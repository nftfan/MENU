<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFTFAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0E1116" />
  <link rel="icon" href="data:," />
  <!-- Professional fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    :root{
      /* Professional color palette */
      --bg: #0a0d12;
      --bg-2: #080b10;
      --card: #12161d;
      --card-2: #14181f;
      --surface: #0f1318;
      --line: #1e252f;
      --text: #e8edf7;
      --muted: #8892a6;
      --muted-2: #6b7280;

      /* Accent colors (professional) */
      --accent-1: #3b82f6;
      --accent-2: #10b981;
      --accent-3: #f59e0b;
      --accent-4: #ef4444;
      --accent-5: #8b5cf6;
      --accent-6: #06b6d4;

      --radius: 6px;
      --radius-sm: 4px;
      --tap: 32px;
      --transition: 200ms ease;
      --shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
    }

    html, body {
      margin: 0; 
      padding: 0;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      font-size: 10px; /* Max font size */
      font-weight: 400; /* No bold */
      line-height: 1.4;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .wrap {
      padding: calc(6px + env(safe-area-inset-top)) 6px calc(8px + env(safe-area-inset-bottom)) 6px;
      max-width: 100vw;
      width: 100%;
      margin: 0 auto;
      display: grid;
      gap: 6px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      width: 100%;
    }

    .header {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      padding: 5px 6px;
      border-bottom: 1px solid var(--line);
      background: var(--card-2);
      min-height: 28px;
    }

    .title-wrap { 
      display: grid; 
      gap: 1px; 
      flex: 1;
      min-width: 0;
    }

    .title { 
      font-size: 9px; 
      font-weight: 500; 
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle { 
      font-size: 7px; 
      color: var(--muted); 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .content { 
      padding: 6px; 
      display: grid; 
      gap: 5px; 
    }

    /* Input row - optimized for mobile */
    .input-group {
      display: flex; 
      align-items: center; 
      gap: 4px;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding: 3px;
      min-height: var(--tap);
    }

    input[type="text"]{
      appearance: none; 
      border: 0; 
      outline: 0; 
      background: transparent;
      color: var(--text); 
      flex: 1; 
      min-width: 0; 
      font-size: 8px;
      font-family: 'JetBrains Mono', monospace;
      padding: 2px 4px;
    }

    input[type="text"]::placeholder {
      color: var(--muted-2);
      font-size: 7px;
    }

    .btn-group {
      display: flex;
      gap: 2px;
      flex-shrink: 0;
    }

    .btn, .icon-btn {
      border: 1px solid var(--line);
      background: var(--surface);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 4px 6px;
      font-weight: 400; /* No bold */
      font-size: 7px;
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 3px;
      cursor: pointer; 
      min-height: 26px;
      transition: all var(--transition);
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn.primary {
      background: var(--accent-1);
      border-color: var(--accent-1);
      color: white;
    }

    .btn:active, .icon-btn:active { 
      transform: translateY(1px); 
    }

    .icon-btn { 
      padding: 3px 5px; 
      min-width: 26px;
    }

    .icon-btn.color-1 { 
      border-color: var(--accent-4); 
      color: var(--accent-4); 
    }

    .icon-btn.color-2 { 
      border-color: var(--accent-2); 
      color: var(--accent-2); 
    }

    .icon-btn.color-3 { 
      border-color: var(--accent-6); 
      color: var(--accent-6); 
    }

    /* Actions - stack on mobile */
    .actions { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 4px; 
    }

    @media (max-width: 320px) {
      .actions { 
        grid-template-columns: 1fr; 
      }
    }

    /* Result */
    .result {
      border: 1px solid var(--line);
      background: var(--surface);
      border-radius: var(--radius-sm);
      padding: 5px;
      font-size: 8px;
      line-height: 1.3;
      min-height: 32px;
      display: flex;
      align-items: center;
    }

    .value { 
      font-weight: 500; 
      color: var(--accent-6);
      font-family: 'JetBrains Mono', monospace;
    }

    .muted { 
      color: var(--muted); 
      font-size: 7px; 
    }

    /* Tokens left */
    .tokens-left {
      display: flex; 
      align-items: center; 
      gap: 4px; 
      flex-wrap: wrap;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 4px;
      background: var(--surface);
      font-size: 7px;
      min-height: 28px;
    }

    .badge {
      display: inline-flex; 
      gap: 3px; 
      align-items: center;
      padding: 2px 4px; 
      border-radius: 999px;
      border: 1px solid var(--accent-6);
      background: var(--bg);
      color: var(--accent-6); 
      font-weight: 400;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
      white-space: nowrap;
    }

    .spacer { 
      flex: 1; 
      min-width: 4px;
    }

    /* Loyalty system */
    .loyalty {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%;
      box-shadow: var(--shadow);
    }

    .loyalty-head {
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 4px;
      padding: 5px 6px;
      background: var(--card-2);
      border-bottom: 1px solid var(--line);
      min-height: 32px;
    }

    .stats { 
      display: flex; 
      gap: 3px; 
      flex-wrap: wrap; 
      align-items: center;
    }

    .pill {
      display: inline-flex; 
      gap: 3px; 
      align-items: center;
      padding: 2px 4px; 
      border-radius: 999px;
      border: 1px solid var(--line);
      background: var(--bg); 
      font-weight: 400; 
      font-size: 7px;
      white-space: nowrap;
      font-family: 'JetBrains Mono', monospace;
    }

    .pill.level { 
      border-color: var(--accent-5); 
      color: var(--accent-5); 
    }

    .pill.kt { 
      border-color: var(--accent-2); 
      color: var(--accent-2); 
    }

    .pill.pol { 
      border-color: var(--accent-3); 
      color: var(--accent-3); 
    }

    .ladder {
      display: grid; 
      grid-template-columns: 12px 1fr; 
      gap: 4px;
      padding: 5px 6px;
      background: var(--card);
    }

    .rail { 
      position: relative; 
    }

    .rail::before {
      content: ""; 
      position: absolute; 
      left: 5px; 
      top: 1px; 
      bottom: 1px; 
      width: 2px; 
      background: var(--line);
      border-radius: 1px;
    }

    .progress {
      position: absolute; 
      left: 5px; 
      top: 1px; 
      width: 2px; 
      height: 0%;
      background: linear-gradient(180deg, var(--accent-1), var(--accent-5));
      border-radius: 1px;
      transition: height 400ms ease;
    }

    .levels { 
      display: grid; 
      gap: 3px; 
    }

    .level { 
      display: grid; 
      grid-template-columns: 12px 1fr; 
      gap: 4px; 
      align-items: center; 
    }

    .marker { 
      width: 4px; 
      height: 4px; 
      border-radius: 50%; 
      border: 1px solid var(--line); 
      background: var(--bg); 
      margin-left: 4px; 
      transition: all var(--transition); 
    }

    .reached .marker { 
      background: var(--accent-1); 
      border-color: var(--accent-1); 
      transform: scale(1.2);
    }

    .level-card {
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 4px;
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      background: var(--surface);
      padding: 3px 4px;
      position: relative;
      overflow: hidden;
      min-height: 24px;
    }

    .reached .level-card {
      border-color: var(--accent-1);
      background: linear-gradient(90deg, var(--surface), rgba(59, 130, 246, 0.05));
    }

    .info { 
      display: grid; 
      gap: 1px; 
      flex: 1;
      min-width: 0;
    }

    .line1 { 
      font-weight: 500; 
      font-size: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .req { 
      color: var(--muted); 
      font-size: 6px; 
      font-weight: 400;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .right { 
      display: flex; 
      gap: 3px; 
      align-items: center; 
      flex-shrink: 0;
    }

    .award {
      display: inline-flex; 
      gap: 2px; 
      align-items: center;
      border: 1px solid var(--line); 
      border-radius: 999px; 
      padding: 1px 3px; 
      font-size: 6px;
      background: var(--bg); 
      font-weight: 400;
      white-space: nowrap;
    }

    .unlock {
      display: inline-flex; 
      gap: 2px; 
      align-items: center;
      border: 1px solid var(--line); 
      border-radius: var(--radius-sm);
      padding: 2px 4px; 
      font-weight: 400; 
      font-size: 6px; 
      text-decoration: none; 
      color: var(--text);
      background: var(--surface); 
      min-height: 20px;
      transition: all var(--transition);
      white-space: nowrap;
    }

    .unlock:hover { 
      background: var(--card); 
    }

    .unlock[aria-disabled="true"] { 
      opacity: 0.6; 
      pointer-events: none; 
    }

    /* How to get tokens */
    .howto .content {
      padding: 6px;
    }

    .howto ol {
      margin: 0 0 4px 12px; 
      padding: 0; 
      line-height: 1.3; 
      font-size: 8px;
    }

    .addr {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-sm);
      padding: 4px;
      margin-top: 4px;
      word-break: break-all;
      font-weight: 400;
      font-family: 'JetBrains Mono', monospace;
      font-size: 7px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: calc(16px + env(safe-area-inset-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 6px 12px;
      font-size: 8px;
      color: var(--text);
      z-index: 1000;
      transition: transform var(--transition);
      box-shadow: var(--shadow);
      white-space: nowrap;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Confetti */
    .confetti {
      position: fixed; 
      left: 50%; 
      bottom: calc(18px + env(safe-area-inset-bottom)); 
      transform: translateX(-50%);
      pointer-events: none; 
      z-index: 50;
    }

    .confetti > span {
      display: inline-block; 
      width: 3px; 
      height: 6px; 
      margin: 0 1px; 
      border-radius: 1px;
      animation: floatUp 800ms ease forwards;
      opacity: 0.9;
    }

    @keyframes floatUp {
      0% { transform: translateY(0) rotate(0deg); opacity: 0.9; }
      70% { opacity: 0.9; }
      100% { transform: translateY(-40px) rotate(180deg); opacity: 0; }
    }

    /* Responsive adjustments */
    @media (max-width: 360px) {
      .wrap {
        padding-left: 4px;
        padding-right: 4px;
      }
      
      .btn-group {
        gap: 1px;
      }
      
      .icon-btn {
        padding: 3px 4px;
        min-width: 24px;
        font-size: 6px;
      }
      
      .stats {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
      }
      
      .right {
        flex-direction: column;
        gap: 2px;
      }
    }

    @media (max-width: 280px) {
      .input-group {
        flex-direction: column;
        gap: 3px;
        align-items: stretch;
      }
      
      .btn-group {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-labelledby="title">
      <div class="header">
        <div class="title-wrap">
          <div id="title" class="title">NFTFAN Balance</div>
          <div class="subtitle">Polygon • $NFTFAN</div>
        </div>
        <div class="subtitle">Powered by Polygonscan</div>
      </div>

      <div class="content">
        <div class="input-group" role="form" aria-label="Wallet address input">
          <input id="wallet" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="none"
                 spellcheck="false" placeholder="Paste wallet address (0x…)" maxlength="42" />
          <div class="btn-group">
            <button class="icon-btn color-1" type="button" id="pasteBtn" title="Paste">Paste</button>
            <button class="icon-btn color-2" type="button" id="connectBtn" title="Connect Wallet">Connect</button>
            <button class="icon-btn color-3" type="button" id="clearBtn" title="Clear">Clear</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="checkBtn" type="button">Check Balance</button>
          <button class="btn" id="refreshTokensBtn" type="button" style="border-color:var(--accent-6);color:var(--accent-6)">Refresh Tokens</button>
        </div>

        <div id="result" class="result" role="status" aria-live="polite">
          <span class="muted">Enter an address and tap "Check Balance".</span>
        </div>

        <div class="tokens-left" id="tokensLeftRow">
          <span>Tokens left in sale:</span>
          <span class="badge"><span id="tokensLeftValue">—</span></span>
          <span class="spacer"></span>
          <button class="icon-btn color-3" type="button" id="tokensLeftRefresh" title="Refresh">↻</button>
        </div>
      </div>
    </div>

    <!-- Loyalty -->
    <div class="loyalty">
      <div class="loyalty-head">
        <div class="title">Community Loyalty</div>
        <div class="stats">
          <span class="pill level"><span id="currentLevelLabel">Level 1</span></span>
          <span class="pill kt" title="Holdings in KT"><span id="currentKT">0.000 KT</span></span>
          <span class="pill pol" title="Estimated POL invested"><span id="currentPOL">≈ 0.000 POL</span></span>
        </div>
      </div>

      <div class="ladder">
        <div class="rail"><div id="ladderProgress" class="progress"></div></div>
        <div class="levels" id="levelsContainer"><!-- injected --></div>
      </div>
    </div>

    <!-- How to get tokens -->
    <div class="howto card">
      <div class="header">
        <div class="title">How to get $NFTFAN tokens</div>
      </div>
      <div class="content">
        <ol>
          <li>Send 0.01 – 100 POL (Polygon) to the airdrop contract:</li>
        </ol>
        <div class="addr">
          <span id="airdropAddr">0xaf2d132C8773bca3821C24EcF64e844E202A12e8</span>
          <span class="spacer"></span>
          <button class="icon-btn" type="button" id="copyAirdropBtn" title="Copy address" style="border-color:var(--accent-1);color:var(--accent-1);min-height:24px;">Copy</button>
        </div>
        <ol start="2">
          <li>Tokens are airdropped to your wallet automatically.</li>
          <li>Check your balance above after a few seconds.</li>
          <li>Rate: 1 POL → 1 KT → 1,000 Trillion $NFTFAN.</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toast" class="toast" role="alert"></div>

  <!-- Confetti container -->
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    // Config
    const tokenAddress = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const apiKey = "3AFN3ZU4ANK3XEUJQ6BRJCBCITAFHKFVTV";
    const airdropContract = "0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
    const TOKEN_DECIMALS = 18;
    const TOKEN_SYMBOL = "NFTFAN";

    // KT mapping (and 1 KT = 1 POL)
    const KT_BASE_RAW = 10n ** 33n; // 1e33 raw units
    const MAX_KT = 100;
    const LEVEL_COUNT = 10;
    const LEVEL_STEP_KT = MAX_KT / LEVEL_COUNT; // 10 KT per level

    // Elements
    const walletInput = document.getElementById("wallet");
    const resultDiv = document.getElementById("result");
    const tokensLeftValue = document.getElementById("tokensLeftValue");
    const tokensLeftRefresh = document.getElementById("tokensLeftRefresh");
    const refreshTokensBtn = document.getElementById("refreshTokensBtn");
    const checkBtn = document.getElementById("checkBtn");
    const pasteBtn = document.getElementById("pasteBtn");
    const clearBtn = document.getElementById("clearBtn");
    const connectBtn = document.getElementById("connectBtn");
    const copyAirdropBtn = document.getElementById("copyAirdropBtn");
    const confetti = document.getElementById("confetti");
    const toastEl = document.getElementById("toast");

    // Loyalty
    const ladderProgress = document.getElementById("ladderProgress");
    const levelsContainer = document.getElementById("levelsContainer");
    const currentLevelLabel = document.getElementById("currentLevelLabel");
    const currentKTLabel = document.getElementById("currentKT");
    const currentPOLLabel = document.getElementById("currentPOL");
    let lastLevel = 0; // track for celebration

    // Level definitions
    const LEVELS = [
      { n: 1,  thresholdKT: 0,   title: "Explorer",  award: "Profile Flair",      nft: null },
      { n: 2,  thresholdKT: 10,  title: "Supporter", award: "Early Access",       nft: "https://web3.okx.com/ul/rcLrG8g" },
      { n: 3,  thresholdKT: 20,  title: "Insider",   award: "Alpha Feed",         nft: null },
      { n: 4,  thresholdKT: 30,  title: "Champion",  award: "Discord Role",       nft: null },
      { n: 5,  thresholdKT: 40,  title: "Patron",    award: "Beta Invites",       nft: null },
      { n: 6,  thresholdKT: 50,  title: "Guardian",  award: "OG Badge",           nft: null },
      { n: 7,  thresholdKT: 60,  title: "Architect", award: "Voting Boost",       nft: null },
      { n: 8,  thresholdKT: 70,  title: "Legend",    award: "Whitelist+",         nft: null },
      { n: 9,  thresholdKT: 80,  title: "Mythic",    award: "Airdrop Boost",      nft: null },
      { n: 10, thresholdKT: 90,  title: "Titan",     award: "VIP Access",         nft: null }
    ];

    const validateEthAddress = (addr) => /^0x[a-fA-F0-9]{40}$/.test(addr);

    function formatIntegerWithSeparators(nStr) {
      const parts = nStr.split("");
      let out = "", count = 0;
      for (let i = parts.length - 1; i >= 0; i--) {
        out = parts[i] + out;
        if (++count === 3 && i !== 0) { out = "," + out; count = 0; }
      }
      return out;
    }

    function formatUnits(raw, decimals = 18, maxFractionDigits = 6) {
      try {
        const value = BigInt(String(raw));
        const base = 10n ** BigInt(decimals);
        const integer = value / base;
        const fraction = value % base;
        if (maxFractionDigits > 0) {
          const scale = 10n ** BigInt(maxFractionDigits);
          const fracScaled = (fraction * scale) / base;
          let fracStr = fracScaled.toString().padStart(maxFractionDigits, "0").replace(/0+$/, "");
          return fracStr ? `${formatIntegerWithSeparators(integer.toString())}.${fracStr}` : formatIntegerWithSeparators(integer.toString());
        }
        return formatIntegerWithSeparators(integer.toString());
      } catch { return "0"; }
    }

    function formatRawToKT(raw, maxFractionDigits = 3) {
      try {
        const value = BigInt(String(raw));
        const integer = value / KT_BASE_RAW;
        const fraction = value % KT_BASE_RAW;
        if (maxFractionDigits > 0) {
          const scale = 10n ** BigInt(maxFractionDigits);
          const fracScaled = (fraction * scale) / KT_BASE_RAW;
          let fracStr = fracScaled.toString().padStart(maxFractionDigits, "0").replace(/0+$/, "");
          return (fracStr ? `${formatIntegerWithSeparators(integer.toString())}.${fracStr}` : formatIntegerWithSeparators(integer.toString())) + " KT";
        }
        return formatIntegerWithSeparators(integer.toString()) + " KT";
      } catch { return "0 KT"; }
    }

    function toKTNumber(raw) {
      try {
        const value = BigInt(String(raw));
        const scale = 10n ** 6n;
        const scaled = (value * scale) / KT_BASE_RAW;
        const num = Number(scaled) / 1e6;
        return Number.isFinite(num) ? num : 0;
      } catch { return 0; }
    }

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const levelForKT = (kt) => clamp(Math.floor(clamp(kt, 0, MAX_KT) / LEVEL_STEP_KT) + 1, 1, LEVEL_COUNT);
    const progressPercentForKT = (kt) => clamp((kt / MAX_KT) * 100, 0, 100);

    function celebrate() {
      confetti.innerHTML = "";
      const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4'];
      const pieces = 15;
      for (let i=0;i<pieces;i++){
        const s = document.createElement("span");
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.transform = `translateY(0) rotate(${Math.random()*40-20}deg)`;
        s.style.animationDelay = `${Math.random()*0.2}s`;
        confetti.appendChild(s);
      }
      setTimeout(()=> confetti.innerHTML = "", 900);
    }

    // Build levels UI
    function renderLevels(currentKT) {
      const lvl = levelForKT(currentKT);
      if (lvl > lastLevel && lastLevel !== 0) celebrate();
      lastLevel = lvl;

      currentLevelLabel.textContent = `Level ${lvl}`;
      ladderProgress.style.height = `${progressPercentForKT(currentKT)}%`;

      levelsContainer.innerHTML = "";
      LEVELS.forEach(L => {
        const reached = currentKT >= L.thresholdKT;

        const row = document.createElement("div");
        row.className = `level ${reached ? "reached" : ""}`;

        const marker = document.createElement("div");
        marker.className = "marker";

        const card = document.createElement("div");
        card.className = "level-card";

        const info = document.createElement("div");
        info.className = "info";
        const line1 = document.createElement("div");
        line1.className = "line1";
        line1.textContent = `Level ${L.n} — ${L.title}`;
        const req = document.createElement("div");
        req.className = "req";
        req.textContent = L.n === 10 ? "Requires ≥ 90 KT (Max 100 KT)" : `Requires ≥ ${L.thresholdKT} KT`;
        info.appendChild(line1);
        info.appendChild(req);

        const right = document.createElement("div");
        right.className = "right";
        const award = document.createElement("div");
        award.className = "award";
        award.textContent = L.award;
        
        const unlock = document.createElement("a");
        unlock.className = "unlock";
        if (reached) {
          unlock.setAttribute("aria-disabled", "true");
          unlock.textContent = "Unlocked";
        } else if (L.nft) {
          unlock.href = L.nft;
          unlock.target = "_blank";
          unlock.rel = "noopener noreferrer";
          unlock.textContent = "Unlock";
          unlock.style.borderColor = "var(--accent-1)";
          unlock.style.color = "var(--accent-1)";
          unlock.addEventListener('click', ()=> setTimeout(()=> celebrate(), 250), { once:true });
        } else {
          unlock.setAttribute("aria-disabled", "true");
          unlock.textContent = "Soon";
        }
        
        right.appendChild(award);
        right.appendChild(unlock);

        card.appendChild(info);
        card.appendChild(right);

        row.appendChild(marker);
        row.appendChild(card);
        levelsContainer.appendChild(row);
      });
    }

    async function getBalance() {
      const wallet = walletInput.value.trim();
      if (!wallet) {
        resultDiv.innerHTML = "<span class='muted'>Please enter a wallet address.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
        return;
      }
      if (!validateEthAddress(wallet)) {
        resultDiv.innerHTML = "<span style='color:var(--accent-4)'>Invalid Polygon (EVM) address. Must start with 0x and be 42 characters.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
        return;
      }
      resultDiv.innerHTML = "<span class='muted'>Checking…</span>";
      const url = `https://api.polygonscan.com/api?module=account&action=tokenbalance&contractaddress=${tokenAddress}&address=${wallet}&tag=latest&apikey=${apiKey}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "1") {
          const raw = BigInt(data.result);
          const tokensStr = formatUnits(raw, TOKEN_DECIMALS, 6);
          const ktStr = formatRawToKT(raw, 3);
          const ktNum = toKTNumber(raw);
          const polNum = ktNum; // 1 KT = 1 POL
          const polStr = polNum.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " POL";

          resultDiv.innerHTML = `<div>${TOKEN_SYMBOL} Balance: <span class="value">${tokensStr} ${TOKEN_SYMBOL}</span><br/><span class="muted">≈ ${ktStr} • ≈ ${polStr} invested</span></div>`;
          currentKTLabel.textContent = ktStr;
          currentPOLLabel.textContent = `≈ ${polStr}`;
          renderLevels(ktNum);
        } else {
          resultDiv.innerHTML = "<span style='color:var(--accent-4)'>Error fetching balance. Try again later.</span>";
          currentKTLabel.textContent = "0.000 KT";
          currentPOLLabel.textContent = "≈ 0.000 POL";
          renderLevels(0);
        }
      } catch {
        resultDiv.innerHTML = "<span style='color:var(--accent-4)'>Network error. Please try again later.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
      }
    }

    async function fetchTokensLeft() {
      tokensLeftValue.textContent = "...";
      const url = `https://api.polygonscan.com/api?module=account&action=tokenbalance&contractaddress=${tokenAddress}&address=${airdropContract}&tag=latest&apikey=${apiKey}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "1") {
          tokensLeftValue.textContent = `${formatUnits(data.result, TOKEN_DECIMALS, 3)} ${TOKEN_SYMBOL}`;
        } else {
          tokensLeftValue.textContent = "Error";
        }
      } catch {
        tokensLeftValue.textContent = "Error";
      }
    }

    // Toast helper
    const showToast = (msg) => {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1400);
    };

    async function pasteFromClipboard() {
      if (!navigator.clipboard?.readText) return showToast("Clipboard not available");
      try { 
        walletInput.value = (await navigator.clipboard.readText()).trim(); 
        showToast("Pasted"); 
      } catch { 
        showToast("Paste failed"); 
      }
    }

    function clearInput() { 
      walletInput.value = ""; 
      walletInput.focus(); 
    }

    async function connectWallet() {
      const eth = window.ethereum;
      if (!eth?.request) return showToast("No wallet found");
      try {
        const accounts = await eth.request({ method: "eth_requestAccounts" });
        if (accounts?.[0]) { 
          walletInput.value = accounts[0]; 
          showToast("Wallet connected"); 
        }
      } catch { 
        showToast("Connection rejected"); 
      }
    }

    async function copyAirdropAddress() {
      const address = document.getElementById("airdropAddr").textContent.trim();
      try { 
        await navigator.clipboard.writeText(address); 
        showToast("Address copied"); 
      } catch {
        const ta = document.createElement("textarea"); 
        ta.value = address; 
        document.body.appendChild(ta);
        ta.select(); 
        document.execCommand("copy"); 
        document.body.removeChild(ta); 
        showToast("Address copied");
      }
    }

    // Events
    checkBtn.addEventListener("click", getBalance);
    refreshTokensBtn.addEventListener("click", fetchTokensLeft);
    tokensLeftRefresh.addEventListener("click", fetchTokensLeft);
    pasteBtn.addEventListener("click", pasteFromClipboard);
    clearBtn.addEventListener("click", clearInput);
    connectBtn.addEventListener("click", connectWallet);
    copyAirdropBtn.addEventListener("click", copyAirdropAddress);
    walletInput.addEventListener("keydown", (e) => { 
      if (e.key === "Enter") { 
        e.preventDefault(); 
        getBalance(); 
      } 
    });

    // Hide connect if no provider
    if (!window.ethereum) connectBtn.style.display = "none";

    // Initial render
    fetchTokensLeft();
    currentKTLabel.textContent = "0.000 KT";
    currentPOLLabel.textContent = "≈ 0.000 POL";
    renderLevels(0);
  </script>
</body>
</html>
