<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFTFAN • Balance • Loyalty • POL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0E1116" />
  <link rel="icon" href="data:," />
  <!-- Sleek, compact fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@500;700&family=Plus+Jakarta+Sans:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      /* Flat base */
      --bg: #0e1116;
      --bg-2: #0b0f14;
      --card: #141925;
      --card-2: #161d2b;
      --surface: #101624;
      --line: #243048;
      --text: #edf2ff;
      --muted: #99a6ba;

      /* Vivid palette (10 levels + utility) */
      --c1:#ff6b6b; --c2:#ff8e53; --c3:#ffc46b; --c4:#34d399; --c5:#2dd4bf;
      --c6:#22d3ee; --c7:#60a5fa; --c8:#818cf8; --c9:#a78bfa; --c10:#f472b6;

      --radius: 8px;
      --tap: 36px; /* compact touch target */
      --speed: 480ms;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin: 0; padding: 0;
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      color: var(--text);
      font-family: 'Inter Tight','Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 10px; /* max 10px base size */
      min-height: 100vh;
    }

    .wrap {
      padding: calc(8px + env(safe-area-inset-top)) 8px calc(12px + env(safe-area-inset-bottom)) 8px;
      max-width: 350px; /* requested max width */
      margin: 0 auto;
      display: grid;
      gap: 8px;
      width: 100%;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%;
    }

    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 8px;
      border-bottom: 1px solid var(--line);
      background: var(--card-2);
    }
    .title-wrap { display: grid; gap: 1px; }
    .title { font-weight: 800; font-family: 'Plus Jakarta Sans', 'Inter Tight', sans-serif; font-size: .98rem; letter-spacing: .2px; }
    .subtitle { font-size: .78rem; color: var(--muted); }

    .content { padding: 8px; display: grid; gap: 6px; }

    /* Input row */
    .input-group {
      display: flex; align-items: center; gap: 6px;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      padding: 5px;
    }
    input[type="text"]{
      appearance: none; border: 0; outline: 0; background: transparent;
      color: var(--text); flex: 1; min-width: 0; font-size: .92rem;
    }
    .row { display: inline-flex; gap: 4px; align-items: center; }
    .btn, .icon-btn {
      border: 1px solid var(--line);
      background: var(--card);
      color: var(--text);
      border-radius: 6px;
      padding: 6px 8px;
      font-weight: 800;
      font-size: .9rem;
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      cursor: pointer; min-height: var(--tap);
      transition: background 160ms ease, transform 120ms ease, border-color 160ms ease;
    }
    .btn.primary {
      background: linear-gradient(90deg, var(--c7), var(--c9));
      border-color: transparent;
      color: #0d1220;
    }
    .btn:active, .icon-btn:active { transform: translateY(1px); }
    .icon-btn { padding: 5px 8px; min-height: 28px; }
    .icon-btn.color-1 { border-color: var(--c1); color: var(--c1); }
    .icon-btn.color-2 { border-color: var(--c5); color: var(--c5); }
    .icon-btn.color-3 { border-color: var(--c7); color: var(--c7); }

    /* Actions */
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }

    /* Result & helper */
    .result {
      border: 1px solid var(--line);
      background: var(--surface);
      border-radius: var(--radius);
      padding: 6px;
      font-size: .92rem;
      line-height: 1.35;
    }
    .value { font-weight: 800; background: linear-gradient(90deg,var(--c6),var(--c7)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .muted { color: var(--muted); font-size: .78rem; }

    /* Tokens left */
    .tokens-left {
      display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 6px;
      background: var(--surface);
      font-size: .88rem;
    }
    .badge {
      display: inline-flex; gap: 6px; align-items: center;
      padding: 2px 6px; border-radius: 999px;
      border: 1px solid var(--c6);
      background: #0c1520;
      color: var(--c6); font-weight: 800;
    }
    .spacer { flex: 1; }

    /* Loyalty sleek ladder (more compact) */
    .loyalty {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%;
    }
    .loyalty-head {
      display: flex; align-items: center; justify-content: space-between; gap: 6px;
      padding: 6px 8px;
      background: var(--card-2);
      border-bottom: 1px solid var(--line);
    }
    .stats { display: inline-flex; gap: 4px; flex-wrap: wrap; }
    .pill {
      display: inline-flex; gap: 6px; align-items: center;
      padding: 3px 6px; border-radius: 999px;
      border: 1px solid var(--line);
      background: #0e1523; font-weight: 800; font-size: .86rem;
    }
    .pill.level { border-color: var(--c8); color: var(--c8); }
    .pill.kt    { border-color: var(--c5); color: var(--c5); }
    .pill.pol   { border-color: var(--c3); color: var(--c3); }

    .ladder {
      display: grid; grid-template-columns: 14px 1fr; gap: 6px;
      padding: 6px 8px 8px 8px;
      background: var(--card);
    }
    .rail { position: relative; }
    .rail::before {
      content: ""; position: absolute; left: 6px; top: 1px; bottom: 1px; width: 2px; background: #27334a;
      border-radius: 2px;
    }
    .progress {
      position: absolute; left: 6px; top: 1px; width: 2px; height: 0%;
      background: linear-gradient(180deg, var(--c7), var(--c10));
      border-radius: 2px;
      transition: height .45s ease;
    }
    .levels { display: grid; gap: 5px; }

    .level { display: grid; grid-template-columns: 14px 1fr; gap: 6px; align-items: center; }
    .marker { width: 6px; height: 6px; border-radius: 50%; border: 2px solid #2b3342; background: #121824; margin-left: 4px; transition: transform .2s ease, background .2s ease, border-color .2s ease; }
    .reached .marker { transform: scale(1.05); background: var(--c7); border-color: var(--c7); }

    .level-card {
      display: flex; align-items: center; justify-content: space-between; gap: 6px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: var(--surface);
      padding: 5px;
      position: relative;
      overflow: hidden;
    }
    .level-card::after {
      content:""; position:absolute; inset:0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.07), transparent);
      transform: translateX(-100%); pointer-events:none;
    }
    .reached .level-card::after { animation: sheen 1100ms ease 100ms; }
    @keyframes sheen { to { transform: translateX(100%); } }

    .info { display: grid; gap: 1px; }
    .line1 { font-weight: 800; font-size: .9rem; }
    .req { color: var(--muted); font-size: .76rem; font-weight: 700; }
    .right { display: inline-flex; gap: 6px; align-items: center; }
    .award {
      display: inline-flex; gap: 6px; align-items: center;
      border: 1px solid var(--line); border-radius: 999px; padding: 2px 6px; font-size: .82rem;
      background: #0f1520; font-weight: 700;
    }
    .unlock {
      display: inline-flex; gap: 6px; align-items: center;
      border: 1px solid var(--line); border-radius: 999px;
      padding: 4px 8px; font-weight: 800; font-size: .82rem; text-decoration: none; color: var(--text);
      background: #161d2a; min-height: 28px;
      transition: transform 120ms ease, background 160ms ease, border-color 160ms ease;
    }
    .unlock:hover { background: #1b2435; }
    .unlock[aria-disabled="true"] { opacity: .6; pointer-events: none; }

    /* Color tags for levels */
    .tag { display:inline-block; width: 3px; height: 100%; border-radius: 3px; margin-right: 6px; }
    .t-1{background:var(--c1)} .t-2{background:var(--c2)} .t-3{background:var(--c3)} .t-4{background:var(--c4)} .t-5{background:var(--c5)}
    .t-6{background:var(--c6)} .t-7{background:var(--c7)} .t-8{background:var(--c8)} .t-9{background:var(--c9)} .t-10{background:var(--c10)}

    /* Achievement highlight (rainbow border on reached) */
    .reached .level-card {
      border-color: transparent;
      background:
        linear-gradient(var(--surface),var(--surface)) padding-box,
        linear-gradient(90deg,var(--c4),var(--c6),var(--c8),var(--c10)) border-box;
      animation: cardPulse 800ms ease;
    }
    @keyframes cardPulse {
      0%{ transform: scale(0.997); } 100%{ transform: scale(1); }
    }

    /* Confetti (for level-up) */
    .confetti {
      position: fixed; left: 50%; bottom: calc(18px + env(safe-area-inset-bottom)); transform: translateX(-50%);
      pointer-events: none; z-index: 50;
    }
    .confetti > span {
      display:inline-block; width: 5px; height: 8px; margin: 0 2px; border-radius: 1px;
      animation: floatUp 880ms ease forwards;
      opacity: .95;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) rotate(0deg); opacity: .95; }
      70% { opacity:.95; }
      100% { transform: translateY(-56px) rotate(200deg); opacity: 0; }
    }

    /* Stack buttons on very small widths */
    @media (max-width: 340px) {
      .actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-labelledby="title">
      <div class="header">
        <div class="title-wrap">
          <div id="title" class="title">NFTFAN Balance</div>
          <div class="subtitle">Polygon • $NFTFAN</div>
        </div>
        <div class="subtitle">Powered by Polygonscan</div>
      </div>

      <div class="content">
        <div class="input-group" role="form" aria-label="Wallet address input">
          <input id="wallet" inputmode="text" autocomplete="off" autocorrect="off" autocapitalize="none"
                 spellcheck="false" placeholder="Paste wallet address (0x…)" maxlength="42" />
          <div class="row">
            <button class="icon-btn color-1" type="button" id="pasteBtn" title="Paste">Paste</button>
            <button class="icon-btn color-2" type="button" id="connectBtn" title="Connect Wallet">Connect</button>
            <button class="icon-btn color-3" type="button" id="clearBtn" title="Clear">Clear</button>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="checkBtn" type="button">Check Balance</button>
          <button class="btn" id="refreshTokensBtn" type="button" style="border-color:var(--c6);color:var(--c6)">Refresh Tokens Left</button>
        </div>

        <div id="result" class="result" role="status" aria-live="polite">
          <span class="muted">Enter an address and tap “Check Balance”.</span>
        </div>

        <div class="tokens-left" id="tokensLeftRow">
          <span>Amount left in token sale contract:</span>
          <span class="badge"><span id="tokensLeftValue">—</span></span>
          <span class="spacer"></span>
          <button class="icon-btn color-3" type="button" id="tokensLeftRefresh" title="Refresh">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Loyalty -->
    <div class="loyalty">
      <div class="loyalty-head">
        <div class="title">Community Loyalty</div>
        <div class="stats">
          <span class="pill level"><b id="currentLevelLabel">Level 1</b></span>
          <span class="pill kt" title="Holdings in KT (1 KT = 1,000 Trillion tokens = 1 POL)"><b id="currentKT">0.000 KT</b></span>
          <span class="pill pol" title="Estimated POL invested (1 KT = 1 POL)"><b id="currentPOL">≈ 0.000 POL</b></span>
        </div>
      </div>

      <div class="ladder">
        <div class="rail"><div id="ladderProgress" class="progress"></div></div>
        <div class="levels" id="levelsContainer"><!-- injected --></div>
      </div>
    </div>

    <!-- How to get tokens -->
    <div class="howto card">
      <div class="header" style="padding:6px 8px;">
        <div class="title">How to get $NFTFAN tokens</div>
      </div>
      <div class="content" style="padding:8px;">
        <ol style="margin:0 0 6px 16px; padding:0; line-height:1.45; font-size:.9rem;">
          <li>Send <b>0.01 – 100 POL</b> (Polygon) to the airdrop contract:</li>
        </ol>
        <div class="addr" style="display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--line);border-radius:6px;padding:6px;margin-top:6px;word-break:break-all;font-weight:700;">
          <span id="airdropAddr">0xaf2d132C8773bca3821C24EcF64e844E202A12e8</span>
          <span class="spacer"></span>
          <button class="icon-btn" type="button" id="copyAirdropBtn" title="Copy address" style="border-color:var(--c7);color:var(--c7);min-height:28px;">Copy</button>
        </div>
        <ol start="2" style="margin:6px 0 0 16px; padding:0; line-height:1.45; font-size:.9rem;">
          <li>Tokens are airdropped to your wallet automatically.</li>
          <li>Check your balance above after a few seconds.</li>
          <li><b>Rate:</b> 1 POL → 1 KT → 1,000 Trillion $NFTFAN.</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- Confetti container -->
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    // Config
    const tokenAddress = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const apiKey = "3AFN3ZU4ANK3XEUJQ6BRJCBCITAFHKFVTV";
    const airdropContract = "0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
    const TOKEN_DECIMALS = 18;
    const TOKEN_SYMBOL = "NFTFAN";

    // KT mapping (and 1 KT = 1 POL)
    const KT_BASE_RAW = 10n ** 33n; // 1e33 raw units
    const MAX_KT = 100;
    const LEVEL_COUNT = 10;
    const LEVEL_STEP_KT = MAX_KT / LEVEL_COUNT; // 10 KT per level

    // Elements
    const walletInput = document.getElementById("wallet");
    const resultDiv = document.getElementById("result");
    const tokensLeftValue = document.getElementById("tokensLeftValue");
    const tokensLeftRefresh = document.getElementById("tokensLeftRefresh");
    const refreshTokensBtn = document.getElementById("refreshTokensBtn");
    const checkBtn = document.getElementById("checkBtn");
    const pasteBtn = document.getElementById("pasteBtn");
    const clearBtn = document.getElementById("clearBtn");
    const connectBtn = document.getElementById("connectBtn");
    const copyAirdropBtn = document.getElementById("copyAirdropBtn");
    const confetti = document.getElementById("confetti");

    // Loyalty
    const ladderProgress = document.getElementById("ladderProgress");
    const levelsContainer = document.getElementById("levelsContainer");
    const currentLevelLabel = document.getElementById("currentLevelLabel");
    const currentKTLabel = document.getElementById("currentKT");
    const currentPOLLabel = document.getElementById("currentPOL");
    let lastLevel = 0; // track for celebration

    // Level definitions (color tags + unlock links; Level 2 has provided NFT link)
    const LEVELS = [
      { n: 1,  thresholdKT: 0,   title: "Explorer",  tag: "t-1",  award: "Profile Flair",      nft: null },
      { n: 2,  thresholdKT: 10,  title: "Supporter", tag: "t-2",  award: "Early Access",       nft: "https://web3.okx.com/ul/rcLrG8g" },
      { n: 3,  thresholdKT: 20,  title: "Insider",   tag: "t-3",  award: "Alpha Feed",         nft: null },
      { n: 4,  thresholdKT: 30,  title: "Champion",  tag: "t-4",  award: "Discord Role",       nft: null },
      { n: 5,  thresholdKT: 40,  title: "Patron",    tag: "t-5",  award: "Beta Invites",       nft: null },
      { n: 6,  thresholdKT: 50,  title: "Guardian",  tag: "t-6",  award: "OG Badge",           nft: null },
      { n: 7,  thresholdKT: 60,  title: "Architect", tag: "t-7",  award: "Voting Boost",       nft: null },
      { n: 8,  thresholdKT: 70,  title: "Legend",    tag: "t-8",  award: "Whitelist+",         nft: null },
      { n: 9,  thresholdKT: 80,  title: "Mythic",    tag: "t-9",  award: "Airdrop Boost",      nft: null },
      { n: 10, thresholdKT: 90,  title: "Titan",     tag: "t-10", award: "VIP Access",         nft: null }
    ];

    const validateEthAddress = (addr) => /^0x[a-fA-F0-9]{40}$/.test(addr);

    function formatIntegerWithSeparators(nStr) {
      const parts = nStr.split("");
      let out = "", count = 0;
      for (let i = parts.length - 1; i >= 0; i--) {
        out = parts[i] + out;
        if (++count === 3 && i !== 0) { out = "," + out; count = 0; }
      }
      return out;
    }

    function formatUnits(raw, decimals = 18, maxFractionDigits = 6) {
      try {
        const value = BigInt(String(raw));
        const base = 10n ** BigInt(decimals);
        const integer = value / base;
        const fraction = value % base;
        if (maxFractionDigits > 0) {
          const scale = 10n ** BigInt(maxFractionDigits);
          const fracScaled = (fraction * scale) / base;
          let fracStr = fracScaled.toString().padStart(maxFractionDigits, "0").replace(/0+$/, "");
          return fracStr ? `${formatIntegerWithSeparators(integer.toString())}.${fracStr}` : formatIntegerWithSeparators(integer.toString());
        }
        return formatIntegerWithSeparators(integer.toString());
      } catch { return "0"; }
    }

    function formatRawToKT(raw, maxFractionDigits = 3) {
      try {
        const value = BigInt(String(raw));
        const integer = value / KT_BASE_RAW;
        const fraction = value % KT_BASE_RAW;
        if (maxFractionDigits > 0) {
          const scale = 10n ** BigInt(maxFractionDigits);
          const fracScaled = (fraction * scale) / KT_BASE_RAW;
          let fracStr = fracScaled.toString().padStart(maxFractionDigits, "0").replace(/0+$/, "");
          return (fracStr ? `${formatIntegerWithSeparators(integer.toString())}.${fracStr}` : formatIntegerWithSeparators(integer.toString())) + " KT";
        }
        return formatIntegerWithSeparators(integer.toString()) + " KT";
      } catch { return "0 KT"; }
    }

    function toKTNumber(raw) {
      try {
        const value = BigInt(String(raw));
        const scale = 10n ** 6n;
        const scaled = (value * scale) / KT_BASE_RAW;
        const num = Number(scaled) / 1e6;
        return Number.isFinite(num) ? num : 0;
      } catch { return 0; }
    }

    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const levelForKT = (kt) => clamp(Math.floor(clamp(kt, 0, MAX_KT) / LEVEL_STEP_KT) + 1, 1, LEVEL_COUNT);
    const progressPercentForKT = (kt) => clamp((kt / MAX_KT) * 100, 0, 100);

    function celebrate() {
      confetti.innerHTML = "";
      const colors = ['var(--c1)','var(--c2)','var(--c3)','var(--c4)','var(--c5)','var(--c6)','var(--c7)','var(--c8)','var(--c9)','var(--c10)'];
      const pieces = 20;
      for (let i=0;i<pieces;i++){
        const s = document.createElement("span");
        s.style.background = colors[Math.floor(Math.random()*colors.length)];
        s.style.transform = `translateY(0) rotate(${Math.random()*40-20}deg)`;
        s.style.animationDelay = `${Math.random()*0.2}s`;
        s.style.opacity = 0.9;
        confetti.appendChild(s);
      }
      setTimeout(()=> confetti.innerHTML = "", 1100);
    }

    // Build levels UI
    function renderLevels(currentKT) {
      const lvl = levelForKT(currentKT);
      if (lvl > lastLevel && lastLevel !== 0) celebrate();
      lastLevel = lvl;

      currentLevelLabel.textContent = `Level ${lvl}`;
      ladderProgress.style.height = `${progressPercentForKT(currentKT)}%`;

      levelsContainer.innerHTML = "";
      LEVELS.forEach(L => {
        const reached = currentKT >= L.thresholdKT;

        const row = document.createElement("div");
        row.className = `level ${reached ? "reached" : ""}`;

        const marker = document.createElement("div");
        marker.className = "marker";

        const card = document.createElement("div");
        card.className = "level-card";

        const leftWrap = document.createElement("div");
        leftWrap.style.display = "flex";
        leftWrap.style.alignItems = "stretch";
        const tag = document.createElement("span");
        tag.className = `tag ${L.tag}`;
        const info = document.createElement("div");
        info.className = "info";
        const line1 = document.createElement("div");
        line1.className = "line1";
        line1.textContent = `Level ${L.n} — ${L.title}`;
        const req = document.createElement("div");
        req.className = "req";
        req.textContent = L.n === 10 ? "Requires ≥ 90 KT (Max 100 KT)" : `Requires ≥ ${L.thresholdKT} KT`;
        info.appendChild(line1);
        info.appendChild(req);
        leftWrap.appendChild(tag);
        leftWrap.appendChild(info);

        const right = document.createElement("div");
        right.className = "right";
        const award = document.createElement("div");
        award.className = "award";
        award.style.borderColor = `var(--c${L.n})`;
        award.style.color = `var(--c${L.n})`;
        award.textContent = `Award: ${L.award}`;
        const unlock = document.createElement("a");
        unlock.className = "unlock";
        unlock.style.borderColor = `var(--c${L.n})`;
        unlock.style.color = `var(--c${L.n})`;
        if (reached) {
          unlock.setAttribute("aria-disabled", "true");
          unlock.textContent = "Unlocked";
          unlock.style.background = "#0f1520";
        } else if (L.nft) {
          unlock.href = L.nft;
          unlock.target = "_blank";
          unlock.rel = "noopener noreferrer";
          unlock.textContent = "Unlock";
          unlock.addEventListener('click', ()=> setTimeout(()=> celebrate(), 250), { once:true });
        } else {
          unlock.setAttribute("aria-disabled", "true");
          unlock.textContent = "Coming Soon";
        }
        right.appendChild(award);
        right.appendChild(unlock);

        card.appendChild(leftWrap);
        card.appendChild(right);

        row.appendChild(marker);
        row.appendChild(card);
        levelsContainer.appendChild(row);
      });
    }

    async function getBalance() {
      const wallet = walletInput.value.trim();
      if (!wallet) {
        resultDiv.innerHTML = "<span class='muted'>Please enter a wallet address.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
        return;
      }
      if (!validateEthAddress(wallet)) {
        resultDiv.innerHTML = "<span style='color:var(--c1)'>Invalid Polygon (EVM) address. It should start with 0x and be 42 characters.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
        return;
      }
      resultDiv.innerHTML = "<span class='muted'>Checking…</span>";
      const url = `https://api.polygonscan.com/api?module=account&action=tokenbalance&contractaddress=${tokenAddress}&address=${wallet}&tag=latest&apikey=${apiKey}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "1") {
          const raw = BigInt(data.result);
          const tokensStr = formatUnits(raw, TOKEN_DECIMALS, 6);
          const ktStr = formatRawToKT(raw, 3);
          const ktNum = toKTNumber(raw);
          const polNum = ktNum; // 1 KT = 1 POL
          const polStr = polNum.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + " POL";

          resultDiv.innerHTML = `<div><b>${TOKEN_SYMBOL} Balance:</b> <span class="value">${tokensStr} ${TOKEN_SYMBOL}</span><br/><span class="muted">≈ ${ktStr} • ≈ ${polStr} invested</span></div>`;
          currentKTLabel.textContent = ktStr;
          currentPOLLabel.textContent = `≈ ${polStr}`;
          renderLevels(ktNum);
        } else {
          resultDiv.innerHTML = "<span style='color:var(--c1)'>Error fetching balance. Try again later.</span>";
          currentKTLabel.textContent = "0.000 KT";
          currentPOLLabel.textContent = "≈ 0.000 POL";
          renderLevels(0);
        }
      } catch {
        resultDiv.innerHTML = "<span style='color:var(--c1)'>Network error fetching balance. Please try again later.</span>";
        currentKTLabel.textContent = "0.000 KT";
        currentPOLLabel.textContent = "≈ 0.000 POL";
        renderLevels(0);
      }
    }

    async function fetchTokensLeft() {
      tokensLeftValue.textContent = "...";
      const url = `https://api.polygonscan.com/api?module=account&action=tokenbalance&contractaddress=${tokenAddress}&address=${airdropContract}&tag=latest&apikey=${apiKey}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "1") {
          tokensLeftValue.textContent = `${formatUnits(data.result, TOKEN_DECIMALS, 3)} ${TOKEN_SYMBOL}`;
        } else {
          tokensLeftValue.textContent = "Error";
        }
      } catch {
        tokensLeftValue.textContent = "Error";
      }
    }

    // Helpers
    const toastEl = (()=>{ const t=document.createElement('div'); t.className="toast"; t.setAttribute('role','alert'); document.body.appendChild(t); return t; })();
    const showToast = (msg) => {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1400);
    };

    async function pasteFromClipboard() {
      if (!navigator.clipboard?.readText) return showToast("Clipboard not available");
      try { walletInput.value = (await navigator.clipboard.readText()).trim(); showToast("Pasted"); }
      catch { showToast("Paste failed"); }
    }
    function clearInput() { walletInput.value = ""; walletInput.focus(); }
    async function connectWallet() {
      const eth = window.ethereum;
      if (!eth?.request) return showToast("No wallet found");
      try {
        const accounts = await eth.request({ method: "eth_requestAccounts" });
        if (accounts?.[0]) { walletInput.value = accounts[0]; showToast("Wallet connected"); }
      } catch { showToast("Connection rejected"); }
    }
    async function copyAirdropAddress() {
      const address = document.getElementById("airdropAddr").innerText.trim();
      try { await navigator.clipboard.writeText(address); showToast("Address copied"); }
      catch {
        const ta = document.createElement("textarea"); ta.value = address; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta); showToast("Address copied");
      }
    }

    // Events
    checkBtn.addEventListener("click", getBalance);
    refreshTokensBtn.addEventListener("click", fetchTokensLeft);
    tokensLeftRefresh.addEventListener("click", fetchTokensLeft);
    pasteBtn.addEventListener("click", pasteFromClipboard);
    clearBtn.addEventListener("click", clearInput);
    connectBtn.addEventListener("click", connectWallet);
    copyAirdropBtn.addEventListener("click", copyAirdropAddress);
    walletInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); getBalance(); } });

    // Hide connect if no provider
    if (!window.ethereum) connectBtn.style.display = "none";

    // Initial render
    fetchTokensLeft();
    currentKTLabel.textContent = "0.000 KT";
    currentPOLLabel.textContent = "≈ 0.000 POL";
    renderLevels(0);
  </script>
</body>
</html>
