<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CyberTerritories â€” Mint your digital land</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Firebase (compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #00f9ff;
      --primary-glow: rgba(0, 249, 255, 0.5);
      --primary-dark: #00b2ff;
      --accent: #ff2cf0;
      --accent-glow: rgba(255, 44, 240, 0.5);
      --success: #12ff9b;
      --success-glow: rgba(18, 255, 155, 0.4);
      --error: #ff3860;
      --error-glow: rgba(255, 56, 96, 0.4);
      --bg: #0c0b1d;
      --bg-dark: #07061a;
      --card: #12122a;
      --text: #eef2ff;
      --muted: #8f9cce;
      --border: #3e3f82;
      --border-glow: rgba(0, 249, 255, 0.2);
      --radius: 12px;
      --shadow: rgba(0, 0, 0, 0.4);
      --neon-shadow: 0 0 10px var(--primary-glow);
      --accent-shadow: 0 0 10px var(--accent-glow);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: 'Rajdhani', sans-serif; background: var(--bg-dark); color: var(--text); overflow-x: hidden; }
    #app-container { display: flex; flex-direction: column; min-height: 100vh; background: radial-gradient(800px at 15% 15%, rgba(0, 249, 255, 0.08), transparent 70%), radial-gradient(600px at 85% 20%, rgba(255, 44, 240, 0.08), transparent 70%), linear-gradient(180deg, var(--bg-dark), var(--bg)); }
    .cyber-grid { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: -1; background-image: linear-gradient(rgba(0, 249, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 249, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; animation: gridPulse 20s infinite linear; }
    @keyframes gridPulse { 0% { background-size: 40px 40px; } 50% { background-size: 42px 42px; } 100% { background-size: 40px 40px; } }

    header { display: flex; align-items: center; justify-content: space-between; padding: 16px; z-index: 10; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo { width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, var(--primary), var(--accent)); display: grid; place-items: center; box-shadow: 0 0 15px rgba(0, 249, 255, 0.4); position: relative; overflow: hidden; }
    .logo::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, var(--primary), transparent 30%); animation: rotate 4s linear infinite; }
    .logo::after { content: ''; position: absolute; inset: 3px; border-radius: 6px; background: var(--bg-dark); }
    .logo .material-icons { font-size: 22px; color: var(--primary); z-index: 2; text-shadow: 0 0 8px var(--primary-glow); }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .title h1 { margin: 0; font-size: 24px; font-weight: 700; font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 1px; background: linear-gradient(90deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 5px rgba(0, 249, 255, 0.3); }
    .title p { margin: 0; font-size: 14px; color: var(--muted); }

    .actions { display: flex; gap: 10px; align-items: center; }
    button { appearance: none; border: 1px solid transparent; border-radius: 8px; padding: 10px 14px; font-size: 14px; font-weight: 600; font-family: 'Rajdhani', sans-serif; color: var(--text); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; background: rgba(32, 33, 77, 0.6); border-color: var(--border); transition: all 0.2s ease; position: relative; overflow: hidden; backdrop-filter: blur(10px); text-transform: uppercase; letter-spacing: 0.5px; }
    button::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: 0.5s; }
    button:hover::after { left: 100%; }
    button .material-icons { font-size: 18px; }
    button.primary { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); border-color: var(--primary); box-shadow: 0 0 10px var(--primary-glow); text-shadow: 0 0 5px var(--primary); }
    button.success { background: linear-gradient(135deg, var(--success), #00ddb9); border-color: var(--success); box-shadow: 0 0 10px var(--success-glow); color: #07172c; font-weight: 700; text-shadow: 0 0 2px rgba(255, 255, 255, 0.5); }
    button:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; }
    button:not(:disabled):active { transform: translateY(1px) scale(0.98); }

    .wallet { color: var(--primary); font-size: 14px; font-weight: 700; text-shadow: 0 0 5px var(--primary-glow); background: rgba(0, 249, 255, 0.1); padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(0, 249, 255, 0.3); }
    .pill { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); background: rgba(15, 16, 40, 0.7); color: var(--muted); backdrop-filter: blur(5px); }
    .pill .material-icons { font-size: 16px; color: var(--primary); }

    main { display: flex; flex-direction: column; align-items: center; padding: 20px 16px; flex: 1; gap: 24px; }
    .hero-image { width: 100%; max-width: 600px; border-radius: var(--radius); overflow: hidden; box-shadow: 0 0 30px var(--primary-glow), 0 0 20px var(--accent-glow); border: 2px solid transparent; background: linear-gradient(135deg, var(--primary), var(--accent)); padding: 3px; }
    .hero-image img { width: 100%; height: auto; display: block; border-radius: calc(var(--radius) - 3px); }

    .mint-section { text-align: center; max-width: 500px; width: 100%; }
    .mint-price { font-size: 18px; margin-bottom: 16px; color: var(--primary); text-shadow: 0 0 8px var(--primary-glow); }

    .status { min-height: 46px; display: grid; place-items: center; text-align: center; font-size: 14px; border-radius: 8px; padding: 12px; background: rgba(8, 9, 33, 0.5); border: 1px solid rgba(62, 63, 130, 0.3); color: var(--muted); }
    .status.success { background: rgba(18, 255, 155, 0.07); color: var(--success); border-color: rgba(18, 255, 155, 0.25); box-shadow: 0 0 10px rgba(18, 255, 155, 0.1); }
    .status.error { background: rgba(255, 56, 96, 0.07); color: var(--error); border-color: rgba(255, 56, 96, 0.25); box-shadow: 0 0 10px rgba(255, 56, 96, 0.1); }
    .status.loading { display: inline-flex; align-items: center; gap: 10px; }
    .spinner { width: 18px; height: 18px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.1); border-left-color: var(--primary); animation: spin 1s linear infinite; box-shadow: 0 0 10px var(--primary-glow); }
    @keyframes spin { to { transform: rotate(360deg); } }

    .minters-panel { background: rgba(18, 18, 42, 0.75); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; backdrop-filter: blur(10px); box-shadow: 0 0 25px var(--shadow); width: 100%; max-width: 600px; }
    .panel-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 8px; border-bottom: 1px solid rgba(62, 63, 130, 0.3); margin-bottom: 12px; }
    .panel-header h2 { margin: 0; font-family: 'Orbitron', sans-serif; font-size: 18px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px var(--primary-glow); }
    .minters-list { list-style: none; margin: 0; padding: 0; max-height: 300px; overflow-y: auto; }
    .minters-list li { padding: 8px 0; border-bottom: 1px dashed rgba(62, 63, 130, 0.2); color: var(--muted); font-size: 14px; display: flex; justify-content: space-between; }
    .minters-list li:last-child { border-bottom: none; }
    .minters-list .addr { font-family: monospace; color: var(--success); }
    .minters-list .time { font-size: 12px; color: #5a5f8a; }

    @media (max-width: 640px) {
      header { flex-direction: column; gap: 12px; }
      .actions { width: 100%; justify-content: space-between; }
      .hero-image { max-width: 100%; }
      .mint-section { padding: 0 12px; }
    }

    @keyframes glitch { 0% { transform: translate(0); } 20% { transform: translate(-2px, 1px); } 40% { transform: translate(-2px, -1px); } 60% { transform: translate(2px, 1px); } 80% { transform: translate(2px, -1px); } 100% { transform: translate(0); } }
    .glitch-text:hover::before, .glitch-text:hover::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .glitch-text:hover::before { animation: glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both infinite; text-shadow: 0 0 5px var(--primary-glow); clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%); transform: translate(-2px, -2px); }
    .glitch-text:hover::after { animation: glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) reverse both infinite; text-shadow: 0 0 5px var(--accent-glow); clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%); transform: translate(2px, 2px); }
  </style>
</head>
<body>
  <div id="app-container">
    <div class="cyber-grid"></div>

    <header>
      <div class="brand">
        <div class="logo"><span class="material-icons">language</span></div>
        <div class="title">
          <h1 class="glitch-text" data-text="CyberTerritories">Cyber Fan</h1>
          <p>Mint your digital avatar in the metaverse</p>
        </div>
      </div>
      <div class="actions">
        <span class="pill">
          <span class="material-icons">paid</span>
          <span>Mint Price: <strong style="margin-left:4px;color:var(--primary);">0.001 $POL</strong></span>
        </span>
        <button id="connectBtn" class="primary">
          <span class="material-icons">account_balance_wallet</span>Connect
        </button>
        <span id="wallet" class="wallet"></span>
      </div>
    </header>

    <main>
      <div class="hero-image">
        <img src="https://pbs.twimg.com/media/G4rqEbIWgAAn8V7?format=jpg&name=medium" alt="CyberTerritories Digital Land">
      </div>

      <div class="mint-section">
        <div class="mint-price">Mint your unique digital territory for only <strong>0.001 $POL</strong></div>
        <button id="mintBtn" class="success" disabled>
          <span class="material-icons">rocket_launch</span>Mint Now
        </button>
        <div id="status" class="status">Connect your wallet to mint</div>
      </div>

      <div class="minters-panel">
        <div class="panel-header">
          <h2>Recent Minters</h2>
        </div>
        <ul id="mintersList" class="minters-list">
          <!-- Filled by JS -->
        </ul>
      </div>
    </main>
  </div>

  <script>
    // Polygon Mainnet
    const POLYGON_PARAMS = { chainId: '0x89', chainName: 'Polygon Mainnet', nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 }, rpcUrls: ['https://polygon-rpc.com/'], blockExplorerUrls: ['https://polygonscan.com/'] };
    const CONTRACT_ADDRESS = "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC";
    const CONTRACT_ABI = [ "function mintWithURI(string tokenURI) external payable returns (uint256)", "function mintPrice() view returns (uint256)", "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)" ];
    const MINT_PRICE = ethers.utils.parseUnits("0.001", 18); // 0.001 POL

    // Firebase config
    const firebaseConfig = { apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY", authDomain: "newnft-47bd7.firebaseapp.com", databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com", projectId: "newnft-47bd7", storageBucket: "newnft-47bd7.firebasestorage.app", messagingSenderId: "172043823738", appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3", measurementId: "G-8VB3DYRNXR" };

    // UI Elements
    const connectBtn = document.getElementById('connectBtn');
    const walletEl = document.getElementById('wallet');
    const mintBtn = document.getElementById('mintBtn');
    const statusEl = document.getElementById('status');
    const mintersList = document.getElementById('mintersList');

    // State
    let web3Provider, signer, userAddress;
    let fbApp, fbDb, mintsRef;

    function shortAddr(a) { return a ? `${a.slice(0,6)}...${a.slice(-4)}` : ''; }
    function setStatus(msg, type = '') {
      statusEl.className = 'status';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'loading') {
        statusEl.classList.add('loading');
        statusEl.innerHTML = `<span class="spinner"></span><span>${msg}</span>`;
      } else {
        statusEl.textContent = msg;
      }
    }

    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_PARAMS.chainId }] });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          try { await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PARAMS] }); return true; }
          catch { setStatus('Failed to add Polygon network', 'error'); return false; }
        }
        setStatus('Failed to switch network', 'error'); return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) { setStatus('Please install MetaMask', 'error'); return; }
      try {
        setStatus('Connecting wallet...', 'loading');
        if (!await switchToPolygon()) return;
        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        await web3Provider.send('eth_requestAccounts', []);
        signer = web3Provider.getSigner();
        userAddress = await signer.getAddress();
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span>Connected';
        walletEl.textContent = shortAddr(userAddress);
        mintBtn.disabled = false;
        setStatus('Wallet connected. Ready to mint!', 'success');
      } catch (e) {
        console.error(e); setStatus('Connection failed', 'error');
      }
    }

    async function mint() {
      if (!userAddress) { setStatus('Connect wallet first', 'error'); return; }
      try {
        setStatus('Preparing transaction...', 'loading');
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const price = await contract.mintPrice().catch(() => MINT_PRICE);
        const tokenURI = "data:application/json;base64," + btoa(JSON.stringify({ name: "CyberTerritory #1", description: "First mint in simplified CyberTerritories", image: "https://pbs.twimg.com/media/G4rqEbIWgAAn8V7?format=jpg&name=medium" }));
        const tx = await contract.mintWithURI(tokenURI, { value: price });
        setStatus('Transaction sent. Waiting...', 'loading');
        const receipt = await tx.wait();
        const ev = receipt.events?.find(e => e.event === 'Transfer');
        const tokenId = ev?.args?.tokenId?.toString();
        await writeMintToFirebase(tokenId);
        setStatus(`Minted! Token #${tokenId}`, 'success');
        mintBtn.disabled = true;
      } catch (e) {
        console.error(e);
        const msg = e?.data?.message || e?.reason || e?.message || 'Transaction failed';
        setStatus(`Mint failed: ${msg}`, 'error');
      }
    }

    function initFirebase() {
      try {
        fbApp = firebase.initializeApp(firebaseConfig);
        fbDb = firebase.database();
        mintsRef = fbDb.ref('mints');
        mintsRef.on('child_added', (snap) => addMinterToList(snap.val()));
      } catch (e) { console.error(e); setStatus("DB connection failed", "error"); }
    }

    async function writeMintToFirebase(tokenId) {
      if (!fbDb || !userAddress) return;
      await fbDb.ref(`mints/${tokenId}`).set({ owner: userAddress, timestamp: Date.now() });
    }

    function addMinterToList(data) {
      if (!data || !data.owner) return;
      const li = document.createElement('li');
      const time = new Date(data.timestamp).toLocaleTimeString();
      li.innerHTML = `<span class="addr">${shortAddr(data.owner)}</span><span class="time">${time}</span>`;
      mintersList.prepend(li);
      if (mintersList.children.length > 50) mintersList.removeChild(mintersList.lastChild);
    }

    // Event Listeners
    connectBtn.addEventListener('click', connectWallet);
    mintBtn.addEventListener('click', mint);
    window.addEventListener('DOMContentLoaded', initFirebase);
  </script>
</body>
</html>
