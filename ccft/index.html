<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Coin.Fun - Trade Coins as NFTs">
  <meta property="og:description" content="The fun way to collect and trade coins as NFTs. Powered by NFTFans Token on Polygon Matic. Start your NFT journey today!">
  <meta property="og:image" content="https://i.imgur.com/AKKhfAe.png">
  <meta property="og:url" content="https://www.nftfanstoken.com/coinfun/">
  <meta property="og:type" content="website">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Coin.Fun - Trade Coins as NFTs">
  <meta name="twitter:description" content="Collect, trade, and earn with Coin.Fun â€” the NFT coin marketplace powered by NFTFans Token on Polygon. Explore now!">
  <meta name="twitter:image" content="https://i.imgur.com/AKKhfAe.png">
  <meta name="twitter:url" content="https://www.nftfanstoken.com/coinfun/">

  <title>Coin.Fun</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
  * {
    box-sizing: border-box;
}

html, body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    background: linear-gradient(145deg, #0a0f1c 0%, #111827 100%);
    color: #fff;
    min-height: 100vh;
    font-size: 10px;
    line-height: 1.4;
}

body.modal-open {
    overflow: hidden;
}

.banner-top {
    width: 100vw;
    max-width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #0a0a0f 0%, #0d1220 50%, #1a1a2e 100%);
    border-bottom: 1px solid rgba(0, 255, 255, 0.3);
    padding: 0;
    margin: 0;
    position: relative;
    overflow: hidden;
    animation: bannerPulse 4s ease-in-out infinite;
}

@keyframes bannerPulse {
    0%, 100% { 
        background: linear-gradient(135deg, #0a0a0f 0%, #0d1220 50%, #1a1a2e 100%);
    }
    50% { 
        background: linear-gradient(135deg, #0f0f1a 0%, #121829 50%, #1e1e33 100%);
    }
}

.banner-top::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 25% 25%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(255, 0, 255, 0.08) 0%, transparent 50%),
        linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.05) 50%, transparent 70%);
    pointer-events: none;
    animation: backgroundShimmer 6s ease-in-out infinite;
}

@keyframes backgroundShimmer {
    0%, 100% { opacity: 0.7; }
    50% { opacity: 1; }
}

.banner-top::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -100%;
    right: -100%;
    bottom: -2px;
    background: linear-gradient(90deg, 
        transparent,
        #00ffff 20%,
        #ff00ff 40%, 
        #00ff00 60%,
        #ffff00 80%,
        transparent
    );
    animation: topBorderScan 4s linear infinite;
    z-index: 1;
}

@keyframes topBorderScan {
    0% { left: -100%; }
    100% { left: 100%; }
}

.banner-top img {
    width: 100%;
    max-width: 480px;
    object-fit: cover;
    display: block;
    margin: 0 auto;
    border-radius: 0 0 100px 2px;
    position: relative;
    z-index: 2;
    filter: brightness(1.1) contrast(1.1) saturate(1.2);
    transition: all 0.4s ease;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 4px 16px rgba(0, 255, 255, 0.1);
}

.banner-top img::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: conic-gradient(
        from 0deg,
        #00ffff,
        #ff00ff,
        #00ff00,
        #ffff00,
        #ff0080,
        #00ffff
    );
    border-radius: 0 0 22px 22px;
    z-index: -1;
    animation: hueBorderRotate 3s linear infinite;
}

@keyframes hueBorderRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.wrapper {
    max-width: 480px;
    margin: 0 auto;
    padding: 12px 0 40px 0;
    position: relative;
    background: linear-gradient(180deg, 
        rgba(0, 255, 255, 0.02) 0%, 
        transparent 50%, 
        rgba(255, 0, 255, 0.02) 100%
    );
    border-radius: 0 0 24px 24px;
    overflow: hidden;
}

.wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 50% 0%, rgba(0, 255, 255, 0.05) 0%, transparent 60%);
    pointer-events: none;
    animation: wrapperGlow 5s ease-in-out infinite;
}

@keyframes wrapperGlow {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.wrapper::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        transparent,
        #00ffff 25%,
        #ff00ff 50%,
        #00ffff 75%,
        transparent
    );
    animation: bottomGlow 3s ease-in-out infinite;
}

@keyframes bottomGlow {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

.image-container {
    position: relative;
    display: inline-block;
    border-radius: 0 0 20px 20px;
    overflow: hidden;
}

.image-container::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    background: conic-gradient(
        from 0deg,
        #00ffff 0deg,
        #0080ff 60deg,
        #8000ff 120deg,
        #ff0080 180deg,
        #ff8000 240deg,
        #80ff00 300deg,
        #00ffff 360deg
    );
    border-radius: 0 0 24px 24px;
    z-index: -1;
    animation: hueBorderSpin 4s linear infinite;
}

@keyframes hueBorderSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.image-container::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: conic-gradient(
        from 180deg,
        transparent 0deg,
        #00ffff 90deg,
        transparent 180deg,
        #ff00ff 270deg,
        transparent 360deg
    );
    border-radius: 0 0 22px 22px;
    z-index: -1;
    animation: hueBorderSpin 2s linear infinite reverse;
    opacity: 0.7;
}

.banner-top:hover img {
    transform: scale(1.02);
    filter: brightness(1.2) contrast(1.2) saturate(1.3);
    box-shadow: 
        0 12px 48px rgba(0, 0, 0, 0.5),
        0 6px 24px rgba(0, 255, 255, 0.2);
}

.header {
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    padding: 20px 32px;
    font-weight: 600;
    font-size: 14px;
    border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    letter-spacing: 0.8px;
    color: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    box-shadow: 
        0 8px 32px rgba(0, 255, 255, 0.1),
        0 4px 20px rgba(138, 43, 226, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    overflow: hidden;
    animation: headerPulse 4s ease-in-out infinite;
}

@keyframes headerPulse {
    0%, 100% { box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1), 0 4px 20px rgba(138, 43, 226, 0.1); }
    50% { box-shadow: 0 12px 40px rgba(0, 255, 255, 0.2), 0 6px 30px rgba(138, 43, 226, 0.2); }
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        transparent, 
        #00ffff 20%, 
        #ff00ff 40%, 
        #00ff00 60%, 
        #ffff00 80%, 
        transparent
    );
    animation: borderScan 3s linear infinite;
}

@keyframes borderScan {
    0% { left: -100%; }
    100% { left: 100%; }
}

.header::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, rgba(138, 43, 226, 0.05) 0%, transparent 70%);
    pointer-events: none;
    animation: backgroundShift 6s ease-in-out infinite;
}

@keyframes backgroundShift {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 2;
    position: relative;
}

.header .material-icons {
    font-size: 26px;
    background: linear-gradient(135deg, #00ffff, #ff00ff, #00ff00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    vertical-align: middle;
    filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.6));
    animation: iconGlow 2s ease-in-out infinite alternate;
    cursor: pointer;
    transition: all 0.3s ease;
}

.header .material-icons:hover {
    transform: scale(1.2) rotate(10deg);
    filter: drop-shadow(0 0 25px rgba(0, 255, 255, 0.8));
}

@keyframes iconGlow {
    0% { filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.6)); }
    100% { filter: drop-shadow(0 0 25px rgba(255, 0, 255, 0.8)); }
}

.header-title {
    font-size: 18px;
    font-weight: 800;
    background: linear-gradient(135deg, 
        #00ffff 0%, 
        #ff00ff 25%, 
        #00ff00 50%, 
        #ffff00 75%, 
        #ff0080 100%
    );
    background-size: 300% 300%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: titleShimmer 3s ease-in-out infinite;
    text-transform: uppercase;
    letter-spacing: 2px;
    position: relative;
}

.header-title::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #00ffff, transparent);
    animation: underlineGlow 2s ease-in-out infinite;
}

@keyframes titleShimmer {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

@keyframes underlineGlow {
    0%, 100% { opacity: 0.3; transform: scaleX(0.5); }
    50% { opacity: 1; transform: scaleX(1); }
}

.header-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
}

.particle {
    position: absolute;
    width: 2px;
    height: 2px;
    background: #00ffff;
    border-radius: 50%;
    opacity: 0;
    animation: floatParticle 8s linear infinite;
}

.particle:nth-child(2) { animation-delay: -2s; background: #ff00ff; }
.particle:nth-child(3) { animation-delay: -4s; background: #00ff00; }
.particle:nth-child(4) { animation-delay: -6s; background: #ffff00; }

@keyframes floatParticle {
    0% {
        transform: translateY(100%) translateX(0) scale(0);
        opacity: 0;
    }
    10% {
        opacity: 1;
        transform: translateY(90%) translateX(10px) scale(1);
    }
    90% {
        opacity: 1;
        transform: translateY(10%) translateX(-10px) scale(1);
    }
    100% {
        transform: translateY(0%) translateX(0) scale(0);
        opacity: 0;
    }
}

.header:hover {
    transform: translateY(-2px) scale(1.01);
    box-shadow: 
        0 16px 48px rgba(0, 255, 255, 0.2),
        0 8px 32px rgba(138, 43, 226, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.wallet-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    border-radius: 12px;
    margin: 12px 8px;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(59, 130, 246, 0.2);
}

.nftfan-balance-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 600;
    color: #93c5fd;
}

.nftfan-token-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid rgba(0, 255, 255, 0.3);
}

.connect-btn {
    padding: 10px 18px;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    color: #e2e8f0;
    font-size: 12px;
    min-width: 120px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    position: relative;
    z-index: 2;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.connect-btn::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, 
        #ff0000, #ff7300, #fffb00, #48ff00, 
        #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
    background-size: 400% 400%;
    border-radius: 14px;
    z-index: -1;
    animation: rainbow 3s ease-in-out infinite;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.connect-btn:hover::before {
    opacity: 1;
}

.connect-btn::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.6s ease;
    z-index: 1;
}

.connect-btn:hover::after {
    left: 100%;
}

.connect-btn .material-icons {
    font-size: 16px;
    color: #60a5fa;
    text-shadow: 0 0 8px rgba(96, 165, 250, 0.3);
}

.connect-btn:hover, .connect-btn:focus {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    color: #ffffff;
    outline: none;
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 12px 32px rgba(59, 130, 246, 0.25);
}

.connect-btn:active {
    transform: translateY(0) scale(0.98);
}

@keyframes rainbow {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.status-bar {
    padding: 16px 20px;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    border-radius: 16px;
    margin: 16px 12px 20px 12px;
    font-size: 12px;
    min-height: 28px;
    text-align: left;
    font-weight: 600;
    border: 1px solid rgba(0, 255, 255, 0.2);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(0, 255, 255, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    word-break: break-word;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(20px);
    animation: statusPulse 3s ease-in-out infinite;
}

@keyframes statusPulse {
    0%, 100% { 
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.3),
            0 4px 16px rgba(0, 255, 255, 0.1);
    }
    50% { 
        box-shadow: 
            0 12px 40px rgba(0, 0, 0, 0.4),
            0 6px 24px rgba(0, 255, 255, 0.2);
    }
}

.status-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 6px;
    height: 100%;
    background: linear-gradient(180deg, currentColor, transparent, currentColor);
    opacity: 0.8;
    animation: leftBorderGlow 2s ease-in-out infinite alternate;
}

@keyframes leftBorderGlow {
    0% { opacity: 0.5; filter: blur(0px); }
    100% { opacity: 1; filter: blur(1px); }
}

.status-bar::after {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    bottom: -50%;
    left: -50%;
    background: conic-gradient(from 0deg, transparent, currentColor, transparent);
    opacity: 0.1;
    animation: backgroundRotate 6s linear infinite;
    pointer-events: none;
}

@keyframes backgroundRotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-bar .material-icons {
    font-size: 20px;
    vertical-align: middle;
    padding-right: 4px;
    transition: all 0.3s ease;
    filter: drop-shadow(0 0 12px currentColor);
    animation: iconFloat 3s ease-in-out infinite;
    z-index: 2;
    position: relative;
}

@keyframes iconFloat {
    0%, 100% { transform: translateY(0px) scale(1); }
    50% { transform: translateY(-3px) scale(1.1); }
}

.status-bar:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
        0 16px 48px rgba(0, 0, 0, 0.4),
        0 8px 24px rgba(0, 255, 255, 0.2),
        inset 0 2px 0 rgba(255, 255, 255, 0.2);
}

.status-bar:hover .material-icons {
    transform: scale(1.3) rotate(15deg);
    filter: drop-shadow(0 0 20px currentColor);
}

.status-info { 
    background: linear-gradient(135deg, #0f1419 0%, #1e3a8a 50%, #312e81 100%); 
    color: #00d4ff; 
    border-color: rgba(0, 212, 255, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(0, 212, 255, 0.15),
        inset 0 1px 0 rgba(0, 212, 255, 0.2);
}

.status-success { 
    background: linear-gradient(135deg, #0a1f0a 0%, #064e3b 50%, #14532d 100%); 
    color: #00ff88; 
    border-color: rgba(0, 255, 136, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(0, 255, 136, 0.15),
        inset 0 1px 0 rgba(0, 255, 136, 0.2);
}

.status-error { 
    background: linear-gradient(135deg, #1f0a0a 0%, #7f1d1d 50%, #991b1b 100%); 
    color: #ff0066; 
    border-color: rgba(255, 0, 102, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(255, 0, 102, 0.15),
        inset 0 1px 0 rgba(255, 0, 102, 0.2);
}

.status-warn { 
    background: linear-gradient(135deg, #1f1a0a 0%, #92400e 50%, #b45309 100%); 
    color: #ffaa00; 
    border-color: rgba(255, 170, 0, 0.4);
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 4px 16px rgba(255, 170, 0, 0.15),
        inset 0 1px 0 rgba(255, 170, 0, 0.2);
}

.status-bar.status-success .material-icons { 
    color: #00ff88; 
    filter: drop-shadow(0 0 15px #00ff88);
}

.status-bar.status-error .material-icons { 
    color: #ff0066; 
    filter: drop-shadow(0 0 15px #ff0066);
}

.status-bar.status-warn .material-icons { 
    color: #ffaa00; 
    filter: drop-shadow(0 0 15px #ffaa00);
}

.status-bar.status-info .material-icons { 
    color: #00d4ff; 
    filter: drop-shadow(0 0 15px #00d4ff);
}

.status-bar-particles {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: hidden;
    z-index: 1;
}

.status-particle {
    position: absolute;
    width: 1px;
    height: 1px;
    background: currentColor;
    border-radius: 50%;
    opacity: 0;
    animation: statusParticleFloat 4s linear infinite;
}

.status-particle:nth-child(2) { animation-delay: -1s; }
.status-particle:nth-child(3) { animation-delay: -2s; }
.status-particle:nth-child(4) { animation-delay: -3s; }

@keyframes statusParticleFloat {
    0% {
        transform: translateX(0) translateY(0) scale(0);
        opacity: 0;
    }
    20% {
        opacity: 1;
        transform: translateX(20px) translateY(-5px) scale(1);
    }
    80% {
        opacity: 1;
        transform: translateX(80px) translateY(-10px) scale(1);
    }
    100% {
        transform: translateX(100px) translateY(-15px) scale(0);
        opacity: 0;
    }
}

.status-bar-text {
    flex: 1;
    z-index: 2;
    position: relative;
    text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}

.tab-bar {
    display: flex;
    gap: 6px;
    margin: 0 8px 12px 8px;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: 12px;
    overflow: hidden;
    padding: 4px;
    border: 1px solid rgba(59, 130, 246, 0.2);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.tab-btn {
    flex: 1;
    padding: 10px 8px;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    color: #94a3b8;
    font-size: 9px;
    letter-spacing: 0.02em;
    transition: all 0.3s ease;
    outline: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    position: relative;
}

.tab-btn .material-icons {
    font-size: 14px;
    margin-bottom: 1px;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: #fff;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    transform: translateY(-1px);
}

.tab-btn:hover:not(.active) {
    background: rgba(59, 130, 246, 0.1);
    color: #e2e8f0;
    transform: translateY(-1px);
}

.tab-btn:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

.nft-list {
    list-style: none;
    padding: 0;
    margin: 12px 0 0 0;
}

.nft-post {
    display: flex;
    align-items: stretch;
    justify-content: space-between;
    padding: 14px 0;
    background: transparent;
    position: relative;
    font-size: 10px;
    gap: 16px;
    border: none;
    transition: all 0.3s ease;
}

.nft-post:hover {
    background: rgba(59, 130, 246, 0.02);
    transform: translateX(2px);
}

.nft-post:not(:last-child)::after {
    content: "";
    display: block;
    position: absolute;
    left: 60px;
    right: 8px;
    bottom: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.2), transparent);
    opacity: 1;
    z-index: 1;
}

.nft-post-left {
    display: flex;
    align-items: center;
    gap: 14px;
    flex: 1;
    min-width: 0;
}

.serial-number {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 42px;
    min-width: 24px;
    font-size: 12px;
    color: #64748b;
    font-family: inherit;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-align: center;
    margin-right: 0;
}

.nft-avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background-color: #fff;
    object-fit: cover;
    border: 2px solid rgba(59, 130, 246, 0.2);
    flex-shrink: 0;
    display: block;
    transition: all 0.3s ease;
}

.nft-avatar:hover {
    transform: scale(1.05);
    border-color: rgba(59, 130, 246, 0.4);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.15);
}

.nft-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.nft-title {
    font-weight: 700;
    font-size: 11px;
    color: #e2e8f0;
    line-height: 1.3;
    margin-bottom: 2px;
    white-space: normal;
    word-break: break-word;
    display: flex;
    align-items: center;
    gap: 8px;
}

.nft-supply {
    color: #64748b;
    font-size: 9px;
    font-weight: 500;
    margin-left: 6px;
}

.nft-description {
    font-size: 9px;
    color: #94a3b8;
    margin-top: 2px;
    max-width: 240px;
    white-space: normal;
    word-break: break-word;
    line-height: 1.4;
}

.nft-actions {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    margin-left: 12px;
    min-width: 100px;
    justify-content: center;
}

.nft-status-label {
    align-items: center;
    gap: 4px;
    font-size: 8px;
    font-weight: 700;
    padding: 4px 8px;
    margin-left: 8px;
    margin-top: 2px;
    color: #d1fae5;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.nft-status-listed {
    background: linear-gradient(135deg, #064e3b 0%, #14532d 100%);
    border: 1px solid rgba(0, 255, 136, 0.3);
}

.nft-status-notlisted {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    border: 1px solid rgba(75, 85, 99, 0.3);
}

.price-tab {
    background: linear-gradient(135deg, #1e40af 0%, #1d4ed8 100%);
    color: #dbeafe;
    font-size: 10px;
    font-weight: 700;
    border-radius: 16px;
    padding: 8px 12px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    margin: 0;
    min-width: 80px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
    display: flex;
    align-items: center;
    gap: 4px;
    letter-spacing: 0.2px;
    transition: all 0.3s ease;
}

.price-tab:hover {
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(30, 64, 175, 0.3);
}

.price-tab .material-icons {
    font-size: 14px;
    color: #93c5fd;
    margin-right: 2px;
}

.buy-btn, .sell-btn, .delist-btn {
    font-size: 10px;
    padding: 8px 16px;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    letter-spacing: 0.1px;
    display: flex;
    align-items: center;
    gap: 5px;
    position: relative;
    overflow: hidden;
}

.buy-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.sell-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
}

.delist-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.buy-btn .material-icons, 
.sell-btn .material-icons, 
.delist-btn .material-icons {
    font-size: 14px;
    margin-bottom: 1px;
}

.buy-btn:disabled, 
.sell-btn:disabled, 
.delist-btn:disabled {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    color: #6b7280;
    cursor: not-allowed;
}

.buy-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
}

.sell-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
}

.delist-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
}

.sold-out {
    font-size: 10px;
    color: #f87171;
    font-weight: 700;
    margin-left: 0;
    display: flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    padding: 6px 10px;
    border-radius: 12px;
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.sold-out .material-icons {
    font-size: 14px;
    color: #ef4444;
}

.loading {
    color: #60a5fa;
    text-align: center;
    padding: 18px 0;
    font-size: 10px;
    position: relative;
    overflow: hidden;
}

.loading::before {
    content: '';
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #60a5fa;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error-message {
    background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
    color: #f87171;
    padding: 7px 10px;
    border-radius: 6px;
    margin-bottom: 7px;
    font-size: 9px;
    text-align: left;
    border: 1px solid rgba(239, 68, 68, 0.3);
    transition: opacity 0.3s ease;
    display: none;
}

.error-message[style*="block"] {
    display: block;
    opacity: 1;
}

#sellModal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(8px);
    justify-content: center;
    align-items: center;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

#sellModal[style*="flex"] {
    display: flex;
}

#sellModalContent {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    padding: 20px 16px 16px 16px;
    border-radius: 16px;
    box-shadow: 0 20px 64px rgba(0, 0, 0, 0.3);
    min-width: 240px;
    max-width: 96vw;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    font-size: 10px;
    color: #fff;
    border: 1px solid rgba(59, 130, 246, 0.3);
    gap: 10px;
    position: relative;
}

#sellModalContent h3 {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    margin: 0 0 10px 0;
    color: #e2e8f0;
    font-weight: 700;
}

#sellModalContent input {
    margin: 4px 0 8px 0;
    padding: 8px 10px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 8px;
    width: 97%;
    font-size: 16px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: #fff;
    outline: none;
    transition: all 0.3s ease;
}

#sellModalContent input:focus {
    border: 2px solid #3b82f6;
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

#sellModalContent button {
    padding: 8px 16px;
    border-radius: 8px;
    border: none;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: #fff;
    font-weight: 700;
    cursor: pointer;
    font-size: 10px;
    margin-top: 6px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

#sellModalContent button:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
}

#sellModalContent button .material-icons {
    font-size: 14px;
    margin-bottom: 1px;
}

#sellModalContent button:hover { 
    background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    transform: translateY(-1px);
    box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
}

#sellModalContent .cancel-btn {
    background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    color: #fff;
    margin-left: 8px;
    border: 1px solid #4b5563;
}

#sellModalClose {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 20px;
    cursor: pointer;
    z-index: 2;
    display: flex;
    align-items: center;
    padding: 4px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

#sellModalClose:hover { 
    color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

#sellModalClose:focus {
    outline: 2px solid #ef4444;
    outline-offset: 2px;
}

@media (max-width: 768px) {
    .wrapper {
        padding: 8px 0 32px 0;
    }
    
    .banner-top img {
        border-radius: 0 0 12px 12px;
    }
    
    .image-container::before,
    .image-container::after {
        border-radius: 0 0 12px 12px;
    }
    
    .header {
        padding: 16px 20px;
    }
    
    .header-title {
        font-size: 16px;
        letter-spacing: 1px;
    }
    
    .header .material-icons {
        font-size: 22px;
    }
    
    .status-bar {
        padding: 12px 16px;
        margin: 12px 8px 16px 8px;
        font-size: 11px;
        gap: 8px;
    }
    
    .status-bar .material-icons {
        font-size: 18px;
    }
    
    .tab-bar {
        margin: 0 6px 10px 6px;
    }
    
    .wallet-container {
        padding: 10px 12px;
        margin: 10px 6px;
        flex-wrap: wrap;
        gap: 8px;
    }
}

@media (max-width: 600px) {
    .wrapper { 
        max-width: 100vw; 
        padding: 0; 
    }
    .nft-avatar { 
        width: 32px; 
        height: 32px; 
        border-radius: 50%;
    }
    .serial-number { 
        height: 32px; 
        min-width: 16px; 
        font-size: 10px;
    }
    .nft-title { 
        font-size: 10px; 
    }
    .buy-btn, .sell-btn, .delist-btn { 
        font-size: 9px; 
        padding: 6px 12px; 
    }
    .nft-description { 
        font-size: 8px; 
        max-width: 120px; 
    }
    .nft-post { 
        padding: 10px 0; 
    }
    .price-tab { 
        font-size: 9px; 
        padding: 6px 10px; 
        min-width: 60px;
    }
    .nft-actions { 
        gap: 6px; 
        margin-left: 8px;
        min-width: 80px;
    }
    .nft-post:not(:last-child)::after { 
        left: 50px; 
    }
    .banner-top img { 
        max-width: 100vw; 
        border-radius: 0 0 12px 12px;
    }
    .status-bar {
        margin: 10px 6px 12px 6px;
        padding: 10px 12px;
        font-size: 10px;
        z-index: 9999;
    }
    .header {
        font-size: 12px;
        padding: 10px 6px;
    }
    .wallet-container {
        padding: 8px 6px;
    }
}

@media (max-width: 400px) {
    .banner-top img {
        max-height: 150px;
    }
    .wrapper {
        padding-bottom: 24px;
    }
    .tab-bar {
        flex-direction: column;
        gap: 4px;
    }
    .tab-btn {
        padding: 8px;
        font-size: 8px;
    }
    .nft-post {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .nft-actions {
        align-items: flex-start;
        min-width: auto;
    }
}
  
   </style>
</head>
<body>
  <div class="banner-top">
    <img src="https://pbs.twimg.com/media/GtAPA6qXEAA4du1?format=jpg&name=large" alt="Banner">
  </div>
  <div class="wrapper">
    <div class="header">
      <div class="header-left">
        <span class="material-icons">currency_bitcoin</span>
        <div class="header-title">Coin.Fun</div>
      </div>
      <div class="header-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
      </div>
    </div>
    <div class="top-bar wallet-container">
      <div class="nftfan-balance-bar" id="nftfanBalanceBar" style="display:none;">
        <img class="nftfan-token-icon" src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Token">
        <span id="nftfanBalance">--</span>
        <span style="font-size:7px;font-weight:400;color:#888;margin-left:2px;">NFTFAN</span>
      </div>
      <button class="connect-btn" id="connect-btn" onclick="connectWallet()">
        <span class="material-icons">link</span>
        Connect Wallet
      </button>
    </div>
    <div class="status-bar status-info" id="statusBar">
      <span class="material-icons" id="statusBarIcon">info</span>
      <span class="status-bar-text">Status: Initializing...</span>
      <div class="status-bar-particles">
        <div class="status-particle"></div>
        <div class="status-particle"></div>
        <div class="status-particle"></div>
        <div class="status-particle"></div>
      </div>
    </div>
    <div class="tab-bar">
      <button class="tab-btn" id="tab-listings" onclick="showTab('listings')" aria-label="View User Listings">
        <span class="material-icons">list_alt</span>User Listings
      </button>
      <button class="tab-btn active" id="tab-shop" onclick="showTab('shop')" aria-label="View Coin Shop">
        <span class="material-icons">storefront</span>Coin Shop
      </button>
      <button class="tab-btn" id="tab-mynfts" onclick="showTab('mynfts')" aria-label="View My Coins">
        <span class="material-icons">account_balance_wallet</span>My Coins
      </button>
    </div>
    <!-- Shop Tab -->
    <div class="tab-content" id="tab-content-shop">
      <div id="shop-loading" class="loading">Loading NFTs...</div>
      <div id="shop-error" class="error-message" style="display: none;"></div>
      <ul class="nft-list" id="shopGrid" style="display: none;"></ul>
    </div>
    <!-- My NFTs Tab -->
    <div class="tab-content" id="tab-content-mynfts" style="display:none;">
      <div id="my-loading" class="loading">Loading Your NFTs...</div>
      <div id="my-error" class="error-message" style="display: none;"></div>
      <ul class="nft-list" id="myGrid" style="display: none;"></ul>
    </div>
    <!-- User Listings Tab -->
    <div class="tab-content" id="tab-content-listings" style="display:none;">
      <div id="listings-loading" class="loading">Loading User Listings...</div>
      <div id="listings-error" class="error-message" style="display: none;"></div>
      <ul class="nft-list" id="listingsGrid" style="display: none;"></ul>
    </div>
  </div>
  <!-- Sell Modal -->
  <div id="sellModal" role="dialog" aria-labelledby="sellModalTitle" aria-modal="true">
    <div id="sellModalContent">
      <button id="sellModalClose" onclick="closeSellModal()" aria-label="Close Modal">
        <span class="material-icons">close</span>
      </button>
      <h3 id="sellModalTitle">
        <span class="material-icons">sell</span>
        Sell Your NFT
      </h3>
      <div>
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">confirmation_number</span>
        Token ID: <span id="sellTokenId"></span>
      </div>
      <div>
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">inventory_2</span>
        You own: <span id="sellMaxAmount"></span>
      </div>
      <input type="number" id="sellAmountInput" min="1" placeholder="Amount to sell" aria-label="Amount to sell">
      <input type="number" id="sellPriceInput" step="0.000000000000000001" placeholder="Price per NFT (MATIC)" aria-label="Price per NFT in MATIC">
      <div style="display:flex;gap:7px;width:100%;justify-content:flex-start;">
        <button onclick="confirmSellNFT()" aria-label="Confirm Sell">
          <span class="material-icons">check_circle</span>Sell
        </button>
        <button onclick="closeSellModal()" class="cancel-btn" aria-label="Cancel Sell">
          <span class="material-icons">cancel</span>Cancel
        </button>
      </div>
      <div id="sellModalError" class="error-message"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
  
  <script>
  
  const contractAddress = "0x582E752646c6df16a14247994f1848C7Cd208211";
const contractABI = [
    {
        "inputs": [
            {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"internalType": "uint256", "name": "amount", "type": "uint256"}
        ],
        "name": "buyNFT",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
        ],
        "name": "cancelListing",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
        ],
        "name": "getListings",
        "outputs": [
            {
                "components": [
                    {"internalType": "address", "name": "seller", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"},
                    {"internalType": "uint256", "name": "price", "type": "uint256"}
                ],
                "internalType": "struct CoinFun.Listing[]",
                "name": "",
                "type": "tuple[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [],
        "name": "getShopNFTs",
        "outputs": [
            {
                "components": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
                    {"internalType": "string", "name": "tokenURI", "type": "string"},
                    {"internalType": "uint256", "name": "price", "type": "uint256"},
                    {"internalType": "uint256", "name": "availableSupply", "type": "uint256"},
                    {"internalType": "uint256", "name": "totalSupply", "type": "uint256"}
                ],
                "internalType": "struct CoinFun.ShopNFT[]",
                "name": "",
                "type": "tuple[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
        ],
        "name": "nftInfo",
        "outputs": [
            {"internalType": "string", "name": "tokenURI", "type": "string"},
            {"internalType": "uint256", "name": "price", "type": "uint256"},
            {"internalType": "uint256", "name": "availableSupply", "type": "uint256"},
            {"internalType": "uint256", "name": "totalSupply", "type": "uint256"}
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"internalType": "uint256", "name": "amount", "type": "uint256"},
            {"internalType": "uint256", "name": "price", "type": "uint256"}
        ],
        "name": "sellNFT",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
    },
    {
        "inputs": [
            {"internalType": "address", "name": "owner", "type": "address"}
        ],
        "name": "tokensOfOwner",
        "outputs": [
            {
                "components": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "internalType": "struct CoinFun.TokenOwnership[]",
                "name": "",
                "type": "tuple[]"
            }
        ],
        "stateMutability": "view",
        "type": "function"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"indexed": true, "internalType": "address", "name": "buyer", "type": "address"},
            {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"},
            {"indexed": false, "internalType": "uint256", "name": "price", "type": "uint256"}
        ],
        "name": "NFTBought",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"indexed": true, "internalType": "address", "name": "seller", "type": "address"},
            {"indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256"},
            {"indexed": false, "internalType": "uint256", "name": "price", "type": "uint256"}
        ],
        "name": "NFTListed",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"indexed": true, "internalType": "address", "name": "minter", "type": "address"},
            {"indexed": false, "internalType": "string", "name": "tokenURI", "type": "string"},
            {"indexed": false, "internalType": "uint256", "name": "totalSupply", "type": "uint256"}
        ],
        "name": "NFTMinted",
        "type": "event"
    },
    {
        "anonymous": false,
        "inputs": [
            {"indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256"},
            {"indexed": true, "internalType": "address", "name": "seller", "type": "address"}
        ],
        "name": "NFTUnlisted",
        "type": "event"
    }
];

const POLYGON_CHAIN_ID = "0x89";
const RPC_URLS = [
    "https://polygon-rpc.com",
    "https://rpc-mainnet.matic.network",
    "https://matic-mainnet.chainstacklabs.com"
];
const DEFAULT_IMAGE = "https://via.placeholder.com/42?text=NFT";

let web3, contract, userAddress, isInitialized = false;
let currentTab = "shop";
const metadataCache = new Map();
const retryAttempts = 3;
const retryDelay = 1000;

document.addEventListener("DOMContentLoaded", async () => {
    if (!window.ethereum) {
        updateStatus("error", "MetaMask is not installed. Please install it to use Coin.Fun.");
        return;
    }
    await setupWeb3();
    await setupContracts();
    await loadInitialData();
    setupEventListeners();
});

async function setupWeb3() {
    for (let i = 0; i < retryAttempts; i++) {
        try {
            web3 = new Web3(window.ethereum);
            const chainId = await web3.eth.getChainId();
            if (chainId !== parseInt(POLYGON_CHAIN_ID, 16)) {
                await switchToPolygon();
            }
            updateStatus("info", "Connected to Polygon network");
            return;
        } catch (error) {
            console.error(`Web3 setup attempt ${i + 1} failed:`, error);
            if (i < retryAttempts - 1) {
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                web3 = new Web3(RPC_URLS[i % RPC_URLS.length]);
            } else {
                updateStatus("error", "Failed to connect to Polygon network. Please check your connection.");
            }
        }
    }
}

async function switchToPolygon() {
    try {
        await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: POLYGON_CHAIN_ID }]
        });
    } catch (switchError) {
        if (switchError.code === 4902) {
            await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [{
                    chainId: POLYGON_CHAIN_ID,
                    chainName: "Polygon Mainnet",
                    nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
                    rpcUrls: RPC_URLS,
                    blockExplorerUrls: ["https://polygonscan.com/"]
                }]
            });
        } else {
            throw switchError;
        }
    }
}

async function setupContracts() {
    try {
        contract = new web3.eth.Contract(contractABI, contractAddress);
        isInitialized = true;
        updateStatus("success", "Contract initialized successfully");
    } catch (error) {
        console.error("Contract setup failed:", error);
        updateStatus("error", "Failed to initialize contract. Please refresh and try again.");
    }
}

async function connectWallet() {
    try {
        const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
        userAddress = accounts[0];
        document.getElementById("connect-btn").innerHTML = `
            <span class="material-icons">account_balance_wallet</span>
            ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}
        `;
        updateStatus("success", "Wallet connected successfully");
        await loadUserNFTs();
        if (currentTab === "mynfts") {
            await showTab("mynfts");
        }
    } catch (error) {
        console.error("Wallet connection failed:", error);
        updateStatus("error", `Failed to connect wallet: ${error.message}`);
    }
}

function setupEventListeners() {
    if (window.ethereum) {
        window.ethereum.on("accountsChanged", async (accounts) => {
            if (accounts.length === 0) {
                userAddress = null;
                document.getElementById("connect-btn").innerHTML = `
                    <span class="material-icons">link</span>Connect Wallet
                `;
                updateStatus("warn", "Wallet disconnected");
                await showTab(currentTab);
            } else {
                await connectWallet();
            }
        });

        window.ethereum.on("chainChanged", async (chainId) => {
            if (chainId !== POLYGON_CHAIN_ID) {
                await switchToPolygon();
            }
            await loadInitialData();
        });

        window.addEventListener("unload", () => {
            window.ethereum.removeAllListeners("accountsChanged");
            window.ethereum.removeAllListeners("chainChanged");
        });
    }

    const sellModal = document.getElementById("sellModal");
    sellModal.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            closeSellModal();
        } else if (e.key === "Enter" && document.activeElement !== document.getElementById("sellModalClose")) {
            confirmSellNFT();
        }
    });

    const focusableElements = sellModal.querySelectorAll('button, input');
    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    sellModal.addEventListener("keydown", (e) => {
        if (e.key === "Tab") {
            if (e.shiftKey && document.activeElement === firstElement) {
                e.preventDefault();
                lastElement.focus();
            } else if (!e.shiftKey && document.activeElement === lastElement) {
                e.preventDefault();
                firstElement.focus();
            }
        }
    });
}

async function loadInitialData() {
    updateStatus("info", "Loading initial data...");
    await Promise.all([
        showTab("shop"),
        userAddress ? loadUserNFTs() : Promise.resolve()
    ]);
}

async function showTab(tabId) {
    currentTab = tabId;
    const tabs = ["shop", "mynfts", "listings"];
    tabs.forEach(tab => {
        const tabBtn = document.getElementById(`tab-${tab}`);
        const tabContent = document.getElementById(`tab-content-${tab}`);
        if (!tabBtn || !tabContent) {
            updateStatus("error", `Tab element missing for ${tab}`);
            return;
        }
        tabBtn.classList.toggle("active", tab === tabId);
        tabContent.style.display = tab === tabId ? "block" : "none";
    });

    document.getElementById(`${tabId}-loading`).style.display = "block";
    document.getElementById(`${tabId}-error`).style.display = "none";
    document.getElementById(`${tabId}Grid`).style.display = "none";

    try {
        if (tabId === "shop") {
            await loadShopNFTs();
        } else if (tabId === "mynfts") {
            await loadUserNFTs();
        } else if (tabId === "listings") {
            await loadUserListings();
        }
        document.getElementById(`${tabId}Grid`).style.display = "block";
    } catch (error) {
        console.error(`Failed to load ${tabId} data:`, error);
        document.getElementById(`${tabId}-error`).style.display = "block";
        document.getElementById(`${tabId}-error`).textContent = `Error: ${error.message}`;
    } finally {
        document.getElementById(`${tabId}-loading`).style.display = "none";
    }
}

async function loadShopNFTs() {
    if (!isInitialized) return;
    const grid = document.getElementById("shopGrid");
    grid.innerHTML = "";
    try {
        const nfts = await contract.methods.getShopNFTs().call();
        for (const nft of nfts) {
            if (localStorage.getItem(`soldout_${nft.tokenId}`)) continue;
            const metadata = await fetchMetadata(nft.tokenURI, nft.tokenId);
            if (nft.availableSupply === "0") {
                localStorage.setItem(`soldout_${nft.tokenId}`, "true");
                continue;
            }
            const li = createNFTElement(nft, metadata, "shop");
            grid.appendChild(li);
        }
        if (grid.children.length === 0) {
            grid.innerHTML = "<li>No NFTs available in the shop.</li>";
        }
    } catch (error) {
        console.error("Failed to load shop NFTs:", error);
        document.getElementById("shop-error").style.display = "block";
        document.getElementById("shop-error").textContent = `Error: ${error.message}`;
    }
}

async function loadUserNFTs() {
    if (!isInitialized || !userAddress) return;
    const grid = document.getElementById("myGrid");
    grid.innerHTML = "";
    try {
        const tokens = await contract.methods.tokensOfOwner(userAddress).call();
        for (const token of tokens) {
            const { tokenURI, price, availableSupply } = await contract.methods.nftInfo(token.tokenId).call();
            const listings = await contract.methods.getListings(token.tokenId).call();
            const metadata = await fetchMetadata(tokenURI, token.tokenId);
            const li = createNFTElement({ ...token, tokenURI, price, availableSupply }, metadata, "mynfts", listings);
            grid.appendChild(li);
        }
        if (grid.children.length === 0) {
            grid.innerHTML = "<li>You don't own any NFTs.</li>";
        }
    } catch (error) {
        console.error("Failed to load user NFTs:", error);
        document.getElementById("my-error").style.display = "block";
        document.getElementById("my-error").textContent = `Error: ${error.message}`;
    }
}

async function loadUserListings() {
    if (!isInitialized) return;
    const grid = document.getElementById("listingsGrid");
    grid.innerHTML = "";
    try {
        const nfts = await contract.methods.getShopNFTs().call();
        for (const nft of nfts) {
            const listings = await contract.methods.getListings(nft.tokenId).call();
            const filteredListings = listings.filter(listing => listing.seller !== contractAddress);
            if (filteredListings.length === 0) continue;
            const metadata = await fetchMetadata(nft.tokenURI, nft.tokenId);
            for (const listing of filteredListings) {
                const li = createNFTElement({ ...nft, amount: listing.amount, price: listing.price }, metadata, "listings", listing.seller);
                grid.appendChild(li);
            }
        }
        if (grid.children.length === 0) {
            grid.innerHTML = "<li>No user listings available.</li>";
        }
    } catch (error) {
        console.error("Failed to load user listings:", error);
        document.getElementById("listings-error").style.display = "block";
        document.getElementById("listings-error").textContent = `Error: ${error.message}`;
    }
}

async function fetchMetadata(tokenURI, tokenId) {
    if (metadataCache.has(tokenURI)) return metadataCache.get(tokenURI);
    try {
        const response = await fetch(tokenURI, { mode: "cors" });
        const data = await response.json();
        const metadata = {
            name: data.name || `NFT #${tokenId}`,
            image: data.image || DEFAULT_IMAGE,
            description: data.description || "No description available"
        };
        metadataCache.set(tokenURI, metadata);
        return metadata;
    } catch (error) {
        console.error(`Failed to fetch metadata for token ${tokenId}:`, error);
        const fallback = { name: `NFT #${tokenId}`, image: DEFAULT_IMAGE, description: "Metadata unavailable" };
        metadataCache.set(tokenURI, fallback);
        return fallback;
    }
}

function createNFTElement(nft, metadata, tab, listingSeller = null) {
    const li = document.createElement("li");
    li.className = "nft-post";
    const priceInMatic = web3.utils.fromWei(nft.price, "ether");
    const isListed = tab === "mynfts" && nft.listings && nft.listings.some(l => l.seller.toLowerCase() === userAddress?.toLowerCase());
    
    li.innerHTML = `
        <div class="nft-post-left">
            <span class="serial-number">${nft.tokenId}</span>
            <img class="nft-avatar" src="${metadata.image}" alt="${metadata.name}">
            <div class="nft-content">
                <div class="nft-title">${metadata.name}</div>
                <div class="nft-description">${metadata.description}</div>
            </div>
        </div>
        <div class="nft-actions">
            <div class="price-tab">
                <span class="material-icons">currency_exchange</span>
                ${priceInMatic} MATIC
            </div>
            ${tab === "shop" ? `
                <button class="buy-btn" ${nft.availableSupply === "0" ? "disabled" : ""} onclick="buyNFT(${nft.tokenId}, ${nft.price})">
                    <span class="material-icons">shopping_cart</span>Buy
                </button>
            ` : tab === "mynfts" ? `
                ${isListed ? `
                    <span class="nft-status-label nft-status-listed">Listed</span>
                    <button class="delist-btn" onclick="delistNFT(${nft.tokenId})">
                        <span class="material-icons">cancel</span>Delist
                    </button>
                ` : `
                    <span class="nft-status-label nft-status-notlisted">Not Listed</span>
                    <button class="sell-btn" onclick="openSellModal(${nft.tokenId}, ${nft.amount})">
                        <span class="material-icons">sell</span>Sell
                    </button>
                `}
            ` : `
                <button class="buy-btn" onclick="buyNFT(${nft.tokenId}, ${nft.price}, '${listingSeller}')">
                    <span class="material-icons">shopping_cart</span>Buy
                </button>
            `}
            ${nft.availableSupply === "0" && tab !== "mynfts" ? `
                <span class="sold-out"><span class="material-icons">block</span>Sold Out</span>
            ` : ""}
        </div>
    `;
    return li;
}

async function buyNFT(tokenId, price, seller = null) {
    if (!userAddress) {
        updateStatus("warn", "Please connect your wallet first");
        return;
    }
    updateStatus("info", "Initiating purchase...");
    try {
        const gasEstimate = await contract.methods.buyNFT(tokenId, 1).estimateGas({
            from: userAddress,
            value: price
        });
        const tx = await contract.methods.buyNFT(tokenId, 1).send({
            from: userAddress,
            value: price,
            gas: Math.ceil(gasEstimate * 1.2)
        });
        updateStatus("success", `NFT #${tokenId} purchased successfully! Tx: ${tx.transactionHash}`);
        await showTab(currentTab);
    } catch (error) {
        console.error("Buy NFT failed:", error);
        updateStatus("error", `Failed to buy NFT: ${error.message}`);
    }
}

function openSellModal(tokenId, maxAmount) {
    document.getElementById("sellTokenId").textContent = tokenId;
    document.getElementById("sellMaxAmount").textContent = maxAmount;
    document.getElementById("sellAmountInput").value = "";
    document.getElementById("sellPriceInput").value = "";
    document.getElementById("sellModalError").style.display = "none";
    document.getElementById("sellModal").style.display = "flex";
    document.body.classList.add("modal-open");
    document.getElementById("sellAmountInput").focus();
}

function closeSellModal() {
    document.getElementById("sellModal").style.display = "none";
    document.body.classList.remove("modal-open");
}

async function confirmSellNFT() {
    const tokenId = parseInt(document.getElementById("sellTokenId").textContent);
    const amount = parseInt(document.getElementById("sellAmountInput").value);
    const price = web3.utils.toWei(document.getElementById("sellPriceInput").value, "ether");
    const maxAmount = parseInt(document.getElementById("sellMaxAmount").textContent);

    if (!amount || amount <= 0 || amount > maxAmount) {
        document.getElementById("sellModalError").style.display = "block";
        document.getElementById("sellModalError").textContent = "Invalid amount";
        return;
    }
    if (!price || price <= 0) {
        document.getElementById("sellModalError").style.display = "block";
        document.getElementById("sellModalError").textContent = "Invalid price";
        return;
    }

    updateStatus("info", "Listing NFT for sale...");
    try {
        const gasEstimate = await contract.methods.sellNFT(tokenId, amount, price).estimateGas({ from: userAddress });
        const tx = await contract.methods.sellNFT(tokenId, amount, price).send({
            from: userAddress,
            gas: Math.ceil(gasEstimate * 1.2)
        });
        updateStatus("success", `NFT #${tokenId} listed successfully! Tx: ${tx.transactionHash}`);
        closeSellModal();
        await showTab("mynfts");
    } catch (error) {
        console.error("Sell NFT failed:", error);
        updateStatus("error", `Failed to list NFT: ${error.message}`);
    }
}

async function delistNFT(tokenId) {
    if (!userAddress) {
        updateStatus("warn", "Please connect your wallet first");
        return;
    }
    updateStatus("info", "Canceling listing...");
    try {
        const gasEstimate = await contract.methods.cancelListing(tokenId).estimateGas({ from: userAddress });
        const tx = await contract.methods.cancelListing(tokenId).send({
            from: userAddress,
            gas: Math.ceil(gasEstimate * 1.2)
        });
        updateStatus("success", `Listing for NFT #${tokenId} canceled! Tx: ${tx.transactionHash}`);
        await showTab("mynfts");
    } catch (error) {
        console.error("Delist NFT failed:", error);
        updateStatus("error", `Failed to cancel listing: ${error.message}`);
    }
}

function updateStatus(type, message) {
    const statusBar = document.getElementById("statusBar");
    const statusIcon = document.getElementById("statusBarIcon");
    statusBar.className = `status-bar status-${type}`;
    statusIcon.textContent = {
        info: "info",
        success: "check_circle",
        error: "error",
        warn: "warning"
    }[type];
    document.querySelector(".status-bar-text").textContent = `Status: ${message}`;
}
  
  </script>
</body>
</html>
