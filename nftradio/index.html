<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Global Radio Swipe (Random + Favorites)</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<link rel="icon" href="https://raw.githubusercontent.com/nftfan/MENU/refs/heads/main/play/Copy%20of%20Copy%20of%20Copy%20of%20Untitled%20Design.png" type="image/png">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f12;
  --accent:#19d77f;
  --warn:#ffca2c;
  --danger:#ff5468;
  --panel:rgba(0,0,0,0.55);
  --text:#ffffff;
  --text-dim:#b7bcc3;
  --radius:16px;
  --shadow:0 8px 32px -6px rgba(0,0,0,.55);
  --gradient:linear-gradient(145deg,#101318,#101d1f 40%,#091513 85%);
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html,body {
  margin:0; padding:0;
  font-family:'Roboto',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
  background:#000; color:var(--text);
  height:100%; overscroll-behavior-y:contain;
}
::-webkit-scrollbar{width:0;height:0;}
.app-shell {
  position:fixed; inset:0;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
  scroll-snap-stop:always;
  background:#000;
}
.slide {
  position:relative;
  width:100%; height:100vh;
  scroll-snap-align:start;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:70px 20px 110px;
  gap:34px;
  background:var(--gradient);
  background-size:250% 250%;
  animation:bgMove 18s linear infinite;
  isolation:isolate;
  touch-action:manipulation;
}
@keyframes bgMove {
  0% { background-position:0% 50%; }
  50% { background-position:100% 50%; }
  100% { background-position:0% 50%; }
}
.slide.active {}
.station-art {
  width:220px; height:220px;
  border-radius:28px;
  background:linear-gradient(145deg,#1d232a,#101417);
  box-shadow:0 12px 38px -10px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,0.06);
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
  position:relative;
}
.station-art img {
  width:100%; height:100%; object-fit:cover;
  display:block;
  filter:contrast(1.07) saturate(1.05);
}
.station-art .placeholder {
  font-size:70px; opacity:.22; color:#fff;
}
.wave-canvas {
  position:absolute;
  inset:auto 0 0 0;
  height:70px;
  mix-blend-mode:screen;
  opacity:.35;
  pointer-events:none;
}
.meta {
  text-align:center;
  max-width:90vw;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.station-name {
  font-size:clamp(20px,6.8vw,36px);
  font-weight:600;
  letter-spacing:.4px;
  line-height:1.1;
  text-shadow:0 4px 22px rgba(0,0,0,.55);
  display:flex;
  align-items:center;
  gap:.4em;
  justify-content:center;
  flex-wrap:wrap;
}
.badge-line {
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
}
.badge {
  font-size:11px;
  letter-spacing:.4px;
  text-transform:uppercase;
  font-weight:500;
  padding:6px 12px 7px;
  border-radius:999px;
  background:rgba(255,255,255,0.14);
  backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,0.1);
  color:var(--text-dim);
}
.badge.codec { color:#b0ffdc; }
.badge.br { color:#ffdca8; }
.badge.country { color:#c9ceff; }
.controls-cluster {
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  justify-content:center;
}
.ctrl-btn {
  width:66px; height:66px;
  border-radius:22px;
  background:rgba(255,255,255,0.12);
  display:flex; align-items:center; justify-content:center;
  font-size:30px;
  color:#fff;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter:blur(10px);
  box-shadow:var(--shadow);
  transition:background .28s, transform .3s;
  position:relative;
}
.ctrl-btn.small { width:56px; height:56px; font-size:24px; }
.ctrl-btn:active { transform:scale(.9); }
.ctrl-btn:hover { background:rgba(255,255,255,0.22); }
.ctrl-btn.favorited {
  color:#ffd54d;
  background:rgba(255,213,77,0.18);
  border-color:rgba(255,213,77,0.5);
}
.ctrl-btn.mode-active {
  background:rgba(25,215,127,0.2);
  color:#19d77f;
  border-color:rgba(25,215,127,0.5);
}

.top-bar {
  position:fixed;
  top:0; left:0; right:0;
  height:64px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 14px;
  z-index:30;
  background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0));
  transition:opacity .35s;
  pointer-events:none;
}
.top-bar .brand {
  display:flex; align-items:center; gap:12px;
  font-weight:600; font-size:18px; pointer-events:auto;
}
.top-bar .brand img { width:40px; height:40px; border-radius:14px; }
.top-bar .actions { display:flex; align-items:center; gap:10px; pointer-events:auto; }

.floating-mode-label {
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%, -50%);
  padding:8px 16px;
  font-size:11px;
  font-weight:600;
  text-transform:uppercase;
  letter-spacing:.5px;
  background:rgba(0,0,0,0.55);
  border:1px solid rgba(255,255,255,0.15);
  color:#fff;
  border-radius:999px;
  backdrop-filter:blur(10px);
  opacity:0;
  pointer-events:none;
  transition:opacity .4s, transform .4s;
}

.slide.show-mode-label .floating-mode-label {
  opacity:1;
  transform:translate(-50%, -50%) scale(1.05);
}

.loading {
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  font-size:12px;
  letter-spacing:.2em;
  background:rgba(0,0,0,0.6);
  padding:10px 18px;
  border-radius:999px;
  display:none;
  align-items:center; gap:10px;
  backdrop-filter:blur(10px);
}
.loading .spinner {
  width:18px;height:18px;
  border:3px solid rgba(255,255,255,0.25);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin .8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

.search-panel {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.82);
  backdrop-filter:blur(14px) brightness(.9);
  z-index:80;
  display:none;
  flex-direction:column;
  padding:82px 16px 22px;
}
.search-panel.active { display:flex; }
.search-panel input {
  width:100%;
  background:#14181b;
  border:1px solid #20272b;
  border-radius:16px;
  padding:16px 18px;
  font-size:16px;
  color:#fff;
  outline:none;
  font-family:inherit;
}
.search-results {
  margin-top:18px;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
  display:flex;
  flex-direction:column;
  gap:12px;
  max-height:calc(100vh - 190px);
}
.result-item {
  display:flex;
  align-items:center;
  gap:14px;
  background:#161d20;
  border:1px solid #20292d;
  padding:12px 14px;
  border-radius:16px;
  cursor:pointer;
  position:relative;
  transition:background .25s;
}
.result-item:hover { background:#1f272b; }
.result-item img {
  width:56px; height:56px;
  border-radius:14px;
  object-fit:cover;
  background:#0b0e10;
}
.result-meta {
  display:flex; flex-direction:column;
  flex:1; min-width:0;
}
.rm-name {
  font-size:14px; font-weight:500;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.rm-tags {
  font-size:10px; letter-spacing:.4px;
  opacity:.65;
  display:flex; flex-wrap:wrap; gap:6px;
  margin-top:4px;
}
.fav-flag {
  position:absolute;
  top:6px; right:8px;
  font-size:20px;
  color:#ffd54d;
  text-shadow:0 2px 6px rgba(0,0,0,.5);
}
.close-search {
  position:absolute;
  top:16px; right:16px;
  width:50px; height:50px;
  border-radius:16px;
  background:rgba(255,255,255,0.14);
  border:1px solid rgba(255,255,255,0.1);
  display:flex; align-items:center; justify-content:center;
  font-size:30px; cursor:pointer;
}
.close-search:active { transform:scale(.9); }
.safe-area { height:env(safe-area-inset-bottom); width:100%; }

.toast-container {
  position:fixed;
  left:50%; bottom:24px;
  transform:translateX(-50%);
  display:flex; flex-direction:column; gap:12px;
  z-index:120;
  pointer-events:none;
}
.toast {
  min-width:190px; max-width:80vw;
  background:rgba(0,0,0,0.72);
  backdrop-filter:blur(16px);
  border:1px solid rgba(255,255,255,0.16);
  padding:12px 16px;
  color:#fff;
  font-size:13px;
  letter-spacing:.35px;
  border-radius:16px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 10px 34px -10px rgba(0,0,0,.7);
  animation:toastIn .45s cubic-bezier(.4,.0,.2,1);
}
.toast.success { border-color:rgba(25,215,127,0.5); }
.toast.warn { border-color:rgba(255,213,77,0.5); }
.toast.error{ border-color:rgba(255,84,104,0.5); }
@keyframes toastIn {
  from { opacity:0; transform:translate(-50%,14px); }
  to { opacity:1; transform:translate(-50%,0); }
}

/* Auto-hide UI (top-bar & clusters) */
body.ui-hidden .top-bar,
body.ui-hidden .slide.active .meta,
body.ui-hidden .slide.active .controls-cluster { opacity:0; pointer-events:none; }
body.ui-hidden .slide.active .station-art::after { opacity:0; }
body:not(.ui-hidden) .top-bar,
body:not(.ui-hidden) .slide.active .meta,
body:not(.ui-hidden) .slide.active .controls-cluster { transition:opacity .4s; }

.first-interaction-overlay {
  position:fixed;
  inset:0;
  background:linear-gradient(160deg,#060708,#111b21);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:32px;
  z-index:200;
  text-align:center;
  padding:40px 24px;
}
.first-interaction-overlay.hidden { display:none; }
.first-interaction-overlay h1 { margin:0; font-size:clamp(28px,10vw,44px); letter-spacing:.5px; }
.first-interaction-overlay p { margin:0; font-size:15px; line-height:1.5; opacity:.75; }
.primary-cta {
  background:var(--accent);
  border:none;
  color:#041a11;
  font-weight:600;
  font-size:16px;
  letter-spacing:.5px;
  padding:16px 28px;
  border-radius:18px;
  cursor:pointer;
  display:flex; gap:10px; align-items:center;
  box-shadow:0 6px 28px -6px rgba(0,0,0,.7), 0 0 0 1px rgba(255,255,255,0.08);
  transition:transform .3s, box-shadow .3s;
}
.primary-cta:active { transform:translateY(2px); }
.primary-cta .material-icons { font-size:22px; }

@media (min-width:820px) {
  .app-shell { width:470px; margin:0 auto; border-left:1px solid #12191d; border-right:1px solid #12191d; }
  .toast { max-width:380px; }
}
</style>
</head>
<body>
<div class="top-bar">
  <div class="brand">
    <img src="https://raw.githubusercontent.com/nftfan/MENU/refs/heads/main/play/Copy%20of%20Copy%20of%20Copy%20of%20Untitled%20Design.png" alt="Logo"/>
    <span id="mode-label">Global Radio</span>
  </div>
  <div class="actions">
    <div class="ctrl-btn small" id="toggle-favorites-mode" title="Toggle Favorites Mode">
      <span class="material-icons" id="fav-mode-icon">favorite_border</span>
    </div>
    <div class="ctrl-btn small" id="open-search" title="Search">
      <span class="material-icons">search</span>
    </div>
    <div class="ctrl-btn small" id="reload-btn" title="Reload Sources">
      <span class="material-icons">refresh</span>
    </div>
  </div>
</div>

<div id="app" class="app-shell"></div>

<!-- Search Panel -->
<div class="search-panel" id="search-panel">
  <div class="close-search" id="close-search"><span class="material-icons">close</span></div>
  <input id="search-input" type="text" placeholder="Search stations: name, country, tag..." autocomplete="off">
  <div class="search-results" id="search-results"></div>
  <div class="safe-area"></div>
</div>

<!-- First Interaction Overlay (to enable autoplay) -->
<div class="first-interaction-overlay" id="first-overlay">
  <h1>Tap to Start Radio</h1>
  <p>Swipe up or down to explore random live radio stations from around the world. Add favorites and switch to a favorites-only mode anytime.</p>
  <button class="primary-cta" id="start-btn">
    <span class="material-icons">play_arrow</span>
    Start Listening
  </button>
</div>

<!-- Toast container -->
<div class="toast-container" id="toast-container"></div>

<!-- Template -->
<template id="slide-template">
  <div class="slide" data-index="">
    <div class="station-art">
      <div class="placeholder material-icons">radio</div>
      <canvas class="wave-canvas"></canvas>
    </div>
    <div class="meta">
      <div class="station-name"><span class="flag"></span><span class="name"></span></div>
      <div class="badge-line">
        <span class="badge country"></span>
        <span class="badge codec"></span>
        <span class="badge br"></span>
        <span class="badge tags"></span>
      </div>
    </div>
    <div class="controls-cluster">
      <div class="ctrl-btn playpause" title="Play/Pause"><span class="material-icons">pause</span></div>
      <div class="ctrl-btn mute" title="Mute / Unmute"><span class="material-icons">volume_off</span></div>
      <div class="ctrl-btn favorite" title="Add to Favorites"><span class="material-icons">star_border</span></div>
      <div class="ctrl-btn next" title="Next Station"><span class="material-icons">arrow_downward</span></div>
    </div>
    <div class="floating-mode-label" aria-hidden="true"></div>
    <div class="loading">
      <div class="spinner"></div>
      <span>CONNECTING</span>
    </div>
  </div>
</template>

<script>
/* ================================
   CONFIG & STATE
=================================== */
const FAVORITES_KEY = "globalRadioFavoritesV1";
const UI_HIDE_DELAY = 4000;
const INITIAL_SLIDES = 5;
const PRELOAD_AHEAD = 2;
const KEEP_BEFORE_AFTER = 5;
const MAX_DOM_SLIDES = 24;

// Radio Browser API (public) - optional dynamic list
const RADIO_BROWSER_ENDPOINT = "https://de1.api.radio-browser.info/json/stations/topvote/120";

// If API fails, fallback to this curated list (only openly accessible mp3/aac streams at time of writing)
const FALLBACK_STATIONS = [
  {
    name:"Candlelight (Instrumental)",
    country:"US",
    favicon:"https://cdn.webrad.io/images/logos/radio-candlelight.png",
    tags:"instrumental,relax",
    codec:"mp3",
    bitrate:128,
    url:"https://ais-sa2.cdnstream1.com/2444_128.mp3"
  },
  {
    name:"Smooth Jazz Florida",
    country:"US",
    favicon:"https://www.smoothjazzflorida.com/favicon.ico",
    tags:"jazz,smooth",
    codec:"mp3",
    bitrate:128,
    url:"https://us4.internet-radio.com/proxy/smoothjazzflorida?mp=/stream"
  },
  {
    name:"Nightride FM (Chill Synth)",
    country:"US",
    favicon:"https://nightride.fm/icons/icon-512x512.png",
    tags:"synthwave,chill",
    codec:"mp3",
    bitrate:192,
    url:"https://stream.nightride.fm/nightride.m4a"
  },
  {
    name:"Radio Swiss Jazz",
    country:"CH",
    favicon:"https://www.radioswissjazz.ch/favicon-196x196.png",
    tags:"jazz,swiss",
    codec:"mp3",
    bitrate:128,
    url:"https://stream.srg-ssr.ch/m/rsj/mp3_128"
  },
  {
    name:"Radio Paradise (Main)",
    country:"US",
    favicon:"https://radioparadise.com/favicon-196.png",
    tags:"eclectic,rock,indie",
    codec:"aac",
    bitrate:128,
    url:"https://stream.radioparadise.com/aac-128"
  },
  {
    name:"DeepHouseRadio",
    country:"NL",
    favicon:"https://www.deephouseradio.com/favicon.ico",
    tags:"deep house,electronic",
    codec:"mp3",
    bitrate:192,
    url:"https://stream.deephouseradio.com/320.mp3"
  },
  {
    name:"Dance Wave!",
    country:"BG",
    favicon:"https://dancewave.online/wp-content/uploads/2022/08/cropped-site-icon-192x192.png",
    tags:"dance,edm",
    codec:"mp3",
    bitrate:192,
    url:"https://securestreams2.autopo.st:1202/dance.mp3"
  },
  {
    name:"Kiss FM (Dance)",
    country:"RO",
    favicon:"https://www.kissfm.ro/apple-touch-icon.png",
    tags:"pop,dance",
    codec:"aac",
    bitrate:128,
    url:"https://live.kissfm.ro/kissfm.mp3"
  },
  {
    name:"80s 90s Hits",
    country:"DE",
    favicon:"https://i.imgur.com/1MZ8pZp.png",
    tags:"80s,90s,pop",
    codec:"mp3",
    bitrate:128,
    url:"https://stream.laut.fm/80s90s"
  },
  {
    name:"Classical KUSC",
    country:"US",
    favicon:"https://www.kusc.org/wp-content/uploads/2021/04/cropped-kusc-favicon-32x32.png",
    tags:"classical",
    codec:"mp3",
    bitrate:128,
    url:"https://kuscstream.audionow.com/playlist/kusc/kusc.stream/playlist.m3u8" // may be HLS
  },
  {
    name:"LOFI Girl",
    country:"FR",
    favicon:"https://lofigirl.com/wp-content/uploads/2022/07/cropped-logo192.png",
    tags:"lofi,chill,beats",
    codec:"mp3",
    bitrate:128,
    url:"https://play.streamafrica.net/lofiradio"
  },
  {
    name:"BBC Radio 1 Relax (Unofficial Mirror)",
    country:"UK",
    favicon:"https://www.bbc.co.uk/favicon.ico",
    tags:"chill,ambient",
    codec:"mp3",
    bitrate:128,
    url:"https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one" // might geo-restrict
  }
];

let masterStations = []; // combined list
let favorites = [];
let favoritesMode = false;
let lastStationKey = null;

let currentIndex = 0;
let slideCount = 0;
let slidesMap = new Map();
let observer = null;

let uiHideTimeout = null;
let firstInteractionDone = false;

/* ================================
   UTIL HELPERS
=================================== */
function flagEmoji(code){
  if(!code || code.length !==2) return "";
  return String.fromCodePoint(...[...code.toUpperCase()].map(c => 0x1F1E6 + (c.charCodeAt(0)-65)));
}
function uniqKey(st){
  return (st.stationuuid) ? st.stationuuid : (st.name + "::" + st.url);
}
function loadFavorites(){
  try {
    const raw = localStorage.getItem(FAVORITES_KEY);
    favorites = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(favorites)) favorites = [];
  } catch(e){ favorites = []; }
}
function saveFavorites(){
  try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favorites)); } catch(e){}
}
function isFavorite(st){
  return favorites.includes(uniqKey(st));
}
function toast(msg,type="info",icon="info"){
  const tc = document.getElementById('toast-container');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<span class="material-icons" style="font-size:18px;">${icon}</span><span>${msg}</span>`;
  tc.appendChild(el);
  setTimeout(()=>{
    el.style.transition='opacity .4s, transform .4s';
    el.style.opacity='0';
    el.style.transform='translate(-50%,12px)';
    setTimeout(()=>el.remove(),420);
  },2500);
}
function stationPool(){
  if(favoritesMode){
    const set = new Set(favorites);
    return masterStations.filter(s => set.has(uniqKey(s)));
  }
  return masterStations;
}
function randomStation(){
  const pool = stationPool();
  if(!pool.length) return null;
  let attempt=0, st;
  do {
    st = pool[Math.floor(Math.random()*pool.length)];
    attempt++;
  } while (attempt < 12 && pool.length>1 && uniqKey(st) === lastStationKey);
  lastStationKey = uniqKey(st);
  return st;
}

/* ================================
   FETCH STATIONS
=================================== */
async function loadStations(force=false){
  if(masterStations.length && !force) return;
  try {
    const resp = await fetch(RADIO_BROWSER_ENDPOINT, { cache:'no-store' });
    if(!resp.ok) throw new Error("API fail");
    const list = await resp.json();
    // Filter out those without working url or low reliability & unify shape
    const cleaned = list
      .filter(s=> s.url && !s.url.startsWith("https://discord.") )
      .map(s=> ({
        name:s.name,
        country:s.countrycode || s.country || "",
        favicon:s.favicon || s.image || "",
        tags:(s.tags||"").split(",").filter(Boolean).slice(0,4).join(","),
        codec:(s.codec||"").toLowerCase(),
        bitrate:s.bitrate || 0,
        url: s.url_resolved || s.url,
        stationuuid: s.stationuuid
      }));
    masterStations = [...cleaned, ...FALLBACK_STATIONS];
  } catch(e){
    console.warn("Using fallback only", e);
    masterStations = [...FALLBACK_STATIONS];
  }
}

/* ================================
   BUILD SLIDES
=================================== */
function resetFeed(){
  document.getElementById('app').innerHTML = "";
  slidesMap.clear();
  slideCount = 0;
  currentIndex = 0;
  lastStationKey = null;
}
function initFeed(){
  for(let i=0; i<INITIAL_SLIDES; i++){
    addSlide(slideCount++);
  }
  initObserver();
  setTimeout(()=>goTo(0,false),40);
}
function addSlide(index){
  const tpl = document.getElementById('slide-template');
  const node = tpl.content.firstElementChild.cloneNode(true);
  node.dataset.index = index;
  const st = randomStation();
  node._station = st;
  fillSlide(node, st);
  attachSlideEvents(node);
  slidesMap.set(index,node);
  document.getElementById('app').appendChild(node);
  if(observer) observer.observe(node);
  trimSlides();
  return node;
}
function fillSlide(slide, st){
  const nameEl = slide.querySelector('.name');
  const flagEl = slide.querySelector('.flag');
  const cBadge = slide.querySelector('.badge.country');
  const codecBadge = slide.querySelector('.badge.codec');
  const brBadge = slide.querySelector('.badge.br');
  const tagsBadge = slide.querySelector('.badge.tags');
  const artBox = slide.querySelector('.station-art');
  const placeholder = artBox.querySelector('.placeholder');

  // Clear old art
  const existingImg = artBox.querySelector('img');
  if(existingImg) existingImg.remove();

  if(!st){
    nameEl.textContent = "Unknown";
    flagEl.textContent = "";
    cBadge.textContent = "??";
    codecBadge.textContent = "--";
    brBadge.textContent = "--";
    tagsBadge.textContent = "no tags";
    placeholder.style.display='flex';
    return;
  }
  nameEl.textContent = st.name || "Unknown";
  flagEl.textContent = flagEmoji(st.country);
  cBadge.textContent = st.country || "??";
  codecBadge.textContent = (st.codec || "stream").toUpperCase();
  brBadge.textContent = st.bitrate ? (st.bitrate + " kbps") : "VBR";
  tagsBadge.textContent = st.tags ? st.tags : "misc";

  if(st.favicon){
    const img = document.createElement('img');
    img.src = st.favicon;
    img.alt = st.name;
    img.loading = "lazy";
    img.onerror = () => {
      img.remove();
      placeholder.style.display = 'flex';
    };
    placeholder.style.display='none';
    artBox.prepend(img);
  } else {
    placeholder.style.display='flex';
  }

  updateFavButton(slide);
}

function updateFavButton(slide){
  const favBtn = slide.querySelector('.ctrl-btn.favorite');
  const st = slide._station;
  if(!st){ favBtn.classList.remove('favorited'); favBtn.querySelector('.material-icons').textContent='star_border'; return; }
  if(isFavorite(st)){
    favBtn.classList.add('favorited');
    favBtn.querySelector('.material-icons').textContent='star';
    favBtn.title = "Remove Favorite";
  } else {
    favBtn.classList.remove('favorited');
    favBtn.querySelector('.material-icons').textContent='star_border';
    favBtn.title = "Add Favorite";
  }
}

function attachSlideEvents(slide){
  const playBtn = slide.querySelector('.ctrl-btn.playpause');
  const muteBtn = slide.querySelector('.ctrl-btn.mute');
  const favBtn  = slide.querySelector('.ctrl-btn.favorite');
  const nextBtn = slide.querySelector('.ctrl-btn.next');

  playBtn.addEventListener('click', e=>{
    e.stopPropagation();
    const audio = ensureAudio(slide);
    if(audio.paused){
      safePlay(audio);
      playBtn.querySelector('.material-icons').textContent='pause';
      scheduleUIHide();
    } else {
      audio.pause();
      playBtn.querySelector('.material-icons').textContent='play_arrow';
      showUI(true);
    }
  });

  muteBtn.addEventListener('click', e=>{
    e.stopPropagation();
    const audio = ensureAudio(slide);
    audio.muted = !audio.muted;
    muteBtn.querySelector('.material-icons').textContent = audio.muted ? 'volume_off' : 'volume_up';
    showUI(); scheduleUIHide();
  });

  favBtn.addEventListener('click', e=>{
    e.stopPropagation();
    toggleFavorite(slide._station);
    updateFavButton(slide);
  });

  nextBtn.addEventListener('click', e=>{
    e.stopPropagation();
    goTo(parseInt(slide.dataset.index,10)+1);
  });

  // Tap anywhere toggles UI
  slide.addEventListener('click', e=>{
    if(e.target.closest('.ctrl-btn')) return;
    const audio = ensureAudio(slide);
    const hidden = document.body.classList.contains('ui-hidden');
    if(audio.paused){ showUI(true); }
    else {
      if(hidden) { showUI(); scheduleUIHide(); }
      else hideUI();
    }
  });

  // Double tap to toggle mute
  slide.addEventListener('dblclick', ()=>{
    const audio = ensureAudio(slide);
    audio.muted = !audio.muted;
    muteBtn.querySelector('.material-icons').textContent = audio.muted ? 'volume_off':'volume_up';
    showUI(); scheduleUIHide();
  });
}

function ensureSlide(index){
  if(slidesMap.has(index)) return slidesMap.get(index);
  return addSlide(index);
}

function trimSlides(){
  const indices = [...slidesMap.keys()].sort((a,b)=>a-b);
  if(indices.length <= MAX_DOM_SLIDES) return;
  indices.forEach(i=>{
    if(Math.abs(i - currentIndex) > KEEP_BEFORE_AFTER && indices.length > MAX_DOM_SLIDES){
      const slide = slidesMap.get(i);
      if(slide && slide.parentNode){
        const audio = slide.querySelector('audio');
        if(audio){
          audio.pause();
          audio.src="";
        }
        slide.parentNode.removeChild(slide);
      }
      slidesMap.delete(i);
    }
  });
}

/* ================================
   AUDIO HANDLING
=================================== */
function ensureAudio(slide){
  let audio = slide.querySelector('audio');
  if(!audio){
    audio = document.createElement('audio');
    audio.setAttribute('preload','none');
    audio.crossOrigin = "anonymous";
    slide.appendChild(audio);
    setupAudio(slide, audio);
  }
  return audio;
}

function setupAudio(slide, audio){
  const st = slide._station;
  const loading = slide.querySelector('.loading');
  const playBtn = slide.querySelector('.ctrl-btn.playpause');
  const waveCanvas = slide.querySelector('.wave-canvas');

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 256;
  const source = ctx.createMediaElementSource(audio);
  source.connect(analyser);
  analyser.connect(ctx.destination);
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  const canvasCtx = waveCanvas.getContext('2d');
  function drawWave(){
    requestAnimationFrame(drawWave);
    if(canvasCtx.canvas.width !== waveCanvas.clientWidth){
      canvasCtx.canvas.width = waveCanvas.clientWidth;
      canvasCtx.canvas.height = waveCanvas.clientHeight;
    }
    analyser.getByteFrequencyData(dataArray);
    canvasCtx.clearRect(0,0,canvasCtx.canvas.width,canvasCtx.canvas.height);
    const barW = (canvasCtx.canvas.width / bufferLength)*1.9;
    for(let i=0;i<bufferLength;i++){
      const v = dataArray[i]/255;
      const h = v * canvasCtx.canvas.height;
      const x = i * barW;
      const grd = canvasCtx.createLinearGradient(x, canvasCtx.canvas.height-h, x, canvasCtx.canvas.height);
      grd.addColorStop(0,'#19d77f');
      grd.addColorStop(1,'rgba(25,215,127,0)');
      canvasCtx.fillStyle = grd;
      canvasCtx.fillRect(x, canvasCtx.canvas.height-h, barW*0.7, h);
    }
  }
  drawWave();

  audio.addEventListener('playing', ()=>{
    hideLoader(loading);
    playBtn.querySelector('.material-icons').textContent='pause';
    scheduleUIHide();
  });
  audio.addEventListener('pause', ()=>{
    showUI(true);
    playBtn.querySelector('.material-icons').textContent='play_arrow';
  });
  audio.addEventListener('waiting', ()=> showLoader(loading));
  audio.addEventListener('error', ()=>{
    loading.querySelector('span').textContent='ERROR';
    setTimeout(()=>hideLoader(loading), 3000);
    toast('Stream error','error','error');
  });

  // Set src
  audio.src = st ? st.url : "";
  audio.load();
  if(firstInteractionDone){
    safePlay(audio);
  }
}

function showLoader(el){ if(el) el.style.display='flex'; }
function hideLoader(el){ if(el) el.style.display='none'; }

function safePlay(audio){
  const p = audio.play();
  if(p && p.catch){
    p.catch(()=> {
      // likely autoplay blocked
      showUI(true);
    });
  }
}

/* ================================
   INTERSECTION / AUTO FLOW
=================================== */
function initObserver(){
  observer = new IntersectionObserver(onIntersect,{
    root:document.getElementById('app'),
    threshold:0.63
  });
  slidesMap.forEach(slide=>observer.observe(slide));
  document.getElementById('app').addEventListener('scroll', throttle(onScroll,120), { passive:true });
}

function onScroll(){
  const app = document.getElementById('app');
  const nearBottom = app.scrollTop + app.clientHeight * 1.15 > app.scrollHeight;
  if(nearBottom){
    for(let i=0;i<3;i++){
      addSlide(slideCount++);
    }
  }
}

function onIntersect(entries){
  entries.forEach(entry=>{
    const slide = entry.target;
    const idx = parseInt(slide.dataset.index,10);
    if(entry.isIntersecting){
      currentIndex = idx;
      slide.classList.add('active');
      prepareSlideAudio(idx);
      pauseOthers(idx);
      for(let i=1;i<=PRELOAD_AHEAD;i++) ensureSlide(idx+i);
      cleanupAudio(idx);
      showUI();
      scheduleUIHide();
    } else {
      slide.classList.remove('active');
      const audio = slide.querySelector('audio');
      if(audio) audio.pause();
    }
  });
}

function prepareSlideAudio(index){
  const slide = slidesMap.get(index);
  if(!slide) return;
  let audio = slide.querySelector('audio');
  if(!audio){
    ensureAudio(slide);
  } else if(audio.src === "" && slide._station){
    audio.src = slide._station.url;
    audio.load();
    if(firstInteractionDone) safePlay(audio);
  } else {
    if(firstInteractionDone && audio.paused) safePlay(audio);
  }
}

function pauseOthers(activeIdx){
  slidesMap.forEach((slide, idx)=>{
    if(idx !== activeIdx){
      const a = slide.querySelector('audio');
      if(a && !a.paused) a.pause();
    }
  });
}

function cleanupAudio(centerIdx){
  slidesMap.forEach((slide, idx)=>{
    if(Math.abs(idx-centerIdx) > KEEP_BEFORE_AFTER){
      const a = slide.querySelector('audio');
      if(a){
        a.pause();
        a.src = "";
        a.load();
      }
    }
  });
}

function goTo(index, smooth=true){
  if(index<0) return;
  ensureSlide(index);
  const slide = slidesMap.get(index);
  if(slide){
    slide.scrollIntoView({behavior: smooth?'smooth':'auto'});
  }
  showUI(); scheduleUIHide();
}

/* ================================
   FAVORITES / MODES
=================================== */
function toggleFavorite(st){
  if(!st) return;
  const key = uniqKey(st);
  const i = favorites.indexOf(key);
  if(i===-1){
    favorites.push(key);
    toast("Added to favorites","success","star");
  } else {
    favorites.splice(i,1);
    toast("Removed from favorites","warn","star_border");
    if(favoritesMode && !favorites.length){
      setFavoritesMode(false,true);
      toast("Favorites empty - returning to all","info","info");
    }
  }
  saveFavorites();
  // Update current slide icon
  const slide = slidesMap.get(currentIndex);
  if(slide) updateFavButton(slide);
}

function setFavoritesMode(on, silent=false){
  if(on && !favorites.length){
    toast("No favorites yet","warn","star_border");
    return;
  }
  favoritesMode = on;
  const modeBtn = document.getElementById('toggle-favorites-mode');
  const icon = document.getElementById('fav-mode-icon');
  const label = document.getElementById('mode-label');
  modeBtn.classList.toggle('mode-active', favoritesMode);
  icon.textContent = favoritesMode ? "favorite" : "favorite_border";
  label.textContent = favoritesMode ? "Favorites" : "Global Radio";
  if(!silent){
    toast(favoritesMode ? "Favorites mode" : "All stations mode","info",favoritesMode?"favorite":"shuffle");
  }
  rebuildFeed();
}
function rebuildFeed(){
  resetFeed();
  initFeed();
}

/* ================================
   SEARCH
=================================== */
const searchPanel = document.getElementById('search-panel');
const searchInput = document.getElementById('search-input');
const searchResults = document.getElementById('search-results');

document.getElementById('open-search').addEventListener('click', ()=>{
  showUI(true);
  searchPanel.classList.add('active');
  setTimeout(()=>searchInput.focus(),50);
  renderSearchResults();
});
document.getElementById('close-search').addEventListener('click', ()=>{
  searchPanel.classList.remove('active');
  searchInput.value="";
  searchResults.innerHTML="";
  showUI(); scheduleUIHide();
});

searchInput.addEventListener('input', renderSearchResults);

function renderSearchResults(){
  const q = searchInput.value.trim().toLowerCase();
  searchResults.innerHTML="";
  const list = masterStations.filter(st=>{
    if(!q) return true;
    return (st.name && st.name.toLowerCase().includes(q))
       || (st.country && st.country.toLowerCase().includes(q))
       || (st.tags && st.tags.toLowerCase().includes(q));
  }).slice(0,150);

  if(!list.length){
    searchResults.innerHTML='<div style="opacity:.6;font-size:13px;padding:8px 4px;">No results.</div>';
    return;
  }

  list.forEach(st=>{
    const div = document.createElement('div');
    const key = uniqKey(st);
    const fav = favorites.includes(key);
    div.className='result-item';
    div.innerHTML=`
      <img src="${st.favicon || ''}" alt="" onerror="this.style.display='none';">
      <div class="result-meta">
        <div class="rm-name">${st.name}</div>
        <div class="rm-tags">${[st.country||"??", st.codec?st.codec.toUpperCase():"", st.bitrate?st.bitrate+"kbps":"VBR", st.tags||"misc"].filter(Boolean).join(" Â· ")}</div>
      </div>
      <span class="material-icons" style="font-size:26px;color:#888;">play_arrow</span>
      ${fav?'<span class="material-icons fav-flag" title="Favorite">star</span>':''}
    `;
    div.addEventListener('click', ()=>{
      searchPanel.classList.remove('active');
      replaceCurrentSlide(st);
      showUI(); scheduleUIHide();
    });

    // Long press to toggle favorite
    let timer;
    div.addEventListener('touchstart', ()=>{
      timer = setTimeout(()=>{
        toggleFavorite(st);
        renderSearchResults();
      },600);
    }, {passive:true});
    ['touchend','touchmove','touchcancel'].forEach(evt=>{
      div.addEventListener(evt, ()=>clearTimeout(timer), {passive:true});
    });
    // Right click
    div.addEventListener('contextmenu', e=>{
      e.preventDefault();
      toggleFavorite(st);
      renderSearchResults();
    });

    searchResults.appendChild(div);
  });
}

function replaceCurrentSlide(st){
  const slide = slidesMap.get(currentIndex);
  if(!slide) return;
  lastStationKey = uniqKey(st); // avoid immediate repeat on next
  slide._station = st;
  fillSlide(slide, st);
  const audio = slide.querySelector('audio');
  const loading = slide.querySelector('.loading');
  showLoader(loading);
  if(audio){
    audio.pause();
    audio.src="";
    audio.load();
    audio.src = st.url;
    audio.load();
    if(firstInteractionDone) safePlay(audio);
  }
}

/* ================================
   UI AUTO HIDE
=================================== */
function showUI(forcePaused=false){
  document.body.classList.remove('ui-hidden');
  if(uiHideTimeout) clearTimeout(uiHideTimeout);
  if(forcePaused) return;
}
function hideUI(){
  const slide = slidesMap.get(currentIndex);
  if(!slide) return;
  const audio = slide.querySelector('audio');
  if(!audio || audio.paused) return;
  if(searchPanel.classList.contains('active')) return;
  document.body.classList.add('ui-hidden');
}
function scheduleUIHide(){
  if(uiHideTimeout) clearTimeout(uiHideTimeout);
  uiHideTimeout = setTimeout(hideUI, UI_HIDE_DELAY);
}
['mousemove','mousedown','touchstart','touchmove','keydown','wheel'].forEach(evt=>{
  window.addEventListener(evt, ()=>{
    if(document.body.classList.contains('ui-hidden')) showUI();
    scheduleUIHide();
  }, { passive:true });
});

/* ================================
   FAVORITES MODE TOGGLE
=================================== */
document.getElementById('toggle-favorites-mode').addEventListener('click', ()=>{
  setFavoritesMode(!favoritesMode);
});

/* ================================
   RELOAD
=================================== */
document.getElementById('reload-btn').addEventListener('click', async ()=>{
  toast("Reloading sources","info","refresh");
  await loadStations(true);
  rebuildFeed();
});

/* ================================
   KEYBOARD NAV
=================================== */
document.addEventListener('keydown', e=>{
  if(searchPanel.classList.contains('active')){
    if(e.key === 'Escape'){
      searchPanel.classList.remove('active');
      showUI(); scheduleUIHide();
    }
    return;
  }
  if(e.key === 'ArrowDown' || e.key === 'PageDown'){
    e.preventDefault();
    goTo(currentIndex+1);
  } else if(e.key === 'ArrowUp' || e.key === 'PageUp'){
    e.preventDefault();
    goTo(currentIndex-1);
  } else if(e.key === ' ') {
    const slide = slidesMap.get(currentIndex);
    if(slide){
      const audio = ensureAudio(slide);
      if(audio.paused){
        safePlay(audio); scheduleUIHide();
      } else {
        audio.pause(); showUI(true);
      }
    }
  }
});

/* ================================
   FIRST INTERACTION
=================================== */
document.getElementById('start-btn').addEventListener('click', ()=>{
  firstInteractionDone = true;
  document.getElementById('first-overlay').classList.add('hidden');
  // start current slide audio
  const slide = slidesMap.get(currentIndex);
  if(slide){
    const audio = ensureAudio(slide);
    safePlay(audio);
  }
  scheduleUIHide();
});

/* ================================
   FAVORITE BUTTON REFRESH
=================================== */
function refreshAllFavButtons(){
  slidesMap.forEach(slide => updateFavButton(slide));
}

/* ================================
   FAVORITES MODE LOGIC
=================================== */
function rebuildFeed(){
  resetFeed();
  initFeed();
}

/* ================================
   TOGGLE FAVORITE
=================================== */
function toggleFavorite(st){
  if(!st) return;
  const key = uniqKey(st);
  const idx = favorites.indexOf(key);
  if(idx === -1){
    favorites.push(key);
    toast("Added to favorites","success","star");
  } else {
    favorites.splice(idx,1);
    toast("Removed from favorites","warn","star_border");
    if(favoritesMode && favorites.length === 0){
      setFavoritesMode(false,true);
      toast("Favorites empty","info","info");
    }
  }
  saveFavorites();
  refreshAllFavButtons();
}

/* ================================
   SCROLL / THROTTLE
=================================== */
function throttle(fn, wait){
  let last=0, t;
  return (...args)=>{
    const now = Date.now();
    const remain = wait - (now - last);
    if(remain <= 0){
      clearTimeout(t);
      last = now;
      fn(...args);
    } else if(!t){
      t = setTimeout(()=>{
        last = Date.now();
        t = null;
        fn(...args);
      }, remain);
    }
  };
}

/* ================================
   INITIALIZE
=================================== */
(async function init(){
  loadFavorites();
  await loadStations();
  initFeed();
  showUI();
})();
</script>
</body>
</html>
