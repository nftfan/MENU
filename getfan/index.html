<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>$NFTFAN Free Airdrop Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" href="https://i.imgur.com/ODP45iQ.png" type="image/png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #fcfcfe;
  --primary: #00bfae;
  --secondary: #a259e6;
  --accent: #ffd900;
  --success: #27ae60;
  --text: #23243b;
  --text-light: #7e819c;
  --bubble-bot: #f3f7fa;
  --bubble-user: #e0f7fa;
  --bubble-success: #e8faf1;
  --bubble-warning: #fffbe9;
  --radius: 17px;
  --radius-m: 13px;
  --font-title: 'Orbitron', monospace;
  --font-main: 'Inter', sans-serif;
}
html, body {
  background: var(--bg);
  min-height: 100vh;
  font-family: var(--font-main);
  color: var(--text);
  font-size: 16px;
}
#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  background: var(--bg);
  padding: 0;
}
.banner-img {
  width: 100vw;
  max-width: 100%;
  display: block;
  object-fit: cover;
  object-position: center;
  height: 120px;
  border-radius: 0 0 20px 20px;
  margin-bottom: 0px;
  box-shadow: 0 6px 30px 0 rgba(36,36,62,.10);
}
@media (max-width:520px) {
  .banner-img { height: 70px; border-radius: 0 0 13px 13px;}
}
.chat-card {
  width: 100%;
  max-width: 420px;
  margin: 0 auto;
  background: #fff;
  border-radius: var(--radius);
  box-shadow: 0 4px 36px 0 rgba(36,36,62,.09);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 88vh;
  margin-top: 20px;
  margin-bottom: 20px;
  border: 1.5px solid #f0f0f7;
  position: relative;
}
.header {
  display: flex;
  align-items: center;
  gap: 11px;
  background: linear-gradient(90deg, #f3f7fa 60%, #eae6fb 100%);
  padding: 19px 19px 13px 19px;
  border-bottom: 1.5px solid #f0f0f7;
  position: relative;
}
.logo {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: linear-gradient(135deg,#00bfae,#a259e6);
  box-shadow: 0 3px 11px #a259e633;
  display: flex; align-items: center; justify-content: center;
  animation: popLogo 1.2s cubic-bezier(.36,1.54,.31,.9);
}
@keyframes popLogo {
  0% { transform: scale(0);}
  70% { transform: scale(1.15);}
  100% { transform: scale(1);}
}
.logo img { width: 26px; height: 26px; border-radius: 50%; }
.header-text { display: flex; flex-direction: column; gap: 2px; }
.header-title {
  font-family: var(--font-title);
  font-size: 17px;
  color: var(--primary);
  font-weight: 700;
  letter-spacing: 1.1px;
}
.header-desc {
  color: var(--text-light);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .3px;
}
.live-indicator {
  display: inline-flex;
  align-items: center;
  font-size: 13px;
  font-weight: 700;
  color: var(--success);
  background: #e8faf1;
  border-radius: 99px;
  padding: 3px 14px 3px 9px;
  position: absolute;
  right: 19px;
  top: 19px;
  box-shadow: 0 1px 5px #00bfae14;
  animation: pulseLive 1.3s infinite;
  z-index: 2;
}
.live-dot {
  width: 11px;
  height: 11px;
  background: var(--success);
  border-radius: 50%;
  margin-right: 7px;
  box-shadow: 0 0 0 0 #27ae6066;
  animation: liveDotPulse 1.3s infinite;
}
@keyframes liveDotPulse {
  0% { box-shadow: 0 0 0 0 #27ae6066;}
  60% { box-shadow: 0 0 0 7px #27ae6000;}
  100% { box-shadow: 0 0 0 0 #27ae6066;}
}
@keyframes pulseLive {
  0% { background: #e8faf1; }
  60% { background: #d7f5e7;}
  100% { background: #e8faf1;}
}

.chat-window {
  flex: 1;
  background: #fcfcfe;
  padding: 22px 7px 12px 7px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  scroll-behavior: smooth;
}
::-webkit-scrollbar {width:7px;}
::-webkit-scrollbar-thumb{background:#ececf4;border-radius:8px;}
::-webkit-scrollbar-track{background:transparent;}

.bubble-row {
  display: flex;
  align-items: flex-end;
  margin-bottom: 2px;
}
.bubble-row.bot {justify-content: flex-start;}
.bubble-row.user {justify-content: flex-end;}
.bubble {
  max-width: 88vw;
  max-width: 87%;
  padding: 14px 15px;
  border-radius: var(--radius-m);
  font-size: 15px;
  box-shadow: 0 4px 18px 0 rgba(0,205,180,.08);
  margin-bottom: 2px;
  word-break: break-word;
  line-height: 1.4;
  position: relative;
  animation: fadeInUp 0.5s;
}
.bubble.bot {
  background: var(--bubble-bot);
  color: var(--text);
  border-bottom-left-radius: 3px;
}
.bubble.user {
  background: var(--bubble-user);
  color: var(--primary);
  border-bottom-right-radius: 3px;
  font-weight: 600;
}
.bubble.success {
  background: var(--bubble-success);
  color: var(--success);
  border: 1.5px solid var(--success);
}
.bubble.warning {
  background: var(--bubble-warning);
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
.material-icons {
  font-size: 19px;
  vertical-align: middle;
  margin-right: 6px;
  opacity: .74;
}
.bot-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  margin-right: 7px;
  box-shadow: 0 1px 7px #a259e619;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e0f7fa;
  margin-left: 7px;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.user-avatar img, .user-avatar span.material-icons { width: 100%; height: 100%; }
.input-bar {
  display: flex;
  gap: 8px;
  padding: 15px 12px 15px 12px;
  border-top: 1.5px solid #f0f0f7;
  background: linear-gradient(90deg,#fcfcfe 80%,#f5f4fe 100%);
  align-items: center;
}
.input-bar input, .input-bar button, .input-bar select {
  font-family: var(--font-main);
  font-size: 15px;
  border-radius: 7px;
  border: none;
  outline: none;
}
.input-bar input {
  flex: 1;
  padding: 12px 13px;
  background: #f5f5fa;
  color: var(--text);
  border: 1.2px solid #e1e1ef;
  transition: border .17s;
}
.input-bar input:focus {
  border: 1.2px solid var(--primary);
  background: #f8f9fb;
}
.input-bar button {
  background: linear-gradient(90deg,#00bfae 80%,#a259e6 100%);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  padding: 11px 17px;
  cursor: pointer;
  border: none;
  min-width: 46px;
  box-shadow: 0 1px 6px #00bfae1c;
  transition: box-shadow .18s, transform .18s;
}
.input-bar button:active { transform: scale(0.98);}
.input-bar button:disabled { opacity: .43; cursor: not-allowed;}
@media (max-width:520px) {
  .chat-card {max-width:99vw;}
}
@media (max-width:400px) {
  .header-title {font-size:14px;}
  .header-desc {font-size:10px;}
  .chat-window {padding:10px 2vw 6px 2vw;}
  .input-bar {padding: 10px 5px;}
}
/* Animations */
@keyframes fadeInUp {from{opacity:0;transform:translateY(21px);}to{opacity:1;transform:translateY(0);}}
@keyframes pulse {
  0%{box-shadow:0 0 0 0 #00bfae33;}
  70%{box-shadow:0 0 0 12px #00bfae00;}
  100%{box-shadow:0 0 0 0 #00bfae33;}
}
/* Scroll to bottom indicator */
#scrollToBottom {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  bottom: 80px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 14px;
  padding: 6px 16px;
  font-size: 14px;
  font-weight: 700;
  box-shadow: 0 1px 6px #00bfae1c;
  cursor: pointer;
  z-index: 9;
  display: none;
  animation: fadeInUp .33s;
}
  </style>
</head>
<body>
  <img class="banner-img" src="https://pbs.twimg.com/profile_banners/1462505560142667777/1743232308/1500x500" alt="NFTFAN X Banner"/>
  <div id="app">
    <div class="chat-card">
      <div class="header">
        <div class="logo"><img src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Logo"/></div>
        <div class="header-text">
          <div class="header-title">$NFTFAN Ai</div>
          <div class="header-desc">Get 1T $NFTFAN tokens by joining below!</div>
        </div>
        <span class="live-indicator">
          <span class="live-dot"></span>Live
        </span>
      </div>
      <div class="chat-window" id="chatWindow"></div>
      <form class="input-bar" id="inputBar" autocomplete="off">
        <input id="chatInput" type="text" placeholder="Type your X (Twitter) handle..." autocomplete="off" maxlength="60"/>
        <button id="sendBtn" type="submit"><span class="material-icons">send</span></button>
      </form>
      <button id="scrollToBottom">Scroll to bottom</button>
    </div>
  </div>
  <script>
    // --- Utility functions ---
    function delay(ms) { return new Promise(res=>setTimeout(res,ms)); }
    function sanitize(str) {
      return (str||'').replace(/[<>&]/g, (c)=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]));
    }
    function validateEthAddress(addr) {
      return /^0x[a-fA-F0-9]{40}$/.test(addr);
    }
    function validateXHandle(x) {
      return /^@([a-zA-Z0-9_]{1,15})$/.test(x);
    }
    function getStorageData() {
      try{
        return JSON.parse(localStorage.getItem("nftfan_airdrop_chat")) || [];
      }catch{ return [];}
    }
    function saveStorageData(arr) {
      localStorage.setItem("nftfan_airdrop_chat", JSON.stringify(arr));
    }
    function scrollDown(smooth=true) {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.scrollTo({top:chatWindow.scrollHeight,behavior:smooth?'smooth':'auto'});
    }
    function showScrollToBottom(show) {
      document.getElementById('scrollToBottom').style.display = show?'block':'none';
    }

    // --- Avatar fetching ---
    async function getXAvatar(xhandle) {
      // fallback to default if not loaded
      if (!validateXHandle(xhandle)) return 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';
      const uname = xhandle.replace(/^@/, '');
      // Try X avatar via unavatar.io
      return `https://unavatar.io/twitter/${uname}`;
    }

    // --- Chat rendering ---
    function botBubble(html, opts={}) {
      const pre = opts.avatar===false ? '' : `
        <div class="bot-avatar"><img src="https://i.imgur.com/ODP45iQ.png" style="width:100%;"></div>`;
      return `<div class="bubble-row bot">
        ${pre}
        <div class="bubble bot${opts.success? ' success':''}${opts.warning?' warning':''}">${html}</div>
      </div>`;
    }
    function userBubble(html, user) {
      // user: {xHandle, wallet, avatar}
      const ava = user?.avatar ? `<img src="${sanitize(user.avatar)}" onerror="this.src='https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png'" style="width:100%;"/>` : `<span class="material-icons" style="color:#00bfae;">account_circle</span>`;
      return `<div class="bubble-row user">
        <div class="bubble user">${html}</div>
        <div class="user-avatar">${ava}</div>
      </div>`;
    }

    // --- Chat state ---
    let chatLog = getStorageData(); // [{xHandle, wallet, avatar, time}]
    let currentInputStep = 0; // 0: ask X handle, 1: ask wallet
    let tmpUser = {}; // {xHandle, avatar}

    // --- Render chat log ---
    async function renderChat() {
      const win = document.getElementById('chatWindow');
      win.innerHTML = '';
      // Show previous airdrop users
      if (chatLog.length > 0) {
        appendBotMsg(`<span class="material-icons" style="color:var(--secondary);">groups</span> <b>Recent Users:</b>`, {avatar:false});
        for(const entry of chatLog) {
          appendUserMsg(`<span style="font-size:15px;">${sanitize(entry.xHandle)}</span> <br><span style="font-size:13px;color:var(--text-light);">${shortenWallet(entry.wallet)}</span>`, entry);
          appendBotMsg(`<span class="material-icons" style="color:var(--success);">check_circle</span>
            <b>Airdrop requested!</b><br>
            Please wait up to <b>24h</b> for your free $NFTFAN tokens.`, {avatar:false, success:true});
        }
      }
      // Always ask for X username next
      greetAndAsk();
      scrollDown(false);
    }

    function appendBotMsg(html, opts={}) {
      document.getElementById('chatWindow').insertAdjacentHTML('beforeend', botBubble(html, opts));
      scrollDown();
    }
    function appendUserMsg(html, user) {
      document.getElementById('chatWindow').insertAdjacentHTML('beforeend', userBubble(html, user));
      scrollDown();
    }
    function shortenWallet(w) {
      return w && w.length === 42 ? w.slice(0,6)+'...'+w.slice(-4) : w;
    }

    // --- Greet and ask functions ---
    function greetAndAsk() {
      // Only ask for X handle
      setTimeout(()=>{
        appendBotMsg(`<span class="material-icons">question_answer</span>
          To get <b>free $NFTFAN tokens</b>, type your X (Twitter) username as <b>@yourname</b> to start!`);
        setInputStep(0);
      }, 350);
    }

    // --- Input Step Management ---
    function setInputStep(step) {
      currentInputStep = step;
      const input = document.getElementById('chatInput');
      if(step === 0) {
        input.placeholder = 'Your X username (e.g. @nftfansio)';
        input.value = '';
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
      } else if(step === 1) {
        input.placeholder = 'Your Polygon wallet (starts with 0x...)';
        input.value = '';
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.focus();
      } else {
        input.placeholder = '';
        input.value = '';
        input.disabled = true;
        document.getElementById('sendBtn').disabled = true;
      }
    }

    // --- Event: User submits input ---
    document.getElementById('inputBar').addEventListener('submit', async function(e){
      e.preventDefault();
      const val = document.getElementById('chatInput').value.trim();
      if(!val) return;

      if(currentInputStep === 0) {
        // X username
        if(!validateXHandle(val)) {
          appendBotMsg(`<span class="material-icons">warning</span>
            Please enter a valid X (Twitter) username in the format <b>@yourname</b> (max 15 chars, letters/numbers/underscores).`, {warning:true});
          return;
        }
        if(chatLog.find(u=>u.xHandle.toLowerCase() === val.toLowerCase())) {
          appendBotMsg(`<span class="material-icons">error</span>
            That X username is already registered for airdrop.`, {warning:true});
          return;
        }
        tmpUser = {xHandle: val, avatar: await getXAvatar(val)};
        appendUserMsg(`<span style="font-size:15px;">${sanitize(val)}</span>`, tmpUser);
        // Next, ask for wallet
        setTimeout(()=>{
          appendBotMsg(`<span class="material-icons">account_balance_wallet</span>
            Please paste your <b>Polygon (EVM) wallet address</b> (starts with <b>0x</b>).`);
          setInputStep(1);
        }, 600);

      } else if(currentInputStep === 1) {
        // Wallet
        if(!validateEthAddress(val)) {
          appendBotMsg(`<span class="material-icons">error</span>
            That doesn't look like a valid wallet. Must start with <b>0x</b> and be 42 characters.`, {warning:true});
          return;
        }
        if(chatLog.find(u=>u.wallet.toLowerCase() === val.toLowerCase())) {
          appendBotMsg(`<span class="material-icons">error</span>
            That wallet address is already registered for airdrop.`, {warning:true});
          return;
        }
        appendUserMsg(`<span style="font-size:13px;color:var(--text-light);">${shortenWallet(val)}</span>`, tmpUser);
        // Save airdrop
        const entry = {xHandle: tmpUser.xHandle, wallet: val, avatar: tmpUser.avatar, time: Date.now()};
        chatLog.push(entry);
        saveStorageData(chatLog);

        setTimeout(()=>{
          appendBotMsg(`<span class="material-icons" style="color:var(--success);">check_circle</span>
            <b>Request received!</b><br>
            Please wait up to <b>24h</b> to receive your free $NFTFAN tokens.<br>
            We'll send to your address.<br>
            <span style="font-size:13px;color:var(--text-light);">Follow us on <a href="https://x.com/nftfansio" target="_blank" style="color:var(--secondary);font-weight:700;">X</a> for updates!</span>`, {success:true});
        }, 600);

        setTimeout(()=>{
          appendBotMsg(`<span class="material-icons">question_answer</span>
            To register another user, type a new X username (e.g. @noonbi).`);
          setInputStep(0);
        }, 2000);
      }
      scrollDown();
    });

    // --- Scroll to bottom button for mobile UX ---
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.addEventListener('scroll', ()=>{
      if(chatWindow.scrollTop + chatWindow.clientHeight < chatWindow.scrollHeight - 70)
        showScrollToBottom(true);
      else
        showScrollToBottom(false);
    });
    document.getElementById('scrollToBottom').onclick = ()=>scrollDown();

    // --- Initial render ---
    window.addEventListener('DOMContentLoaded', ()=>{
      renderChat();
      scrollDown(false);

      // Animated background bubbles
      for(let i=0;i<13;i++){
        let b=document.createElement('div');
        b.style.position='fixed';
        b.style.zIndex='0';
        b.style.borderRadius='50%';
        b.style.opacity=0.11+Math.random()*0.16;
        b.style.background='radial-gradient(circle,rgba(255,0,226,.21),rgba(0,255,208,.17),transparent 90%)';
        b.style.width=b.style.height=(13+Math.random()*40)+'px';
        b.style.left=(Math.random()*100)+'vw';
        b.style.top=(Math.random()*100)+'vh';
        b.style.pointerEvents='none';
        b.style.transition='2.7s cubic-bezier(.31,1.2,.7,1.2)';
        document.body.appendChild(b);
        setInterval(()=>{
          b.style.left=(Math.random()*100)+'vw';
          b.style.top=(Math.random()*100)+'vh';
        },(2200+Math.random()*7000));
      }
    });
  </script>
</body>
</html>
