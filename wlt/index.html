<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFANS Balance & News</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFTFANS Balance">
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Copy%20of%20NFT.jpg">
  <link rel="apple-touch-startup-image" href="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Copy%20of%20NFT.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    /* [--- styles unchanged; omitted for brevity, copy your original CSS here ---] */
    /* ...paste your entire CSS here from your original HTML... */
	 body { margin: 0; background: #0d0d0d; font-family: 'Rajdhani', sans-serif; color: #fff; overflow-x: hidden; }
    .cyber-grid { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to right, rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(to bottom, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 20px 20px; z-index: 0; pointer-events: none; }
    .wrapper { max-width: 960px; margin: 0 auto; padding: 10px; position: relative; z-index: 1; }
    .header-bar { background: #1a1a1a; border-radius: 8px; padding: 10px; margin-bottom: 10px; position: relative; }
    .banner-area { display: flex; justify-content: space-between; align-items: center; position: relative; }
    .banner-area img { max-width: 100%; height: auto; border-radius: 4px; }
    .tab-bar { display: flex; gap: 5px; justify-content: center; }
    .tab-btn { flex: 1; background: #222; color: #fff; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 9px; transition: all 0.3s; display: flex; align-items: center; gap: 5px; justify-content: center; min-width: 90px; }
    .tab-btn.active { background: #7a3cff; }
    .tab-btn:hover { background: #333; }
    .tab-btn .material-icons { font-size: 17px; vertical-align: middle; }
    .tab-content { margin-top: 10px; }
    .tab-content.hidden { display: none; }
    .wallet-input-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 7px;
      margin: 18px 0 18px 0;
      width: 100%;
    }
    .wallet-input {
      background: #16162a;
      color: #fff;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 7px 12px;
      font-size: 15px;
      font-family: 'Rajdhani', monospace;
      width: 100%;
      max-width: 330px;
      outline: none;
      transition: border 0.2s;
    }
    .wallet-input:focus { border: 1px solid #7a3cff; }
    .wallet-go-btn {
      background: #7a3cff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 7px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .wallet-go-btn .material-icons { font-size: 18px; }
    .wallet-go-btn:hover { background: #9c27b0; }
    .balance-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 16px; }
    .balance-card {
      background: #191927;
      border-radius: 10px;
      padding: 18px 15px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: 0 1px 4px #0004;
      position: relative;
    }
    .token-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #222;
      object-fit: cover;
      border: 1px solid #fff;
      box-shadow: 0 2px 6px #0008;
      margin-right: 6px;
    }
    .token-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .token-symbol {
      font-family: 'Orbitron', 'Rajdhani', sans-serif;
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 1px;
      color: #00ffff;
      margin-bottom: 1px;
    }
    .token-symbol .material-icons.token { color: #a377ff; font-size: 19px; margin-right: 3px; vertical-align: middle; }
    .token-ca {
      font-size: 10px;
      color: #aaa;
      margin-top: 2px;
      word-break: break-all;
    }
    .token-balance {
      font-size: 21px;
      font-family: 'Rajdhani', 'Orbitron', monospace;
      font-weight: bold;
      color: #fff;
      letter-spacing: 1px;
      margin-bottom: 2px;
    }
    .token-name {
      color: #fff;
      font-size: 13px;
      margin-top: 1px;
      margin-bottom: 2px;
    }
    .token-symbol.poldog .material-icons.token { color: #00cfff; }
    .token-symbol.poldog { color: #00cfff; }
    .nft-section {
      margin: 22px 0 8px 0;
    }
    .nft-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 8px;
      margin: 0;
      padding: 0;
      justify-content: start;
      align-items: start;
    }
    .nft-card {
      width: 70px;
      height: 70px;
      background: #191927;
      border-radius: 7px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      border: 1.5px solid #fff;
      box-sizing: border-box;
      box-shadow: 0 1px 4px #0006;
      font-size: 10px;
      text-align: center;
    }
    .nft-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #232332;
      display: block;
    }
    .nft-count-badge {
      position: absolute;
      bottom: 3px;
      right: 6px;
      background: #00ff8b;
      color: #000;
      font-size: 10px;
      font-family: 'Rajdhani', monospace;
      padding: 2px 5px;
      border-radius: 12px;
      font-weight: bold;
      box-shadow: 0 1px 3px #000a;
    }
    .nft-title {
      position: absolute;
      top: 3px;
      left: 4px;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      text-shadow: 0 1px 2px #000b;
      background: rgba(24,24,32,0.74);
      border-radius: 4px;
      padding: 0 4px;
      max-width: 61px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      pointer-events: none;
    }
    .nft-empty-msg {
      margin: 12px 0 0 0;
      color: #aaa;
      text-align: center;
      font-size: 13px;
    }
    .buy-section {
      background: #18182d;
      border-radius: 10px;
      margin: 22px 0 16px 0;
      padding: 19px 9px 19px 9px;
      box-shadow: 0 1px 8px #0006;
    }
    .buy-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 13px;
      flex-wrap: wrap;
    }
    .buy-row:last-child { margin-bottom: 0; }
    .buy-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1.5px solid #fff;
      object-fit: cover;
      box-shadow: 0 1px 6px #0006;
      background: #222;
    }
    .buy-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .buy-symbol {
      font-family: 'Orbitron', 'Rajdhani', sans-serif;
      font-size: 16px;
      font-weight: 700;
      color: #00ffff;
      margin-bottom: 0;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .buy-symbol.poldog { color: #00cfff; }
    .buy-balance {
      font-size: 15px;
      color: #fff;
      font-weight: 700;
      margin-bottom: 2px;
    }
    .buy-ca {
      font-size: 10px;
      color: #aaa;
      word-break: break-all;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .copy-btn {
      background: none;
      border: none;
      color: #7a3cff;
      cursor: pointer;
      font-size: 14px;
      padding: 0 3px;
      margin-left: 3px;
      display: flex;
      align-items: center;
      transition: color 0.2s;
    }
    .copy-btn .material-icons { font-size: 14px; }
    .copy-btn.copied { color: #00ff8b !important; }
    .buy-section-info {
      background: #11182a;
      color: #fffd;
      border-radius: 8px;
      padding: 13px 9px;
      font-size: 13px;
      margin: 18px 0 14px 0;
      box-shadow: 0 1px 7px #0005;
      line-height: 1.6;
      text-align: center;
      font-family: 'Rajdhani', sans-serif;
    }
    .buy-rates {
      margin-top: 9px;
      font-size: 12px;
      color: #00ffff;
      font-family: 'Orbitron', monospace;
    }
    .buy-nft-grid-title {
      font-size: 14px;
      font-weight: bold;
      margin: 15px 0 10px 2px;
    }
    .buy-nft-grid .nft-card {
      border: 2px solid #7a3cff;
      box-shadow: 0 1px 10px #7a3cff33;
      margin-bottom: 0;
    }
    .nft-buy-btn {
      position: absolute;
      left: 50%;
      bottom: 4px;
      transform: translateX(-50%);
      background: #7a3cff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 2px 7px;
      font-size: 11px;
      font-family: 'Rajdhani', monospace;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s;
      z-index: 3;
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
      text-decoration: none;
    }
    .nft-buy-btn:hover { background: #9c27b0; }
    .nft-buy-btn .material-icons { font-size: 13px; vertical-align: middle;}
    .error-bar {
      text-align: center;
      color: #ff2070;
      margin: 12px 0 0 0;
      font-size: 13px;
      font-weight: 600;
    }
    footer { text-align: center; padding: 10px; font-size: 10px; color: #555; }
    @media (max-width: 600px) {
      .balance-list, .news-list { gap: 10px; }
      .wrapper { padding: 5px; }
      .balance-card { padding: 13px 7px; }
      .news-card { padding: 10px 8px; }
      .banner-area img { border-radius: 3px; }
      .wallet-input { max-width: 180px; font-size: 13px; padding: 7px 6px; }
      .wallet-input-bar { margin: 13px 0 13px 0; }
      .nft-section { margin: 15px 0 8px 0; }
      .nft-grid { gap: 6px; }
      .buy-section { padding: 12px 3px; }
      .buy-row { gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="cyber-grid"></div>
  <div class="wrapper">
    <div class="header-bar">
      <div class="banner-area">
        <img src="https://pbs.twimg.com/media/Gs758wIWEAEsq45?format=jpg&name=large" alt="NFTFANS Banner">
      </div>
      <div class="tab-bar">
        <button class="tab-btn active" id="tab-balance" onclick="showTab('balance')">
          <span class="material-icons">account_balance_wallet</span> WALLET
        </button>
        <button class="tab-btn" id="tab-buy" onclick="showTab('buy')">
          <span class="material-icons">shopping_cart</span> BUY
        </button>
        <button class="tab-btn" id="tab-news" onclick="showTab('news')">
          <span class="material-icons">feed</span> AIRDROPS
        </button>
      </div>
    </div>
    <!-- INPUT BAR -->
    <div class="wallet-input-bar" id="walletInputBar">
      <input class="wallet-input" type="text" id="walletInput" placeholder="Enter wallet address" autocomplete="off" spellcheck="false" />
      <button class="wallet-go-btn" id="addWalletBtn" onclick="addWallet()">
        <span class="material-icons">add</span> ADD WALLET
      </button>
      <button class="wallet-go-btn" id="deleteWalletBtn" style="display:none;" onclick="deleteWallet()">
        <span class="material-icons">delete</span> DELETE WALLET
      </button>
    </div>
    <div id="errorBar" class="error-bar" style="display:none;"></div>
    <!-- BALANCE TAB -->
    <div class="tab-content" id="tab-content-balance">
      <ul class="balance-list">
        <li class="balance-card">
          <img class="token-icon" src="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Copy%20of%20NFT.jpg" alt="NFTFAN">
          <div class="token-details">
            <span class="token-symbol"><span class="material-icons token">token</span>NFTFAN</span>
            <span class="token-name">NFT Fans Token</span>
            <span class="token-balance" id="nftfanBalance">--</span>
            <span class="token-ca">CA: 0x2017Fcaea540d2925430586DC92818035Bfc2F50</span>
          </div>
        </li>
        <li class="balance-card">
          <img class="token-icon" src="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Untitled%20design%20(56).png" alt="POLDOG">
          <div class="token-details">
            <span class="token-symbol poldog"><span class="material-icons token">pets</span>POLDOG</span>
            <span class="token-name">Polygon Dogs Token</span>
            <span class="token-balance" id="poldogBalance">--</span>
            <span class="token-ca">CA: 0xC504f9154B2f563879c9E25Cd564A47975326737</span>
          </div>
        </li>
      </ul>
      <!-- NFT GRID -->
      <div class="nft-section">
        <div style="font-size:14px;font-weight:600;margin-bottom:8px;margin-left:2px;">Coin Fun NFTs</div>
        <div id="nftGridWrap">
          <div class="nft-grid" id="nftGrid"></div>
          <div class="nft-empty-msg" id="nftEmptyMsg" style="display:none;">No Coin Fun NFTs found for this wallet.</div>
        </div>
      </div>
    </div>
    <!-- BUY TAB -->
    <div class="tab-content hidden" id="tab-content-buy">
      <div class="buy-section">
        <div class="buy-row">
          <img class="buy-icon" src="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Copy%20of%20NFT.jpg" alt="NFTFAN">
          <div class="buy-details">
            <span class="buy-symbol"><span class="material-icons token">token</span>NFTFAN</span>
            <span class="token-name">NFT Fans Token Sale</span>
            <span class="buy-ca">
              SALE CA: <span id="nftfanSaleCA">0xaf2d132C8773bca3821C24EcF64e844E202A12e8</span>
              <button class="copy-btn" onclick="copyToClipboard('nftfanSaleCA', this)" title="Copy"><span class="material-icons">content_copy</span></button>
            </span>
            <span class="buy-balance" id="nftfanSaleBalance">--</span>
          </div>
        </div>
        <div class="buy-row">
          <img class="buy-icon" src="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/Untitled%20design%20(56).png" alt="POLDOG">
          <div class="buy-details">
            <span class="buy-symbol poldog"><span class="material-icons token">pets</span>POLDOG</span>
            <span class="token-name">Polygon Dogs Token Sale</span>
            <span class="buy-ca">
              SALE CA: <span id="poldogSaleCA">0xb1a37c277986e13aa6c4f0763c2f06c4e9527d54</span>
              <button class="copy-btn" onclick="copyToClipboard('poldogSaleCA', this)" title="Copy"><span class="material-icons">content_copy</span></button>
            </span>
            <span class="buy-balance" id="poldogSaleBalance">--</span>
          </div>
        </div>
        <div class="buy-section-info">
          <div>To buy any Token, send <span style="color:#00ffff;">$POL</span> (<b>0.01 - 100</b>) to any above contract addresses.<br>
          You will receive the tokens automatically.<br>
          <span class="buy-rates">
            1 POL = 1000T NFTFAN<br>
            1 POL = 1,000,000 POLDOG
          </span>
          </div>
        </div>
        <div class="buy-nft-grid-title">Coin Fun NFTs</div>
        <div class="nft-grid buy-nft-grid" id="buyNftGrid"></div>
        <div class="nft-empty-msg" id="buyNftEmptyMsg" style="display:none;">NFT sale not available now.</div>
      </div>
    </div>
    <!-- NEWS TAB -->
    <div class="tab-content hidden" id="tab-content-news">
      <div class="news-section">
        <ul class="news-list" id="newsList">
          <li class="news-card">
            <div class="news-title">Welcome to NFT Fans & Polygon Dogs!</div>
            <div>Airdrops will be announced here!</div>
          </li>
          <li class="news-card">
            <div class="news-title">How to Buy Tokens?</div>
            <div>Go to Buy tab and follow instructions.</div>
          </li>
          <li class="news-card">
            <div class="news-title">How to get Coin Fun NFTs?</div>
            <div>Coin Fun NFTs are ERC1155 collectibles. You can get them via https://www.nftfanstoken.com/coinfun/</div>
          </li>
        </ul>
      </div>
    </div>
  </div>
  <footer>
    <span class="material-icons" style="font-size:13px;vertical-align:middle;color:#7a3cff;">copyright</span>
    NFTFANS TOKEN
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  <script>
    const NFTFAN_TOKEN_CA = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const POLDOG_TOKEN_CA = "0xC504f9154B2f563879c9E25Cd564A47975326737";
    const COINFUN_NFT_CA = "0x582E752646c6df16a14247994f1848C7Cd208211";
    const NFTFAN_SALE_CA = "0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
    const POLDOG_SALE_CA = "0xb1a37c277986e13aa6c4f0763c2f06c4e9527d54";
    const ERC20_ABI = [
      {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
      {"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"}
    ];
    const ERC1155_ABI = [
      {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_id","type":"uint256"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},
      {"constant":true,"inputs":[{"name":"_id","type":"uint256"}],"name":"uri","outputs":[{"name":"","type":"string"}],"type":"function"}
    ];
    const COINFUN_NFT_IDS = Array.from({length: 30}, (_, i) => i); // IDs 0..29

    let web3 = new Web3("https://polygon-rpc.com/");
    let nftfanContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_TOKEN_CA);
    let poldogContract = new web3.eth.Contract(ERC20_ABI, POLDOG_TOKEN_CA);
    let coinfunContract = new web3.eth.Contract(ERC1155_ABI, COINFUN_NFT_CA);
    let nftfanSaleContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_SALE_CA);
    let poldogSaleContract = new web3.eth.Contract(ERC20_ABI, POLDOG_SALE_CA);

    // Storage keys
    const WALLET_STORAGE_KEY = "nftfans-wallet-address";

    function showTab(tab) {
      document.getElementById('tab-content-balance').classList.toggle("hidden", tab !== 'balance');
      document.getElementById('tab-content-buy').classList.toggle("hidden", tab !== 'buy');
      document.getElementById('tab-content-news').classList.toggle("hidden", tab !== 'news');
      document.getElementById('tab-balance').classList.toggle('active', tab === 'balance');
      document.getElementById('tab-buy').classList.toggle('active', tab === 'buy');
      document.getElementById('tab-news').classList.toggle('active', tab === 'news');
      if (tab === 'buy') fetchBuyTabBalances();
    }

    function formatNumberNoDecimals(numStr, decimals) {
      if (!numStr) return "--";
      try {
        let num = BigInt(numStr);
        let divisor = BigInt(10) ** BigInt(decimals);
        let whole = num / divisor;
        return whole.toLocaleString('en-US');
      } catch (e) {
        return "--";
      }
    }

    function setWalletInputUI(address) {
      const input = document.getElementById('walletInput');
      const addBtn = document.getElementById('addWalletBtn');
      const delBtn = document.getElementById('deleteWalletBtn');
      if (address) {
        input.value = address;
        input.disabled = true;
        addBtn.style.display = "none";
        delBtn.style.display = "";
      } else {
        input.value = "";
        input.disabled = false;
        addBtn.style.display = "";
        delBtn.style.display = "none";
      }
    }

    function getSavedWallet() {
      return localStorage.getItem(WALLET_STORAGE_KEY) || null;
    }

    function addWallet() {
      const addr = document.getElementById('walletInput').value.trim();
      const errorBar = document.getElementById('errorBar');
      errorBar.style.display = "none";
      if (!/^0x[a-fA-F0-9]{40}$/.test(addr)) {
        errorBar.textContent = "Please enter a valid wallet address";
        errorBar.style.display = "";
        return;
      }
      localStorage.setItem(WALLET_STORAGE_KEY, addr);
      setWalletInputUI(addr);
      fetchBalances(addr);
    }

    function deleteWallet() {
      localStorage.removeItem(WALLET_STORAGE_KEY);
      setWalletInputUI(null);
      // Reset UI
      document.getElementById('nftfanBalance').textContent = "--";
      document.getElementById('poldogBalance').textContent = "--";
      clearNFTGrid();
    }

    // Overwrite fetchBalances to take address from argument or storage
    async function fetchBalances(address) {
      // address: optional. If not provided, get from storage
      address = address || getSavedWallet();
      const errorBar = document.getElementById('errorBar');
      errorBar.style.display = "none";
      if (!address || !/^0x[a-fA-F0-9]{40}$/.test(address)) {
        errorBar.textContent = "Please enter a valid wallet address";
        errorBar.style.display = "";
        document.getElementById('nftfanBalance').textContent = "--";
        document.getElementById('poldogBalance').textContent = "--";
        clearNFTGrid();
        return;
      }
      document.getElementById('nftfanBalance').textContent = "...";
      document.getElementById('poldogBalance').textContent = "...";
      clearNFTGrid(true); // show loading
      try {
        let [nftfanInfo, poldogInfo] = await Promise.all([
          Promise.all([
            nftfanContract.methods.balanceOf(address).call(),
            nftfanContract.methods.decimals().call()
          ]),
          Promise.all([
            poldogContract.methods.balanceOf(address).call(),
            poldogContract.methods.decimals().call()
          ])
        ]);
        document.getElementById('nftfanBalance').textContent = formatNumberNoDecimals(nftfanInfo[0], nftfanInfo[1]);
        document.getElementById('poldogBalance').textContent = formatNumberNoDecimals(poldogInfo[0], poldogInfo[1]);
      } catch (e) {
        errorBar.textContent = "Failed to load balances. Please try again.";
        errorBar.style.display = "";
        document.getElementById('nftfanBalance').textContent = "--";
        document.getElementById('poldogBalance').textContent = "--";
      }
      try {
        await fetchCoinFunNFTs(address, "nftGrid", "nftEmptyMsg");
      } catch (e) {
        document.getElementById('nftEmptyMsg').textContent = "Failed to load Coin Fun NFTs.";
        document.getElementById('nftEmptyMsg').style.display = "";
        document.getElementById('nftGrid').innerHTML = "";
      }
    }

    function clearNFTGrid(loading=false) {
      document.getElementById('nftGrid').innerHTML = loading ? '<div class="nft-empty-msg" style="color:#aaa;text-align:center;">Loading NFTs...</div>' : '';
      document.getElementById('nftEmptyMsg').style.display = "none";
    }

    async function fetchCoinFunNFTs(address, gridId, emptyMsgId, showBuyBtn) {
      const nftGrid = document.getElementById(gridId);
      const nftEmptyMsg = document.getElementById(emptyMsgId);
      nftGrid.innerHTML = '';
      nftEmptyMsg.style.display = "none";
      let nftPromises = COINFUN_NFT_IDS.map(async id => {
        try {
          let [bal, uri] = await Promise.all([
            address ? coinfunContract.methods.balanceOf(address, id).call() : "1",
            coinfunContract.methods.uri(id).call()
          ]);
          if ((bal && bal !== "0") || showBuyBtn) {
            let metaUrl = uri.replace('{id}', id.toString(16).padStart(64, '0'));
            if (metaUrl.startsWith("ipfs://")) {
              metaUrl = "https://ipfs.io/ipfs/" + metaUrl.substring(7);
            }
            let imgUrl = '', title = '';
            try {
              let meta = await fetch(metaUrl).then(r => r.json());
              imgUrl = meta?.image || '';
              title = meta?.name || '';
              if (imgUrl && imgUrl.startsWith("ipfs://")) {
                imgUrl = "https://ipfs.io/ipfs/" + imgUrl.substring(7);
              }
            } catch (err) {
              imgUrl = '';
              title = '';
            }
            if (!imgUrl) imgUrl = 'https://via.placeholder.com/70x70?text=NFT';
            if (!title) title = `#${id}`;
            if (showBuyBtn) {
              return `<div class="nft-card">
                <img class="nft-img" src="${imgUrl}" alt="NFT #${id}" loading="lazy" onerror="this.src='https://via.placeholder.com/70x70?text=NFT'">
                <span class="nft-title">${title}</span>
                <a class="nft-buy-btn" href="https://www.nftfanstoken.com/coinfun/" target="_blank" rel="noopener">
                  <span class="material-icons">shopping_cart</span>Buy
                </a>
              </div>`;
            } else {
              return `<div class="nft-card">
                <img class="nft-img" src="${imgUrl}" alt="NFT #${id}" loading="lazy" onerror="this.src='https://via.placeholder.com/70x70?text=NFT'">
                <span class="nft-title">${title}</span>
                <span class="nft-count-badge">x${bal}</span>
              </div>`;
            }
          } else {
            return '';
          }
        } catch (e) {
          return '';
        }
      });
      let nfts = await Promise.all(nftPromises);
      nfts = nfts.filter(x => x);
      if (nfts.length === 0) {
        nftGrid.innerHTML = '';
        nftEmptyMsg.textContent = showBuyBtn ? "NFT sale not available now." : "No Coin Fun NFTs found for this wallet.";
        nftEmptyMsg.style.display = "";
      } else {
        nftGrid.innerHTML = nfts.join("");
        nftEmptyMsg.style.display = "none";
      }
    }

    async function fetchBuyTabBalances() {
      document.getElementById('nftfanSaleBalance').textContent = "...";
      document.getElementById('poldogSaleBalance').textContent = "...";
      try {
        let [nftfanInfo, poldogInfo] = await Promise.all([
          Promise.all([
            nftfanContract.methods.balanceOf(NFTFAN_SALE_CA).call(),
            nftfanContract.methods.decimals().call()
          ]),
          Promise.all([
            poldogContract.methods.balanceOf(POLDOG_SALE_CA).call(),
            poldogContract.methods.decimals().call()
          ])
        ]);
        document.getElementById('nftfanSaleBalance').textContent = formatNumberNoDecimals(nftfanInfo[0], nftfanInfo[1]);
        document.getElementById('poldogSaleBalance').textContent = formatNumberNoDecimals(poldogInfo[0], poldogInfo[1]);
      } catch (e) {
        document.getElementById('nftfanSaleBalance').textContent = "--";
        document.getElementById('poldogSaleBalance').textContent = "--";
      }
      try {
        await fetchCoinFunNFTs(null, "buyNftGrid", "buyNftEmptyMsg", true);
      } catch (e) {
        document.getElementById('buyNftEmptyMsg').textContent = "NFT sale not available now.";
        document.getElementById('buyNftEmptyMsg').style.display = "";
        document.getElementById('buyNftGrid').innerHTML = "";
      }
    }

    function copyToClipboard(spanId, btn) {
      const caText = document.getElementById(spanId).textContent;
      navigator.clipboard.writeText(caText).then(() => {
        btn.classList.add('copied');
        btn.title = "Copied!";
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.title = "Copy";
        }, 1200);
      });
    }

    document.getElementById('walletInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        if (getSavedWallet()) return; // don't allow input when wallet is saved
        addWallet();
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const savedAddress = getSavedWallet();
      setWalletInputUI(savedAddress);
      if (savedAddress) {
        fetchBalances(savedAddress);
      }
      showTab('balance');
    });
  </script>
</body>
</html>
