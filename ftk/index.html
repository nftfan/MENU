<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFT FANS Airdrop Submission</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #18151a;
      --card-bg: #212027;
      --text: #e3dccf;
      --muted: #726b7b;
      --accent: #e4ae64;
      --border: #2d2936;
      --radius: 12px;
      --shadow: 0 2px 12px rgba(228,174,100,0.16);
      --copy-bg: #232029;
      --copy-border: #3a3241;
      --font-thin: 350;
      --success: #8aff8a;
      --danger: #ff8a8a;
      --info: #8affff;
      --transition: 0.3s cubic-bezier(.31,.52,.41,.97);
    }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      width: 100vw;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Roboto', 'Arial', ui-sans-serif, system-ui, -apple-system;
      font-size: 9px;
      font-weight: var(--font-thin);
      letter-spacing: 0.02em;
      overflow-x: hidden;
    }
    body {
      background: linear-gradient(135deg, #19151a 0%, #232029 100%);
    }
    .top-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 0;
    }
    .card {
      width: 100%;
      max-width: 340px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      padding: 16px 7px 16px 7px;
      margin: 0 auto;
      margin-top: 30px;
      font-weight: var(--font-thin);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: box-shadow var(--transition), background var(--transition);
      backdrop-filter: blur(3px);
    }
    .title {
      font-size: 13px;
      font-weight: 900;
      margin-bottom: 12px;
      color: var(--accent);
      letter-spacing: 0.05em;
      text-align: center;
      text-shadow: 0 2px 10px #0002;
    }
    .form-step {
      width: 100%;
      margin-bottom: 8px;
      animation: fadeInUp 0.6s;
      transition: opacity var(--transition);
    }
    .step-stack {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 5px;
    }
    .step-stack .form-step {
      margin-bottom: 0px;
      box-shadow: none;
      border-radius: 0;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      background: none;
    }
    .step-stack .form-step:last-child {
      border-bottom: none;
    }
    .entered-data {
      font-size: 9px;
      color: var(--accent);
      background: var(--copy-bg);
      border: 1px solid var(--copy-border);
      border-radius: 7px;
      padding: 5px 7px;
      margin: 5px 0 0 0;
      word-break: break-all;
      width: fit-content;
      max-width: 95%;
      box-shadow: 0 2px 6px #0001;
      font-weight: 500;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .entered-label {
      color: var(--muted);
      font-size: 9px;
      font-weight: 350;
      margin-right: 3px;
    }
    label {
      font-size: 9px;
      margin-bottom: 6px;
      color: var(--muted);
      display: block;
      text-align: left;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    input[type="text"] {
      width: 100%;
      padding: 11px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--copy-bg);
      color: var(--accent);
      font-size: 9px;
      font-family: inherit;
      box-sizing: border-box;
      outline: none;
      margin-bottom: 4px;
      transition: border-color var(--transition), box-shadow var(--transition);
      box-shadow: 0 2px 7px 0 #0002;
    }
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px #e4ae6444;
    }
    button {
      background: linear-gradient(90deg, var(--accent) 0%, #d4a154 100%);
      color: var(--card-bg);
      border: none;
      border-radius: var(--radius);
      padding: 10px 0;
      font-size: 9px;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
      font-weight: 700;
      box-shadow: 0 2px 14px #e4ae6411;
      transition: background var(--transition), transform var(--transition), box-shadow var(--transition);
      letter-spacing: 0.08em;
      outline: none;
      opacity: 1;
      position: relative;
      z-index: 1;
    }
    button.next-animate {
      opacity: 0;
      transform: translateY(24px) scale(0.96);
      pointer-events: none;
      animation: nextFadeIn 0.7s cubic-bezier(.31,.52,.41,.97) forwards;
    }
    @keyframes nextFadeIn {
      from { opacity: 0; transform: translateY(24px) scale(0.96);}
      80% { opacity: 0.7; transform: translateY(8px) scale(1);}
      to { opacity: 1; transform: translateY(0) scale(1);}
    }
    button:hover {
      background: linear-gradient(90deg, #d4a154 0%, var(--accent) 100%);
      box-shadow: 0 4px 24px #e4ae6422;
    }
    button:active {
      transform: scale(0.98);
    }
    .back-btn {
      background: var(--copy-bg);
      color: var(--accent);
      margin-top: 6px;
      font-weight: 500;
      font-size: 9px;
      padding: 7px 0;
      border-radius: var(--radius);
      box-shadow: 0 2px 7px #0002;
      border: 1px solid var(--copy-border);
      transition: background var(--transition), color var(--transition), border-color var(--transition);
    }
    .back-btn:hover {
      background: var(--card-bg);
      color: var(--accent);
      border-color: var(--accent);
    }
    .message {
      font-size: 9px;
      margin: 8px 0;
      padding: 7px;
      border-radius: var(--radius);
      display: none;
      font-weight: 600;
      letter-spacing: 0.01em;
      box-shadow: 0 2px 10px #0002;
    }
    .error { 
        color: var(--danger); 
        background: rgba(255, 138, 138, 0.11);
        border: 1px solid var(--danger);
        display: block;
        animation: fadeInUp 0.5s;
    }
    .status {
        font-size: 9px;
        color: var(--muted);
        margin: 8px 0 6px 0;
        font-weight: 500;
        letter-spacing: 0.01em;
        text-align: center;
        transition: color var(--transition);
    }
    .fake-verify {
        font-size: 9px;
        color: var(--accent);
        background: var(--copy-bg);
        border-radius: var(--radius);
        padding: 7px;
        margin: 7px 0;
        display: none;
        font-weight: 600;
        animation: fadeIn 0.9s;
        box-shadow: 0 2px 10px #e4ae6411;
        border: 1px solid var(--copy-border);
        text-align: center;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .success { 
        font-size: 11px;
        font-weight: 900;
        color: var(--success); 
        margin-bottom: 9px;
        letter-spacing: 0.01em;
        text-shadow: 0 2px 8px #8aff8a22;
        animation: fadeInUp 0.8s;
        text-align: center;
    }
    .instructions {
      width: 90%;
      margin-top: 7px;
      font-size: 9px;
      color: var(--muted);
      background: var(--copy-bg);
      border-radius: var(--radius);
      border: 1px solid var(--copy-border);
      padding: 10px 7px 11px 7px;
      text-align: left;
      line-height: 1.7;
      box-shadow: 0 2px 10px #0002;
      word-break: break-word;
    }
    .instructions b {
      color: var(--accent);
      font-weight: 900;
      letter-spacing: 0.01em;
      font-size: 9px;
    }
    .airdrop-address-row {
      display: flex;
      align-items: center;
      background: var(--copy-bg);
      border: 1px solid var(--copy-border);
      border-radius: 7px;
      padding: 6px 7px;
      color: var(--accent);
      font-size: 9px !important;
      word-break: break-all;
      margin: 4px 0 2px 0;
      gap: 6px;
      font-weight: 400;
      position: relative;
    }
    #airdropAddr {
      font-size: 9px !important;
      color: var(--accent);
      font-family: 'Roboto Mono', 'Consolas', monospace;
      font-weight: 400;
      letter-spacing: 0.03em;
    }
    .copy-btn {
      background: var(--card-bg);
      color: var(--accent);
      font-size: 9px !important;
      border: 1px solid var(--copy-border);
      border-radius: 6px;
      padding: 2px 7px;
      cursor: pointer;
      margin-left: 4px;
      transition: background 0.18s, color 0.18s, border 0.18s, transform 0.1s;
      display: flex;
      align-items: center;
      gap: 2px;
      position: relative;
      font-weight: 500;
    }
    .copy-btn:active {
      background: var(--bg);
      color: var(--accent);
      border: 1px solid #3a3241;
      animation: vibrate 0.18s linear 2;
    }
    @keyframes vibrate {
      0% { transform: translateX(0); }
      20% { transform: translateX(-1px); }
      40% { transform: translateX(2px); }
      60% { transform: translateX(-2px); }
      80% { transform: translateX(1px); }
      100% { transform: translateX(0); }
    }
    .copied-tooltip {
      display: none;
      position: absolute;
      left: 50%;
      bottom: 115%;
      transform: translateX(-50%);
      background: var(--copy-bg);
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 7px;
      font-size: 9px !important;
      white-space: nowrap;
      opacity: 0.93;
      z-index: 10;
      border: 1px solid var(--copy-border);
      font-weight: 400;
    }
    .copy-btn.copied .copied-tooltip {
      display: block;
      animation: fadeOut 1.2s forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 0.93; }
      80% { opacity: 0.93; }
      100% { opacity: 0; }
    }
    .form-step {
      opacity: 1;
      transition: opacity var(--transition), transform var(--transition);
    }
    .form-step.hidden {
      opacity: 0;
      transform: translateY(20px) scale(0.98);
      pointer-events: none;
      height: 0;
      margin: 0;
      padding: 0;
    }
    .spinner {
      display: inline-block;
      vertical-align: middle;
      width: 14px;
      height: 14px;
      margin-right: 5px;
      border: 2px solid #23262e;
      border-top: 2px solid var(--accent);
      border-radius: 50%;
      animation: spin 1.2s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg);}
    }
    .next-below-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 12px;
      margin-bottom: -3px;
    }
    .hidden-next {
      display: none !important;
      opacity: 0 !important;
    }
    @media (max-width: 420px) {
      .card { padding: 8px 2px 8px 2px; }
      .title, label, .airdrop-address-row, #airdropAddr, .copy-btn, .copied-tooltip, .instructions { font-size: 9px !important; }
      button, .status, .success, .fake-verify { font-size: 9px !important; }
      .next-below-wrap { margin-top: 9px; }
      .entered-data { font-size: 9px !important; }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, query, orderByChild, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let walletSet = new Set();
    let userSet = new Set();
    let userXHandle = '';
    let userWallet = '';

    function listenExisting() {
      const usersRef = query(ref(db, 'nftfan_airdrop_chat'), orderByChild('time'));
      onValue(usersRef, (snapshot) => {
        let wallets = new Set();
        let users = new Set();
        snapshot.forEach(child => {
          let v = child.val();
          if (v.wallet && v.xHandle) {
            wallets.add(v.wallet.trim().toLowerCase());
            users.add(v.xHandle.trim().toLowerCase());
          }
        });
        walletSet = wallets;
        userSet = users;
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
        listenExisting();

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');

        const xHandleInput = document.getElementById('xHandle');
        const walletInput = document.getElementById('wallet');
        
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');
        const backBtn2 = document.getElementById('backBtn2');
        const backBtn3 = document.getElementById('backBtn3');

        const errorDiv = document.getElementById('errorMsg');
        const statusDiv = document.getElementById('statusMsg');
        const fakeVerifyDiv = document.getElementById('fakeVerify');
        const addrCopyBtn = document.getElementById('copyAddrBtn');
        const addrCopyTooltip = document.getElementById('copiedTooltip');
        const nextBelowWrap = document.getElementById('nextBelowWrap');
        const nextBelowBtn = document.getElementById('nextBelowBtn');

        // Previous step display containers
        const prevStep2 = document.getElementById('prevStep2');
        const prevStep3 = document.getElementById('prevStep3');

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('error');
            errorDiv.style.display = 'block';
            showNextBelow(false);
        }

        function clearError() {
            errorDiv.textContent = '';
            errorDiv.classList.remove('error');
            errorDiv.style.display = 'none';
        }

        function showStep(step) {
            [step1, step2, step3, step4].forEach(s => s.classList.add('hidden'));
            step.classList.remove('hidden');
            showNextBelow(step === step1);
            updatePrevSteps();
        }

        function showNextBelow(show) {
            if (show) {
                nextBelowBtn.classList.add('next-animate');
                nextBelowWrap.classList.remove('hidden-next');
                setTimeout(() => {
                    nextBelowBtn.classList.remove('next-animate');
                }, 700);
            } else {
                nextBelowWrap.classList.add('hidden-next');
            }
        }

        nextBelowBtn.addEventListener('click', () => {
            nextBtn.click();
        });

        nextBtn.addEventListener('click', async () => {
            clearError();
            statusDiv.innerHTML = '<span class="spinner"></span>Verifying user...';
            statusDiv.classList.remove('hidden');
            fakeVerifyDiv.style.display = 'none';

            const xHandle = xHandleInput.value.trim();

            if (!xHandle) {
                showError("Please enter your X (Twitter) username.");
                statusDiv.classList.add('hidden');
                return;
            }
            if (!/^@?[a-zA-Z0-9_]{1,15}$/.test(xHandle)) {
                showError("Invalid X username. Example: @yourhandle");
                statusDiv.classList.add('hidden');
                return;
            }
            const xHandleLC = xHandle.replace(/^@/, '').toLowerCase();
            if (userSet.has(xHandleLC) || userSet.has('@'+xHandleLC)) {
                showError("This X username is already registered.");
                statusDiv.classList.add('hidden');
                return;
            }
            userXHandle = '@' + xHandleLC;

            showStep(step2);

            setTimeout(() => {
                fakeVerifyDiv.textContent = "🔔 Verifying X (Twitter) identity...";
                fakeVerifyDiv.style.display = 'block';
                setTimeout(() => {
                  fakeVerifyDiv.textContent = "✅ X (Twitter) identity verified!";
                  statusDiv.innerHTML = '';
                  setTimeout(() => {
                    showStep(step3);
                  }, 1000);
                }, 900);
            }, 850);
        });

        submitBtn.addEventListener('click', async () => {
            clearError();
            fakeVerifyDiv.style.display = 'none';
            const wallet = walletInput.value.trim();

            if (!wallet) {
                showError("Please enter your wallet address.");
                return;
            }
            if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
                showError("Invalid wallet address. Must be an Ethereum/Polygon address.");
                return;
            }
            const walletLC = wallet.toLowerCase();
            if (walletSet.has(walletLC)) {
                showError("This wallet is already registered.");
                return;
            }
            userWallet = wallet;

            showStep(step2); 
            fakeVerifyDiv.textContent = "🔔 Verifying wallet entry...";
            fakeVerifyDiv.style.display = 'block';
            statusDiv.innerHTML = '';
            setTimeout(() => {
              fakeVerifyDiv.textContent = "✅ Wallet entry verified!";
              setTimeout(async () => {
                try {
                    await push(ref(db, 'nftfan_airdrop_chat'), {
                        wallet: wallet,
                        xHandle: userXHandle,
                        avatar: "",
                        time: Date.now(),
                        status: "pending"
                    });

                    showStep(step4);
                    document.querySelector('.title').classList.add('hidden');
                } catch (err) {
                    showError("Submission failed. Please try again.");
                    showStep(step3);
                }
              }, 900);
            }, 850);
        });

        backBtn2.addEventListener('click', () => {
          clearError();
          fakeVerifyDiv.style.display = 'none';
          xHandleInput.focus();
          showStep(step1);
        });

        backBtn3.addEventListener('click', () => {
          clearError();
          walletInput.focus();
          showStep(step2);
          fakeVerifyDiv.style.display = 'none';
          statusDiv.textContent = '';
        });

        addrCopyBtn.addEventListener('click', function() {
          const addr = document.getElementById('airdropAddr').textContent;
          navigator.clipboard.writeText(addr);
          addrCopyBtn.classList.add('copied');
          setTimeout(() => {
            addrCopyBtn.classList.remove('copied');
          }, 1300);
        });

        // Previous step value display logic
        function updatePrevSteps() {
          prevStep2.innerHTML = '';
          prevStep3.innerHTML = '';
          // Step 2: show entered xHandle above
          if (!step2.classList.contains('hidden')) {
            if (userXHandle) {
              prevStep2.innerHTML = `
                <div class="entered-data">
                  <span class="entered-label">X Username:</span>
                  <span>${userXHandle}</span>
                </div>
              `;
            }
          }
          // Step 3: show xHandle above, wallet as it's typed
          if (!step3.classList.contains('hidden')) {
            let walletVal = walletInput.value || userWallet || '';
            let html = '';
            if (userXHandle) {
              html += `
                <div class="entered-data">
                  <span class="entered-label">X Username:</span>
                  <span>${userXHandle}</span>
                </div>
              `;
            }
            if (walletVal) {
              html += `
                <div class="entered-data">
                  <span class="entered-label">Wallet:</span>
                  <span>${walletVal}</span>
                </div>
              `;
            }
            prevStep3.innerHTML = html;
          }
        }

        walletInput.addEventListener('input', updatePrevSteps);

        // Initial state for nextBelow
        showNextBelow(true);
    });
  </script>
</head>
<body>
  <div class="top-wrap">
    <div class="card">
      <div class="title">NFT FANS Airdrop</div>
      <div id="errorMsg" class="message"></div>
      <!-- Step Stack: keeps previous visible -->
      <div class="step-stack">
        <!-- Step 1: Ask for X Handle -->
        <div id="step1" class="form-step">
          <label for="xHandle">X (Twitter) Username</label>
          <input type="text" id="xHandle" name="xHandle" placeholder="@yourhandle" maxlength="16" autocomplete="off" required>
          <button id="nextBtn" style="display:none;">Next</button>
          <div id="nextBelowWrap" class="next-below-wrap">
            <button id="nextBelowBtn" class="next-animate">Next</button>
          </div>
        </div>
        <!-- Step 2: Keep previous visible above -->
        <div id="prevStep2"></div>
        <div id="step2" class="form-step hidden">
          <div id="statusMsg" class="status"></div>
          <div id="fakeVerify" class="fake-verify"></div>
          <button id="backBtn2" class="back-btn">← Previous</button>
        </div>
        <!-- Step 3: Keep previous visible above -->
        <div id="prevStep3"></div>
        <div id="step3" class="form-step hidden">
          <label for="wallet">Polygon Wallet Address</label>
          <input type="text" id="wallet" name="wallet" placeholder="0x..." maxlength="42" autocomplete="off" required>
          <button id="submitBtn">Submit</button>
          <button id="backBtn3" class="back-btn">← Previous</button>
        </div>
      </div>
      <!-- Step 4: Success and Instructions -->
      <div id="step4" class="form-step hidden">
        <div class="success">🎉 Congratulations! You are registered.</div>
        <div class="instructions">
          <b>How to view tokens?</b><br>
          After the airdrop, add the following contract address to your Polygon wallet to see your <b>$NFTFAN</b> tokens:<br><br>
          <div class="airdrop-address-row">
            <span id="airdropAddr">0x2017fcaea540d2925430586dc92818035bfc2f50</span>
            <button class="copy-btn" id="copyAddrBtn">
              Copy
              <span class="copied-tooltip" id="copiedTooltip">Copied!</span>
            </button>
          </div>
          <div style="margin-top:7px;">
            <b>Mobile Instructions:</b><br>
            1. Open your wallet app switch to polygon matic network.<br>
            2. Go to "Tokens" or "Import Token" section.<br>
            3. Paste the contract above.<br>
            4. Confirm to see your $NFTFAN balance.<br>
            <span style="color:var(--muted);">If you don't see the token, make sure your wallet is updated and supports custom tokens on Polygon.</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
