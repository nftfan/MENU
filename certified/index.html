<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFANS CERTIFICATION – GAMIFIED</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" href="https://i.imgur.com/ODP45iQ.png" type="image/png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --background:#181B22;
      --card-bg:#222630;
      --input-bg:#232733;
      --accent:#86A8E7;
      --accent2:#91EAE4;
      --text:#F3F6FB;
      --muted:#A2A9B7;
      --radius:10px;
      --rainbow-red:#FF5757;
      --rainbow-orange:#FFBD59;
      --rainbow-yellow:#FFEE59;
      --rainbow-green:#59FF8E;
      --rainbow-blue:#59BFFF;
      --rainbow-indigo:#7C59FF;
      --rainbow-violet:#C159FF;
      --rainbow-gradient:linear-gradient(90deg,var(--rainbow-red),var(--rainbow-orange),var(--rainbow-yellow),var(--rainbow-green),var(--rainbow-blue),var(--rainbow-indigo),var(--rainbow-violet));
      --shadow:0 4px 18px -4px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{background:linear-gradient(135deg,#181B22 0%,#262B36 100%);font-family:'Segoe UI','Roboto',Arial,sans-serif;color:var(--text);font-size:10px;min-height:100vh}
    body{display:flex;flex-direction:column;align-items:center;padding:0.8rem 0.5rem;gap:0.8rem}

    h1{font-size:11px;font-weight:800;letter-spacing:.08em;display:flex;align-items:center;gap:.4rem;margin:.2rem 0 .8rem;background:var(--rainbow-gradient);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:rainbow-text 2.8s linear infinite}
    @keyframes rainbow-text{0%{background-position:0% 50%}100%{background-position:200% 50%}}

    .panel{
      background:var(--card-bg);
      border-radius:var(--radius);
      padding:.9rem .85rem 1.1rem;
      width:100%;
      max-width:370px;
      position:relative;
      overflow:hidden;
      box-shadow:0 0 18px -4px rgba(145,234,228,.28);
    }
    .panel::before{
      content:"";
      position:absolute;
      top:0;left:0;right:0;height:2px;
      background:var(--rainbow-gradient);
      animation:rainbow-bar 3s linear infinite;
    }
    @keyframes rainbow-bar{0%{background-position:0 50%}100%{background-position:200% 50%}}

    .logo{width:26px;height:26px;display:block;margin:0 auto .2rem;border-radius:50%;animation:logo-spin 8s linear infinite}
    @keyframes logo-spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .certification-form{display:flex;flex-direction:column;gap:.55rem;margin-bottom:.4rem}
    .input-row{display:flex;gap:.5rem}
    input[type=text]{
      flex:1;
      background:var(--input-bg);
      border:1px solid rgba(255,255,255,0.07);
      border-radius:7px;
      padding:.55rem .65rem;
      font-size:9px;
      color:var(--text);
      outline:none;
      transition:.25s;
      animation:border-rainbow 4s linear infinite;
    }
    input[type=text]:focus{background:#262b3a;animation:border-rainbow 1.3s linear infinite}
    @keyframes border-rainbow{
      0%{border-color:var(--rainbow-red)}
      16%{border-color:var(--rainbow-orange)}
      32%{border-color:var(--rainbow-yellow)}
      48%{border-color:var(--rainbow-green)}
      64%{border-color:var(--rainbow-blue)}
      80%{border-color:var(--rainbow-indigo)}
      100%{border-color:var(--rainbow-red)}
    }
    button{
      background:var(--rainbow-gradient);
      background-size:200% 200%;
      color:#fff;
      border:none;
      border-radius:7px;
      padding:.55rem .65rem;
      font-weight:700;
      font-size:9px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:.35rem;
      cursor:pointer;
      box-shadow:0 4px 12px -4px rgba(0,0,0,.5);
      letter-spacing:.05em;
      animation:button-rainbow 3s linear infinite;
      transition:.25s;
    }
    button:hover{transform:translateY(-2px);box-shadow:0 6px 16px -6px rgba(0,0,0,.65)}
    button:active{transform:translateY(0)}
    @keyframes button-rainbow{0%{background-position:0% 50%}100%{background-position:200% 50%}}

    .material-icons{font-size:10px}

    #result{font-size:8px;min-height:1.2rem;padding:.4rem .5rem;border-radius:6px;margin-top:.1rem;transition:.3s;line-height:1.3}
    .error{background:rgba(255,87,87,.08);color:var(--rainbow-red)}
    .success{background:rgba(89,255,142,.08);color:var(--rainbow-green)}
    .loading{background:rgba(145,234,228,.08);color:var(--accent2)}

    .user-info{display:flex;justify-content:space-between;align-items:center;font-size:7px;color:var(--muted);margin-top:.45rem;background:rgba(145,234,228,.05);padding:.35rem .55rem;border-radius:6px}

    /* GAMIFIED AREA */
    .gamified-area{display:flex;flex-direction:column;gap:.9rem;margin-top:.4rem}

    .status-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      flex-wrap:wrap;
    }
    .wallet-chip{
      background:rgba(145,234,228,.08);
      padding:.4rem .65rem;
      font-size:7.5px;
      border-radius:100px;
      display:flex;
      align-items:center;
      gap:.3rem;
      letter-spacing:.03em;
      position:relative;
      overflow:hidden;
    }
    .wallet-chip::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,transparent 0%,rgba(255,255,255,.04) 40%,transparent 80%);
      animation:shine 5s linear infinite;
    }
    @keyframes shine{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

    .balance-display{
      font-size:11px;
      font-weight:800;
      letter-spacing:.04em;
      display:flex;
      align-items:baseline;
      gap:.25rem;
      background:var(--rainbow-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 3.2s linear infinite;
    }
    .balance-display small{font-size:7px;font-weight:500;-webkit-text-fill-color:var(--text);background:none}

    .motivation-box{
      background:linear-gradient(145deg,#262d39 0%,#1e222b 100%);
      border:1px solid rgba(255,255,255,0.04);
      padding:.6rem .7rem;
      border-radius:10px;
      font-size:7.5px;
      line-height:1.45;
      position:relative;
      overflow:hidden;
    }
    .motivation-box h3{
      font-size:8px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:.3rem;
      margin-bottom:.35rem;
      letter-spacing:.05em;
      background:var(--rainbow-gradient);
      background-size:200% auto;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 3s linear infinite;
    }
    .motivation-rotator{min-height:1.5em;display:flex;align-items:center;font-weight:500;color:var(--accent2)}

    /* LEVEL LADDER */
    .level-ladder{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(85px,1fr));
      gap:.55rem;
    }
    .level-card{
      position:relative;
      background:#262d39;
      border:1px solid rgba(255,255,255,0.05);
      border-radius:9px;
      padding:.5rem .45rem .6rem;
      display:flex;
      flex-direction:column;
      gap:.25rem;
      align-items:center;
      justify-content:flex-start;
      overflow:hidden;
      min-height:78px;
    }
    .level-card.unlocked{
      border:1px solid transparent;
      animation:card-border 5s linear infinite;
    }
    @keyframes card-border{
      0%{border-color:var(--rainbow-red)}
      20%{border-color:var(--rainbow-yellow)}
      40%{border-color:var(--rainbow-green)}
      60%{border-color:var(--rainbow-blue)}
      80%{border-color:var(--rainbow-indigo)}
      100%{border-color:var(--rainbow-red)}
    }
    .level-card.locked{
      filter:grayscale(0.9) brightness(0.65);
    }
    .level-icon{
      font-size:18px !important;
      text-shadow:0 0 6px rgba(255,255,255,0.15);
      animation:icon-pulse 2.4s ease-in-out infinite;
    }
    @keyframes icon-pulse{0%{transform:scale(.9)}50%{transform:scale(1.08)}100%{transform:scale(.9)}}
    .level-name{
      font-size:7px;
      font-weight:700;
      letter-spacing:.05em;
    }
    .level-req{
      font-size:6.2px;
      color:var(--muted);
      letter-spacing:.04em;
      text-align:center;
    }
    .level-badge-tag{
      position:absolute;
      top:4px;
      right:4px;
      font-size:6px;
      background:var(--rainbow-gradient);
      padding:.15rem .35rem;
      border-radius:20px;
      font-weight:700;
      letter-spacing:.05em;
      background-size:200% auto;
      animation:rainbow-text 2.6s linear infinite;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      pointer-events:none;
    }
    .progress-ring-wrapper{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      opacity:.55;
    }
    .ring{
      width:74px;height:74px;
      border-radius:50%;
      background:
        conic-gradient(var(--rainbow-red) 0deg,var(--rainbow-orange) 60deg,var(--rainbow-yellow) 120deg,var(--rainbow-green) 180deg,var(--rainbow-blue) 240deg,var(--rainbow-indigo)300deg,var(--rainbow-violet)360deg);
      mask:radial-gradient(circle at center,transparent 50%, #000 51%);
      animation:spin 10s linear infinite;
      filter:blur(2px) brightness(.9);
    }
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    /* CURRENT LEVEL PANEL */
    .current-level-panel{
      background:linear-gradient(155deg,#262f3c 0%,#1d2229 100%);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      padding:.75rem .8rem;
      display:flex;
      flex-direction:column;
      gap:.55rem;
      position:relative;
      overflow:hidden;
    }
    .current-level-panel::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 30% 20%,rgba(145,234,228,.08),transparent 70%);
      pointer-events:none;
    }
    .current-level-heading{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.5rem;
    }
    .current-level-heading h2{
      font-size:8.5px;
      font-weight:800;
      letter-spacing:.08em;
      background:var(--rainbow-gradient);
      background-size:200% auto;
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 2.7s linear infinite;
    }
    .next-target{
      font-size:6.5px;
      color:var(--muted);
      letter-spacing:.04em;
      display:flex;
      gap:.3rem;
      align-items:center;
    }
    .radial-progress{
      width:120px;height:120px;
      position:relative;
      margin:.2rem auto .4rem;
    }
    .radial-progress canvas{position:absolute;top:0;left:0}
    .radial-center{
      position:absolute;
      inset:12px;
      border-radius:50%;
      background:#222a33;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:.25rem;
      padding:.3rem;
      text-align:center;
    }
    .radial-center .big{
      font-size:15px;
      font-weight:800;
      letter-spacing:.05em;
      background:var(--rainbow-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 4s linear infinite;
    }
    .radial-center small{
      font-size:6.5px;
      color:var(--muted);
      line-height:1.2;
    }

    .bar-progress{
      height:6px;
      background:rgba(255,255,255,0.08);
      border-radius:4px;
      overflow:hidden;
      position:relative;
    }
    .bar-progress span{
      display:block;
      height:100%;
      width:0;
      background:var(--rainbow-gradient);
      background-size:200% auto;
      animation:button-rainbow 3.5s linear infinite;
      transition:width 1s ease;
    }
    .progress-caption{
      display:flex;
      justify-content:space-between;
      font-size:6.7px;
      margin-top:.25rem;
      letter-spacing:.04em;
      color:var(--muted);
    }

    /* QUESTS */
    .quests{
      background:linear-gradient(160deg,#262f3a 0%,#1e232b 100%);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:12px;
      padding:.7rem .75rem .85rem;
      display:flex;
      flex-direction:column;
      gap:.55rem;
      position:relative;
    }
    .quests h3{
      font-size:8px;
      display:flex;
      align-items:center;
      gap:.35rem;
      font-weight:800;
      letter-spacing:.08em;
      background:var(--rainbow-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 3s linear infinite;
    }
    .quest-list{display:flex;flex-direction:column;gap:.45rem}
    .quest{
      background:#27323e;
      padding:.55rem .6rem;
      border-radius:9px;
      display:flex;
      gap:.55rem;
      align-items:flex-start;
      font-size:6.9px;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,0.04);
    }
    .quest.complete{
      border-color:var(--rainbow-green);
      box-shadow:0 0 0 1px rgba(89,255,142,.3);
    }
    .quest::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg,transparent,rgba(255,255,255,.04),transparent);
      opacity:0;
      animation:quest-shine 6s linear infinite;
    }
    @keyframes quest-shine{0%{opacity:0;transform:translateX(-100%)}45%{opacity:0}50%{opacity:.7}60%{opacity:0;transform:translateX(100%)}100%{opacity:0}}
    .quest-icon{font-size:14px !important;margin-top:-1px}
    .quest-content{flex:1;display:flex;flex-direction:column;gap:.3rem}
    .quest-title{font-weight:700;letter-spacing:.05em;font-size:7px}
    .quest-desc{color:var(--muted);line-height:1.3}
    .quest-reward{font-size:6px;color:var(--accent2);display:flex;align-items:center;gap:.25rem;font-weight:600}
    .quest button{
      font-size:6.5px;
      padding:.35rem .55rem;
      font-weight:700;
      letter-spacing:.06em;
      min-width:60px;
    }
    .quest button.small-done{
      background:linear-gradient(90deg,#2f3b48,#2f3b48);
      color:var(--rainbow-green);
      cursor:default;
      animation:none;
      box-shadow:none;
    }

    /* ACHIEVEMENTS */
    .achievements{
      background:linear-gradient(160deg,#262f3a 0%,#1d2229 100%);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:12px;
      padding:.7rem .75rem .9rem;
      display:flex;
      flex-direction:column;
      gap:.55rem;
    }
    .achievements h3{
      font-size:8px;
      font-weight:800;
      display:flex;
      align-items:center;
      gap:.35rem;
      letter-spacing:.08em;
      background:var(--rainbow-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 3s linear infinite;
    }
    .achievements-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(88px,1fr));
      gap:.55rem;
    }
    .achievement{
      background:#27323e;
      border:1px solid rgba(255,255,255,0.05);
      border-radius:9px;
      padding:.45rem .4rem .55rem;
      display:flex;
      flex-direction:column;
      gap:.25rem;
      align-items:center;
      justify-content:center;
      min-height:70px;
      position:relative;
      overflow:hidden;
    }
    .achievement.unlocked{
      border-color:var(--rainbow-green);
      box-shadow:0 0 0 1px rgba(89,255,142,.3),0 0 16px -4px rgba(89,255,142,.35);
    }
    .achievement.locked{filter:grayscale(.85) brightness(.65)}
    .achievement-icon{font-size:18px !important;animation:icon-pulse 2.8s ease-in-out infinite}
    .achievement-title{font-size:6.5px;font-weight:700;text-align:center;letter-spacing:.05em}
    .achievement-desc{font-size:5.5px;color:var(--muted);text-align:center;line-height:1.25}

    /* CTA */
    .buy-cta{
      background:linear-gradient(160deg,#283646 0%,#1c232b 100%);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      padding:.85rem .85rem 1rem;
      display:flex;
      flex-direction:column;
      gap:.6rem;
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .buy-cta::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 70% 20%,rgba(255,255,255,.06),transparent 75%);
      pointer-events:none;
    }
    .buy-cta h3{
      font-size:9px;
      font-weight:800;
      letter-spacing:.08em;
      background:var(--rainbow-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      animation:rainbow-text 3s linear infinite;
    }
    .buy-cta p{
      font-size:6.8px;
      color:var(--muted);
      line-height:1.4;
    }
    .levels-inline{
      display:flex;
      gap:.4rem;
      flex-wrap:wrap;
      justify-content:center;
      margin-top:.2rem;
    }
    .inline-pill{
      font-size:6px;
      padding:.25rem .5rem;
      border-radius:50px;
      background:rgba(255,255,255,0.06);
      display:flex;
      gap:.3rem;
      align-items:center;
      letter-spacing:.04em;
    }

    .cta-buttons{
      display:flex;
      flex-direction:column;
      gap:.55rem;
      margin-top:.2rem;
    }
    .cta-buttons a{text-decoration:none}
    .btn-outline{
      background:#242d38;
      animation:none;
      background-image:none;
      border:1px solid rgba(255,255,255,0.09);
      font-weight:600;
    }
    .btn-outline:hover{
      background:#2d3947;
    }

    /* PARTICLES */
    .particles{
      position:absolute;
      top:0;left:0;
      width:100%;height:100%;
      overflow:hidden;
      z-index:0;
      pointer-events:none;
      opacity:.35;
    }
    .particle{
      position:absolute;
      width:3px;height:3px;
      border-radius:50%;
      animation:particle-float 8s linear infinite;
      opacity:0;
    }
    @keyframes particle-float{
      0%{transform:translateY(100px);opacity:0}
      10%{opacity:.7}
      90%{opacity:.6}
      100%{transform:translateY(-60px);opacity:0}
    }

    /* UTIL */
    .hidden{display:none !important}
    .fade-in{animation:fadeIn .6s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  </style>
</head>
<body>

  <div class="panel">
    <img class="logo" src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Logo" />
    <h1><span>NFTFANS CERTIFICATION</span><span class="material-icons">verified</span></h1>

    <div class="certification-form">
      <div class="input-row">
        <input type="text" id="wallet" placeholder="Enter your wallet (0x...)" maxlength="42" autocomplete="off" inputmode="text"/>
        <button type="button" id="certify-btn" onclick="certifyWallet()">
          <span class="material-icons">bolt</span>
          <span>SCAN</span>
        </button>
      </div>
    </div>
    <div id="result"></div>
    <div class="user-info">
      <span><span class="material-icons">person</span> NFTFANS</span>
      <span><span class="material-icons">schedule</span> <span id="time-stamp"></span></span>
    </div>
  </div>

  <!-- GAMIFIED EXPERIENCE -->
  <div id="game-wrapper" class="panel gamified-area hidden">
    <div class="particles" id="particles"></div>

    <!-- STATUS HEADER -->
    <div class="status-header">
      <div class="wallet-chip" id="wallet-display">
        <span class="material-icons" style="font-size:11px;">account_balance_wallet</span>
        <span>—</span>
      </div>
      <div class="balance-display" id="balance-display">
        0 <small>KT</small>
      </div>
    </div>

    <!-- MOTIVATION -->
    <div class="motivation-box">
      <h3><span class="material-icons" style="font-size:11px;">rocket_launch</span> PROGRESSION FEED</h3>
      <div class="motivation-rotator" id="motivation-rotator">Hold KT to unlock epic tiers...</div>
    </div>

    <!-- CURRENT LEVEL -->
    <div class="current-level-panel">
      <div class="current-level-heading">
        <h2 id="current-level-title">CURRENT: BASIC</h2>
        <div class="next-target" id="next-target">
          <span class="material-icons" style="font-size:9px;">trending_up</span>
          <span>Next: ACTIVE (0.001 KT)</span>
        </div>
      </div>

      <div class="radial-progress">
        <canvas id="radial-bg" width="120" height="120"></canvas>
        <canvas id="radial-fg" width="120" height="120"></canvas>
        <div class="radial-center">
          <div class="big" id="radial-percent">0%</div>
          <small id="radial-small">TO NEXT LEVEL</small>
        </div>
      </div>

      <div class="bar-progress">
        <span id="bar-progress-fill"></span>
      </div>
      <div class="progress-caption">
        <span id="progress-from">0</span>
        <span id="progress-to">Goal</span>
      </div>
    </div>

    <!-- LEVEL LADDER -->
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.45rem;">
        <h2 style="font-size:8px;font-weight:800;letter-spacing:.07em;background:var(--rainbow-gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:rainbow-text 3s linear infinite;display:flex;align-items:center;gap:.35rem;">
          <span class="material-icons" style="font-size:11px;">military_tech</span>
          LEVEL LADDER
        </h2>
        <span style="font-size:6.5px;color:var(--muted);letter-spacing:.04em;">Collect more KT to ascend</span>
      </div>
      <div class="level-ladder" id="level-ladder"></div>
    </div>

    <!-- QUESTS / SIMULATED ENGAGEMENT -->
    <div class="quests">
      <h3><span class="material-icons" style="font-size:11px;">task_alt</span> DAILY / SOCIAL QUESTS</h3>
      <div class="quest-list" id="quest-list">
        <!-- Dynamically filled -->
      </div>
      <div style="font-size:6.3px;color:var(--muted);text-align:center;margin-top:.2rem;">
        Quests give XP (visual boosts) – Real certification still depends on your actual KT balance.
      </div>
    </div>

    <!-- ACHIEVEMENTS -->
    <div class="achievements">
      <h3><span class="material-icons" style="font-size:11px;">emoji_events</span> ACHIEVEMENTS</h3>
      <div class="achievements-grid" id="achievements-grid"></div>
    </div>

    <!-- BUY CTA -->
    <div class="buy-cta">
      <h3>BOOST YOUR TIER</h3>
      <p>
        Each higher tier unlocks brighter visuals, animated effects, prestige icons and social flex.
        Accumulate KT to climb from Basic all the way to DIAMOND.
      </p>
      <div class="levels-inline" id="inline-levels"></div>
      <div class="cta-buttons">
        <a href="http://nftfanstoken.com/topup" target="_blank">
          <button>
            <span class="material-icons" style="font-size:11px;">add_circle</span>
            BUY MORE KT NOW
          </button>
        </a>
        <button class="btn-outline" onclick="shareProgress()">
          <span class="material-icons" style="font-size:11px;">ios_share</span>
          SHARE PROGRESS
        </button>
      </div>
    </div>
  </div>

  <!-- Firebase & Script -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    /* ---------------- CONFIG & CONSTANTS (v2-style) ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain: "nftfanactive.firebaseapp.com",
      databaseURL: "https://nftfanactive-default-rtdb.firebaseio.com",
      projectId: "nftfanactive",
      storageBucket: "nftfanactive.appspot.com",
      messagingSenderId: "311309982791",
      appId: "1:311309982791:web:3e55bba6b78feb57ea6562",
      measurementId: "G-3TRDL9749N"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Etherscan v2 config (Polygon mainnet)
    const ES_API_KEY  = "Z7UUSFGES3UDZ8RMWVAWF9HA59IAJA83XJ";
    const ES_CHAIN_ID = 137;
    const ES_BASE     = "https://api.etherscan.io/v2/api";

    const TOKEN_CA        = "0x2017Fcaea540d2925430586DC92818035Bfc2F50"; // NFTFAN/KT token
    const TOKEN_DECIMALS  = 18;
    // 1 KT = 1000 trillion tokens.
    // 1 token = 1e18 base units → 1e3 * 1e12 * 1e18 = 1e33 base units.
    const KT_UNIT         = 1_000_000_000_000_000_000_000_000_000_000_000n; // 1e33
    const BASE_UNIT       = 10n ** BigInt(TOKEN_DECIMALS);                  // 1e18

    const LEVELS_ORDERED = [
      { key:'BASIC',    min:0,       icon:'person',              name:'Basic',    next:'ACTIVE'   },
      { key:'ACTIVE',   min:0.001,   icon:'bolt',                name:'Active',   next:'SUPER'    },
      { key:'SUPER',    min:0.5,     icon:'moving',              name:'Super',    next:'BRONZE'   },
      { key:'BRONZE',   min:1,       icon:'workspace_premium',   name:'Bronze',   next:'SILVER'   },
      { key:'SILVER',   min:5,       icon:'star',                name:'Silver',   next:'GOLD'     },
      { key:'GOLD',     min:10,      icon:'stars',               name:'Gold',     next:'PLATINUM' },
      { key:'PLATINUM', min:50,      icon:'auto_awesome',        name:'Platinum', next:'DIAMOND'  },
      { key:'DIAMOND',  min:100,     icon:'diamond',             name:'Diamond',  next:null       }
    ];
    const LEVEL_MAP = Object.fromEntries(LEVELS_ORDERED.map(l=>[l.key,l]));

    const MOTIVATION_LINES = [
      "Reach Silver to unlock upgraded glow & animated ladder highlights.",
      "Gold tier radiates prestige – 10 KT gets you there.",
      "Platinum adds cosmic pulses. Hold 50 KT to shine brighter.",
      "Diamond unlocks full celestial particle storms.",
      "Tiny balance? Even 0.001 KT activates your first glow. Start climbing!",
      "Every KT pushes you closer to your next transformation.",
      "Flex your certification badge visually – stack KT, level up.",
      "Higher tiers = more animation layers & aura energy."
    ];

    const ACHIEVEMENTS = [
      { id:'first_hold',    min:0.001, title:'First Spark',     icon:'flare',             desc:'Hold ≥ 0.001 KT', },
      { id:'super_holder',  min:0.5,   title:'Rising Current',  icon:'bolt',              desc:'Reach Super tier (0.5 KT)', },
      { id:'bronze_step',   min:1,     title:'Bronze Claimed',  icon:'workspace_premium', desc:'Reach Bronze (1 KT)', },
      { id:'silver_edge',   min:5,     title:'Silver Edge',     icon:'star',              desc:'Hold 5 KT', },
      { id:'golden_core',   min:10,    title:'Golden Core',     icon:'stars',             desc:'Hold 10 KT', },
      { id:'platinum_wave', min:50,    title:'Platinum Wave',   icon:'auto_awesome',      desc:'Hold 50 KT', },
      { id:'diamond_sky',   min:100,   title:'Diamond Sky',     icon:'diamond',           desc:'Hold 100 KT', }
    ];

    let QUESTS = [
      { id:'q1', title:'Check Wallet',     desc:'Scan any valid wallet address.', icon:'search',   reward:20, done:false, auto:true },
      { id:'q2', title:'Social Share',     desc:'Share your level with friends.', icon:'share',    reward:35, done:false },
      { id:'q3', title:'Come Back Later',  desc:'Return after 6 hours (session-based demo).', icon:'schedule', reward:50, done:false },
      { id:'q4', title:'Scan Again',       desc:'Rescan wallet (encourages balance refresh).', icon:'refresh', reward:15, done:false }
    ];

    let currentWalletState = {
      address: null,
      balanceRawBase: 0n,
      balanceKT: 0,
      level: LEVEL_MAP.BASIC,
      xp: 0
    };

    function commas(n){
      return (String(n||"0")).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    async function fetchJson(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }

    function toHuman(raw, decimals){
      try{
        const d   = Number(decimals || TOKEN_DECIMALS);
        const big = BigInt(raw || "0");
        if (d <= 0) return big.toString();
        const factor = 10n ** BigInt(d);
        return (big / factor).toString();
      }catch{
        return "0";
      }
    }

    async function getTokenBalanceRaw(holder){
      const url = `${ES_BASE}?chainid=${ES_CHAIN_ID}&module=account&action=tokenbalance&contractaddress=${TOKEN_CA}&address=${holder}&tag=latest&apikey=${ES_API_KEY}`;
      const res = await fetchJson(url);
      if (res.status !== "1") throw new Error(res.result || res.message || "Unable to fetch balance");
      return BigInt(res.result);
    }

    function formatKTFromBase(rawBase){
      // 1 KT = 1e33 base units
      const kt = Number(rawBase) / Number(KT_UNIT);
      if (kt >= 1000) return kt.toLocaleString(undefined,{maximumFractionDigits:1});
      if (kt >= 100)  return kt.toLocaleString(undefined,{maximumFractionDigits:2});
      if (kt >= 10)   return kt.toLocaleString(undefined,{maximumFractionDigits:3});
      if (kt >= 1)    return kt.toLocaleString(undefined,{maximumFractionDigits:4});
      return kt.toLocaleString(undefined,{maximumSignificantDigits:3});
    }

    function shortAddress(addr){ return addr ? addr.slice(0,6)+"..."+addr.slice(-4) : ""; }
    function validateEthAddress(a){ return /^0x[a-fA-F0-9]{40}$/.test(a); }

    function getLevel(balanceKT){
      for (let i = LEVELS_ORDERED.length - 1; i >= 0; i--){
        if (balanceKT >= LEVELS_ORDERED[i].min) return LEVELS_ORDERED[i];
      }
      return LEVEL_MAP.BASIC;
    }

    function getNext(level){
      if (!level.next) return null;
      return LEVEL_MAP[level.next];
    }

    function generateParticles(){
      const colors = ['var(--rainbow-red)','var(--rainbow-orange)','var(--rainbow-yellow)','var(--rainbow-green)','var(--rainbow-blue)','var(--rainbow-indigo)','var(--rainbow-violet)'];
      const cont = document.getElementById('particles');
      if (!cont) return;
      cont.innerHTML = '';
      const count = 36;
      for (let i=0;i<count;i++){
        const d = document.createElement('div');
        d.className='particle';
        d.style.left = (Math.random()*100)+'%';
        d.style.animationDelay = (Math.random()*7)+'s';
        d.style.animationDuration = (6+Math.random()*6)+'s';
        d.style.background = colors[Math.floor(Math.random()*colors.length)];
        cont.appendChild(d);
      }
    }

    let motIndex = 0;
    function rotateMotivation(){
      const el = document.getElementById('motivation-rotator');
      if (!el) return;
      motIndex = (motIndex+1)%MOTIVATION_LINES.length;
      el.style.opacity=0;
      setTimeout(()=>{
        el.textContent = MOTIVATION_LINES[motIndex];
        el.style.opacity=1;
      },260);
    }
    setInterval(()=>{
      const wrap = document.getElementById('game-wrapper');
      if (wrap && !wrap.classList.contains('hidden')) rotateMotivation();
    },5000);

    function drawRadial(progress){
      const bgCanvas = document.getElementById('radial-bg');
      const fgCanvas = document.getElementById('radial-fg');
      if (!bgCanvas || !fgCanvas) return;
      const bg = bgCanvas.getContext('2d');
      const fg = fgCanvas.getContext('2d');
      const size = 120;
      bg.clearRect(0,0,size,size);
      fg.clearRect(0,0,size,size);

      bg.lineWidth=10;
      bg.strokeStyle='rgba(255,255,255,0.07)';
      bg.beginPath();
      bg.arc(size/2,size/2, size/2-10, 0, Math.PI*2);
      bg.stroke();

      const grad = fg.createLinearGradient(0,0,size,0);
      grad.addColorStop(0,'#FF5757');
      grad.addColorStop(0.2,'#FFBD59');
      grad.addColorStop(0.42,'#59FF8E');
      grad.addColorStop(0.65,'#59BFFF');
      grad.addColorStop(0.82,'#7C59FF');
      grad.addColorStop(1,'#C159FF');

      fg.lineWidth=10;
      fg.strokeStyle=grad;
      fg.lineCap='round';
      fg.beginPath();
      const startAngle = -Math.PI/2;
      const endAngle = startAngle + (Math.PI*2 * Math.min(progress,1));
      fg.arc(size/2,size/2, size/2-10, startAngle, endAngle);
      fg.stroke();
    }

    function buildLevelLadder(){
      const ladder = document.getElementById('level-ladder');
      ladder.innerHTML='';
      const balKT = currentWalletState.balanceKT;
      LEVELS_ORDERED.forEach(l=>{
        const unlocked = balKT >= l.min;
        const card = document.createElement('div');
        card.className='level-card '+(unlocked?'unlocked':'locked')+' fade-in';
        if (unlocked){
          const ringWrap=document.createElement('div');
          ringWrap.className='progress-ring-wrapper';
          const ring=document.createElement('div');
          ring.className='ring';
          ringWrap.appendChild(ring);
          card.appendChild(ringWrap);
          const tag=document.createElement('div');
          tag.className='level-badge-tag';
          tag.textContent='UNLOCKED';
          card.appendChild(tag);
        }
        const icon=document.createElement('span');
        icon.className='material-icons level-icon';
        icon.textContent=l.icon;
        const name=document.createElement('div');
        name.className='level-name';
        name.textContent=l.name.toUpperCase();
        const req=document.createElement('div');
        req.className='level-req';
        req.textContent=l.min+' KT';
        card.appendChild(icon);
        card.appendChild(name);
        card.appendChild(req);
        ladder.appendChild(card);
      });
    }

    function buildInlineLevels(){
      const wrap=document.getElementById('inline-levels');
      wrap.innerHTML='';
      LEVELS_ORDERED.slice(1).forEach(l=>{
        const pill=document.createElement('div');
        pill.className='inline-pill';
        pill.innerHTML = `<span class="material-icons" style="font-size:9px;">${l.icon}</span><span>${l.name}</span>`;
        wrap.appendChild(pill);
      });
    }

    function buildAchievements(){
      const grid=document.getElementById('achievements-grid');
      grid.innerHTML='';
      const balKT = currentWalletState.balanceKT;
      ACHIEVEMENTS.forEach(a=>{
        const unlocked = balKT >= a.min;
        const item=document.createElement('div');
        item.className='achievement '+(unlocked?'unlocked':'locked')+' fade-in';
        item.innerHTML = `
          <span class="material-icons achievement-icon">${a.icon}</span>
          <div class="achievement-title">${a.title}</div>
          <div class="achievement-desc">${a.desc}</div>
        `;
        grid.appendChild(item);
      });
    }

    function buildQuests(){
      const list=document.getElementById('quest-list');
      list.innerHTML='';
      QUESTS.forEach(q=>{
        const div=document.createElement('div');
        div.className='quest '+(q.done?'complete':'');
        div.innerHTML=`
          <span class="material-icons quest-icon">${q.icon}</span>
          <div class="quest-content">
            <div class="quest-title">${q.title}</div>
            <div class="quest-desc">${q.desc}</div>
            <div class="quest-reward"><span class="material-icons" style="font-size:8px;">bolt</span>${q.reward} XP</div>
          </div>
        `;
        const btn=document.createElement('button');
        if (q.done){
          btn.textContent='DONE';
          btn.className='small-done';
        } else {
          btn.textContent='CLAIM';
          btn.onclick=()=>{
            q.done=true;
            currentWalletState.xp += q.reward;
            buildQuests();
            flashMotivation("Quest completed! Visual XP +" + q.reward);
          };
        }
        div.appendChild(btn);
        list.appendChild(div);
      });
    }

    function flashMotivation(msg){
      const rot=document.getElementById('motivation-rotator');
      const prev = rot.textContent;
      rot.textContent=msg;
      rot.style.color='var(--rainbow-green)';
      setTimeout(()=>{
        rot.style.color='var(--accent2)';
        rot.textContent=prev;
      },2800);
    }

    function shareProgress(){
      if (!currentWalletState.address){
        flashMotivation("Scan a wallet first!");
        return;
      }
      const text = `I am ${currentWalletState.level.name} on NFTFANS — holding ${formatKTFromBase(currentWalletState.balanceRawBase)} KT. Climbing to ${getNext(currentWalletState.level)?.name || 'MAX'}! #NFTFANS`;
      if (navigator.share){
        navigator.share({title:"My NFTFANS Certification", text});
      } else if (navigator.clipboard) {
        navigator.clipboard.writeText(text);
        flashMotivation("Progress copied! Share it now.");
      } else {
        flashMotivation("Share not supported – copy manually.");
      }
    }

    function progressColor(p){
      if (p<0.2) return 'rgba(255,87,87,0.35)';
      if (p<0.4) return 'rgba(255,189,89,0.4)';
      if (p<0.6) return 'rgba(89,255,142,0.4)';
      if (p<0.8) return 'rgba(89,191,255,0.45)';
      return 'rgba(193,89,255,0.5)';
    }

    function updateCoreUI(){
      document.getElementById('game-wrapper').classList.remove('hidden');

      document.getElementById('wallet-display').children[1].textContent =
        shortAddress(currentWalletState.address);
      document.getElementById('balance-display').innerHTML =
        `${formatKTFromBase(currentWalletState.balanceRawBase)} <small>KT</small>`;

      const level = currentWalletState.level;
      document.getElementById('current-level-title').textContent =
        `CURRENT: ${level.name.toUpperCase()}`;
      const next = getNext(level);
      const nextTarget=document.getElementById('next-target');
      if (next){
        nextTarget.innerHTML =
          `<span class="material-icons" style="font-size:9px;">trending_up</span><span>Next: ${next.name} (${next.min} KT)</span>`;
      } else {
        nextTarget.innerHTML =
          `<span class="material-icons" style="font-size:9px;">emoji_events</span><span>MAX LEVEL REACHED</span>`;
      }

      let progress=1;
      let from = level.min;
      let to = next ? next.min : level.min;
      if (next){
        const bal = currentWalletState.balanceKT;
        progress = (bal - from) / (to - from);
        progress = Math.max(0,Math.min(1,progress));
      }
      drawRadial(progress);
      document.getElementById('radial-percent').textContent =
        Math.round(progress*100)+'%';
      document.getElementById('radial-small').textContent =
        next ? `TO ${next.name.toUpperCase()}` : 'LEGENDARY';
      const barFill=document.getElementById('bar-progress-fill');
      requestAnimationFrame(()=> barFill.style.width = (progress*100)+'%');
      document.getElementById('progress-from').textContent = from+' KT';
      document.getElementById('progress-to').textContent = next ? (next.min+' KT') : 'MAX';

      buildLevelLadder();
      buildAchievements();
      buildInlineLevels();
      buildQuests();

      const wrapper = document.getElementById('game-wrapper');
      wrapper.style.boxShadow = `0 0 25px -6px ${progressColor(progress)}`;
      generateParticles();
    }

    async function certifyWallet(){
      const wallet = document.getElementById("wallet").value.trim();
      const resultDiv = document.getElementById("result");
      resultDiv.className='';
      if (!wallet){
        resultDiv.textContent='Please enter a wallet address.';
        resultDiv.className='error';
        return;
      }
      if (!validateEthAddress(wallet)){
        resultDiv.textContent='Invalid wallet address format.';
        resultDiv.className='error';
        return;
      }

      const btn=document.getElementById('certify-btn');
      const originalHTML=btn.innerHTML;
      btn.disabled=true;
      btn.innerHTML='<span class="material-icons">hourglass_top</span><span>SCANNING</span>';
      resultDiv.textContent='Fetching token balance...';
      resultDiv.className='loading';

      try{
        const rawBase = await getTokenBalanceRaw(wallet);
        const humanTokensStr = toHuman(rawBase.toString(), TOKEN_DECIMALS);
        const humanTokens = Number(humanTokensStr);
        const balanceKT = Number(rawBase) / Number(KT_UNIT);

        const level = getLevel(balanceKT);
        currentWalletState.address        = wallet;
        currentWalletState.balanceRawBase = rawBase;
        currentWalletState.balanceKT      = balanceKT;
        currentWalletState.level          = level;

        const ts=new Date().toISOString();
        const ref=db.ref('certified-wallets/'+wallet.toLowerCase());
        ref.once('value').then(snap=>{
          const data = {
            address: wallet.toLowerCase(),
            balanceBase: rawBase.toString(),
            balanceTokens: humanTokens,
            balanceKT,
            level: level.name,
            certified:true,
            lastUpdated:ts
          };
          if (snap.exists()){
            ref.update(data);
          } else {
            data.certifiedAt = ts;
            ref.set(data);
          }
        });

        resultDiv.textContent =
          `Level: ${level.name} | Balance: ${formatKTFromBase(rawBase)} KT`;
        resultDiv.className='success';

        const q = QUESTS.find(q=>q.id==='q1');
        if (q && !q.done){ q.done=true; currentWalletState.xp += q.reward; }

        updateCoreUI();
        flashMotivation("Scan success! Keep climbing.");
      } catch(err){
        console.error(err);
        resultDiv.textContent='Error fetching token balance. Please retry.';
        resultDiv.className='error';
      } finally {
        btn.disabled=false;
        btn.innerHTML=originalHTML;
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('time-stamp').textContent =
        new Date().toISOString().replace('T',' ').slice(0,19);
      buildInlineLevels();
      buildAchievements();
      buildQuests();
      drawRadial(0);
    });
  </script>
</body>
</html>
