<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>My SUBFANS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.11.1/web3.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        * {margin:0;padding:0;box-sizing:border-box;}
        html {font-size:14px;}
        body {
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:linear-gradient(135deg, #101622 0%, #2c3242 100%);
            min-height:100vh;
            padding:0;
            color:#f2f2ff;
        }
        .container {
            max-width:400px;
            margin:0 auto;
            background:#191d2b;
            border-radius:12px;
            box-shadow:0 6px 16px rgba(0,0,0,0.21);
            overflow:hidden;
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }
        .topbar {
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:8px 10px 8px 10px;
            background:linear-gradient(90deg, #23263e 60%, #303856 100%);
        }
        .topbar-left {
            display:flex;
            align-items:center;
            gap:7px;
        }
        .topbar-logo {
            height:22px;
            width:22px;
            border-radius:50%;
            display:none;
        }
        .topbar-title {font-size:1em;font-weight:600;color:#f2f2ff;letter-spacing:0.02em;}
        .topbar-score {
            display:flex;
            align-items:center;
            gap:2px;
            background:#191d33;
            border-radius:7px;
            padding:1px 8px;
            font-size:0.95em;
            font-weight:600;
            color:#94b8e2;
        }
        .topbar-actions {display:flex;align-items:center;gap:6px;}
        .connect-btn {
            background:linear-gradient(135deg, #2940a7 0%, #6262b2 100%);
            color:#fff;
            border:none;
            padding:6px 11px;
            border-radius:20px;
            font-size:0.97em;
            font-weight:600;
            cursor:pointer;
            transition:all 0.2s;
            min-width:80px;
            outline:none;
        }
        .connect-btn:disabled {opacity:0.5;cursor:not-allowed;}
        .topbar-wallet {
            color:#acacbe;
            font-size:0.77em;
            font-family:monospace;
            max-width:76px;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
        }
        .balance-bar {
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px 13px 6px 13px;
            background:linear-gradient(90deg, #181c31 0%, #313156 100%);
            border-bottom:1px solid #26283b;
            font-weight:700;
            font-size:1.03em;
            color:#dbd8ff;
            letter-spacing:0.01em;
            box-shadow:0 1px 4px 0 #0004;
        }
        .balance-label {
            font-size:0.97em;
            color:#898dae;
            font-weight:500;
            margin-right:6px;
        }
        .balance-amount {
            font-size:0.97em;
            color:#7fa9f8;
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            font-weight:700;
        }
        .balance-bar-pol {
            background:linear-gradient(90deg, #212d38 0%, #23343f 100%);
            color:#79b3ff;
        }
        .balance-amount-pol {
            color:#9deeff;
        }
        .token-symbol {
            font-size:0.90em;
            font-weight:700;
            margin-left: 3px;
            color:#6f97bb;
        }
        .main-content {
            padding:12px 8px 14px 8px;
            flex:1;
            display:flex;
            flex-direction:column;
        }
        .input-section {margin-bottom:13px;}
        .input-section label {
            display:block;
            margin-bottom:4px;
            font-weight:500;
            color:#a5adc8;
            font-size:0.93em;
        }
        .text-input {
            font-size:10px !important;
            width:100%;
            min-height:48px;
            padding:7px;
            border:1.5px solid #252a39;
            border-radius:5px;
            background:#181c2e;
            color:#fff;
            font-family:monospace;
            resize:vertical;
            transition:border-color 0.25s;
            box-sizing:border-box;
            outline:none;
        }
        .text-input:focus {border-color:#4153e1;}
        .wallet-count {
            background:#212542;
            padding:7px;
            border-radius:7px;
            margin-bottom:11px;
            text-align:center;
            font-weight:500;
            font-size:0.90em;
            color:#adb7df;
        }
        .button-group {
            display:flex;
            gap:8px;
            margin-bottom:11px;
            flex-wrap:wrap;
        }
        .action-btn {
            background:linear-gradient(135deg, #253d70 0%, #3b75d3 100%);
            color:white;
            border:none;
            padding:7px 5px;
            border-radius:6px;
            font-weight:600;
            cursor:pointer;
            flex:1;
            min-width:80px;
            font-size:0.94em;
        }
        .action-btn:hover {box-shadow:0 2px 7px #283c68bb;}
        .action-btn:disabled {background:#333a52;cursor:not-allowed;box-shadow:none;}
        .extract-btn {background:linear-gradient(135deg, #4044a6 0%, #9279b8 100%);}
        .airdrop-btn {background:linear-gradient(135deg, #1b7e6f 0%, #218ace 100%);}
        .progress-section {margin-bottom:10px;display:none;}
        .progress-bar {
            width:100%;
            height:12px;
            background:#161c2e;
            border-radius:7px;
            margin-bottom:3px;
        }
        .progress-fill {
            height:100%;
            background:linear-gradient(90deg, #27e8c6 0%, #227ee3 100%);
            width:0%;
            transition:width 0.2s;
        }
        .progress-text {text-align:center;font-weight:600;color:#7fa9f8;font-size:0.87em;}
        .score-preview {
            display:flex;
            align-items:center;
            justify-content:center;
            gap:4px;
            margin-bottom:7px;
            font-size:0.97em;
            font-weight:600;
            color:#91b5ec;
            min-height:24px;
            padding:4px 0;
        }
        .subfan-animated {
            width:18px;
            height:18px;
            border-radius:50%;
            display:inline-block;
            position:relative;
            background:#20284d;
            margin-right:2px;
        }
        .activity-log {
            background:#161a27;
            border-radius:7px;
            max-height:115px;
            overflow-y:auto;
            margin-top:10px;
        }
        .activity-log h3 {
            padding:5px 8px;
            margin:0;
            background:#2a2d47;
            border-radius:7px 7px 0 0;
            font-size:0.98em;
            color:#ccc;
        }
        .log-table {width:100%;border-collapse:collapse;}
        .log-table th {
            background:#23243a;
            padding:3.5px 4px;
            text-align:left;
            font-size:8.5px;
            font-weight:600;
            border-bottom:1px solid #26283b;
            color:#7dabf5;
        }
        .log-table td {
            padding:2.5px 4px;
            font-size:8.5px;
            border-bottom:1px solid #191a28;
            font-family:monospace;
            color:#b3bfff;
        }
        .log-table tr:hover {background:#222a37;}
        .log-empty {
            padding:6px;
            text-align:center;
            color:#6b7990;
            font-style:italic;
            font-size:9px;
        }
        .error {color:#ffe4e4;background:#512526;padding:5px;border-radius:4px;margin:5px 0;font-size:0.93em;}
        .success {color:#e9ffe4;background:#245136;padding:5px;border-radius:4px;margin:5px 0;font-size:0.93em;}
        #firebaseNotification {
            margin-top:7px;
            font-size:0.90em;
            color:#39e2a7;
            background:#132c24;
            border-radius:5px;
            padding:5px;
            display:none;
        }
        @media (max-width:600px) {
            html {font-size:13px;}
            .container {max-width:100vw;border-radius:0;box-shadow:none;}
            .main-content {padding:7px 2.5vw 10px 2.5vw;}
            .topbar {padding:7px 3vw 7px 3vw;}
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Top Navigation Bar -->
        <div class="topbar">
            <div class="topbar-left">
                <span class="topbar-title">My SubFans</span>
                <span class="topbar-score">
                    <span id="subdropScore">0</span>
                </span>
            </div>
            <div class="topbar-actions">
                <span class="topbar-wallet" id="walletAddress"></span>
                <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect</button>
            </div>
        </div>
        <!-- $NFTFAN Balance Bar -->
        <div class="balance-bar" id="nftfanBalanceBar" style="display:none;">
            <span class="balance-label">NFT Fans</span>
            <span class="balance-amount" id="nftfanBalance">0</span> <span class="token-symbol">$NFTFAN</span>
        </div>
        <!-- $POL Balance Bar -->
        <div class="balance-bar balance-bar-pol" id="polBalanceBar" style="display:none;">
            <span class="balance-label">$POL</span>
            <span class="balance-amount balance-amount-pol" id="polBalance">0</span>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="input-section">
                <textarea 
                    class="text-input" 
                    id="walletInput" 
                    placeholder="Paste text with wallet addresses here...&#10;Extracts valid Ethereum addresses."
                    inputmode="text"
                    autocomplete="off"
                    autocorrect="off"
                    spellcheck="false"
                ></textarea>
            </div>
            <div class="wallet-count" id="walletCount">No wallets extracted yet</div>
            <div class="score-preview" id="scorePreview" style="display:none;">
                <span class="subfan-animated"></span>
                <span id="scoreMessage">You will earn SUBFANS for this drop!</span>
            </div>
            <div class="button-group">
                <button class="action-btn extract-btn" id="extractBtn" onclick="extractWallets()">Extract</button>
                <button class="action-btn airdrop-btn" id="airdropBtn" onclick="startAirdrop()" disabled>Airdrop</button>
            </div>
            <div class="topbar-actions" style="margin-bottom:8px;">
                <span class="topbar-wallet" id="walletAddress"></span>
                <a href="https://www.nftfanstoken.com/oswallets/" class="connect-btn" id="dbWalletsBtn" style="text-align:center;width:100px;">Get Wallets</a>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Preparing...</div>
            </div>
            <div class="activity-log">
                <h3>Activity Log</h3>
                <table class="log-table" id="logTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        <tr>
                            <td colspan="3" class="log-empty">No activity yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="firebaseNotification"></div>
        </div>
    </div>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
            authDomain: "nftfanactive.firebaseapp.com",
            databaseURL: "https://nftfanactive-default-rtdb.firebaseio.com",
            projectId: "nftfanactive",
            storageBucket: "nftfanactive.appspot.com",
            messagingSenderId: "311309982791",
            appId: "1:311309982791:web:3e55bba6b78feb57ea6562",
            measurementId: "G-3TRDL9749N"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- main dapp code ---
        const DISTRIBUTOR_ADDRESS = '0x6Ee372b30C73Dd6087ba58F8C4a5Ca77F49BE0b3';
        const NFTFAN_ADDRESS = '0x2017Fcaea540d2925430586DC92818035Bfc2F50';
        const POLYGON_CHAIN_ID = '0x89';
        const POL_ADDRESS = '0xC7c8cAcaA3c3A34d437FE3F56c6b41eA6c9fA2F0';
        const ERC20_ABI = [
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"}
        ];
        const DISTRIBUTOR_ABI = [
            {"inputs":[{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"distributeTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"wallet","type":"address"}],"name":"getSubdropScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"previewDistribution","outputs":[{"internalType":"uint256","name":"successfulDrops","type":"uint256"},{"internalType":"uint256","name":"tokensNeeded","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];
        let web3, userAccount, distributorContract, nftfanContract, polContract, extractedWallets = [];
        let newWalletsCount = 0, predictedScore = null, currentScore = null;

        function showFirebaseNotification(msg) {
            const notif = document.getElementById('firebaseNotification');
            notif.textContent = msg || 'Firebase database updated!';
            notif.style.display = '';
            setTimeout(()=>{notif.style.display='none';}, 2200);
        }
        function addLog(event, details) {
            const logBody = document.getElementById('logBody');
            const emptyRow = logBody.querySelector('.log-empty');
            if (emptyRow) emptyRow.parentNode.removeChild(emptyRow);
            const row = document.createElement('tr');
            const time = new Date().toLocaleTimeString();
            row.innerHTML = `<td>${time}</td><td>${event}</td><td>${details}</td>`;
            logBody.insertBefore(row, logBody.firstChild);
            while (logBody.children.length > 30) logBody.removeChild(logBody.lastChild);
        }
        function saveWalletAndScoreToFirebase(address, score) {
            if (!address) return;
            db.ref('users/' + address).set({ wallet: address, subfanScore: score, lastLogin: new Date().toISOString() }, function(error) {
                if (error) {
                    addLog('Firebase', 'Error updating wallet:' + error);
                } else {
                    addLog('Firebase', 'Wallet/score updated');
                    showFirebaseNotification(`Wallet ${address} & score saved`);
                }
            });
        }
        function watchUserDb(address) {
            if (!address) return;
            db.ref('users/' + address).on('value', function(snapshot) {
                const data = snapshot.val();
                if (data) {
                    showFirebaseNotification(`DB updated! Wallet: ${address}, Score: ${data.subfanScore || 0}`);
                }
            });
        }
        async function switchToPolygon() {
            try {
                await window.ethereum.request({method: 'wallet_switchEthereumChain',params: [{chainId: POLYGON_CHAIN_ID}]});
                addLog('Network', 'Polygon set');
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: POLYGON_CHAIN_ID,
                                chainName: 'Polygon',
                                nativeCurrency: {name: 'MATIC',symbol: 'MATIC',decimals: 18},
                                rpcUrls: ['https://polygon-rpc.com/'],
                                blockExplorerUrls: ['https://polygonscan.com/']
                            }]
                        });
                        addLog('Network', 'Polygon added');
                    } catch (addError) {
                        addLog('Error', 'Add Polygon failed');
                        throw addError;
                    }
                } else {
                    addLog('Error', 'Switch Polygon failed');
                    throw switchError;
                }
            }
        }
        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    await switchToPolygon();
                    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
                    userAccount = accounts[0];
                    web3 = new Web3(window.ethereum);
                    distributorContract = new web3.eth.Contract(DISTRIBUTOR_ABI, DISTRIBUTOR_ADDRESS);
                    nftfanContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_ADDRESS);
                    polContract = new web3.eth.Contract(ERC20_ABI, POL_ADDRESS);
                    document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+'...'+userAccount.slice(-4);
                    document.getElementById('connectBtn').textContent = 'Connected';
                    document.getElementById('connectBtn').disabled = true;
                    await updateSubdropScore();
                    await showAllBalances();
                    addLog('Wallet', 'Connected');
                    if (userAccount && currentScore !== null) {
                        saveWalletAndScoreToFirebase(userAccount, currentScore);
                        watchUserDb(userAccount);
                    }
                } catch (error) {
                    addLog('Error', 'Wallet connect fail: ' + error.message);
                }
            } else {
                addLog('Error', 'MetaMask missing');
            }
            document.getElementById('airdropBtn').disabled = extractedWallets.length === 0 || !userAccount || newWalletsCount === 0;
        }
        async function showAllBalances() {
            await showNftfanBalance(); await showPolBalance();
        }
        async function showNftfanBalance() {
            if (!nftfanContract || !userAccount) {
                document.getElementById('nftfanBalanceBar').style.display = 'none';
                return;
            }
            try {
                let [balance, decimals] = await Promise.all([
                    nftfanContract.methods.balanceOf(userAccount).call(),
                    nftfanContract.methods.decimals().call()
                ]);
                const divisor = BigInt(10) ** BigInt(decimals || 18);
                let intBalance = (BigInt(balance) / divisor).toString();
                intBalance = Number(intBalance).toLocaleString('en');
                document.getElementById('nftfanBalance').textContent = intBalance;
                document.getElementById('nftfanBalanceBar').style.display = '';
            } catch (e) {
                document.getElementById('nftfanBalanceBar').style.display = 'none';
            }
        }
        async function showPolBalance() {
            if (!polContract || !userAccount) {
                document.getElementById('polBalanceBar').style.display = 'none';
                return;
            }
            try {
                let [balance, decimals] = await Promise.all([
                    polContract.methods.balanceOf(userAccount).call(),
                    polContract.methods.decimals().call()
                ]);
                const divisor = BigInt(10) ** BigInt(decimals || 18);
                let intBalance = (BigInt(balance) / divisor).toString();
                intBalance = Number(intBalance).toLocaleString('en');
                document.getElementById('polBalance').textContent = intBalance;
                document.getElementById('polBalanceBar').style.display = '';
            } catch (e) {
                document.getElementById('polBalanceBar').style.display = 'none';
            }
        }
        async function updateSubdropScore() {
            if (!distributorContract || !userAccount) return;
            try {
                const score = await distributorContract.methods.getSubdropScore(userAccount).call();
                document.getElementById('subdropScore').textContent = score;
                currentScore = score;
                updateScorePreview();
                addLog('Score', 'Score: ' + score);
                if (userAccount) {
                    saveWalletAndScoreToFirebase(userAccount, score);
                }
            } catch (error) {
                addLog('Error', 'Subdrop score fail');
            }
        }
        function extractWallets() {
            const input = document.getElementById('walletInput').value;
            const walletRegex = /0x[a-fA-F0-9]{40}/g;
            const matches = input.match(walletRegex);
            if (matches) {
                extractedWallets = [...new Set(matches)].filter(addr => /^0x[a-fA-F0-9]{40}$/.test(addr));
                document.getElementById('walletCount').textContent = `Extracted ${extractedWallets.length} unique wallet addresses`;
                addLog('Extract', `Found ${extractedWallets.length} unique`);
            } else {
                extractedWallets = [];
                document.getElementById('walletCount').textContent = 'No valid wallet addresses found';
                addLog('Extract', 'No valid wallet addresses');
            }
            newWalletsCount = 0;
            predictedScore = null;
            document.getElementById('scorePreview').style.display = 'none';
            document.getElementById('airdropBtn').disabled = true;
            if (userAccount && extractedWallets.length > 0) {
                previewScoreAndEnableAirdrop();
            }
        }
        function chunkArray(array, chunkSize) {
            const results = [];
            for (let i = 0; i < array.length; i += chunkSize) {
                results.push(array.slice(i, i + chunkSize));
            }
            return results;
        }
        async function previewScoreAndEnableAirdrop() {
            if (!userAccount || !distributorContract || extractedWallets.length === 0) {
                document.getElementById('scorePreview').style.display = 'none';
                document.getElementById('airdropBtn').disabled = true;
                return;
            }
            const batchSize = 50;
            const batches = chunkArray(extractedWallets, batchSize);
            let totalDrops = 0;
            try {
                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    const preview = await distributorContract.methods.previewDistribution(userAccount, batch).call();
                    totalDrops += Number(preview.successfulDrops);
                }
                newWalletsCount = totalDrops;
                updateScorePreview();
                document.getElementById('airdropBtn').disabled = newWalletsCount === 0;
            } catch (error) {
                document.getElementById('scorePreview').style.display = 'none';
                document.getElementById('airdropBtn').disabled = true;
                addLog('Error', 'Preview error: ' + error.message);
            }
        }
        function updateScorePreview() {
            const previewDiv = document.getElementById('scorePreview');
            const scoreMsg = document.getElementById('scoreMessage');
            if (typeof currentScore !== 'undefined' && currentScore !== null && newWalletsCount > 0) {
                let newScore = Number(currentScore) + Number(newWalletsCount);
                scoreMsg.textContent = `You will score ${newScore} SUBFANS after this drop!`;
                previewDiv.style.display = '';
            } else if (newWalletsCount === 0) {
                scoreMsg.textContent = 'No new wallets to airdrop!';
                previewDiv.style.display = '';
            } else {
                previewDiv.style.display = 'none';
            }
        }
        async function startAirdrop() {
            if (!userAccount || !distributorContract || extractedWallets.length === 0 || newWalletsCount === 0) {
                addLog('Error', 'No wallets to airdrop');
                document.getElementById('airdropBtn').disabled = true;
                return;
            }
            const batchSize = 50;
            const batches = chunkArray(extractedWallets, batchSize);
            let totalDrops = 0;
            let totalTokensNeeded = BigInt(0);
            let totalDistributed = 0;
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('airdropBtn').disabled = true;
            try {
                addLog('Preview', `Check preview for ${batches.length} batch...`);
                let previews = [];
                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    const preview = await distributorContract.methods.previewDistribution(userAccount, batch).call();
                    previews.push(preview);
                    totalDrops += Number(preview.successfulDrops);
                    totalTokensNeeded += BigInt(preview.tokensNeeded);
                    addLog('Preview', `Batch${i+1}: ${preview.successfulDrops} wallets`);
                }
                if (totalDrops === 0) {
                    addLog('Info', 'No new wallets to airdrop');
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('airdropBtn').disabled = true;
                    updateScorePreview();
                    return;
                }
                const balance = await nftfanContract.methods.balanceOf(userAccount).call();
                if (BigInt(balance) < totalTokensNeeded) {
                    addLog('Error', 'Insufficient tokens');
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('airdropBtn').disabled = false;
                    return;
                }
                const allowance = await nftfanContract.methods.allowance(userAccount, DISTRIBUTOR_ADDRESS).call();
                if (BigInt(allowance) < totalTokensNeeded) {
                    addLog('Approval', 'Approving...');
                    document.getElementById('progressText').textContent = 'Approving tokens...';
                    await nftfanContract.methods.approve(DISTRIBUTOR_ADDRESS, totalTokensNeeded.toString()).send({from:userAccount});
                    addLog('Approval', 'Tokens approved');
                }
            } catch (error) {
                addLog('Error', 'Preview/approve error: '+ error.message);
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('airdropBtn').disabled = false;
                updateProgress(0);
                return;
            }
            try {
                let batchesDone = 0;
                for (let i = 0; i < batches.length; i++) {
                    const batch = batches[i];
                    document.getElementById('progressText').textContent = `Airdropping ${i + 1}/${batches.length}...`;
                    updateProgress(Math.round((i / batches.length) * 100));
                    addLog('Airdrop', `Sending to batch ${i+1} (${batch.length})`);
                    try {
                        const distributeTx = await distributorContract.methods.distributeTokens(batch).send({from:userAccount,gas:5000000});
                        addLog('Success', `Batch ${i+1}: ${distributeTx.transactionHash}`);
                        batchesDone++;
                        totalDistributed += batch.length;
                        updateProgress(Math.round((batchesDone / batches.length) * 100));
                    } catch (batchError) {
                        addLog('Error', `Airdrop batch ${i+1} fail: ${batchError.message}`);
                    }
                }
                document.getElementById('progressText').textContent = 'Airdrop done!';
                updateProgress(100);
                addLog('Success', `Airdrop done. ${totalDistributed} wallets in ${batchesDone} batches`);
                await updateSubdropScore();
                await showAllBalances();
                if (userAccount && currentScore !== null) {
                    saveWalletAndScoreToFirebase(userAccount, currentScore);
                }
                setTimeout(() => {
                    document.getElementById('progressSection').style.display = 'none';
                    document.getElementById('airdropBtn').disabled = false;
                    updateProgress(0);
                    showFindNewWalletsMessage();
                }, 1200);
            } catch (error) {
                addLog('Error', 'Airdrop failed: ' + error.message);
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('airdropBtn').disabled = false;
                updateProgress(0);
            }
        }
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
            if (percent === 100)
                document.getElementById('progressText').textContent = 'Airdrop completed!';
        }
        function showFindNewWalletsMessage() {
            const previewDiv = document.getElementById('scorePreview');
            const scoreMsg = document.getElementById('scoreMessage');
            scoreMsg.textContent = "Airdrop done! ðŸŽ‰ Find new wallets to score more!";
            previewDiv.style.display = '';
        }
        document.addEventListener('touchstart', function(e) {
            var active = document.activeElement;
            if (active && (active.tagName === 'TEXTAREA' || active.tagName === 'INPUT')) {
                setTimeout(function() {active.style.fontSize = '10px';}, 0);
            }
        });
        window.addEventListener('DOMContentLoaded', async function() {
            addLog('System', 'Airdrop tool loaded');
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({method: 'eth_accounts'});
                    if (accounts.length > 0) {
                        userAccount = accounts[0];
                        web3 = new Web3(window.ethereum);
                        distributorContract = new web3.eth.Contract(DISTRIBUTOR_ABI, DISTRIBUTOR_ADDRESS);
                        nftfanContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_ADDRESS);
                        polContract = new web3.eth.Contract(ERC20_ABI, POL_ADDRESS);
                        document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+'...'+userAccount.slice(-4);
                        document.getElementById('connectBtn').textContent = 'Connected';
                        document.getElementById('connectBtn').disabled = true;
                        await updateSubdropScore();
                        await showAllBalances();
                        if (userAccount && currentScore !== null) {
                            saveWalletAndScoreToFirebase(userAccount, currentScore);
                            watchUserDb(userAccount);
                        }
                        if (extractedWallets.length > 0) {
                            previewScoreAndEnableAirdrop();
                        }
                    }
                } catch {}
            }
        });
    </script>
</body>
</html>
