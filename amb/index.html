
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFANS Ambassadors - Become a Brand Ambassador in Your Country</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --bg: #111113;
      --bg2: #1a1a21;
      --panel: #19192b;
      --shadow: #10e0ff44;
      --neon: #10e0ff;
      --neon2: #1f7fff;
      --text: #d7faff;
      --text2: #0ff;
      --accent: #ff00d4;
      --grey: #7c8c99;
      --success: #1be895;
      --fail: #ff2954;
    }
    html, body {
      font-family: 'Inter', 'Roboto', 'Arial', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-size: 10px;
      -webkit-tap-highlight-color: transparent;
      width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
      background: linear-gradient(120deg, #1a0033 0%, #0f222d 100%);
    }
    h1 {
      text-align: center;
      margin: 12px 0 4px 0;
      font-size: 1.22rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: var(--neon);
      text-shadow: 0 2px 18px var(--neon2), 0 1px 14px #0004;
      line-height: 1.18;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .material-icons { vertical-align: middle; }
    .help-icon {
      margin-left: 5px;
      cursor: pointer;
      vertical-align: middle;
      color: var(--neon2);
      transition: color 0.15s;
      border-radius: 50%;
      background: #191940;
      padding: 3px;
      box-shadow: 0 1px 7px var(--shadow);
      font-size: 18px !important;
    }
    .help-icon:hover {
      color: var(--accent);
      background: #181838;
    }
    .buy-nftfan-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 230px;
      margin: 0 auto 14px auto;
      background: linear-gradient(90deg, var(--neon) 0%, var(--accent) 100%);
      color: #fff;
      font-size: 1.09rem;
      font-weight: 700;
      letter-spacing: 1px;
      border: none;
      border-radius: 12px;
      padding: 14px 7px 13px 7px;
      box-shadow: 0 2px 12px var(--shadow), 0 1.5px 7px #0009;
      cursor: pointer;
      transition: background 0.13s, transform 0.09s, box-shadow 0.13s;
      outline: none;
      gap: 7px;
      position: relative;
      z-index: 2;
      text-decoration: none;
      border: 2.5px solid var(--accent);
    }
    .buy-nftfan-btn:active {
      background: linear-gradient(90deg, var(--accent) 0%, var(--neon) 100%);
      transform: scale(0.98);
      box-shadow: 0 3px 20px var(--accent), 0 1.5px 7px #0006;
    }
    .mainbox {
      width: 97vw;
      max-width: 410px;
      margin: 10px auto 0 auto;
      background: var(--panel);
      border-radius: 17px;
      box-shadow: 0 2px 28px var(--shadow), 0 2px 18px #0008;
      padding: 13px 7px 19px 7px;
      border: 2px solid var(--neon2);
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .mapbox {
      width: 100%;
      max-width: 370px;
      height: 41vw;
      max-height: 470px;
      min-height: 180px;
      border: 2px solid var(--accent);
      border-radius: 12px;
      margin-bottom: 10px;
      background: #101019;
      overflow: hidden;
      box-shadow: 0 4px 28px var(--accent), 0 3px 18px #000a;
      position: relative;
      box-sizing: border-box;
    }
    .legend {
      background: rgba(25,25,50,0.98);
      color: var(--neon2);
      padding: 4px 10px 4px 7px;
      border-radius: 7px;
      font-size: 8.5px;
      position: absolute;
      top: 8px;
      left: 8px;
      z-index: 1000;
      box-shadow: 0 1px 12px var(--shadow);
      display: flex;
      align-items: center;
      gap: 7px;
      border: 1.5px solid var(--neon2);
    }
    .legend-img {
      display: inline-block;
      width: 15px;
      height: 15px;
      background: #101019;
      border-radius: 50%;
      margin-right: 3px;
      border: 1px solid var(--neon);
      background-size: cover;
      background-position: center;
    }
    .location-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 210px;
      margin: 0 auto 10px auto;
      background: linear-gradient(90deg, var(--neon2) 50%, var(--accent) 100%);
      color: #fff;
      font-size: 1.07rem;
      font-weight: 700;
      letter-spacing: 1px;
      border: none;
      border-radius: 8px;
      padding: 13px 7px 12px 7px;
      box-shadow: 0 2px 12px var(--shadow), 0 1.5px 7px #0001;
      cursor: pointer;
      transition: background 0.13s, transform 0.09s;
      outline: none;
      gap: 7px;
      position: relative;
      z-index: 2;
      border: 2px solid var(--neon2);
    }
    .location-btn:active {
      background: linear-gradient(90deg, var(--accent) 60%, var(--neon2) 100%);
      transform: scale(0.98);
    }
    .location-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #39394a !important;
      color: #888 !important;
    }
    .form-step-box {
      width: 100%;
      max-width: 330px;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 11px;
      padding-left: 5px;
      padding-right: 5px;
      box-sizing: border-box;
    }
    .inputbox {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 12px;
      width: 100%;
      align-items: flex-start;
    }
    label {
      color: var(--neon2);
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 11px;
      text-align: left;
      text-shadow: 0 1px 6px #0ff4;
    }
    input[type="text"], input[type="email"], textarea, input[type="tel"], input[type="number"] {
      background: #22223a;
      border: 1.5px solid #294c7a;
      color: var(--text);
      border-radius: 7px;
      padding: 10px 9px;
      font-size: 15px;
      margin-bottom: 2px;
      outline: none;
      transition: border 0.1s, background 0.14s;
      width: 100%;
      box-sizing: border-box;
      appearance: none;
      caret-color: var(--neon2);
      box-shadow: 0 1px 7px #10e0ff22;
    }
    input[type="text"]:focus, input[type="email"]:focus, textarea:focus, input[type="tel"]:focus, input[type="number"]:focus {
      border: 1.8px solid var(--accent);
      background: #19192b;
    }
    textarea {
      min-height: 70px;
      max-height: 180px;
      resize: vertical;
      font-size: 15px;
    }
    .btn, button[type="submit"].btn, .submit-btn, .step-btn, .back-btn {
      background: linear-gradient(90deg, var(--accent) 0%, var(--neon2) 100%);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 11px 0 10px 0;
      font-size: 1.13rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 9px 0 7px 0;
      box-shadow: 0 2px 9px var(--accent), 0 1.5px 7px #0003;
      width: 100%;
      transition: background 0.13s, transform 0.09s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-height: 34px;
      cursor: pointer;
      outline: none;
      position: relative;
      z-index: 2;
      border: 2px solid var(--neon2);
    }
    .btn:active, button[type="submit"].btn:active, .submit-btn:active, .step-btn:active, .back-btn:active {
      background: linear-gradient(90deg, var(--neon2) 60%, var(--accent) 100%);
      transform: scale(0.98);
    }
    .btn[disabled], button[type="submit"].btn[disabled], .submit-btn[disabled], .step-btn[disabled], .back-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #39394a !important;
      color: #888 !important;
    }
    .back-btn {
      width: 100%;
      background: linear-gradient(90deg, #2b2b2b 0%, #4c4c4c 100%);
      color: var(--neon2);
      font-size: 1rem;
      font-weight: 600;
      border-radius: 10px;
      margin-top: 2px;
      margin-bottom: 6px;
      box-shadow: 0 1px 4px #0002;
      gap: 5px;
      border: 2px solid var(--neon2);
    }
    .info-message {
      color: var(--neon2);
      background: #19192b;
      border-radius: 7px;
      padding: 7px 9px;
      margin: 7px 0 0 0;
      font-size: 10.5px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1.5px solid var(--neon2);
      box-shadow: 0 1px 8px var(--shadow);
    }
    .success-message {
      color: #fff;
      background: var(--success);
      border: 1px solid var(--success);
      box-shadow: 0 3px 24px #1be89566;
    }
    .popup-help-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.23);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }
    .popup-help {
      background: var(--panel);
      border-radius: 13px;
      box-shadow: 0 2px 18px var(--shadow);
      border: 2px solid var(--neon2);
      max-width: 340px;
      width: 92vw;
      padding: 23px 15px 19px 15px;
      color: var(--text);
      font-size: 13px;
      line-height: 1.52;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 7px;
      animation: pop-in 0.22s;
    }
    @keyframes pop-in {
      from {transform: scale(0.88); opacity: 0;}
      to {transform: scale(1); opacity: 1;}
    }
    .popup-help-close {
      position: absolute;
      top: 8px;
      right: 9px;
      background: #191940;
      color: var(--neon2);
      border-radius: 50%;
      border: none;
      font-size: 17px;
      cursor: pointer;
      transition: background 0.12s;
      padding: 2px 5px 2px 5px;
    }
    .popup-help-close:hover {
      background: var(--accent);
      color: #fff;
    }
    .popup-help-title {
      font-weight: 700;
      font-size: 15px;
      color: var(--neon2);
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 5px;
      text-shadow: 0 1px 8px var(--shadow);
    }
    .leaflet-container {
      background: #101019 !important;
      background-repeat: no-repeat !important;
      background-size: cover !important;
      filter: drop-shadow(0 0 18px var(--neon2));
    }
    @media (max-width: 600px) {
      html, body { font-size: 10px; width: 100vw; max-width: 100vw; overflow-x: hidden !important; box-sizing: border-box; }
      h1 { font-size: 1rem; }
      .mainbox { max-width: 99vw; width: 99vw; padding: 6px 1.3vw 13px 1.3vw;}
      .mapbox { max-width: 99vw; width: 99vw; height: 270px; min-height: 120px;}
      .legend { font-size: 8px; top: 4px; left: 4px;}
      .buy-nftfan-btn { font-size: 1rem; padding: 11px 7px 10px 7px; }
      .location-btn, .btn, .submit-btn, .step-btn, .back-btn { font-size: 1rem; padding: 11px 7px 10px 7px; }
      input[type="text"], input[type="email"], textarea, input[type="tel"], input[type="number"] { font-size: 13px; }
      #map { width: 100% !important; }
      .form-step-box { max-width: 99vw; }
      .popup-help { max-width: 98vw; font-size: 12px;}
    }
    @media (max-width: 400px) {
      .mainbox, .mapbox { max-width: 100vw; width: 100vw; }
      html, body { padding: 0; margin: 0; }
    }
    @media (min-width: 1025px) {
      .mainbox {
        max-width: 800px;
      }
      .mapbox {
        max-width: 560px;
        height: 560px;
      }
      .form-step-box {
        max-width: 500px;
      }
    }
  </style>
</head>
<body>
  <h1>
    <span style="display:inline-flex;align-items:center;">
      <span class="material-icons" style="font-size:15px;color:var(--neon2);margin-right:3px;">emoji_events</span>
      NFTFANS Ambassadors
    </span>
    <span class="material-icons help-icon" id="helpIcon" title="Help">help_outline</span>
  </h1>
  <a href="https://nftfanstoken.com/topup" class="buy-nftfan-btn" target="_blank">
    <span class="material-icons" style="font-size:17px;color:#fff;">paid</span>
    BUY $NFTFAN
  </a>
  <div class="mainbox">
    <div class="mapbox">
      <div class="legend">
        <span class="legend-img" id="legendProfilePic"></span>
        NFTFANS TOKEN
      </div>
      <div id="map" style="width:100%;height:100%;"></div>
    </div>
    <div id="step1">
      <button class="location-btn" id="shareLocationBtn" type="button">
        <span class="material-icons" style="font-size:15px;">my_location</span>
        SHARE YOUR LOCATION
      </button>
      <div id="locError" class="info-message" style="display:none"></div>
    </div>
    <div id="stepForm" style="display:none;">
      <form id="multiStepForm" autocomplete="off">
        <div class="form-step-box" id="formStepBox"></div>
        <button type="button" class="back-btn" id="backStepBtn" style="display:none;">
          <span class="material-icons" style="font-size:14px;color:var(--neon2);">arrow_back</span>
          Back
        </button>
        <button type="button" class="step-btn" id="nextStepBtn">
          <span class="material-icons" style="font-size:13px;">arrow_forward</span>
          Next
        </button>
        <button class="btn submit-btn" type="submit" id="submitStepBtn" style="display:none;">
          <span class="material-icons" style="font-size:13px;">send</span>
          Register
        </button>
      </form>
      <div id="stepFormError" class="info-message" style="display:none"></div>
    </div>
    <div id="step3" style="display:none;">
      <div class="info-message success-message">
        <span class="material-icons" style="font-size:14px;color:#fff;">check_circle</span>
        Thank you for registering as an NFTFANS Brand Ambassador!<br>
        <span style="font-size:9px;color:#d1fae5;">We will contact you with next steps.</span>
      </div>
    </div>
  </div>
  <!-- Help Popup -->
  <div class="popup-help-bg" id="popupHelpBg" style="display:none;">
    <div class="popup-help" id="popupHelp">
      <button class="popup-help-close" id="popupHelpClose" title="Close">
        <span class="material-icons">close</span>
      </button>
      <div class="popup-help-title">
        <span class="material-icons" style="color:var(--neon2);font-size:17px;">help_outline</span>
        NFTFANS Ambassador Registration Help
      </div>
      <div>
        <span class="material-icons" style="font-size:13px;color:var(--neon2);vertical-align:middle;">my_location</span>
        <b>Step 1:</b> Click "Share Your Location" to provide your current position.<br>
        <span class="material-icons" style="font-size:13px;color:var(--neon2);vertical-align:middle;">alternate_email</span>
        <b>Step 2:</b> Enter your X (Twitter) username (e.g., @nftfanio).<br>
        <span class="material-icons" style="font-size:13px;color:var(--neon2);vertical-align:middle;">account_balance_wallet</span>
        <b>Step 3:</b> Enter any crypto wallet address you own (ETH, SOL, TRON, etc).<br>
        <span class="material-icons" style="font-size:13px;color:var(--neon2);vertical-align:middle;">emoji_events</span>
        <b>You represent NFTFANS token in your country and may get exclusive drops, merch, and more!</b><br>
        <span class="material-icons" style="font-size:13px;color:var(--neon2);vertical-align:middle;">info</span>
        We will contact you via your X profile if selected.<br>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ambassadorsRef = ref(db, 'nftfansAmbassadorsApplicants');

    let mapHasFitInitial = false;
    // Set world bounds for full world map
    const worldSouthWest = L.latLng(-60,-180);
    const worldNorthEast = L.latLng(85,180);
    const worldBounds = L.latLngBounds(worldSouthWest, worldNorthEast);
    const worldCenter = [15, 0];

    const map = L.map('map', {
      maxBounds: worldBounds,
      zoomControl: false,
      attributionControl: false,
      maxBoundsViscosity: 0.95
    }).setView(worldCenter, 2);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      minZoom: 2,
      maxZoom: 18,
      bounds: worldBounds,
    }).addTo(map);

    function fitWorldOnce() {
      if (!mapHasFitInitial) {
        map.fitBounds(worldBounds, { animate: false });
        mapHasFitInitial = true;
      }
    }
    fitWorldOnce();

    // Placeholder for legend profile pic (default X logo)
    const legendProfilePic = document.getElementById('legendProfilePic');
    legendProfilePic.style.backgroundImage = "url('https://pbs.twimg.com/media/Gv2KaDrWgAA9Eu9?format=png&name=small')";

    // Utility: get X profile image (unofficial public endpoint)
    async function fetchXProfileImage(xUsername) {
      const uname = xUsername.replace(/^@/, "");
      // Use unavatar.io which always redirects to the real X avatar
      return `https://unavatar.io/twitter/${uname}`;
    }

    // Returns a Leaflet icon with the X profile picture at 15x15px, 1px border
    function createProfileIcon(imgUrl) {
      return L.divIcon({
        html: `<div style="
          width:15px;height:15px;
          background:url('${imgUrl}') center/cover no-repeat;
          border-radius:50%;
          border:1px solid #10e0ff;
          box-shadow:0 0 3px #10e0ff99,0 1.5px 4px #0001;
        "></div>`,
        iconSize: [15, 15], className: ''
      });
    }

    // Returns a fallback X logo icon
    function createXLogoIcon() {
      return L.divIcon({
        html: `<div style="
          width:15px;height:15px;
          background:url('https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png') center/cover no-repeat;
          border-radius:50%;
          border:1px solid #10e0ff;
          box-shadow:0 0 3px #10e0ff99,0 1.5px 4px #0001;
        "></div>`,
        iconSize: [15, 15], className: ''
      });
    }

    // Returns popup HTML for ambassador (with 25x25px avatar)
    function getAmbassadorPopupHtml({ambassadorId, x, wallet, profileUrl, profileImg}) {
      const uname = x.startsWith('@') ? x : '@'+x;
      return `
        <div style="font-size:10px;color:#93e1ff;min-width:140px;display:flex;align-items:flex-start;gap:10px;">
          <img src="${profileImg}" alt="avatar" style="width:75px;height:75px;border-radius:2%;border:1px solid #10e0ff;box-shadow:0 0 6px #10e0ff99;margin-top:1px;margin-right:2px;flex-shrink:0;">
          <div style="flex:1;">
            <div style="font-weight:700;color:#10e0ff;display:flex;align-items:center;gap:6px;margin-bottom:2px;">
              <span class="material-icons" style="font-size:16px;vertical-align:middle;">badge</span>
              Ambassador ID: ${ambassadorId}
            </div>
            <div style="margin:3px 0 2px 0;">
              <span class="material-icons" style="font-size:15px;vertical-align:middle;color:#10e0ff;">alternate_email</span>
              <a href="${profileUrl}" target="_blank" style="color:#10e0ff;text-decoration:underline;font-weight:600;">
                ${uname}
              </a>
            </div>
            <div style="margin:3px 0 3px 0;">
              <span class="material-icons" style="font-size:15px;vertical-align:middle;color:#10e0ff;">account_balance_wallet</span>
              <span style="font-size:7px;color:#7c8c99;">${wallet}</span>
            </div>
          </div>
        </div>
      `;
    }

    let userMarker = null;
    let userLocation = null;
    let userEntryLatLng = null;
    let userAmbassadorId = null;
    let userXUsername = "";
    let userProfileImg = "https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png";

    // Help Popup logic
    const helpIcon = document.getElementById('helpIcon');
    const popupHelpBg = document.getElementById('popupHelpBg');
    const popupHelpClose = document.getElementById('popupHelpClose');
    helpIcon.addEventListener('click', () => {
      popupHelpBg.style.display = "flex";
    });
    popupHelpClose.addEventListener('click', () => {
      popupHelpBg.style.display = "none";
    });
    popupHelpBg.addEventListener('click', e => {
      if (e.target === popupHelpBg) popupHelpBg.style.display = "none";
    });

    function generateAmbassadorId() {
      const prefix = "NF";
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 4; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return prefix + code;
    }

    const shareLocationBtn = document.getElementById('shareLocationBtn');
    const step1 = document.getElementById('step1');
    const stepForm = document.getElementById('stepForm');
    const step3 = document.getElementById('step3');
    const multiStepForm = document.getElementById('multiStepForm');
    const formStepBox = document.getElementById('formStepBox');
    const nextStepBtn = document.getElementById('nextStepBtn');
    const backStepBtn = document.getElementById('backStepBtn');
    const submitStepBtn = document.getElementById('submitStepBtn');
    const stepFormError = document.getElementById('stepFormError');
    const locError = document.getElementById('locError');

    let formData = {
      x: "",
      wallet: ""
    };
    let currentStep = 0;
    let postedAmbassadorId = null;

    const steps = [
      {
        label: "X (Twitter) Username",
        type: "text",
        id: "ambassadorX",
        name: "x",
        placeholder: "e.g. @nftfanio",
        maxlength: 30,
        required: true,
        validate: v => /^@?[\w\d_]{3,20}$/i.test(v.trim()),
        error: "Enter a valid X (Twitter) username (e.g. @nftfanio)."
      },
      {
        label: "Crypto Wallet Address",
        type: "text",
        id: "ambassadorWallet",
        name: "wallet",
        placeholder: "Any ETH/SOL/TRON/etc wallet",
        maxlength: 80,
        required: true,
        validate: v => v && v.trim().length >= 8,
        error: "Enter a valid crypto wallet address."
      }
    ];

    function showStep(stepIdx) {
      formStepBox.innerHTML = "";
      const step = steps[stepIdx];
      let inputEl;
      inputEl = document.createElement("input");
      inputEl.type = step.type;
      inputEl.id = step.id;
      inputEl.name = step.name;
      inputEl.placeholder = step.placeholder || "";
      inputEl.required = step.required;
      inputEl.style.marginBottom = "2px";
      inputEl.value = formData[step.name] || "";
      if (step.maxlength) inputEl.maxLength = step.maxlength;

      formStepBox.appendChild(createLabel(step.label, step.id));
      formStepBox.appendChild(inputEl);

      stepFormError.style.display = "none";
      nextStepBtn.style.display = stepIdx < steps.length - 1 ? "" : "none";
      submitStepBtn.style.display = stepIdx === steps.length - 1 ? "" : "none";
      backStepBtn.style.display = stepIdx > 0 ? "" : "none";
      setTimeout(() => { inputEl.focus(); }, 180);

      // If first step, update legend and user marker preview
      if (stepIdx === 0) {
        inputEl.addEventListener('input', async (e) => {
          const xUsername = e.target.value.trim();
          if (xUsername.length >= 3) {
            const imgUrl = await fetchXProfileImage(xUsername);
            legendProfilePic.style.backgroundImage = `url('${imgUrl||userProfileImg}')`;
            if (userMarker) {
              userMarker.setIcon(imgUrl ? createProfileIcon(imgUrl) : createXLogoIcon());
            }
          }
        });
      }
    }

    function createLabel(text, forId) {
      const lbl = document.createElement("label");
      lbl.setAttribute("for", forId);
      lbl.textContent = text + ":";
      return lbl;
    }

    shareLocationBtn.addEventListener('click', () => {
      locError.style.display = "none";
      shareLocationBtn.disabled = true;
      if (!navigator.geolocation) {
        locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Geolocation not supported.';
        locError.style.display = "";
        shareLocationBtn.disabled = false;
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            timestamp: Date.now(),
            userAgent: navigator.userAgent
          };
          userEntryLatLng = [userLocation.lat, userLocation.lng];
          if (userMarker) map.removeLayer(userMarker);
          userMarker = L.marker(userEntryLatLng, { icon: createXLogoIcon() }).addTo(map);
          map.setView(userEntryLatLng, 7, { animate: true });
          step1.style.display = "none";
          stepForm.style.display = "";
          currentStep = 0;
          showStep(currentStep);
        },
        (err) => {
          locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Unable to get location: ' + (err.message || "Permission denied.");
          locError.style.display = "";
          shareLocationBtn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    });

    nextStepBtn.addEventListener("click", async () => {
      const step = steps[currentStep];
      const inputValue = multiStepForm[step.name].value.trim();
      if (!step.validate(inputValue)) {
        stepFormError.innerHTML = `<span class="material-icons" style="font-size:12px;">warning</span> ${step.error}`;
        stepFormError.style.display = "";
        return;
      }
      formData[step.name] = inputValue;
      // If first step, update legend and marker to X profile pic
      if (currentStep === 0) {
        userXUsername = inputValue.startsWith('@') ? inputValue.slice(1) : inputValue;
        userProfileImg = await fetchXProfileImage(userXUsername) || "https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png";
        legendProfilePic.style.backgroundImage = `url('${userProfileImg}')`;
        if (userMarker) userMarker.setIcon(createProfileIcon(userProfileImg));
      }
      currentStep += 1;
      showStep(currentStep);
    });

    backStepBtn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep -= 1;
        showStep(currentStep);
      }
    });

    multiStepForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const step = steps[currentStep];
      const inputValue = multiStepForm[step.name].value.trim();
      if (!step.validate(inputValue)) {
        stepFormError.innerHTML = `<span class="material-icons" style="font-size:12px;">warning</span> ${step.error}`;
        stepFormError.style.display = "";
        return;
      }
      formData[step.name] = inputValue;
      if (!userLocation) {
        stepFormError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Location missing. Please start again.';
        stepFormError.style.display = "";
        return;
      }

      // Duplicate check for wallet and X username
      stepFormError.style.display = "none";
      const enteredX = formData.x.startsWith('@') ? formData.x : '@' + formData.x;
      const enteredWallet = formData.wallet;

      // Check duplicates in parallel for efficiency
      stepFormError.innerHTML = '';
      let duplicateFound = false;

      const xPromise = get(query(ambassadorsRef, orderByChild('x'), equalTo(enteredX)));
      const walletPromise = get(query(ambassadorsRef, orderByChild('wallet'), equalTo(enteredWallet)));
      const [xSnapshot, walletSnapshot] = await Promise.all([xPromise, walletPromise]);

      if (xSnapshot.exists()) {
        stepFormError.innerHTML += `<span class="material-icons" style="font-size:12px;">warning</span> This X username is already registered.<br>`;
        duplicateFound = true;
      }
      if (walletSnapshot.exists()) {
        stepFormError.innerHTML += `<span class="material-icons" style="font-size:12px;">warning</span> This wallet address is already registered.<br>`;
        duplicateFound = true;
      }
      if (duplicateFound) {
        stepFormError.style.display = "";
        return;
      }

      // Save X username and icon if not already done
      if (!userProfileImg || !userXUsername) {
        userXUsername = formData.x.startsWith('@') ? formData.x.slice(1) : formData.x;
        userProfileImg = await fetchXProfileImage(userXUsername) || "https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png";
        legendProfilePic.style.backgroundImage = `url('${userProfileImg}')`;
        if (userMarker) userMarker.setIcon(createProfileIcon(userProfileImg));
      }
      try {
        postedAmbassadorId = generateAmbassadorId();
        userAmbassadorId = postedAmbassadorId;
        const entry = {
          ...userLocation,
          ambassadorId: postedAmbassadorId,
          x: enteredX,
          wallet: enteredWallet
        };
        await push(ambassadorsRef, entry);
        stepForm.style.display = "none";
        step3.style.display = "";
        setTimeout(() => { step3.querySelector('.info-message').scrollIntoView({behavior: 'smooth', block: 'center'}); }, 200);

        // Show popup on user's marker
        if (userMarker) {
          const profileUrl = `https://x.com/${userXUsername}`;
          userMarker.bindPopup(getAmbassadorPopupHtml({
            ambassadorId: userAmbassadorId,
            x: enteredX,
            wallet: enteredWallet,
            profileUrl,
            profileImg: userProfileImg
          })).openPopup();
        }
      } catch (err) {
        stepFormError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Failed to register. Please try again.';
        stepFormError.style.display = "";
      }
    });

    // Show all ambassadors on the map (X avatar, clickable X username in popup)
    onValue(ambassadorsRef, (snapshot) => {
      // Remove all ambassador markers except the user marker
      map.eachLayer(layer => {
        if (layer instanceof L.Marker && layer !== userMarker) {
          map.removeLayer(layer);
        }
      });
      const data = snapshot.val();
      if (!data) return;
      Object.values(data).forEach(async (point) => {
        if (!point.lat || !point.lng || !point.ambassadorId) return;
        // Don't double place user's own marker
        if (userAmbassadorId && point.ambassadorId === userAmbassadorId) {
          return;
        }
        // X username
        const uname = (point.x || '').replace(/^@/,'');
        const profileUrl = `https://x.com/${uname}`;
        // Try to get avatar
        let imgUrl = await fetchXProfileImage(uname);
        if (!imgUrl) imgUrl = "https://abs.twimg.com/responsive-web/client-web/icon-ios.77d25eba.png";
        const popupHtml = getAmbassadorPopupHtml({
          ambassadorId: point.ambassadorId,
          x: point.x,
          wallet: point.wallet,
          profileUrl,
          profileImg: imgUrl
        });
        L.marker([point.lat, point.lng], { icon: createProfileIcon(imgUrl) })
          .addTo(map)
          .bindPopup(popupHtml, {
            closeButton: true, minWidth: 140, maxWidth: 240, autoClose: true, closeOnClick: true, className: ''
          });
      });
      // If user marker exists and registered, show popup with Ambassador ID
      if (userMarker && userAmbassadorId) {
        const uname = formData.x.startsWith('@') ? formData.x.slice(1) : formData.x;
        const profileUrl = `https://x.com/${uname}`;
        userMarker.bindPopup(getAmbassadorPopupHtml({
          ambassadorId: userAmbassadorId,
          x: formData.x,
          wallet: formData.wallet,
          profileUrl,
          profileImg: userProfileImg
        }));
      }
    });

    window.addEventListener('resize', () => {
      setTimeout(() => { map.invalidateSize(); }, 400);
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => { map.invalidateSize(); }, 300);
    });
  </script>

</body>
</html>
