<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ONLY NFTFANS // ONFT</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

  <style>
    :root{
      --bg: #9bd4f1;
      --surface: rgba(255,255,255,.86);
      --surface-strong: rgba(255,255,255,.96);
      --stroke: rgba(15, 23, 42, .12);
      --stroke-strong: rgba(15, 23, 42, .18);

      --text: #0b1221;
      --muted: rgba(11, 18, 33, .64);

      --primary: #6d28d9;
      --primary2:#06b6d4;

      --ok: #16a34a;
      --err:#ef4444;

      --radius: 16px;
      --radius2: 14px;

      --fs: 12px;
      --fw: 800; /* desktop */
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 480px at 15% 15%, rgba(109,40,217,.14), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(6,182,212,.11), transparent 62%),
        var(--bg);
      color:var(--text);
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    .walletbar{
      position: sticky;
      top: 0;
      z-index: 50;
      width: 100%;
      background: rgba(255,255,255,.82);
      border-bottom: 1px solid var(--stroke);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .walletbar-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      min-width: 0;
    }
    .wallet-left{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 240px;
    }
    .wallet-right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 240px;
    }

    .titlebar{
      width: 100%;
      background: #fff;
      border-bottom: 1px solid var(--stroke);
    }
    .titlebar-inner{
      max-width: 1120px;
      margin: 0 auto;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      min-width: 0;
    }
    .title-left{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 240px;
    }
    .title-logo{
      width: 26px;
      height: 26px;
      border-radius: 10px;
      overflow:hidden;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.96);
      flex: 0 0 auto;
    }
    .title-logo img{width:100%;height:100%;object-fit:cover;display:block}
    .title-text{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 0px;
    }
    .title-main{
      font-size: var(--fs);
      font-weight: var(--fw);
      letter-spacing: .2px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.05;
      max-width: 100%;
    }
    .title-sub{
      font-size: var(--fs);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      min-width: 0;
    }
    .title-sub i{font-size: 16px; flex: 0 0 auto;}

    .title-right{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      min-width: 0;
      max-width: 100%;
      flex: 1 1 240px;
    }

    .banner{
      width: 100%;
      background: #ffffff;
      border-bottom: 1px solid var(--stroke);
    }
    .banner img{
      width: 100%;
      height: auto;
      display:block;
      max-height: 180px;
      object-fit: cover;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 10px 26px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: var(--surface-strong);
      font-size: var(--fs);
      color: var(--muted);
      white-space: nowrap;
      min-width: 0;
      max-width: 100%;
    }
    .pill i{font-size: 16px; color: rgba(11,18,33,.55); flex: 0 0 auto;}
    .pill b{
      color: var(--text);
      font-weight: var(--fw);
      font-size: var(--fs);
    }
    .pill small{font-size: var(--fs); opacity: .9}

    .marketbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: var(--surface);
      margin-bottom: 10px;
      flex-wrap: wrap;
      min-width: 0;
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .market-left, .market-right{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
      min-width: 0;
      max-width: 100%;
    }
    .ticker{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.96);
      font-size: var(--fs);
      font-weight: var(--fw);
      letter-spacing: .2px;
      text-transform: uppercase;
      min-width: 0;
      max-width: 100%;
    }
    .ticker i{font-size: 16px; color: rgba(109,40,217,.95); flex:0 0 auto;}
    .ticker span{white-space:nowrap; overflow:hidden; text-overflow: ellipsis; min-width: 0;}

    .btn{
      appearance:none;
      border: 1px solid var(--stroke-strong);
      background: rgba(255,255,255,.96);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 999px;
      font-weight: var(--fw);
      font-size: var(--fs);
      letter-spacing: .1px;
      display:inline-flex;
      align-items:center;
      gap: 6px;
      cursor:pointer;
      transition: transform .10s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      min-width: 0;
      max-width: 100%;
      will-change: transform;
    }
    .btn i{font-size: 16px; flex: 0 0 auto;}
    .btn span{white-space: nowrap; overflow:hidden; text-overflow: ellipsis; min-width: 0;}
    .btn:hover:not(:disabled){filter: brightness(0.985); transform: translateY(-1px);}
    .btn:active:not(:disabled){filter: brightness(0.97); transform: translateY(0px);}
    .btn-primary{border: 0; color: white; background: linear-gradient(135deg, var(--primary), var(--primary2)); box-shadow: 0 10px 20px rgba(109,40,217,.18);}
    .btn:disabled{opacity: .45; cursor:not-allowed; filter: grayscale(1) saturate(.2); box-shadow:none;}

    .controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 10px;
      padding: 10px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: var(--surface);
      flex-wrap: wrap;
      min-width: 0;
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .left-controls{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      min-width: 0;
    }
    .label{
      font-size: var(--fs);
      color: var(--muted);
      font-weight: var(--fw);
      letter-spacing: .2px;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap: 6px;
      white-space: nowrap;
    }
    .label i{font-size: 16px}
    .select{
      border: 1px solid var(--stroke-strong);
      background: rgba(255,255,255,.96);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-weight: var(--fw);
      font-size: var(--fs);
      outline: none;
      cursor:pointer;
      max-width: 100%;
      transition: filter .12s ease, transform .10s ease;
    }
    .select:hover{filter: brightness(0.985); transform: translateY(-1px);}
    .select:active{transform: translateY(0px);}

    .status{
      margin: 0 0 10px;
      border: 1px solid var(--stroke);
      background: var(--surface-strong);
      border-radius: var(--radius);
      padding: 10px 10px;
      display:flex;
      gap: 8px;
      align-items:flex-start;
      min-width: 0;
      box-shadow: 0 10px 24px rgba(15,23,42,.05);
    }
    .status i{font-size: 18px; margin-top: 1px; color: rgba(11,18,33,.55);}
    .status .msg{font-size: var(--fs); color: var(--muted); line-height: 1.35; overflow-wrap:anywhere;}
    .status.ok{border-color: rgba(22,163,74,.22); background: rgba(22,163,74,.08);}
    .status.ok i{color: rgba(22,163,74,.9)}
    .status.err{border-color: rgba(239,68,68,.24); background: rgba(239,68,68,.08);}
    .status.err i{color: rgba(239,68,68,.95)}

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      min-width: 0;
    }
    .card{
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.78);
      overflow:hidden;
      min-width: 0;
      box-shadow: 0 12px 26px rgba(15,23,42,.06);
      transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
      will-change: transform;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(15,23,42,.10);
      filter: saturate(1.02);
    }
    .media{
      width: 100%;
      aspect-ratio: 1/1;
      background: rgba(255,255,255,.72);
      border-bottom: 1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:center;
      min-width: 0;
    }
    .media img, .media video{width:100%;height:100%;object-fit:contain;display:block;background:transparent}

    .body{
      padding: 8px 8px 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      min-width: 0;
    }
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 6px;
      min-width: 0;
    }
    .title{
      font-weight: var(--fw);
      letter-spacing: .1px;
      font-size: var(--fs);
      text-transform: uppercase;
      color: var(--text);
      max-width: 70%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.1;
      min-width: 0;
    }
    .price{
      display:flex;
      align-items:center;
      gap: 4px;
      font-weight: var(--fw);
      font-size: var(--fs);
      color: rgba(11,18,33,.82);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .price i{font-size: 16px; color: rgba(6,182,212,.95)}
    .qty{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .qty label{
      font-size: var(--fs);
      color: var(--muted);
      font-weight: var(--fw);
      text-transform: uppercase;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .qty input{
      width: 110px;
      padding: 8px 10px;
      border: 1px solid var(--stroke-strong);
      border-radius: 12px;
      background: rgba(255,255,255,.96);
      font-weight: var(--fw);
      font-size: var(--fs);
      outline: none;
      text-align: right;
    }

    .mint{
      width: 100%;
      justify-content:center;
      padding: 9px 10px;
      border-radius: 14px;
    }

    .skeleton{
      border-radius: var(--radius2);
      border: 1px dashed rgba(15,23,42,.15);
      background: rgba(255,255,255,.7);
      padding: 12px;
      color: var(--muted);
      font-size: var(--fs);
      grid-column: 1 / -1;
    }

    .fade-in{ animation: fadeIn .22s ease both; }
    @keyframes fadeIn{ from{opacity:.0; transform: translateY(2px);} to{opacity:1; transform:none;} }

    @media (max-width: 980px){ .grid{grid-template-columns: repeat(3, minmax(0, 1fr));} }

    @media (max-width: 720px){
      :root{ --fs: 10px; --fw: 400; }
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .pill i, .ticker i, .btn i, .label i, .title-sub i{font-size: 14px;}
      .wrap{padding: 10px 8px 22px;}
      .marketbar, .controls, .status{padding: 8px 8px;}
      .btn{padding: 8px 9px;}
      .select{padding: 8px 9px;}
      .banner img{max-height: 140px;}
      .titlebar-inner{padding: 7px 8px;}
      .walletbar-inner{padding: 8px 8px;}
      .qty input{width: 96px; padding: 7px 9px;}
    }

    .wrap, .marketbar, .controls, .status, .grid, .card, .body, .row{max-width:100%; min-width:0;}
    a{color:inherit}
  </style>
</head>

<body>
  <div class="walletbar">
    <div class="walletbar-inner">
      <div class="wallet-left">
        <div id="addrChip" class="pill" title="Wallet status">
          <i class="material-icons-round">link_off</i>
          <small>WALLET</small><b id="addrText">Disconnected</b>
        </div>
      </div>

      <div class="wallet-right">
        <button id="connectBtn" class="btn btn-primary">
          <i class="material-icons-round">account_balance_wallet</i>
          <span>Connect wallet</span>
        </button>
      </div>
    </div>
  </div>

  <div class="titlebar">
    <div class="titlebar-inner">
      <div class="title-left">
        <div class="title-logo" aria-hidden="true">
          <img src="https://pbs.twimg.com/media/G-jogd7XMAEyCGj?format=jpg&name=medium" alt="NFTFAN">
        </div>
        <div class="title-text">
          <div class="title-main">BUY WITH NFTFAN TOKEN</div>
          <div class="title-sub">
            <i class="material-icons-round">public</i>
            <span>Polygon Mainnet</span>
          </div>
          <!-- NEW: show NFTFAN balance -->
          <div class="title-sub" id="balanceLine" style="display:none;">
            <i class="material-icons-round">account_balance</i>
            <span>Balance: <b id="nftfanBalance">—</b> NFTFAN</span>
          </div>
        </div>
      </div>

      <div class="title-right">
        <a class="pill" href="https://polygonscan.com/address/0x35049d172e22883546B9E99e6C2c08267163Ceac" target="_blank" rel="noreferrer" style="text-decoration:none;">
          <i class="material-icons-round">open_in_new</i>
          <small>SCAN</small><b>CONTRACT</b>
        </a>
      </div>
    </div>
  </div>

  <div class="banner">
    <img src="https://i.postimg.cc/J4x6VnSB/image.png" alt="NFTFAN banner">
  </div>

  <div class="wrap">
    <div class="marketbar fade-in">
      <div class="market-left">
        <div class="ticker" title="Display only">
          <i class="material-icons-round">candlestick_chart</i>
          <span>NFTFAN MARKET</span>
        </div>

        <!-- Fake Vol starts at 50,000 trillion -->
        <div class="pill" title="Display only">
          <i class="material-icons-round">swap_vert</i>
          <small>VOL</small><b id="fakeVol">50,000T</b><small>NFTFAN</small>
        </div>

        <div class="pill" title="Display only">
          <i class="material-icons-round">trending_up</i>
          <small>FLOOR</small><b id="fakeFloor">0.000</b><small>NFTFAN</small>
        </div>

        <!-- NEW: show total copies owned (across all NFTs) -->
        <div class="pill" title="Your total copies owned (sum across all tokenIds)">
          <i class="material-icons-round">layers</i>
          <small>YOU OWN</small><b id="youOwnTotal">—</b>
        </div>
      </div>

      <div class="market-right">
        <div class="pill" title="Token types created (from contract)">
          <i class="material-icons-round">verified</i>
          <small>ITEMS</small><b id="mintedCount">—</b>
        </div>

        <!-- Fake holders starts at 1200 -->
        <div class="pill" title="Display only">
          <i class="material-icons-round">people</i>
          <small>HOLDERS</small><b id="fakeHolders">1,200</b>
        </div>

        <div class="pill" title="Display only">
          <i class="material-icons-round">inventory_2</i>
          <small>LISTED</small><b id="fakeItems">0</b>
        </div>

        <div class="pill" title="Display only">
          <i class="material-icons-round">bolt</i>
          <small>24H</small><b id="fake24h">+0.0%</b>
        </div>

        <a class="pill" id="scanLink" href="#" target="_blank" rel="noreferrer" style="text-decoration:none;" title="View contract">
          <i class="material-icons-round">open_in_new</i>
          <small>SCAN</small><b>VIEW</b>
        </a>
      </div>
    </div>

    <div class="controls fade-in">
      <div class="left-controls">
        <div class="label"><i class="material-icons-round">sort</i> Sort</div>
        <select id="sortSelect" class="select">
          <option value="date_desc">Newest</option>
          <option value="date_asc">Oldest</option>
          <option value="price_desc">Price: High → Low</option>
          <option value="price_asc">Price: Low → High</option>
        </select>
      </div>

      <div class="label" style="gap:6px;">
        <i class="material-icons-round">info</i>
        <span>Unlimited copies per NFT</span>
      </div>
    </div>

    <div id="status" class="status fade-in">
      <i class="material-icons-round">bolt</i>
      <div class="msg" id="statusMsg">System ready.</div>
    </div>

    <div id="grid" class="grid">
      <div class="skeleton">Loading collection…</div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
      authDomain: "tokentransfer-4a9b3.firebaseapp.com",
      databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
      projectId: "tokentransfer-4a9b3",
      storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
      messagingSenderId: "205455490321",
      appId: "1:205455490321:web:9919f5dde059316c9320b0",
      measurementId: "G-Y6CVEDL9XH"
    };

    // Must match admin dataset
    const COLLECTION_PATH = "nfts_2026";

    // NEW collection CA
    const CONTRACT_ADDRESS = "0x35049d172e22883546B9E99e6C2c08267163Ceac";

    const NFTFAN_TOKEN_ADDRESS = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const NFTFAN_DECIMALS = 18;

    const EXPECTED_CHAIN_ID = 137;
    const READ_RPC = "https://polygon-rpc.com";

    // Minimal ABI we actually use (avoid "is not a function")
    const CONTRACT_ABI = [
      "function mint(string tokenURI_, uint256 pricePerCopy, uint256 amount)",
      "function totalTokenTypesCreated() view returns (uint256)",
      "function uriToTokenId(bytes32 uriHash) view returns (uint256)",
      "function balanceOf(address account, uint256 id) view returns (uint256)"
    ];

    const ERC20_ABI = [
      "function approve(address spender, uint256 amount) returns (bool)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function balanceOf(address owner) view returns (uint256)"
    ];

    const POLYGON_PARAMS = {
      chainId: "0x89",
      chainName: "Polygon Mainnet",
      nativeCurrency: { name: "POL", symbol: "POL", decimals: 18 },
      rpcUrls: [READ_RPC],
      blockExplorerUrls: ["https://polygonscan.com"]
    };

    const app = firebase.apps?.length ? firebase.app() : firebase.initializeApp(firebaseConfig);
    const db = app.database();

    let provider = null;
    let signer = null;
    let contract = null;
    let userAddress = null;
    let nftfan = null;

    const readProvider = new ethers.JsonRpcProvider(READ_RPC);
    const readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

    let currentEntries = [];
    const mintingSet = new Set();

    const tokenIdCache = new Map();  // uri -> tokenId (bigint)
    const balanceCache = new Map();  // uri -> balance (bigint)

    const gridEl = document.getElementById("grid");
    const connectBtn = document.getElementById("connectBtn");
    const addrText = document.getElementById("addrText");
    const sortSelect = document.getElementById("sortSelect");
    const statusWrap = document.getElementById("status");
    const statusMsg = document.getElementById("statusMsg");

    const fakeVolEl = document.getElementById("fakeVol");
    const fakeFloorEl = document.getElementById("fakeFloor");
    const fakeHoldersEl = document.getElementById("fakeHolders");
    const fakeItemsEl = document.getElementById("fakeItems");
    const fake24hEl = document.getElementById("fake24h");
    const itemsCountEl = document.getElementById("mintedCount");
    const scanLinkEl = document.getElementById("scanLink");

    const youOwnTotalEl = document.getElementById("youOwnTotal");
    const balanceLineEl = document.getElementById("balanceLine");
    const nftfanBalanceEl = document.getElementById("nftfanBalance");

    function setStatus(message, kind = "") {
      statusWrap.className = `status ${kind}`.trim();
      const icon = statusWrap.querySelector("i");
      if (icon) icon.textContent = kind === "ok" ? "check_circle" : kind === "err" ? "error" : "bolt";
      statusMsg.textContent = message;
    }

    function shorten(addr) { return addr ? addr.slice(0, 6) + "…" + addr.slice(-4) : "—"; }

    function setWalletUI(connected) {
      const chipIcon = document.querySelector("#addrChip i");
      if (connected && userAddress) {
        chipIcon.textContent = "link";
        addrText.textContent = shorten(userAddress);
      } else {
        chipIcon.textContent = "link_off";
        addrText.textContent = "Disconnected";
      }
    }

    function isLikelyVideo(url) {
      if (!url) return false;
      const videoExts = [".mp4", ".webm", ".ogg", ".mov", ".m4v"];
      const lower = url.split("?")[0].toLowerCase();
      return videoExts.some(ext => lower.endsWith(ext))
        || lower.includes("video")
        || (lower.startsWith("https://coming-blush-wolverine.myfilebase.com/ipfs/") && !/\.(png|jpg|jpeg|gif|svg|webp)\b/i.test(lower));
    }

    // Display: K/M/B/T (for prices + balances)
    function formatCompactNumber(value) {
      const n = typeof value === "number" ? value : Number(String(value).replace(/,/g, ""));
      if (!Number.isFinite(n)) return String(value ?? "—");
      const abs = Math.abs(n);
      const sign = n < 0 ? "-" : "";
      const fmt = (x, suf) => sign + x.toFixed(2).replace(/\.?0+$/, "") + suf;

      if (abs >= 1e12) return fmt(abs / 1e12, "T");
      if (abs >= 1e9)  return fmt(abs / 1e9,  "B");
      if (abs >= 1e6)  return fmt(abs / 1e6,  "M");
      if (abs >= 1e3)  return fmt(abs / 1e3,  "K");
      return sign + abs.toLocaleString(undefined, { maximumFractionDigits: 6 });
    }

    function seedFromString(str) {
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) { h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
      return (h >>> 0);
    }

    // Fake stats: VOL starts 50,000T and HOLDERS starts 1200 (as requested)
    function initFakeMarketStats(itemsCount) {
      // keep your base values, add tiny drift so it moves
      const seed = seedFromString(CONTRACT_ADDRESS + ":" + itemsCount);
      const drift = (seed % 9000) / 100; // 0..90
      fakeVolEl.textContent = `${(50000 + drift).toLocaleString()}T`;
      fakeFloorEl.textContent = (0.08 + ((seed % 240) / 1000)).toFixed(3);
      fakeHoldersEl.textContent = "1,200";
      fakeItemsEl.textContent = (itemsCount || 0).toLocaleString();
      const pct = ((seed % 260) / 10) - 6;
      fake24hEl.textContent = (pct >= 0 ? "+" : "") + pct.toFixed(1) + "%";
    }

    function animateFakeVolume() {
      // small wiggle but stays around 50,000T
      const base = 50000;
      const wiggle = (Math.sin(Date.now() / 8000) * 18) + (Math.sin(Date.now() / 19000) * 10);
      const v = base + wiggle;
      fakeVolEl.textContent = `${v.toLocaleString(undefined, { maximumFractionDigits: 2 })}T`;
    }

    async function switchToPolygon() {
      if (!window.ethereum) throw new Error("No wallet found");
      try {
        await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: POLYGON_PARAMS.chainId }] });
      } catch (err) {
        if (err && err.code === 4902) {
          await window.ethereum.request({ method: "wallet_addEthereumChain", params: [POLYGON_PARAMS] });
        } else {
          throw err;
        }
      }
    }

    async function connectWallet() {
      if (!window.ethereum) { setStatus("No Web3 wallet found.", "err"); throw new Error("No wallet"); }

      await switchToPolygon();

      provider = new ethers.BrowserProvider(window.ethereum, "any");
      const network = await provider.getNetwork();
      if (Number(network.chainId) !== EXPECTED_CHAIN_ID) {
        setStatus("Wrong network. Switch to Polygon Mainnet.", "err");
        throw new Error("Wrong network");
      }

      const accounts = await provider.send("eth_requestAccounts", []);
      signer = await provider.getSigner();
      userAddress = accounts[0];

      contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
      nftfan = new ethers.Contract(NFTFAN_TOKEN_ADDRESS, ERC20_ABI, signer);

      setWalletUI(true);
      return userAddress;
    }

    function installWalletListeners() {
      if (!window.ethereum) return;
      window.ethereum.on?.("accountsChanged", async (accounts) => {
        userAddress = (accounts && accounts[0]) ? accounts[0] : null;
        setWalletUI(!!userAddress);

        if (!userAddress) {
          balanceLineEl.style.display = "none";
          nftfanBalanceEl.textContent = "—";
          youOwnTotalEl.textContent = "—";
          balanceCache.clear();
        } else {
          await refreshUserStats();
        }
      });
      window.ethereum.on?.("chainChanged", () => {
        setStatus("Network changed. Refreshing…", "");
        setTimeout(() => window.location.reload(), 350);
      });
    }

    function toTokenUnitsFromHuman(priceHumanString) {
      const s = String(priceHumanString ?? "").trim();
      if (!s) return null;
      if (!/^\d+(\.\d+)?$/.test(s)) return null;
      return ethers.parseUnits(s, NFTFAN_DECIMALS);
    }

    function isReceiptSuccess(receipt) {
      if (!receipt) return false;
      const s = receipt.status;
      return s === 1 || s === "1" || s === 1n;
    }

    async function ensureAllowance(requiredAmount) {
      const allowance = await nftfan.allowance(userAddress, CONTRACT_ADDRESS);
      if (allowance >= requiredAmount) return;

      setStatus("Approve NFTFAN (one-time)…", "");
      const tx = await nftfan.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
      setStatus(`Approve TX sent… ${tx.hash.slice(0, 10)}…`, "");
      const receipt = await tx.wait();
      if (!isReceiptSuccess(receipt)) throw new Error("Approve not confirmed.");
    }

    async function getTokenIdForURI(tokenURI) {
      if (tokenIdCache.has(tokenURI)) return tokenIdCache.get(tokenURI);

      const uriHash = ethers.keccak256(ethers.toUtf8Bytes(tokenURI));
      const tokenId = await readContract.uriToTokenId(uriHash); // 0 if not created
      const idNum = typeof tokenId === "bigint" ? tokenId : BigInt(tokenId);

      tokenIdCache.set(tokenURI, idNum);
      return idNum;
    }

    async function refreshBalancesForEntries(entries) {
      if (!userAddress) return;

      const uris = entries
        .map(([_, d]) => (d?.imageUrl || "").trim())
        .filter(Boolean);

      // preload tokenIds + balances (wallet view only)
      const batchSize = 12;
      for (let i = 0; i < uris.length; i += batchSize) {
        const batch = uris.slice(i, i + batchSize);
        await Promise.all(batch.map(async (uri) => {
          try {
            const tokenId = await getTokenIdForURI(uri);
            if (tokenId === 0n) {
              balanceCache.set(uri, 0n);
              return;
            }
            const bal = await readContract.balanceOf(userAddress, tokenId);
            balanceCache.set(uri, bal);
          } catch {
            balanceCache.set(uri, 0n);
          }
        }));
      }
    }

    function computeYouOwnTotal() {
      let total = 0n;
      for (const v of balanceCache.values()) {
        if (typeof v === "bigint") total += v;
      }
      return total;
    }

    async function refreshUserStats() {
      if (!userAddress) return;

      // NFTFAN balance
      try {
        const bal = await nftfan.balanceOf(userAddress); // bigint (18 decimals)
        // show in “trillions” style: convert to human and compact (K/M/B/T)
        const human = ethers.formatUnits(bal, NFTFAN_DECIMALS);
        nftfanBalanceEl.textContent = formatCompactNumber(human);
        balanceLineEl.style.display = "flex";
      } catch {
        nftfanBalanceEl.textContent = "—";
        balanceLineEl.style.display = "none";
      }

      // Owned copies total (sum balances)
      try {
        await refreshBalancesForEntries(currentEntries);
        const totalCopies = computeYouOwnTotal();
        youOwnTotalEl.textContent = totalCopies.toString();
      } catch {
        youOwnTotalEl.textContent = "—";
      }
    }

    async function mint(tokenURI, priceHumanFromDB, copiesStr) {
      if (!tokenURI) { setStatus("Missing URI.", "err"); return; }

      const copies = BigInt(String(copiesStr || "1").replace(/[^\d]/g, "") || "0");
      if (copies <= 0n) { setStatus("Amount must be > 0", "err"); return; }

      const pricePerCopy = toTokenUnitsFromHuman(priceHumanFromDB);
      if (pricePerCopy === null || pricePerCopy <= 0n) { setStatus("Invalid price in database.", "err"); return; }

      const totalCost = pricePerCopy * copies;

      if (mintingSet.has(tokenURI)) return;
      mintingSet.add(tokenURI);
      renderList();

      try {
        setStatus("Connecting wallet…", "");
        await connectWallet();

        const bal = await nftfan.balanceOf(userAddress);
        if (bal < totalCost) {
          setStatus("Insufficient NFTFAN balance.", "err");
          return;
        }

        await ensureAllowance(totalCost);

        setStatus("Confirm mint in wallet…", "");
        let gasLimit = 700000n;
        try {
          const est = await contract.mint.estimateGas(tokenURI, pricePerCopy, copies);
          gasLimit = (est * 125n) / 100n;
        } catch (_) {}

        const tx = await contract.mint(tokenURI, pricePerCopy, copies, { gasLimit });
        setStatus(`TX sent… ${tx.hash.slice(0, 10)}…`, "");

        const receipt = await tx.wait();
        if (!isReceiptSuccess(receipt)) {
          setStatus("Confirmation pending. Check Polygonscan or your wallet.", "");
          return;
        }

        setStatus("Mint confirmed.", "ok");
        await refreshItemsCount();
        await refreshUserStats();
      } catch (err) {
        console.error(err);
        let msg = err?.info?.error?.message || err?.error?.message || err?.message || "Something went wrong.";
        if (/user rejected|rejected the request|denied transaction/i.test(msg)) msg = "Transaction rejected.";
        if (/insufficient funds/i.test(msg)) msg = "Insufficient gas (POL).";
        setStatus(msg, "err");
      } finally {
        mintingSet.delete(tokenURI);
        renderList();
      }
    }

    function renderCard(id, data) {
      const card = document.createElement("div");
      card.className = "card fade-in";

      const media = document.createElement("div");
      media.className = "media";

      const url = (data?.imageUrl || "").trim();
      if (isLikelyVideo(url)) {
        const video = document.createElement("video");
        video.src = url;
        video.setAttribute("controls", "controls");
        video.setAttribute("playsinline", "playsinline");
        video.setAttribute("preload", "metadata");
        media.appendChild(video);
      } else {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.decoding = "async";
        img.src = url;
        img.alt = (data?.title || "Asset");
        media.appendChild(img);
      }

      const body = document.createElement("div");
      body.className = "body";

      const row = document.createElement("div");
      row.className = "row";

      const title = document.createElement("div");
      title.className = "title";
      title.textContent = (data?.title || "Unknown").toUpperCase();

      const rawPriceHuman = (data?.price ?? "");
      const price = document.createElement("div");
      price.className = "price";
      const displayPrice = (rawPriceHuman !== null && typeof rawPriceHuman !== "undefined" && rawPriceHuman !== "")
        ? `${formatCompactNumber(rawPriceHuman)} NFTFAN`
        : "—";
      price.innerHTML = `<i class="material-icons-round">token</i><span>${displayPrice}</span>`;

      row.appendChild(title);
      row.appendChild(price);

      const qty = document.createElement("div");
      qty.className = "qty";

      const label = document.createElement("label");
      label.textContent = "COPIES";

      const input = document.createElement("input");
      input.type = "number";
      input.min = "1";
      input.step = "1";
      input.value = "1";
      input.inputMode = "numeric";

      qty.appendChild(label);
      qty.appendChild(input);

      const btn = document.createElement("button");
      btn.className = "btn btn-primary mint";

      const minting = mintingSet.has(url);
      btn.disabled = minting || !url || rawPriceHuman === "";
      btn.innerHTML = minting
        ? `<i class="material-icons-round">hourglass_top</i><span>Minting…</span>`
        : `<i class="material-icons-round">shopping_bag</i><span>Mint</span>`;

      btn.onclick = () => mint(url, String(rawPriceHuman), input.value);

      body.appendChild(row);
      body.appendChild(qty);
      body.appendChild(btn);

      card.appendChild(media);
      card.appendChild(body);
      return card;
    }

    function sortEntries(entries, mode) {
      return entries.slice().sort((a, b) => {
        const da = a[1]?.createdAt || 0, dbb = b[1]?.createdAt || 0;
        const pa = parseFloat(a[1]?.price || "0"), pb = parseFloat(b[1]?.price || "0");
        switch (mode) {
          case "date_asc": return da - dbb;
          case "price_desc": return pb - pa;
          case "price_asc": return pa - pb;
          case "date_desc":
          default: return dbb - da;
        }
      });
    }

    function renderList() {
      gridEl.innerHTML = "";
      const sorted = sortEntries(currentEntries, sortSelect.value);

      if (!sorted.length) {
        const empty = document.createElement("div");
        empty.className = "skeleton fade-in";
        empty.textContent = "No NFTs found in database.";
        gridEl.appendChild(empty);
        return;
      }
      sorted.forEach(([id, data]) => gridEl.appendChild(renderCard(id, data)));
    }

    async function refreshItemsCount() {
      try {
        const t = await readContract.totalTokenTypesCreated();
        itemsCountEl.textContent = String(t);
      } catch {
        itemsCountEl.textContent = "—";
      }
    }

    scanLinkEl.href = `https://polygonscan.com/address/${CONTRACT_ADDRESS}`;

    connectBtn.addEventListener("click", async () => {
      connectBtn.disabled = true;
      setStatus("Connecting…", "");
      try {
        await connectWallet();
        connectBtn.innerHTML = `<i class="material-icons-round">check</i><span>Connected</span>`;
        setStatus("Wallet connected.", "ok");
        await refreshUserStats();
      } catch (_) {
        setWalletUI(false);
        connectBtn.innerHTML = `<i class="material-icons-round">account_balance_wallet</i><span>Connect wallet</span>`;
      } finally {
        connectBtn.disabled = false;
      }
    });

    sortSelect.addEventListener("change", renderList);

    db.ref(COLLECTION_PATH).orderByChild("createdAt").on("value", async (snapshot) => {
      const val = snapshot.val();

      if (!val) {
        currentEntries = [];
        tokenIdCache.clear();
        balanceCache.clear();
        gridEl.innerHTML = "";
        initFakeMarketStats(0);
        refreshItemsCount();
        youOwnTotalEl.textContent = userAddress ? "0" : "—";
        setStatus("Database is empty.", "");
        return;
      }

      currentEntries = Object.entries(val);
      initFakeMarketStats(currentEntries.length);

      setStatus("Syncing…", "");
      renderList();
      await refreshItemsCount();

      // Preload token IDs so user stats can sum correctly after connect
      try {
        const uris = currentEntries.map(([_, d]) => (d?.imageUrl || "").trim()).filter(Boolean);
        await Promise.all(uris.map(u => getTokenIdForURI(u).catch(()=>0n)));
      } catch (e) {
        console.warn(e);
      }

      if (userAddress) {
        await refreshUserStats();
      }

      setStatus(`Loaded ${currentEntries.length} items.`, "ok");
    }, (err) => {
      console.error(err);
      setStatus("Database read error.", "err");
    });

    (async function boot(){
      installWalletListeners();
      setWalletUI(false);

      setInterval(animateFakeVolume, 1500);
      refreshItemsCount();
      setStatus("System ready.", "");
    })();
  </script>
</body>
</html>
