<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFT Circle Map — Draw a Circle (≤ 1 km) and Mint</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet" />
  <!-- Leaflet + Leaflet.draw via jsDelivr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --accent: #f59e0b;
      --success: #10b981;
      --error: #ef4444;
      --bg: #0f1020;
      --card: #14162b;
      --text: #f8fafc;
      --muted: #94a3b8;
      --border: #253357;
      --radius: 12px;
      --shadow: rgba(0,0,0,0.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 0% 0%, rgba(99,102,241,0.12), transparent 60%),
                  radial-gradient(1200px 600px at 100% 0%, rgba(245,158,11,0.1), transparent 60%),
                  linear-gradient(180deg, #0b0c1a, #0f1020);
      color: var(--text);
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 12px; gap: 10px;
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 28px; height: 28px; border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: grid; place-items: center; box-shadow: 0 4px 12px var(--shadow);
    }
    .logo .material-icons { font-size: 16px; color: #fff; }
    .title h1 { margin: 0; font-size: 16px; font-weight: 700; }
    .title p { margin: 0; font-size: 11px; color: var(--muted); }

    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button {
      appearance: none; border: 1px solid transparent; border-radius: 10px;
      padding: 8px 10px; font-size: 12px; font-weight: 700; color: #fff; cursor: pointer;
      display: inline-flex; align-items: center; gap: 6px;
      background: #1a1d36; border-color: #2a3560; transition: transform .15s ease, opacity .2s ease;
    }
    button .material-icons { font-size: 16px; }
    button.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-color: transparent; }
    button.accent { background: linear-gradient(135deg, var(--accent), #fb923c); border-color: transparent; color: #1a1305; }
    button.success { background: linear-gradient(135deg, var(--success), #34d399); border-color: transparent; color: #052318; }
    button:disabled { opacity: .6; cursor: not-allowed; transform: none !important; }
    button:not(:disabled):active { transform: translateY(1px); }
    .wallet { color: #a7f3d0; font-size: 12px; font-weight: 700; }

    main { display: grid; grid-template-columns: 1fr; gap: 10px; padding: 0 12px 12px; }
    @media (min-width: 900px) { main { grid-template-columns: 1.5fr 1fr; } }

    #map {
      height: 62vh; width: 100%;
      border-radius: var(--radius); border: 1px solid var(--border);
      overflow: hidden; background: #0e1023; box-shadow: 0 8px 20px var(--shadow);
    }

    .panel {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 12px; display: grid; gap: 10px;
    }
    .row { display: grid; gap: 8px; }
    .row.inline { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .status {
      min-height: 38px; display: grid; place-items: center; text-align: center;
      font-size: 12px; border-radius: 10px; padding: 8px;
      border: 1px solid #22345a; color: var(--muted);
    }
    .status.success { background: rgba(16,185,129,.12); color: var(--success); border-color: rgba(16,185,129,.35); }
    .status.error { background: rgba(239,68,68,.12); color: var(--error); border-color: rgba(239,68,68,.35); }
    .status.loading { display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
    .spinner {
      width: 14px; height: 14px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,.25); border-top-color: var(--primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hint { color: var(--muted); font-size: 12px; }
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 11px; padding: 6px 8px; border-radius: 999px; border: 1px solid var(--border);
      background: #0f1329; color: #cbd5e1;
    }
    .leaflet-container { background: #0e1023; }
    .leaflet-control-attribution, .leaflet-control-zoom a { background: #14162b; color: #cbd5e1; border-color: #2a3560; }
    .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #111327; color: #e5e7eb; border: 1px solid var(--border); }
    .leaflet-draw-toolbar a { background: #14162b; border-color: #2a3560; }
    .leaflet-draw-toolbar a:hover { background: #1a1d36; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo"><span class="material-icons">radio_button_checked</span></div>
      <div class="title">
        <h1>NFT Circle Map</h1>
        <p>Draw a circle (max 1 km diameter) and mint it</p>
      </div>
    </div>
    <div class="actions">
      <span class="pill"><span class="material-icons" style="font-size:16px;">paid</span> Mint Price: <strong style="margin-left:4px;">1 $POL</strong></span>
      <button id="connectBtn" class="primary"><span class="material-icons">account_balance_wallet</span>Connect</button>
      <span id="wallet" class="wallet"></span>
    </div>
  </header>

  <main>
    <div id="map" aria-label="Map"></div>

    <div class="panel">
      <div class="row">
        <div class="hint">Instructions</div>
        <ul class="hint" style="margin:0 0 6px 18px;">
          <li>Use the circle tool on the map to draw an area.</li>
          <li>Maximum diameter is 1 km (radius ≤ 500 m). Larger circles will be rejected.</li>
          <li>Connect your wallet, then press Mint Circle.</li>
        </ul>
        <div class="row inline">
          <span id="circleInfo" class="pill" style="display:none;"></span>
        </div>
      </div>

      <div class="row inline">
        <button id="mintBtn" class="success" disabled><span class="material-icons">rocket_launch</span>Mint Circle</button>
        <button id="clearBtn" class="accent"><span class="material-icons">delete_sweep</span>Clear</button>
        <button id="recenterBtn"><span class="material-icons">center_focus_strong</span>Recenter</button>
      </div>

      <div id="status" class="status"></div>
    </div>
  </main>

  <script>
    // Network: Polygon Mainnet
    const POLYGON_PARAMS = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };

    // Contract (must support mintWithURI(string) payable)
    const CONTRACT_ADDRESS = "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC";
    const CONTRACT_ABI = [
      "function mintWithURI(string tokenURI) external payable returns (uint256)",
      "function mintPrice() view returns (uint256)"
    ];

    const MAX_RADIUS_M = 500; // 1km diameter

    let provider, signer, userAddress;
    let map, drawnItems, drawControl;
    let selectedCircle = null; // Leaflet circle layer

    // UI
    const connectBtn = document.getElementById('connectBtn');
    const walletEl = document.getElementById('wallet');
    const mintBtn = document.getElementById('mintBtn');
    const clearBtn = document.getElementById('clearBtn');
    const recenterBtn = document.getElementById('recenterBtn');
    const statusEl = document.getElementById('status');
    const circleInfo = document.getElementById('circleInfo');

    function setStatus(msg, type = '') {
      if (!msg) {
        statusEl.textContent = '';
        statusEl.className = 'status';
        return;
      }
      statusEl.className = 'status';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'loading') {
        statusEl.classList.add('loading');
        statusEl.innerHTML = `<span class="spinner"></span><span>${msg}</span>`;
      } else {
        statusEl.textContent = msg;
      }
    }

    function toFixed(n) { return (Math.round(n * 100000) / 100000).toFixed(5); }

    function updateUIFromCircle() {
      if (!selectedCircle) {
        circleInfo.style.display = 'none';
        mintBtn.disabled = true;
        return;
      }
      const center = selectedCircle.getLatLng();
      const r = selectedCircle.getRadius(); // meters
      circleInfo.style.display = 'inline-flex';
      circleInfo.innerHTML = `<span class="material-icons" style="font-size:16px;">info</span> Lat: ${toFixed(center.lat)}, Lng: ${toFixed(center.lng)} • Radius: ${Math.round(r)} m`;
      mintBtn.disabled = !(userAddress && r > 0 && r <= MAX_RADIUS_M);
    }

    function updateMintEnabled() {
      if (!selectedCircle || !userAddress) {
        mintBtn.disabled = true;
        return;
      }
      const r = selectedCircle.getRadius();
      mintBtn.disabled = !(r > 0 && r <= MAX_RADIUS_M);
    }

    // Map init
    function initMap() {
      if (!window.L) {
        setStatus('Leaflet failed to load (CDN blocked?). Try refreshing.', 'error');
        return;
      }
      map = L.map('map', { center: [20, 0], zoom: 3, zoomControl: true });
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      })
      .on('load', () => { if (!statusEl.textContent) setStatus('Map ready. Use the circle tool to draw.', 'success'); })
      .on('tileerror', () => setStatus('Tile load error (rate limit/network). Try again later.', 'error'));
      tiles.addTo(map);

      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      drawControl = new L.Control.Draw({
        draw: {
          polygon: false,
          polyline: false,
          rectangle: false,
          marker: false,
          circlemarker: false,
          circle: {
            shapeOptions: { color: '#f59e0b', weight: 2, fillOpacity: 0.15 },
            showArea: false
          }
        },
        edit: {
          featureGroup: drawnItems,
          edit: false,
          remove: true
        }
      });
      map.addControl(drawControl);

      // When a circle is created, enforce radius <= 500m
      map.on(L.Draw.Event.CREATED, (e) => {
        if (e.layerType !== 'circle') return;
        const circle = e.layer;
        const r = circle.getRadius();

        if (r > MAX_RADIUS_M) {
          setStatus('Circle too big. Max diameter is 1 km (radius ≤ 500 m). Draw a smaller circle.', 'error');
          return;
        }

        // Keep only one circle
        drawnItems.clearLayers();
        drawnItems.addLayer(circle);
        selectedCircle = circle;

        const c = circle.getLatLng();
        circle.bindPopup(`<div style="min-width:180px;">
          <div style="font-weight:700;margin-bottom:6px;">Circle Selected</div>
          <div style="color:#94a3b8;font-size:12px;">Center: ${toFixed(c.lat)}, ${toFixed(c.lng)}</div>
          <div style="color:#94a3b8;font-size:12px;">Radius: ${Math.round(r)} m</div>
        </div>`).openPopup();

        setStatus('Circle ready. Connect your wallet to mint.', 'success');
        updateUIFromCircle();
      });

      // If user deletes the circle
      map.on('draw:deleted', () => {
        selectedCircle = null;
        setStatus('Circle cleared. Draw again to select a new area.');
        updateUIFromCircle();
      });

      setTimeout(() => map.invalidateSize(), 300);
    }

    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_PARAMS.chainId }] });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          try {
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PARAMS] });
            return true;
          } catch {
            setStatus('Failed to add Polygon to wallet', 'error');
            return false;
          }
        }
        setStatus('Failed to switch network', 'error');
        return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        setStatus('Please install MetaMask to continue', 'error');
        return;
      }
      try {
        setStatus('Connecting wallet...', 'loading');
        const switched = await switchToPolygon();
        if (!switched) return;

        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send('eth_requestAccounts', []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span>Connected';
        walletEl.textContent = `${userAddress.slice(0,6)}...${userAddress.slice(-4)}`;

        setStatus('Wallet connected. Draw your circle then mint.', 'success');
        updateMintEnabled();
      } catch {
        setStatus('Wallet connection failed', 'error');
      }
    }

    // Build minimal SVG visualization (no user photo)
    function buildCircleSVG(lat, lng, radiusM) {
      const label = `r=${Math.round(radiusM)}m`;
      const pos = `${lat}, ${lng}`;
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="420">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#4f46e5"/>
              <stop offset="100%" stop-color="#06b6d4"/>
            </linearGradient>
          </defs>
          <rect width="100%" height="100%" fill="#0b0c1a"/>
          <rect x="20" y="20" width="760" height="380" rx="20" fill="url(#g)" opacity="0.25"/>
          <g transform="translate(110,60)">
            <circle cx="170" cy="150" r="120" fill="#22d3ee22" stroke="#60a5fa" stroke-width="4"/>
            <circle cx="170" cy="150" r="4" fill="#10b981"/>
          </g>
          <g font-family="Inter, Arial, sans-serif" fill="#e5e7eb">
            <text x="420" y="150" font-size="38" font-weight="700">Minted Circle</text>
            <text x="420" y="195" font-size="22" fill="#cbd5e1">Center: ${pos}</text>
            <text x="420" y="225" font-size="22" fill="#cbd5e1">${label}</text>
            <g transform="translate(420,270)">
              <rect width="220" height="48" rx="10" fill="#10b981" />
              <text x="16" y="32" font-size="20" font-weight="700" fill="#00110d">NFT Geometry</text>
            </g>
          </g>
        </svg>`;
      return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
    }

    function buildTokenURI({ lat, lng, radius }) {
      const name = `Circle @ ${lat.toFixed(5)}, ${lng.toFixed(5)} (r=${Math.round(radius)}m)`;
      const description = "User-minted circle on the map (max diameter 1 km).";
      const image = buildCircleSVG(lat.toFixed(5), lng.toFixed(5), radius);

      // Note: GeoJSON doesn't define Circle; we encode as an extension
      const metadata = {
        name,
        description,
        image, // data:image/svg+xml; for marketplaces
        attributes: [
          { trait_type: "Center Latitude", value: Number(lat.toFixed(6)) },
          { trait_type: "Center Longitude", value: Number(lng.toFixed(6)) },
          { trait_type: "Radius (m)", value: Math.round(radius) },
          { trait_type: "Diameter (m)", value: Math.round(radius * 2) }
        ],
        geometry: {
          type: "Circle",
          coordinates: [Number(lng.toFixed(6)), Number(lat.toFixed(6))],
          radius_m: Math.round(radius),
          crs: "EPSG:4326"
        }
      };

      const json = JSON.stringify(metadata);
      return "data:application/json;base64," + btoa(unescape(encodeURIComponent(json)));
    }

    async function mintCircle() {
      try {
        if (!userAddress) { setStatus('Connect wallet first', 'error'); return; }
        if (!selectedCircle) { setStatus('Draw a circle first', 'error'); return; }

        const radius = selectedCircle.getRadius();
        if (!(radius > 0 && radius <= MAX_RADIUS_M)) {
          setStatus('Circle invalid. Radius must be ≤ 500 m.', 'error');
          return;
        }

        const center = selectedCircle.getLatLng();
        const tokenURI = buildTokenURI({ lat: center.lat, lng: center.lng, radius });

        setStatus('Minting NFT...', 'loading');

        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        // Fixed 1 POL price (override). If contract supports mintPrice(), consider reading it.
        const mintPrice = ethers.utils.parseUnits('1', 18);

        const tx = await contract.mintWithURI(tokenURI, { value: mintPrice });
        await tx.wait();

        // Style the circle as minted (green)
        if (selectedCircle) {
          selectedCircle.setStyle({ color: '#10b981', fillColor: '#10b981', fillOpacity: 0.12, weight: 3 });
          const c = selectedCircle.getLatLng();
          selectedCircle.bindPopup(`<div style="min-width:200px;text-align:center;">
            <div style="font-weight:800;margin-bottom:6px;color:#10b981;">Circle Minted!</div>
            <div style="font-size:12px;color:#a7f3d0;">Center: ${toFixed(c.lat)}, ${toFixed(c.lng)}</div>
            <div style="font-size:12px;color:#a7f3d0;">Radius: ${Math.round(radius)} m</div>
            <div style="margin-top:10px;">
              <a href="https://opensea.io/collection/nft-photography-5" target="_blank" rel="noopener noreferrer">View Collection →</a>
            </div>
          </div>`).openPopup();
        }

        setStatus('Success! Your circle NFT has been minted.', 'success');
      } catch (e) {
        console.error(e);
        setStatus('Minting failed: ' + (e?.message || 'Unknown error'), 'error');
      }
    }

    function recenter() {
      if (selectedCircle) {
        map.setView(selectedCircle.getLatLng(), 16, { animate: true });
        setStatus('Map centered to your circle', 'success');
      } else {
        setStatus('No circle yet. Draw one with the circle tool.', 'error');
      }
    }

    function clearCircle() {
      drawnItems?.clearLayers();
      selectedCircle = null;
      setStatus('Circle cleared. Draw a new one.');
      updateUIFromCircle();
    }

    // Bind UI
    connectBtn.addEventListener('click', connectWallet);
    mintBtn.addEventListener('click', mintCircle);
    clearBtn.addEventListener('click', clearCircle);
    recenterBtn.addEventListener('click', recenter);

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      if (window.ethereum?.selectedAddress) {
        connectWallet().catch(() => {});
      }
    });
  </script>
</body>
</html>
