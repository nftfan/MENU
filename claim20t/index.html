<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFT FANS TOKEN Claim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <!-- Material Icons & Google Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <link rel="icon" href="https://pbs.twimg.com/media/GvMZI-kXAAASZdZ?format=jpg&name=small" type="image/jpeg">
  <style>
    :root {
      --primary: #7C3AED;
      --accent: #29B6F6;
      --bg: #1a1a29;
      --surface: #23233b;
      --text: #fff;
      --button: #29B6F6;
      --button-hover: #0288d1;
      --error: #ff5252;
      --success: #00e676;
      --disabled: #44445a;
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    html, body {
      margin: 0; padding: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      width: 100vw;
      overflow-x: hidden;
    }
    .banner {
      width: 100vw;
      height: 110px;
      background: url('https://pbs.twimg.com/profile_banners/1462505560142667777/1743232308/1500x500') center center/cover no-repeat;
      border-bottom-left-radius: 1.2rem;
      border-bottom-right-radius: 1.2rem;
      box-shadow: var(--shadow);
      position: relative;
    }
    .top-info {
      display: flex;
      align-items: center;
      gap: 13px;
      margin-top: -34px;
      margin-left: 6vw;
      margin-bottom: 16px;
      z-index: 10;
      position: relative;
    }
    .logo-circle {
      width: 68px;
      height: 68px;
      background: var(--surface);
      border-radius: 50%;
      border: 3.2px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 16px #0004;
      overflow: hidden;
    }
    .logo-circle img {
      width: 58px;
      height: 58px;
      border-radius: 50%;
      display: block;
      object-fit: cover;
    }
    .token-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: 1.2px;
      background: var(--surface);
      border-radius: 0.6rem;
      padding: 0.29rem 0.9rem;
      margin-left: 2px;
      box-shadow: 0 1px 8px #0001;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .main-card {
      background: var(--surface);
      margin: 0 auto;
      margin-top: 16px;
      border-radius: 1.2rem;
      padding: 1.1rem 1.0rem 1.0rem 1.0rem;
      box-shadow: var(--shadow);
      max-width: 97vw;
      width: 355px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
    }
    .desc {
      font-size: 1.01rem;
      color: #c6c9d8;
      margin-bottom: 0.8rem;
      text-align: left;
      line-height: 1.5;
      padding-left: 3px;
    }
    .balance-row {
      background: #1b1b2a;
      border-radius: 0.7rem;
      padding: 0.7rem 0.7rem;
      margin-bottom: 1.0rem;
      box-shadow: 0 1px 8px #0002;
      font-size: 1.06rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .balance-row .material-icons {
      color: var(--accent);
      margin-right: 6px;
      font-size: 1.2em;
      vertical-align: middle;
    }
    .balance-label {
      font-weight: 500;
      color: #b8e1ff;
      display: flex;
      align-items: center;
      font-size: 1.03em;
    }
    .balance-value {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.12em;
    }
    .btn, .wallet-btn {
      font-size: 1.09rem;
      font-weight: 500;
      padding: 0.82rem 1.2rem;
      border-radius: 0.7rem;
      border: none;
      outline: none;
      background: var(--button);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 5px #0003;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 0.3rem 0;
      width: 100%;
    }
    .btn:active, .btn:focus, .wallet-btn:active, .wallet-btn:focus {
      background: var(--button-hover);
    }
    .btn[disabled], .wallet-btn[disabled] {
      background: var(--disabled);
      color: #aaa;
      cursor: not-allowed;
    }
    .wallet-btn {
      background: var(--surface);
      color: var(--primary);
      border: 2px solid var(--primary);
      margin-bottom: 0.5rem;
      margin-top: 0.2rem;
      font-size: 1.02rem;
      font-weight: 700;
      box-shadow: none;
    }
    .wallet-btn:focus, .wallet-btn:hover {
      background: var(--primary);
      color: #fff;
    }
    .status {
      font-size: 0.98rem;
      margin-top: 0.37rem;
      min-height: 24px;
      text-align: center;
      word-break: break-word;
      line-height: 1.5;
    }
    .status.success { color: var(--success);}
    .status.error { color: var(--error);}
    @media (max-width: 550px) {
      .banner { height: 70px; border-radius: 0 0 0.9rem 0.9rem;}
      .top-info { margin-top: -32px; margin-left: 3vw; }
      .logo-circle { width: 48px; height: 48px;}
      .logo-circle img { width: 40px; height: 40px; }
      .token-title { font-size: 1.02rem; padding: 0.18rem 0.6rem;}
      .main-card { width: 95vw; padding: 0.7rem 0.1rem 0.8rem 0.1rem;}
      .desc { font-size: 0.98rem; }
      .balance-row { padding: 0.5rem 0.3rem; font-size: 1.01rem;}
    }
    @media (max-width: 400px) {
      .main-card { width: 99vw; }
      .top-info { margin-left: 2vw; }
    }
  </style>
</head>
<body>
  <div class="banner"></div>
  <div class="top-info">
    <div class="logo-circle">
      <img src="https://pbs.twimg.com/media/GvMZI-kXAAASZdZ?format=jpg&name=small" alt="NFT FANS TOKEN Logo" />
    </div>
    <div class="token-title">
      <span class="material-icons" style="font-size:1.2em;vertical-align:middle;">stars</span>
      NFT FANS TOKEN
    </div>
  </div>
  <div class="main-card">
    <div class="desc">
      <span style="color:var(--primary); font-weight:600;">Claim 20T NFTFAN tokens</span> for <span style="color:var(--accent);font-weight:600;">0.001 MATIC</span>.<br>
      <span style="color:#b8e1ff">One claim per wallet. Be part of the NFT Fans revolution!</span>
    </div>
    <div class="balance-row" id="balanceRow">
      <span class="balance-label">
        <span class="material-icons">account_balance</span>
        Contract Balance
      </span>
      <span class="balance-value" id="nftfanBalance">...</span>
    </div>
    <button id="connectWalletBtn" class="wallet-btn">
      <span class="material-icons">account_balance_wallet</span>
      <span id="walletStatus">Connect Wallet</span>
    </button>
    <button id="claimBtn" class="btn" disabled>
      <span class="material-icons">redeem</span>
      Claim 20T NFTFAN
    </button>
    <div id="status" class="status"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // NFTFAN Token Info
    const TOKEN_CA = "0x2017fcaea540d2925430586dc92818035bfc2f50";
    const TOKEN_DECIMALS = 18;
    const SALE_CA = "0xb01cDCCb307cb19751D970613Dd99bd1c7cF981C";
    const REQUIRED_MATIC = "1000000000000000"; // 0.001 MATIC in wei
    const CHAIN_ID = "0x89";
    const POLYGON_PARAMS = {
      chainId: CHAIN_ID,
      chainName: "Polygon Mainnet",
      nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
      rpcUrls: ["https://polygon-rpc.com"],
      blockExplorerUrls: ["https://polygonscan.com/"]
    };
    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];
    const SALE_ABI = [
      "function hasWalletPurchased(address wallet) view returns (bool)"
    ];

    let provider, signer, userAddress, tokenContract, saleContract;

    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletStatus = document.getElementById('walletStatus');
    const claimBtn = document.getElementById('claimBtn');
    const statusDiv = document.getElementById('status');
    const nftfanBalanceEl = document.getElementById('nftfanBalance');

    function setStatus(msg, type = "") {
      statusDiv.textContent = msg;
      statusDiv.className = "status" + (type ? " " + type : "");
    }

    // Fetch NFTFAN balance in sale contract
    async function fetchNFTFanBalance() {
      try {
        const rpcProvider = new ethers.providers.JsonRpcProvider(POLYGON_PARAMS.rpcUrls[0]);
        const contract = new ethers.Contract(TOKEN_CA, TOKEN_ABI, rpcProvider);
        const raw = await contract.balanceOf(SALE_CA);
        const decimals = TOKEN_DECIMALS;
        let formatted = ethers.utils.formatUnits(raw, decimals);
        // Show as e.g. "12.34T" if >=1T, or "900B" if >=1B, etc.
        let val = Number(formatted);
        let show = val >= 1e12 ? (val/1e12).toFixed(2) + "T"
                : val >= 1e9 ? (val/1e9).toFixed(2) + "B"
                : val >= 1e6 ? (val/1e6).toFixed(2) + "M"
                : val.toLocaleString();
        nftfanBalanceEl.textContent = show + " NFTFAN";
      } catch {
        nftfanBalanceEl.textContent = "N/A";
      }
    }

    fetchNFTFanBalance();
    setInterval(fetchNFTFanBalance, 25000); // Refresh every 25s

    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID }] });
        return true;
      } catch (switchError) {
        if (switchError.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [POLYGON_PARAMS]
            });
            return true;
          } catch {
            setStatus("Failed to add Polygon.", "error");
            return false;
          }
        }
        setStatus("Switch to Polygon failed.", "error");
        return false;
      }
    }

    async function connectWallet() {
      setStatus("");
      if (!window.ethereum) {
        setStatus("No wallet found. Install MetaMask or a compatible wallet.", "error");
        return;
      }
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== CHAIN_ID) {
          setStatus("Switching to Polygon...", "");
          const switched = await switchToPolygon();
          if (!switched) return;
        }
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        signer = provider.getSigner();
        tokenContract = new ethers.Contract(TOKEN_CA, TOKEN_ABI, provider);
        saleContract = new ethers.Contract(SALE_CA, SALE_ABI, provider);
        walletStatus.textContent = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
        connectWalletBtn.disabled = true;
        connectWalletBtn.style.background = "var(--disabled)";
        connectWalletBtn.style.color = "#aaa";
        claimBtn.disabled = false;
        await checkPurchaseStatus();
      } catch (err) {
        setStatus("Wallet connection failed: " + (err.data?.message || err.message), "error");
      }
    }

    async function checkPurchaseStatus() {
      if (!saleContract || !userAddress) return;
      try {
        const purchased = await saleContract.hasWalletPurchased(userAddress);
        claimBtn.disabled = purchased;
        if (purchased) {
          setStatus("You have already claimed your NFTFAN tokens.", "success");
        } else {
          setStatus("You can claim your 20T NFTFAN now!", "success");
        }
      } catch {
        setStatus("Failed to check claim status.", "error");
      }
    }

    async function claimTokens() {
      setStatus("");
      if (!signer || !userAddress) {
        setStatus("Please connect your wallet first.", "error");
        return;
      }
      try {
        claimBtn.disabled = true;
        setStatus("Sending claim transaction...", "");
        const tx = await signer.sendTransaction({
          to: SALE_CA,
          value: REQUIRED_MATIC
        });
        setStatus("Waiting for confirmation...", "");
        await tx.wait();
        setStatus("Claim successful! 20T NFTFAN sent to your wallet.", "success");
        claimBtn.disabled = true;
        fetchNFTFanBalance();
      } catch (err) {
        let msg = err.data?.message || err.message;
        if (msg.includes("already purchased")) {
          setStatus("You have already claimed your NFTFAN tokens.", "error");
          claimBtn.disabled = true;
        } else if (msg.includes("Must send exactly")) {
          setStatus("Incorrect claim amount. Please try again.", "error");
        } else {
          setStatus("Claim failed: " + msg, "error");
        }
        claimBtn.disabled = false;
      }
    }

    connectWalletBtn.addEventListener('click', connectWallet);
    claimBtn.addEventListener('click', claimTokens);

    window.addEventListener('DOMContentLoaded', async () => {
      if (window.ethereum && window.ethereum.selectedAddress) {
        await connectWallet();
      }
    });
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', async () => { window.location.reload(); });
      window.ethereum.on('chainChanged', async () => { window.location.reload(); });
    }
  </script>
</body>
</html>
