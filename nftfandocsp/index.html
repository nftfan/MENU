<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFT Fans Docs Publisher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #0f172a;
      color: #e5e7eb;
      padding: 24px;
    }

    h1 {
      text-align: center;
      margin-bottom: 8px;
    }

    p.subtitle {
      text-align: center;
      margin-top: 0;
      color: #9ca3af;
      font-size: 0.95rem;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 24px;
      box-shadow:
        0 10px 25px rgba(15, 23, 42, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.07);
      margin-bottom: 24px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      align-items: flex-end;
    }
    .form-lab {
      flex: 1 1 0;
    }
    @media (max-width: 700px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .form-row { flex-direction: column; gap: 2px; }
    }

    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    input, textarea, select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 10px 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    input:focus, textarea:focus, select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      background: #020617;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button, .delete-btn, .edit-btn, .cancel-btn, .save-btn {
      border: none;
      border-radius: 999px;
      color: white;
      font-weight: 600;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      text-shadow: 0 1px 1.5px #122;
    }
    button, .save-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
    }
    .edit-btn {
      background: linear-gradient(135deg, #38bdf8, #2563eb);
      color: #f8fafc;
      padding: 7px 16px;
      font-size: 0.89rem;
      margin-top: 3px;
      text-shadow: none;
    }
    .cancel-btn {
      background: linear-gradient(135deg, #6b7280, #334155);
      color: #f8fafc;
      padding: 7px 16px;
      font-size: 0.89rem;
      margin-top: 3px;
      text-shadow: none;
    }
    .delete-btn {
      background: linear-gradient(135deg, #ef4444, #be123c);
      color: #fff;
      padding: 7px 16px;
      font-size: 0.89rem;
      margin-top: 3px;
      box-shadow: none;
      text-shadow: none;
    }

    .status {
      margin-top: 8px;
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .status.error {
      color: #f97373;
    }
    .status.success {
      color: #4ade80;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-top: 12px;
    }

    .post-card {
      background: radial-gradient(circle at top left, rgba(56, 189, 248, 0.09), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(34, 197, 94, 0.09), transparent 55%),
                  #030a18;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.11);
      display: flex;
      flex-direction: column;
      min-height: 100%;
      position: relative;
      box-shadow: 0 2px 14px 0 rgba(34, 197, 94, 0.022);
      margin-bottom: 2px;
    }

    .post-image-wrapper {
      position: relative;
      width: 100%;
      padding-top: 32%;
      overflow: hidden;
      background: #162234;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .post-image {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: auto; height: 100%;
      max-width: 200px; min-width: 80px;
      margin: auto;
      object-fit: contain;
      display: block;
      filter: drop-shadow(0 2px 18px #1115);
    }

    .post-content {
      padding: 18px 22px 14px;
      display: flex;
      flex-direction: column;
      gap: 7px;
      flex: 1;
    }

    .post-number-label {
      color: #a5f3fc;
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 3px;
      letter-spacing: 0.065em;
      display: inline-block;
      background: #042f2e;
      border-radius: 7px;
      padding: 2px 10px;
      margin-right: 9px;
    }
    .post-label-tag {
      background: linear-gradient(90deg,#eef2ff,#f0abfc,#a7f3d0);
      color: #232937;
      font-size: .87em;
      padding: 2.3px 10px;
      border-radius: 99px;
      margin-right: 5px;
      font-weight: 700;
      letter-spacing: 0.04em;
      font-family: inherit;
    }

    .post-title {
      font-size: 1.13rem;
      font-weight: 700;
      margin: 0;
      color: #97fafb;
      word-break:break-word;
    }

    .post-description {
      white-space: pre-line;
      font-size: 0.97rem;
      color: #e0eefe;
      margin: 0.36em 0 0.28em;
    }

    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: #6b7280;
      font-size: 0.98rem;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.62);
      margin-top: 16px;
    }

    .post-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Publish NFT Fans Docs</h1>
    <p class="subtitle">Enter the document's number, label, title, and main content (support paragraphs and lists). Docs appear below. <strong>You can edit or delete any published doc.</strong></p>

    <!-- Form Card -->
    <div class="card">
      <form id="postForm" autocomplete="off">
        <div class="form-row">
          <div class="form-lab">
            <label for="number">Number</label>
            <input id="number" type="text" required maxlength="10" placeholder="e.g. 1, 1.1, 2.2, etc." pattern="^[0-9]+(\.[0-9]+)*$" title="Use numbers like 1, 1.1, 2.2, etc." />
          </div>
          <div class="form-lab">
            <label for="label">Label / Tag (optional)</label>
            <input id="label" type="text" maxlength="24" placeholder="e.g. DOC, WHITEPAPER" />
          </div>
        </div>
        <div class="form-grid" style="margin-top:16px;">
          <div>
            <label for="title">Title</label>
            <input id="title" type="text" required maxlength="120" placeholder="e.g. Introduction to NFT Fans" />
          </div>
          <div>
            <label for="imageUrl">Image URL (thumbnail or logo)</label>
            <input id="imageUrl" type="url" required placeholder="https://.../image.png" />
          </div>
        </div>
        <div style="margin-top:16px;">
          <label for="description">Content (paragraphs, Markdown or plain text)</label>
          <!-- UNLIMITED -->
          <textarea id="description" required placeholder="Start writing your doc here...

- Use bullet lists
- Paragraphs

**bold** and `inline code` are supported.
Links: [NFT Fans](https://nftfanstoken.com)"></textarea>
        </div>
        <button type="submit" id="publishBtn">
          <span>Publish</span>
          <span>➜</span>
        </button>
        <button type="button" id="cancelEditBtn" style="display:none;" class="cancel-btn">
          Cancel Edit
        </button>
        <div id="status" class="status"></div>
      </form>
    </div>

    <!-- Docs List -->
    <div class="card">
      <h2 style="margin-top: 0; font-size: 1.1rem;">Published Docs</h2>
      <div id="postsContainer" class="cards-grid"></div>
      <div id="emptyState" class="empty-state" style="display:none;">
        No published documents yet.
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      remove,
      update,
      onValue,
      query,
      orderByChild
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
      authDomain: "tokentransfer-4a9b3.firebaseapp.com",
      databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
      projectId: "tokentransfer-4a9b3",
      storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
      messagingSenderId: "205455490321",
      appId: "1:205455490321:web:9919f5dde059316c9320b0",
      measurementId: "G-Y6CVEDL9XH"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // References
    const postsRef = ref(db, "posts");

    const postForm = document.getElementById("postForm");
    const statusEl = document.getElementById("status");
    const postsContainer = document.getElementById("postsContainer");
    const emptyState = document.getElementById("emptyState");
    const publishBtn = document.getElementById("publishBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    // Edit Mode State
    let editId = null;

    function setEditForm(doc) {
      document.getElementById("number").value = doc.number || "";
      document.getElementById("label").value = doc.label || "";
      document.getElementById("title").value = doc.title || "";
      document.getElementById("description").value = doc.description || "";
      document.getElementById("imageUrl").value = doc.imageUrl || "";
      publishBtn.innerHTML = "<span>Save</span> <span>✔</span>";
      cancelEditBtn.style.display = "inline-flex";
    }

    function resetForm() {
      postForm.reset();
      editId = null;
      publishBtn.innerHTML = "<span>Publish</span> <span>➜</span>";
      cancelEditBtn.style.display = "none";
      statusEl.textContent = "";
    }

    cancelEditBtn.onclick = () => {
      resetForm();
    };

    // Handle form submit (write or edit)
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.textContent = "";
      statusEl.className = "status";

      const number = document.getElementById("number").value.trim();
      const label = document.getElementById("label").value.trim();
      const title = document.getElementById("title").value.trim();
      const description = document.getElementById("description").value.trim();
      const imageUrl = document.getElementById("imageUrl").value.trim();

      if (!number || !title || !description || !imageUrl) {
        statusEl.textContent = "Please fill in all required fields.";
        statusEl.classList.add("error");
        return;
      }

      if (!/^[0-9]+(\.[0-9]+)*$/.test(number)) {
        statusEl.textContent = "Number must be like 1, 1.1, 2, 3.3 etc.";
        statusEl.classList.add("error");
        return;
      }

      try {
        if (editId) {
          // Edit existing
          await update(ref(db, "posts/" + editId), {
            number,
            label,
            title,
            description,
            imageUrl
          });
          statusEl.textContent = "Document updated!";
        } else {
          // Add new
          await push(postsRef, {
            number,
            label,
            title,
            description,
            imageUrl
          });
          statusEl.textContent = "Document published!";
        }
        statusEl.className = "status success";
        resetForm();
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to publish. Check console for details.";
        statusEl.classList.add("error");
      }
    });

    // Markdown formatting for doc content
    function parseAndFormatDescription(desc) {
      return desc
        .replace(/\r\n/g, '\n')
        .split(/\n{2,}/)
        .map(par => {
          // markdown list
          if (/^\s*[-*]\s+/.test(par)) {
            return '<ul>' +
              par.split(/\n/).map(line => line.replace(/^\s*[-*]\s+/, '')).map(item => `<li>${item}</li>`).join('') +
              '</ul>';
          } else {
            let formatted = par
              .replace(/^#+\s*(.*)/, '<h3>$1</h3>')
              .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
              .replace(/`([^`]+)`/g, '<code>$1</code>')
              .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            return `<p>${formatted}</p>`;
          }
        }).join('');
    }

    // Render docs with edit and delete, sorted by number
    function compareNumberString(a, b) {
      const pa = a.number.split('.').map(Number);
      const pb = b.number.split('.').map(Number);
      for (let i = 0; i < Math.max(pa.length, pb.length); i++) {
        const va = pa[i] !== undefined ? pa[i] : 0;
        const vb = pb[i] !== undefined ? pb[i] : 0;
        if (va !== vb) return va - vb;
      }
      return 0;
    }

    function renderPosts(snapshot) {
      postsContainer.innerHTML = "";

      const data = snapshot.val();
      if (!data) {
        emptyState.style.display = "block";
        return;
      }

      let postsArr = Object.entries(data)
        .map(([id, value]) => ({ id, ...value }))
        .filter(post =>
          typeof post.number === "string" && post.number.trim() !== "" &&
          typeof post.title === "string" && post.title.trim() !== "" &&
          typeof post.description === "string" && post.description.trim() !== "" &&
          typeof post.imageUrl === "string" && post.imageUrl.trim() !== ""
        )
        .sort(compareNumberString);

      if (postsArr.length === 0) {
        emptyState.style.display = "block";
        return;
      } else {
        emptyState.style.display = "none";
      }

      for (const post of postsArr) {
        const card = document.createElement("article");
        card.className = "post-card";

        // Image
        const imageWrapper = document.createElement("div");
        imageWrapper.className = "post-image-wrapper";

        const img = document.createElement("img");
        img.className = "post-image";
        img.src = post.imageUrl;
        img.alt = post.title || "Doc image";
        img.onerror = () => {
          img.src = "https://via.placeholder.com/200/020617/64748b?text=Image+Error";
        };
        imageWrapper.appendChild(img);

        // Content
        const content = document.createElement("div");
        content.className = "post-content";

        // Number & Label
        if (post.number) {
          const numSpan = document.createElement("span");
          numSpan.className = "post-number-label";
          numSpan.textContent = post.number;
          content.appendChild(numSpan);
        }
        if (post.label) {
          const labSpan = document.createElement("span");
          labSpan.className = "post-label-tag";
          labSpan.textContent = post.label;
          content.appendChild(labSpan);
        }

        // Title
        const titleEl = document.createElement("h3");
        titleEl.className = "post-title";
        titleEl.textContent = post.title || "Untitled";

        // Description
        const descEl = document.createElement("div");
        descEl.className = "post-description";
        descEl.innerHTML = parseAndFormatDescription(post.description);

        // Actions
        const actions = document.createElement("div");
        actions.className = "post-actions";
        // EDIT BUTTON
        const editBtn = document.createElement("button");
        editBtn.type = "button";
        editBtn.className = "edit-btn";
        editBtn.innerHTML = "Edit";
        editBtn.onclick = () => {
          editId = post.id;
          setEditForm(post);
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        // DELETE BUTTON
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "delete-btn";
        delBtn.innerHTML = "Delete";
        delBtn.onclick = async () => {
          if (window.confirm("Are you sure you want to delete this doc?")) {
            await remove(ref(db, "posts/" + post.id));
            if (editId === post.id) {
              resetForm();
            }
          }
        };
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        content.appendChild(titleEl);
        content.appendChild(descEl);

        card.appendChild(imageWrapper);
        card.appendChild(content);
        card.appendChild(actions);

        postsContainer.appendChild(card);
      }
    }

    // Listen for changes in Realtime Database
    const postsQuery = query(postsRef, orderByChild("number"));
    onValue(postsQuery, renderPosts);
  </script>
</body>
</html>
