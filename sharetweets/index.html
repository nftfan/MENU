<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>$NFTFAN Free Claim</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f5f7fa">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#06070a">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<style>
:root {
  --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
  --ease: cubic-bezier(.4,.14,.3,1);
  --accent: #5d82ff;
  --accent-rgb: 93 130 255;
  --accent-alt: #ff3db9;
  --text: #f2f6fb;
  --text-dim: #b6c2d6;
  --text-faint: #6f7d92;
  --surface: #11151d;
  --panel: #171d27cc;
  --border: #2d3947;
  --glass-border: #ffffff12;
  --radius-md: 12px;
  --radius-lg: 16px;
  --shadow-1: 0 2px 4px -1px rgba(0,0,0,.4), 0 8px 18px -6px rgba(0,0,0,.55);
  --blur-panel: 22px;
  --gradient-accent: linear-gradient(135deg,#4f7dff,#4d4ffb 40%,#7b2dfd 70%,#ff35a6);
  --gradient-bg: radial-gradient(circle at 18% 20%,#18202c 0%,#0d1219 40%,#07090d 80%);
  --success: #3ddf91;
  --warn: #ffbe3d;
}

* { box-sizing: border-box; }
html,body { height:100%; margin:0; }
body {
  font-family: var(--font-sans);
  -webkit-font-smoothing: antialiased;
  background: var(--gradient-bg);
  background-size: cover;
  color: var(--text);
  accent-color: var(--accent);
  overflow-x:hidden;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding-top: 0.75rem;
  font-size: 12px;
}

body::before {
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 80% 15%, #5d82ff20 0%, transparent 45%),
    radial-gradient(circle at 15% 85%, #ff3db920 0%, transparent 50%);
  mix-blend-mode:color-dodge;
  z-index:0;
}

.container {
  width:100%;
  max-width:450px;
  padding:0.5rem 1rem;
  position:relative;
  z-index:1;
  text-align:center;
}

.header {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

h1 {
  font-size:1.75rem;
  background:var(--gradient-accent);
  -webkit-background-clip:text;
  color:transparent;
  filter:drop-shadow(0 6px 12px #00000050);
  margin:0;
}

.badge-live {
  font-size:9px;
  background:#ff3db9;
  color:#fff;
  padding:0.15rem 0.35rem 0.2rem;
  border-radius:4px;
  letter-spacing:.5px;
  font-weight:600;
  box-shadow:0 2px 6px -2px #ff3db980;
  display: inline-block;
}

.stats-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
  margin: 0.5rem 0;
}

.stat-card {
  background: rgba(30, 40, 58, 0.8);
  border-radius: 8px;
  padding: 0.5rem;
  flex: 1;
  min-width: 110px;
  max-width: 160px;
  box-shadow: 0 4px 12px -6px rgba(0,0,0,0.5);
  border: 1px solid var(--glass-border);
}

.stat-value {
  font-size: 1.2rem;
  font-weight: 700;
  margin: 0.15rem 0;
  background: var(--gradient-accent);
  -webkit-background-clip: text;
  color: transparent;
}

.stat-label {
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-dim);
  font-weight: 600;
}

.panel {
  position:relative;
  background:var(--panel);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-lg);
  padding:1rem;
  box-shadow:var(--shadow-1);
  backdrop-filter:saturate(140%) blur(var(--blur-panel));
  -webkit-backdrop-filter:saturate(140%) blur(var(--blur-panel));
  margin:0.75rem 0;
}

.panel::before {
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(120deg,#ffffff10 0%,transparent 22%,transparent 78%,#ffffff08 100%);
  pointer-events:none;
  mix-blend-mode:overlay;
  opacity:.55;
  border-radius:inherit;
}

.message {
  font-size:11px;
  margin:0.5rem 0 0.75rem;
  color:var(--text-dim);
  line-height:1.3;
}

button {
  font-family:inherit;
  font-weight:600;
  font-size:12px;
  letter-spacing:.5px;
  line-height:1;
  border:none;
  border-radius:8px;
  padding:0 1.5rem;
  height:45px;
  cursor:pointer;
  background:linear-gradient(135deg,#3552ff,#5d82ff 55%,#7b2dfd);
  color:#fff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.55rem;
  box-shadow:0 4px 14px -5px rgba(var(--accent-rgb)/.8), 0 2px 4px -2px rgba(0,0,0,.6);
  transition:transform .25s var(--ease), box-shadow .25s var(--ease), background .25s var(--ease);
  width:100%;
  max-width:220px;
}

button:hover:not(:disabled) {
  background:linear-gradient(135deg,#4660ff,#6a8bff 55%,#8a40ff);
  transform:translateY(-2px);
  box-shadow:0 8px 26px -6px rgba(var(--accent-rgb)/.85), 0 3px 10px -4px rgba(0,0,0,.8);
}

button:active:not(:disabled) {
  transform:translateY(0);
  transition-duration:.12s;
}

button:disabled {
  opacity:.55;
  cursor:not-allowed;
  filter:saturate(.3);
  transform:none !important;
}

.toast {
  position:fixed;
  z-index:100;
  bottom:1rem;
  max-width:min(320px,90vw);
  background:#121c27f2;
  backdrop-filter:blur(22px) saturate(160%);
  -webkit-backdrop-filter:blur(22px) saturate(160%);
  border:1px solid #ffffff20;
  box-shadow:0 12px 40px -12px rgba(0,0,0,.6), 0 0 0 1px #ffffff08;
  padding:0.75rem;
  border-radius:var(--radius-lg);
  font-size:11px;
  line-height:1.4;
  opacity:0;
  transform:translateY(14px) scale(.96);
  pointer-events:none;
  transition:opacity .5s var(--ease), transform .55s var(--ease);
}
.toast.show {
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:auto;
}

.loading {
  display:inline-block;
  width:16px;
  height:16px;
  border:2px solid rgba(255,255,255,0.3);
  border-radius:50%;
  border-top-color:#fff;
  animation:spin 1s ease-in-out infinite;
  margin-right:6px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.cooldown-box {
  margin-top: 0.5rem;
  background: rgba(30, 40, 58, 0.6);
  border-radius: 8px;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--warn);
  font-weight: 600;
  font-size: 10px;
}

.countdown {
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  padding: 0.1rem 0.35rem;
  margin-left: 0.35rem;
  background: rgba(0,0,0,0.2);
  border-radius: 4px;
}

#fallbackCopyArea {
  position:absolute;
  left:-9999px;
  top:-9999px;
}

/* Hidden links that will be triggered programmatically */
.app-links {
  position: absolute;
  top: -9999px;
  left: -9999px;
  visibility: hidden;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>$NFTFAN</h1>
    <span class="badge-live">LIVE</span>
  </div>
  
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-label">Tweets Shared</div>
      <div class="stat-value" id="tweetsShared">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Tokens Earned</div>
      <div class="stat-value" id="tokensEarned">0 TRILLION</div>
    </div>
  </div>
  
  <div class="panel">
    <div class="message">
      Share a tweet to earn 1 Trillion $NFTFAN tokens.<br>
      Cooldown period: 20 minutes between shares.
    </div>
    
    <button id="shareBtn" type="button">Share Tweet</button>
    
    <div id="cooldownBox" class="cooldown-box" style="display:none;">
      Next share available in: <span id="countdownTimer" class="countdown">20:00</span>
    </div>
  </div>
</div>

<!-- Hidden links for app opening -->
<div class="app-links">
  <a id="twitterAppLink" href=""></a>
  <a id="twitterWebLink" href=""></a>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>
<textarea id="fallbackCopyArea" aria-hidden="true" tabindex="-1"></textarea>

<script type="module">
/* Firebase integration */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
  authDomain: "newnft-47bd7.firebaseapp.com",
  databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
  projectId: "newnft-47bd7",
  storageBucket: "newnft-47bd7.firebasestorage.app",
  messagingSenderId: "172043823738",
  appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
  measurementId: "G-8VB3DYRNXR"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* Constants */
const COOLDOWN_MINUTES = 20;
const COOLDOWN_MS = COOLDOWN_MINUTES * 60 * 1000;
const TOKENS_PER_SHARE = 1; // 1 trillion

/* Elements */
const shareBtn = document.getElementById('shareBtn');
const toastEl = document.getElementById('toast');
const fallbackCopyArea = document.getElementById('fallbackCopyArea');
const tweetsSharedEl = document.getElementById('tweetsShared');
const tokensEarnedEl = document.getElementById('tokensEarned');
const cooldownBox = document.getElementById('cooldownBox');
const countdownTimer = document.getElementById('countdownTimer');
const twitterAppLink = document.getElementById('twitterAppLink');
const twitterWebLink = document.getElementById('twitterWebLink');

/* Detect device */
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isAndroid = /Android/.test(navigator.userAgent);
const isMobile = isIOS || isAndroid;

/* User state */
let tweetsShared = 0;
let tokensEarned = 0;
let lastShareTime = 0;
let countdownInterval = null;

/* Server Time Offset */
let serverOffset = 0;
onValue(ref(db, '.info/serverTimeOffset'), s => serverOffset = s.val() || 0);
const nowServer = () => Date.now() + serverOffset;

/* Load user state from localStorage */
function loadUserState() {
  const savedState = localStorage.getItem('nftfan_user_state');
  if (savedState) {
    try {
      const state = JSON.parse(savedState);
      tweetsShared = state.tweetsShared || 0;
      tokensEarned = state.tokensEarned || 0;
      lastShareTime = state.lastShareTime || 0;
      
      // Update UI
      tweetsSharedEl.textContent = tweetsShared;
      tokensEarnedEl.textContent = tokensEarned + ' TRILLION';
      
      // Check if still in cooldown
      checkCooldown();
    } catch (e) {
      console.error('Error loading user state:', e);
    }
  }
}

/* Save user state to localStorage */
function saveUserState() {
  const state = {
    tweetsShared,
    tokensEarned,
    lastShareTime
  };
  localStorage.setItem('nftfan_user_state', JSON.stringify(state));
}

/* Check cooldown status */
function checkCooldown() {
  if (!lastShareTime) {
    cooldownBox.style.display = 'none';
    shareBtn.disabled = false;
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
    return;
  }
  
  const nextShareTime = lastShareTime + COOLDOWN_MS;
  const now = nowServer();
  
  if (now < nextShareTime) {
    startCountdown(nextShareTime);
  } else {
    cooldownBox.style.display = 'none';
    shareBtn.disabled = false;
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
  }
}

/* Start countdown timer */
function startCountdown(endTime) {
  cooldownBox.style.display = 'flex';
  shareBtn.disabled = true;
  
  function updateTimer() {
    const now = nowServer();
    const remaining = Math.max(0, endTime - now);
    
    if (remaining <= 0) {
      clearInterval(countdownInterval);
      countdownInterval = null;
      cooldownBox.style.display = 'none';
      shareBtn.disabled = false;
      return;
    }
    
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    countdownTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }
  
  if (countdownInterval) {
    clearInterval(countdownInterval);
  }
  
  updateTimer();
  countdownInterval = setInterval(updateTimer, 1000);
}

/* Helpers */
function showToast(msg, t=3200) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(() => toastEl.classList.remove('show'), t);
}

/* Tweet building & sharing */
function buildTweet(_groupKey, groupData) {
  const usernames = (groupData.usernames || []).filter(Boolean);
  let listPart = '';
  if (usernames.length === 1) listPart = usernames[0];
  else if (usernames.length === 2) listPart = `${usernames[0]} and ${usernames[1]}`;
  else listPart = `${usernames[0]}, ${usernames[1]} and ${usernames[2]}`;
  return `Follow @nftfanstoken to claim, click the link nftfanstoken.com/nftzz to claim your tokens. Winners are: ${listPart}. I used this link to invite you: https://www.nftfanstoken.com/sharetweets/`;
}

async function shareToTwitter(tweet) {
  const encodedTweet = encodeURIComponent(tweet);
  
  // For mobile, try to use the app
  if (isMobile) {
    let appOpened = false;
    
    // Set up app and web links
    if (isIOS) {
      // iOS Twitter app URL scheme
      twitterAppLink.href = `twitter://post?message=${encodedTweet}`;
    } else if (isAndroid) {
      // Android intent
      twitterAppLink.href = `intent://post?message=${encodedTweet}#Intent;scheme=twitter;package=com.twitter.android;end`;
    }
    
    // Set web intent as fallback
    twitterWebLink.href = `https://twitter.com/intent/tweet?text=${encodedTweet}`;
    
    // Try to open the app first
    if (twitterAppLink.href) {
      // Create a timestamp to detect if we've left the page
      const beforeOpen = Date.now();
      
      // Click the link to try opening the app
      twitterAppLink.click();
      
      // Check if the app was opened
      setTimeout(() => {
        const timeElapsed = Date.now() - beforeOpen;
        // If we're still here after 1500ms and the elapsed time is small,
        // the app probably didn't open, so use the web intent
        if (timeElapsed < 1500) {
          twitterWebLink.click();
          showToast('Opening web composer...');
        } else {
          appOpened = true;
        }
      }, 1000);
    } else {
      // Just use web intent if app link couldn't be created
      twitterWebLink.click();
    }
    
    // Return after attempting to open app
    return;
  }
  
  // For desktop, just use web intent
  const webIntentUrl = `https://twitter.com/intent/tweet?text=${encodedTweet}`;
  let win = null;
  try { win = window.open(webIntentUrl, '_blank', 'noopener'); } 
  catch(e) { win = null; }
  
  if (!win) {
    try {
      await navigator.clipboard.writeText(tweet);
      showToast('Popup blocked. Tweet copied — paste into X.');
    } catch(e) {
      fallbackCopyArea.value = tweet;
      fallbackCopyArea.select();
      document.execCommand('copy');
      showToast('Popup blocked. Copied (fallback).');
    }
  } else {
    showToast('Opened X compose.');
  }
}

/* Group fetching and claiming */
async function fetchAvailableGroup() {
  const allGroupsSnap = await get(ref(db, 'groups'));
  const groupsObj = allGroupsSnap.exists() ? allGroupsSnap.val() : {};
  const keys = Object.keys(groupsObj)
    .sort((a, b) => (parseInt(a.replace('group_', '')) || 0) - (parseInt(b.replace('group_', '')) || 0));
  
  for (const key of keys) {
    const group = groupsObj[key];
    if (group.status === 'pending') {
      return { key, data: group };
    }
  }
  return null;
}

async function claimAndShareTweet() {
  // Check cooldown first
  const now = nowServer();
  if (lastShareTime && now - lastShareTime < COOLDOWN_MS) {
    const remaining = (lastShareTime + COOLDOWN_MS) - now;
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    showToast(`Please wait ${minutes}m ${seconds}s before sharing again`);
    return;
  }
  
  shareBtn.disabled = true;
  shareBtn.innerHTML = '<span class="loading"></span> Loading...';
  
  try {
    // Find an available group
    const availableGroup = await fetchAvailableGroup();
    
    if (!availableGroup) {
      showToast('No available tweets to share right now.');
      shareBtn.disabled = false;
      shareBtn.textContent = 'Share Tweet';
      return;
    }
    
    // Generate a random handle if needed in a real app
    // For this simplified version, we'll use a fixed one
    const handle = '@user' + Math.floor(Math.random() * 10000);
    
    // Mark group as in_progress
    const updates = {};
    updates[`groups/${availableGroup.key}/status`] = 'in_progress';
    updates[`groups/${availableGroup.key}/reserver`] = handle;
    await update(ref(db), updates);
    
    // Build and share the tweet
    const tweet = buildTweet(availableGroup.key, availableGroup.data);
    await shareToTwitter(tweet);
    
    // Mark as done automatically
    await update(ref(db), { [`groups/${availableGroup.key}/status`]: 'done' });
    
    // Update user stats
    tweetsShared++;
    tokensEarned += TOKENS_PER_SHARE;
    lastShareTime = nowServer();
    
    // Update UI
    tweetsSharedEl.textContent = tweetsShared;
    tokensEarnedEl.textContent = tokensEarned + ' TRILLION';
    
    // Save state
    saveUserState();
    
    // Show success message
    showToast(`Successfully shared! Earned 1 Trillion $NFTFAN tokens.`);
    
    // Start cooldown
    checkCooldown();
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Something went wrong. Please try again.');
    shareBtn.disabled = false;
    shareBtn.textContent = 'Share Tweet';
  } finally {
    if (!shareBtn.disabled) {
      shareBtn.textContent = 'Share Tweet';
    }
  }
}

/* Event listeners */
shareBtn.addEventListener('click', claimAndShareTweet);

/* Initialize */
loadUserState();
</script>
</body>
</html>
