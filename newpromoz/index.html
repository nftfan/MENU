<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>$NFTFAN Futuristic Tweet Claim</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f5f7fa">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#06070a">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<style>
/* ------------------ THEME TOKENS ------------------ */
:root {
  --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
  --ease: cubic-bezier(.4,.14,.3,1);
  --ease-bounce: cubic-bezier(.34,1.56,.64,1);
  --dur-s: .25s;
  --dur-m: .55s;
  --blur-panel: 22px;
  --radius-xs: 6px;
  --radius-sm: 10px;
  --radius-md: 16px;
  --radius-lg: 26px;
  --shadow-1: 0 2px 4px -1px rgba(0,0,0,.4), 0 8px 18px -6px rgba(0,0,0,.55);
  --shadow-focus: 0 0 0 3px #ffffff10, 0 0 0 1px var(--accent);
  --gradient-accent: linear-gradient(135deg,#4f7dff,#4d4ffb 40%,#7b2dfd 70%,#ff35a6);
  --gradient-bg: radial-gradient(circle at 18% 20%,#18202c 0%,#0d1219 40%,#07090d 80%);
  --grid-accent: linear-gradient(#ffffff03 1px,transparent 1px), linear-gradient(90deg,#ffffff05 1px,transparent 1px);
  --accent: #5d82ff;
  --accent-rgb: 93 130 255;
  --accent-alt: #ff3db9;
  --danger: #ff4d61;
  --warn: #ffbe3d;
  --success: #3ddf91;
  --text: #f2f6fb;
  --text-dim: #b6c2d6;
  --text-faint: #6f7d92;
  --surface: #11151d;
  --surface-rgb: 17 21 29;
  --panel: #171d27cc;
  --panel-solid: #1d2430;
  --panel-alt: #202a36cc;
  --border: #2d3947;
  --glass-border: #ffffff12;
  --glow: 0 0 0 1px #5d82ff40, 0 0 18px -4px #5d82ff80, 0 0 42px -10px #ff3db980;
  --focus-ring: 0 0 0 2px #ffffff10, 0 0 0 3.5px #5d82ff;
  --code-bg: #1d2734;
  --danger-bg: #38161d;
  --warn-bg: #332918;
  --success-bg: #113528;
  --toast-bg: #121c27f2;
  --backdrop-filter: saturate(140%) blur(var(--blur-panel));
  --char-ok: var(--success);
  --char-warn: var(--warn);
  --char-bad: var(--danger);
  --tap: 52px;
  --safe-top: env(safe-area-inset-top);
  --safe-bottom: env(safe-area-inset-bottom);
}

[data-theme="light"] {
  --gradient-bg: radial-gradient(circle at 25% 20%,#f5f9ff 0%,#e3e9f2 45%,#d4dbe5 90%);
  --surface: #ffffff;
  --surface-rgb: 255 255 255;
  --panel: #ffffffd8;
  --panel-alt: #f5f8fcf2;
  --panel-solid: #ffffff;
  --text: #161d29;
  --text-dim: #3e4b5b;
  --text-faint: #738194;
  --border: #d9e2ec;
  --code-bg: #edf2f7;
  --toast-bg: #1c2631e6;
  --glass-border: #00000010;
  --focus-ring: 0 0 0 2px #5d82ff50;
}

@media (prefers-color-scheme: light) {
  :root:not([data-theme="dark"]) {
    --gradient-bg: radial-gradient(circle at 25% 20%,#f5f9ff 0%,#e3e9f2 45%,#d4dbe5 90%);
    --surface: #ffffff;
  }
}

/* ------------------ RESET / BASE ------------------ */
* { box-sizing: border-box; }
html,body { height:100%; }
body {
  margin:0;
  font-family: var(--font-sans);
  -webkit-font-smoothing: antialiased;
  background:
    var(--grid-accent),
    var(--gradient-bg);
  background-size: 220px 220px, cover;
  color: var(--text);
  accent-color: var(--accent);
  overflow-x:hidden;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
}

body::before, body::after {
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 80% 15%, #5d82ff20 0%, transparent 45%),
    radial-gradient(circle at 15% 85%, #ff3db920 0%, transparent 50%);
  mix-blend-mode:color-dodge;
  z-index:0;
  animation: aura 14s var(--ease) infinite alternate;
}
@keyframes aura {
  0% { filter:hue-rotate(0deg) brightness(1); }
  50% { filter:hue-rotate(40deg) brightness(1.1); }
  100% { filter:hue-rotate(85deg) brightness(1); }
}

::selection {
  background: #5d82ff;
  color: #fff;
}

/* ------------------ TYPOGRAPHY SCALES ------------------ */
:root {
  --fs-xs: clamp(.68rem,.7rem + .1vw,.72rem);
  --fs-sm: clamp(.78rem,.75rem + .25vw,.88rem);
  --fs: clamp(.86rem,.83rem + .35vw,1rem);
  --fs-md: clamp(1rem, .95rem + .5vw, 1.2rem);
  --fs-lg: clamp(1.3rem,1.15rem + .9vw,1.9rem);
  --fs-xl: clamp(2.1rem,1.9rem + 2.1vw,3.2rem);
  --lh: 1.45;
}

p, ul, ol { line-height:var(--lh); }
h1,h2,h3 { line-height:1.18; margin:0; font-weight:600; letter-spacing:.5px; }

/* ------------------ LAYOUT ------------------ */
.app-shell {
  width:100%;
  max-width:880px;
  margin:0 auto;
  padding:calc(var(--safe-top) + 1.2rem) clamp(1rem,4vw,2rem) 4.5rem;
  flex:1 0 auto;
  position:relative;
  z-index:1;
}

header.app-head {
  margin-bottom:1.4rem;
  position:relative;
}

h1.title {
  font-size:var(--fs-xl);
  background:var(--gradient-accent);
  -webkit-background-clip:text;
  color:transparent;
  filter:drop-shadow(0 6px 12px #00000050);
  display:inline-flex;
  gap:.6ch;
  align-items:center;
}

.badge-live {
  font-size:var(--fs-xs);
  background:#ff3db9;
  color:#fff;
  padding:.25rem .55rem .3rem;
  border-radius:var(--radius-xs);
  letter-spacing:.5px;
  font-weight:600;
  box-shadow:0 2px 6px -2px #ff3db980;
}

p.desc {
  font-size:var(--fs-sm);
  max-width:64ch;
  margin:.5rem 0 0;
  color:var(--text-dim);
}

/* Responsive grid adjustments for future expansion */
.grid {
  display:grid;
  gap:1.2rem;
}

/* ------------------ PANELS / GLASS ------------------ */
.panel {
  position:relative;
  background:linear-gradient(155deg,#1e2632cc,#131a23e6 60%,#12161fef);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-lg);
  padding:1.25rem clamp(1rem,3.5vw,1.75rem) 1.9rem;
  box-shadow:var(--shadow-1);
  backdrop-filter:var(--backdrop-filter);
  -webkit-backdrop-filter:var(--backdrop-filter);
  overflow:hidden;
  isolation:isolate;
}

.panel::before {
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(120deg,#ffffff10 0%,transparent 22%,transparent 78%,#ffffff08 100%);
  pointer-events:none;
  mix-blend-mode:overlay;
  opacity:.55;
}

.panel-outline {
  position:absolute;
  inset:0;
  background:
    linear-gradient(145deg, #5d82ff22, transparent 35% 65%, #ff3db920);
  opacity:.65;
  border-radius:inherit;
  pointer-events:none;
  filter:blur(22px) saturate(250%);
}

.panel-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  flex-wrap:wrap;
  margin-bottom:1.15rem;
}

.inline-actions {
  display:flex;
  flex-wrap:wrap;
  gap:.8rem;
}

@media (max-width:560px) {
  .inline-actions {
    width:100%;
    justify-content:stretch;
  }
  .inline-actions > * {
    flex:1 1 auto;
  }
}

/* ------------------ FORM ELEMENTS ------------------ */
label {
  font-size:var(--fs-xs);
  text-transform:uppercase;
  letter-spacing:.9px;
  font-weight:600;
  color:var(--text-faint);
  margin-bottom:.4rem;
  display:flex;
  align-items:center;
  gap:.5ch;
}

input[type=text] {
  width:100%;
  border:1px solid var(--border);
  background:linear-gradient(160deg,#1d2632,#141b25);
  color:var(--text);
  padding:.92rem 1rem .95rem;
  font-size:var(--fs);
  border-radius:var(--radius-sm);
  font-family:inherit;
  letter-spacing:.3px;
  transition:border-color var(--dur-s) var(--ease), background var(--dur-s) var(--ease), box-shadow var(--dur-s) var(--ease);
  box-shadow: inset 0 0 0 1px #ffffff06;
}

input[type=text]::placeholder {
  color:var(--text-faint);
  letter-spacing:.5px;
}

input[type=text]:focus {
  outline:none;
  border-color:#5d82ff;
  background:linear-gradient(160deg,#232f3d,#161e26);
  box-shadow:var(--focus-ring), inset 0 0 0 1px #5d82ff40;
}

/* ------------------ BUTTONS ------------------ */
button {
  --btn-bg: linear-gradient(135deg,#3552ff,#5d82ff 55%,#7b2dfd);
  --btn-bg-hover: linear-gradient(135deg,#4660ff,#6a8bff 55%,#8a40ff);
  --btn-fg: #fff;
  position:relative;
  font-family:inherit;
  font-weight:600;
  font-size:var(--fs-sm);
  letter-spacing:.5px;
  line-height:1;
  border:none;
  border-radius:calc(var(--radius-sm) + 2px);
  padding:0 1.25rem;
  height:var(--tap);
  min-width:110px;
  cursor:pointer;
  background:var(--btn-bg);
  color:var(--btn-fg);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:.55rem;
  box-shadow:0 4px 14px -5px rgba(var(--accent-rgb)/.8), 0 2px 4px -2px rgba(0,0,0,.6);
  transition:transform var(--dur-s) var(--ease), box-shadow var(--dur-s) var(--ease), background var(--dur-s) var(--ease);
  will-change:transform;
  -webkit-tap-highlight-color: transparent;
}

button:before {
  content:"";
  position:absolute;
  inset:0;
  border-radius:inherit;
  background:linear-gradient(#ffffff40,#ffffff05);
  mix-blend-mode:overlay;
  opacity:.0;
  transition:opacity var(--dur-s) var(--ease);
  pointer-events:none;
}

button:hover:not(:disabled) {
  background:var(--btn-bg-hover);
  transform:translateY(-2px);
  box-shadow:0 8px 26px -6px rgba(var(--accent-rgb)/.85), 0 3px 10px -4px rgba(0,0,0,.8);
}

button:hover:not(:disabled)::before {
  opacity:.65;
}

button:active:not(:disabled) {
  transform:translateY(0);
  transition-duration:.12s;
}

button:focus-visible {
  outline:none;
  box-shadow:0 0 0 2px #ffffff30, 0 0 0 4px #5d82ff;
}

button.secondary {
  --btn-bg: linear-gradient(145deg,#262f3a,#1d242d);
  --btn-bg-hover: linear-gradient(145deg,#2d3945,#252e38);
  --btn-fg: var(--text-dim);
  box-shadow: 0 2px 10px -4px rgba(0,0,0,.6), inset 0 0 0 1px #ffffff08;
}

button.secondary:hover:not(:disabled) {
  --btn-fg: var(--text);
}

button.danger {
  --btn-bg: linear-gradient(135deg,#ff3d66,#ff4d4d);
  --btn-bg-hover: linear-gradient(135deg,#ff5076,#ff5a5a);
}

button:disabled {
  opacity:.55;
  cursor:not-allowed;
  filter:saturate(.3);
  transform:none !important;
  box-shadow:inset 0 0 0 1px #ffffff08;
}

/* Mobile full-width stacking */
@media (max-width:520px) {
  button {
    flex:1 1 auto;
    min-width:auto;
  }
}

/* ------------------ STATUS + BADGES ------------------ */
.badge {
  display:inline-flex;
  align-items:center;
  gap:.4ch;
  font-size:var(--fs-xs);
  font-weight:600;
  letter-spacing:.6px;
  padding:.35rem .7rem .4rem;
  background:#1e2834;
  color:var(--text-dim);
  border-radius: 999px;
  box-shadow: inset 0 0 0 1px #ffffff10;
  text-transform:uppercase;
}

.badge.pending { background:var(--warn-bg); color:var(--warn); }
.badge.in_progress { background:#243046; color:#5d82ff; }
.badge.done { background:var(--success-bg); color:var(--success); }

.meta-line {
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
  margin:.2rem 0 0;
}

/* ------------------ CLAIMED BOX ------------------ */
.status-box {
  margin-top:1rem;
  background:
    linear-gradient(155deg,#202a36f2,#141b25f7 65%);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-md);
  padding:1.05rem 1rem 1.25rem;
  position:relative;
  backdrop-filter:var(--backdrop-filter);
  -webkit-backdrop-filter:var(--backdrop-filter);
  box-shadow: inset 0 0 0 1px #ffffff06, 0 8px 32px -18px #000;
  overflow:hidden;
}

.status-box::before {
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(120deg,#ffffff0a,transparent 50%,#ffffff05);
  pointer-events:none;
  opacity:.6;
}

.status-box h2 {
  font-size:var(--fs-md);
  font-weight:600;
  margin:0 0 .7rem;
  letter-spacing:.75px;
  color:var(--text);
}

/* ------------------ TWEET PREVIEW ------------------ */
.tweet-preview {
  position:relative;
  background: linear-gradient(160deg,#1c2530,#161d26);
  border:1px solid #ffffff12;
  border-radius:var(--radius-md);
  padding:1rem 1rem 3.1rem;
  font-family:inherit;
  font-size:var(--fs);
  color:var(--text);
  line-height:1.45;
  box-shadow: inset 0 0 0 1px #ffffff05, 0 4px 16px -8px #000;
  animation: fadeSlide .55s var(--ease) both;
  overflow-wrap:anywhere;
}

@keyframes fadeSlide {
  0% { opacity:0; transform:translateY(8px) scale(.985); }
  100% { opacity:1; transform:translateY(0) scale(1); }
}

.tweet-preview code {
  font-family:inherit;
  font-size:inherit;
  font-weight:500;
  color:var(--text-dim);
  background:none;
  padding:0;
}

.copy-btn {
  position:absolute;
  right:.55rem;
  bottom:.55rem;
  background:#2a3644;
  color:var(--text-dim);
  font-size:var(--fs-xs);
  padding:.55rem .75rem;
  height:auto;
  min-width:auto;
  border-radius:var(--radius-xs);
  box-shadow:none;
  letter-spacing:.5px;
  font-weight:600;
  transition: background var(--dur-s) var(--ease), color var(--dur-s) var(--ease), transform var(--dur-s) var(--ease);
}

.copy-btn:hover {
  background:#344353;
  color:var(--text);
}

.char-counter {
  font-size:var(--fs-xs);
  font-weight:600;
  letter-spacing:.8px;
  margin:.55rem .15rem 1rem;
  display:flex;
  align-items:center;
  gap:.5ch;
  text-transform:uppercase;
}
.char-counter.ok { color:var(--char-ok); }
.char-counter.warn { color:var(--char-warn); }
.char-counter.bad { color:var(--char-bad); }

/* ------------------ FEEDBACK / TOAST ------------------ */
.toast {
  position:fixed;
  z-index:100;
  right:clamp(.75rem,4vw,2rem);
  bottom:calc(var(--safe-bottom) + 1rem);
  max-width:min(360px,90vw);
  background:var(--toast-bg);
  backdrop-filter:blur(22px) saturate(160%);
  -webkit-backdrop-filter:blur(22px) saturate(160%);
  border:1px solid #ffffff20;
  box-shadow:0 12px 40px -12px rgba(0,0,0,.6), 0 0 0 1px #ffffff08;
  padding:.95rem 1.05rem 1rem;
  border-radius:var(--radius-lg);
  font-size:var(--fs-sm);
  line-height:1.4;
  opacity:0;
  transform:translateY(14px) scale(.96);
  pointer-events:none;
  transition:opacity .5s var(--ease), transform .55s var(--ease);
}
.toast.show {
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:auto;
}

/* ------------------ FOOTER ------------------ */
footer {
  width:100%;
  padding:2rem clamp(1rem,4vw,2rem) calc(var(--safe-bottom) + 2.5rem);
  font-size:var(--fs-xs);
  color:var(--text-faint);
  text-align:center;
  line-height:1.5;
  backdrop-filter:blur(24px) saturate(130%);
  background:linear-gradient(180deg, #ffffff04, #ffffff00);
  position:relative;
  z-index:1;
  margin-top:auto;
}

footer a {
  color:var(--accent);
  text-decoration:none;
  font-weight:600;
  transition:color var(--dur-s) var(--ease);
}
footer a:hover {
  color:var(--accent-alt);
  text-decoration:underline;
}

/* ------------------ UTILS ------------------ */
.error {
  margin-top:.7rem;
  background:var(--danger-bg);
  color:var(--danger);
  padding:.75rem .9rem;
  border-radius:var(--radius-sm);
  font-size:var(--fs-xs);
  font-weight:600;
  letter-spacing:.6px;
  display:none;
  box-shadow:inset 0 0 0 1px #ff4d6125, 0 2px 6px -3px #000;
}

.info-line {
  font-size:var(--fs-xs);
  color:var(--text-faint);
  margin-top:.9rem;
  letter-spacing:.4px;
}

/* Cooldown box */
#cooldownStatus {
  margin-top:1.1rem;
  font-size:var(--fs-sm);
  color:var(--text-dim);
  display:flex;
  flex-wrap:wrap;
  gap:.65rem;
  align-items:center;
  background:linear-gradient(140deg,#212b36,#192129);
  padding:.9rem 1rem;
  border:1px solid #ffffff10;
  border-radius:var(--radius-md);
  box-shadow: inset 0 0 0 1px #ffffff06;
  position:relative;
  overflow:hidden;
}

#cooldownStatus::before {
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(110deg,#ffffff08,transparent 40%,transparent 60%,#ffffff05);
  opacity:.5;
  pointer-events:none;
}

.countdown {
  font-weight:700;
  font-variant-numeric:tabular-nums;
  font-size:var(--fs-sm);
  padding:.15rem .6rem .2rem;
  border-radius:var(--radius-xs);
  background:#2a3646;
  color:var(--warn);
  letter-spacing:.5px;
  box-shadow:inset 0 0 0 1px #ffffff08;
}

/* Accessible focus for any focusable element */
:focus-visible {
  outline:2px solid #5d82ff;
  outline-offset:2px;
  border-radius:4px;
}

/* Motion reduction */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration:.001ms !important;
    animation-iteration-count:1 !important;
    transition-duration:.001ms !important;
    scroll-behavior:auto !important;
  }
  body::before, body::after { display:none; }
}

/* Theme toggle */
.theme-toggle {
  position:fixed;
  z-index:120;
  top:calc(var(--safe-top) + .75rem);
  right:clamp(.75rem,3vw,1.25rem);
  background:linear-gradient(145deg,#212c38,#18212b);
  height:42px;
  width:42px;
  border-radius:50%;
  border:1px solid #ffffff14;
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow:0 8px 24px -12px rgba(0,0,0,.8), 0 2px 6px -2px #000;
  backdrop-filter:blur(18px) saturate(140%);
  -webkit-backdrop-filter:blur(18px) saturate(140%);
  transition:background var(--dur-s) var(--ease), transform var(--dur-s) var(--ease);
}
.theme-toggle:hover {
  transform:translateY(-3px);
  background:linear-gradient(145deg,#293544,#1d2731);
}
.theme-toggle:active { transform:translateY(-1px); }
.theme-toggle svg {
  width:22px;
  height:22px;
  stroke:var(--text-dim);
  stroke-width:2;
  fill:none;
  transition:stroke var(--dur-s) var(--ease);
}
.theme-toggle:hover svg { stroke:var(--accent); }

/* Mobile enhancements */
@media (max-width:480px) {
  .app-shell {
    padding:calc(var(--safe-top) + .9rem) .95rem 4.5rem;
  }
  h1.title { font-size:clamp(1.45rem,6vw,2.3rem); }
  .status-box, .panel { padding:1.05rem 1rem 1.35rem; }
  .tweet-preview { padding:1rem 1rem 3rem; }
  button { height:54px; }
}

/* Floating "Mark Done" on very small screens after scroll */
@media (max-width:420px) {
  #doneBtn {
    position:relative;
  }
}

/* Optional subtle pulse for pending state tag */
@keyframes pulseGlow {
  0% { box-shadow:0 0 0 0 rgba(255,190,61,.0); }
  35% { box-shadow:0 0 0 6px rgba(255,190,61,.15); }
  100% { box-shadow:0 0 0 0 rgba(255,190,61,0); }
}
.badge.pending {
  animation:pulseGlow 4s ease-out infinite;
}
</style>
</head>
<body>
<button class="theme-toggle" aria-label="Toggle color theme" id="themeToggle">
  <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <circle cx="12" cy="12" r="5"></circle>
    <path d="M12 1v2m0 18v2M4.22 4.22 5.64 5.64m12.72 12.72 1.42 1.42M1 12h2m18 0h2M6 18l-1.42 1.42M18 6l1.42-1.42"/>
  </svg>
</button>

<main class="app-shell" id="app">
  <header class="app-head">
    <h1 class="title">$NFTFAN <span class="badge-live">LIVE</span></h1>
    <p class="desc">
      Claim a group of usernames (max one per 60 min), share the welcome tweet, then mark it done. Designed for fast mobile flow & futuristic clarity.
    </p>
  </header>

  <section class="panel" aria-labelledby="claim-section-heading">
    <div class="panel-outline" aria-hidden="true"></div>
    <div class="panel-header">
      <div style="flex:1 1 auto; min-width:240px;">
        <label for="handleInput">Your Handle</label>
        <input id="handleInput" type="text" placeholder="@yourname" autocomplete="off" spellcheck="false" inputmode="text">
      </div>
      <div class="inline-actions" role="group" aria-label="Claim actions">
        <button id="claimBtn" type="button">Get a Tweet</button>
        <button id="resetBtn" type="button" class="secondary" title="Clear remembered handle & state">Reset</button>
      </div>
    </div>
    <div id="errorMsg" class="error" role="alert" aria-live="assertive"></div>

    <div id="claimedBox" class="status-box" style="display:none;" aria-live="polite">
      <h2 id="claim-section-heading">Claimed Group</h2>
      <div id="groupMeta" class="meta-line"></div>

      <div class="tweet-preview" id="tweetPreview" aria-label="Tweet preview">
        <code id="tweetText"></code>
        <button class="copy-btn" id="copyBtn" type="button" aria-label="Copy tweet text">Copy</button>
      </div>

      <div id="charCounter" class="char-counter ok" aria-live="polite"></div>

      <div class="inline-actions" role="group" aria-label="Tweet actions">
        <button id="shareBtn" type="button">Share on X</button>
        <button id="doneBtn" type="button" class="secondary">Mark Done</button>
      </div>

      <div class="info-line" id="cooldownLine"></div>
    </div>

    <div id="cooldownStatus" style="display:none;" aria-live="polite"></div>
  </section>
</main>

<footer>
  Client-side rate limiting only. For stronger integrity add auth, a backend, or signed verification of posted tweet.
  <br><br>
  <a href="#" id="exportClaimData">Download my claim record</a>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>
<textarea id="fallbackCopyArea" aria-hidden="true" tabindex="-1" style="position:absolute;left:-9999px;top:-9999px;"></textarea>

<script type="module">
/* Core logic retained from previous version with minor ergonomic improvements */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
  authDomain: "newnft-47bd7.firebaseapp.com",
  databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
  projectId: "newnft-47bd7",
  storageBucket: "newnft-47bd7.firebasestorage.app",
  messagingSenderId: "172043823738",
  appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
  measurementId: "G-8VB3DYRNXR"
};
initializeApp(firebaseConfig);
const db = getDatabase();

/* Config */
const cooldownMinutes = 60;
const cooldownMs = cooldownMinutes * 60 * 1000;
const TWEET_MAX = 280;
const autoTrimOverflow = true;

/* Elements */
const handleInput = document.getElementById('handleInput');
const claimBtn = document.getElementById('claimBtn');
const resetBtn = document.getElementById('resetBtn');
const errorMsg = document.getElementById('errorMsg');
const claimedBox = document.getElementById('claimedBox');
const groupMeta = document.getElementById('groupMeta');
const tweetTextEl = document.getElementById('tweetText');
const copyBtn = document.getElementById('copyBtn');
const shareBtn = document.getElementById('shareBtn');
const doneBtn = document.getElementById('doneBtn');
const cooldownStatus = document.getElementById('cooldownStatus');
const cooldownLine = document.getElementById('cooldownLine');
const toastEl = document.getElementById('toast');
const exportClaimData = document.getElementById('exportClaimData');
const charCounter = document.getElementById('charCounter');
const fallbackCopyArea = document.getElementById('fallbackCopyArea');
const themeToggle = document.getElementById('themeToggle');

/* Server Time Offset */
let serverOffset = 0;
onValue(ref(db, '.info/serverTimeOffset'), s => serverOffset = s.val() || 0);
const nowServer = () => Date.now() + serverOffset;

/* Theme persistence */
const THEME_KEY = 'nftfan_theme';
function applyStoredTheme() {
  const t = localStorage.getItem(THEME_KEY);
  if (!t) return;
  document.documentElement.dataset.theme = t;
}
applyStoredTheme();
themeToggle.addEventListener('click', () => {
  const current = document.documentElement.dataset.theme;
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.dataset.theme = next;
  localStorage.setItem(THEME_KEY, next);
});

/* Helpers */
function showToast(msg, t=3200) {
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), t);
}
function validateHandle(raw) {
  return /^@[A-Za-z0-9_]{2,32}$/.test(raw.trim());
}
function setError(text) {
  if (!text) { errorMsg.style.display='none'; }
  else {
    errorMsg.textContent = text;
    errorMsg.style.display='block';
  }
}

/* Tweet building & sharing */
function buildTweet(_groupKey, groupData) {
  const usernames = (groupData.usernames || []).filter(Boolean);
  let listPart='';
  if (usernames.length===1) listPart=usernames[0];
  else if (usernames.length===2) listPart=`${usernames[0]} and ${usernames[1]}`;
  else listPart = `${usernames[0]}, ${usernames[1]} and ${usernames[2]}`;
  return `Welcome to $NFTFAN community you are eligible for 5B free $NFTFAN please follow @nftfanstoken to claim. Winners are: ${listPart}.`;
}
function normalizeTweet(text) {
  return text.replace(/\s+/g,' ').trim();
}
function updateCharCounter(text) {
  const len = Array.from(text).length;
  let cls='ok';
  if (len>TWEET_MAX) cls='bad';
  else if (len> TWEET_MAX - 18) cls='warn';
  charCounter.className = 'char-counter '+cls;
  charCounter.textContent = `${len}/${TWEET_MAX} CHARACTERS`;
}
function ensureLength(text) {
  updateCharCounter(text);
  if (text.length <= TWEET_MAX) return text;
  if (!autoTrimOverflow) {
    showToast('Tweet exceeds 280 chars.');
    return text;
  }
  const trimmed = text.slice(0,TWEET_MAX);
  updateCharCounter(trimmed);
  return trimmed;
}
function buildIntentURL(text) {
  return `https://x.com/intent/tweet?text=${encodeURIComponent(text)}`;
}
async function safeOpenTweetIntent(tweet) {
  const normalized = normalizeTweet(tweet);
  const finalText = ensureLength(normalized);
  const url = buildIntentURL(finalText);
  let win = null;
  try { win = window.open(url,'_blank','noopener'); } catch(e){ win=null; }
  if (!win) {
    try {
      await navigator.clipboard.writeText(finalText);
      showToast('Popup blocked. Tweet copied — paste into X.');
    } catch(e){
      fallbackCopyArea.value=finalText;
      fallbackCopyArea.select();
      document.execCommand('copy');
      showToast('Popup blocked. Copied (fallback).');
    }
  } else {
    showToast('Opened X compose.');
  }
}

/* Countdown */
let countdownTimer = null;
function startCountdown(nextAllowed) {
  stopCountdown();
  function tick() {
    const remain = nextAllowed - nowServer();
    if (remain <= 0) {
      cooldownStatus.innerHTML = '<span class="badge done">READY</span> You can claim a new tweet.';
      claimBtn.disabled=false;
      stopCountdown();
      return;
    }
    const m = Math.floor(remain/60000);
    const s = Math.floor((remain%60000)/1000);
    cooldownStatus.innerHTML = '<span class="badge pending">COOLDOWN</span> Next claim in <span class="countdown">'+String(m).padStart(2,'0')+':'+String(s).padStart(2,'0')+'</span>';
    claimBtn.disabled=true;
  }
  tick();
  countdownTimer = setInterval(tick,1000);
}
function stopCountdown() {
  if (countdownTimer) {
    clearInterval(countdownTimer);
    countdownTimer=null;
  }
}

/* Data access */
async function loadExistingClaim(handle) {
  const snap = await get(ref(db, `claimers/${handle}`));
  return snap.exists() ? snap.val() : null;
}
async function fetchGroup(groupKey) {
  const snap = await get(ref(db, `groups/${groupKey}`));
  return snap.exists() ? snap.val() : null;
}

/* UI Rendering */
function showGroup(groupKey, groupData, lastClaimTs) {
  claimedBox.style.display='block';
  groupMeta.innerHTML = `
    <span class="badge ${groupData.status}">${groupData.status.replace('_',' ')}</span>
    <span style="font-weight:600; letter-spacing:.5px;">${groupKey.replace('group_','Group ')}</span>
    <span style="font-size:var(--fs-xs); color:var(--text-faint);">Usernames:
      <strong style="color:var(--text-dim); font-weight:600;">
        ${(groupData.usernames||[]).join(', ')}
      </strong>
    </span>
  `;
  const tweet = buildTweet(groupKey, groupData);
  tweetTextEl.textContent = tweet;
  updateCharCounter(tweet);

  shareBtn.onclick = () => {
    const latest = buildTweet(groupKey, groupData);
    safeOpenTweetIntent(latest);
  };
  copyBtn.onclick = () => {
    const txt = buildTweet(groupKey, groupData);
    navigator.clipboard.writeText(txt)
      .then(()=> showToast('Copied tweet text'))
      .catch(()=> showToast('Copy failed'));
  };
  doneBtn.onclick = async () => {
    doneBtn.disabled=true;
    try {
      await update(ref(db), { [`groups/${groupKey}/status`]: 'done' });
      showToast('Marked done.');
      groupData.status='done';
      showGroup(groupKey, groupData, lastClaimTs);
    } catch(e) {
      console.error(e);
      showToast('Failed to mark done');
      doneBtn.disabled=false;
    }
  };
  doneBtn.disabled = groupData.status === 'done';

  if (lastClaimTs) {
    const nextAllowed = lastClaimTs + cooldownMs;
    cooldownLine.textContent = nowServer() < nextAllowed ?
      'You can claim a new tweet after: '+ new Date(nextAllowed).toLocaleTimeString() :
      'You can now claim a new tweet.';
  } else {
    cooldownLine.textContent='';
  }
}

async function claimTweet() {
  setError('');
  const handleRaw = handleInput.value.trim();
  if (!validateHandle(handleRaw)) {
    setError('Enter a valid @handle (2–32 alphanumeric or underscore).');
    return;
  }
  const handle = handleRaw;
  claimBtn.disabled=true;
  claimBtn.textContent='Checking…';

  try {
    const existing = await loadExistingClaim(handle);
    let lastClaimTs = existing?.lastClaim || null;

    if (existing?.lastGroupKey) {
      const g = await fetchGroup(existing.lastGroupKey);
      if (g && g.status !== 'done') {
        showGroup(existing.lastGroupKey, g, lastClaimTs);
        prepareCooldown(lastClaimTs);
        showToast('Loaded existing claim.');
        return;
      }
    }
    if (lastClaimTs && nowServer() - lastClaimTs < cooldownMs) {
      prepareCooldown(lastClaimTs);
      showToast('Cooldown active.');
      claimBtn.textContent='Get a Tweet';
      return;
    }

    const allGroupsSnap = await get(ref(db,'groups'));
    const groupsObj = allGroupsSnap.exists() ? allGroupsSnap.val() : {};
    const keys = Object.keys(groupsObj)
      .sort((a,b)=>(parseInt(a.replace('group_',''))||0) - (parseInt(b.replace('group_',''))||0));
    let chosenKey=null;
    for (const k of keys) {
      const g = groupsObj[k];
      if (g.status === 'pending') { chosenKey=k; break; }
    }
    if (!chosenKey) {
      showToast('No pending groups available.');
      claimBtn.textContent='Get a Tweet';
      claimBtn.disabled=false;
      return;
    }

    const updates = {};
    updates[`groups/${chosenKey}/status`] = 'in_progress';
    updates[`groups/${chosenKey}/reserver`] = handle;
    updates[`claimers/${handle}/lastClaim`] = serverTimestamp();
    updates[`claimers/${handle}/lastGroupKey`] = chosenKey;
    await update(ref(db), updates);

    const groupData = await fetchGroup(chosenKey);
    lastClaimTs = nowServer();
    showGroup(chosenKey, groupData, lastClaimTs);
    prepareCooldown(lastClaimTs);
    showToast('Tweet claimed.');
  } catch(e) {
    console.error(e);
    setError('Failed to claim a tweet. Try again.');
    claimBtn.disabled=false;
  } finally {
    claimBtn.textContent='Get a Tweet';
  }
}

function prepareCooldown(lastClaimTs) {
  if (!lastClaimTs) {
    cooldownStatus.style.display='none';
    claimBtn.disabled=false;
    stopCountdown();
    return;
  }
  const nextAllowed = lastClaimTs + cooldownMs;
  if (nowServer() < nextAllowed) {
    cooldownStatus.style.display='flex';
    startCountdown(nextAllowed);
  } else {
    cooldownStatus.style.display='flex';
    cooldownStatus.innerHTML='<span class="badge done">READY</span> You can claim a new tweet.';
    claimBtn.disabled=false;
  }
}

/* Local storage handle */
const LS_HANDLE = 'nftfan_handle';
const savedHandle = localStorage.getItem(LS_HANDLE);
if (savedHandle) handleInput.value = savedHandle;
handleInput.addEventListener('change', () => {
  const v=handleInput.value.trim();
  if (validateHandle(v)) localStorage.setItem(LS_HANDLE,v);
});

/* Event bindings */
claimBtn.addEventListener('click', claimTweet);
resetBtn.addEventListener('click', () => {
  handleInput.value='';
  localStorage.removeItem(LS_HANDLE);
  claimedBox.style.display='none';
  cooldownStatus.style.display='none';
  stopCountdown();
  showToast('Handle reset.');
});
exportClaimData.addEventListener('click', async (e) => {
  e.preventDefault();
  const handle = handleInput.value.trim();
  if (!validateHandle(handle)) {
    showToast('Enter a valid handle first.');
    return;
  }
  try {
    const snap = await get(ref(db, `claimers/${handle}`));
    const data = snap.exists() ? snap.val() : {};
    const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download = `${handle.replace('@','')}-claim.json`;
    a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 900);
  } catch(e2) {
    showToast('Export failed.');
  }
});

/* Auto-load existing claim if handle present */
(async () => {
  const h = handleInput.value.trim();
  if (validateHandle(h)) {
    try {
      const existing = await loadExistingClaim(h);
      if (existing?.lastClaim) {
        const lastClaimTs = existing.lastClaim;
        if (existing.lastGroupKey) {
          const g = await fetchGroup(existing.lastGroupKey);
            if (g && g.status !== 'done') {
              showGroup(existing.lastGroupKey, g, lastClaimTs);
            }
        }
        prepareCooldown(lastClaimTs);
      }
    } catch {}
  }
})();
</script>
</body>
</html>
