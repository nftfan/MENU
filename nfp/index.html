<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFT FAN Posts — Mint Image Posts on Polygon</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #050509;
      --panel: #111119;
      --border: #24242f;
      --text: #eebd6e;
      --muted: #9b7f4a;
      --accent: #eebd6e;
      --error: #ff4b4b;
      --success: #7ed957;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 10px;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    #app-container {
      width: 100%;
      max-width: 880px;
      padding: 8px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 6px;
      margin-bottom: 8px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .logo {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }

    .logo .material-icons {
      font-size: 10px;
      color: var(--text);
    }

    .title-main { font-size: 10px; font-weight: 600; }
    .title-sub { font-size: 9px; color: var(--muted); }

    .actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 3px 6px;
      font-size: 9px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill .material-icons { font-size: 10px; }

    button {
      border: 1px solid var(--border);
      background: #14141c;
      color: var(--text);
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button .material-icons { font-size: 10px; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .wallet {
      font-size: 9px;
      padding: 3px 6px;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--text);
    }

    main {
      display: grid;
      grid-template-columns: 1.2fr 1.1fr;
      gap: 8px;
    }

    @media (max-width: 720px) {
      main { grid-template-columns: 1fr; }
    }

    .panel {
      background: var(--panel);
      border-radius: 4px;
      border: 1px solid var(--border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }

    .panel-header-title { font-size: 9px; font-weight: 600; }

    .row { display: flex; flex-direction: column; gap: 6px; }
    .row.inline { flex-direction: row; flex-wrap: wrap; align-items: center; gap: 6px; }

    .status {
      font-size: 9px;
      padding: 6px;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--muted);
      min-height: 20px;
      display: flex;
      align-items: center;
    }
    .status.success { color: var(--success); border-color: var(--success); }
    .status.error { color: var(--error); border-color: var(--error); }
    .status.loading { gap: 4px; }

    .spinner {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.1);
      border-left-color: var(--text);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .tag {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 2px 6px;
      font-size: 9px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
    }
    .tag .material-icons { font-size: 10px; }

    .name-color-input {
      width: 40px;
      height: 16px;
      padding: 0;
      border-radius: 3px;
      border: 1px solid var(--border);
      background: #090910;
    }

    a.username-link {
      color: inherit;
      text-decoration: none;
    }
    a.username-link:hover { text-decoration: underline; }

    .right { text-align: right; }

    #initial-loader {
      position: fixed;
      inset: 0;
      background: #050509;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      z-index: 9999;
    }
    #initial-loader.hidden { display: none; }

    #cityLoading {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #111119;
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 3px;
      display: none;
      align-items: center;
      gap: 4px;
      font-size: 9px;
    }
    #cityLoading .spinner {
      width: 8px;
      height: 8px;
      border-width: 1.5px;
    }
    #cityLoading .material-icons { font-size: 10px; }

    .small-note {
      font-size: 8px;
      color: var(--muted);
    }

    /* Image grid styles */
    #imageGridContainer {
      max-height: 260px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 4px;
    }

    .image-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    @media (max-width: 720px) {
      .image-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 1024px) {
      .image-grid {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .image-card {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      background: #090910;
      border: 1px solid #1b1b25;
      cursor: pointer;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
      display: flex;
      flex-direction: column;
    }

    .image-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(238, 189, 110, 0.4);
      border-color: var(--accent);
    }

    .image-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(238, 189, 110, 0.8);
    }

    .image-card.minted::after {
      content: "Minted";
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(255, 75, 75, 0.85);
      color: #fff;
      font-size: 8px;
      padding: 2px 4px;
      border-radius: 3px;
    }

    /* IMPORTANT: fit image fully in box, no cropping */
    .image-card img {
      width: 100%;
      aspect-ratio: 4 / 5;       /* poster-like box */
      object-fit: contain;       /* show whole image, no crop */
      background: #000;          /* letterbox/pillarbox background */
      display: block;
    }

    .image-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 4px 4px 4px;
      font-size: 8px;
      color: var(--muted);
      border-top: 1px solid #1b1b25;
      background: rgba(5,5,9,0.95);
    }

    .image-card-status {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }

    .image-card-status.available {
      color: var(--success);
    }

    .image-card-status.taken {
      color: var(--error);
    }

    .image-card-index {
      opacity: 0.6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9px;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 4px 3px;
    }

    th {
      color: var(--muted);
      text-align: left;
    }

    tr:last-child td { border-bottom: none; }
  </style>
</head>
<body>
  <div id="initial-loader">
    <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
      <div class="spinner"></div>
      <div>Loading NFT FAN POSTS…</div>
    </div>
  </div>

  <div id="app-container">
    <header>
      <div class="brand">
        <div class="logo"><span class="material-icons">image</span></div>
        <div>
          <div class="title-main">NFT FAN Posts</div>
          <div class="title-sub">Mint image posts on Polygon</div>
        </div>
      </div>
      <div class="actions">
        <span class="pill">
          <span class="material-icons">paid</span>
          <span>Price: 1 POL</span>
        </span>
        <button id="connectBtn">
          <span class="material-icons">account_balance_wallet</span>
          <span>Connect</span>
        </button>
        <span id="wallet" class="wallet" style="display:none;"></span>
      </div>
    </header>

    <main>
      <!-- LEFT: Mint control -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-header-title">Mint a post</div>
        </div>

        <div class="row">
          <div class="tag">
            <span class="material-icons">info</span>
            <span>
              These cards are image URLs stored in Firebase (for example Twitter images).
              Pick a card, choose a color label, then mint your NFT FAN POST.
            </span>
          </div>
          <span class="small-note">
            This is a separate app (NFT FAN Posts). It does not show data from the old “fan names” app.
          </span>
        </div>

        <div class="row">
          <div class="panel-header-title" style="border-bottom:none;padding-bottom:0;">Available posts</div>
          <div id="imageGridContainer">
            <div id="image-grid" class="image-grid"></div>
          </div>
          <span id="noImagesNote" class="small-note" style="display:none;">
            No image URLs found yet. Use your uploader app to push URLs under <code>imageUrls</code> in Firebase.
          </span>
        </div>

        <div class="row inline">
          <span id="selectionPill" class="tag" style="display:none;"></span>
          <span id="ownedCountPill" class="tag" style="display:none;"></span>
          <span id="mintedCountPill" class="tag" style="display:none;"></span>
        </div>

        <div class="row inline">
          <button id="mintBtn" disabled>
            <span class="material-icons">rocket_launch</span>
            <span>Mint selected</span>
          </button>
          <button id="clearBtn">
            <span class="material-icons">delete_sweep</span>
            <span>Clear</span>
          </button>
          <button id="refreshBtn">
            <span class="material-icons">refresh</span>
            <span>Refresh</span>
          </button>
          <div style="flex:1;"></div>
          <div class="tag">
            <span>Color:</span>
            <input id="nameColorInput" class="name-color-input" type="color" value="#eebd6e" />
          </div>
        </div>

        <div id="status" class="status">
          Connect wallet, pick a post image, choose a color, then mint.
        </div>
      </section>

      <!-- RIGHT: Minted posts list (for THIS app only) -->
      <section class="panel">
        <div class="panel-header">
          <div class="panel-header-title">Minted NFT FAN Posts</div>
        </div>
        <div style="max-height:320px;overflow-y:auto;">
          <table>
            <thead>
              <tr>
                <th>Post</th>
                <th>Owner</th>
                <th class="right">Price (POL)</th>
              </tr>
            </thead>
            <tbody id="minted-body"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <div id="cityLoading">
    <span class="spinner"></span>
    <span class="material-icons">image</span>
    <span class="text">Loading posts…</span>
  </div>

  <script>
    // Polygon
    const POLYGON_PARAMS = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };

    // Contract (same as before, just re‑used)
    const CONTRACT_ADDRESS = "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC";
    const CONTRACT_ABI = [
      "function mintWithURI(string tokenURI) external payable returns (uint256)",
      "function mintPrice() view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function ownerOf(uint256 tokenId) view returns (address)",
      "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
    ];
    const FIXED_MINT_PRICE_POL = 1;

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
      authDomain: "newnft-47bd7.firebaseapp.com",
      databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
      projectId: "newnft-47bd7",
      storageBucket: "newnft-47bd7.firebasestorage.app",
      messagingSenderId: "172043823738",
      appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
      measurementId: "G-8VB3DYRNXR"
    };

    // State
    let web3Provider, signer, userAddress;
    let nameColor = '#eebd6e';
    let selectedIndex = null;  // index into firebaseImageUrls
    let selectedPostKey = '';  // e.g. "Post#1"

    let fbApp, fbDb, postsRef = null, imagesRef = null;
    const postsById = new Map(); // tokenId -> post data for THIS app only

    let firebaseImageUrls = [];  // [{_id, url, created_at}, ...]

    // UI
    const initialLoader = document.getElementById('initial-loader');
    const connectBtn = document.getElementById('connectBtn');
    const walletEl = document.getElementById('wallet');
    const mintBtn = document.getElementById('mintBtn');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const selectionPill = document.getElementById('selectionPill');
    const ownedCountPill = document.getElementById('ownedCountPill');
    const mintedCountPill = document.getElementById('mintedCountPill');
    const cityLoadingEl = document.getElementById('cityLoading');
    const cityLoadingText = cityLoadingEl.querySelector('.text');
    const nameColorInput = document.getElementById('nameColorInput');
    const imageGrid = document.getElementById('image-grid');
    const mintedBody = document.getElementById('minted-body');
    const noImagesNote = document.getElementById('noImagesNote');

    function setStatus(msg, type = '') {
      statusEl.className = 'status';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'loading') {
        statusEl.classList.add('loading');
        statusEl.innerHTML = '<span class="spinner"></span><span>' + msg + '</span>';
      } else {
        statusEl.textContent = msg;
      }
    }

    function showCityLoading(text = 'Loading posts…') {
      cityLoadingText.textContent = text;
      cityLoadingEl.style.display = 'flex';
      setTimeout(() => {
        if (cityLoadingEl.style.display !== 'none') {
          cityLoadingEl.style.display = 'none';
        }
      }, 20000);
    }

    function hideCityLoading() {
      cityLoadingEl.style.display = 'none';
    }

    function escapeHTML(s) {
      return String(s || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function shortAddr(a) {
      return a ? a.slice(0, 6) + '...' + a.slice(-4) : '';
    }

    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_PARAMS.chainId }]
        });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [POLYGON_PARAMS]
            });
            return true;
          } catch {
            setStatus('Failed to add Polygon network.', 'error');
            return false;
          }
        }
        setStatus('Failed to switch network.', 'error');
        return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        setStatus('Please install MetaMask.', 'error');
        return;
      }
      try {
        setStatus('Connecting wallet…', 'loading');
        if (!await switchToPolygon()) return;

        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        await web3Provider.send('eth_requestAccounts', []);
        signer = web3Provider.getSigner();
        userAddress = await signer.getAddress();

        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span><span>Connected</span>';
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';

        setStatus('Wallet connected. Choose a post to mint.', 'success');
        updateMintButtonState();

        if (window.ethereum?.on) {
          window.ethereum.removeListener?.('accountsChanged', onAccountsChanged);
          window.ethereum.on('accountsChanged', onAccountsChanged);
        }
      } catch (e) {
        console.error(e);
        setStatus('Wallet connection failed.', 'error');
      }
    }

    async function onAccountsChanged(accounts) {
      userAddress = (accounts && accounts[0]) ? accounts[0] : null;
      if (userAddress) {
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span><span>Connected</span>';
      } else {
        walletEl.style.display = 'none';
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<span class="material-icons">account_balance_wallet</span><span>Connect</span>';
      }
      updateMintButtonState();
      updateOwnedCount();
    }

    function selectByIndex(idx) {
      selectedIndex = idx;
      selectedPostKey = 'Post#' + (idx + 1);

      document.querySelectorAll('.image-card').forEach((card, i) => {
        card.classList.toggle('selected', i === idx);
      });

      if (selectedPostKey) {
        const minted = isPostKeyMinted(selectedPostKey);
        selectionPill.style.display = 'inline-flex';
        selectionPill.innerHTML =
          '<span class="material-icons">image</span>' +
          '<span>' + escapeHTML(selectedPostKey) + '</span>' +
          '<span style="color:' + (minted ? '#ff4b4b' : '#eebd6e') + ';">' +
          (minted ? 'Minted' : 'Available') +
          '</span>';
      } else {
        selectionPill.style.display = 'none';
      }

      updateMintButtonState();
      renderImageGrid(); // refresh minted overlay
    }

    function isPostKeyMinted(postKey) {
      for (const v of postsById.values()) {
        if (v.meta && v.meta.post_key === postKey) return true;
      }
      return false;
    }

    function updateNameColorState() {
      nameColor = nameColorInput.value || '#eebd6e';
      updateMintButtonState();
    }

    function updateMintButtonState() {
      const hasWallet = !!userAddress;
      const hasSelection = selectedIndex !== null && selectedIndex >= 0;
      const taken = hasSelection && selectedPostKey && isPostKeyMinted(selectedPostKey);

      mintBtn.disabled = !hasWallet || !hasSelection || taken;

      if (!hasWallet) {
        setStatus('Connect wallet, then choose a post.', '');
      } else if (!hasSelection) {
        setStatus('Choose a post image from the grid.', '');
      } else if (taken) {
        setStatus('This post is already minted.', 'error');
      } else {
        setStatus('Ready to mint this NFT FAN POST for 1 POL.', 'success');
      }
    }

    async function mintSelectedPost() {
      try {
        if (!userAddress) {
          setStatus('Connect wallet first.', 'error');
          return;
        }
        if (selectedIndex === null || selectedIndex < 0 || !firebaseImageUrls[selectedIndex]) {
          setStatus('Choose a post first.', 'error');
          return;
        }
        if (!selectedPostKey) {
          setStatus('Internal error: no post key.', 'error');
          return;
        }
        if (isPostKeyMinted(selectedPostKey)) {
          setStatus('This post is already minted.', 'error');
          return;
        }

        const img = firebaseImageUrls[selectedIndex];
        const imageUrl = img.url;

        setStatus('Submitting transaction to mint NFT FAN POST…', 'loading');
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const tokenURI = buildPostTokenURI(selectedPostKey, imageUrl, nameColor);
        const priceWei = ethers.utils.parseEther(FIXED_MINT_PRICE_POL.toString());
        const tx = await contract.mintWithURI(tokenURI, { value: priceWei });

        setStatus('Waiting for confirmation…', 'loading');
        const receipt = await tx.wait();
        const ev = receipt.events?.find(e => e.event === 'Transfer');
        const mintedTokenId = ev?.args?.tokenId?.toString() || ('post-' + Date.now());

        const now = Math.floor(Date.now() / 1000);
        const postData = {
          owner: userAddress,
          meta: {
            post_key: selectedPostKey,
            image_url: imageUrl,
            color: nameColor,
            mint_price_pol: FIXED_MINT_PRICE_POL,
            created_at: now
          }
        };

        await writePostToFirebase(mintedTokenId, postData);

        setStatus('Minted NFT FAN POST.', 'success');
        updateMintButtonState();
      } catch (e) {
        console.error('Minting failed:', e);
        const msg = e?.data?.message || e?.reason || e?.message || 'Unknown transaction error.';
        setStatus('Minting failed: ' + msg, 'error');
      }
    }

    function buildPostTokenURI(postKey, imageUrl, color) {
      const metadata = {
        name: 'NFT FAN Post ' + postKey,
        description: 'NFT FAN image post stored on-chain via NFT FAN Posts dapp.',
        image: imageUrl,  // directly use the URL of the post
        background_color: color.replace('#', ''), // optional
        attributes: [
          { trait_type: 'Post Key', value: postKey },
          { trait_type: 'Origin', value: 'NFT FAN Posts' }
        ]
      };
      const json = JSON.stringify(metadata);
      return 'data:application/json;base64,' + btoa(unescape(encodeURIComponent(json)));
    }

    function initFirebase() {
      try {
        if (!window.firebase) throw new Error('Firebase not loaded');
        fbApp = firebase.initializeApp(firebaseConfig);
        fbDb = firebase.database();

        // Posts for THIS app only
        subscribePosts();
        // Image URLs source
        subscribeImageUrls();
      } catch (e) {
        console.error('Firebase init failed', e);
        setStatus('Could not connect to Firebase.', 'error');
        initialLoader.classList.add('hidden');
      }
    }

    function subscribePosts() {
      if (!fbDb) return;
      // This is a NEW node just for this app
      postsRef = fbDb.ref('fanPosts');

      showCityLoading();
      postsRef.once('value', (snapshot) => {
        snapshot.forEach((child) => {
          upsertPost(child.key, child.val());
        });
        initialLoader.classList.add('hidden');
        hideCityLoading();

        postsRef.on('child_added', snap => upsertPost(snap.key, snap.val()));
        postsRef.on('child_changed', snap => upsertPost(snap.key, snap.val()));
        postsRef.on('child_removed', snap => removePost(snap.key));
      }, (err) => {
        console.error('Firebase fanPosts read failed:', err);
        setStatus('Cannot read NFT FAN posts.', 'error');
        initialLoader.classList.add('hidden');
        hideCityLoading();
      });
    }

    function subscribeImageUrls() {
      if (!fbDb) return;
      // assumes your uploader writes here
      imagesRef = fbDb.ref('imageUrls');

      imagesRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        firebaseImageUrls = Object.entries(data)
          .map(([id, value]) => ({
            _id: id,
            url: value.url || '',
            created_at: value.created_at || 0
          }))
          .filter(item => item.url);

        firebaseImageUrls.sort((a, b) => b.created_at - a.created_at);

        renderImageGrid();
      }, (err) => {
        console.error('imageUrls read error:', err);
      });
    }

    function upsertPost(tokenId, data) {
      if (!data || !data.meta) return;
      postsById.set(tokenId, data);
      renderMintedTable();
      updateOwnedCount();
      updateMintedCount();
      renderImageGrid();
    }

    function removePost(tokenId) {
      postsById.delete(tokenId);
      renderMintedTable();
      updateOwnedCount();
      updateMintedCount();
      renderImageGrid();
    }

    async function writePostToFirebase(tokenId, postData) {
      if (!fbDb || !postsRef) return;
      await postsRef.child(tokenId).set(postData);
    }

    function updateOwnedCount() {
      if (!userAddress) {
        ownedCountPill.style.display = 'none';
        return;
      }
      const me = userAddress.toLowerCase();
      let count = 0;
      for (const v of postsById.values()) {
        if ((v.owner || '').toLowerCase() === me) count++;
      }
      if (count > 0) {
        ownedCountPill.style.display = 'inline-flex';
        ownedCountPill.innerHTML =
          '<span class="material-icons">verified</span>' +
          '<span>You own ' + count + ' post(s)</span>';
      } else {
        ownedCountPill.style.display = 'none';
      }
    }

    function updateMintedCount() {
      const total = postsById.size;
      mintedCountPill.style.display = 'inline-flex';
      mintedCountPill.innerHTML =
        '<span class="material-icons">collections</span>' +
        '<span>Total minted ' + total + '</span>';
    }

    function renderMintedTable() {
      mintedBody.innerHTML = '';
      if (postsById.size === 0) {
        mintedBody.innerHTML =
          '<tr><td colspan="3" style="padding:6px;color:#9b7f4a;">No NFT FAN posts minted yet.</td></tr>';
        return;
      }

      const list = Array.from(postsById.entries())
        .map(([tokenId, data]) => ({
          tokenId,
          ...data
        }))
        .sort((a, b) => (b.meta?.created_at || 0) - (a.meta?.created_at || 0));

      for (const item of list) {
        const owner = item.owner || '';
        const postKey = item.meta?.post_key || '';
        const price = item.meta?.mint_price_pol || FIXED_MINT_PRICE_POL;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHTML(postKey || ('Token ' + item.tokenId))}</td>
          <td>${shortAddr(owner)}</td>
          <td class="right">${Number(price).toFixed(2)}</td>
        `;
        mintedBody.appendChild(tr);
      }
    }

    function renderImageGrid() {
      imageGrid.innerHTML = '';

      if (!firebaseImageUrls || firebaseImageUrls.length === 0) {
        noImagesNote.style.display = 'inline';
        return;
      }
      noImagesNote.style.display = 'none';

      const count = firebaseImageUrls.length;

      for (let i = 0; i < count; i++) {
        const imgInfo = firebaseImageUrls[i];
        const url = imgInfo.url;
        const postKey = 'Post#' + (i + 1);
        const minted = isPostKeyMinted(postKey);
        const isSelected = selectedIndex === i;

        const card = document.createElement('div');
        card.className = 'image-card';
        card.dataset.index = String(i);
        if (minted) card.classList.add('minted');
        if (isSelected) card.classList.add('selected');

        card.innerHTML = `
          <img src="${escapeHTML(url)}" alt="${escapeHTML(postKey)}" loading="lazy" />
          <div class="image-card-footer">
            <div class="image-card-status ${minted ? 'taken' : 'available'}">
              <span class="material-icons" style="font-size:10px;">
                ${minted ? 'lock' : 'rocket_launch'}
              </span>
              <span>${minted ? 'Minted' : 'Available'}</span>
            </div>
            <div class="image-card-index">${escapeHTML(postKey)}</div>
          </div>
        `;

        if (!minted) {
          card.addEventListener('click', () => selectByIndex(i));
        } else {
          card.style.cursor = 'not-allowed';
        }

        imageGrid.appendChild(card);
      }
    }

    function clearSelection() {
      selectedIndex = null;
      selectedPostKey = '';
      selectionPill.style.display = 'none';
      document.querySelectorAll('.image-card').forEach(card => card.classList.remove('selected'));
      setStatus('Selection cleared. Choose a post.', '');
      updateMintButtonState();
    }

    // Events
    connectBtn.addEventListener('click', connectWallet);
    mintBtn.addEventListener('click', mintSelectedPost);
    clearBtn.addEventListener('click', clearSelection);
    refreshBtn.addEventListener('click', () => {
      setStatus('Data refresh is automatic from Firebase.', '');
      renderImageGrid();
    });
    nameColorInput.addEventListener('input', updateNameColorState);

    window.addEventListener('DOMContentLoaded', () => {
      renderImageGrid(); // empty until Firebase loads
      initFirebase();
      setStatus('Connect wallet and choose a post image to mint.', '');
    });
  </script>
</body>
</html>
