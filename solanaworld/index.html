<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFAN SOLANA AIRDROP PRIZE 1 $SOL , 200$</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', 'Roboto', 'Arial', sans-serif;
      background: #090e1a;
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-size: 10px;
      -webkit-tap-highlight-color: transparent;
      width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      margin: 10px 0 4px 0;
      font-size: 1.18rem;
      font-weight: 700;
      letter-spacing: 1px;
      color: #ef4444;
      text-shadow: 0 2px 8px #0005;
      line-height: 1.18;
    }
    .mainbox {
      width: 97vw;
      max-width: 385px;
      margin: 10px auto 0 auto;
      background: rgba(22,27,41,0.99);
      border-radius: 11px;
      box-shadow: 0 2px 16px #0006;
      padding: 10px 5px 13px 5px;
      border: 1px solid #283044;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .description-airdrop {
      background: #172031;
      color: #fbbf24;
      font-size: 9.6px;
      border-radius: 7px;
      padding: 7px 9px 7px 9px;
      margin: 0 0 10px 0;
      text-align: center;
      font-weight: 500;
      line-height: 1.44;
      box-shadow: 0 1px 7px #0002;
      border: 1px solid #ef4444;
    }
    .mapbox {
      width: 100%;
      max-width: 355px;
      height: 41vw;
      max-height: 170px;
      min-height: 100px;
      border: 1px solid #ef4444;
      border-radius: 7px;
      margin-bottom: 8px;
      background: #1a2238;
      overflow: hidden;
      box-shadow: 0 3px 18px #0003;
      position: relative;
      box-sizing: border-box;
    }
    .legend {
      background: rgba(30,41,59,0.88);
      color: #fff;
      padding: 4px 10px 4px 7px;
      border-radius: 6px;
      font-size: 8.5px;
      position: absolute;
      top: 6px;
      left: 6px;
      z-index: 1000;
      box-shadow: 0 1px 6px #0002;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .legend-dot {
      display: inline-block;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      margin-right: 3px;
    }
    .legend-dot.green { background: #22c55e; box-shadow: 0 0 7px #22c55ecc,0 1px 2px #0004; }
    .legend-dot.red { background: #ef4444; box-shadow: 0 0 7px #ef4444cc,0 1px 2px #0004; }
    .location-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 210px;
      margin: 0 auto 8px auto;
      background: linear-gradient(90deg, #ef4444 50%, #fb7185 100%);
      color: #fff;
      font-size: 1.05rem;
      font-weight: 700;
      letter-spacing: 1px;
      border: none;
      border-radius: 8px;
      padding: 12px 7px 11px 7px;
      box-shadow: 0 2px 10px #ef444475, 0 1.5px 6px #0002;
      cursor: pointer;
      transition: background 0.13s, transform 0.09s;
      outline: none;
      gap: 7px;
      position: relative;
      z-index: 2;
    }
    .location-btn:active {
      background: linear-gradient(90deg, #fb7185 60%, #ef4444 100%);
      transform: scale(0.98);
    }
    .location-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #a1a1aa !important;
    }
    .payrec-choice {
      display: flex;
      width: 100%;
      gap: 6px;
      justify-content: center;
      margin: 7px 0;
    }
    .payrec-btn {
      flex: 1 1 0;
      padding: 1px 0;
      font-size: 8.6px;
      font-weight: 600;
      letter-spacing: 0.35px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #1f2937;
      color: #f3f4f6;
      transition: background 0.18s, transform 0.08s, box-shadow 0.16s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      outline: none;
      border: 1.3px solid #374151;
    }
    .payrec-btn:hover {
      background: #2d3748;
      box-shadow: 0 1.5px 5px rgba(0, 0, 0, 0.16);
    }
    .payrec-btn.selected {
      background: linear-gradient(90deg, #22c55e 50%, #16a34a 100%);
      color: #ffffff;
      border: 1.3px solid #22c55e;
      transform: scale(0.97);
    }
    .payrec-btn.red.selected {
      background: linear-gradient(90deg, #ef4444 50%, #f87171 100%);
      border: 1.3px solid #ef4444;
    }
    .solbox, .amountbox, .xpostbox, .onelinerbox {
      margin: 0 0 7px 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 2px;
    }
    label {
      color: #b6c4e2;
      font-weight: 600;
      margin-bottom: 1px;
      font-size: 9px;
    }
    input[type="text"], input[type="number"], input[type="url"] {
      background: #232e47;
      border: 1px solid #374151;
      color: #fff;
      border-radius: 6px;
      padding: 7px 7px;
      font-size: 13.5px;
      margin-bottom: 1px;
      outline: none;
      transition: border 0.1s;
      width: 100%;
      box-sizing: border-box;
      appearance: none;
      -webkit-appearance: none;
      -webkit-text-size-adjust: 100%;
      caret-color: #ef4444;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="url"]:focus {
      border: 1.2px solid #ef4444;
      background: #283552;
    }
    .oneliner-input-row {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .oneliner-prefix {
      font-weight: 700;
      font-size: 11px;
      margin-right: 2px;
      letter-spacing: 0.2px;
      display: inline-block;
    }
    .oneliner-prefix.green { color: #22c55e; }
    .oneliner-prefix.red { color: #ef4444; }
    .oneliner-userinput {
      background: #232e47;
      border: none;
      color: #fff;
      outline: none;
      font-size: 11px;
      padding: 6px 3px 6px 3px;
      max-width: 150px;
      border-radius: 5px;
      flex: 1 1 0;
      margin-left: 1px;
      box-sizing: border-box;
    }
    .oneliner-userinput:focus { background: #283552; }
    .oneliner-charcount {
      font-size: 8px;
      color: #fbbf24;
      margin-left: 2px;
      min-width: 34px;
      text-align: right;
    }
    .btn, button[type="submit"].btn, .submit-btn {
      background: linear-gradient(90deg, #fbbf24 0%, #ef4444 100%);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 10px 0 9px 0;
      font-size: 1.02rem;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 7px 0 7px 0;
      box-shadow: 0 2px 9px #fbbf2445, 0 1.5px 5px #0002;
      width: 100%;
      transition: background 0.13s, transform 0.09s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      min-height: 24px;
      cursor: pointer;
      outline: none;
      position: relative;
      z-index: 2;
    }
    .btn:active, button[type="submit"].btn:active, .submit-btn:active {
      background: linear-gradient(90deg, #ef4444 60%, #fbbf24 100%);
      transform: scale(0.98);
    }
    .btn[disabled], button[type="submit"].btn[disabled], .submit-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #a1a1aa !important;
    }
    .info-message {
      color: #fbbf24;
      background: #2b2324;
      border-radius: 6px;
      padding: 6px 7px;
      margin: 7px 0 0 0;
      font-size: 9.2px;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .success-message {
      color: #fff;
      background: #166534;
    }
    .wallet-table-container {
      width: 100%;
      max-width: 370px;
      margin: 11px auto 0 auto;
      background: rgba(30,41,59,0.93);
      border-radius: 9px;
      box-shadow: 0 1.5px 9px #0003;
      padding: 7px 3px 7px 3px;
      border: 1px solid #283044;
      overflow-x: auto;
      box-sizing: border-box;
    }
    .wallet-table-title {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10.2px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 5px;
      margin-left: 2px;
      letter-spacing: 0.5px;
    }
    table.wallet-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9.5px;
      background: none;
      min-width: 170px;
    }
    table.wallet-table th, table.wallet-table td {
      padding: 4.2px 2px;
      text-align: left;
      border-bottom: 1px solid #334155;
      color: #fff;
      font-size: 9.5px;
      font-family: 'Roboto Mono', monospace;
      background: none;
      vertical-align: top;
    }
    table.wallet-table th {
      color: #fbbf24;
      font-weight: 700;
      background: none;
    }
    table.wallet-table tr:last-child td {
      border-bottom: none;
    }
    table.wallet-table td.wallet-addr {
      word-break: break-all;
      color: #a5f3fc;
      font-weight: 600;
      font-size: 9.7px;
      user-select: all;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 1px;
    }
    .copy-btn {
      background: none;
      border: none;
      padding: 0 0 0 2px;
      margin-left: 2px;
      cursor: pointer;
      color: #38bdf8;
      font-size: 13px;
      outline: none;
      display: flex;
      align-items: center;
      transition: color 0.12s;
    }
    .copy-btn:active, .copy-btn:focus {
      color: #fbbf24;
    }
    .copied-indicator {
      font-size: 9.5px;
      color: #22c55e;
      margin-left: 2px;
      vertical-align: middle;
      opacity: 0.84;
      transition: opacity 0.2s;
    }
    .oneliner-table {
      font-size: 9.6px;
      font-family: inherit;
      white-space: pre-line;
      line-height: 1.25;
      margin-top: 2px;
    }
    .oneliner-prefix-table.green { color: #22c55e; font-weight: 700;}
    .oneliner-prefix-table.red { color: #ef4444; font-weight: 700;}
    @media (max-width: 600px) {
      html, body { font-size: 10px; width: 100vw; max-width: 100vw; overflow-x: hidden !important; box-sizing: border-box; }
      h1 { font-size: 0.98rem; }
      .mainbox { max-width: 99vw; width: 99vw; padding: 4px 1.3vw 10px 1.3vw;}
      .mapbox { max-width: 99vw; width: 99vw; height: 36vw; min-height: 70px;}
      .legend { font-size: 7.5px; top: 3px; left: 3px;}
      .wallet-table-container { max-width: 99vw; width: 99vw; }
      table.wallet-table { font-size: 8.7px; min-width: 120px;}
      table.wallet-table th, table.wallet-table td { font-size: 8.7px; padding: 2.5px 1px;}
      .location-btn, .btn, .submit-btn { font-size: 0.97rem; padding: 9px 5px 8px 5px; }
      input[type="text"], input[type="number"], input[type="url"] { font-size: 12.5px; }
      #map { width: 100% !important; }
      .oneliner-userinput { font-size: 9.5px; }
    }
    @media (max-width: 400px) {
      .mainbox, .wallet-table-container, .mapbox { max-width: 100vw; width: 100vw; }
      html, body { padding: 0; margin: 0; }
    }
    .leaflet-container {
      background: #1a2238 !important;
      background-repeat: no-repeat !important;
      background-size: cover !important;
    }
  </style>
</head>
<body>
  <h1>
    <span style="display:inline-flex;align-items:center;">
      <span class="material-icons" style="font-size:13px;color:#fff;margin-right:2px;">redeem</span>
      NFTFAN SOLANA WORLD
    </span><br>
    <span style="font-size:9px;letter-spacing:0.8px;">EARN OR PAY SOLANA</span>
  </h1>
  <div class="mainbox">
    <div class="description-airdrop">
      <span class="material-icons" style="font-size:10px;vertical-align:-2px;color:#ef4444;">info</span>
      To participate you must <b>share your location</b>.
    </div>
    <div class="mapbox">
      <div class="legend">
        <span class="legend-dot green"></span> Paying &nbsp;
        <span class="legend-dot red"></span> Receiving
      </div>
      <div id="map" style="width:100%;height:100%;"></div>
    </div>
    <div id="step1">
      <button class="location-btn" id="shareLocationBtn" type="button" autocomplete="off">
        <span class="material-icons" style="font-size:14px;">my_location</span>
        SHARE LOCATION
      </button>
      <div id="locError" class="info-message" style="display:none"></div>
    </div>
    <div id="step2" style="display:none;">
      <div class="payrec-choice" id="payrecChoice">
        <button class="payrec-btn green" type="button" data-type="pay">
          <span class="material-icons" style="font-size:13px;color:#22c55e;">arrow_upward</span>
          Paying $SOL
        </button>
        <button class="payrec-btn red" type="button" data-type="receive">
          <span class="material-icons" style="font-size:13px;color:#ef4444;">arrow_downward</span>
          Receiving $SOL
        </button>
      </div>
      <div id="payrecError" class="info-message" style="display:none"></div>
      <form id="airdropForm" autocomplete="off" style="width:100%;display:none;">
        <div class="solbox">
          <label for="solAddr">Solana Wallet Address:</label>
          <input type="text" id="solAddr" name="solAddr" maxlength="60" required placeholder="5B3w...XyZ" inputmode="text" autocomplete="off" pattern="[1-9A-HJ-NP-Za-km-z]{32,44}">
        </div>
        <div class="amountbox">
          <label for="solAmount">SOL Amount:</label>
          <input type="number" id="solAmount" name="solAmount" min="0.0001" step="0.0001" required placeholder="1.5">
        </div>
        <div class="xpostbox">
          <label for="xPostUrl">X (Twitter) Post URL:</label>
          <input type="url" id="xPostUrl" name="xPostUrl" required placeholder="https://x.com/yourpost">
          <span style="font-size:8px;color:#fbbf24;">Explain in your X post why you want to pay or receive SOL, etc.</span>
        </div>
        <div class="onelinerbox">
          <label for="onelinerInput">One line statement (max 100 chars):</label>
          <div class="oneliner-input-row">
            <span id="onelinerPrefix" class="oneliner-prefix green">I am paying $SOL</span>
            <input type="text" id="onelinerInput" maxlength="100" class="oneliner-userinput" required placeholder="to help NFT fans worldwide" autocomplete="off">
            <span id="onelinerCharCount" class="oneliner-charcount">0/100</span>
          </div>
        </div>
        <button class="btn submit-btn" type="submit">
          <span class="material-icons" style="font-size:12px;">send</span>
          Submit
        </button>
      </form>
      <div id="formError" class="info-message" style="display:none"></div>
    </div>
    <div id="step3" style="display:none;">
      <div class="info-message success-message">
        <span class="material-icons" style="font-size:10px;color:#fff;">check_circle</span>
        Entry submitted! Good luck 🍀<br>
        <span style="font-size:8.2px;color:#d1fae5;">Scroll/zoom map to see your and all entries.</span>
      </div>
    </div>
  </div>
  <div class="wallet-table-container" id="wallet-table-container" style="display:none;">
    <div class="wallet-table-title">
      <span class="material-icons" style="font-size:10px;color:#fbbf24;">list_alt</span>
      Wallets (<span id="wallet-count">0</span>)
    </div>
    <div style="overflow-x:auto;">
      <table class="wallet-table" id="wallet-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Wallet</th>
            <th>Type</th>
            <th>SOL</th>
            <th>X Post</th>
          </tr>
        </thead>
        <tbody>
          <!-- Wallet rows go here -->
        </tbody>
      </table>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const entriesRef = ref(db, 'solanaAirdropEntriesV2');

    let mapHasFitInitial = false;
    const southWest = L.latLng(-85, -180),
          northEast = L.latLng(85, 180),
          bounds = L.latLngBounds(southWest, northEast);

    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false,
      scrollWheelZoom: true,
      dragging: true,
      doubleClickZoom: true,
      maxBounds: bounds,
      maxBoundsViscosity: 1.0,
      worldCopyJump: false,
      minZoom: 2,
      maxZoom: 18,
    }).setView([20,0], 2);

    function fitWorldOnce() {
      if (!mapHasFitInitial) {
        map.fitBounds(bounds, { animate: false });
        mapHasFitInitial = true;
      }
    }
    fitWorldOnce();

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      minZoom: 2,
      maxZoom: 18,
      attribution: '© OpenStreetMap',
      noWrap: true,
      bounds: bounds,
      continuousWorld: false
    }).addTo(map);

    const greenDotIcon = L.divIcon({
      html: '<div style="width:10px;height:10px;background:#22c55e;border-radius:50%;box-shadow:0 0 7px #22c55ecc,0 1.5px 3px #0004;"></div>',
      iconSize: [10, 10], className: ''
    });
    const redDotIcon = L.divIcon({
      html: '<div style="width:10px;height:10px;background:#ef4444;border-radius:50%;box-shadow:0 0 7px #ef4444cc,0 1.5px 3px #0004;"></div>',
      iconSize: [10, 10], className: ''
    });

    let markers = [];
    let userMarker = null;
    let userEntryLatLng = null;
    let userType = null;

    const shareLocationBtn = document.getElementById('shareLocationBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const payrecChoice = document.getElementById('payrecChoice');
    const payrecError = document.getElementById('payrecError');
    const airdropForm = document.getElementById('airdropForm');
    const solAddrInput = document.getElementById('solAddr');
    const solAmountInput = document.getElementById('solAmount');
    const xPostUrlInput = document.getElementById('xPostUrl');
    const onelinerInput = document.getElementById('onelinerInput');
    const onelinerPrefix = document.getElementById('onelinerPrefix');
    const onelinerCharCount = document.getElementById('onelinerCharCount');
    const formError = document.getElementById('formError');
    const locError = document.getElementById('locError');

    let userLocation = null;

    payrecChoice.querySelectorAll('.payrec-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        payrecChoice.querySelectorAll('.payrec-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        userType = btn.dataset.type;
        payrecError.style.display = "none";
        airdropForm.style.display = "";
        solAddrInput.focus();
        if (userType === "pay") {
          onelinerPrefix.textContent = "I am paying $SOL";
          onelinerPrefix.classList.remove('red');
          onelinerPrefix.classList.add('green');
        } else {
          onelinerPrefix.textContent = "I am receiving $SOL";
          onelinerPrefix.classList.remove('green');
          onelinerPrefix.classList.add('red');
        }
      });
    });

    shareLocationBtn.addEventListener('click', () => {
      locError.style.display = "none";
      shareLocationBtn.disabled = true;
      if (!navigator.geolocation) {
        locError.innerHTML = '<span class="material-icons" style="font-size:10px;">error</span> Geolocation is not supported by your browser.';
        locError.style.display = "";
        shareLocationBtn.disabled = false;
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            timestamp: Date.now(),
            userAgent: navigator.userAgent
          };
          step1.style.display = "none";
          step2.style.display = "";
          payrecError.style.display = "none";
          airdropForm.style.display = "none";
        },
        (err) => {
          locError.innerHTML = '<span class="material-icons" style="font-size:10px;">error</span> Unable to get location: ' + (err.message || "Permission denied.");
          locError.style.display = "";
          shareLocationBtn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    });

    onelinerInput.addEventListener('input', () => {
      onelinerCharCount.textContent = `${onelinerInput.value.length}/100`;
      if (onelinerInput.value.length > 100) onelinerInput.value = onelinerInput.value.slice(0,100);
    });

    airdropForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.style.display = "none";
      let addr = solAddrInput.value.trim();
      let amount = solAmountInput.value.trim();
      let xpost = xPostUrlInput.value.trim();
      let onelinerValue = onelinerInput.value.trim();

      if (!/^([1-9A-HJ-NP-Za-km-z]{32,44})$/.test(addr)) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Invalid Solana address format.';
        formError.style.display = "";
        return;
      }
      if (!userType || (userType !== "pay" && userType !== "receive")) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Please select if you are paying or receiving.';
        formError.style.display = "";
        return;
      }
      let solAmt = Number(amount);
      if (isNaN(solAmt) || solAmt <= 0) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Enter a valid SOL amount.';
        formError.style.display = "";
        return;
      }
      if (!/^https?:\/\/(www\.)?(twitter|x)\.com\/[^\s]+$/i.test(xpost)) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Enter a valid X (Twitter) post URL.';
        formError.style.display = "";
        return;
      }
      if (!userLocation) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">error</span> Location missing. Please start again.';
        formError.style.display = "";
        return;
      }
      if (!onelinerValue || onelinerValue.length === 0) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Please complete the statement.';
        formError.style.display = "";
        return;
      }
      if (onelinerValue.length > 100) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">warning</span> Statement too long.';
        formError.style.display = "";
        return;
      }

      let duplicate = false;
      const snapshot = await new Promise(resolve =>
        onValue(entriesRef, resolve, { onlyOnce: true })
      );
      const allEntries = snapshot.val() || {};
      for (const key in allEntries) {
        if (allEntries[key].solanaAddress && allEntries[key].solanaAddress.trim() === addr) {
          duplicate = true;
          break;
        }
      }
      if (duplicate) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">block</span> Wallet already entered!';
        formError.style.display = "";
        return;
      }

      try {
        const entry = {
          ...userLocation,
          solanaAddress: addr,
          type: userType,
          solAmount: solAmt,
          xPostUrl: xpost,
          oneliner: onelinerValue
        };
        await push(entriesRef, entry);
        userEntryLatLng = [userLocation.lat, userLocation.lng];
        step2.style.display = "none";
        step3.style.display = "";
        setTimeout(() => { step3.querySelector('.info-message').scrollIntoView({behavior: 'smooth', block: 'center'}); }, 200);
      } catch (err) {
        formError.innerHTML = '<span class="material-icons" style="font-size:10px;">error</span> Failed to submit. Please try again.';
        formError.style.display = "";
      }
    });

    function shortWallet(addr) {
      if (!addr || addr.length < 10) return addr;
      return addr.substring(0,4) + "..." + addr.substring(addr.length-4);
    }

    function copyToClipboard(text, btn) {
      if (!navigator.clipboard) {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      } else {
        navigator.clipboard.writeText(text);
      }
      if (btn) {
        let icon = btn.parentNode.querySelector('.copied-indicator');
        if (!icon) {
          icon = document.createElement('span');
          icon.className = 'copied-indicator';
          icon.innerHTML = '<span class="material-icons" style="font-size:11px;vertical-align:-1px;">check</span>';
          btn.parentNode.appendChild(icon);
        }
        icon.style.opacity = 1;
        setTimeout(() => { icon.style.opacity = 0; }, 850);
      }
    }

    function renderOneliner(type, oneliner) {
      if (!oneliner) return '';
      const prefix = type === "pay" ? "I am paying $SOL" : "I am receiving $SOL";
      const prefixClass = type === "pay" ? "oneliner-prefix-table green" : "oneliner-prefix-table red";
      return `<span class="${prefixClass}">${prefix}</span> ${escapeHtml(oneliner)}`;
    }
    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    onValue(entriesRef, (snapshot) => {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
      const data = snapshot.val();
      if (!data) return;

      const walletMap = {};
      for (const key in data) {
        const e = data[key];
        if (e.solanaAddress) {
          walletMap[e.solanaAddress.trim()] = { ...e };
        }
      }
      const points = Object.values(walletMap)
        .filter(e => e.lat && e.lng && e.solanaAddress && (e.type === "pay" || e.type === "receive"))
        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      points.forEach(point => {
        const marker = L.marker([point.lat, point.lng], { icon: point.type === "pay" ? greenDotIcon : redDotIcon }).addTo(map);
        const popupHtml = `
          <div class="popup-wallet-title">
            <span class="material-icons" style="font-size:12px;color:${point.type === "pay" ? "#22c55e" : "#ef4444"};vertical-align:middle;">account_balance_wallet</span>
            ${point.type === "pay" ? "Paying" : "Receiving"}
          </div>
          <div class="popup-wallet-address">${shortWallet(point.solanaAddress)}</div>
          <div style="font-size:9px;margin-top:2px;color:#fbbf24;">SOL: ${point.solAmount}</div>
          <div class="oneliner-table" style="margin-top:2px;">${renderOneliner(point.type, point.oneliner)}</div>
          <div style="font-size:9px;margin-top:2px;"><a target="_blank" href="${point.xPostUrl}" style="color:#38bdf8;text-decoration:underline;">X Post</a></div>
        `;
        marker.bindPopup(popupHtml, { closeButton: true, minWidth: 140, maxWidth: 220, autoClose: true, closeOnClick: true });
        markers.push(marker);
      });

      if (userEntryLatLng) {
        userMarker = L.marker(userEntryLatLng, { icon: userType === "pay" ? greenDotIcon : redDotIcon }).addTo(map);
        const popupHtml = `
          <div class="popup-wallet-title">
            <span class="material-icons" style="font-size:12px;color:${userType === "pay" ? "#22c55e" : "#ef4444"};vertical-align:middle;">account_balance_wallet</span>
            Your Wallet
          </div>
          <div class="popup-wallet-address">${shortWallet(solAddrInput.value)}</div>
          <div style="font-size:9px;margin-top:2px;color:#fbbf24;">SOL: ${solAmountInput.value}</div>
          <div class="oneliner-table" style="margin-top:2px;">${renderOneliner(userType, onelinerInput.value)}</div>
          <div style="font-size:9px;margin-top:2px;"><a target="_blank" href="${xPostUrlInput.value}" style="color:#38bdf8;text-decoration:underline;">X Post</a></div>
        `;
        userMarker.bindPopup(popupHtml, { closeButton: true, minWidth: 140, maxWidth: 220, autoClose: true, closeOnClick: true });
        map.setView(userEntryLatLng, 8, { animate: true });
      } else if (points.length > 0 && !mapHasFitInitial) {
        fitWorldOnce();
      }

      // ---- Wallet table ----
      const walletTableBody = document.querySelector('#wallet-table tbody');
      const walletTableContainer = document.getElementById('wallet-table-container');
      const walletCount = document.getElementById('wallet-count');
      walletTableBody.innerHTML = "";
      if (points.length > 0) {
        walletTableContainer.style.display = "";
        walletCount.textContent = points.length;
        points.slice().reverse().forEach((entry, idx) => {
          const n = points.length - idx;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${n}</td>
            <td class="wallet-addr">
              <span>${shortWallet(entry.solanaAddress)}</span>
              <button class="copy-btn" title="Copy full wallet" data-wallet="${entry.solanaAddress}">
                <span class="material-icons" style="font-size:11px;">content_copy</span>
              </button>
              <div class="oneliner-table" style="margin-top:2px;">
                ${renderOneliner(entry.type, entry.oneliner)}
              </div>
            </td>
            <td style="color:${entry.type === "pay" ? "#22c55e" : "#ef4444"};font-weight:700;">${entry.type === "pay" ? "Pay" : "Receive"}</td>
            <td>${entry.solAmount}</td>
            <td><a href="${entry.xPostUrl}" target="_blank" style="color:#38bdf8;text-decoration:underline;font-size:9.2px;">X Post</a></td>
          `;
          walletTableBody.appendChild(tr);
        });

        walletTableBody.querySelectorAll('.copy-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            e.stopPropagation();
            const wallet = btn.getAttribute('data-wallet');
            copyToClipboard(wallet, btn);
          });
        });
      } else {
        walletTableContainer.style.display = "none";
        walletCount.textContent = "0";
      }
    });

    window.addEventListener('resize', () => {
      setTimeout(() => { map.invalidateSize(); }, 400);
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => { map.invalidateSize(); }, 300);
    });
  </script>
</body>
</html>
