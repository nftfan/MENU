<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFAN SOLANA AIRDROP PRIZE 1 $SOL , 200$</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    html, body {
      font-family: 'Inter', 'Roboto', 'Arial', sans-serif;
      background: #090e1a;
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-size: 10px;
      -webkit-tap-highlight-color: transparent;
      width: 100vw;
      overflow-x: hidden;
      box-sizing: border-box;
    }
    body {
      width: 100vw;
      max-width: 100vw;
      overflow-x: hidden;
    }
    h1 {
      text-align: center;
      margin: 15px 0 7px 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 1.2px;
      color: #ef4444;
      text-shadow: 0 2px 10px #0006;
      line-height: 1.2;
      letter-spacing: 2px;
    }
    .mainbox {
      width: 96vw;
      max-width: 430px;
      margin: 14px auto 0 auto;
      background: rgba(22,27,41,0.97);
      border-radius: 13px;
      box-shadow: 0 4px 24px #0005;
      padding: 15px 8px 16px 8px;
      border: 1px solid #283044;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
    }
    .description-airdrop {
      background: #172031;
      color: #fbbf24;
      font-size: 10px;
      border-radius: 8px;
      padding: 9px 12px 8px 12px;
      margin: 0 0 15px 0;
      text-align: center;
      font-weight: 500;
      line-height: 1.44;
      box-shadow: 0 1.5px 8px #0002;
      border: 1px solid #ef4444;
    }
    .mapbox {
      width: 100%;
      max-width: 390px;
      height: 45vw;
      max-height: 250px;
      min-height: 130px;
      border: 1px solid #ef4444;
      border-radius: 8px;
      margin-bottom: 13px;
      background: #1a2238;
      overflow: hidden;
      box-shadow: 0 6px 32px #0002;
      position: relative;
      box-sizing: border-box;
    }
    .legend {
      background: rgba(30,41,59,0.88);
      color: #fff;
      padding: 5px 11px 5px 8px;
      border-radius: 7px;
      font-size: 9px;
      position: absolute;
      top: 8px;
      left: 7px;
      z-index: 1000;
      box-shadow: 0 1.5px 7px #0002;
      display: flex;
      align-items: center;
      gap: 9px;
    }
    .legend-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }
    .legend-dot.green { background: #22c55e; box-shadow: 0 0 7px #22c55ecc,0 1.5px 3px #0004; }
    .legend-dot.red { background: #ef4444; box-shadow: 0 0 7px #ef4444cc,0 1.5px 3px #0004; }
    .location-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      max-width: 250px;
      margin: 0 auto 8px auto;
      background: linear-gradient(90deg, #ef4444 50%, #fb7185 100%);
      color: #fff;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 1.4px;
      border: none;
      border-radius: 9px;
      padding: 15px 10px 13px 10px;
      box-shadow: 0 3px 16px #ef444485, 0 2px 8px #0002;
      cursor: pointer;
      transition: background 0.16s, transform 0.11s;
      outline: none;
      gap: 8px;
      position: relative;
      z-index: 2;
    }
    .location-btn:active {
      background: linear-gradient(90deg, #fb7185 60%, #ef4444 100%);
      transform: scale(0.98);
    }
    .location-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #a1a1aa !important;
    }
   .payrec-choice {
  display: flex;
  width: 100%;
  gap: 8px;
  justify-content: center;
  margin: 8px 0;
}

.payrec-btn {
  flex: 1 1 0;
  padding: 1px 0;
  font-size: 9px;
  font-weight: 600;
  letter-spacing: 0.5px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: #1f2937;
  color: #f3f4f6;
  
  transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  outline: none;
  border: 1.5px solid #374151;
}

.payrec-btn:hover {
  background: #2d3748;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.payrec-btn.selected {
  background: linear-gradient(90deg, #22c55e 50%, #16a34a 100%);
  color: #ffffff;
  border: 1.5px solid #22c55e;
  transform: scale(0.98);
}

.payrec-btn.red.selected {
  background: linear-gradient(90deg, #ef4444 50%, #f87171 100%);
  border: 1.5px solid #ef4444;
}

    .solbox, .amountbox, .xpostbox {
      margin: 0 0 8px 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 3px;
    }
    label {
      color: #b6c4e2;
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 10px;
    }
    input[type="text"], input[type="number"], input[type="url"] {
      background: #232e47;
      border: 1px solid #374151;
      color: #fff;
      border-radius: 6px;
      padding: 9px 8px;
      font-size: 16px;
      margin-bottom: 2px;
      outline: none;
      transition: border 0.1s;
      width: 100%;
      box-sizing: border-box;
      appearance: none;
      -webkit-appearance: none;
      -webkit-text-size-adjust: 100%;
      caret-color: #ef4444;
    }
    input[type="text"]:focus, input[type="number"]:focus, input[type="url"]:focus {
      border: 1.5px solid #ef4444;
      background: #283552;
    }
    .btn, button[type="submit"].btn, .submit-btn {
      background: linear-gradient(90deg, #fbbf24 0%, #ef4444 100%);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 15px 0 13px 0;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 1.2px;
      margin: 10px 0 14px 0;
      box-shadow: 0 3px 14px #fbbf2465, 0 2px 8px #0002;
      width: 100%;
      transition: background 0.16s, transform 0.11s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 9px;
      min-height: 32px;
      cursor: pointer;
      outline: none;
      position: relative;
      z-index: 2;
    }
    .btn:active, button[type="submit"].btn:active, .submit-btn:active {
      background: linear-gradient(90deg, #ef4444 60%, #fbbf24 100%);
      transform: scale(0.98);
    }
    .btn[disabled], button[type="submit"].btn[disabled], .submit-btn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      background: #a1a1aa !important;
    }
    .info-message {
      color: #fbbf24;
      background: #2b2324;
      border-radius: 6px;
      padding: 7px 9px;
      margin: 8px 0 0 0;
      font-size: 10px;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .success-message {
      color: #fff;
      background: #166534;
    }
    .wallet-table-container {
      width: 100%;
      max-width: 400px;
      margin: 14px auto 0 auto;
      background: rgba(30,41,59,0.85);
      border-radius: 10px;
      box-shadow: 0 2px 12px #0003;
      padding: 8px 6px 10px 6px;
      border: 1px solid #283044;
      overflow-x: auto;
      box-sizing: border-box;
    }
    .wallet-table-title {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 7px;
      margin-left: 3px;
      letter-spacing: 0.6px;
    }
    table.wallet-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 10px;
      background: none;
      min-width: 220px;
    }
    table.wallet-table th, table.wallet-table td {
      padding: 6px 4px;
      text-align: left;
      border-bottom: 1px solid #334155;
      color: #fff;
      font-size: 10px;
      font-family: 'Roboto Mono', monospace;
      background: none;
    }
    table.wallet-table th {
      color: #fbbf24;
      font-weight: 700;
      background: none;
    }
    table.wallet-table tr:last-child td {
      border-bottom: none;
    }
    table.wallet-table td.wallet-addr {
      word-break: break-all;
      color: #a5f3fc;
      font-weight: 600;
      font-size: 10px;
      user-select: all;
    }
    @media (max-width: 600px) {
      html, body { font-size: 10px; width: 100vw; max-width: 100vw; overflow-x: hidden !important; box-sizing: border-box; }
      h1 { font-size: 1.13rem; }
      .mainbox { max-width: 99vw; width: 99vw; padding: 5px 2vw 12px 2vw;}
      .mapbox { max-width: 99vw; width: 99vw; height: 42vw; min-height: 85px;}
      .legend { font-size: 8px; top: 4px; left: 4px;}
      .wallet-table-container { max-width: 99vw; width: 99vw; }
      table.wallet-table { font-size: 9px; min-width: 140px;}
      table.wallet-table th, table.wallet-table td { font-size: 9px; padding: 4px 2px;}
      .location-btn, .btn, .submit-btn { font-size: 1rem; padding: 12px 10px 11px 10px; }
      input[type="text"], input[type="number"], input[type="url"] { font-size: 16px; }
      #map { width: 100% !important; }
    }
    @media (max-width: 400px) {
      .mainbox, .wallet-table-container, .mapbox { max-width: 100vw; width: 100vw; }
      html, body { padding: 0; margin: 0; }
    }
    /* Prevent map repeating horizontally (wrap) */
    .leaflet-container {
      background: #1a2238 !important;
      background-repeat: no-repeat !important;
      background-size: cover !important;
    }
  </style>
</head>
<body>
  <h1>
    <span style="display:inline-flex;align-items:center;">
      <span class="material-icons" style="font-size:15px;color:#fff;margin-right:3px;">redeem</span>
      NFTFAN SOLANA WORLD
    </span><br>
    <span style="font-size:11px;letter-spacing:0.9px;">EARN OR PAY SOLANA</span>
  </h1>
  <div class="mainbox">
    <div class="description-airdrop">
      <span class="material-icons" style="font-size:12px;vertical-align:-2px;color:#ef4444;">info</span>
      To participate you must <b>share your location</b>.
    </div>
    <div class="mapbox">
      <div class="legend">
        <span class="legend-dot green"></span> Paying &nbsp;
        <span class="legend-dot red"></span> Receiving
      </div>
      <div id="map" style="width:100%;height:100%;"></div>
    </div>
    <div id="step1">
      <button class="location-btn" id="shareLocationBtn" type="button" autocomplete="off">
        <span class="material-icons" style="font-size:16px;">my_location</span>
        SHARE LOCATION
      </button>
      <div id="locError" class="info-message" style="display:none"></div>
    </div>
    <div id="step2" style="display:none;">
      <div class="payrec-choice" id="payrecChoice">
        <button class="payrec-btn green" type="button" data-type="pay">
          <span class="material-icons" style="font-size:16px;color:#22c55e;">arrow_upward</span>
          Paying $SOL
        </button>
        <button class="payrec-btn red" type="button" data-type="receive">
          <span class="material-icons" style="font-size:16px;color:#ef4444;">arrow_downward</span>
          Receiving $SOL
        </button>
      </div>
      <div id="payrecError" class="info-message" style="display:none"></div>
      <form id="airdropForm" autocomplete="off" style="width:100%;display:none;">
        <div class="solbox">
          <label for="solAddr">Enter your Solana Wallet Address:</label>
          <input type="text" id="solAddr" name="solAddr" maxlength="60" required placeholder="e.g. 5B3w...XyZ" inputmode="text" autocomplete="off" pattern="[1-9A-HJ-NP-Za-km-z]{32,44}">
        </div>
        <div class="amountbox">
          <label for="solAmount">SOL Amount:</label>
          <input type="number" id="solAmount" name="solAmount" min="0.0001" step="0.0001" required placeholder="e.g. 1.5">
        </div>
        <div class="xpostbox">
          <label for="xPostUrl">X (Twitter) Post URL:</label>
          <input type="url" id="xPostUrl" name="xPostUrl" required placeholder="https://x.com/yourpost">
          <span style="font-size:9px;color:#fbbf24;">Explain in your X post why you want to pay or receive SOL, etc.</span>
        </div>
        <button class="btn submit-btn" type="submit">
          <span class="material-icons" style="font-size:15px;">send</span>
          Submit Entry
        </button>
      </form>
      <div id="formError" class="info-message" style="display:none"></div>
    </div>
    <div id="step3" style="display:none;">
      <div class="info-message success-message">
        <span class="material-icons" style="font-size:12px;color:#fff;">check_circle</span>
        Entry submitted! Good luck 🍀<br>
        <span style="font-size:9px;color:#d1fae5;">Scroll/zoom map to see your and all entries.</span>
      </div>
    </div>
  </div>
  <div class="wallet-table-container" id="wallet-table-container" style="display:none;">
    <div class="wallet-table-title">
      <span class="material-icons" style="font-size:12px;color:#fbbf24;">list_alt</span>
      All Wallets (<span id="wallet-count">0</span>)
    </div>
    <div style="overflow-x:auto;">
      <table class="wallet-table" id="wallet-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Wallet Address</th>
            <th>Type</th>
            <th>SOL</th>
            <th>X Post</th>
          </tr>
        </thead>
        <tbody>
          <!-- Wallet rows go here -->
        </tbody>
      </table>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD_c9jMxAA6dtyk_EXAHnH09OEAoalUADA",
      authDomain: "trackingclients.firebaseapp.com",
      projectId: "trackingclients",
      storageBucket: "trackingclients.appspot.com",
      messagingSenderId: "27490943622",
      appId: "1:27490943622:web:d6c87547aa5df440508707",
      databaseURL: "https://trackingclients-default-rtdb.firebaseio.com/"
    };

    // Initialize Firebase & DB
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const entriesRef = ref(db, 'solanaAirdropEntriesV2');

    let mapHasFitInitial = false;
    // Restrict map bounds to prevent horizontal repeating
    const southWest = L.latLng(-85, -180),
          northEast = L.latLng(85, 180),
          bounds = L.latLngBounds(southWest, northEast);

    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false,
      scrollWheelZoom: true,
      dragging: true,
      doubleClickZoom: true,
      maxBounds: bounds, // limit map panning to world bounds
      maxBoundsViscosity: 1.0, // hard limit
      worldCopyJump: false, // disables horizontal repeat
      minZoom: 2,
      maxZoom: 18,
    }).setView([20,0], 2);

    function fitWorldOnce() {
      if (!mapHasFitInitial) {
        map.fitBounds(bounds, { animate: false });
        mapHasFitInitial = true;
      }
    }
    fitWorldOnce();

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      minZoom: 2,
      maxZoom: 18,
      attribution: '© OpenStreetMap',
      noWrap: true,         // prevent horizontal repeat
      bounds: bounds,       // restrict tiles to bounds
      continuousWorld: false
    }).addTo(map);

    // Dot icons
    const greenDotIcon = L.divIcon({
      html: '<div style="width:10px;height:10px;background:#22c55e;border-radius:50%;box-shadow:0 0 7px #22c55ecc,0 1.5px 3px #0004;"></div>',
      iconSize: [10, 10], className: ''
    });
    const redDotIcon = L.divIcon({
      html: '<div style="width:10px;height:10px;background:#ef4444;border-radius:50%;box-shadow:0 0 7px #ef4444cc,0 1.5px 3px #0004;"></div>',
      iconSize: [10, 10], className: ''
    });

    let markers = [];
    let userMarker = null;
    let userEntryLatLng = null;
    let userType = null; // "pay" or "receive"

    // UI step logic
    const shareLocationBtn = document.getElementById('shareLocationBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const payrecChoice = document.getElementById('payrecChoice');
    const payrecError = document.getElementById('payrecError');
    const airdropForm = document.getElementById('airdropForm');
    const solAddrInput = document.getElementById('solAddr');
    const solAmountInput = document.getElementById('solAmount');
    const xPostUrlInput = document.getElementById('xPostUrl');
    const formError = document.getElementById('formError');
    const locError = document.getElementById('locError');

    let userLocation = null;

    // Step 1: Ask for location
    shareLocationBtn.addEventListener('click', () => {
      locError.style.display = "none";
      shareLocationBtn.disabled = true;
      if (!navigator.geolocation) {
        locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Geolocation is not supported by your browser.';
        locError.style.display = "";
        shareLocationBtn.disabled = false;
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            timestamp: Date.now(),
            userAgent: navigator.userAgent
          };
          // Move to step 2 (Pay/Receive select)
          step1.style.display = "none";
          step2.style.display = "";
          payrecError.style.display = "none";
          airdropForm.style.display = "none";
        },
        (err) => {
          locError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Unable to get location: ' + (err.message || "Permission denied.");
          locError.style.display = "";
          shareLocationBtn.disabled = false;
        },
        { enableHighAccuracy: true, timeout: 12000 }
      );
    });

    // Step 2: Choose pay/receive
    payrecChoice.querySelectorAll('.payrec-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remove previous selections
        payrecChoice.querySelectorAll('.payrec-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        userType = btn.dataset.type;
        payrecError.style.display = "none";
        // Show form step
        airdropForm.style.display = "";
        solAddrInput.focus();
      });
    });

    // Step 3: Form submit
    airdropForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formError.style.display = "none";
      let addr = solAddrInput.value.trim();
      let amount = solAmountInput.value.trim();
      let xpost = xPostUrlInput.value.trim();

      // Validate wallet
      if (!/^([1-9A-HJ-NP-Za-km-z]{32,44})$/.test(addr)) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">warning</span> Invalid Solana address format.';
        formError.style.display = "";
        return;
      }
      // Validate pay/receive
      if (!userType || (userType !== "pay" && userType !== "receive")) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">warning</span> Please select if you are paying or receiving.';
        formError.style.display = "";
        return;
      }
      // Validate amount
      let solAmt = Number(amount);
      if (isNaN(solAmt) || solAmt <= 0) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">warning</span> Enter a valid SOL amount.';
        formError.style.display = "";
        return;
      }
      // Validate X post URL
      if (!/^https?:\/\/(www\.)?(twitter|x)\.com\/[^\s]+$/i.test(xpost)) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">warning</span> Enter a valid X (Twitter) post URL.';
        formError.style.display = "";
        return;
      }
      // Check location
      if (!userLocation) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Location missing. Please start again.';
        formError.style.display = "";
        return;
      }

      // Check for duplicate wallet (client-side only)
      let duplicate = false;
      const snapshot = await new Promise(resolve =>
        onValue(entriesRef, resolve, { onlyOnce: true })
      );
      const allEntries = snapshot.val() || {};
      for (const key in allEntries) {
        if (allEntries[key].solanaAddress && allEntries[key].solanaAddress.trim() === addr) {
          duplicate = true;
          break;
        }
      }
      if (duplicate) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">block</span> Wallet already entered!';
        formError.style.display = "";
        return;
      }

      // Save entry to Firebase
      try {
        const entry = {
          ...userLocation,
          solanaAddress: addr,
          type: userType,
          solAmount: solAmt,
          xPostUrl: xpost
        };
        await push(entriesRef, entry);
        userEntryLatLng = [userLocation.lat, userLocation.lng];
        // Move to step 3 (success)
        step2.style.display = "none";
        step3.style.display = "";
        setTimeout(() => { step3.querySelector('.info-message').scrollIntoView({behavior: 'smooth', block: 'center'}); }, 250);
      } catch (err) {
        formError.innerHTML = '<span class="material-icons" style="font-size:12px;">error</span> Failed to submit. Please try again.';
        formError.style.display = "";
      }
    });

    // Listen for all entries and render as dots and wallet table
    onValue(entriesRef, (snapshot) => {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
      const data = snapshot.val();
      if (!data) return;

      // Deduplicate wallets (keep most recent entry for each wallet)
      const walletMap = {};
      for (const key in data) {
        const e = data[key];
        if (e.solanaAddress) {
          walletMap[e.solanaAddress.trim()] = { ...e };
        }
      }
      // Convert to sorted array by time (most recent last)
      const points = Object.values(walletMap)
        .filter(e => e.lat && e.lng && e.solanaAddress && (e.type === "pay" || e.type === "receive"))
        .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));

      // Show all dots (green for pay, red for receive)
      points.forEach(point => {
        const marker = L.marker([point.lat, point.lng], { icon: point.type === "pay" ? greenDotIcon : redDotIcon }).addTo(map);
        const popupHtml = `
          <div class="popup-wallet-title">
            <span class="material-icons" style="font-size:12px;color:${point.type === "pay" ? "#22c55e" : "#ef4444"};vertical-align:middle;">account_balance_wallet</span>
            ${point.type === "pay" ? "Paying" : "Receiving"}
          </div>
          <div class="popup-wallet-address">${point.solanaAddress}</div>
          <div style="font-size:10px;margin-top:3px;color:#fbbf24;">SOL: ${point.solAmount}</div>
          <div style="font-size:10px;margin-top:2px;"><a target="_blank" href="${point.xPostUrl}" style="color:#38bdf8;text-decoration:underline;">X Post</a></div>
        `;
        marker.bindPopup(popupHtml, { closeButton: true, minWidth: 180, maxWidth: 260, autoClose: true, closeOnClick: true });
        markers.push(marker);
      });

      // Show user's marker on top if exists (optional)
      if (userEntryLatLng) {
        userMarker = L.marker(userEntryLatLng, { icon: userType === "pay" ? greenDotIcon : redDotIcon }).addTo(map);
        const popupHtml = `
          <div class="popup-wallet-title">
            <span class="material-icons" style="font-size:12px;color:${userType === "pay" ? "#22c55e" : "#ef4444"};vertical-align:middle;">account_balance_wallet</span>
            Your Wallet
          </div>
          <div class="popup-wallet-address">${solAddrInput.value}</div>
          <div style="font-size:10px;margin-top:3px;color:#fbbf24;">SOL: ${solAmountInput.value}</div>
          <div style="font-size:10px;margin-top:2px;"><a target="_blank" href="${xPostUrlInput.value}" style="color:#38bdf8;text-decoration:underline;">X Post</a></div>
        `;
        userMarker.bindPopup(popupHtml, { closeButton: true, minWidth: 180, maxWidth: 260, autoClose: true, closeOnClick: true });
        map.setView(userEntryLatLng, 8, { animate: true });
      } else if (points.length > 0 && !mapHasFitInitial) {
        fitWorldOnce();
      }

      // ---- Wallet table ----
      const walletTableBody = document.querySelector('#wallet-table tbody');
      const walletTableContainer = document.getElementById('wallet-table-container');
      const walletCount = document.getElementById('wallet-count');
      walletTableBody.innerHTML = "";
      if (points.length > 0) {
        walletTableContainer.style.display = "";
        walletCount.textContent = points.length;
        points.slice().reverse().forEach((entry, idx) => {
          const tr = document.createElement('tr');
          const n = points.length - idx;
          tr.innerHTML = `
            <td>${n}</td>
            <td class="wallet-addr">${entry.solanaAddress}</td>
            <td style="color:${entry.type === "pay" ? "#22c55e" : "#ef4444"};font-weight:700;">${entry.type === "pay" ? "Paying" : "Receiving"}</td>
            <td>${entry.solAmount}</td>
            <td><a href="${entry.xPostUrl}" target="_blank" style="color:#38bdf8;text-decoration:underline;font-size:10px;">X Post</a></td>
          `;
          walletTableBody.appendChild(tr);
        });
      } else {
        walletTableContainer.style.display = "none";
        walletCount.textContent = "0";
      }
    });

    // Touch-friendly tweaks for mobile
    window.addEventListener('resize', () => {
      setTimeout(() => { map.invalidateSize(); }, 500);
    });
    window.addEventListener('orientationchange', () => {
      setTimeout(() => { map.invalidateSize(); }, 400);
    });
  </script>
</body>
</html>
