<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFTFan Token Sale</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.5.0/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            opacity: 0.8;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .balance-label {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .balance-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4ade80;
        }

        .button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .connect-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .switch-btn {
            background: linear-gradient(45deg, #ffd93d, #ff9f43);
            color: #333;
        }

        .purchase-btn {
            background: linear-gradient(45deg, #4ade80, #22c55e);
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-field:focus {
            outline: none;
            border-color: #4ade80;
        }

        .rate-info {
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status {
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .error {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .success {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .info {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .processing-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .processing-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4ade80;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .hidden {
            display: none;
        }

        .network-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">NFTFan Token Sale</h1>
        <p class="subtitle">Get your NFTFan tokens with MATIC</p>

        <div id="status" class="status hidden"></div>

        <!-- Wallet Connection Section -->
        <div class="card">
            <button id="connectWallet" class="button connect-btn">
                Connect Wallet
            </button>
            
            <div id="walletInfo" class="hidden">
                <div class="balance-item">
                    <span class="balance-label">Wallet Address:</span>
                    <span id="walletAddress" class="balance-value"></span>
                </div>
            </div>
        </div>

        <!-- Network Section -->
        <div id="networkSection" class="card hidden">
            <button id="switchNetwork" class="button switch-btn">
                Switch to Polygon Network
            </button>
        </div>

        <!-- Balances Section -->
        <div id="balanceSection" class="card hidden">
            <h3 style="margin-bottom: 15px; text-align: center;">Your Balances</h3>
            <div class="balance-item">
                <span class="balance-label">MATIC Balance:</span>
                <span id="maticBalance" class="balance-value">0.00</span>
            </div>
            <div class="balance-item">
                <span class="balance-label">NFTFan Balance:</span>
                <span id="nftfanBalance" class="balance-value">0.00</span>
            </div>
        </div>

        <!-- Purchase Section -->
        <div id="purchaseSection" class="card hidden">
            <div class="rate-info">
                <strong>Exchange Rate:</strong> 1 MATIC = 1,000,000,000,000,000 NFTFan
            </div>
            
            <div class="input-group">
                <label class="input-label" for="maticAmount">MATIC Amount:</label>
                <input 
                    type="number" 
                    id="maticAmount" 
                    class="input-field" 
                    placeholder="Enter MATIC amount" 
                    step="0.001"
                    min="0"
                >
            </div>
            
            <div class="balance-item">
                <span class="balance-label">You will receive:</span>
                <span id="tokensToReceive" class="balance-value">0 NFTFan</span>
            </div>
            
            <button id="purchaseTokens" class="button purchase-btn" disabled>
                Purchase NFTFan Tokens
            </button>
        </div>
    </div>

    <!-- Processing Overlay -->
    <div id="processingOverlay" class="processing-overlay">
        <div class="processing-content">
            <div class="processing-spinner"></div>
            <h3>Processing Transaction</h3>
            <p>Please wait while your transaction is being processed...</p>
        </div>
    </div>

    <script>
        // Contract Configuration
        const CONTRACT_ADDRESS = '0xaf2d132C8773bca3821C24EcF64e844E202A12e8';
        const TOKEN_ADDRESS = '0x YOUR_TOKEN_ADDRESS'; // Replace with actual NFTFan token address
        const POLYGON_CHAIN_ID = '0x89'; // 137 in decimal
        const RATE = 1000000000000000; // 1 MATIC = 1,000,000,000,000,000 tokens

        // Contract ABIs (simplified)
        const TOKEN_SALE_ABI = [
            {
                "inputs": [],
                "name": "RATE",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            }
        ];

        const ERC20_ABI = [
            {
                "inputs": [{"internalType": "address", "name": "account", "type": "address"}],
                "name": "balanceOf",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [{"internalType": "uint8", "name": "", "type": "uint8"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Global variables
        let web3;
        let userAccount;
        let tokenContract;

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWallet');
        const switchNetworkBtn = document.getElementById('switchNetwork');
        const purchaseTokensBtn = document.getElementById('purchaseTokens');
        const maticAmountInput = document.getElementById('maticAmount');
        const walletInfo = document.getElementById('walletInfo');
        const networkSection = document.getElementById('networkSection');
        const balanceSection = document.getElementById('balanceSection');
        const purchaseSection = document.getElementById('purchaseSection');
        const processingOverlay = document.getElementById('processingOverlay');

        // Initialize
        async function init() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                
                // Check if already connected
                const accounts = await web3.eth.getAccounts();
                if (accounts.length > 0) {
                    userAccount = accounts[0];
                    await handleWalletConnected();
                }
            } else {
                showStatus('Please install MetaMask to use this application', 'error');
            }
        }

        // Connect wallet
        async function connectWallet() {
            try {
                showStatus('Connecting wallet...', 'info');
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                userAccount = accounts[0];
                await handleWalletConnected();
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showStatus('Failed to connect wallet', 'error');
            }
        }

        // Handle wallet connected
        async function handleWalletConnected() {
            // Update UI
            document.getElementById('walletAddress').textContent = 
                userAccount.substring(0, 6) + '...' + userAccount.substring(38);
            walletInfo.classList.remove('hidden');
            connectWalletBtn.textContent = 'Wallet Connected';
            connectWalletBtn.disabled = true;

            // Check network
            const chainId = await web3.eth.getChainId();
            if (chainId.toString() !== '137') {
                networkSection.classList.remove('hidden');
                showStatus('Please switch to Polygon network', 'network-warning');
            } else {
                await handleCorrectNetwork();
            }
        }

        // Switch to Polygon network
        async function switchToPolygon() {
            try {
                showStatus('Switching to Polygon network...', 'info');
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_CHAIN_ID }],
                });
                await handleCorrectNetwork();
            } catch (error) {
                if (error.code === 4902) {
                    // Network not added, add it
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: POLYGON_CHAIN_ID,
                                chainName: 'Polygon Mainnet',
                                nativeCurrency: {
                                    name: 'MATIC',
                                    symbol: 'MATIC',
                                    decimals: 18
                                },
                                rpcUrls: ['https://polygon-rpc.com/'],
                                blockExplorerUrls: ['https://polygonscan.com/']
                            }]
                        });
                        await handleCorrectNetwork();
                    } catch (addError) {
                        console.error('Error adding network:', addError);
                        showStatus('Failed to add Polygon network', 'error');
                    }
                } else {
                    console.error('Error switching network:', error);
                    showStatus('Failed to switch network', 'error');
                }
            }
        }

        // Handle correct network
        async function handleCorrectNetwork() {
            networkSection.classList.add('hidden');
            balanceSection.classList.remove('hidden');
            purchaseSection.classList.remove('hidden');
            
            // Initialize token contract if address is provided
            if (TOKEN_ADDRESS !== '0x YOUR_TOKEN_ADDRESS') {
                tokenContract = new web3.eth.Contract(ERC20_ABI, TOKEN_ADDRESS);
            }
            
            await updateBalances();
            showStatus('Ready to purchase tokens!', 'success');
        }

        // Update balances
        async function updateBalances() {
            try {
                // Get MATIC balance
                const maticBalance = await web3.eth.getBalance(userAccount);
                const maticFormatted = web3.utils.fromWei(maticBalance, 'ether');
                document.getElementById('maticBalance').textContent = 
                    parseFloat(maticFormatted).toFixed(4) + ' MATIC';

                // Get NFTFan balance if contract is available
                if (tokenContract) {
                    const tokenBalance = await tokenContract.methods.balanceOf(userAccount).call();
                    const decimals = await tokenContract.methods.decimals().call();
                    const tokenFormatted = (tokenBalance / Math.pow(10, decimals)).toFixed(2);
                    document.getElementById('nftfanBalance').textContent = 
                        tokenFormatted + ' NFTFan';
                } else {
                    document.getElementById('nftfanBalance').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Error updating balances:', error);
            }
        }

        // Calculate tokens to receive
        function calculateTokens() {
            const maticAmount = parseFloat(maticAmountInput.value) || 0;
            const tokensToReceive = maticAmount * RATE;
            
            if (tokensToReceive > 0) {
                document.getElementById('tokensToReceive').textContent = 
                    tokensToReceive.toLocaleString() + ' NFTFan';
                purchaseTokensBtn.disabled = false;
            } else {
                document.getElementById('tokensToReceive').textContent = '0 NFTFan';
                purchaseTokensBtn.disabled = true;
            }
        }

        // Purchase tokens
        async function purchaseTokens() {
            const maticAmount = parseFloat(maticAmountInput.value);
            
            if (!maticAmount || maticAmount <= 0) {
                showStatus('Please enter a valid MATIC amount', 'error');
                return;
            }

            try {
                showProcessing(true);
                showStatus('Processing transaction...', 'info');

                const amountWei = web3.utils.toWei(maticAmount.toString(), 'ether');
                
                const transaction = await web3.eth.sendTransaction({
                    from: userAccount,
                    to: CONTRACT_ADDRESS,
                    value: amountWei,
                    gas: 200000
                });

                showStatus('Transaction successful!', 'success');
                
                // Wait a moment then update balances
                setTimeout(async () => {
                    await updateBalances();
                    maticAmountInput.value = '';
                    calculateTokens();
                    showProcessing(false);
                }, 2000);

            } catch (error) {
                console.error('Transaction error:', error);
                showStatus('Transaction failed: ' + error.message, 'error');
                showProcessing(false);
            }
        }

        // Show/hide processing overlay
        function showProcessing(show) {
            if (show) {
                processingOverlay.classList.add('active');
            } else {
                processingOverlay.classList.remove('active');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.classList.remove('hidden');
            
            // Auto-hide after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 5000);
            }
        }

        // Event listeners
        connectWalletBtn.addEventListener('click', connectWallet);
        switchNetworkBtn.addEventListener('click', switchToPolygon);
        purchaseTokensBtn.addEventListener('click', purchaseTokens);
        maticAmountInput.addEventListener('input', calculateTokens);

        // Listen for account changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    userAccount = accounts[0];
                    handleWalletConnected();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                location.reload();
            });
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
