<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>X Username Minter — NFTFAN Community</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
  <!-- Ethers -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Firebase (compat SDK) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #00f9ff;
      --primary-glow: rgba(0, 249, 255, 0.5);
      --primary-dark: #00b2ff;
      --accent: #ff2cf0;
      --accent-glow: rgba(255, 44, 240, 0.5);
      --success: #12ff9b;
      --success-glow: rgba(18, 255, 155, 0.4);
      --error: #ff3860;
      --error-glow: rgba(255, 56, 96, 0.4);
      --bg: #0c0b1d;
      --bg-dark: #07061a;
      --card: #12122a;
      --text: #eef2ff;
      --muted: #8f9cce;
      --border: #3e3f82;
      --border-glow: rgba(0, 249, 255, 0.2);
      --radius: 12px;
      --shadow: rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      scroll-behavior: smooth;
      overscroll-behavior: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Rajdhani', sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      line-height: 1.4;
      overflow-x: hidden;
      letter-spacing: 0.2px;
      font-weight: 500;
    }

    #app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: radial-gradient(800px at 15% 15%, rgba(0, 249, 255, 0.08), transparent 70%),
                  radial-gradient(600px at 85% 20%, rgba(255, 44, 240, 0.08), transparent 70%),
                  linear-gradient(180deg, var(--bg-dark), var(--bg));
    }

    /* Cyber grid */
    .cyber-grid {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image:
        linear-gradient(rgba(0, 249, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 249, 255, 0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridPulse 15s infinite linear;
    }
    .cyber-grid::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, transparent 0%, var(--bg-dark) 100%);
      animation: scanline 8s infinite linear;
      opacity: 0.5;
    }
    @keyframes gridPulse {
      0%,100% { background-size: 40px 40px; opacity: 1; }
      50% { background-size: 42px 42px; opacity: 0.8; }
    }
    @keyframes scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }

    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      position: relative;
      z-index: 10;
    }
    .brand { display:flex;align-items:center;gap:12px; }
    .logo {
      width: 40px;height:40px;border-radius:8px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display:grid;place-items:center;
      box-shadow:0 0 15px rgba(0,249,255,0.4);
      position:relative;overflow:hidden;
    }
    .logo::before{
      content:'';position:absolute;top:-50%;left:-50%;
      width:200%;height:200%;
      background:conic-gradient(transparent,var(--primary),transparent 30%);
      animation:rotate 4s linear infinite;
    }
    .logo::after{
      content:'';position:absolute;inset:3px;
      border-radius:6px;background:var(--bg-dark);
    }
    .logo .material-icons{
      font-size:22px;color:var(--primary);
      position:relative;z-index:2;
      text-shadow:0 0 8px var(--primary-glow);
    }
    @keyframes rotate{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .title h1{
      margin:0;font-size:24px;font-weight:700;
      font-family:'Orbitron',sans-serif;
      text-transform:uppercase;letter-spacing:1px;
      background:linear-gradient(90deg,var(--primary),var(--accent));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-shadow:0 0 5px rgba(0,249,255,0.3);
    }
    .title p{margin:0;font-size:14px;color:var(--muted);}

    .actions{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }

    /* Buttons */
    button{
      appearance:none;border:1px solid var(--border);
      border-radius:8px;padding:10px 14px;
      font-size:14px;font-weight:600;
      font-family:'Rajdhani',sans-serif;
      color:var(--text);cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(32,33,77,0.6);
      transition:all 0.2s ease;
      position:relative;overflow:hidden;
      backdrop-filter:blur(10px);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    button::after{
      content:'';position:absolute;
      top:0;left:-100%;width:100%;height:100%;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
      transition:0.5s;
    }
    button:hover::after{left:100%;}
    button .material-icons{font-size:18px;}
    button.primary{
      background:linear-gradient(135deg,var(--primary-dark),var(--primary));
      border-color:var(--primary);
      box-shadow:0 0 10px var(--primary-glow);
      text-shadow:0 0 5px var(--primary);
    }
    button.success{
      background:linear-gradient(135deg,var(--success),#00ddb9);
      border-color:var(--success);
      box-shadow:0 0 10px var(--success-glow);
      color:#07172c;
      font-weight:700;
      text-shadow:0 0 2px rgba(255,255,255,0.5);
    }
    button.accent{
      background:linear-gradient(135deg,var(--accent),#ff6afc);
      border-color:var(--accent);
      box-shadow:0 0 10px var(--accent-glow);
      color:#07172c;
      font-weight:700;
      text-shadow:0 0 2px rgba(255,255,255,0.5);
    }
    button:disabled{
      opacity:0.5;cursor:not-allowed;
      transform:none !important;
      box-shadow:none;
    }
    button:not(:disabled):active{transform:translateY(1px) scale(0.98);}

    .wallet{
      color:var(--primary);
      font-size:14px;font-weight:700;
      text-shadow:0 0 5px var(--primary-glow);
      background:rgba(0,249,255,0.1);
      padding:4px 10px;border-radius:8px;
      border:1px solid rgba(0,249,255,0.3);
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:13px;padding:6px 10px;
      border-radius:8px;border:1px solid var(--border);
      background:rgba(15,16,40,0.7);
      color:var(--muted);
      backdrop-filter:blur(5px);
    }
    .pill .material-icons{
      font-size:16px;color:var(--primary);
    }

    /* Main layout */
    main{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;padding:0 16px 16px;
      flex:1;
      max-width:900px;
      margin:0 auto;
    }

    @media (min-width: 980px){
      main{
        grid-template-columns:1.1fr 1.2fr;
        align-items:flex-start;
      }
    }

    .panel{
      background:rgba(18,18,42,0.75);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      display:grid;gap:16px;
      backdrop-filter:blur(10px);
      box-shadow:0 0 25px var(--shadow);
      position:relative;overflow:hidden;
      z-index:1;
    }
    .panel::after{
      content:'';position:absolute;
      top:-1px;left:-1px;right:-1px;
      height:2px;
      background:linear-gradient(90deg,transparent,var(--primary),var(--accent),transparent);
      z-index:2;
      box-shadow:0 0 15px var(--primary-glow);
    }

    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding-bottom:8px;
      border-bottom:1px solid rgba(62,63,130,0.3);
    }
    .panel-header h2{
      margin:0;
      font-family:'Orbitron',sans-serif;
      font-size:18px;
      color:var(--primary);
      text-transform:uppercase;
      letter-spacing:1px;
      text-shadow:0 0 5px var(--primary-glow);
    }

    .row{display:grid;gap:12px;}
    .row.inline{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
    }

    .form-group{display:grid;gap:6px;}
    .form-group label{
      font-size:14px;font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .form-group input[type="text"],
    .form-group input[type="color"]{
      font-family:'Rajdhani',sans-serif;
      font-size:16px;color:var(--text);
      background:rgba(8,9,33,0.5);
      border:1px solid var(--border);
      border-radius:6px;
      padding:8px 12px;
      transition:all 0.2s ease;
    }
    .form-group input[type="text"]:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 8px var(--primary-glow);
    }
    .form-group input[type="color"]{
      padding:4px 8px;height:40px;cursor:pointer;
    }

    .status{
      min-height:46px;
      display:grid;place-items:center;
      text-align:center;
      font-size:14px;
      border-radius:8px;
      padding:12px;
      background:rgba(8,9,33,0.5);
      border:1px solid rgba(62,63,130,0.3);
      color:var(--muted);
      transition:all 0.3s ease;
    }
    .status.success{
      background:rgba(18,255,155,0.07);
      color:var(--success);
      border-color:rgba(18,255,155,0.25);
      box-shadow:0 0 10px rgba(18,255,155,0.1);
    }
    .status.error{
      background:rgba(255,56,96,0.07);
      color:var(--error);
      border-color:rgba(255,56,96,0.25);
      box-shadow:0 0 10px rgba(255,56,96,0.1);
    }
    .status.loading{
      display:inline-flex;
      align-items:center;gap:10px;
      justify-content:center;
    }
    .spinner{
      width:18px;height:18px;border-radius:50%;
      border:2px solid rgba(255,255,255,0.1);
      border-left-color:var(--primary);
      animation:spin 1s linear infinite;
      box-shadow:0 0 10px var(--primary-glow);
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    /* Toast */
    .toast{
      position:fixed;top:20px;left:50%;
      transform:translateX(-50%);
      display:none;align-items:center;gap:10px;
      padding:12px 16px;
      background:rgba(12,13,38,0.9);
      color:var(--text);
      border-left:3px solid var(--primary);
      border-radius:8px;
      box-shadow:0 5px 15px rgba(0,0,0,0.3),
                 0 0 10px var(--primary-glow);
      z-index:9999;
      font-size:14px;
      backdrop-filter:blur(10px);
      animation:fadeIn 0.3s ease;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translate(-50%,-10px);}
      to{opacity:1;transform:translate(-50%,0);}
    }

    /* Leaderboard + table of usernames */
    .leaderboard-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .leaderboard-table th,
    .leaderboard-table td{
      padding:8px 10px;
      text-align:left;
      border-bottom:1px solid rgba(62,63,130,0.3);
    }
    .leaderboard-table th{
      color:var(--primary);
      font-family:'Orbitron',sans-serif;
      font-weight:300;
      font-size:11px;
    }
    .leaderboard-table td{
      color:var(--muted);
    }
    .leaderboard-table tr:last-child td{border-bottom:none;}
    .leaderboard-table tr:hover{background:rgba(0,249,255,0.05);}
    .leaderboard-table .rank{width:40px;text-align:center;color:var(--accent);font-weight:700;font-size:10px;}
    .leaderboard-table .owner{width:160px;font-weight:600;}
    .leaderboard-table .count{width:80px;text-align:right;color:var(--primary);font-weight:700;}
    .leaderboard-table .value{text-align:right;color:var(--success);font-weight:700;}

    .usernames-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .usernames-table th,
    .usernames-table td{
      padding:6px 8px;
      text-align:left;
      border-bottom:1px solid rgba(62,63,130,0.3);
    }
    .usernames-table th{
      color:var(--primary);
      font-family:'Orbitron',sans-serif;
      font-weight:300;
      font-size:11px;
    }
    .usernames-table td{
      color:var(--muted);
      font-size:11px;
    }
    .usernames-table tr:last-child td{border-bottom:none;}
    .usernames-table tr:hover{background:rgba(0,249,255,0.05);}

    /* Glitch title */
    @keyframes glitch {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 1px); }
      40% { transform: translate(-2px, -1px); }
      60% { transform: translate(2px, 1px); }
      80% { transform: translate(2px, -1px); }
      100% { transform: translate(0); }
    }
    .glitch-text{
      position:relative;display:inline-block;
    }
    .glitch-text:hover::before,
    .glitch-text:hover::after{
      content:attr(data-text);
      position:absolute;top:0;left:0;
      width:100%;height:100%;
    }
    .glitch-text:hover::before{
      animation:glitch 0.3s cubic-bezier(0.25,0.46,0.45,0.94) both infinite;
      color:var(--primary);
      text-shadow:0 0 5px var(--primary-glow);
      clip-path:polygon(0 0,100% 0,100% 45%,0 45%);
      transform:translate(-2px,-2px);
    }
    .glitch-text:hover::after{
      animation:glitch 0.3s cubic-bezier(0.25,0.46,0.45,0.94) reverse both infinite;
      color:var(--accent);
      text-shadow:0 0 5px var(--accent-glow);
      clip-path:polygon(0 55%,100% 55%,100% 100%,0 100%);
      transform:translate(2px,2px);
    }

    /* Initial loader */
    #initial-loader{
      position:fixed;inset:0;
      background:var(--bg-dark);
      z-index:10000;
      display:flex;align-items:center;justify-content:center;
      transition:opacity 0.5s ease,visibility 0.5s ease;
    }
    #initial-loader .loader-content{
      text-align:center;color:var(--primary);
    }
    #initial-loader .spinner{
      width:50px;height:50px;border-width:4px;
      margin:0 auto 20px;
    }
    #initial-loader .loader-text{
      font-family:'Orbitron',sans-serif;
      font-size:18px;letter-spacing:1px;
      text-shadow:0 0 10px var(--primary-glow);
    }
    #initial-loader.hidden{
      opacity:0;visibility:hidden;
    }

    @media (max-width:640px){
      header{flex-direction:column;align-items:flex-start;gap:12px;}
      .actions{width:100%;justify-content:space-between;}
      main{padding:0 12px 12px;gap:12px;}
      button{padding:8px 12px;font-size:13px;}
      .panel{padding:12px;}
      .leaderboard-table th,.leaderboard-table td,
      .usernames-table th,.usernames-table td{
        font-size:10px;
      }
    }
  </style>
</head>
<body>
  <!-- Initial Loading Overlay -->
  <div id="initial-loader">
    <div class="loader-content">
      <div class="spinner"></div>
      <div class="loader-text">Initializing X Username Minter...</div>
    </div>
  </div>

  <div id="app-container">
    <div class="cyber-grid"></div>

    <header>
      <div class="brand">
        <div class="logo"><span class="material-icons">alternate_email</span></div>
        <div class="title">
          <h1 class="glitch-text" data-text="X Username Minter">X Username Minter</h1>
          <p>Mint your X handle as an on-chain identity (NFTFAN community)</p>
        </div>
      </div>
      <div class="actions">
        <span class="pill">
          <span class="material-icons">paid</span>
          <span>Mint Price: <strong style="margin-left:4px;color:var(--primary);">1 POL</strong></span>
        </span>
        <button id="connectBtn" class="primary">
          <span class="material-icons">account_balance_wallet</span>Connect
        </button>
        <span id="wallet" class="wallet" style="display:none;"></span>
      </div>
    </header>

    <main>
      <!-- Left: mint form -->
      <div class="panel">
        <div class="panel-header">
          <h2 class="glitch-text" data-text="Mint Username">Mint Username</h2>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="usernameInput">X Username</label>
            <input type="text" id="usernameInput" placeholder="@yourhandle" maxlength="32" />
          </div>
        </div>

        <div class="row" style="grid-template-columns: 1fr 110px; gap: 10px;">
          <div class="form-group">
            <label for="empireNameInput">Empire / Community Name</label>
            <input type="text" id="empireNameInput" placeholder="e.g. NFTFAN Syndicate" maxlength="32" />
          </div>
          <div class="form-group">
            <label for="empireColorInput">Theme Color</label>
            <input type="color" id="empireColorInput" value="#00f9ff" />
          </div>
        </div>

        <div class="row inline">
          <span id="selectionPill" class="pill" style="display:none;"></span>
          <span id="ownedCountPill" class="pill" style="display:none;"></span>
          <span id="mintedCountPill" class="pill" style="display:none;"></span>
        </div>

        <div class="row inline">
          <button id="mintBtn" class="success" disabled>
            <span class="material-icons">rocket_launch</span>Mint Username
          </button>
          <button id="clearBtn" class="accent">
            <span class="material-icons">delete_sweep</span>Clear
          </button>
          <button id="refreshBtn">
            <span class="material-icons">refresh</span>Refresh
          </button>
        </div>

        <div id="status" class="status">Connect your wallet and enter an X username to mint it.</div>
      </div>

      <!-- Right: leaderboard + usernames table -->
      <div class="panel">
        <div class="panel-header">
          <h2 class="glitch-text" data-text="Top Collectors">Top Collectors</h2>
        </div>
        <table class="leaderboard-table">
          <thead>
            <tr>
              <th class="rank">#</th>
              <th class="owner">Owner</th>
              <th class="count">Usernames</th>
              <th class="value">Total POL Spent</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- rows filled by JS -->
          </tbody>
        </table>

        <div class="panel-header" style="margin-top:16px;">
          <h2 class="glitch-text" data-text="Minted Usernames">Minted Usernames</h2>
        </div>
        <div style="max-height:260px;overflow-y:auto;">
          <table class="usernames-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Owner</th>
                <th>Empire</th>
                <th>Mint Price (POL)</th>
              </tr>
            </thead>
            <tbody id="usernames-body">
              <!-- rows filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Loading toast -->
  <div id="cityLoading" class="toast" role="status" aria-live="assertive" aria-atomic="true">
    <span class="spinner" aria-hidden="true"></span>
    <span class="material-icons" aria-hidden="true">alternate_email</span>
    <span class="text">Loading username data...</span>
  </div>

  <script>
    // Polygon Mainnet
    const POLYGON_PARAMS = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };

    // Contract
    const CONTRACT_ADDRESS = "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC";
    const CONTRACT_ABI = [
      "function mintWithURI(string tokenURI) external payable returns (uint256)",
      "function mintPrice() view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function ownerOf(uint256 tokenId) view returns (address)",
      "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
    ];

    // Fixed price: 1 POL
    const FIXED_MINT_PRICE_POL = 1;

    // Firebase configuration (same as your previous app)
    const firebaseConfig = {
      apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
      authDomain: "newnft-47bd7.firebaseapp.com",
      databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
      projectId: "newnft-47bd7",
      storageBucket: "newnft-47bd7.firebasestorage.app",
      messagingSenderId: "172043823738",
      appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
      measurementId: "G-8VB3DYRNXR"
    };

    // Ethers / state
    let web3Provider, signer, userAddress;
    let empireName = '', empireColor = '#00f9ff';
    let selectedUsername = '';

    // Firebase
    let fbApp, fbDb;
    let allNftsRef = null;

    // Username data (reusing Map concept)
    const usernameDataByName = new Map(); // key: username_lower -> data

    // UI elements
    const initialLoader = document.getElementById('initial-loader');
    const connectBtn = document.getElementById('connectBtn');
    const walletEl = document.getElementById('wallet');
    const mintBtn = document.getElementById('mintBtn');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const selectionPill = document.getElementById('selectionPill');
    const ownedCountPill = document.getElementById('ownedCountPill');
    const mintedCountPill = document.getElementById('mintedCountPill');
    const cityLoadingEl = document.getElementById('cityLoading');
    const empireNameInput = document.getElementById('empireNameInput');
    const empireColorInput = document.getElementById('empireColorInput');
    const usernameInput = document.getElementById('usernameInput');
    const leaderboardBody = document.getElementById('leaderboard-body');
    const usernamesBody = document.getElementById('usernames-body');

    function showCityLoading(text = 'Loading username data...') {
      cityLoadingEl.querySelector('.text').textContent = text;
      cityLoadingEl.style.display = 'inline-flex';
      setTimeout(() => {
        if (cityLoadingEl.style.display !== 'none') hideCityLoading();
      }, 20000);
    }
    function hideCityLoading() {
      cityLoadingEl.style.display = 'none';
    }

    function setStatus(msg, type = '') {
      if (!msg) {
        statusEl.textContent = '';
        statusEl.className = 'status';
        return;
      }
      statusEl.className = 'status';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'loading') {
        statusEl.classList.add('loading');
        statusEl.innerHTML = `<span class="spinner"></span><span>${msg}</span>`;
      } else {
        statusEl.textContent = msg;
      }
    }

    function escapeHTML(s) {
      return String(s || '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
    function shortAddr(a) {
      return a ? `${a.slice(0,6)}...${a.slice(-4)}` : '';
    }

    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_PARAMS.chainId }]
        });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          try {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [POLYGON_PARAMS]
            });
            return true;
          } catch {
            setStatus('Failed to add Polygon network', 'error');
            return false;
          }
        }
        setStatus('Failed to switch network', 'error');
        return false;
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        setStatus('Please install MetaMask to continue', 'error');
        return;
      }
      try {
        setStatus('Connecting wallet...', 'loading');
        if (!await switchToPolygon()) return;

        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        await web3Provider.send('eth_requestAccounts', []);
        signer = web3Provider.getSigner();
        userAddress = await signer.getAddress();

        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span>Connected';
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';

        await loadEmpireSettings();
        setStatus('Wallet connected.', 'success');
        updateMintButtonState();
        updateCountsAndLeaderboard();

        if (window.ethereum?.on) {
          window.ethereum.removeListener?.('accountsChanged', onAccountsChanged);
          window.ethereum.on('accountsChanged', onAccountsChanged);
        }
      } catch (e) {
        console.error(e);
        setStatus('Wallet connection failed', 'error');
      }
    }

    async function onAccountsChanged(accounts) {
      userAddress = (accounts && accounts[0]) ? accounts[0] : null;
      if (userAddress) {
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span>Connected';
        await loadEmpireSettings();
      } else {
        walletEl.style.display = 'none';
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<span class="material-icons">account_balance_wallet</span>Connect';
      }
      updateMintButtonState();
      updateCountsAndLeaderboard();
    }

    function updateUsernameState() {
      let value = usernameInput.value.trim();
      if (value && !value.startsWith('@')) {
        value = '@' + value;
      }
      selectedUsername = value;

      if (selectedUsername) {
        selectionPill.style.display = 'inline-flex';
        const taken = isUsernameMinted(selectedUsername);
        selectionPill.innerHTML =
          `<span class="material-icons" style="font-size:16px;">alternate_email</span>` +
          `${escapeHTML(selectedUsername)} · ` +
          `<span style="color:${taken ? 'var(--error)' : 'var(--primary)'};">` +
          (taken ? 'Already minted' : 'Available') +
          `</span>`;
      } else {
        selectionPill.style.display = 'none';
      }
      updateMintButtonState();
    }

    function isUsernameMinted(username) {
      if (!username) return false;
      const unameLower = username.toLowerCase();
      return usernameDataByName.has(unameLower);
    }

    function updateEmpireState() {
      empireName = empireNameInput.value.trim();
      empireColor = empireColorInput.value || '#00f9ff';
      updateMintButtonState();
    }

    function updateMintButtonState() {
      const hasWallet = !!userAddress;
      const hasUsername = !!selectedUsername;
      const taken = hasUsername && isUsernameMinted(selectedUsername);
      const hasEmpire = !!empireName;

      mintBtn.disabled = !hasWallet || !hasUsername || taken || !hasEmpire;
      if (taken) {
        setStatus('This username is already minted.', 'error');
      } else if (hasWallet && hasUsername && hasEmpire) {
        setStatus(`Ready to mint ${selectedUsername} for ${FIXED_MINT_PRICE_POL} POL.`, 'success');
      }
    }

    async function mintSelectedUsername() {
      try {
        if (!userAddress) {
          setStatus('Please connect your wallet first', 'error');
          return;
        }
        if (!selectedUsername) {
          setStatus('Enter an X username first', 'error');
          return;
        }
        if (isUsernameMinted(selectedUsername)) {
          setStatus('This username is already minted', 'error');
          return;
        }
        if (!empireName) {
          setStatus('Please enter an Empire / Community Name before minting', 'error');
          return;
        }

        const mintPricePol = FIXED_MINT_PRICE_POL;
        setStatus('Submitting mint transaction...', 'loading');
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        const tokenURI = buildUsernameTokenURI(selectedUsername, empireName, empireColor);
        const priceWei = ethers.utils.parseEther(mintPricePol.toString());
        const tx = await contract.mintWithURI(tokenURI, { value: priceWei });

        setStatus('Transaction sent! Waiting for confirmation...', 'loading');
        const receipt = await tx.wait();
        const ev = receipt.events?.find(e => e.event === 'Transfer');
        const mintedTokenId = ev?.args?.tokenId?.toString() || `temp-${Date.now()}`;

        const now = Math.floor(Date.now() / 1000);
        const fullNftData = {
          owner: userAddress,
          meta: {
            username: selectedUsername,
            username_lower: selectedUsername.toLowerCase(),
            empire_name: empireName,
            empire_color: empireColor,
            mint_price_pol: mintPricePol,
            created_at: now
          }
        };

        await writeNftToFirebase(mintedTokenId, fullNftData);
        await saveEmpireSettings();

        setStatus(`Success! ${selectedUsername} has been minted.`, 'success');
        updateMintButtonState();
      } catch (e) {
        console.error("Minting failed:", e);
        const msg = e?.data?.message || e?.reason || e?.message || 'Unknown transaction error.';
        setStatus(`Minting failed: ${msg}`, 'error');
      }
    }

    function buildUsernameTokenURI(username, empireName, empireColor) {
      const metadata = {
        name: `X Handle: ${username}`,
        description: `NFT claiming the X username ${username} under the ${empireName} community.`,
        image: buildUsernameSVG(username, empireName, empireColor),
        attributes: [
          { trait_type: "Username", value: username },
          { trait_type: "Empire Name", value: empireName },
          { trait_type: "Empire Color", value: empireColor }
        ]
      };
      const json = JSON.stringify(metadata);
      return "data:application/json;base64," + btoa(unescape(encodeURIComponent(json)));
    }

    function buildUsernameSVG(username, empireName, empireColor) {
      const uname = escapeHTML(username);
      const emp = escapeHTML(empireName || '');
      const color = empireColor || '#00f9ff';

      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="420" viewBox="0 0 800 420">
          <defs>
            <linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#070814" />
              <stop offset="100%" stop-color="#12122a" />
            </linearGradient>
            <linearGradient id="titleGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="${color}" />
              <stop offset="100%" stop-color="#eef2ff" />
            </linearGradient>
            <filter id="glow">
              <feGaussianBlur stdDeviation="3.5" result="blur" />
              <feFlood flood-color="${color}" flood-opacity="0.4" result="color" />
              <feComposite in="color" in2="blur" operator="in" result="glow" />
              <feMerge>
                <feMergeNode in="glow" />
                <feMergeNode in="SourceGraphic" />
              </feMerge>
            </filter>
          </defs>
          <rect width="800" height="420" fill="url(#bgGrad)" />
          <rect x="10" y="10" width="780" height="400" rx="15"
                fill="none" stroke="${color}" stroke-width="2" filter="url(#glow)" />
          <g font-family="'Orbitron', sans-serif">
            <text x="40" y="90" font-size="32" font-weight="700" fill="url(#titleGrad)" filter="url(#glow)">
              X USERNAME NFT
            </text>
            <text x="40" y="150" font-size="48" font-weight="900" fill="#eef2ff">${uname}</text>
            <text x="40" y="200" font-size="20" fill="#8f9cce">Community: ${emp}</text>
            <g transform="translate(40,260)">
              <rect width="260" height="60" rx="10" fill="none" stroke="${color}" stroke-width="2" />
              <rect x="1" y="1" width="258" height="58" rx="9" fill="${color}1A" />
              <text x="30" y="38" font-size="22" font-weight="700" fill="${color}" filter="url(#glow)">NFTFAN VERIFIED</text>
            </g>
          </g>
        </svg>
      `;
      return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
    }

    // Firebase init / subscription
    function initFirebase() {
      try {
        if (!window.firebase) throw new Error("Firebase script not loaded");
        fbApp = firebase.initializeApp(firebaseConfig);
        fbDb = firebase.database();
        subscribeMintedOnFirebase();
      } catch (e) {
        console.error('Firebase init failed', e);
        setStatus("Could not connect to the database.", "error");
        initialLoader.classList.add('hidden');
      }
    }

    function subscribeMintedOnFirebase() {
      if (!fbDb) return;
      allNftsRef = fbDb.ref('nfts');

      allNftsRef.once('value', (snapshot) => {
        snapshot.forEach((childSnapshot) => {
          upsertMintedUsername(childSnapshot.key, childSnapshot.val());
        });
        initialLoader.classList.add('hidden');

        allNftsRef.on('child_added', (snap) => upsertMintedUsername(snap.key, snap.val()));
        allNftsRef.on('child_changed', (snap) => upsertMintedUsername(snap.key, snap.val()));
        allNftsRef.on('child_removed', (snap) => removeMintedUsername(snap.key, snap.val()));
      }, (err) => {
        console.error("Firebase initial read failed:", err);
        setStatus("Cannot read username data. Check DB rules.", "error");
        initialLoader.classList.add('hidden');
      });
    }

    function upsertMintedUsername(tokenId, data) {
      if (!data || !data.meta) return;
      const username = data.meta.username;
      if (!username) return;

      const unameLower = (data.meta.username_lower || username).toLowerCase();
      const ownerLower = (data.owner || '').toLowerCase();

      const fullData = {
        tokenId,
        owner: ownerLower,
        username,
        username_lower: unameLower,
        empireName: data.meta.empire_name || '',
        empireColor: data.meta.empire_color || '#00f9ff',
        mintPricePol: data.meta.mint_price_pol || FIXED_MINT_PRICE_POL,
        createdAt: data.meta.created_at || 0
      };

      usernameDataByName.set(unameLower, fullData);
      updateCountsAndLeaderboard();
      renderUsernamesTable();
    }

    function removeMintedUsername(tokenId, data) {
      if (!data || !data.meta) return;
      const unameLower = (data.meta.username_lower || data.meta.username || '').toLowerCase();
      if (!unameLower) return;
      usernameDataByName.delete(unameLower);
      updateCountsAndLeaderboard();
      renderUsernamesTable();
    }

    async function writeNftToFirebase(tokenId, fullNftData) {
      if (!fbDb) return;
      await fbDb.ref(`nfts/${tokenId}`).set(fullNftData);
    }

    async function saveEmpireSettings() {
      if (!fbDb || !userAddress) return;
      await fbDb.ref(`empires/${userAddress.toLowerCase()}`).set({
        name: empireName,
        color: empireColor
      });
    }

    async function loadEmpireSettings() {
      if (!fbDb || !userAddress) return;
      const snapshot = await fbDb.ref(`empires/${userAddress.toLowerCase()}`).get();
      if (snapshot.exists()) {
        const data = snapshot.val();
        empireNameInput.value = data.name || '';
        empireColorInput.value = data.color || '#00f9ff';
      }
      updateEmpireState();
    }

    function updateCountsAndLeaderboard() {
      let myOwnedCount = 0;
      const ownerCounts = {};
      const ownerValues = {};

      if (userAddress) {
        const userAddrLower = userAddress.toLowerCase();
        for (const data of usernameDataByName.values()) {
          if (data.owner === userAddrLower) myOwnedCount++;
        }
      }

      ownedCountPill.style.display = myOwnedCount > 0 ? 'inline-flex' : 'none';
      if (myOwnedCount > 0) {
        ownedCountPill.innerHTML =
          `<span class="material-icons" style="font-size:16px;color:var(--success);">verified</span>` +
          `You own: <strong style="margin-left:4px;color:var(--success);">${myOwnedCount} usernames</strong>`;
      }

      const totalMinted = usernameDataByName.size;
      mintedCountPill.style.display = 'inline-flex';
      mintedCountPill.innerHTML =
        `<span class="material-icons" style="font-size:16px;">people</span>` +
        `Total minted: <strong style="margin-left:4px;color:var(--primary);">${totalMinted}</strong>`;

      for (const data of usernameDataByName.values()) {
        if (data.owner) {
          ownerCounts[data.owner] = (ownerCounts[data.owner] || 0) + 1;
          ownerValues[data.owner] = (ownerValues[data.owner] || 0) + (data.mintPricePol || FIXED_MINT_PRICE_POL);
        }
      }

      const sortedOwners = Object.entries(ownerCounts)
        .map(([owner, count]) => ({ owner, count, value: ownerValues[owner] }))
        .sort((a, b) => b.count - a.count || b.value - a.value);

      renderLeaderboard(sortedOwners.slice(0, 10));
    }

    function renderLeaderboard(sortedOwners) {
      leaderboardBody.innerHTML = '';
      if (sortedOwners.length === 0) {
        leaderboardBody.innerHTML =
          '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px;">No usernames minted yet.</td></tr>';
        return;
      }
      sortedOwners.forEach((entry, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="rank">${index + 1}</td>
          <td class="owner">${shortAddr(entry.owner)}</td>
          <td class="count">${entry.count}</td>
          <td class="value">${entry.value.toFixed(2)} POL</td>
        `;
        leaderboardBody.appendChild(row);
      });
    }

    function renderUsernamesTable() {
      usernamesBody.innerHTML = '';
      if (usernameDataByName.size === 0) {
        usernamesBody.innerHTML =
          '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:10px;">No usernames minted yet.</td></tr>';
        return;
      }

      const list = Array.from(usernameDataByName.values())
        .sort((a, b) => b.createdAt - a.createdAt);

      for (const data of list) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${escapeHTML(data.username)}</td>
          <td>${shortAddr(data.owner)}</td>
          <td>${escapeHTML(data.empireName)}</td>
          <td>${(data.mintPricePol || FIXED_MINT_PRICE_POL).toFixed(2)}</td>
        `;
        usernamesBody.appendChild(row);
      }
    }

    function clearSelection() {
      usernameInput.value = '';
      selectedUsername = '';
      selectionPill.style.display = 'none';
      setStatus('Selection cleared. Enter a new X username to mint.', 'success');
      updateMintButtonState();
    }

    // Event listeners
    connectBtn.addEventListener('click', connectWallet);
    mintBtn.addEventListener('click', mintSelectedUsername);
    clearBtn.addEventListener('click', clearSelection);
    refreshBtn.addEventListener('click', () => {
      setStatus("Data refresh is automatic via Firebase. Manual refresh disabled.", "error");
    });
    empireNameInput.addEventListener('input', updateEmpireState);
    empireColorInput.addEventListener('input', updateEmpireState);
    usernameInput.addEventListener('input', updateUsernameState);

    window.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      setStatus('Connect your wallet and enter an X username to mint it.', '');
    });
  </script>
</body>
</html>
