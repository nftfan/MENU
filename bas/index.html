<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MATIC Bank + Trades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://raw.githubusercontent.com/nftfan/delivery/main/Untitled%20design%20(22).png" type="image/png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>

  <!-- Firebase SDKs (Compat version for simple HTML usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    html, body {
      background: #fff;
      font-family: 'Inter', Arial, sans-serif;
      margin: 0;
      padding: 0;
      font-size: 10px;
      color: #222;
      min-height: 100vh;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 10px 0 60px 0;
    }

    .price-bar {
      background: #eefdf2;
      border-radius: 10px;
      border: 1px solid #daefdd;
      margin: 10px 10px 18px 10px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .price-bar-label { color: #0d8a43; font-weight: bold; }
    .price-bar-value { color: #222; font-size: 16px; font-weight: bold; margin-left: 8px; }

    .total-card {
      background: #f8f7ff;
      border-radius: 10px;
      border: 1px solid #ececec;
      margin: 10px 10px 22px 10px;
      padding: 18px 14px 15px 14px;
      text-align: left;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    .total-label { font-size: 10px; font-weight: bold; color: #888; margin-bottom: 7px; }
    .total-sum { font-size: 18px; font-weight: bold; color: #7a3cff; }
    .total-usd { font-size: 13px; color: #0d8a43; font-weight: bold; margin-top: 4px; }

    .refresh-btn {
      font-size: 10px; padding: 7px 18px; border-radius: 15px; border: 1px solid #ececec;
      background: #f4f0ff; color: #7a3cff; font-weight: bold; margin: 0 10px 12px 10px;
      cursor: pointer; display: inline-block; align-self: flex-end;
    }

    .section-label { font-weight: bold; margin: 25px 0 8px 16px; font-size: 12px; color: #444; }

    .account-card {
      display: flex; justify-content: space-between; align-items: flex-start;
      border: 1px solid #ececec; border-radius: 9px; background: #fff;
      margin: 0 10px 12px 10px; padding: 14px 14px 10px 14px; min-height: 48px;
    }
    .account-info { flex: 1; min-width: 0; }
    .account-title { font-weight: bold; font-size: 10px; margin-bottom: 2px; color: #222; }
    .account-iban, .account-owner { font-size: 10px; color: #999; line-height: 1.5; }
    .account-balance { font-size: 12px; font-weight: bold; color: #7a3cff; margin-left: 10px; white-space: nowrap; }
    .account-balance-usd { font-size: 11px; color: #0d8a43; margin-left: 10px; }

    .loading-spinner {
      display: inline-block; width: 12px; height: 12px; border: 1px solid #bbb;
      border-radius: 50%; border-top-color: #7a3cff; animation: spin 0.8s linear infinite; margin-left: 3px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- TRADES SECTION STYLES --- */
    .trades-header {
      display: flex; justify-content: space-between; align-items: center;
      margin: 30px 16px 15px 16px;
    }
    .add-trade-btn {
      background: #222; color: #fff; border: none; border-radius: 20px;
      padding: 8px 20px; font-size: 11px; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.1s;
    }
    .add-trade-btn:active { transform: scale(0.96); }

    .trade-card {
      background: #fff;
      border-radius: 12px;
      margin: 0 10px 12px 10px;
      padding: 15px;
      padding-right: 56px; /* reserve space for Del button */
      position: relative;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      transition: all 0.3s ease;
    }

    .trade-card.type-buy { border: 1px solid #27ae60; border-left: 5px solid #27ae60; }
    .trade-card.type-sell { border: 1px solid #e74c3c; border-left: 5px solid #e74c3c; }

    .trade-dot {
      width: 8px; height: 8px; border-radius: 50%; margin-right: 12px; flex-shrink: 0;
    }
    .type-buy .trade-dot { background-color: #27ae60; box-shadow: 0 0 6px #27ae60; }
    .type-sell .trade-dot { background-color: #e74c3c; box-shadow: 0 0 6px #e74c3c; }

    .trade-main { flex: 1; }
    .trade-coin { font-size: 14px; font-weight: 800; color: #222; margin-bottom: 2px; text-transform: uppercase;}
    .trade-entry { font-size: 11px; color: #666; }
    .trade-time { font-size: 9px; color: #aaa; margin-top: 4px; font-weight: 500;}

    .trade-stats {
      text-align: right;
      min-width: 110px;
    }
    .trade-change { font-size: 14px; font-weight: bold; display: block; margin-bottom: 2px; }
    .trade-change.up { color: #27ae60; }
    .trade-change.down { color: #e74c3c; }
    .trade-current { font-size: 10px; color: #888; }

    /* Delete button */
    .trade-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      border: 1px solid #eee;
      background: #fff;
      color: #e74c3c;
      font-size: 10px;
      font-weight: 700;
      border-radius: 10px;
      padding: 4px 7px;
      cursor: pointer;
      line-height: 1;
    }
    .trade-delete-btn:active { transform: scale(0.96); }

    /* Modal Styles */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 999; display: none;
      justify-content: center; align-items: flex-end;
    }
    .modal-overlay.open { display: flex; }

    .modal-content {
      background: #fff; width: 100%; max-width: 480px;
      border-radius: 20px 20px 0 0; padding: 25px;
      box-sizing: border-box; animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #222; }

    .form-group { margin-bottom: 15px; }
    .form-label { display: block; font-size: 11px; font-weight: bold; color: #666; margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      font-size: 14px; box-sizing: border-box; outline: none;
    }
    .form-input:focus { border-color: #7a3cff; }

    .type-selector { display: flex; gap: 10px; margin-bottom: 20px; }
    .type-opt {
      flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
      text-align: center; font-weight: bold; font-size: 12px; cursor: pointer;
      transition: 0.2s;
    }
    .type-opt.selected-buy { background: #eefdf2; border-color: #27ae60; color: #27ae60; }
    .type-opt.selected-sell { background: #feefee; border-color: #e74c3c; color: #e74c3c; }

    .submit-btn {
      width: 100%; background: #7a3cff; color: #fff; border: none; padding: 14px;
      border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;
    }
    .close-modal { margin-top: 15px; text-align: center; color: #888; font-size: 12px; cursor: pointer; }

    @media (min-width: 481px) {
      .modal-overlay { align-items: center; }
      .modal-content { border-radius: 20px; margin: 20px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Header: POL Price -->
    <div class="price-bar">
      <span class="price-bar-label">POL Price (USD):</span>
      <span class="price-bar-value" id="pol-price">Loading...</span>
      <span style="font-size:12px;color:#444;margin-left:8px;">USD</span>
    </div>

    <!-- Total Balance -->
    <div class="total-card">
      <div class="total-label">Total balance</div>
      <div class="total-sum" id="total-sum"><span class="loading-spinner"></span></div>
      <div class="total-usd" id="total-sum-usd"><span class="loading-spinner"></span></div>
    </div>
    <button class="refresh-btn" id="refresh-btn" onclick="refreshAllBalances()">⟳ Refresh</button>

    <!-- Wallets -->
    <div class="section-label">Payment accounts</div>
    <div class="account-card" id="account-1">
      <div class="account-info">
        <div class="account-title">NFTFAN SALE</div>
        <div class="account-iban">0xaf2d...12e8</div>
        <div class="account-owner">Trading</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-1"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-1-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <div class="account-card" id="account-2">
      <div class="account-info">
        <div class="account-title">POLDOG SALE</div>
        <div class="account-iban">0xB1A3...7D54</div>
        <div class="account-owner">Investment</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-2"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-2-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <div class="section-label">Savings accounts</div>
    <div class="account-card" id="account-0">
      <div class="account-info">
        <div class="account-title">MY WALLET</div>
        <div class="account-iban">0x92d5...27Ba</div>
        <div class="account-owner">Personal</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-0"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-0-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <div class="account-card" id="account-3">
      <div class="account-info">
        <div class="account-title">SAVINGS 2</div>
        <div class="account-iban">0x2dbA...144F1</div>
        <div class="account-owner">Personal</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-3"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-3-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <!-- PHOTONFT WALLET -->
    <div class="account-card" id="account-4">
      <div class="account-info">
        <div class="account-title">PHOTONFT</div>
        <div class="account-iban">0xb7d9...E2CC</div>
        <div class="account-owner">NFTs</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-4"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-4-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <!-- NEW FANI WALLET -->
    <div class="account-card" id="account-5">
      <div class="account-info">
        <div class="account-title">FANI</div>
        <div class="account-iban">0xacc7...02c6</div>
        <div class="account-owner">Personal</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-5"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-5-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <!-- NEW NFTSIX WALLET -->
    <div class="account-card" id="account-6">
      <div class="account-info">
        <div class="account-title">NFTSIX</div>
        <div class="account-iban">0xe220...74e0</div>
        <div class="account-owner">Personal</div>
      </div>
      <div>
        <div class="account-balance positive" id="balance-6"><span class="loading-spinner"></span></div>
        <div class="account-balance-usd" id="balance-6-usd"><span class="loading-spinner"></span></div>
      </div>
    </div>

    <!-- TRADES SECTION -->
    <div class="trades-header">
      <div style="font-weight:bold; font-size:16px;">My Trades</div>
      <button class="add-trade-btn" onclick="openModal()">+ Add Trade</button>
    </div>

    <div id="trades-container">
      <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">Loading trades...</div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal-content">
      <div class="modal-title">New Trade Entry</div>

      <div class="type-selector">
        <div class="type-opt selected-buy" id="opt-buy" onclick="selectType('buy')">BUY</div>
        <div class="type-opt" id="opt-sell" onclick="selectType('sell')">SELL</div>
      </div>

      <div class="form-group">
        <label class="form-label">Coin Symbol (e.g. BTC, POL, ETH)</label>
        <input type="text" id="t-coin" class="form-input" placeholder="BTC">
      </div>

      <div class="form-group">
        <label class="form-label">Entry Price ($)</label>
        <input type="number" id="t-price" class="form-input" placeholder="0.00" step="any">
      </div>

      <div class="form-group">
        <label class="form-label">Date & Time</label>
        <input type="datetime-local" id="t-date" class="form-input">
      </div>

      <button class="submit-btn" onclick="submitTrade()">Add Trade</button>
      <div class="close-modal" onclick="closeModal()">Cancel</div>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
      authDomain: "tokentransfer-4a9b3.firebaseapp.com",
      databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
      projectId: "tokentransfer-4a9b3",
      storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
      messagingSenderId: "205455490321",
      appId: "1:205455490321:web:9919f5dde059316c9320b0",
      measurementId: "G-Y6CVEDL9XH"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- WALLET LOGIC ---
    const POLYGON_RPC = "https://polygon-rpc.com/";
    const WALLETS = [
      { address: "0x92d550cdBc234211957Bd1B579d962c885A127Ba", idx: 0 },
      { address: "0xaf2d132c8773bca3821c24ecf64e844e202a12e8", idx: 1 },
      { address: "0xB1A37c277986E13Aa6c4f0763c2F06C4E9527D54", idx: 2 },
      { address: "0x2dbA27e3ab39F662c1Df9CBdC4dBD526107144F1", idx: 3 },
      { address: "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC", idx: 4 }, // Photonft
      { address: "0xacc774D2B05606ad22bDe0f53c256D20f83202c6", idx: 5 }, // FANI
      { address: "0xe220Bc80B77769407d127A195920D527200674e0", idx: 6 }  // NFTSIX
    ];

    // Display order
    const DISPLAY_ORDER = [1, 2, 0, 3, 4, 5, 6];

    let polPriceUSD = null;

    async function fetchPOLPrice() {
      try {
        const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=POLUSDT');
        const data = await response.json();
        polPriceUSD = parseFloat(data.price);
        document.getElementById('pol-price').innerText = "$" + polPriceUSD.toFixed(4);
      } catch (error) {
        document.getElementById('pol-price').innerText = 'Err';
      }
    }

    async function fetchAndShowBalance(wallet) {
      const idx = wallet.idx;
      try {
        const web3 = new Web3(POLYGON_RPC);
        const balanceWei = await web3.eth.getBalance(wallet.address);
        const balance = web3.utils.fromWei(balanceWei, "ether");
        const formatted = parseFloat(balance).toLocaleString(undefined, {maximumFractionDigits: 4});

        document.getElementById("balance-" + idx).textContent = "+ " + formatted + " MATIC";

        if (polPriceUSD != null) {
          const usdVal = (parseFloat(balance) * polPriceUSD);
          document.getElementById("balance-" + idx + "-usd").textContent = "≈ $" + usdVal.toLocaleString(undefined, {maximumFractionDigits: 2});
        }
        return parseFloat(balance);
      } catch (err) {
        document.getElementById("balance-" + idx).innerText = "--";
        const usdEl = document.getElementById("balance-" + idx + "-usd");
        if (usdEl) usdEl.innerText = "";
        return 0;
      }
    }

    async function refreshAllBalances() {
      const btn = document.getElementById("refresh-btn");
      if (btn) btn.textContent = "Updating...";

      let sum = 0;
      for (let i = 0; i < DISPLAY_ORDER.length; i++) {
        const idx = DISPLAY_ORDER[i];
        const wallet = WALLETS.find(w => w.idx === idx);
        if (!wallet) continue;
        const balance = await fetchAndShowBalance(wallet);
        sum += balance;
      }

      document.getElementById("total-sum").textContent = "+ " + sum.toLocaleString(undefined, {maximumFractionDigits: 4}) + " MATIC";
      if (polPriceUSD != null) {
        const totalUsd = (sum * polPriceUSD);
        document.getElementById("total-sum-usd").textContent = "≈ $" + totalUsd.toLocaleString(undefined, {maximumFractionDigits: 2});
      }
      if (btn) btn.textContent = "⟳ Refresh";
    }

    // --- TRADES LOGIC ---
    let currentTradeType = 'buy';

    function openModal() {
      document.getElementById('tradeModal').classList.add('open');
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('t-date').value = now.toISOString().slice(0,16);
      selectType(currentTradeType);
    }

    function closeModal() {
      document.getElementById('tradeModal').classList.remove('open');
    }

    function selectType(type) {
      currentTradeType = type;
      if(type === 'buy') {
        document.getElementById('opt-buy').classList.add('selected-buy');
        document.getElementById('opt-sell').classList.remove('selected-sell');
        document.getElementById('opt-buy').style.background = "#eefdf2";
        document.getElementById('opt-sell').style.background = "#fff";
      } else {
        document.getElementById('opt-buy').classList.remove('selected-buy');
        document.getElementById('opt-sell').classList.add('selected-sell');
        document.getElementById('opt-buy').style.background = "#fff";
        document.getElementById('opt-sell').style.background = "#feefee";
      }
    }

    function submitTrade() {
      const coin = document.getElementById('t-coin').value.toUpperCase().trim();
      const price = parseFloat(document.getElementById('t-price').value);
      const dateStr = document.getElementById('t-date').value;

      if(!coin || !price || !dateStr) {
        alert("Please fill all fields");
        return;
      }

      const timestamp = new Date(dateStr).getTime();

      const newTradeRef = database.ref('trades').push();
      newTradeRef.set({
        coin: coin,
        entryPrice: price,
        timestamp: timestamp,
        type: currentTradeType
      });

      closeModal();
      document.getElementById('t-coin').value = "";
      document.getElementById('t-price').value = "";
    }

    function timeAgo(prevDate) {
      const diff = Number(new Date()) - prevDate;
      const minute = 60 * 1000;
      const hour = minute * 60;
      const day = hour * 24;

      const days = Math.floor(diff / day);
      const hours = Math.floor((diff % day) / hour);

      if (days > 0) return `${days}d ${hours}h ago`;
      if (hours > 0) return `${hours} hours ago`;
      return "Just now";
    }

    // Listen for Trades Data
    database.ref('trades').on('value', (snapshot) => {
      const container = document.getElementById('trades-container');
      container.innerHTML = "";
      const data = snapshot.val();

      if(!data) {
        container.innerHTML = "<div style='text-align:center;color:#ccc;font-size:12px;margin-top:20px'>No trades yet</div>";
        return;
      }

      const trades = Object.entries(data)
        .map(([key, trade]) => ({ key, ...trade }))
        .sort((a,b) => b.timestamp - a.timestamp);

      trades.forEach(async (trade) => {
        const div = document.createElement('div');
        div.className = `trade-card type-${trade.type}`;

        div.innerHTML = `
          <button class="trade-delete-btn" title="Delete">Del</button>

          <div class="trade-dot"></div>
          <div class="trade-main">
            <div class="trade-coin">${trade.coin}</div>
            <div class="trade-entry">Entry: $${trade.entryPrice}</div>
            <div class="trade-time">${timeAgo(trade.timestamp)}</div>
          </div>
          <div class="trade-stats" id="stats-${trade.key}">
            <div class="trade-change">...</div>
            <div class="trade-current">Loading...</div>
          </div>
        `;

        div.querySelector(".trade-delete-btn").addEventListener("click", (e) => {
          e.stopPropagation();
          if(confirm("Delete this trade?")) {
            database.ref(`trades/${trade.key}`).remove();
          }
        });

        container.appendChild(div);

        try {
          const symbol = trade.coin === 'POL' ? 'POLUSDT' : trade.coin + 'USDT';
          const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
          const resData = await response.json();
          const currentPrice = parseFloat(resData.price);

          const change = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100;
          const isProfit = change >= 0;
          const sign = isProfit ? "+" : "";
          const colorClass = isProfit ? "up" : "down";

          const statsDiv = document.getElementById(`stats-${trade.key}`);
          if(statsDiv) {
            statsDiv.innerHTML = `
              <div class="trade-change ${colorClass}">${sign}${change.toFixed(2)}%</div>
              <div class="trade-current">Curr: $${currentPrice.toLocaleString()}</div>
            `;
          }
        } catch(e) {
          const statsDiv = document.getElementById(`stats-${trade.key}`);
          if(statsDiv) statsDiv.innerHTML = `<div class="trade-current" style="color:red">Price Error</div>`;
        }
      });
    });

    // --- INITIALIZATION ---
    window.addEventListener("DOMContentLoaded", () => {
      fetchPOLPrice().then(refreshAllBalances);
      setInterval(fetchPOLPrice, 3000);
      setInterval(refreshAllBalances, 30000);
    });
  </script>
</body>
</html>
