<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC Predictor Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{
    margin:0;font-family:Segoe UI;background:#080a0f;color:#fff;
    display:flex;justify-content:center;align-items:center;min-height:100vh;
}
.container{
    width:420px;background:#111827;padding:20px;border-radius:20px;
    box-shadow:0 0 40px rgba(0,242,255,.2);
}
h1{text-align:center;color:#00f2ff}
.btn{
    width:100%;padding:14px;margin-top:10px;
    border:none;border-radius:10px;font-weight:700;cursor:pointer;
}
.primary{background:#00f2ff;color:#000}
.dir{background:#1f2937;color:#fff}
.dir.selected-up{border:2px solid #00ffa3}
.dir.selected-down{border:2px solid #ff3864}
#btc{font-size:28px;text-align:center;margin:10px 0}
#leaderboard{margin-top:20px;border-top:1px solid #333;padding-top:10px}
.lb-row{display:flex;justify-content:space-between;font-size:12px;color:#ccc}
#paywall{display:none;text-align:center;background:#000;padding:20px;border-radius:12px}
</style>
</head>

<body>
<div class="container">
<h1>BTC Predictor Pro</h1>

<button id="connectBtn" class="btn primary">CONNECT WALLET</button>

<div id="app" style="display:none">
    <div id="btc">Loading...</div>
    <canvas id="chart" height="120"></canvas>

    <button id="up" class="btn dir">UP</button>
    <button id="down" class="btn dir">DOWN</button>
    <button id="confirm" class="btn primary" disabled>CONFIRM</button>

    <p>Balance: <b id="bal">$100.00</b></p>
    <p>Rounds: <b id="rounds">0 / 3</b></p>

    <div id="paywall">
        <h3>Free rounds used</h3>
        <button class="btn primary" onclick="payToPlay()">PAY 1 POL</button>
    </div>

    <div id="leaderboard">
        <h3 style="color:#00f2ff">Leaderboard</h3>
        <div id="lb"></div>
    </div>
</div>
</div>

<script>
/* ================= CONFIG ================= */
const ADMIN="0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
const firebaseConfig={
 apiKey:"AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
 authDomain:"tokentransfer-4a9b3.firebaseapp.com",
 databaseURL:"https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
 projectId:"tokentransfer-4a9b3",
 storageBucket:"tokentransfer-4a9b3.firebasestorage.app",
 messagingSenderId:"205455490321",
 appId:"1:205455490321:web:9919f5dde059316c9320b0"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ================= STATE ================= */
let provider,signer,wallet;
let btc=0,entry=0,dir=null;
let balance=100,rounds=0;

/* ================= WALLET ================= */
connectBtn.onclick=async()=>{
 if(!window.ethereum) return alert("Install MetaMask");
 provider=new ethers.providers.Web3Provider(window.ethereum);
 const net=await provider.getNetwork();
 if(net.chainId!==137) return alert("Switch to Polygon");
 signer=provider.getSigner();
 wallet=await signer.getAddress();

 connectBtn.style.display="none";
 app.style.display="block";
 loadUser();
 initChart();
};

/* ================= USER DATA ================= */
async function loadUser(){
 const ref=db.ref("users/"+wallet);
 const snap=await ref.get();
 if(!snap.exists()){
   await ref.set({balance:100,rounds:0});
 }
 const d=(await ref.get()).val();
 balance=d.balance; rounds=d.rounds;
 updateUI();
 if(rounds>=3) paywall.style.display="block";
}

/* ================= PRICE ================= */
async function fetchPrice(){
 const r=await fetch("https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT");
 btc=parseFloat((await r.json()).price);
 document.getElementById("btc").textContent="$"+btc.toFixed(2);
 updateChart(btc);
}
setInterval(fetchPrice,2000);

/* ================= GAME ================= */
up.onclick=()=>select("UP");
down.onclick=()=>select("DOWN");

function select(d){
 dir=d;
 up.classList.toggle("selected-up",d==="UP");
 down.classList.toggle("selected-down",d==="DOWN");
 confirm.disabled=false;
}

confirm.onclick=()=>{
 if(rounds>=3){paywall.style.display="block";return;}
 entry=btc;
 setTimeout(endRound,60000);
 confirm.disabled=true;
};

async function endRound(){
 let pnl=dir==="UP"?btc-entry:entry-btc;
 balance+=pnl;
 rounds++;

 await db.ref("users/"+wallet).set({balance,rounds});
 await db.ref("leaderboard/"+wallet).set({balance});

 updateUI();
 loadLeaderboard();

 if(rounds>=3) paywall.style.display="block";
}

/* ================= PAY ================= */
async function payToPlay(){
 const tx=await signer.sendTransaction({
  to:ADMIN,
  value:ethers.utils.parseEther("1")
 });
 await tx.wait();
 rounds=0;
 await db.ref("users/"+wallet+"/rounds").set(0);
 paywall.style.display="none";
 updateUI();
}

/* ================= UI ================= */
function updateUI(){
 bal.textContent="$"+balance.toFixed(2);
 roundsEl=document.getElementById("rounds");
 roundsEl.textContent=rounds+" / 3";
}

/* ================= LEADERBOARD ================= */
function loadLeaderboard(){
 db.ref("leaderboard").orderByChild("balance").limitToLast(10)
 .on("value",snap=>{
  let arr=[];
  snap.forEach(c=>arr.push({w:c.key,b:c.val().balance}));
  arr.reverse();
  lb.innerHTML=arr.map((p,i)=>
   `<div class="lb-row">
     <span>#${i+1} ${p.w.slice(0,6)}â€¦</span>
     <b>${p.b.toFixed(2)}</b>
   </div>`).join("");
 });
}
loadLeaderboard();

/* ================= CHART ================= */
let chart,data=[];
function initChart(){
 chart=new Chart(document.getElementById("chart"),{
  type:"line",
  data:{labels:[],datasets:[{data:[],borderColor:"#00f2ff",pointRadius:0}]},
  options:{plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}
 });
}
function updateChart(p){
 data.push(p); if(data.length>20) data.shift();
 chart.data.datasets[0].data=data;
 chart.update("none");
}
</script>
</body>
</html>
