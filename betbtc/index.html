<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC Pro: Leaderboard & Faucet</title>
<meta name="viewport" content="width=420">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background: #0B0E11; color: #EAECEF; margin:0; padding:10px; }
.container { max-width: 380px; margin: auto; background: #181A20; border-radius: 16px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
h1 { font-size: 1.2rem; text-align: center; color: #FCD535; margin-bottom: 5px; }
/* Tabs */
.tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #333; }
.tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #848E9C; font-weight: bold; font-size: 12px; }
.tab.active { color: #FCD535; border-bottom: 2px solid #FCD535; }
/* Stats */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.stat-card { background: #2B2F36; padding: 10px; border-radius: 8px; text-align: center; }
.stat-label { font-size: 9px; color: #848E9C; text-transform: uppercase; }
.stat-value { font-size: 14px; font-weight: bold; display: block; margin-top: 3px; }
/* Game Elements */
.comparison-bar { display: flex; justify-content: space-between; background: #1e2329; padding: 10px; border-radius: 8px; margin: 10px 0; border: 1px solid #333; }
.comp-item { flex: 1; text-align: center; }
.comp-label { font-size: 10px; color: #848E9C; display: block; }
.comp-val { font-size: 12px; font-weight: bold; font-family: monospace; }
/* Leverage Slider */
.leverage-row { display: flex; align-items: center; margin-top:13px; margin-bottom: 5px; justify-content: space-between; }
.leverage-label { font-size:11px; color:#FCD535; }
#leverageSlider { width: 70%; margin-left: 7px; margin-right:7px; }
#leverageSlider:disabled { opacity:0.4; }
/* Timer Progress Bar */
#timerBarContainer { width:100%; height: 7px; background:#23262f; border-radius:7px; overflow:hidden; margin-bottom:3px; }
#timerBar { height:100%; background:linear-gradient(90deg,#FCD535 0,#fcb535 100%); transition:width 1s linear; }
/* Buttons */
.btn { border: none; border-radius: 4px; padding: 12px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; font-size: 13px; }
.btn-connect { background: #FCD535; color: #000; }
.btn-row { display: flex; gap: 8px; width:100%; margin-bottom:8px;}
.btn-up { background: #2ebd85; color: white; width: 50%; }
.btn-down { background: #f6465d; color: white; width: 50%; }
.btn-disabled { opacity: 0.3; pointer-events: none; }
.selected { outline: 2px solid #fff; transform: scale(0.98); }
#btc-price { font-size: 24px; font-weight: bold; text-align: center; margin: 10px 0; color: #FCD535; }
/* Bet History */
.bet-history-title { margin-top:15px; font-size: 9px; color:#FCD535; font-weight:bold; text-align:left; margin-bottom:5px; }
#betHistoryTable { width:100%; font-size:7px; border-collapse:collapse; background:#242731; margin-bottom: 0; }
#betHistoryTable th, #betHistoryTable td { border:1px solid #26282d; padding:3px; text-align:center; }
#betHistoryTable th { background:#181A20;color:#FCD535;}
#betHistoryTable tr:nth-child(even) { background:#1e2329; }
#betHistoryTable tr:nth-child(odd) { background:#242731;}
/* Leaderboard */
#leaderboard-list { list-style: none; padding: 0; margin-top: 10px; }
.lb-item { display: flex; justify-content: space-between; padding: 8px; background: #2b2f36; margin-bottom: 4px; border-radius: 4px; font-size: 11px; }
.lb-rank { color: #FCD535; font-weight: bold; width: 20px; }
.lb-wallet { color: #848E9C; font-family: monospace; }
.reward-info { font-size: 10px; color: #848E9C; background: #1e2329; padding: 10px; border-radius: 8px; margin-top: 15px; border-left: 3px solid #FCD535; }
</style>
</head>
<body>
<div class="container">
    <h1>BTC TRADER PRO</h1>
    <div id="auth-section">
        <button id="connectBtn" class="btn btn-connect">CONNECT WALLET TO START</button>
    </div>
    <div id="app-content" style="display:none;">
        <div class="tabs">
            <div id="tab-trade" class="tab active" onclick="switchTab('trade')">TRADE</div>
            <div id="tab-leader" class="tab" onclick="switchTab('leader')">LEADERBOARD</div>
        </div>
        <div id="view-trade">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">Balance</span>
                    <span id="balanceUSD" class="stat-value">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Est. Reward</span>
                    <span id="rewardNFTFAN" class="stat-value" style="color:#00ffcc">0M</span>
                </div>
            </div>
            <div id="btc-price">--.---</div>
            <canvas id="btcChart" width="340" height="80"></canvas>
            <div id="comparison" class="comparison-bar" style="display:none;">
                <div class="comp-item"><span class="comp-label">Entry</span><span id="entryPrice" class="comp-val">--</span></div>
                <div class="comp-item"><span class="comp-label">Live</span><span id="livePrice" class="comp-val">--</span></div>
                <div class="comp-item"><span class="comp-label">PnL</span><span id="liveDiff" class="comp-val">--</span></div>
            </div>
            <div class="leverage-row">
                <span class="leverage-label">Leverage:</span>
                <input type="range" min="1" max="10000" value="1" id="leverageSlider" oninput="onLeverageSet(this.value)">
                <span id="leverageValue" style="color:#FCD535;font-weight:bold;font-size:12px;">1x</span>
                <span id="leverageFee" style="color:#f6465d; font-size:11px;margin-left:8px;display:none;"></span>
            </div>
            <div id="timerBarContainer" style="display:none;"><div id="timerBar"></div></div>
            <div id="timer" style="display:none;"></div>
            <div id="controls">
                <div class="btn-row">
                    <button id="upBtn" class="btn btn-up" onclick="selectDir('UP')">UP</button>
                    <button id="downBtn" class="btn btn-down" onclick="selectDir('DOWN')">DOWN</button>
                </div>
                <button id="startBtn" class="btn btn-connect btn-disabled" style="margin-top:10px;" onclick="startBet()">CONFIRM POSITION</button>
            </div>
            <div class="bet-history-title">Recent Bets by All Users</div>
            <table id="betHistoryTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Wallet</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Side</th>
                        <th>Leverage</th>
                        <th>PnL</th>
                    </tr>
                </thead>
                <tbody id="betHistoryBody">
                </tbody>
            </table>
        </div>
        <div id="view-leader" style="display:none;">
            <div style="text-align:center; font-size:11px; margin-bottom:10px; color:#848E9C;">Top Traders by Balance</div>
            <div id="leaderboard-list">Loading...</div>
        </div>
    </div>
    <div class="reward-info">
        <b>Rules:</b> 1M $NFTFAN for every $1 USD in your balance. Negative balances are allowed.<br>
        Leverage up to 500x is free. Every x above 500 reduces your balance instantly by 0.01% per x moved above 500. Max 10000x.<br>
        When a bet is active, leverage cannot be changed.<br>
        All leverage fees are non-refundable.
    </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
    authDomain: "tokentransfer-4a9b3.firebaseapp.com",
    databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
    projectId: "tokentransfer-4a9b3",
    storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
    messagingSenderId: "205455490321",
    appId: "1:205455490321:web:9919f5dde059316c9320b0",
    measurementId: "G-Y6CVEDL9XH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let userWallet = null;
let currentBalance = 0.00;
let btcPrice = 0;
let gameState = "IDLE";
let selectedDirection = null;
let entryPrice = 0;
let userLeverage = 1;
let entryLine = null;
let timerInterval = null, timerValue=0;

let pendingLeverage = 1;
let paidLeverageFee = 0;

const FREE_LEVERAGE = 500;
const MAX_LEVERAGE = 10000;
const LEVERAGE_FEE_RATE = 0.0001; // 0.01% per x above 500

document.getElementById('connectBtn').onclick = async () => {
    if (window.ethereum) {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userWallet = accounts[0].toLowerCase();
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initUser();
    } else { alert("Install MetaMask"); }
};
function initUser() {
    db.ref('users/' + userWallet).on('value', (snap) => {
        if (snap.exists()) {
            currentBalance = snap.val().balance;
        } else {
            db.ref('users/' + userWallet).set({ balance: 0.0, wallet: userWallet });
            currentBalance = 0.0;
        }
        updateUI();
    });
    loadBetHistory();
}
function updateUI() {
    const balanceField = document.getElementById('balanceUSD');
    balanceField.textContent = `$${currentBalance.toFixed(2)}`;
    balanceField.style.color = currentBalance >= 0 ? "#EAECEF" : "#f6465d";
    document.getElementById('rewardNFTFAN').textContent = `${(currentBalance * 1).toFixed(1)}M`;
}

function switchTab(tab) {
    document.getElementById('view-trade').style.display = tab === 'trade' ? 'block' : 'none';
    document.getElementById('view-leader').style.display = tab === 'leader' ? 'block' : 'none';
    document.getElementById('tab-trade').className = "tab" + (tab === 'trade' ? ' active' : '');
    document.getElementById('tab-leader').className = "tab" + (tab === 'leader' ? ' active' : '');
    if (tab === 'leader') loadLeaderboard();
}

// Helper: compute fee for changing from prevX to newX (exclusive of <501)
function getLeverageFee(prevX, newX, bal) {
    let from = Math.max(prevX, FREE_LEVERAGE);
    let to = Math.max(newX, FREE_LEVERAGE);
    if (to > from && bal > 0) {
        let added = to - from;
        let fee = bal * LEVERAGE_FEE_RATE * added;
        return fee;
    }
    return 0;
}

// Leverage slider logic
function onLeverageSet(val) {
    if(gameState==="ACTIVE") return;

    val = parseInt(val);
    let slider = document.getElementById('leverageSlider');
    let feeEl = document.getElementById('leverageFee');
    feeEl.style.display = "none";

    if(val > MAX_LEVERAGE) {
        val = MAX_LEVERAGE;
        slider.value = MAX_LEVERAGE;
    }
    let prevX = pendingLeverage;
    let userBal = currentBalance;

    // Calculate positive delta and fee
    let fee = 0;
    let charged = false;
    if (val > prevX && val > FREE_LEVERAGE) {
        let feeReq = getLeverageFee(prevX,val,userBal);
        if(feeReq > currentBalance) {
            // Clamp to max allowable leverage, user can only afford n more x
            let maxExtraX = Math.floor(currentBalance/(userBal*LEVERAGE_FEE_RATE));
            let maxX = Math.max(prevX,FREE_LEVERAGE) + maxExtraX;
            if(maxX > MAX_LEVERAGE) maxX = MAX_LEVERAGE;
            val = maxX;
            slider.value = maxX;
            feeReq = getLeverageFee(prevX,val,userBal);
        }
        if (feeReq > 0) {
            charged = true;
            pendingLeverage = val;
            userLeverage = val;
            paidLeverageFee += feeReq;
            currentBalance -= feeReq;
            db.ref('users/' + userWallet).update({ balance: currentBalance });
            updateUI();
        }
    }
    pendingLeverage = val;
    userLeverage = val;
    feeEl.style.display = (val>FREE_LEVERAGE) ? "" : "none";
    if(val>FREE_LEVERAGE) {
        let totalFee = paidLeverageFee + (charged ? 0 : getLeverageFee(FREE_LEVERAGE,val,currentBalance));
        feeEl.textContent = `Fee: $${totalFee.toFixed(2)} non-refundable`;
    }
    document.getElementById('leverageValue').textContent = userLeverage+'x';
}

// Lock leverage input while betting
function setLeverageEnabled(enable) {
    const slider = document.getElementById('leverageSlider');
    slider.disabled = !enable;
}

// --- LEADERBOARD ---
function loadLeaderboard() {
    db.ref('users').orderByChild('balance').limitToLast(10).once('value', (snap) => {
        let list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        let items = [];
        snap.forEach(child => { items.push(child.val()); });
        items.reverse().forEach((u, i) => {
            list.innerHTML += `<div class="lb-item">
                <span><span class="lb-rank">#${i+1}</span> <span class="lb-wallet">${u.wallet.slice(0,6)}...${u.wallet.slice(-4)}</span></span>
                <span style="font-weight:bold;color:${u.balance<0?'#f6465d':'#EAECEF'}">$${u.balance.toFixed(2)}</span>
            </div>`;
        });
    });
}

// --- BET HISTORY ---
function recordBet(entry, exit, dir, leverage, pnl, date, feeCharged) {
    const betObj = {
        entry, exit, dir, leverage, pnl, date, fee: feeCharged,
        wallet: userWallet
    };
    const betKey = db.ref('bets/'+userWallet).push().key;
    db.ref(`bets/${userWallet}/${betKey}`).set(betObj).then(loadBetHistory);
}

function loadBetHistory() {
    const tbody = document.getElementById('betHistoryBody');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#848E9C;">Loading...</td></tr>';
    db.ref('bets').once('value', function(snap) {
        let bets = [];
        snap.forEach(userSnap => {
            userSnap.forEach(betSnap => {
                const v = betSnap.val();
                bets.push(v);
            });
        });
        bets.sort((a, b) => (b.date||'') > (a.date||'') ? 1 : -1);
        let rows = [];
        for(let i=0; i<bets.length; i++) {
            let { date, entry, exit, dir, leverage, pnl, wallet } = bets[i];
            let dateStr = date ? (new Date(date)).toLocaleString() : "-";
            let walletStr = wallet ? wallet.slice(0,6)+'...'+wallet.slice(-4) : '-';
            rows.push(`<tr>
                <td>${dateStr}</td>
                <td>${walletStr}</td>
                <td>${entry ? '$'+Number(entry).toFixed(2) : '-'}</td>
                <td>${exit ? '$'+Number(exit).toFixed(2) : '-'}</td>
                <td style="color:${dir=="UP"?"#2ebd85":"#f6465d"};font-weight:700">${dir||"-"}</td>
                <td>${leverage||"-"}x</td>
                <td style="color:${(pnl>0?"#2ebd85":(pnl<0?"#f6465d":"#aaa"))};font-weight:bold">${!isNaN(pnl)?(pnl>0?"+":"")+Number(pnl).toFixed(2):"-"}</td>
            </tr>`);
            if(i===49) break;
        }
        tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="7" style="text-align:center;color:#848E9C;">No bet history.</td></tr>';
    });
}

// --- GAMEPLAY ---
async function fetchPrice() {
    try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await res.json();
        btcPrice = parseFloat(data.price);
    } catch { btcPrice = btcPrice }
    document.getElementById('btc-price').textContent = `$${btcPrice.toLocaleString()}`;
    if (gameState === "ACTIVE") {
        document.getElementById('livePrice').textContent = `$${btcPrice.toFixed(2)}`;
        let diff = btcPrice - entryPrice;
        let pnl = (selectedDirection === "UP" ? diff : -diff) * userLeverage;
        document.getElementById('liveDiff').textContent = (pnl >= 0 ? "+" : "") + pnl.toFixed(2);
        document.getElementById('liveDiff').style.color = pnl >= 0 ? "#2ebd85" : "#f6465d";
    }
}
setInterval(fetchPrice, 2000);

function selectDir(dir) {
    if (gameState !== "IDLE") return;
    selectedDirection = dir;
    document.getElementById('upBtn').className = "btn btn-up" + (dir === 'UP' ? ' selected' : '');
    document.getElementById('downBtn').className = "btn btn-down" + (dir === 'DOWN' ? ' selected' : '');
    document.getElementById('startBtn').classList.remove('btn-disabled');
}
function maintainSelectedBtnHighlight() {
    if (gameState === "ACTIVE") {
        document.getElementById('upBtn').className = "btn btn-up" + (selectedDirection === 'UP' ? ' selected' : '');
        document.getElementById('downBtn').className = "btn btn-down" + (selectedDirection === 'DOWN' ? ' selected' : '');
    }
}
setInterval(maintainSelectedBtnHighlight, 333);

const ctx = document.getElementById('btcChart').getContext('2d');
let priceHistory = [];
let dottedLinePlugin = {
    id: 'dottedLine',
    afterDraw: function(chart, eas) {
        if (entryLine !== null) {
            let y = chart.scales['y'].getPixelForValue(entryLine);
            let ctx = chart.ctx;
            ctx.save();
            ctx.setLineDash([4,4]);
            ctx.beginPath();
            ctx.moveTo(chart.chartArea.left, y);
            ctx.strokeStyle = "#fedd45";
            ctx.lineWidth = 2;
            ctx.lineTo(chart.chartArea.right, y);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
        }
    }
}
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{ data: priceHistory, borderColor: '#FCD535', tension: 0.4, pointRadius: 0, borderWidth: 2, fill:false }]
    },
    options: {
        scales: { x: { display: false }, y: { display: false } },
        plugins: { legend: { display: false } }
    },
    plugins: [dottedLinePlugin]
});
setInterval(() => {
    priceHistory.push(btcPrice);
    if (priceHistory.length > 20) priceHistory.shift();
    chart.data.datasets[0].data = priceHistory.slice();
    chart.update();
}, 3000);

function showTimerBar(show) {
    document.getElementById('timerBarContainer').style.display = show?'block':'none';
}
function updateTimerBar(percent) {
    document.getElementById('timerBar').style.width = (percent*100).toFixed(2)+'%';
}

function startBet() {
    if (!selectedDirection) return;
    gameState = "ACTIVE";
    setLeverageEnabled(false);

    entryPrice = btcPrice;
    entryLine = entryPrice;
    document.getElementById('controls').style.display = 'none';
    document.getElementById('comparison').style.display = 'flex';
    document.getElementById('entryPrice').textContent = `$${entryPrice.toFixed(2)}`;
    document.getElementById('livePrice').textContent = `$${btcPrice.toFixed(2)}`;
    document.getElementById('liveDiff').textContent = '--';
    document.getElementById('leverageFee').style.display = (userLeverage>FREE_LEVERAGE) ? "" : "none";
    chart.update();

    timerValue = 60;
    updateTimerBar(1);
    showTimerBar(true);
    document.getElementById('timer').style.display = "none";
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timerValue--;
        updateTimerBar(timerValue/60);
        if (timerValue <= 0) {
            clearInterval(timerInterval);
            endBet();
        }
    }, 1000);
}

function endBet() {
    let fallBackPrice = btcPrice || entryPrice;
    let exitPrice = fallBackPrice;
    let diff = (selectedDirection === "UP" ? (exitPrice - entryPrice) : (entryPrice - exitPrice));
    let pnl = diff * userLeverage; // Fees already deducted, do NOT refund
    let now = new Date().toISOString();

    db.ref('users/' + userWallet).update({ balance: currentBalance });
    recordBet(entryPrice, exitPrice, selectedDirection, userLeverage, pnl, now, paidLeverageFee);

    setTimeout(() => {
        entryLine = null;
        gameState = "IDLE";
        setLeverageEnabled(true);
        document.getElementById('controls').style.display = 'block';
        document.getElementById('comparison').style.display = 'none';
        document.getElementById('startBtn').classList.add('btn-disabled');
        document.getElementById('upBtn').className = "btn btn-up";
        document.getElementById('downBtn').className = "btn btn-down";
        selectedDirection = null;
        document.getElementById('leverageSlider').value = userLeverage;
        chart.update();
        showTimerBar(false);

        // Reset temporary state for next round
        paidLeverageFee = 0;
        pendingLeverage = userLeverage;
        // flash fee text on settlement
        document.getElementById('leverageFee').style.display = (userLeverage>FREE_LEVERAGE) ? "" : "none";
    }, 3000);
}
</script>
</body>
</html>
