<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC Pro: Compact PnL Vault</title>
<meta name="viewport" content="width=420, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background: #0B0E11; color: #EAECEF; margin:0; padding:7px; font-size:9px; }
.container { max-width: 370px; margin: auto; background: #181A20; border-radius: 11px; padding: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.4);}
h1 { font-size: 10px; text-align: center; color: #FCD535; margin-bottom: 4px; font-weight:bold; }
.tabs { display: flex; gap: 2px; margin-bottom: 7px; border-bottom: 1px solid #333; }
.tab { flex: 1; padding: 6px; text-align: center; cursor: pointer; color: #848E9C; font-weight:bold; font-size: 9px;}
.tab.active { color: #FCD535; border-bottom: 2px solid #FCD535;}
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 7px; }
.stat-card { background: #22252b; padding: 7px; border-radius: 6px; text-align: center; }
.stat-label { font-size: 8px; color: #848E9C; text-transform: uppercase;}
.stat-value { font-size: 10px; font-weight:bold; display:block; margin-top: 3px;}
.comparison-bar { display: flex; justify-content: space-between; background: #1e2329; padding: 7px; border-radius: 6px; margin: 7px 0; border: 1px solid #333; font-size:9px;}
.comp-item { flex: 1; text-align: center;}
.comp-label { font-size: 8px; color: #848E9C; display: block;}
.comp-val { font-size: 9px; font-weight: bold; font-family: monospace;}
.leverage-row, .amount-row { display: flex; align-items: center; margin-bottom: 4px; justify-content: space-between; }
.leverage-label, .amount-label { font-size:9px; color:#FCD535; }
#leverageSlider, #amountSlider { width: 55%; margin-left: 4px; margin-right:4px; }
#leverageSlider:disabled, #amountSlider:disabled { opacity:0.4;}
.slider-value { color:#FCD535;font-weight:bold;font-size:9px;min-width:22px;display:inline-block;text-align:right;}
#betAmountSummary { color: #fff; font-size: 9px; margin-bottom: 4px; margin-top: 2px;}
#timerBarContainer { width:100%; height: 4px; background:#23262f; border-radius:4px; overflow:hidden; margin-bottom:2px;}
#timerBar { height:100%; background:linear-gradient(90deg,#FCD535 0,#fcb535 100%); transition:width 1s linear;}
.btn { border: none; border-radius: 3px; padding: 6px 9px; font-weight: bold; cursor: pointer; width: unset; font-size: 8.5px; transition: 0.17s;}
.btn-connect { background: #FCD535; color: #000;}
.btn-up { background: #2ebd85; color: white;}
.btn-down { background: #f6465d; color: white;}
.btn-disabled { opacity: 0.3; pointer-events: none;}
.selected { outline: 2px solid #fff; transform: scale(0.97);}
#btc-price { font-size: 12px; font-weight:bold; text-align:center; margin:7px 0; color:#FCD535;}
#pnlTable { width: 100%; font-size: 8px; border-collapse: collapse; background: #242731; margin-bottom: 5px;}
#pnlTable th, #pnlTable td { border:1px solid #26282d; padding:2px; text-align:center; font-size:8px;}
#pnlTable th { background:#181A20;color:#FCD535;}
#pnlTable tr:nth-child(even) { background:#1e2329;}
#pnlTable tr:nth-child(odd) { background:#242731;}
#pnlTable td.pnl-positive { color: #2ebd85;}
#pnlTable td.pnl-negative { color: #f6465d;}
#currentLoss { color:#f6465d;font-weight:bold; }
#remainingAdd { color:#FCD535;font-weight:bold;}
#payForLossBtn { margin-top:7px;}
.max-btn { background: #23262f; color:#FCD535; border:none; border-radius:2px; font-weight:bold; font-size:8px; padding:2px 6px; margin:0 2px; cursor:pointer;}
.input-funds { width:58px; font-size:9px; border-radius:4px; padding:2.5px 2px;border:1px solid #333; background:#1e2329; color:#FCD535; margin-left:3px;}
.input-funds::-webkit-outer-spin-button,
.input-funds::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0;}
.input-funds[type=number] { -moz-appearance: textfield;}
.reward-info { font-size:8px; color:#848E9C; background:#1e2329; padding:7px; border-radius:5px; margin-top:9px; border-left: 2px solid #FCD535; }
</style>
</head>
<body>
<div class="container">
    <h1>BTC TRADER PRO</h1>
    <div id="auth-section">
        <button id="connectBtn" class="btn btn-connect">CONNECT</button>
    </div>
    <div id="app-content" style="display:none;">
        <div class="tabs">
            <div id="tab-mybalance" class="tab active" onclick="switchTab('mybalance')">MY BAL</div>
            <div id="tab-trade" class="tab" onclick="switchTab('trade')">TRADE</div>
            <div id="tab-pnl" class="tab" onclick="switchTab('pnl')">PNL</div>
        </div>
        <!-- MY BALANCE TAB -->
        <div id="view-mybalance">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">MAIN</span>
                    <span id="userMain" class="stat-value">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">TRADING</span>
                    <span id="userTrading" class="stat-value">$0.00</span>
                </div>
            </div>
            <div style="margin-bottom:6px;">
                <button class="btn btn-up" id="addMoneyBtn" onclick="addMoneyMain()">Add Main</button>
                <input class="input-funds" id="addMoneyInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1" step="1" max="1000000">
                <span style="color:#848E9C;font-size:7px;padding-left:2px;">Max/day: 1M</span>
            </div>
            <div style="color:#848E9C;font-size:8px;margin-bottom:3px;">Remaining today: <span id="remainingAdd">$1,000,000</span></div>
            <div style="margin-bottom:6px;">
                <button class="btn btn-connect" id="mainToTradingBtn" onclick="moveBalance('main','trading')">Main➔Trade</button>
                <input class="input-funds" id="mainToTradingInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1"
                       step="1" max="999999">
                <button class="max-btn" onclick="setMax('mainToTrading')">MAX</button>
            </div>
            <div style="margin-bottom:6px;">
                <button class="btn btn-down" id="tradingToMainBtn" onclick="moveBalance('trading','main')">Trade➔Main</button>
                <input class="input-funds" id="tradingToMainInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1"
                       step="1" max="999999">
                <button class="max-btn" onclick="setMax('tradingToMain')">MAX</button>
            </div>
        </div>
        <!-- TRADE TAB -->
        <div id="view-trade" style="display:none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">TRADING</span>
                    <span id="balanceUSD" class="stat-value">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">MAIN</span>
                    <span id="userMain2" class="stat-value" style="color:#fff">$0.00</span>
                </div>
            </div>
            <div id="btc-price">--.---</div>
            <canvas id="btcChart" width="340" height="55"></canvas>
            <div id="comparison" class="comparison-bar" style="display:none;">
                <div class="comp-item"><span class="comp-label">Entry</span><span id="entryPrice" class="comp-val">--</span></div>
                <div class="comp-item"><span class="comp-label">Live</span><span id="livePrice" class="comp-val">--</span></div>
                <div class="comp-item"><span class="comp-label">PnL</span><span id="liveDiff" class="comp-val">--</span></div>
            </div>
            <div class="amount-row">
                <span class="amount-label">Bet:</span>
                <input type="range" min="1" max="100" value="10" id="amountSlider" oninput="onBetAmountSet(this.value)">
                <span id="amountValue" class="slider-value">10</span>
            </div>
            <div id="betAmountSummary">(Bal after: <span id="betAmountRemain">$0.00</span>)</div>
            <div class="leverage-row">
                <span class="leverage-label">Lev:</span>
                <input type="range" min="0" max="500" value="1" id="leverageSlider" oninput="onLeverageSet(this.value)">
                <span id="leverageValue" class="slider-value">1x</span>
            </div>
            <div id="timerBarContainer" style="display:none;"><div id="timerBar"></div></div>
            <div id="timer" style="display:none;"></div>
            <div id="controls">
                <div class="btn-row">
                    <button id="upBtn" class="btn btn-up" onclick="selectDir('UP')">UP</button>
                    <button id="downBtn" class="btn btn-down" onclick="selectDir('DOWN')">DOWN</button>
                </div>
                <button id="startBtn" class="btn btn-connect btn-disabled" style="margin-top:5px;" onclick="startBet()">CONFIRM</button>
            </div>
        </div>
        <!-- PNL TAB -->
        <div id="view-pnl" style="display:none;">
            <div class="stats-grid" style="margin-bottom:4px;">
                <div class="stat-card">
                    <span class="stat-label">TOTAL PROFIT</span>
                    <span id="totalProfit" class="stat-value" style="color:#2ebd85">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">LOSS TO PAY</span>
                    <span id="currentLoss" class="stat-value">$0.00</span>
                    <button class="btn btn-down" id="payForLossBtn" style="display:none;" onclick="payForLoss()">Pay for Loss</button>
                </div>
            </div>
            <div style="color:#848E9C;font-size:8px;margin-bottom:3px;">Profit/Loss History</div>
            <table id="pnlTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>PnL</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>Side</th>
                        <th>Amt</th>
                        <th>Lev</th>
                    </tr>
                </thead>
                <tbody id="pnlTableBody"></tbody>
            </table>
        </div>
    </div>
    <div class="reward-info">
        Fund your Main up to <span style="color:#FCD535;">1,000,000</span> per day.<br>
        Move between Main/Trade. <span style="color:#f6465d;">If you have a loss, you must "Pay for Loss" to 0 before further trading.</span><br>
        Profits/loss/compact UI - no zoom on mobile!
    </div>
<script type="module">
// Firebase & Analytics
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, push, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyA6w6auszWRniQfZCjb4nXE_bq9Mzt9dOs",
  authDomain: "betbtc-6d881.firebaseapp.com",
  databaseURL: "https://betbtc-6d881-default-rtdb.firebaseio.com",
  projectId: "betbtc-6d881",
  storageBucket: "betbtc-6d881.firebasestorage.app",
  messagingSenderId: "962176232122",
  appId: "1:962176232122:web:a277d922543c3378033083",
  measurementId: "G-V4XNB7K1E0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Util
function toUsd(x) { return "$" + (+x).toLocaleString("en",{minimumFractionDigits:2}); }
function nonneg(x) { return (!x||x<0)?0:Number(x); }
function todayKey() { let d = new Date(); d.setUTCHours(0,0,0,0); return d.toISOString().slice(0,10);}
let userWallet = null, main = 0, trading = 0, totalProfit = 0, currentLoss = 0, btcPrice = 0;
let gameState = "IDLE", selectedDirection = null, entryPrice = 0, userLeverage = 1, userBetAmount = 10, entryLine = null, timerInterval = null, timerValue=0;
let todayAddAmt = 0, todayAddDate = null;

function selectTab(tab) {
    document.getElementById('view-mybalance').style.display = tab==="mybalance"?"block":"none";
    document.getElementById('view-trade').style.display = tab==="trade"?"block":"none";
    document.getElementById('view-pnl').style.display = tab==="pnl"?"block":"none";
    document.getElementById('tab-mybalance').className = "tab" + (tab=='mybalance'?' active':'');
    document.getElementById('tab-trade').className = "tab" + (tab=='trade'?' active':'');
    document.getElementById('tab-pnl').className = "tab" + (tab=='pnl'?' active':'');
}
window.switchTab = selectTab;

document.getElementById('connectBtn').onclick = async () => {
    if (window.ethereum) {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userWallet = accounts[0].toLowerCase();
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initUser();
    } else { alert("Install MetaMask"); }
};

function setRemainingAdd(val) {
    let left = 1000000 - (val||0);
    document.getElementById('remainingAdd').textContent = toUsd(left<=0?0:left);
}

function initUser() {
    onValue(ref(db, `users/${userWallet}`), snap => {
        let node = snap.val();
        main = nonneg(node?.main);
        trading = nonneg(node?.trading);
        totalProfit = Number(node?.totalProfit ?? 0);
        currentLoss = Number(node?.loss ?? 0);
        todayAddAmt = node?.todayAdd?.amount || 0;
        todayAddDate = node?.todayAdd?.date || '';
        updateTabs();
        setRemainingAdd(todayAddAmt);
        updateLossUI();
    });
    loadPnLTable();
    checkAndSettleActiveBet();
}

function updateTabs() {
    document.getElementById('userMain').textContent = toUsd(main);
    document.getElementById('userMain2').textContent = toUsd(main);
    document.getElementById('userTrading').textContent = toUsd(trading);
    document.getElementById('balanceUSD').textContent = toUsd(trading);
    updateAmountSlider();
    document.getElementById('mainToTradingInput').max = main;
    document.getElementById('tradingToMainInput').max = trading;
}
function setMax(which) {
    if(which==='mainToTrading') document.getElementById('mainToTradingInput').value = main;
    else if(which==='tradingToMain') document.getElementById('tradingToMainInput').value = trading;
}
window.setMax = setMax;

// Add to main, max 1M per day
window.addMoneyMain = async function() {
    let amt = Math.round(+document.getElementById('addMoneyInput').value);
    if (isNaN(amt)||amt<1||amt>1000000) return alert("Max add per day is 1,000,000");
    // Only one add per day
    let todayStr = todayKey();
    if (todayAddAmt>0 && todayAddDate && todayAddDate.slice(0,10) == todayStr) return alert("Already added money today!");
    await set(ref(db, `users/${userWallet}/main`), main + amt);
    await set(ref(db, `users/${userWallet}/todayAdd`), {amount:amt, date:new Date().toISOString()});
    todayAddAmt = amt;
    setRemainingAdd(todayAddAmt);
    document.getElementById('addMoneyInput').value = '';
};

window.moveBalance = async function(from,to) {
    let inputId, amt, u = {};
    if (from==='main' && to==='trading') inputId = "mainToTradingInput";
    else if (from==='trading' && to==='main') inputId = "tradingToMainInput";
    else return;
    amt = parseFloat(document.getElementById(inputId).value);
    if(!amt || amt <= 0) {alert("Enter valid amount."); return;}
    if      (from=="main"    && amt>main)      { alert("Insufficient main balance."); return; }
    else if (from=="trading" && amt>trading)   { alert("Insufficient trading balance."); return; }
    if(from=='main')    u['main']=main-amt;
    if(to=='main')      u['main']=main+amt;
    if(from=='trading') u['trading']=trading-amt;
    if(to=='trading')   u['trading']=trading+amt;
    await update(ref(db,`users/${userWallet}`), u);
    document.getElementById(inputId).value = '';
};

window.onLeverageSet = function(val) {
    if(gameState==="ACTIVE") return;
    userLeverage = parseInt(val);
    document.getElementById('leverageValue').textContent = userLeverage+'x';
};
window.onBetAmountSet = function(val) {
    if(gameState==="ACTIVE") return;
    userBetAmount = Math.round(Math.min(Math.max(1, +val), Math.max(1, Math.floor(trading))));
    document.getElementById('amountValue').textContent = userBetAmount;
    let futureBalance = trading - userBetAmount;
    document.getElementById('betAmountRemain').textContent = toUsd(futureBalance);
};
function setLeverageEnabled(enable) {
    document.getElementById('leverageSlider').disabled = !enable;
}
function setAmountEnabled(enable) {
    document.getElementById('amountSlider').disabled = !enable;
}
function updateAmountSlider() {
    let amountSlider = document.getElementById('amountSlider');
    amountSlider.min = "1";
    amountSlider.max = Math.max("1", trading<1 ? 1 : Math.floor(trading));
    userBetAmount = Math.max(1, Math.min(userBetAmount, Math.floor(amountSlider.max)));
    amountSlider.value = userBetAmount;
    document.getElementById('amountValue').textContent = userBetAmount;
    let futureBalance = trading - userBetAmount;
    document.getElementById('betAmountRemain').textContent = toUsd(futureBalance);
}

function updateLossUI() {
    document.getElementById('currentLoss').textContent = (currentLoss>0 ? "-" : "")+toUsd(Math.abs(currentLoss));
    document.getElementById('payForLossBtn').style.display = (currentLoss < 0) ? "inline-block" : "none";
}

window.payForLoss = async function() {
    if (currentLoss >= 0) return alert("No loss to pay for!");
    if (main + currentLoss < 0) return alert("Not enough main to pay for loss.");
    if (!confirm(`Pay ${toUsd(-currentLoss)} from Main to normalize loss?`)) return;
    await update(ref(db,`users/${userWallet}`), {main: main + currentLoss, loss: 0});
    currentLoss = 0; updateLossUI();
};

// PnL log (profit/loss)
function addPnL(pnl, entry, exit, dir, amt, lev) {
    let tpl = {date: (new Date()).toISOString(), pnl, entry, exit, dir, amt, lev};
    let pKey = push(ref(db, `users/${userWallet}/pnl`)).key;
    set(ref(db, `users/${userWallet}/pnl/${pKey}`), tpl).then(loadPnLTable);
    // profit/loss balancing
    let tProfit = Number(totalProfit), tLoss = Number(currentLoss);
    if (pnl > 0)  tProfit += pnl;
    if (pnl < 0)  tLoss += pnl;
    set(ref(db, `users/${userWallet}/totalProfit`), tProfit);
    set(ref(db, `users/${userWallet}/loss`), tLoss);
    updateLossUI();
}
//
function loadPnLTable() {
    const tb = document.getElementById('pnlTableBody');
    get(ref(db, `users/${userWallet}/pnl`)).then(snap=>{
        let arr = [];
        snap.forEach(ch=>{ arr.push(ch.val()); });
        arr.sort((a,b)=>b.date.localeCompare(a.date));
        let out = arr.map(obj=>{
            let d = new Date(obj.date).toISOString().slice(0,16).replace('T',' ');
            let val = (+obj.pnl).toFixed(2), pos = obj.pnl >= 0;
            return `<tr>
<td>${d}</td>
<td class="${pos?'pnl-positive':'pnl-negative'}"><b>${pos?'':'-'}${toUsd(Math.abs(val))}</b></td>
<td>${toUsd(obj.entry)}</td><td>${toUsd(obj.exit)}</td>
<td style="color:${obj.dir=="UP"?"#2ebd85":"#f6465d"};font-weight:700">${obj.dir||"-"}</td>
<td>${toUsd(obj.amt)}</td><td>${obj.lev}x</td>
</tr>`;
        });
        tb.innerHTML = out.length?out.join(''):'<tr><td colspan=7 style="color:#848E9C">No history yet.</td></tr>';
        // accumulate profit/loss for summary
        let prof = 0, los = 0;
        arr.forEach(obj=>{ if(+obj.pnl>0) prof+=+obj.pnl; else los+=+obj.pnl;});
        document.getElementById('totalProfit').textContent = toUsd(prof);
        currentLoss = los;
        updateLossUI();
    });
}
// --- BET LOGIC ---
async function checkAndSettleActiveBet() {
    const betSnap = await get(ref(db, `users/${userWallet}/activeBet`));
    if (betSnap.exists() && betSnap.val() && !betSnap.val().settled) {
        const activeBet = betSnap.val();
        const now = Date.now();
        if (now >= activeBet.scheduledEnd) {
            await settleBetOffline(activeBet);
        }
    }
}
async function settleBetOffline(activeBet) {
    if(!activeBet) return;
    const endTime = Math.ceil(activeBet.scheduledEnd / 60000)*60000;
    const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&endTime=${endTime}&limit=1`;
    let exitPrice = activeBet.entryPrice;
    try {
        const resp = await fetch(url);
        const data = await resp.json();
        if (data && data[0] && data[0][4]) exitPrice = parseFloat(data[0][4]);
    } catch {}
    let wentUp = exitPrice > activeBet.entryPrice ? 1 : exitPrice < activeBet.entryPrice ? -1 : 0;
    let mult = (activeBet.direction === "UP") ? wentUp : -wentUp;
    let pnl = activeBet.betAmount * activeBet.leverage * mult;
    await set(ref(db, `users/${userWallet}/activeBet/settled`), true);
    let newTrading = trading + pnl;
    await set(ref(db, `users/${userWallet}/trading`), newTrading);
    if(pnl!=0) addPnL(pnl, activeBet.entryPrice, exitPrice, activeBet.direction, activeBet.betAmount, activeBet.leverage);
    loadPnLTable();
    updateTabs();
    updateLossUI();
}
window.selectDir = function(dir) {
    if (gameState !== "IDLE") return;
    if (currentLoss < 0) { alert("You must pay for loss first."); return; }
    selectedDirection = dir;
    document.getElementById('upBtn').className = "btn btn-up" + (dir === 'UP' ? ' selected' : '');
    document.getElementById('downBtn').className = "btn btn-down" + (dir === 'DOWN' ? ' selected' : '');
    document.getElementById('startBtn').classList.remove('btn-disabled');
};
window.startBet = function() {
    if (!selectedDirection) return;
    if (currentLoss < 0) { alert("You must pay for loss first."); return; }
    userBetAmount = Math.round(Math.max(1, Math.min(userBetAmount, Math.floor(trading))));
    if (userBetAmount > trading) userBetAmount = trading;
    if (userBetAmount < 1) userBetAmount = 1;
    const entryTimestamp = Date.now();
    const betDuration = 60 * 1000;
    const scheduledEnd = entryTimestamp + betDuration;
    gameState = "ACTIVE";
    setLeverageEnabled(false);
    setAmountEnabled(false);
    entryPrice = btcPrice;
    entryLine = entryPrice;
    document.getElementById('controls').style.display = 'none';
    document.getElementById('comparison').style.display = 'flex';
    document.getElementById('entryPrice').textContent = toUsd(entryPrice);
    document.getElementById('livePrice').textContent = toUsd(btcPrice);
    document.getElementById('liveDiff').textContent = '--';
    chart.update();
    set(ref(db, `users/${userWallet}/activeBet`), {
        entryPrice,
        entryTimestamp,
        scheduledEnd,
        direction: selectedDirection,
        leverage: userLeverage,
        betAmount: userBetAmount,
        settled: false
    });
    timerValue = 60;
    updateTimerBar(1);
    showTimerBar(true);
    document.getElementById('timer').style.display = "none";
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timerValue--;
        updateTimerBar(timerValue/60);
        if (timerValue <= 0) {
            clearInterval(timerInterval);
            endBet();
        }
    }, 1000);
};
function endBet() {
    let fallBackPrice = btcPrice || entryPrice;
    let exitPrice = fallBackPrice;
    let wentUp = exitPrice > entryPrice ? 1 : exitPrice < entryPrice ? -1 : 0;
    let mult = (selectedDirection === "UP") ? wentUp : -wentUp;
    let pnl = userBetAmount * userLeverage * mult;
    set(ref(db, `users/${userWallet}/activeBet/settled`), true);
    let newTrading = trading + pnl;
    set(ref(db, `users/${userWallet}/trading`), newTrading);
    if(pnl!=0) addPnL(pnl, entryPrice, exitPrice, selectedDirection, userBetAmount, userLeverage);
    setTimeout(() => {
        entryLine = null; gameState = "IDLE"; setLeverageEnabled(true); setAmountEnabled(true);
        document.getElementById('controls').style.display = 'block';
        document.getElementById('comparison').style.display = 'none';
        document.getElementById('startBtn').classList.add('btn-disabled');
        document.getElementById('upBtn').className = "btn btn-up";
        document.getElementById('downBtn').className = "btn btn-down";
        selectedDirection = null;
        chart.update();
        updateTabs();
        updateLossUI();
        showTimerBar(false); updateAmountSlider();
        loadPnLTable();
    }, 1600);
}

// --- Price / Chart
async function fetchPrice() {
    try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await res.json();
        btcPrice = parseFloat(data.price);
    } catch { btcPrice = btcPrice }
    document.getElementById('btc-price').textContent = toUsd(btcPrice);
    if (gameState === "ACTIVE") {
        document.getElementById('livePrice').textContent = toUsd(btcPrice);
        let wentUp = btcPrice > entryPrice ? 1 : btcPrice < entryPrice ? -1 : 0;
        let diff = (selectedDirection === "UP" ? wentUp : -wentUp);
        let pnl = userBetAmount * userLeverage * diff;
        document.getElementById('liveDiff').textContent = (pnl >= 0 ? "+" : "-") + Math.abs(pnl).toFixed(2);
        document.getElementById('liveDiff').style.color = pnl >= 0 ? "#2ebd85" : "#f6465d";
    }
}
setInterval(fetchPrice, 2000);

// Chart.js setup with signal candle
const ctx = document.getElementById('btcChart').getContext('2d');
let priceHistory = [];
let dottedLinePlugin = {
    id: 'dottedLine',
    afterDraw: function(chart) {
        if (entryLine !== null) {
            let y = chart.scales['y'].getPixelForValue(entryLine);
            let ctx = chart.ctx;
            ctx.save();
            ctx.setLineDash([4,4]);
            ctx.beginPath();
            ctx.moveTo(chart.chartArea.left, y);
            ctx.strokeStyle = "#fedd45";
            ctx.lineWidth = 2;
            ctx.lineTo(chart.chartArea.right, y);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.restore();
        }
    }
};
let signalCandlePlugin = {
    id: 'signalCandle10s',
    afterDraw: function(chart) {
        if (entryLine === null) return;
        const lastPrice = chart.data.datasets[0].data.slice(-1)[0];
        if (typeof lastPrice !== 'number') return;
        let color = (lastPrice > entryLine) ? "#2ebd85" : (lastPrice < entryLine) ? "#f6465d" : "#fcd535";
        let ctx = chart.ctx;
        let x = chart.scales.x.getPixelForValue(chart.data.labels.length-1);
        let yTop = chart.scales.y.getPixelForValue(Math.max(lastPrice, entryLine));
        let yBot = chart.scales.y.getPixelForValue(Math.min(lastPrice, entryLine));
        let barWidth = 10;
        ctx.save();
        ctx.globalAlpha = 0.85;
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.fillRect(x-barWidth/2, yTop, barWidth, yBot-yTop || 2.5);
        ctx.strokeStyle = "#181a20";
        ctx.lineWidth = 1;
        ctx.strokeRect(x-barWidth/2, yTop, barWidth, yBot-yTop || 2.5);
        ctx.restore();
    }
};
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: Array(20).fill(''),
        datasets: [{
            data: priceHistory, borderColor: '#FCD535', tension: 0.4, pointRadius: 0, borderWidth: 1.4, fill:false
        }]
    },
    options: {
        animation: false,
        scales: { x: { display: false }, y: { display: false } },
        plugins: { legend: { display: false } }
    },
    plugins: [dottedLinePlugin, signalCandlePlugin]
});
setInterval(() => {
    priceHistory.push(btcPrice);
    if (priceHistory.length > 20) priceHistory.shift();
    chart.data.datasets[0].data = priceHistory.slice();
    chart.update();
}, 3000);
setInterval(() => { chart.update(); }, 10000);

function showTimerBar(show) { document.getElementById('timerBarContainer').style.display = show?'block':'none'; }
function updateTimerBar(percent) { document.getElementById('timerBar').style.width = (percent*100).toFixed(2)+'%'; }

window.addEventListener('beforeunload', function (e) {
    if (gameState === "ACTIVE") {
        e.preventDefault();
        e.returnValue = 'You have an active bet. It will auto-resolve even if you close this page.';
    }
});
</script>
</body>
</html>
