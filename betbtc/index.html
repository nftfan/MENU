<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC Pro: Bank, Life, Trading (M/B/T, items per user)</title>
<meta name="viewport" content="width=420, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background: #0B0E11; color: #EAECEF; margin:0; padding:7px; font-size:9px;}
.container { max-width: 370px; margin: auto; background: #181A20; border-radius: 11px; padding: 10px; box-shadow: 0 4px 14px rgba(0,0,0,0.4);}
h1 { font-size: 11px; text-align: center; color: #FCD535; margin-bottom: 4px; font-weight:bold; }
.tabs { display: flex; gap: 2px; margin-bottom: 7px; border-bottom: 1px solid #333; }
.tab { flex: 1; padding: 6px; text-align: center; cursor: pointer; color: #848E9C; font-weight:bold; font-size: 9px;}
.tab.active { color: #FCD535; border-bottom: 2px solid #FCD535;}
.bold-balance { font-size:16px; font-weight:900; letter-spacing:1px; color:#2ebd85; display:inline-block;}
.card-bank {border-radius:13px;background:linear-gradient(120deg,#FCD53533 0%,#242731 100%); box-shadow:0 2px 10px #0004; display:flex;flex-direction:column;align-items:center; margin-bottom:9px;padding:11px;}
.card-bank .material-icons {font-size:28px;color:#2ebd85;margin-bottom:4px;}
.card-bank-title {color:#FCD535;font-size:10px;font-weight:bold;margin-left:2px;}
#bank-limits {font-size:8.5px;color:#eee; margin-bottom:2px;}
.bank-transfers {margin-bottom:7px;}
.bank-transfer-row {margin-top:2px;margin-bottom:2px;display:flex;align-items:center;justify-content:center;}
.input-funds { width:60px; font-size:9px; border-radius:4px; padding:2.5px 2px;border:1px solid #333; background:#1e2329; color:#FCD535;}
.max-btn { background: #23262f; color:#FCD535; border:none; border-radius:2px; font-weight:bold; font-size:8.5px; padding:2px 6px; margin:0 2px; cursor:pointer;}
.btn { border: none; border-radius: 3px; padding: 6px 9px; font-weight: bold; cursor: pointer; width: unset; font-size: 9px; transition: 0.17s;}
.btn-connect { background: #FCD535; color: #000;}
.btn-up { background: #2ebd85; color: white;}
.btn-down { background: #f6465d; color: white;}
.btn-buy {background:#5ca6ef;color:#fff;}
.btn-disabled { opacity: 0.3; pointer-events: none;}
.grid-life {display:grid; grid-template-columns:repeat(2,1fr); gap:7px; margin-bottom:7px;}
.grid-life .item-card {background:#21262d; border-radius:7px; padding:10px 5px 6px 5px; text-align:center;position:relative;}
.grid-life .item-name {font-size:8.7px;font-weight:bold;margin-bottom:2px; color:#FCD535;}
.grid-life .material-icons {font-size:25px;margin-bottom:2px;}
.grid-life .item-price {font-size:8.2px; color:#2ebd85;margin:1px;}
.grid-life .btn-buy, .grid-life .btn-own {font-size:8.2px;}
.grid-life .btn-own { background: #333; color: #aaa; cursor:default;}
.grid-life .btn-buy {padding:4px 6px; margin-top:1.5px;}
.stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; margin-bottom: 7px; }
.stat-card { background: #22252b; padding: 7px; border-radius: 6px; text-align: center; }
.stat-label { font-size: 8px; color: #848E9C; text-transform: uppercase;}
.stat-value { font-size: 10px; font-weight:bold; display:block; margin-top: 3px;}
#btc-price { font-size: 12px; font-weight:bold; text-align:center; margin:7px 0; color:#FCD535;}
.comparison-bar { display: flex; justify-content: space-between; background: #1e2329; padding: 7px; border-radius: 6px; margin: 7px 0; border: 1px solid #333; font-size:9px;}
.comp-item { flex: 1; text-align: center;}
.comp-label { font-size: 8px; color: #848E9C; display: block;}
.comp-val { font-size: 9px; font-weight: bold; font-family: monospace;}
.stats-box {background:#181a20;padding:7px 5px;margin-bottom:5px;}
#controls {margin-bottom:5px;}
.btn-row { display: flex; gap: 8px; width:100%; margin-bottom:5px;}
.slider-value { color:#FCD535;font-weight:bold;font-size:9px;min-width:22px;display:inline-block;text-align:right;}
.leverage-row, .amount-row { display: flex; align-items: center; margin-bottom: 4px; justify-content: space-between; }
.leverage-label, .amount-label { font-size:9px; color:#FCD535; }
#leverageSlider, #amountSlider { width: 60%; margin-left: 4px; margin-right:4px; }
#leverageSlider:disabled, #amountSlider:disabled { opacity:0.4;}
#betAmountSummary { font-size:8.3px;color:#FCD535; margin-bottom: 3px;}
#tradeUpDown {font-size:10px; font-weight:bold;margin-top:2px;margin-bottom:2px;}
#tradeUpDown .material-icons{font-size:16px;vertical-align:bottom;}
#timerBarContainer { width:100%; height: 15px; background:#23262f; border-radius:7px; overflow:hidden; margin-bottom:3px; position:relative;}
#timerBar { height:100%; background:linear-gradient(90deg,#FCD535 0,#fcb535 100%); transition:width 1s linear;}
#timeRemainText { position:absolute; left:50%; top:1.5px; transform:translateX(-50%); font-size:9.7px; color:#23262f; font-weight:bold; pointer-events:none; line-height:1;}
.reward-info { font-size:7.5px; color:#848E9C; background:#1e2329; padding:7px; border-radius:5px; margin-top:9px; border-left: 2px solid #FCD535;}
</style>
</head>
<body>
<div class="container">
    <h1>BTC TRADER PRO</h1>
    <div id="auth-section">
        <button id="connectBtn" class="btn btn-connect"><span class="material-icons" style="font-size:13px;vertical-align:-2px">account_balance_wallet</span> CONNECT</button>
    </div>
    <div id="app-content" style="display:none;">
        <div class="tabs">
            <div id="tab-bank" class="tab active" onclick="switchTab('bank')">BANK ACC</div>
            <div id="tab-life" class="tab" onclick="switchTab('life')">MY LIFE</div>
            <div id="tab-trade" class="tab" onclick="switchTab('trade')">TRADE</div>
        </div>
        <!-- BANK TAB -->
        <div id="view-bank">
            <div class="card-bank">
                <span class="material-icons" style="font-size:32px;">account_balance</span>
                <span class="card-bank-title">BANK ACCOUNT</span>
                <span class="bold-balance" id="bankBalance">$1,000,000</span>
                <div id="bank-limits">Top-up every 15 days | Cannot exceed $1,000,000</div>
            </div>
            <div class="bank-transfers">
                <div class="bank-transfer-row">
                    <input class="input-funds" id="mainToBankInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1" step="1">
                    <button class="max-btn" onclick="setMax('mainToBank')">MAX</button>
                    <button class="btn btn-connect" onclick="moveBalance('main','bank')" style="margin-left:3px;">
                      <span class="material-icons" style="font-size:10px;vertical-align:-2.5px;margin-right:1px;">trending_up</span>Main➔Bank
                    </button>
                </div>
                <div class="bank-transfer-row">
                    <input class="input-funds" id="bankToMainInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1" step="1">
                    <button class="max-btn" onclick="setMax('bankToMain')">MAX</button>
                    <button class="btn btn-connect" onclick="moveBalance('bank','main')" style="margin-left:3px;">
                        <span class="material-icons" style="font-size:10px;vertical-align:-2.5px;margin-right:1px;">trending_down</span>Bank➔Main
                    </button>
                </div>
                <div class="bank-transfer-row">
                    <input class="input-funds" id="mainToTradingInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1" step="1">
                    <button class="max-btn" onclick="setMax('mainToTrading')">MAX</button>
                    <button class="btn btn-up" onclick="moveBalance('main','trading')" style="margin-left:3px;">
                        <span class="material-icons" style="font-size:10px;vertical-align:-2.5px;margin-right:1px;">swap_horiz</span>Main➔Trade
                    </button>
                </div>
                <div class="bank-transfer-row">
                    <input class="input-funds" id="tradingToMainInput" pattern="[0-9]*" inputmode="numeric" type="number" min="1" step="1">
                    <button class="max-btn" onclick="setMax('tradingToMain')">MAX</button>
                    <button class="btn btn-down" onclick="moveBalance('trading','main')" style="margin-left:3px;">
                        <span class="material-icons" style="font-size:10px;vertical-align:-2.5px;margin-right:1px;">swap_horiz</span>Trade➔Main
                    </button>
                </div>
            </div>
            <div class="stats-grid" style="margin-bottom:0;">
                <div class="stat-card">
                    <span class="stat-label">MAIN</span>
                    <span id="userMain" class="stat-value">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">TRADING</span>
                    <span id="userTrading" class="stat-value">$0.00</span>
                </div>
            </div>
        </div>
        <!-- LIFE TAB -->
        <div id="view-life" style="display:none;">
            <div style="font-size:9px;color:#FCD535;font-weight:bold;text-align:center;margin:4px 0;">
                What could you buy? Show off your "owns"! <span class="material-icons" style="font-size:13px;vertical-align:-2.5px;">star</span>
            </div>
            <div class="grid-life" id="lifeGrid"></div>
        </div>
        <!-- TRADE TAB -->
        <div id="view-trade" style="display:none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-label">TRADING</span>
                    <span id="balanceUSD" class="stat-value">$0.00</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">MAIN</span>
                    <span id="userMain2" class="stat-value" style="color:#fff">$0.00</span>
                </div>
            </div>
            <div class="stats-box">
                <div id="btc-price">--.---</div>
                <canvas id="btcChart" width="340" height="55"></canvas>
                <div id="comparison" class="comparison-bar" style="display:none;">
                    <div class="comp-item"><span class="comp-label">Entry</span><span id="entryPrice" class="comp-val">--</span></div>
                    <div class="comp-item"><span class="comp-label">Live</span><span id="livePrice" class="comp-val">--</span></div>
                    <div class="comp-item"><span class="comp-label">PnL</span><span id="liveDiff" class="comp-val">--</span></div>
                </div>
                <div class="amount-row">
                    <span class="amount-label">Bet:</span>
                    <input type="range" min="1" max="100" value="10" id="amountSlider" oninput="onBetAmountSet(this.value)">
                    <span id="amountValue" class="slider-value">10</span>
                </div>
                <div id="betAmountSummary">(Bal after: <span id="betAmountRemain">$0.00</span>)</div>
                <div class="leverage-row">
                    <span class="leverage-label">Lev:</span>
                    <input type="range" min="0" max="500" value="1" id="leverageSlider" oninput="onLeverageSet(this.value)">
                    <span id="leverageValue" class="slider-value">1x</span>
                </div>
            </div>
            <div id="tradeUpDown"></div>
            <div id="timerBarContainer" style="display:none;">
                <div id="timerBar"></div>
                <span id="timeRemainText"></span>
            </div>
            <div id="timer" style="display:none;"></div>
            <div id="controls">
                <div class="btn-row">
                    <button id="upBtn" class="btn btn-up" onclick="selectDir('UP')"><span class="material-icons" style="font-size:14px;vertical-align:-2px;">arrow_upward</span>UP</button>
                    <button id="downBtn" class="btn btn-down" onclick="selectDir('DOWN')"><span class="material-icons" style="font-size:14px;vertical-align:-2px;">arrow_downward</span>DOWN</button>
                </div>
                <button id="startBtn" class="btn btn-connect btn-disabled" style="margin-top:5px;" onclick="startBet()">CONFIRM</button>
            </div>
        </div>
    </div>
    <div class="reward-info">
        <span class="material-icons" style="font-size:11px;vertical-align:-2.5px;">info</span> $1,000,000 bank, refilled every 15 days.<br>
        Move money between all wallets (bank, main, trading). <br>
        Buy luxury demo items ("My Life") are permanently remembered in your account. All balances formatted M, B, T!
    </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, onValue, set, update, push, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
const firebaseConfig = {
  apiKey: "AIzaSyA6w6auszWRniQfZCjb4nXE_bq9Mzt9dOs",
  authDomain: "betbtc-6d881.firebaseapp.com",
  databaseURL: "https://betbtc-6d881-default-rtdb.firebaseio.com",
  projectId: "betbtc-6d881",
  storageBucket: "betbtc-6d881.firebasestorage.app",
  messagingSenderId: "962176232122",
  appId: "1:962176232122:web:a277d922543c3378033083",
  measurementId: "G-V4XNB7K1E0"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
function toScaled(n) {
    n = +n;
    if (n >= 1_000_000_000_000) return (n/1_000_000_000_000).toFixed(2).replace(/\.00$/,"")+'T';
    if (n >= 1_000_000_000)    return (n/1_000_000_000).toFixed(2).replace(/\.00$/,"")+'B';
    if (n >= 1_000_000)        return (n/1_000_000).toFixed(2).replace(/\.00$/,"")+'M';
    return "$" + n.toLocaleString("en",{minimumFractionDigits:2});
}
function toUsd(x) {
    x=+x;
    return toScaled(x) || "$0";
}
function demoItems() {
    let icons = ["villa","directions_car","diamond","sailing","flight","image","house","commute","bolt","sports_esports","camera","phone_iphone","saving","emoji_events","music_note","watch","stadium","pool","local_cafe","skateboarding"];
    let names = [
        "Luxury Villa", "Lamborghini", "Rare Diamond", "Super Yacht", "Private Jet", "Mona Lisa NFT", "Dream Home", "Hypercar", "Electric City", "Pro Gaming Setup", "DSLR Camera", "iPhone X", "Swiss Bank Vault", "Olympic Medal", "Grand Piano", "Rolex Watch", "Sports Stadium", "Infinity Pool", "Celebrity Coffee", "Pro Skateboard"
    ];
    let items = [];
    for (let i = 0; i < 20; ++i) {
        let price = 1000000 + Math.round((99000000 * i) / 19); // spreads 1M to 100M evenly
        items.push({ k: "i" + i, n: names[i], p: price, icon: icons[i % icons.length] });
    }
    return items;
}
let userWallet = null, main = 0, trading = 0, bank = 1000000, btcPrice = 0, bankDate = "";
let gameState = "IDLE", selectedDirection = null, entryPrice = 0, userLeverage = 1, userBetAmount = 10, entryLine = null, timerInterval = null, timerValue=0, myItems={};
function switchTab(tab) {
    document.getElementById('view-bank').style.display = tab==="bank"?"block":"none";
    document.getElementById('view-life').style.display = tab==="life"?"block":"none";
    document.getElementById('view-trade').style.display = tab==="trade"?"block":"none";
    document.getElementById('tab-bank').className = "tab" + (tab=='bank'?' active':'');
    document.getElementById('tab-life').className = "tab" + (tab=='life'?' active':'');
    document.getElementById('tab-trade').className = "tab" + (tab=='trade'?' active':'');
    if(tab==="life") drawLifeTab();
}
window.switchTab = switchTab;
document.getElementById('connectBtn').onclick = async () => {
    if (window.ethereum) {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userWallet = accounts[0].toLowerCase();
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        initUser();
    } else { alert("Install MetaMask"); }
};
function setMax(which) {
    if(which==='mainToBank') document.getElementById('mainToBankInput').value = main;
    else if(which==='bankToMain') document.getElementById('bankToMainInput').value = bank;
    else if(which==='mainToTrading') document.getElementById('mainToTradingInput').value = main;
    else if(which==='tradingToMain') document.getElementById('tradingToMainInput').value = trading;
}
window.setMax = setMax;
function checkAndRefillBankIfNeeded(node) {
    let now = new Date();
    now.setHours(0,0,0,0);
    let bankDateS = node?.bankDate || "";
    let last = bankDateS ? new Date(bankDateS) : new Date(0);
    last.setHours(0,0,0,0);
    const ms15d = 15*24*3600*1000;
    let nextTopup = new Date(last.getTime()+ms15d);
    document.getElementById('bank-limits').textContent = "Top-up every 15 days | Next: "+nextTopup.toISOString().slice(0,10);
    let toUpdate = {};
    if(now >= nextTopup){
        toUpdate.bank = 1000000;
        toUpdate.bankDate = now.toISOString().slice(0,10);
    }
    if(Object.keys(toUpdate).length) update(ref(db,`users/${userWallet}`), toUpdate);
}
function initUser() {
    onValue(ref(db, `users/${userWallet}`), snap => {
        let node = snap.val()||{};
        main = Number(node?.main)||0;
        trading = Number(node?.trading)||0;
        bank = typeof node?.bank === "number" ? node.bank : 1000000;
        bankDate = node?.bankDate||"";
        myItems = node?.myItems||{};
        document.getElementById('userMain').textContent = toUsd(main);
        document.getElementById('userTrading').textContent = toUsd(trading);
        document.getElementById('balanceUSD').textContent = toUsd(trading);
        document.getElementById('userMain2').textContent = toUsd(main);
        document.getElementById('bankBalance').textContent = toUsd(bank);
        document.getElementById('mainToBankInput').max=main;
        document.getElementById('bankToMainInput').max=bank;
        document.getElementById('mainToTradingInput').max=main;
        document.getElementById('tradingToMainInput').max=trading;
        updateAmountSlider();
        drawLifeTab();
    });
    checkAndSettleActiveBet();
}
window.moveBalance = async function(from,to) {
    let inputId, amt, u = {};
    if (from==='bank' && to==='main') inputId = "bankToMainInput";
    else if (from==='main' && to==='bank') inputId = "mainToBankInput";
    else if (from==='main' && to==='trading') inputId = "mainToTradingInput";
    else if (from==='trading' && to==='main') inputId = "tradingToMainInput";
    else return;
    amt = parseFloat(document.getElementById(inputId).value);
    if(!amt || amt <= 0) {alert("Enter a valid amount."); return;}
    if(from==='bank' && amt>bank) { alert("Insufficient bank funds."); return;}
    if(from==='main' && amt>main) { alert("Insufficient main funds."); return;}
    if(from==='trading' && amt>trading) { alert("Insufficient trading funds."); return;}
    if(from==='bank') { u['bank'] = bank-amt; u['main'] = main+amt;}
    if(from==='main' && to==='bank') { u['main']=main-amt; u['bank']=bank+amt; }
    if(from==='main' && to==='trading') { u['main']=main-amt; u['trading']=trading+amt; }
    if(from==='trading' && to==='main') { u['trading']=trading-amt; u['main']=main+amt; }
    await update(ref(db,`users/${userWallet}`), u);
    document.getElementById(inputId).value = '';
    if(from==='bank') document.getElementById('bankBalance').textContent = toUsd(bank-amt);
    if(from==='main' && to==='bank') document.getElementById('bankBalance').textContent = toUsd(bank+amt);
};
function drawLifeTab() {
    let grid = document.getElementById("lifeGrid");
    let items = demoItems();
    grid.innerHTML="";
    items.forEach(it=>{
        let own = (myItems&&(myItems[it.k]));
        grid.innerHTML += `<div class="item-card">
            <span class="material-icons">${it.icon}</span>
            <div class="item-name">${it.n}</div>
            <div class="item-price">${toUsd(it.p)}</div>
            ${own?('<button class="btn btn-own" disabled>Own <span class="material-icons" style="font-size:11px;vertical-align:-2px;">check</span></button>')
                :(`<button class="btn btn-buy" onclick="buyItem('${it.k}')">Buy <span class="material-icons" style="font-size:11px;vertical-align:-2px;">shopping_cart</span></button>`)}
        </div>`;
    });
}
window.buyItem= async function(k) {
    let items = demoItems();
    let item = items.find(x=>x.k===k);
    if(!item) return;
    if(bank<item.p) { alert("Insufficient bank account balance!"); return; }
    let snapshot = await get(ref(db,`users/${userWallet}/myItems`));
    let ni = (snapshot.exists() ? snapshot.val() : {});
    ni = ni || {};
    ni[k] = true;
    await update(ref(db,`users/${userWallet}`), {bank: bank-item.p, myItems:ni});
};
window.onLeverageSet = function(val) {
    if(gameState==="ACTIVE") return;
    userLeverage = parseInt(val);
    document.getElementById('leverageValue').textContent = userLeverage+'x';
};
window.onBetAmountSet = function(val) {
    if(gameState==="ACTIVE") return;
    userBetAmount = Math.round(Math.min(Math.max(1, +val), Math.max(1, Math.floor(trading))));
    document.getElementById('amountValue').textContent = userBetAmount;
    let futureBalance = trading - userBetAmount;
    document.getElementById('betAmountRemain').textContent = toUsd(futureBalance);
};
function setLeverageEnabled(enable) {
    document.getElementById('leverageSlider').disabled = !enable;
}
function setAmountEnabled(enable) {
    document.getElementById('amountSlider').disabled = !enable;
}
function updateAmountSlider() {
    let amountSlider = document.getElementById('amountSlider');
    amountSlider.min = "1"; amountSlider.max = Math.max("1", trading<1 ? 1 : Math.floor(trading));
    userBetAmount = Math.max(1, Math.min(userBetAmount, Math.floor(amountSlider.max)));
    amountSlider.value = userBetAmount;
    document.getElementById('amountValue').textContent = userBetAmount;
    let futureBalance = trading - userBetAmount;
    document.getElementById('betAmountRemain').textContent = toUsd(futureBalance);
}
window.selectDir = function(dir) {
    if (gameState !== "IDLE") return;
    selectedDirection = dir;
    document.getElementById('tradeUpDown').innerHTML = (
        dir==="UP"?'<span class="material-icons" style="color:#2ebd85;vertical-align:-2px;font-size:14px;">arrow_upward</span> <b style="color:#2ebd85">UP</b>' : 
        '<span class="material-icons" style="color:#f6465d;vertical-align:-2px;font-size:14px;">arrow_downward</span> <b style="color:#f6465d">DOWN</b>'
    ) + " selected";
    document.getElementById('upBtn').className = "btn btn-up" + (dir === 'UP' ? ' selected' : '');
    document.getElementById('downBtn').className = "btn btn-down" + (dir === 'DOWN' ? ' selected' : '');
    document.getElementById('startBtn').classList.remove('btn-disabled');
};
let betTimeAll = 60;
window.startBet = function() {
    if (!selectedDirection) return;
    userBetAmount = Math.round(Math.max(1, Math.min(userBetAmount, Math.floor(trading))));
    if (userBetAmount > trading) userBetAmount = trading;
    if (userBetAmount < 1) userBetAmount = 1;
    const entryTimestamp = Date.now();
    const betDuration = betTimeAll * 1000;
    const scheduledEnd = entryTimestamp + betDuration;
    gameState = "ACTIVE";
    setLeverageEnabled(false); setAmountEnabled(false);
    entryPrice = btcPrice; entryLine = entryPrice;
    document.getElementById('controls').style.display = 'none';
    document.getElementById('comparison').style.display = 'flex';
    document.getElementById('entryPrice').textContent = toUsd(entryPrice);
    document.getElementById('livePrice').textContent = toUsd(btcPrice);
    document.getElementById('liveDiff').textContent = '--';
    document.getElementById('tradeUpDown').innerHTML = (
        selectedDirection==="UP"?'<span class="material-icons" style="color:#2ebd85;vertical-align:-2px;font-size:14px;">arrow_upward</span> <b style="color:#2ebd85">UP</b>' : 
        '<span class="material-icons" style="color:#f6465d;vertical-align:-2px;font-size:14px;">arrow_downward</span> <b style="color:#f6465d">DOWN</b>'
    ) + " selected";
    chart.update();
    set(ref(db, `users/${userWallet}/activeBet`), {
        entryPrice, entryTimestamp,scheduledEnd,direction: selectedDirection,leverage: userLeverage,betAmount: userBetAmount,settled: false
    });
    timerValue = betTimeAll;
    updateTimerBar(1);
    setTimeRemainText(timerValue);
    showTimerBar(true);
    document.getElementById('timer').style.display = "none";
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
        timerValue--;
        updateTimerBar(timerValue/betTimeAll);
        setTimeRemainText(timerValue);
        if (timerValue <= 0) { clearInterval(timerInterval); endBet();}
    }, 1000);
};
function endBet() {
    let fallBackPrice = btcPrice || entryPrice;
    let exitPrice = fallBackPrice;
    let wentUp = exitPrice > entryPrice ? 1 : exitPrice < entryPrice ? -1 : 0;
    let mult = (selectedDirection === "UP") ? wentUp : -wentUp;
    let pnl = userBetAmount * userLeverage * mult;
    set(ref(db, `users/${userWallet}/activeBet/settled`), true);
    set(ref(db, `users/${userWallet}/trading`), trading + pnl);
    setTimeout(() => {
        entryLine = null; gameState = "IDLE"; setLeverageEnabled(true); setAmountEnabled(true);
        document.getElementById('controls').style.display = 'block';
        document.getElementById('comparison').style.display = 'none';
        document.getElementById('tradeUpDown').innerHTML = "";
        document.getElementById('startBtn').classList.add('btn-disabled');
        document.getElementById('upBtn').className = "btn btn-up";
        document.getElementById('downBtn').className = "btn btn-down";
        selectedDirection = null;
        chart.update(); updateAmountSlider();
        showTimerBar(false);
        setTimeRemainText('');
    }, 1400);
}
function setTimeRemainText(val) {
    let t = document.getElementById('timeRemainText');
    t.innerHTML = (val? (val + "s") : "");
}
async function fetchPrice() {
    try {
        const res = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await res.json();
        btcPrice = parseFloat(data.price);
    } catch { btcPrice = btcPrice }
    document.getElementById('btc-price').textContent = toUsd(btcPrice);
    if (gameState === "ACTIVE") {
        document.getElementById('livePrice').textContent = toUsd(btcPrice);
        let wentUp = btcPrice > entryPrice ? 1 : btcPrice < entryPrice ? -1 : 0;
        let diff = (selectedDirection === "UP" ? wentUp : -wentUp);
        let pnl = userBetAmount * userLeverage * diff;
        document.getElementById('liveDiff').textContent = (pnl >= 0 ? "+" : "-") + Math.abs(pnl).toFixed(2);
        document.getElementById('liveDiff').style.color = pnl >= 0 ? "#2ebd85" : "#f6465d";
    }
}
setInterval(fetchPrice, 2000);
const ctx = document.getElementById('btcChart').getContext('2d');
let priceHistory = [];
let chart = new Chart(ctx, {
    type: 'line',
    data: {labels:Array(20).fill(''),datasets:[{data:priceHistory, borderColor:'#FCD535', tension:.4, pointRadius: 0, borderWidth: 1.1, fill:false}]},
    options: {animation:false,scales:{x:{display:false},y:{display:false}},plugins:{legend:{display:false}}}
});
setInterval(() => {priceHistory.push(btcPrice); if(priceHistory.length>20) priceHistory.shift(); chart.data.datasets[0].data=priceHistory.slice();chart.update();},3000);
function showTimerBar(show) {
    document.getElementById('timerBarContainer').style.display = show?'block':'none';
    document.getElementById('timeRemainText').style.display = show?'block':'none';
}
function updateTimerBar(percent) {
    document.getElementById('timerBar').style.width = ((percent>=0?percent:0)*100).toFixed(2)+'%';
}
async function checkAndSettleActiveBet() {
    const betSnap = await get(ref(db, `users/${userWallet}/activeBet`));
    if (betSnap.exists() && betSnap.val() && !betSnap.val().settled) {
        const activeBet = betSnap.val();
        const now = Date.now();
        if (now >= activeBet.scheduledEnd) { await settleBetOffline(activeBet);}
    }
}
async function settleBetOffline(activeBet) {
    if(!activeBet) return;
    const endTime = Math.ceil(activeBet.scheduledEnd / 60000)*60000;
    const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1m&endTime=${endTime}&limit=1`;
    let exitPrice = activeBet.entryPrice;
    try {const resp = await fetch(url);const data = await resp.json();if (data && data[0] && data[0][4]) exitPrice = parseFloat(data[0][4]);}
    catch {}
    let wentUp = exitPrice > activeBet.entryPrice ? 1 : exitPrice < activeBet.entryPrice ? -1 : 0;
    let mult = (activeBet.direction === "UP") ? wentUp : -wentUp;
    let pnl = activeBet.betAmount * activeBet.leverage * mult;
    set(ref(db, `users/${userWallet}/activeBet/settled`), true);
    set(ref(db, `users/${userWallet}/trading`), trading + pnl);
    updateAmountSlider();
}
window.buyItem = window.buyItem;
window.setMax = setMax;
window.moveBalance = window.moveBalance;
window.selectDir = window.selectDir;
window.startBet = window.startBet;
window.switchTab = window.switchTab;
window.onLeverageSet = window.onLeverageSet;
window.onBetAmountSet = window.onBetAmountSet;
window.addEventListener('beforeunload', function (e) {
    if (gameState === "ACTIVE") { e.preventDefault(); e.returnValue = 'You have an active bet. It will auto-resolve even if you close this page.'; }
});
</script>
</body>
</html>
