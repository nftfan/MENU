<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC 60s Up/Down Bet</title>
<meta name="viewport" content="width=420">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
html, body { font-size: 11px; }
body { font-family: 'Roboto', Arial, sans-serif; background: #181A20; color: #FCFCFC; margin:0; padding:0;}
.container { max-width: 400px; margin: 22px auto; background: #232630; border-radius: 15px;
  box-shadow: 0 3px 24px #0005; padding: 20px 11px 8px 11px }
h1 { text-align:center; font-weight:400; font-size:1.3em; margin-bottom:8px; letter-spacing:.8px;}
#connect-section { text-align:center; margin-bottom:15px;}
#connectBtn {
  background: linear-gradient(90deg,#9c59fd 10%,#52e2bd 90%);
  border:none; color:#fff; padding:9px 19px; font-size:1.08em; border-radius:8px;
  cursor:pointer; font-weight:bold; margin:0 auto 8px auto; display:inline-block;
}
#walletAddress { color:#1dc6d8; background:#10131a; padding:4px 12px; border-radius:7px; font-family: monospace;}
#connected-info { margin:6px 0 9px 0; font-size:11px;}
#disconnectBtn { background: #313539; color: #c1e3fb; border:none; border-radius:7px; font-size:0.95em; padding:3.5px 9px; margin-left:13px; cursor:pointer;}
#approveBtn { background: #11ad38; color:#fff; border:none; border-radius:7px; margin-left:5px; margin-top:3px;
  padding:7px 16px; font-size:1em; cursor:pointer; font-weight:bold; }
#approveBtn:active { filter:brightness(0.97);}
#claimBtn { background: #0091fe; color:#fff; border:none; border-radius:7px; margin-left:5px; margin-top:3px;
  padding:7px 16px; font-size:1em; cursor:pointer; font-weight:bold; }
#claimBtn:active { filter:brightness(0.94);}
#balanceBox { background:#222e3a; border-radius:8px; padding:10px 14px; margin-bottom:9px;
    display:flex; align-items:center; gap:6px; font-size:1em;}
#nftfan_icon { font-size:20px; color:#00C48C }
#usd_icon { font-size:18px; color:#1EC4EE }
#btc-price { font-size: 1.18em; font-weight: 600; padding: 4px 8px; border-radius:6px; margin-left:3px; }
.price-rise { background: #294a26; color: #82fa6d;}
.price-fall { background: #492627; color: #f98e9a;}

/* New Live Comparison Stats */
.comparison-bar {
  display: flex; justify-content: space-between; background: #1a1e26;
  padding: 8px; border-radius: 6px; margin: 8px 0; border: 1px solid #2d3446;
}
.comp-item { display: flex; flex-direction: column; align-items: center; flex: 1; }
.comp-label { color: #707a8a; font-size: 10px; margin-bottom: 2px; text-transform: uppercase; }
.comp-val { font-weight: bold; font-family: monospace; font-size: 11px; }
.diff-pos { color: #00F067; }
.diff-neg { color: #E54166; }

#betBox, #resultBox { background: #222b36; border-radius:8px; padding:11px; margin: 7px 0; box-shadow:0 1px 5px #0001 }
.row { margin: 7px 0 8px 0;}
input[type=number] { width:6em;background:#222b29;color:#fff;border:1px solid #37415a;
  border-radius:3px;font-size:1em;outline:none;padding:2px 5px;}
button {
  border: none; border-radius: 7px; padding:7px 16px; font-size:1em; margin:0 5px 0 0;
  background: linear-gradient(to right, #0081CF 70%, #00D4A1 100%);
  color: #fff; box-shadow: 0 2.5px 9px #11efc22b; font-weight:500;
  cursor: pointer; transition:transform 0.13s, background 0.14s,box-shadow 0.13s;}
button:active { transform: scale(0.96);}
.disable { opacity:0.38; pointer-events:none;}
#timer { font-weight: 700; color:#6af; font-size:1.08em; letter-spacing:.9px; text-align:center; margin: 5px 0;}
#btc_chart { margin:8px 0 2px 0; background: #21273F; border-radius: 10px;
  border:1px solid #20223a; box-shadow:0 2px 6px #00fffc0e; }
.material-icons {vertical-align:middle;}
#betUpBtn, #betDownBtn { min-width: 68px; margin-top:2px; outline:none;}
#betUpBtn {background: linear-gradient(to right,#00F067 60%, #0081CF 100%)}
#betDownBtn {background: linear-gradient(to right, #E54166 70%, #5856D6 100%);}
.selected-btn {
  box-shadow: 0 0 0 2.2px #fff9, 0 0 10px 2px #00ffe160, 0 2px 4px #0507;
  filter: brightness(1.13); border-radius:7px; outline:2px solid #45eeedda;
}
#msg { font-size: 10px; margin-top: 5px; text-align: center; }
#msg.success { color:#37e18c;}
#msg.fail { color:#ffa48d;}
#approval-note { font-size: 10px; color: #fca311; text-align: center; margin-bottom: 5px; }
#resultBox { transition: background .17s;}
#resultBox.win { background: #25683D;}
#resultBox.lose { background: #612828;}
#betBox label { font-weight:400;color:#95d2fd; }
#instructions {
  background:#1b222c; border-radius: 6px; color:#bde2ee;
  font-size:10px; margin:12px 0 4px 0; padding:6.7px 9px 6px 12px; line-height:1.35em;
  border-left:3px solid #00c4b2; box-shadow: 0 1.5px 6px #00fffc08;}
ul#instructions_list {margin:.25em 0 .1em 1.1em; padding:0 0 0 10px;}
ul#instructions_list li {margin-bottom:2.1px;}
</style>
</head>
<body>
<div class="container">
  <div id="connect-section">
    <button id="connectBtn"><span class="material-icons" style="font-size:14px;">travel_explore</span> Connect Wallet</button>
    <div id="walletBox" style="display:none;">
      <span id="walletAddress"></span>
      <button id="disconnectBtn">Disconnect</button>
      <div id="connected-info">Polygon Network<br/>
        <span style="font-size:10px;color:#6fdaed;"><b>Bet Contract:</b>
          <a href="https://polygonscan.com/address/0xc2E45bc197C490c5bdf067F75482671C2cf65F0a" target="_blank" style="color:#6fdaed;text-decoration:underline;">0xc2E4...5F0a</a></span>
      </div>
    </div>
  </div>

  <div id="balanceBox">
    <span id="nftfan_icon" class="material-icons">token</span>
    <span id="nftfan_balance">-</span> T (NFTFAN)
    &nbsp; <span id="usd_icon" class="material-icons">attach_money</span>
    <span id="nftfan_usd">-</span>
    <button id="approveBtn" style="display:none;">Approve NFTFAN</button>
    <button id="claimBtn" style="display:none;">Claim Win</button>
  </div>

  <h1>
    <span class="material-icons" style="color:#FCA311; font-size:19px;">show_chart</span>
    BTC 60s Up/Down Bet
  </h1>

  <div style="margin:4px 0 4px 0; text-align: center;">
    <span class="material-icons" style="color:#FCA311; font-size:19px;">currency_bitcoin</span>
    <span id="btc-price">-----</span>
    <span style="font-size:1em;color:#4de7ed;">USD</span>
  </div>

  <canvas id="btc_chart" width="350" height="95" style="display:none"></canvas>

  <div id="betBox">
    <div id="liveComparison" class="comparison-bar" style="display:none;">
        <div class="comp-item">
            <span class="comp-label">Entry Price</span>
            <span id="entryPriceTab" class="comp-val">--</span>
        </div>
        <div class="comp-item" style="border-left: 1px solid #333; border-right: 1px solid #333;">
            <span class="comp-label">Live Price</span>
            <span id="livePriceTab" class="comp-val">--</span>
        </div>
        <div class="comp-item">
            <span class="comp-label">Difference</span>
            <span id="diffTab" class="comp-val">--</span>
        </div>
    </div>

    <div class="row">
      <label><span class="material-icons" style="font-size:13px;">currency_exchange</span> Bet Amount:</label>
      <input type="number" id="betAmount" min="0.01" step="0.00001" value="1" />
      <span style="font-weight:bold;color:#81ffd5;">T</span>
    </div>

    <div id="approval-note">Wallet not connected.</div>

    <div class="row" style="display:flex;gap:6px;">
      <button id="betUpBtn" type="button"><span class="material-icons" style="font-size:14px;">north</span> UP</button>
      <button id="betDownBtn" type="button"><span class="material-icons" style="font-size:14px;">south</span> DOWN</button>
      <button id="confirmBtn" type="button" disabled style="margin-left:8px;font-weight:bold;">
        <span class="material-icons" style="font-size:15px;">play_arrow</span> BET
      </button>
    </div>
    <div id="msg"></div>
  </div>

  <div id="timer"></div>
  <div id="resultBox" style="display:none"></div>

  <div id="instructions">
    <b>Instructions:</b>
    <ul id="instructions_list">
      <li>Connect wallet & <b>Approve</b> NFTFAN before playing.</li>
      <li>Enter your bet, pick <b style="color:#00F067">UP</b> or <b style="color:#E54166">DOWN</b>, then click <b style="color:#27f;">BET</b>.</li>
      <li>Win <b style="color:#00C48C">+50%</b> if correct, or lose <b style="color:#ee8888">25%</b> of bet.</li>
    </ul>
  </div>
</div>

<script>
// --- Onchain Constants ---
const NFTFAN_ADDR = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
const BETGAME_ADDR = "0xc2E45bc197C490c5bdf067F75482671C2cf65F0a";
const NFTFAN_ABI = [
  "function approve(address,uint256) public returns (bool)",
  "function allowance(address,address) public view returns (uint256)",
  "function balanceOf(address owner) public view returns (uint256)",
  "function decimals() public view returns (uint8)"
];
const BETGAME_ABI = [
  "function takeLoss(uint256 betAmount, bytes32 gameId) external",
  "function claimWin(uint256 betAmount, bytes32 gameId, bytes calldata sig) external",
  "function completedGames(bytes32 gameId) view returns (bool)"
];
const POLYGON_PARAMS = {
  chainId: "0x89",
  chainName: "Polygon Mainnet",
  nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
  rpcUrls: ["https://polygon-rpc.com"],
  blockExplorerUrls: ["https://polygonscan.com/"]
};

let provider, signer, userAccount, nftfanContract, gameContract, nftfanDecimals=18;
let approved = false;
let chart, chartTimer, timerInterval;
let btcPricesLive = [];
let lastBtcPrice = null;
let state = "idle";
let selectedDirection = null;
let bet = {dir:null, amtT:0, priceStart:0, priceEnd:0, gameId:null};

// --- Wallet Functions ---
async function showWallet() {
  if(!signer||!userAccount) return;
  document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+"..."+userAccount.slice(-4);
  document.getElementById('walletBox').style.display = '';
  document.getElementById('connectBtn').style.display = 'none';
  
  nftfanContract = new ethers.Contract(NFTFAN_ADDR, NFTFAN_ABI, signer);
  gameContract = new ethers.Contract(BETGAME_ADDR, BETGAME_ABI, signer);
  
  let rawBal = await nftfanContract.balanceOf(userAccount);
  let humanBal = Number(ethers.utils.formatUnits(rawBal, nftfanDecimals))/1e9;
  document.getElementById('nftfan_balance').textContent = humanBal.toLocaleString(undefined,{maximumFractionDigits:8});
  document.getElementById('nftfan_usd').textContent = "$" + (Number(ethers.utils.formatUnits(rawBal,18)) * 0.00000001).toLocaleString(undefined,{maximumFractionDigits:6});

  // Check Allowance
  let allowance = await nftfanContract.allowance(userAccount, BETGAME_ADDR);
  approved = allowance.gt(0); 
  
  const approveBtn = document.getElementById('approveBtn');
  const confirmBtn = document.getElementById('confirmBtn');
  const note = document.getElementById('approval-note');

  if(approved) {
    approveBtn.style.display = "none";
    note.textContent = "✓ Token Approved";
    note.style.color = "#00F067";
    if(selectedDirection) confirmBtn.disabled = false;
  } else {
    approveBtn.style.display = "";
    note.textContent = "⚠ Please approve NFTFAN to enable betting.";
    note.style.color = "#fca311";
    confirmBtn.disabled = true;
  }
}

async function approveNftfan() {
  if(!signer) return;
  try {
    let amount = ethers.utils.parseUnits("1000000000", nftfanDecimals);
    let tx = await nftfanContract.approve(BETGAME_ADDR, amount);
    document.getElementById('approveBtn').textContent = "Approving...";
    await tx.wait();
    await showWallet();
  } catch(e) { alert("Approval failed: " + e.message); }
  document.getElementById('approveBtn').textContent = "Approve NFTFAN";
}

async function connectWallet() {
  if (!window.ethereum) { alert("MetaMask required!"); return; }
  try {
    await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: POLYGON_PARAMS.chainId }] });
  } catch(e) {
    if (e.code === 4902) await window.ethereum.request({ method: "wallet_addEthereumChain", params: [POLYGON_PARAMS] });
  }
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAccount = await signer.getAddress();
  await showWallet();
}

function disconnectWallet() {
  provider = signer = userAccount = null;
  document.getElementById('walletBox').style.display = 'none';
  document.getElementById('connectBtn').style.display = '';
  document.getElementById('approval-note').textContent = "Wallet not connected.";
}

// --- UI Helpers ---
function showMsg(msg, type) {
  let el = document.getElementById('msg');
  el.className = type||"";
  el.textContent = msg;
}

function clearSelection() {
  document.getElementById('betUpBtn').classList.remove("selected-btn");
  document.getElementById('betDownBtn').classList.remove("selected-btn");
  selectedDirection = null;
  document.getElementById('confirmBtn').disabled = true;
}

document.getElementById('betUpBtn').onclick = function(){
  clearSelection();
  selectedDirection = "up";
  this.classList.add("selected-btn");
  if(approved) document.getElementById('confirmBtn').disabled = false;
};

document.getElementById('betDownBtn').onclick = function(){
  clearSelection();
  selectedDirection = "down";
  this.classList.add("selected-btn");
  if(approved) document.getElementById('confirmBtn').disabled = false;
};

// --- Game Logic ---
async function fetchBTCPrice() {
  try {
    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
    const data = await response.json();
    return parseFloat(data.price);
  } catch (error) { return null; }
}

async function startGame() {
  let amtT = parseFloat(document.getElementById('betAmount').value);
  if(!amtT || amtT<=0) { showMsg("Enter a valid amount", "fail"); return;}
  
  showMsg("Opening position...", "");
  let priceA = await fetchBTCPrice();
  if(!priceA) { showMsg("Price fetch error", "fail"); return; }

  bet = {
    dir: selectedDirection,
    amtT: amtT,
    priceStart: priceA,
    gameId: ethers.utils.id(userAccount + ':' + (+new Date()) + ':' + Math.random())
  };

  state = "waiting";
  document.getElementById('betAmount').disabled = true;
  document.getElementById('confirmBtn').disabled = true;
  document.getElementById('liveComparison').style.display = 'flex';
  document.getElementById('entryPriceTab').textContent = "$" + priceA.toFixed(2);
  document.getElementById('btc_chart').style.display = "block";
  
  btcPricesLive = [{ time: 'Start', price: priceA }];
  drawChart();

  let tRemain = 60;
  timerInterval = setInterval(() => {
    tRemain--;
    document.getElementById('timer').innerHTML = `Time left: <span style='color:#29f;'>${tRemain}s</span>`;
    if(tRemain <= 0) {
      clearInterval(timerInterval);
      clearInterval(chartTimer);
      finishBet();
    }
  }, 1000);

  chartTimer = setInterval(async () => {
    let currentPrice = await fetchBTCPrice();
    if(currentPrice) {
      // Update Tab Stats
      document.getElementById('livePriceTab').textContent = "$" + currentPrice.toFixed(2);
      let diff = currentPrice - bet.priceStart;
      let diffEl = document.getElementById('diffTab');
      diffEl.textContent = (diff >= 0 ? "+" : "") + diff.toFixed(2);
      
      // Dynamic Green/Red coloring
      let isWinning = (bet.dir === 'up' && diff > 0) || (bet.dir === 'down' && diff < 0);
      diffEl.className = "comp-val " + (isWinning ? "diff-pos" : "diff-neg");

      // Update Chart
      btcPricesLive.push({ time: new Date().toLocaleTimeString().slice(-5), price: currentPrice });
      if(btcPricesLive.length > 15) btcPricesLive.shift();
      drawChart();
      animatePriceChange(currentPrice);
    }
  }, 3000);
}

async function finishBet() {
  state = "checking";
  let priceB = await fetchBTCPrice();
  bet.priceEnd = priceB;
  
  let outcome = (bet.dir==='up') ? priceB > bet.priceStart : priceB < bet.priceStart;
  let box = document.getElementById('resultBox');
  box.style.display = "block";
  box.className = outcome ? "win" : "lose";
  
  let betRaw = ethers.utils.parseUnits(String(bet.amtT*1e9), nftfanDecimals-9);

  if(outcome) {
    showMsg("Winner! Claim your 1.5x payout.", "success");
    document.getElementById('claimBtn').style.display = '';
    document.getElementById('claimBtn').onclick = async () => {
        alert("In production, this calls claimWin with a backend signature.");
        document.getElementById('claimBtn').style.display = 'none';
    };
  } else {
    showMsg("Loss. 25% penalty sent on-chain.", "fail");
    try { await gameContract.takeLoss(betRaw, bet.gameId); } catch(e) {}
  }

  box.innerHTML = `<b>${outcome ? 'WIN' : 'LOSE'}</b><br>Start: $${bet.priceStart}<br>End: $${priceB}`;
  
  setTimeout(() => {
    box.style.display = 'none';
    document.getElementById('liveComparison').style.display = 'none';
    document.getElementById('betAmount').disabled = false;
    clearSelection();
    state = "idle";
    showWallet();
  }, 5000);
}

// --- Chart/Visuals ---
function drawChart() {
  let ctx = document.getElementById('btc_chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: btcPricesLive.map(p=>p.time),
      datasets: [{
        data: btcPricesLive.map(p=>p.price),
        borderColor: "#00E0FF",
        backgroundColor: "rgba(30,196,238,0.08)",
        fill: true, tension: 0.3, pointRadius: 2
      }]
    },
    options: { plugins: { legend: { display:false } }, scales: { y: { beginAtZero: false }, x: { display: false } } }
  });
}

function animatePriceChange(newPrice) {
  let el = document.getElementById('btc-price');
  el.classList.remove('price-rise','price-fall');
  if (lastBtcPrice && newPrice > lastBtcPrice) el.classList.add('price-rise');
  else if (lastBtcPrice && newPrice < lastBtcPrice) el.classList.add('price-fall');
  el.textContent = newPrice.toLocaleString();
  lastBtcPrice = newPrice;
}

// --- Listeners ---
document.getElementById('connectBtn').onclick = connectWallet;
document.getElementById('disconnectBtn').onclick = disconnectWallet;
document.getElementById('approveBtn').onclick = approveNftfan;
document.getElementById('confirmBtn').onclick = startGame;

if(window.ethereum) {
  window.ethereum.on('accountsChanged', connectWallet);
  window.ethereum.on('chainChanged', () => window.location.reload());
}
</script>
</body>
</html>
