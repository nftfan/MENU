<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BTC 60s Up/Down Bet</title>
<meta name="viewport" content="width=420">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
html, body { font-size: 11px; }
body { font-family: 'Roboto', Arial, sans-serif; background: #181A20; color: #FCFCFC; margin:0; padding:0;}
.container { max-width: 400px; margin: 22px auto; background: #232630; border-radius: 15px;
  box-shadow: 0 3px 24px #0005; padding: 20px 11px 8px 11px }
h1 { text-align:center; font-weight:400; font-size:1.3em; margin-bottom:8px; letter-spacing:.8px;}
#connect-section { text-align:center; margin-bottom:15px;}
#connectBtn {
  background: linear-gradient(90deg,#9c59fd 10%,#52e2bd 90%);
  border:none; color:#fff; padding:9px 19px; font-size:1.08em; border-radius:8px;
  cursor:pointer; font-weight:bold; margin:0 auto 8px auto; display:inline-block;
}
#walletAddress { color:#1dc6d8; background:#10131a; padding:4px 12px; border-radius:7px; font-family: monospace;}
#connected-info { margin:6px 0 9px 0; font-size:11px;}
#disconnectBtn { background: #313539; color: #c1e3fb; border:none; border-radius:7px; font-size:0.95em; padding:3.5px 9px; margin-left:13px; cursor:pointer;}
#approveBtn { background: #11ad38; color:#fff; border:none; border-radius:7px; margin-left:5px; margin-top:3px;
  padding:7px 16px; font-size:1em; cursor:pointer; font-weight:bold; }
#approveBtn:active { filter:brightness(0.97);}
#claimBtn { background: #0091fe; color:#fff; border:none; border-radius:7px; margin-left:5px; margin-top:3px;
  padding:7px 16px; font-size:1em; cursor:pointer; font-weight:bold; }
#claimBtn:active { filter:brightness(0.94);}
#balanceBox { background:#222e3a; border-radius:8px; padding:10px 14px; margin-bottom:9px;
    display:flex; align-items:center; gap:6px; font-size:1em;}
#nftfan_icon { font-size:20px; color:#00C48C }
#usd_icon { font-size:18px; color:#1EC4EE }
#btc-price { font-size: 1.18em; font-weight: 600; padding: 4px 8px; border-radius:6px; margin-left:3px; }
.price-rise { background: #294a26; color: #82fa6d;}
.price-fall { background: #492627; color: #f98e9a;}
#betBox, #resultBox { background: #222b36; border-radius:8px; padding:11px; margin: 7px 0; box-shadow:0 1px 5px #0001 }
.row { margin: 7px 0 8px 0;}
input[type=number] { width:6em;background:#222b29;color:#fff;border:1px solid #37415a;
  border-radius:3px;font-size:1em;outline:none;padding:2px 5px;}
button {
  border: none; border-radius: 7px; padding:7px 16px; font-size:1em; margin:0 5px 0 0;
  background: linear-gradient(to right, #0081CF 70%, #00D4A1 100%);
  color: #fff; box-shadow: 0 2.5px 9px #11efc22b; font-weight:500;
  cursor: pointer; transition:transform 0.13s, background 0.14s,box-shadow 0.13s;}
button:active { transform: scale(0.96);}
.disable { opacity:0.38; pointer-events:none;}
#timer { font-weight: 700; color:#6af; font-size:1.08em; letter-spacing:.9px;}
#btc_chart { margin:8px 0 2px 0; background: #21273F; border-radius: 10px;
  border:1px solid #20223a; box-shadow:0 2px 6px #00fffc0e; }
.material-icons {vertical-align:middle;}
#betUpBtn, #betDownBtn { min-width: 68px; margin-top:2px; outline:none;}
#betUpBtn {background: linear-gradient(to right,#00F067 60%, #0081CF 100%)}
#betDownBtn {background: linear-gradient(to right, #E54166 70%, #5856D6 100%);}
.selected-btn {
  box-shadow: 0 0 0 2.2px #fff9, 0 0 10px 2px #00ffe160, 0 2px 4px #0507;
  filter: brightness(1.13);
  border-radius:7px;
  outline:2px solid #45eeedda;
}
#msg.success { color:#37e18c;}
#msg.fail { color:#ffa48d;}
#resultBox { transition: background .17s;}
#resultBox.win { background: #25683D;}
#resultBox.lose { background: #612828;}
#betBox label { font-weight:400;color:#95d2fd; }
#instructions {
  background:#1b222c; border-radius: 6px; color:#bde2ee;
  font-size:10px; margin:12px 0 4px 0; padding:6.7px 9px 6px 12px; line-height:1.35em;
  border-left:3px solid #00c4b2; box-shadow: 0 1.5px 6px #00fffc08;}
ul#instructions_list {margin:.25em 0 .1em 1.1em; padding:0 0 0 10px;}
ul#instructions_list li {margin-bottom:2.1px;}
</style>
</head>
<body>
<div class="container">
  <div id="connect-section">
    <button id="connectBtn"><span class="material-icons" style="font-size:14px;">travel_explore</span> Connect Wallet</button>
    <div id="walletBox" style="display:none;">
      <span id="walletAddress"></span>
      <button id="disconnectBtn">Disconnect</button>
      <div id="connected-info">Polygon Network<br/>
        <span style="font-size:10px;color:#6fdaed;"><b>Bet Contract:</b>
          <a href="https://polygonscan.com/address/0xc2E45bc197C490c5bdf067F75482671C2cf65F0a" target="_blank" style="color:#6fdaed;text-decoration:underline;">0xc2E4...5F0a</a></span>
      </div>
    </div>
  </div>
  <div id="balanceBox">
    <span id="nftfan_icon" class="material-icons">token</span>
    <span id="nftfan_balance">-</span> T (NFTFAN)
    &nbsp; <span id="usd_icon" class="material-icons">attach_money</span>
    <span id="nftfan_usd">-</span>
    <button id="approveBtn" style="display:none;">Approve NFTFAN</button>
    <button id="claimBtn" style="display:none;">Claim Win</button>
  </div>
  <!-- ... keep rest of your HTML UI unchanged ... -->
  <h1>
    <span class="material-icons" style="color:#FCA311; font-size:19px;">show_chart</span>
    BTC 60s Up/Down Bet
  </h1>
  <div style="margin:4px 0 4px 0;">
    <span class="material-icons" style="color:#FCA311; font-size:19px;">currency_bitcoin</span>
    <span id="btc-price">-----</span>
    <span style="font-size:1em;color:#4de7ed;">USD</span>
  </div>
  <canvas id="btc_chart" width="350" height="95" style="display:none"></canvas>
  <div id="betBox">
    <div class="row">
      <label>
        <span class="material-icons" style="font-size:13px;">currency_exchange</span>
        Bet Amount:
      </label>
      <input type="number" id="betAmount" min="0.01" step="0.00001" value="1" />
      <span style="font-weight:bold;color:#81ffd5;">T</span>
    </div>
    <div class="row" style="display:flex;gap:6px;">
      <button id="betUpBtn" type="button">
        <span class="material-icons" style="font-size:14px;">north</span> UP
      </button>
      <button id="betDownBtn" type="button">
        <span class="material-icons" style="font-size:14px;">south</span> DOWN
      </button>
      <button id="confirmBtn" type="button" disabled style="margin-left:8px;font-weight:bold;">
        <span class="material-icons" style="font-size:15px;">play_arrow</span>
        BET
      </button>
    </div>
    <div id="msg"></div>
  </div>
  <div id="timer"></div>
  <div id="resultBox" style="display:none"></div>
  <div id="instructions">
    <b>Instructions:</b>
    <ul id="instructions_list">
      <li>Connect wallet & approve before playing.</li>
      <li>Enter your bet, pick <b style="color:#00F067">UP</b> or <b style="color:#E54166">DOWN</b>, then click <b style="color:#27f;">BET</b>.</li>
      <li>The chart and price only update during your 60s round.</li>
      <li>Win <b style="color:#00C48C">+50%</b> if correct, or lose <b style="color:#ee8888">25%</b> of bet.</li>
      <li>Click "Claim Win" if you have a win signature from your admin.</li>
    </ul>
  </div>
</div>
<script>
// --- Onchain constants/ABIs (NFTFAN: 18 decimals, contract: 0xc2...5F0a Polygon) ---
const NFTFAN_ADDR = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
const BETGAME_ADDR = "0xc2E45bc197C490c5bdf067F75482671C2cf65F0a";
const NFTFAN_ABI = [
  "function approve(address,uint256) public returns (bool)",
  "function allowance(address,address) public view returns (uint256)",
  "function balanceOf(address owner) public view returns (uint256)",
  "function decimals() public view returns (uint8)"
];
const BETGAME_ABI = [
  "function takeLoss(uint256 betAmount, bytes32 gameId) external",
  "function claimWin(uint256 betAmount, bytes32 gameId, bytes calldata sig) external",
  "function completedGames(bytes32 gameId) view returns (bool)"
];
const POLYGON_PARAMS = {
  chainId: "0x89",
  chainName: "Polygon Mainnet",
  nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
  rpcUrls: [
    "https://polygon-rpc.com",
    "https://polygon.llamarpc.com",
    "https://rpc-mainnet.maticvigil.com"
  ],
  blockExplorerUrls: ["https://polygonscan.com/"]
};
let provider, signer, userAccount, nftfanContract, gameContract, nftfanDecimals=18;
let approved = false;
async function showWallet() {
  if(!signer||!userAccount) return;
  document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+"..."+userAccount.slice(-4);
  document.getElementById('walletBox').style.display = '';
  document.getElementById('connectBtn').style.display = 'none';
  nftfanContract = new ethers.Contract(NFTFAN_ADDR, NFTFAN_ABI, signer);
  gameContract = new ethers.Contract(BETGAME_ADDR, BETGAME_ABI, signer);
  nftfanDecimals = await nftfanContract.decimals();
  // Show NFTFAN balance
  let rawBal = await nftfanContract.balanceOf(userAccount);
  let humanBal = Number(ethers.utils.formatUnits(rawBal, nftfanDecimals))/1e9; // in "T"
  document.getElementById('nftfan_balance').textContent =
    humanBal.toLocaleString(undefined,{maximumFractionDigits:8});
  document.getElementById('nftfan_usd').textContent = "$" +
    (Number(ethers.utils.formatUnits(rawBal,18)) * 0.00000001).toLocaleString(undefined,{maximumFractionDigits:6});
  // Check allowance to game contract for 100 T units (> min bet)
  let allowance = await nftfanContract.allowance(userAccount, BETGAME_ADDR);
  approved = allowance.gte(ethers.utils.parseUnits("100", nftfanDecimals)); // arbitrary 100 T or more
  document.getElementById('approveBtn').style.display = approved ? "none" : "";
}
async function approveNftfan() {
  if(!signer) return;
  let amount = ethers.utils.parseUnits("100000000", nftfanDecimals); // Large allowance for session: 100M T
  let tx = await nftfanContract.approve(BETGAME_ADDR, amount);
  document.getElementById('approveBtn').textContent = "Approving...";
  await tx.wait();
  document.getElementById('approveBtn').textContent = "Approve NFTFAN";
  await showWallet();
}
document.getElementById('approveBtn').onclick = approveNftfan;

// --- Connect/disconnect ---
async function connectWallet() {
  if (!window.ethereum) { alert("MetaMask required!"); return; }
  // Request Polygon
  try {
    await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: POLYGON_PARAMS.chainId }] });
  } catch(e) {
    if (e.code === 4902) {
      await window.ethereum.request({ method: "wallet_addEthereumChain", params: [POLYGON_PARAMS] });
    } else if (!/already/.test(e.message)) { alert("Switch failed: " + e.message); return; }
  }
  provider = new ethers.providers.Web3Provider(window.ethereum, "any");
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAccount = await signer.getAddress();
  await showWallet();
}
function disconnectWallet() {
  provider = signer = userAccount = null;
  document.getElementById('walletBox').style.display = 'none';
  document.getElementById('connectBtn').style.display = '';
}
// Handle account/network changes
document.getElementById('connectBtn').onclick = connectWallet;
document.getElementById('disconnectBtn').onclick = disconnectWallet;
if(window.ethereum) {
  window.ethereum.on('accountsChanged', accounts => {
    if(accounts[0]) { userAccount = accounts[0]; showWallet(); }
    else { disconnectWallet(); }
  });
  window.ethereum.on('chainChanged', (_chainId) => {
    if(_chainId !== POLYGON_PARAMS.chainId) disconnectWallet();
  });
}

// ---- DEMO GAME LOGIC: Only enable actual bets if wallet connected and approved ----
function ensureWalletAndApproval(cb) {
  if(!signer||!userAccount) { alert("Connect wallet first!"); return false; }
  if(!approved) { alert("Please approve NFTFAN to play."); return false; }
  cb();
  return true;
}

let chart, chartTimer, timerInterval;
let btcPricesLive = [];
let lastBtcPrice = null;
let state = "idle";
let selectedDirection = null;
let bet = {dir:null, amtT:0, priceStart:0, priceEnd:0, gameId:null};

function showMsg(msg, type) {
  let el = document.getElementById('msg');
  el.className = type||"";
  el.textContent = msg;
}
function clearSelection() {
  document.getElementById('betUpBtn').classList.remove("selected-btn");
  document.getElementById('betDownBtn').classList.remove("selected-btn");
  selectedDirection = null;
  document.getElementById('confirmBtn').disabled = true;
}
document.getElementById('betUpBtn').onclick = function(){
  clearSelection();
  selectedDirection = "up";
  document.getElementById('betUpBtn').classList.add("selected-btn");
  document.getElementById('confirmBtn').disabled = false;
  state="choosing";
  enableInputs(true);
};
document.getElementById('betDownBtn').onclick = function(){
  clearSelection();
  selectedDirection = "down";
  document.getElementById('betDownBtn').classList.add("selected-btn");
  document.getElementById('confirmBtn').disabled = false;
  state="choosing";
  enableInputs(true);
};
document.getElementById('confirmBtn').onclick = function(){
  ensureWalletAndApproval(startGame);
};

function resetChart() {
  btcPricesLive = [];
  if(chart) chart.destroy();
  document.getElementById('btc_chart').style.display = "none";
}
function drawChart() {
  let dataArr = btcPricesLive;
  let ctx = document.getElementById('btc_chart').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: dataArr.map(p=>p.time),
      datasets: [{
        label: "BTC/USD",
        data: dataArr.map(p=>p.price),
        fill: true,
        borderColor: "#00E0FF",
        backgroundColor: "rgba(30,196,238,0.08)",
        pointBackgroundColor: "#00E0FF",
        tension: 0.29,
        pointRadius: 2.2
      }]
    },
    options: {
      animation: { duration: 550, easing:"easeInOutQuart" },
      plugins: { legend: { display:false } },
      scales: { y: { beginAtZero: false, grid:{color:"#20273166"} }, x: { grid:{color:"transparent"} } }
    }
  });
}
async function fetchBTCPrice() {
  try {
    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
    const data = await response.json();
    return parseFloat(data.price);
  } catch (error) { return null; }
}
function animatePriceChange(newPrice) {
  let el = document.getElementById('btc-price');
  el.classList.remove('price-rise','price-fall');
  if (lastBtcPrice != null) {
    if (newPrice > lastBtcPrice) el.classList.add('price-rise');
    else if (newPrice < lastBtcPrice) el.classList.add('price-fall');
  }
  el.textContent = newPrice.toLocaleString(undefined,{maximumFractionDigits:2});
  lastBtcPrice = newPrice;
  setTimeout(()=>{el.classList.remove('price-rise','price-fall');},450);
}
function enableInputs(enable) {
  document.getElementById('betAmount').disabled = !enable;
  document.getElementById('betUpBtn').disabled = !enable;
  document.getElementById('betDownBtn').disabled = !enable;
  if(!enable) document.getElementById('confirmBtn').disabled = true;
}
async function startGame() {
  // DEMO: Use betAmount in T, convert to raw for contract
  let amtT = parseFloat(document.getElementById('betAmount').value);
  if(!amtT || amtT<=0) { showMsg("Enter a bet amount", "fail"); return;}
  // Live on-chain balance (in raw units)
  let rawBal = await nftfanContract.balanceOf(userAccount);
  let humanBal = Number(ethers.utils.formatUnits(rawBal, nftfanDecimals))/1e9; // in "T"
  if(amtT > humanBal){ showMsg("Insufficient NFTFAN!", "fail"); return;}
  enableInputs(false);
  showMsg("Fetching BTC price ...", "");
  let priceA = await fetchBTCPrice();
  if(!priceA) { showMsg("Network error!", "fail"); enableInputs(true); return; }
  // Generate unique gameId for round
  bet = {
    dir: selectedDirection,
    amtT: amtT,
    priceStart: priceA,
    priceEnd: 0,
    gameId: ethers.utils.id(userAccount + ':' + (+new Date()) + ':'+Math.random())
  };
  state = "waiting";
  resetChart();
  btcPricesLive = [{ time: new Date().toLocaleTimeString().slice(0,5), price: priceA }];
  document.getElementById('btc_chart').style.display = "block";
  drawChart();
  document.getElementById('timer').textContent =
    "Bet placed! Wait <span style='color:#FFA311'>60</span>s";
  showMsg("BTC/USD start: $" + priceA.toLocaleString(undefined,{maximumFractionDigits:2}),"");
  chartTimer = setInterval(async ()=>{
    let price = await fetchBTCPrice();
    if(state === "waiting" && price) {
      btcPricesLive.push({ time: new Date().toLocaleTimeString().slice(0,5), price: price });
      if(btcPricesLive.length>12) btcPricesLive.shift();
      animatePriceChange(price);
      drawChart();
    }
  }, 10000);
  let tRemain=60;
  timerInterval = setInterval(()=>{
    tRemain -= 1;
    document.getElementById('timer').innerHTML =
      "Time left: <span style='color:#29f;'>" + tRemain + "s</span>";
    if(tRemain<=0) {
      clearInterval(timerInterval);
      clearInterval(chartTimer);
      finishBet();
    }
  },1000);
}
async function finishBet() {
  state = "checking";
  document.getElementById('timer').textContent = "Checking ...";
  let priceB = await fetchBTCPrice();
  if(!priceB) { showMsg("Failed to fetch result", "fail"); enableInputs(true); clearSelection(); state="idle"; return;}
  bet.priceEnd = priceB;
  btcPricesLive.push({ time: new Date().toLocaleTimeString().slice(0,5), price: priceB });
  drawChart();
  // Calculate if win or loss off-chain
  let outcome = (bet.dir==='up') ? priceB>bet.priceStart : (bet.dir==='down') ? priceB<bet.priceStart : false;
  let box = document.getElementById('resultBox');
  box.style.display = "block";
  let arrow = bet.dir==="up"
    ? "<span class='material-icons' style='font-size:15px;color:#00F067;vertical-align:-4px'>arrow_upward</span>"
    : "<span class='material-icons' style='font-size:15px;color:#E54166;vertical-align:-4px'>arrow_downward</span>";
  let resultHtml = `${arrow}`;
  let betRaw = ethers.utils.parseUnits(String(bet.amtT*1e9), nftfanDecimals-9); // T to raw
  // DEMO ONLY: For win, backend would return sig, here claim unlocked for demo
  if(outcome) {
    showMsg("ðŸŽ‰ You win! Click 'Claim Win' to receive payout.", "success");
    document.getElementById('claimBtn').style.display = '';
    document.getElementById('claimBtn').onclick = async function() {
      // In production, fetch 'sig' from backend API here: await fetch('/claim-sig', ...);
      // For frontend demo: use a dummy signature that will always fail.
      let dummySig = "0x" + "00".repeat(65); // <-- Replace this with real backend sig in prod
      try {
        await gameContract.claimWin(betRaw, bet.gameId, dummySig);
      } catch(e) {
        alert("This is a frontend demo. In production, this would claim with a backend signature.");
      }
      document.getElementById('claimBtn').style.display = 'none';
      await showWallet();
    };
    resultHtml += `<b style="color:#16ff7b;font-size:1em">WIN!</b><br>
      Bet ${bet.amtT} T. Click <b style="color:#09f;">Claim Win</b> for 1.5x!<br>`;
    box.className = "win";
  } else {
    showMsg("Sorry, you lost! Signing on chain...", "fail");
    try {
      await gameContract.takeLoss(betRaw, bet.gameId);
      showMsg("Loss sent on chain (25% taken)", "fail");
    } catch(e) {
      alert("Loss transaction failed: "+e.message);
    }
    resultHtml += `<b style="color:#ff6961;font-size:1em">LOSE!</b><br>
      25% of ${bet.amtT} T sent to house.<br>`;
    box.className = "lose";
  }
  resultHtml += `<br>Start: $${bet.priceStart.toLocaleString(undefined,{maximumFractionDigits:2})}
                 <br>End: $${bet.priceEnd.toLocaleString(undefined,{maximumFractionDigits:2})}`;
  box.innerHTML = resultHtml;
  document.getElementById('timer').textContent = "";
  state="idle";
  clearSelection();
  setTimeout(()=>{ resetChart(); enableInputs(true); box.style.display='none'; }, 3500);
  await showWallet();
}
// Startup
resetChart();
clearSelection();
enableInputs(true);
</script>
</body>
</html>
