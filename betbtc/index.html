<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BTC 60s Up/Down Bet</title>
  <meta name="viewport" content="width=420">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* ... (Keeping your original CSS) ... */
    html, body { font-size: 11px; }
    body { font-family: 'Roboto', Arial, sans-serif; background: #181A20; color: #FCFCFC; margin:0; padding:0;}
    .container { max-width: 400px; margin: 22px auto; background: #232630; border-radius: 15px; box-shadow: 0 3px 24px #0005; padding: 20px 11px 8px 11px }
    h1 { text-align:center; font-weight:400; font-size:1.3em; margin-bottom:8px; letter-spacing:.8px;}
    #balanceBox { background:#222e3a; border-radius:8px; padding:10px 14px; margin-bottom:9px; display:flex; align-items:center; gap:6px; font-size:1em;}
    #nftfan_icon { font-size:20px; color:#00C48C }
    #usd_icon { font-size:18px; color:#1EC4EE }
    #btc-price { font-size: 1.18em; font-weight: 600; padding: 4px 8px; border-radius:6px; margin-left:3px; }
    .price-rise { background: #294a26; color: #82fa6d;}
    .price-fall { background: #492627; color: #f98e9a;}
    #betBox, #resultBox { background: #222b36; border-radius:8px; padding:11px; margin: 7px 0; box-shadow:0 1px 5px #0001 }
    .row { margin: 7px 0 8px 0;}
    input[type=number] { width:6em;background:#222b29;color:#fff;border:1px solid #37415a; border-radius:3px;font-size:1em;outline:none;padding:2px 5px;}
    button { border: none; border-radius: 7px; padding:7px 16px; font-size:1em; margin:0 5px 0 0; background: linear-gradient(to right, #0081CF 70%, #00D4A1 100%); color: #fff; box-shadow: 0 2.5px 9px #11efc22b; font-weight:500; cursor: pointer; transition:transform 0.13s, background 0.14s,box-shadow 0.13s;}
    button:active { transform: scale(0.96);}
    .disable { opacity:0.38; pointer-events:none;}
    #timer { font-weight: 700; color:#6af; font-size:1.08em; letter-spacing:.9px;}
    #btc_chart { margin:8px 0 2px 0; background: #21273F; border-radius: 10px; border:1px solid #20223a; box-shadow:0 2px 6px #00fffc0e; }
    .material-icons {vertical-align:middle;}
    #betUpBtn, #betDownBtn { min-width: 68px; margin-top:2px; outline:none;}
    #betUpBtn {background: linear-gradient(to right,#00F067 60%, #0081CF 100%)}
    #betDownBtn {background: linear-gradient(to right, #E54166 70%, #5856D6 100%);}
    .selected-btn { box-shadow: 0 0 0 2.2px #fff9, 0 0 10px 2px #00ffe160, 0 2px 4px #0507; filter: brightness(1.13); border-radius:7px; outline:2px solid #45eeedda; }
    #msg.success { color:#37e18c;}
    #msg.fail { color:#ffa48d;}
    #resultBox { transition: background .17s;}
    #resultBox.win { background: #25683D;}
    #resultBox.lose { background: #612828;}
    #betBox label { font-weight:400;color:#95d2fd; }
    #instructions { background:#1b222c; border-radius: 6px; color:#bde2ee; font-size:10px; margin:12px 0 4px 0; padding:6.7px 9px 6px 12px; line-height:1.35em; border-left:3px solid #00c4b2; box-shadow: 0 1.5px 6px #00fffc08;}
    ul#instructions_list {margin:.25em 0 .1em 1.1em; padding:0 0 0 10px;}
    ul#instructions_list li {margin-bottom:2.1px;}
    
    /* New styles for Wallet Button */
    #connectBtn { width: 100%; margin-bottom: 10px; background: #37415a; }
    #connectBtn.connected { background: #294a26; color: #82fa6d; }
  </style>
</head>
<body>
<div class="container">
  <button id="connectBtn">Connect Wallet</button>
  
  <h1>
    <span class="material-icons" style="color:#FCA311; font-size:19px;">show_chart</span>
    BTC 60s Up/Down Bet
  </h1>
  <div id="balanceBox">
    <span id="nftfan_icon" class="material-icons">token</span>
    <span id="nftfan_balance">0.00</span> T (NFTFAN)
    &nbsp; <span id="usd_icon" class="material-icons">attach_money</span>
    <span id="nftfan_usd">0.00</span>
  </div>
  <div style="margin:4px 0 4px 0;">
    <span class="material-icons" style="color:#FCA311; font-size:19px;">currency_bitcoin</span>
    <span id="btc-price">-----</span>
    <span style="font-size:1em;color:#4de7ed;">USD</span>
  </div>
  <canvas id="btc_chart" width="350" height="95" style="display:none"></canvas>
  <div id="betBox">
    <div class="row">
      <label><span class="material-icons" style="font-size:13px;">currency_exchange</span> Bet Amount:</label>
      <input type="number" id="betAmount" min="0.01" step="0.01" value="1" />
      <span style="font-weight:bold;color:#81ffd5;">T</span>
    </div>
    <div class="row" style="display:flex;gap:6px;">
      <button id="betUpBtn" type="button"><span class="material-icons" style="font-size:14px;">north</span> UP</button>
      <button id="betDownBtn" type="button"><span class="material-icons" style="font-size:14px;">south</span> DOWN</button>
      <button id="confirmBtn" type="button" disabled style="margin-left:8px;font-weight:bold;"><span class="material-icons" style="font-size:15px;">play_arrow</span> BET</button>
    </div>
    <div id="msg"></div>
  </div>
  <div id="timer"></div>
  <div id="resultBox" style="display:none"></div>
  <div id="instructions">
    <b>Instructions:</b>
    <ul id="instructions_list">
      <li>Connect your wallet to the <b>Polygon</b> network.</li>
      <li>Pick <b style="color:#00F067">UP</b> or <b style="color:#E54166">DOWN</b>, then click <b style="color:#27f;">BET</b>.</li>
      <li>Win <b style="color:#00C48C">+50%</b> payout if correct.</li>
    </ul>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const CONTRACT_ADDRESS = "0xc2E45bc197C490c5bdf067F75482671C2cf65F0a";
const POLYGON_CHAIN_ID = "0x89"; // 137 in hex
const NFTFAN_TO_USD = 0.00000001; 

// Minimal ABI for ERC20 balance and Game logic
const ABI = [
    "function nftfan() view returns (address)",
    "function deposit(uint256 amount) external",
    "function takeLoss(uint256 betAmount, bytes32 gameId) external",
    "function claimWin(uint256 betAmount, bytes32 gameId, bytes calldata sig) external"
];
const ERC20_ABI = ["function balanceOf(address owner) view returns (uint256)", "function decimals() view returns (uint8)"];

let provider, signer, contract, tokenContract;
let userAddress = null;

// --- WALLET LOGIC ---
async function connectWallet() {
    if (!window.ethereum) return alert("Please install MetaMask");

    try {
        // 1. Request accounts
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = accounts[0];

        // 2. Check/Switch Network
        await switchToPolygon();

        // 3. Initialize Ethers
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        
        // Get Token Address from Contract
        const tokenAddress = await contract.nftfan();
        tokenContract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);

        // Update UI
        document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
        document.getElementById('connectBtn').classList.add('connected');
        
        updateBalances();
    } catch (err) {
        console.error(err);
    }
}

async function switchToPolygon() {
    try {
        await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: POLYGON_CHAIN_ID }],
        });
    } catch (error) {
        if (error.code === 4902) {
            // Chain not added to MetaMask
            await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                    chainId: POLYGON_CHAIN_ID,
                    chainName: 'Polygon Mainnet',
                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                    rpcUrls: ['https://polygon-rpc.com/'],
                    blockExplorerUrls: ['https://polygonscan.com/']
                }]
            });
        }
    }
}

async function updateBalances() {
    if (!tokenContract || !userAddress) return;
    const balance = await tokenContract.balanceOf(userAddress);
    const decimals = await tokenContract.decimals();
    const formatted = ethers.formatUnits(balance, decimals);
    
    document.getElementById('nftfan_balance').textContent = parseFloat(formatted).toFixed(2);
    document.getElementById('nftfan_usd').textContent = "$" + (parseFloat(formatted) * 1e9 * NFTFAN_TO_USD).toFixed(4);
}

document.getElementById('connectBtn').onclick = connectWallet;

// --- GAME LOGIC (Modified to use contract) ---
// Note: In a real environment, takeLoss or claimWin would be called 
// at the end of finishBet() to settle on-chain.

let chart, chartTimer, timerInterval;
let btcPricesLive = [];
let lastBtcPrice = null;
let state = "idle";
let selectedDirection = null;

// (Keeping your original chart and fetch logic, but updating startGame)
async function fetchBTCPrice() {
    try {
        const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await response.json();
        return parseFloat(data.price);
    } catch (e) { return null; }
}

// ... original helper functions (animatePriceChange, drawChart, etc) ...
// (I'll keep them short for the demo)

function showMsg(msg, type) {
    let el = document.getElementById('msg');
    el.className = type || "";
    el.textContent = msg;
}

document.getElementById('betUpBtn').onclick = () => { selectDir('up'); };
document.getElementById('betDownBtn').onclick = () => { selectDir('down'); };

function selectDir(d) {
    selectedDirection = d;
    document.querySelectorAll('#betUpBtn, #betDownBtn').forEach(b => b.classList.remove('selected-btn'));
    document.getElementById(d === 'up' ? 'betUpBtn' : 'betDownBtn').classList.add('selected-btn');
    document.getElementById('confirmBtn').disabled = false;
    state = "choosing";
}

document.getElementById('confirmBtn').onclick = async () => {
    if (!userAddress) return alert("Connect Wallet first!");
    startGame();
};

async function startGame() {
    let amt = document.getElementById('betAmount').value;
    showMsg("Starting round...", "");
    let priceA = await fetchBTCPrice();
    if (!priceA) return;

    // UI Feedback
    state = "waiting";
    document.getElementById('btc_chart').style.display = "block";
    let tRemain = 60;
    
    timerInterval = setInterval(async () => {
        tRemain--;
        document.getElementById('timer').innerHTML = `Time left: <span style='color:#29f;'>${tRemain}s</span>`;
        if(tRemain % 10 === 0) {
            let p = await fetchBTCPrice();
            btcPricesLive.push({time: new Date().toLocaleTimeString().slice(0,5), price: p});
            drawChart();
        }
        if (tRemain <= 0) {
            clearInterval(timerInterval);
            finishBet(priceA);
        }
    }, 1000);
}

async function finishBet(startPrice) {
    let endPrice = await fetchBTCPrice();
    let won = (selectedDirection === 'up' && endPrice > startPrice) || (selectedDirection === 'down' && endPrice < startPrice);
    
    let box = document.getElementById('resultBox');
    box.style.display = "block";
    
    if (won) {
        box.className = "win";
        box.innerHTML = `WIN! <br> Started: ${startPrice} <br> Ended: ${endPrice}`;
        // Here you would normally call contract.claimWin(...) with a backend sig
    } else {
        box.className = "lose";
        box.innerHTML = `LOSE! <br> Started: ${startPrice} <br> Ended: ${endPrice}`;
        // Here you would call contract.takeLoss(...)
    }
    state = "idle";
    updateBalances();
}

function drawChart() {
    let ctx = document.getElementById('btc_chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: btcPricesLive.map(p=>p.time),
            datasets: [{ data: btcPricesLive.map(p=>p.price), borderColor: "#00E0FF", tension: 0.3 }]
        },
        options: { plugins: { legend: { display: false } } }
    });
}
</script>
</body>
</html>
