<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fan Names Minter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #050509;
      --panel: #111119;
      --border: #24242f;
      --text: #eebd6e;
      --muted: #9b7f4a;
      --accent: #eebd6e;
      --error: #ff4b4b;
      --success: #7ed957;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 10px;
    }
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    #app-container {
      width: 100%;
      max-width: 860px;
      padding: 8px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      padding-bottom: 6px;
      margin-bottom: 8px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logo {
      width: 18px;
      height: 18px;
      border-radius: 3px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .logo .material-icons {
      font-size: 10px;
      color: var(--text);
    }
    .title-main { font-size: 10px; font-weight: 600; }
    .actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .pill {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 3px 6px;
      font-size: 9px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill .material-icons { font-size: 10px; }
    button {
      border: 1px solid var(--border);
      background: #14141c;
      color: var(--text);
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    button .material-icons { font-size: 10px; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .wallet {
      font-size: 9px;
      padding: 3px 6px;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--text);
    }
    main {
      display: grid;
      grid-template-columns: 1.1fr 1.2fr;
      gap: 8px;
    }
    @media (max-width: 720px) {
      main { grid-template-columns: 1fr; }
    }
    .panel {
      background: var(--panel);
      border-radius: 4px;
      border: 1px solid var(--border);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 4px;
      border-bottom: 1px solid var(--border);
    }
    .panel-header-title { font-size: 9px; font-weight: 600; }
    .row { display: flex; flex-direction: column; gap: 6px; }
    .row.inline { flex-direction: row; flex-wrap: wrap; align-items: center; gap: 6px; }
    .status {
      font-size: 9px;
      padding: 6px;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--muted);
      min-height: 20px;
      display: flex;
      align-items: center;
    }
    .status.success { color: var(--success); border-color: var(--success); }
    .status.error { color: var(--error); border-color: var(--error); }
    .status.loading { gap: 4px; }
    .spinner {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,0.1);
      border-left-color: var(--text);
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .tag {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 2px 6px;
      font-size: 9px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
    }
    .tag .material-icons { font-size: 10px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 9px;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 4px 3px;
      text-align: left;
    }
    th { color: var(--muted); font-weight: 500; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #15151f; }
    .rank-col { width: 20px; text-align: center; }
    .right { text-align: right; }
    #initial-loader {
      position: fixed;
      inset: 0;
      background: #050509;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10px;
      z-index: 9999;
    }
    #initial-loader.hidden { display: none; }
    #cityLoading {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #111119;
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 3px;
      display: none;
      align-items: center;
      gap: 4px;
      font-size: 9px;
    }
    #cityLoading .spinner {
      width: 8px;
      height: 8px;
      border-width: 1.5px;
    }
    #cityLoading .material-icons { font-size: 10px; }
    a.username-link {
      color: inherit;
      text-decoration: none;
    }
    a.username-link:hover { text-decoration: underline; }
    .name-color-input {
      width: 40px;
      height: 16px;
      padding: 0;
      border-radius: 3px;
      border: 1px solid var(--border);
      background: #090910;
    }
    #imageGridContainer {
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 4px;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
    }
    @media (max-width: 720px) {
      .image-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    @media (max-width: 480px) {
      .image-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .image-card {
      position: relative;
      border-radius: 4px;
      overflow: hidden;
      background: #090910;
      border: 1px solid #1b1b25;
      cursor: pointer;
      transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
    }
    .image-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 0 1px rgba(238, 189, 110, 0.4);
      border-color: var(--accent);
    }
    .image-card.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(238, 189, 110, 0.8);
    }
    .image-card.minted::after {
      content: "Taken";
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(255, 75, 75, 0.85);
      color: #fff;
      font-size: 8px;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .image-card img {
      width: 50px;
      height: 50px;
      display: block;
      object-fit: contain;
      image-rendering: pixelated;
    }
    .image-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 3px 4px 4px 4px;
      font-size: 8px;
      color: var(--muted);
      border-top: 1px solid #1b1b25;
      background: rgba(5,5,9,0.95);
    }
    .image-card-status {
      display: inline-flex;
      align-items: center;
      gap: 2px;
    }
    .image-card-status.available {
      color: var(--success);
    }
    .image-card-status.taken {
      color: var(--error);
    }
    .image-card-index {
      opacity: 0.6;
    }
    #fan-talk-section {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #messages-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .message-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 4px;
      border-bottom: 1px solid var(--border);
    }
    .message-item:last-child {
      border-bottom: none;
    }
    .message-avatar img {
      width: 32px;
      height: 32px;
      border-radius: 3px;
    }
    .message-content {
      flex: 1;
    }
    .message-sender {
      font-size: 9px;
      font-weight: 600;
    }
    .message-text {
      font-size: 9px;
      color: var(--muted);
    }
    .message-timestamp {
      font-size: 8px;
      color: var(--muted);
      opacity: 0.7;
    }
    #fan-talk-input {
      display: flex;
      gap: 6px;
    }
    #message-input {
      flex: 1;
      background: #090910;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 9px;
      padding: 4px 8px;
      border-radius: 3px;
    }
    #post-message-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="initial-loader">
    <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
      <div class="spinner"></div>
      <div>Loading...</div>
    </div>
  </div>
  <div id="app-container">
    <header>
      <div class="brand">
        <div class="logo"><span class="material-icons">alternate_email</span></div>
        <div class="title-main">Community Fans</div>
      </div>
      <div class="actions">
        <button id="connectBtn">
          <span class="material-icons">account_balance_wallet</span>
          <span>Connect</span>
        </button>
        <span id="wallet" class="wallet" style="display:none;"></span>
      </div>
    </header>
    <main>
      <section class="panel">
        <div class="panel-header">
          <div class="panel-header-title">Mint a fan</div>
        </div>
        <div class="row">
          <div id="imageGridContainer">
            <div id="image-grid" class="image-grid">
            </div>
          </div>
        </div>
        <div class="row inline">
          <span id="selectionPill" class="tag" style="display:none;"></span>
          <span id="ownedCountPill" class="tag" style="display:none;"></span>
          <span id="mintedCountPill" class="tag" style="display:none;"></span>
        </div>
        <div class="row inline">
          <button id="mintBtn" disabled>
            <span class="material-icons">rocket_launch</span>
            <span>Mint</span>
          </button>
          <button id="clearBtn">
            <span class="material-icons">delete_sweep</span>
            <span>Clear</span>
          </button>
          <button id="refreshBtn">
            <span class="material-icons">refresh</span>
            <span>Refresh</span>
          </button>
          <div style="flex:1;"></div>
          <div class="tag">
            <span>Color:</span>
            <input id="nameColorInput" class="name-color-input" type="color" value="#eebd6e" />
          </div>
        </div>
        <div id="status" class="status">
          Connect wallet and pick a card.
        </div>
      </section>
      <section class="panel">
        <div class="panel-header">
          <div class="panel-header-title">Top collectors</div>
        </div>
        <table>
          <thead>
            <tr>
              <th class="rank-col">#</th>
              <th>Owner</th>
              <th class="right">Fans</th>
              <th class="right">POL spent</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body"></tbody>
        </table>
        <div class="panel-header" style="margin-top:4px;">
          <div class="panel-header-title">Minted fans</div>
        </div>
        <div style="max-height:260px;overflow-y:auto;">
          <table>
            <thead>
              <tr>
                <th>Fan</th>
                <th>Owner</th>
                <th class="right">Price (POL)</th>
              </tr>
            </thead>
            <tbody id="usernames-body"></tbody>
          </table>
        </div>
      </section>
    </main>
    <section id="fan-talk-section" class="panel">
      <div class="panel-header">
        <div class="panel-header-title">Fan Talk</div>
      </div>
      <div id="messages-list"></div>
      <div id="fan-talk-input" style="display:none;">
        <input id="message-input" type="text" placeholder="Post a message..." maxlength="280" />
        <button id="post-message-btn">
          <span class="material-icons">send</span>
          <span>Post</span>
        </button>
      </div>
      <div id="fan-talk-status" class="status" style="display:none;"></div>
    </section>
  </div>
  <div id="cityLoading">
    <span class="spinner"></span>
    <span class="material-icons">alternate_email</span>
    <span class="text">Loading data…</span>
  </div>
  <script>
    const POLYGON_PARAMS = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'POL', symbol: 'POL', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };
    const CONTRACT_ADDRESS = "0xb7d9E197905A0Fe7A59d82029eEFCBfDa631E2CC";
    const CONTRACT_ABI = [
      "function mintWithURI(string tokenURI) external payable returns (uint256)",
      "function mintPrice() view returns (uint256)",
      "function tokenURI(uint256 tokenId) view returns (string)",
      "function ownerOf(uint256 tokenId) view returns (address)",
      "event Transfer(address indexed from, address indexed to, uint256 indexed tokenId)"
    ];
    const FIXED_MINT_PRICE_POL = 1;
    const firebaseConfig = {
      apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
      authDomain: "newnft-47bd7.firebaseapp.com",
      databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
      projectId: "newnft-47bd7",
      storageBucket: "newnft-47bd7.firebasestorage.app",
      messagingSenderId: "172043823738",
      appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
      measurementId: "G-8VB3DYRNXR"
    };
    let web3Provider, signer, userAddress;
    let nameColor = '#eebd6e';
    let selectedKey = '';
    let selectedIndex = null;
    let fbApp, fbDb, allNftsRef = null, fanTalkRef = null;
    const nameDataByKey = new Map();
    let generatedCards = [];
    let messages = [];
    const initialLoader = document.getElementById('initial-loader');
    const connectBtn = document.getElementById('connectBtn');
    const walletEl = document.getElementById('wallet');
    const mintBtn = document.getElementById('mintBtn');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const statusEl = document.getElementById('status');
    const selectionPill = document.getElementById('selectionPill');
    const ownedCountPill = document.getElementById('ownedCountPill');
    const mintedCountPill = document.getElementById('mintedCountPill');
    const cityLoadingEl = document.getElementById('cityLoading');
    const cityLoadingText = cityLoadingEl.querySelector('.text');
    const nameColorInput = document.getElementById('nameColorInput');
    const leaderboardBody = document.getElementById('leaderboard-body');
    const usernamesBody = document.getElementById('usernames-body');
    const imageGrid = document.getElementById('image-grid');
    const imageGridContainer = document.getElementById('imageGridContainer');
    const messagesList = document.getElementById('messages-list');
    const fanTalkInput = document.getElementById('fan-talk-input');
    const messageInput = document.getElementById('message-input');
    const postMessageBtn = document.getElementById('post-message-btn');
    const fanTalkStatus = document.getElementById('fan-talk-status');
    function setStatus(msg, type = '') {
      statusEl.className = 'status';
      if (type === 'success') statusEl.classList.add('success');
      if (type === 'error') statusEl.classList.add('error');
      if (type === 'loading') {
        statusEl.classList.add('loading');
        statusEl.innerHTML = `<span class="spinner"></span><span>${msg}</span>`;
      } else {
        statusEl.textContent = msg;
      }
    }
    function setFanTalkStatus(msg, type = '') {
      fanTalkStatus.style.display = 'flex';
      fanTalkStatus.className = 'status';
      if (type === 'success') fanTalkStatus.classList.add('success');
      if (type === 'error') fanTalkStatus.classList.add('error');
      fanTalkStatus.textContent = msg;
      setTimeout(() => fanTalkStatus.style.display = 'none', 5000);
    }
    function showCityLoading(text = 'Loading data…') {
      cityLoadingText.textContent = text;
      cityLoadingEl.style.display = 'flex';
      setTimeout(() => cityLoadingEl.style.display = 'none', 20000);
    }
    function hideCityLoading() {
      cityLoadingEl.style.display = 'none';
    }
    function escapeHTML(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function shortAddr(a) {
      return a ? `${a.slice(0,6)}...${a.slice(-4)}` : '';
    }
    function displayFanName(key) {
      if (!key.startsWith('PixelFan')) return key;
      const num = key.slice(8);
      return `Art #${num}`;
    }
    function fanToXLink(key) {
      const display = displayFanName(key);
      return {
        label: display,
        url: 'https://x.com/nftfanstoken'
      };
    }
    async function switchToPolygon() {
      if (!window.ethereum) return false;
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_PARAMS.chainId }] });
        return true;
      } catch (e) {
        if (e.code === 4902) {
          try {
            await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PARAMS] });
            return true;
          } catch {
            setStatus('Failed to add Polygon network.', 'error');
            return false;
          }
        }
        setStatus('Failed to switch network.', 'error');
        return false;
      }
    }
    async function connectWallet() {
      if (!window.ethereum) {
        setStatus('Please install MetaMask.', 'error');
        return;
      }
      try {
        setStatus('Connecting wallet…', 'loading');
        if (!await switchToPolygon()) return;
        web3Provider = new ethers.providers.Web3Provider(window.ethereum);
        await web3Provider.send('eth_requestAccounts', []);
        signer = web3Provider.getSigner();
        userAddress = await signer.getAddress();
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span><span>Connected</span>';
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';
        setStatus('Wallet connected.', 'success');
        updateMintButtonState();
        updateCountsAndLeaderboard();
        updateFanTalkEligibility();
        if (window.ethereum?.on) {
          window.ethereum.removeListener?.('accountsChanged', onAccountsChanged);
          window.ethereum.on('accountsChanged', onAccountsChanged);
        }
      } catch (e) {
        console.error(e);
        setStatus('Wallet connection failed.', 'error');
      }
    }
    async function onAccountsChanged(accounts) {
      userAddress = (accounts && accounts[0]) ? accounts[0] : null;
      if (userAddress) {
        walletEl.textContent = shortAddr(userAddress);
        walletEl.style.display = 'inline-block';
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<span class="material-icons">check_circle</span><span>Connected</span>';
      } else {
        walletEl.style.display = 'none';
        connectBtn.disabled = false;
        connectBtn.innerHTML = '<span class="material-icons">account_balance_wallet</span><span>Connect</span>';
      }
      updateMintButtonState();
      updateCountsAndLeaderboard();
      updateFanTalkEligibility();
    }
    function isKeyMinted(key) {
      if (!key) return false;
      const k = key.toLowerCase();
      return nameDataByKey.has(k);
    }
    function selectByIndex(idx) {
      selectedIndex = idx;
      selectedKey = generatedCards[idx]?.key || '';
      document.querySelectorAll('.image-card').forEach((card, i) => {
        card.classList.toggle('selected', i === idx);
      });
      if (selectedKey) {
        const taken = isKeyMinted(selectedKey);
        const label = displayFanName(selectedKey);
        selectionPill.style.display = 'inline-flex';
        selectionPill.innerHTML = `<span class="material-icons">alternate_email</span><span>${escapeHTML(label)}</span><span style="color:${taken ? '#ff4b4b' : '#eebd6e'};">${taken ? 'Taken' : 'Available'}</span>`;
      } else {
        selectionPill.style.display = 'none';
      }
      updateMintButtonState();
      renderImageGrid();
    }
    function updateNameColorState() {
      nameColor = nameColorInput.value || '#eebd6e';
      updateMintButtonState();
    }
    function updateMintButtonState() {
      const hasWallet = !!userAddress;
      const hasKey = !!selectedKey;
      const taken = hasKey && isKeyMinted(selectedKey);
      mintBtn.disabled = !hasWallet || !hasKey || taken;
      if (!hasWallet) {
        setStatus('Connect wallet.', '');
      } else if (!hasKey) {
        setStatus('Choose a card.', '');
      } else if (taken) {
        setStatus('Already minted.', 'error');
      } else {
        setStatus('Ready to mint.', 'success');
      }
    }
    async function mintSelectedFan() {
      try {
        if (!userAddress) return setStatus('Connect wallet.', 'error');
        if (!selectedKey) return setStatus('Choose a card.', 'error');
        if (isKeyMinted(selectedKey)) return setStatus('Already minted.', 'error');
        const label = displayFanName(selectedKey);
        setStatus(`Minting “${label}”…`, 'loading');
        const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
        const tokenURI = buildFanTokenURI(selectedKey, nameColor);
        const priceWei = ethers.utils.parseEther(FIXED_MINT_PRICE_POL.toString());
        const tx = await contract.mintWithURI(tokenURI, { value: priceWei });
        setStatus('Waiting…', 'loading');
        const receipt = await tx.wait();
        const ev = receipt.events?.find(e => e.event === 'Transfer');
        const mintedTokenId = ev?.args?.tokenId?.toString() || `temp-${Date.now()}`;
        const now = Math.floor(Date.now() / 1000);
        const fullNftData = {
          owner: userAddress,
          meta: {
            fan_key: selectedKey,
            fan_key_lower: selectedKey.toLowerCase(),
            name_color: nameColor,
            mint_price_pol: FIXED_MINT_PRICE_POL,
            created_at: now
          }
        };
        await writeNftToFirebase(mintedTokenId, fullNftData);
        setStatus(`Minted “${label}”.`, 'success');
        updateMintButtonState();
        updateFanTalkEligibility();
      } catch (e) {
        console.error(e);
        const msg = e?.data?.message || e?.reason || e?.message || 'Error.';
        setStatus(`Failed: ${msg}`, 'error');
      }
    }
    function buildFanTokenURI(key, color) {
      const label = displayFanName(key);
      const metadata = {
        name: `${label}`,
        description: `Fan role: ${label}.`,
        image: buildFanSVG(label, color),
        attributes: [
          { trait_type: "Fan", value: label },
          { trait_type: "Key", value: key },
          { trait_type: "Color", value: color }
        ]
      };
      const json = JSON.stringify(metadata);
      return "data:application/json;base64," + btoa(unescape(encodeURIComponent(json)));
    }
    function buildFanSVG(label, color) {
      const safeLabel = escapeHTML(label);
      const safeColor = color || '#eebd6e';
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="800" height="420" viewBox="0 0 800 420">
          <rect width="800" height="420" fill="#050509"/>
          <rect x="20" y="20" width="760" height="380" fill="none" stroke="${safeColor}" stroke-width="2"/>
          <text x="40" y="240" fill="#ffffff" font-size="60" font-family="system-ui">${safeLabel}</text>
        </svg>
      `;
      return "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svg)));
    }
    function initFirebase() {
      try {
        if (!window.firebase) throw new Error("Firebase not loaded");
        fbApp = firebase.initializeApp(firebaseConfig);
        fbDb = firebase.database();
        subscribeMintedOnFirebase();
        subscribeFanTalkOnFirebase();
      } catch (e) {
        console.error(e);
        setStatus("Database error.", "error");
        initialLoader.classList.add('hidden');
      }
    }
    function subscribeMintedOnFirebase() {
      if (!fbDb) return;
      allNftsRef = fbDb.ref('fanNames');
      showCityLoading();
      allNftsRef.once('value', (snapshot) => {
        snapshot.forEach((child) => upsertMintedFan(child.key, child.val()));
        initialLoader.classList.add('hidden');
        hideCityLoading();
        allNftsRef.on('child_added', (snap) => upsertMintedFan(snap.key, snap.val()));
        allNftsRef.on('child_changed', (snap) => upsertMintedFan(snap.key, snap.val()));
        allNftsRef.on('child_removed', (snap) => removeMintedFan(snap.key, snap.val()));
      }, (err) => {
        console.error(err);
        setStatus("Data error.", "error");
        initialLoader.classList.add('hidden');
        hideCityLoading();
      });
    }
    function subscribeFanTalkOnFirebase() {
      if (!fbDb) return;
      fanTalkRef = fbDb.ref('fanTalk');
      fanTalkRef.on('child_added', (snap) => {
        const msg = snap.val();
        if (msg) addMessageToList(msg);
      });
    }
    function upsertMintedFan(tokenId, data) {
      if (!data || !data.meta) return;
      const key = data.meta.fan_key;
      if (!key) return;
      const lower = (data.meta.fan_key_lower || key).toLowerCase();
      const ownerLower = (data.owner || '').toLowerCase();
      const fullData = {
        tokenId,
        owner: ownerLower,
        fan_key: key,
        fan_key_lower: lower,
        nameColor: data.meta.name_color || '#eebd6e',
        mintPricePol: data.meta.mint_price_pol || FIXED_MINT_PRICE_POL,
        createdAt: data.meta.created_at || 0
      };
      nameDataByKey.set(lower, fullData);
      updateCountsAndLeaderboard();
      renderUsernamesTable();
      renderImageGrid();
      if (selectedKey && selectedKey.toLowerCase() === lower) {
        const idx = generatedCards.findIndex(c => c.key === selectedKey);
        if (idx !== -1) selectByIndex(idx);
      }
      updateFanTalkEligibility();
    }
    function removeMintedFan(tokenId, data) {
      if (!data || !data.meta) return;
      const lower = (data.meta.fan_key_lower || data.meta.fan_key || '').toLowerCase();
      if (!lower) return;
      nameDataByKey.delete(lower);
      updateCountsAndLeaderboard();
      renderUsernamesTable();
      renderImageGrid();
      updateFanTalkEligibility();
    }
    async function writeNftToFirebase(tokenId, fullNftData) {
      if (!fbDb) return;
      await fbDb.ref(`fanNames/${tokenId}`).set(fullNftData);
    }
    function getOwnedArts() {
      if (!userAddress) return [];
      const me = userAddress.toLowerCase();
      return Array.from(nameDataByKey.values()).filter(d => d.owner === me).map(d => d.fan_key);
    }
    function updateFanTalkEligibility() {
      const owned = getOwnedArts();
      if (owned.length > 0 && userAddress) {
        fanTalkInput.style.display = 'flex';
      } else {
        fanTalkInput.style.display = 'none';
      }
    }
    async function postMessage() {
      const text = messageInput.value.trim();
      if (!text) return setFanTalkStatus('Empty message.', 'error');
      const owned = getOwnedArts();
      if (owned.length === 0) return setFanTalkStatus('Mint to join.', 'error');
      const artKey = owned[0]; // Pick first owned art
      try {
        await fanTalkRef.push({
          sender: userAddress.toLowerCase(),
          message: text,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          artKey: artKey
        });
        messageInput.value = '';
        setFanTalkStatus('Posted.', 'success');
      } catch (e) {
        console.error(e);
        setFanTalkStatus('Post failed.', 'error');
      }
    }
    function addMessageToList(msg) {
      const div = document.createElement('div');
      div.className = 'message-item';
      const num = parseInt(msg.artKey.slice(8)) || 1;
      const url = generatePixelArt(num);
      const ts = new Date(msg.timestamp).toLocaleString();
      div.innerHTML = `
        <div class="message-avatar"><img src="${escapeHTML(url)}" alt="Avatar" /></div>
        <div class="message-content">
          <div class="message-sender">${shortAddr(msg.sender)}</div>
          <div class="message-text">${escapeHTML(msg.message)}</div>
          <div class="message-timestamp">${ts}</div>
        </div>
      `;
      messagesList.appendChild(div);
      messagesList.scrollTop = messagesList.scrollHeight;
    }
    function updateCountsAndLeaderboard() {
      let myOwnedCount = 0;
      const ownerCounts = {};
      const ownerValues = {};
      if (userAddress) {
        const me = userAddress.toLowerCase();
        for (const data of nameDataByKey.values()) {
          if (data.owner === me) myOwnedCount++;
        }
      }
      if (myOwnedCount > 0) {
        ownedCountPill.style.display = 'inline-flex';
        ownedCountPill.innerHTML = `<span class="material-icons">verified</span><span>You own ${myOwnedCount}</span>`;
      } else {
        ownedCountPill.style.display = 'none';
      }
      const totalMinted = nameDataByKey.size;
      mintedCountPill.style.display = 'inline-flex';
      mintedCountPill.innerHTML = `<span class="material-icons">people</span><span>Total ${totalMinted}</span>`;
      for (const data of nameDataByKey.values()) {
        if (!data.owner) continue;
        ownerCounts[data.owner] = (ownerCounts[data.owner] || 0) + 1;
        ownerValues[data.owner] = (ownerValues[data.owner] || 0) + (data.mintPricePol || FIXED_MINT_PRICE_POL);
      }
      const sorted = Object.entries(ownerCounts).map(([owner, count]) => ({ owner, count, value: ownerValues[owner] })).sort((a, b) => b.count - a.count || b.value - a.value);
      renderLeaderboard(sorted.slice(0, 20));
    }
    function renderLeaderboard(list) {
      leaderboardBody.innerHTML = '';
      if (list.length === 0) {
        leaderboardBody.innerHTML = '<tr><td colspan="4" style="padding:6px;color:#9b7f4a;">None yet.</td></tr>';
        return;
      }
      list.forEach((entry, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="rank-col">${idx + 1}</td>
          <td>${shortAddr(entry.owner)}</td>
          <td class="right">${entry.count}</td>
          <td class="right">${entry.value.toFixed(2)}</td>
        `;
        leaderboardBody.appendChild(tr);
      });
    }
    function renderUsernamesTable() {
      usernamesBody.innerHTML = '';
      if (nameDataByKey.size === 0) {
        usernamesBody.innerHTML = '<tr><td colspan="3" style="padding:6px;color:#9b7f4a;">None yet.</td></tr>';
        return;
      }
      const list = Array.from(nameDataByKey.values()).sort((a, b) => b.createdAt - a.createdAt);
      for (const data of list) {
        const label = displayFanName(data.fan_key);
        const color = data.nameColor || '#eebd6e';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="color:${color};">${escapeHTML(label)}</td>
          <td>${shortAddr(data.owner)}</td>
          <td class="right">${(data.mintPricePol || FIXED_MINT_PRICE_POL).toFixed(2)}</td>
        `;
        usernamesBody.appendChild(tr);
      }
    }
    function generatePixelArt(seed) {
      let currentSeed = seed;
      const canvas = document.createElement('canvas');
      canvas.width = 32;
      canvas.height = 32;
      const ctx = canvas.getContext('2d');
      function srand() {
        currentSeed = (currentSeed * 9301 + 49297) % 233280;
        return currentSeed / 233280;
      }
      ctx.fillStyle = `hsl(${Math.floor(srand() * 360)}, ${Math.floor(50 + srand() * 50)}%, ${Math.floor(30 + srand() * 40)}%)`;
      ctx.fillRect(0, 0, 32, 32);
      const bodyColor = `hsl(${Math.floor(srand() * 360)}, ${Math.floor(50 + srand() * 50)}%, ${Math.floor(40 + srand() * 40)}%)`;
      ctx.fillStyle = bodyColor;
      ctx.beginPath();
      ctx.ellipse(16, 16, 12, 14, 0, 0, 2 * Math.PI);
      ctx.fill();
      const eyeColor = `hsl(${Math.floor(srand() * 360)}, ${Math.floor(50 + srand() * 50)}%, ${Math.floor(20 + srand() * 40)}%)`;
      ctx.fillStyle = eyeColor;
      const eyeOffsetX = 6 + Math.floor(srand() * 4);
      const eyeY = 10 + Math.floor(srand() * 4);
      const eyeSize = 2 + Math.floor(srand() * 3);
      ctx.fillRect(16 - eyeOffsetX - eyeSize / 2, eyeY, eyeSize, eyeSize);
      ctx.fillRect(16 + eyeOffsetX - eyeSize / 2, eyeY, eyeSize, eyeSize);
      const mouthType = Math.floor(srand() * 3);
      ctx.fillStyle = `hsl(${Math.floor(srand() * 360)}, ${Math.floor(50 + srand() * 50)}%, ${Math.floor(20 + srand() * 20)}%)`;
      if (mouthType === 0) {
        ctx.beginPath();
        ctx.arc(16, 22, 6, 0, Math.PI);
        ctx.lineWidth = 2;
        ctx.stroke();
      } else if (mouthType === 1) {
        ctx.fillRect(12, 22, 8, 2);
      } else {
        ctx.beginPath();
        ctx.arc(16, 26, 6, Math.PI, 2 * Math.PI);
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      if (srand() > 0.5) {
        const hatColor = `hsl(${Math.floor(srand() * 360)}, ${Math.floor(50 + srand() * 50)}%, ${Math.floor(30 + srand() * 40)}%)`;
        ctx.fillStyle = hatColor;
        ctx.fillRect(10, 4, 12, 4);
        ctx.fillRect(12, 2, 8, 2);
      }
      if (srand() > 0.5) {
        ctx.fillStyle = bodyColor;
        ctx.beginPath();
        ctx.arc(4, 16, 4, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(28, 16, 4, 0, 2 * Math.PI);
        ctx.fill();
      }
      return canvas.toDataURL();
    }
    function loadMore(count = 20) {
      const start = generatedCards.length + 1;
      for (let i = 0; i < count; i++) {
        const num = start + i;
        const key = `PixelFan${num}`;
        const label = displayFanName(key);
        const url = generatePixelArt(num);
        generatedCards.push({ index: num - 1, key, label, url });
      }
      renderImageGrid();
    }
    function renderImageGrid() {
      imageGrid.innerHTML = '';
      generatedCards.forEach((cardData, i) => {
        const { key, label, url } = cardData;
        const lower = key.toLowerCase();
        const minted = nameDataByKey.has(lower);
        const isSelected = selectedIndex === i;
        const card = document.createElement('div');
        card.className = 'image-card';
        card.dataset.index = String(i);
        if (minted) card.classList.add('minted');
        if (isSelected) card.classList.add('selected');
        const safeUrl = escapeHTML(url || '');
        card.innerHTML = `
          <img src="${safeUrl}" alt="${escapeHTML(label)}" loading="lazy" />
          <div class="image-card-footer">
            <div class="image-card-status ${minted ? 'taken' : 'available'}">
              <span class="material-icons" style="font-size:10px;">${minted ? 'lock' : 'rocket_launch'}</span>
              <span>${minted ? 'Taken' : 'Available'}</span>
            </div>
            <div class="image-card-index">${label}</div>
          </div>
        `;
        if (!minted) {
          card.addEventListener('click', () => selectByIndex(i));
        } else {
          card.style.cursor = 'not-allowed';
        }
        imageGrid.appendChild(card);
      });
    }
    function clearSelection() {
      selectedKey = '';
      selectedIndex = null;
      selectionPill.style.display = 'none';
      document.querySelectorAll('.image-card').forEach(card => card.classList.remove('selected'));
      setStatus('Choose a card.', '');
      updateMintButtonState();
    }
    connectBtn.addEventListener('click', connectWallet);
    mintBtn.addEventListener('click', mintSelectedFan);
    clearBtn.addEventListener('click', clearSelection);
    refreshBtn.addEventListener('click', () => {
      renderImageGrid();
    });
    nameColorInput.addEventListener('input', updateNameColorState);
    imageGridContainer.addEventListener('scroll', () => {
      if (imageGridContainer.scrollTop + imageGridContainer.clientHeight >= imageGridContainer.scrollHeight - 20) {
        loadMore(10);
      }
    });
    postMessageBtn.addEventListener('click', postMessage);
    window.addEventListener('DOMContentLoaded', () => {
      initFirebase();
      loadMore(20);
      setStatus('Connect wallet.', '');
    });
  </script>
</body>
</html>
