<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <title>Subfan Hunter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.11.1/web3.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg,#05060a,#0e1220);
            color: #cce8ff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .container {
            max-width: 420px;
            background: #101420;
            margin: 14px auto;
            padding: 12px;
            border-radius: 14px;
            box-shadow: 0 0 20px #000c;
        }
        h2 {
            font-size: 11px;
            text-align: center;
            color: #6bbaff;
            margin: 0 0 8px 0;
            letter-spacing: 1.2px;
            font-weight: 600;
        }
        .subfan-score-box {
            background: #0d152c;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 12px;
            font-size: 10px;
            position: relative;
            overflow: hidden;
            border: 1px solid #1a2e50;
        }
        .score-label { color: #88c8ff; margin-bottom: 4px; }
        .score-number {
            font-size: 26px;
            font-weight: 800;
            color: #33e6ff;
            text-shadow: 0 0 10px #33e6ff40;
        }
        @keyframes pop {
            0% { transform: scale(0.6); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .wallet-bar {
            background: #0b1222;
            padding: 9px 12px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 9.5px;
            border: 1px solid #1a2a44;
        }
        .wallet-address {
            font-family: monospace;
            color: #88b8ff;
        }
        .connect-btn {
            padding: 7px 12px;
            background: linear-gradient(135deg,#1d4fff,#5e82ff);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-size: 9.5px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 6px #1d4fff50;
        }
        .connect-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .groups-box {
            background: #0c1326;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #1a2e50;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9.5px;
        }
        th, td {
            padding: 8px 4px;
            text-align: center;
            border-bottom: 1px solid #1c2338;
        }
        th {
            color: #7ed6ff;
            font-weight: 600;
            font-size: 9px;
        }
        .status-pending { color: #ffeb7a; }
        .status-done { color: #2fe68d; font-weight: bold; }
        .btn-small {
            background: linear-gradient(135deg,#2080ff,#3aa2ff);
            padding: 6px 10px;
            border-radius: 10px;
            border: none;
            font-size: 9px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 2px 6px #2080ff60;
            min-width: 56px;
        }
        .btn-small:disabled {
            background: #333f66;
            cursor: not-allowed;
            box-shadow: none;
        }

        .progress-section {
            margin-top: 12px;
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 9px;
            background: #0a1020;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #1a2e50;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,#15f2c8,#3572ff);
            transition: width 0.4s ease;
        }
        .status-box {
            margin-top: 8px;
            font-size: 9.8px;
            text-align: center;
            padding: 8px;
            background: #0c1535;
            border-radius: 10px;
            color: #9edbff;
            border: 1px solid #1a2e50;
        }
        .balance-info {
            font-size: 9px;
            text-align: center;
            color: #88c8ff;
            margin: 8px 0;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>SUBFAN HUNTER</h2>

    <div class="subfan-score-box">
        <div class="score-label">Your Subfan Score</div>
        <div id="subdropScore" class="score-number">0</div>
    </div>

    <div class="balance-info" id="nftfanBalance">-</div>

    <div class="wallet-bar">
        <span class="wallet-address" id="walletAddress">Not Connected</span>
        <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect</button>
    </div>

    <div class="groups-box">
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Wallets</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="pendingGroupsBody">
                <tr><td colspan="4" style="color:#88b7ff;">Loading groups...</td></tr>
            </tbody>
        </table>
    </div>

    <div class="progress-section" id="progressSection">
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <div class="status-box" id="progressText">Preparing...</div>
    </div>

    <div class="status-box" id="airdropStatus">Ready</div>
</div>

<script>
    // Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
        authDomain: "newnft-47bd7.firebaseapp.com",
        databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
        projectId: "newnft-47bd7",
        storageBucket: "newnft-47bd7.firebasestorage.app",
        messagingSenderId: "172043823738",
        appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const DISTRIBUTOR_ADDRESS = '0x6Ee372b30C73Dd6087ba58F8C4a5Ca77F49BE0b3';
    const NFTFAN_ADDRESS = '0x2017Fcaea540d2925430586DC92818035Bfc2F50';
    const POLYGON_CHAIN_ID = '0x89';

    const ERC20_ABI = [
        {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
    ];

    const DISTRIBUTOR_ABI = [
        {"inputs":[{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"distributeTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"wallet","type":"address"}],"name":"getSubdropScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"previewDistribution","outputs":[{"internalType":"uint256","name":"successfulDrops","type":"uint256"},{"internalType":"uint256","name":"tokensNeeded","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3, userAccount, distributorContract, nftfanContract;

    async function switchToPolygon() {
        try {
            await ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_ID }] });
        } catch (e) {
            if (e.code === 4902) {
                await ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: POLYGON_CHAIN_ID,
                        chainName: 'Polygon',
                        nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                        rpcUrls: ['https://polygon-rpc.com'],
                        blockExplorerUrls: ['https://polygonscan.com']
                    }]
                });
            }
        }
    }

    async function connectWallet() {
        if (!window.ethereum) { setStatus('MetaMask not found'); return; }
        try {
            await switchToPolygon();
            const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
            userAccount = accounts[0];

            web3 = new Web3(window.ethereum);
            distributorContract = new web3.eth.Contract(DISTRIBUTOR_ABI, DISTRIBUTOR_ADDRESS);
            nftfanContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_ADDRESS);

            document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+'...'+userAccount.slice(-4);
            document.getElementById('connectBtn').textContent = 'Connected';
            document.getElementById('connectBtn').disabled = true;

            await Promise.all([updateScore(), updateBalance(), loadGroups()]);
            setStatus('Connected to Polygon');
        } catch (e) {
            setStatus('Connection rejected');
        }
    }

    async function updateScore() {
        if (!userAccount || !distributorContract) return;
        try {
            const score = await distributorContract.methods.getSubdropScore(userAccount).call();
            const el = document.getElementById('subdropScore');
            el.classList.remove('pop');
            void el.offsetWidth;
            el.classList.add('pop');
            el.textContent = Number(score).toLocaleString();
        } catch (e) {
            document.getElementById('subdropScore').textContent = '0';
        }
    }

    async function updateBalance() {
        if (!userAccount || !nftfanContract) {
            document.getElementById('nftfanBalance').textContent = '- $NFTFAN';
            return;
        }
        try {
            const [bal, dec] = await Promise.all([
                nftfanContract.methods.balanceOf(userAccount).call(),
                nftfanContract.methods.decimals().call()
            ]);
            const formatted = (BigInt(bal) / (10n ** BigInt(dec || 18))).toString();
            document.getElementById('nftfanBalance').textContent = Number(formatted).toLocaleString() + ' $NFTFAN';
        } catch {
            document.getElementById('nftfanBalance').textContent = 'Error';
        }
    }

    async function loadGroups() {
        const snap = await db.ref('wallet_groups').once('value');
        const data = snap.val() || {};
        const keys = Object.keys(data).sort((a,b) => {
            const na = parseInt(a.replace('group_','')) || 0;
            const nb = parseInt(b.replace('group_','')) || 0;
            return na - nb;
        });

        let rows = '';
        let idx = 1;
        for (const key of keys) {
            const g = data[key];
            if (g && g.status !== 'done') {
                const count = (g.wallets || []).filter(w => /^0x[a-fA-F0-9]{40}$/i.test(w)).length;
                if (count > 0) {
                    rows += `
                        <tr>
                            <td>${idx}</td>
                            <td>${count}</td>
                            <td class="status-pending">${g.status || 'pending'}</td>
                            <td><button class="btn-small" onclick="airdropGroup('${key}')">Send</button></td>
                        </tr>`;
                    idx++;
                }
            }
        }
        if (idx === 1) rows = '<tr><td colspan="4" style="color:#88b7ff;">No pending groups</td></tr>';
        document.getElementById('pendingGroupsBody').innerHTML = rows;
    }

    function setStatus(msg) {
        document.getElementById('airdropStatus').textContent = msg;
    }

    function showProgress(show) {
        document.getElementById('progressSection').style.display = show ? 'block' : 'none';
    }

    function updateProgress(pct, text = '') {
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = text || `${pct}%`;
    }

    window.airdropGroup = async function(groupKey) {
        if (!userAccount) { await connectWallet(); if (!userAccount) return; }

        const snap = await db.ref('wallet_groups/' + groupKey).once('value');
        const group = snap.val();
        if (!group || group.status === 'done') { setStatus('Already processed'); return; }

        const wallets = (group.wallets || []).filter(w => /^0x[a-fA-F0-9]{40}$/i.test(w));
        if (wallets.length === 0) { setStatus('No valid wallets'); return; }

        showProgress(true);
        setStatus('Checking allowance...');

        try {
            // Preview
            const preview = await distributorContract.methods.previewDistribution(userAccount, wallets).call({ from: userAccount });
            const needed = BigInt(preview.tokensNeeded || preview[1]);

            const balance = await nftfanContract.methods.balanceOf(userAccount).call();
            if (BigInt(balance) < needed) {
                setStatus('Not enough $NFTFAN');
                showProgress(false);
                return;
            }

            // Approval (MAX_UINT)
            const allowance = await nftfanContract.methods.allowance(userAccount, DISTRIBUTOR_ADDRESS).call();
            if (BigInt(allowance) < needed) {
                updateProgress(20, 'Approving...');
                await nftfanContract.methods.approve(DISTRIBUTOR_ADDRESS, '115792089237316195423570985008687907853269984665640564039457584007913129639935')
                    .send({ from: userAccount });
            }

            updateProgress(60, 'Sending airdrop...');
            await distributorContract.methods.distributeTokens(wallets).send({
                from: userAccount,
                gas: 6000000
            });

            await db.ref('wallet_groups/' + groupKey).update({ status: 'done' });

            updateProgress(100, 'Success!');
            setStatus('Airdrop completed!');
            await Promise.all([updateScore(), updateBalance(), loadGroups()]);

            setTimeout(() => showProgress(false), 1500);

        } catch (e) {
            console.error(e);
            setStatus('Failed: ' + (e.message || 'Tx rejected'));
            showProgress(false);
        }
    }

    // Auto-connect
    window.addEventListener('DOMContentLoaded', async () => {
        if (window.ethereum) {
            const accounts = await ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                userAccount = accounts[0];
                await connectWallet();
            }
        }
        await loadGroups();
        setInterval(loadGroups, 25000);
    });
</script>
</body>
</html>
