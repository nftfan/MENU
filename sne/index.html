
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>NFTFan Share & Claim</title>

  <!-- Fonts and Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet"/>

  <style>
    :root {
      /* Palette */
      --bg: #f6f8fc;
      --surface: #ffffff;
      --surface-2: #f1f3f9;
      --surface-dark: #232b42;
      --bg-dark: #181d26;
      --text: #0b1020;
      --muted: #6b7280;
      --border: #e5e7eb;
      --primary: #5469d4;
      --primary-600: #4559bb;
      --success: #0cce6b;
      --error: #ef4444;
      --accent: #8247e5;
      --purple: #8b6ee6;
      --gold: #f0b86e;

      /* Radii */
      --r-lg: 14px;
      --r-md: 10px;

      /* Safe areas */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 11px;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* App Bar */
    .appbar {
      position: sticky;
      top: 0;
      z-index: 10;
      padding: calc(8px + var(--safe-top)) 14px 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #eaedf5;
      background: #fff;
      flex-shrink: 0;
    }
    .app-title {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .app-title .name {
      font-weight: 700;
      font-size: 11px;
      letter-spacing: -0.01em;
    }
    .app-title .subtitle {
      font-size: 10px;
      color: var(--muted);
    }

    /* Content */
    .container {
      padding: 12px 14px calc(14px + var(--safe-bottom));
      max-width: 520px;
      margin: 0 auto;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r-lg);
      padding: 12px;
      margin-bottom: 12px;
    }

    /* Status chip */
    .status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--muted);
      font-size: 10px;
    }
    .status-chip .material-icons-round {
      font-size: 16px;
      color: var(--muted);
    }
    .status-chip.online {
      color: #0a7a51;
      border-color: #c7f1e1;
      background: #e9fbf3;
    }
    .status-chip.online .material-icons-round { color: #0a7a51; }

    .amount {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin: 2px 0 2px;
    }
    .amount .num {
      font-weight: 800;
      font-size: 11px;
      letter-spacing: -0.01em;
    }
    .amount .ticker {
      font-weight: 700;
      color: var(--primary);
      font-size: 10px;
    }
    .hint {
      font-size: 10px;
      color: var(--muted);
    }

    /* Inputs */
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .label {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .label .material-icons-round {
      font-size: 16px;
      color: var(--primary);
    }
    .input-wrap {
      position: relative;
    }
    /* Important: 16px to avoid iOS zoom on focus */
    .input {
      width: 100%;
      height: 40px;
      border: 1px solid var(--border);
      border-radius: var(--r-md);
      background: #fff;
      padding: 0 36px 0 34px;
      font-size: 16px;
      line-height: 1;
      outline: none;
      transition: box-shadow .15s ease, border-color .15s ease;
      color: var(--text);
    }
    .input::placeholder { color: #9aa3b2; opacity: 1; }
    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(84, 105, 212, .15);
    }
    /* Visually reduce without triggering zoom by scaling text inside using text-rendering tricks */
    .input,
    .input::placeholder {
      letter-spacing: 0.2px;
    }
    .input-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--primary);
      font-size: 18px;
      pointer-events: none;
    }
    .clear-btn {
      position: absolute;
      right: 6px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #9aa3b2;
      padding: 4px;
      border-radius: 8px;
      cursor: pointer;
    }

    /* Buttons */
    .btn {
      width: 100%;
      height: 40px;
      border: none;
      border-radius: var(--r-md);
      font-weight: 800;
      font-size: 11px;
      letter-spacing: 0.01em;
      color: #fff;
      background: var(--primary);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: background .15s ease, opacity .15s ease, transform .05s ease;
      margin-top: 8px;
    }
    .btn .material-icons-round { font-size: 18px; }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: .7; cursor: not-allowed; }
    .btn:hover:not(:disabled) { background: var(--primary-600); }
    .btn.secondary {
      background: var(--surface-2);
      color: var(--accent);
      border: 1px solid var(--border);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      background: var(--surface-2);
      color: var(--primary);
      border: none;
      border-radius: var(--r-md);
      padding: 7px 0;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--primary);
      color: #fff;
    }

    /* Tweet Preview */
    .tweet-preview {
      background: #1e2536;
      color: #fff;
      font-family: monospace;
      border-radius: var(--r-md);
      padding: 12px;
      margin: 12px 0;
      font-size: 10px;
      line-height: 1.4;
      word-break: break-word;
    }

    /* Steps */
    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.01em;
      margin-bottom: 8px;
    }
    .section-title .material-icons-round {
      font-size: 16px;
      color: var(--accent);
    }

    .steps {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }
    .step {
      display: grid;
      grid-template-columns: 26px 1fr;
      gap: 8px;
      align-items: start;
    }
    .step-index {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      display: grid;
      place-items: center;
      font-weight: 800;
      color: var(--primary);
      font-size: 10px;
    }
    .step-body { display: flex; flex-direction: column; gap: 2px; }
    .step-title {
      font-weight: 700;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .step-title .material-icons-round { font-size: 16px; color: var(--primary); }
    .step-text {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.35;
    }

    /* Leaderboard */
    .leaderboard-list {
      margin: 0 0 10px 0;
      border-radius: var(--r-md);
      background: var(--surface-2);
      padding: 5px;
    }
    .lb-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }
    .lb-item:last-child {
      border-bottom: none;
    }
    .lb-rank {
      color: var(--gold);
      font-weight: 700;
      width: 24px;
    }
    .lb-user {
      color: var(--primary);
      font-weight: 600;
      flex: 1;
    }
    .lb-score {
      color: var(--success);
      font-weight: 600;
      width: 60px;
      text-align: right;
    }

    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 9px;
      background: #f2f5fb;
      border: 1px solid var(--border);
      padding: 1px 4px;
      border-radius: 6px;
    }

    /* Promo image */
    .promo {
      width: 100%;
      display: block;
      margin-top: 8px;
      border-radius: var(--r-md);
      border: 1px solid var(--border);
    }

    /* Toast / Snackbar */
    .toast {
      position: fixed;
      left: 50%;
      bottom: calc(10px + var(--safe-bottom));
      transform: translateX(-50%) translateY(120%);
      z-index: 70;
      width: min(96%, 520px);
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      transition: transform .25s ease, opacity .25s ease;
      opacity: 0;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0%);
      opacity: 1;
    }
    .toast .icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: grid;
      place-items: center;
      background: #eef1ff;
      color: var(--primary);
    }
    .toast.success .icon { background: #e9fbf3; color: #067a43; }
    .toast.error .icon { background: #ffeaea; color: #a11b1b; }
    .toast .material-icons-round { font-size: 18px; }
    .toast .content {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .toast .title {
      font-weight: 800;
      font-size: 11px;
    }
    .toast .desc {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.3;
      word-break: break-word;
    }
    .toast .action {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: #0a7bc1;
      font-weight: 700;
      font-size: 10px;
      text-decoration: none;
      white-space: nowrap;
    }

    /* Spinner */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2.5px solid rgba(255,255,255,0.35);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Progress flow */
    .progress-flow {
      display: flex;
      align-items: center;
      margin: 14px 0;
    }
    .progress-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
    }
    .progress-step::after {
      content: '';
      position: absolute;
      top: 14px;
      right: 50%;
      width: 100%;
      height: 2px;
      background: var(--border);
      z-index: -1;
    }
    .progress-step:first-child::after {
      display: none;
    }
    .progress-step:last-child::after {
      display: none;
    }
    .progress-step.completed .progress-icon {
      background: var(--success);
      color: white;
      border-color: var(--success);
    }
    .progress-step.active .progress-icon {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .progress-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface-2);
      color: var(--muted);
      display: grid;
      place-items: center;
    }
    .progress-icon .material-icons-round {
      font-size: 14px;
    }
    .progress-label {
      font-size: 9px;
      font-weight: 600;
      margin-top: 4px;
      color: var(--muted);
      text-align: center;
    }
    .progress-step.completed .progress-label,
    .progress-step.active .progress-label {
      color: var(--text);
    }

    /* Celebration (falling rotating token logos) */
    #celebrateLayer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 60;
    }
    .confetti {
      position: absolute;
      top: -40px;
      will-change: transform;
      opacity: 0.95;
    }
    .confetti .inner {
      display: block;
      will-change: transform;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.12));
    }
    @keyframes fall {
      0% { transform: translate3d(0, -20vh, 0); }
      100% { transform: translate3d(var(--dx, 0px), 110vh, 0); }
    }
    @keyframes spin3d {
      from { transform: rotate3d(0.2, 0.6, 0.1, 0deg); }
      to   { transform: rotate3d(0.2, 0.6, 0.1, 360deg); }
    }
  </style>
</head>
<body>
  <!-- App Bar -->
  <header class="appbar">
    <img class="logo" src="https://pbs.twimg.com/media/GxsIpeHW8AAB7Zq?format=jpg&name=900x900" alt="$NFTFAN Logo"/>
    <div class="app-title">
      <span class="name">NFTFan Share & Claim</span>
      <span class="subtitle">Earn 1B $NFTFAN Tokens</span>
    </div>
  </header>

  <!-- Celebration layer -->
  <div id="celebrateLayer" aria-hidden="true"></div>

  <!-- Main content (starts at top) -->
  <main class="container">
    <!-- Login View -->
    <div id="loginView">
      <div class="card">
        <div class="section-title">
          <span class="material-icons-round">login</span>
          Login with X
        </div>
        <form id="loginForm">
          <div class="field">
            <label class="label" for="usernameInput">
              <span class="material-icons-round">alternate_email</span>
              Your X Username
            </label>
            <div class="input-wrap">
              <span class="material-icons-round input-icon">person</span>
              <input type="text" id="usernameInput" class="input" placeholder="@username" autocomplete="username" required>
              <button type="button" id="clearUsername" class="clear-btn" aria-label="Clear">
                <span class="material-icons-round">close</span>
              </button>
            </div>
          </div>
          <button type="submit" class="btn">
            <span class="material-icons-round">login</span>
            Login to Continue
          </button>
        </form>
        <p class="hint" style="margin-top:12px;text-align:center;">
          Login to share a tweet and earn 1B $NFTFAN tokens
        </p>
      </div>
    </div>

    <!-- Main Application View (after login) -->
    <div id="mainView" style="display:none;">
      <!-- User Status and Progress -->
      <div class="card">
        <div class="status-row">
          <div class="status-chip online">
            <span class="material-icons-round">person</span>
            <span id="userStatusText">@username</span>
          </div>
          <div class="status-chip" id="serverStatus">
            <span class="material-icons-round">cloud_sync</span>
            <span id="serverStatusText">Checking...</span>
          </div>
        </div>

        <div class="amount">
          <div class="num">1,000,000,000</div>
          <div class="ticker">$NFTFAN</div>
        </div>
        <div class="hint">To claim after sharing a tweet</div>

        <!-- Progress Flow -->
        <div class="progress-flow">
          <div class="progress-step" id="stepLogin">
            <div class="progress-icon">
              <span class="material-icons-round">login</span>
            </div>
            <div class="progress-label">Login</div>
          </div>
          <div class="progress-step" id="stepShare">
            <div class="progress-icon">
              <span class="material-icons-round">share</span>
            </div>
            <div class="progress-label">Share</div>
          </div>
          <div class="progress-step" id="stepClaim">
            <div class="progress-icon">
              <span class="material-icons-round">redeem</span>
            </div>
            <div class="progress-label">Claim</div>
          </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
          <button class="tab-btn active" id="tabShare">Share</button>
          <button class="tab-btn" id="tabClaim">Claim</button>
          <button class="tab-btn" id="tabLeaderboard">Leaderboard</button>
        </div>
      </div>

      <!-- Share Tab Content -->
      <div id="tabShareContent">
        <div class="card">
          <div class="section-title">
            <span class="material-icons-round">share</span>
            Share on X to Earn Tokens
          </div>
          <div class="hint" style="color:var(--gold);margin-bottom:8px;">Share this tweet (usernames auto-inserted):</div>
          <div class="tweet-preview" id="tweetPreview">Loading tweet...</div>
          <button class="btn" id="shareBtn">
            <span class="material-icons-round">share</span>
            Share on X
          </button>
          <div class="hint" id="cooldownMsg" style="color:var(--gold);text-align:center;margin-top:8px;display:none;"></div>
          <div class="hint" id="successMsg" style="color:var(--success);text-align:center;margin-top:8px;display:none;"></div>
        </div>
      </div>

      <!-- Claim Tab Content -->
      <div id="tabClaimContent" style="display:none;">
        <div class="card">
          <div class="section-title">
            <span class="material-icons-round">redeem</span>
            Claim Your Tokens
          </div>
          <div class="hint" style="margin-bottom:8px;">Enter your wallet address to receive tokens:</div>

          <!-- Wallet input -->
          <div class="field">
            <label class="label" for="wallet">
              <span class="material-icons-round">account_balance_wallet</span>
              Wallet Address
            </label>
            <div class="input-wrap">
              <span class="material-icons-round input-icon">wallet</span>
              <input id="wallet" class="input" type="text" inputmode="text" autocomplete="off" placeholder="0x0000... (Polygon/MATIC)"/>
              <button id="clearWallet" class="clear-btn" aria-label="Clear">
                <span class="material-icons-round">close</span>
              </button>
            </div>
          </div>

          <button id="claimBtn" class="btn">
            <span class="material-icons-round">redeem</span>
            <span>Claim 1B Tokens</span>
          </button>

          <div class="hint" style="margin-top:8px;text-align:center;" id="claimStatus"></div>
          
          <div class="step">
            <div class="step-index">i</div>
            <div class="step-body">
              <div class="step-text">
                <b>Network:</b> Polygon (MATIC)<br>
                <b>Contract:</b> <span id="contractAddress" class="inline-code" title="Tap to copy">0x2017fcaea540d2925430586dc92818035bfc2f50</span><br>
                <span class="hint">Tap to copy address</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Steps Card -->
        <div class="card">
          <div class="section-title">
            <span class="material-icons-round">route</span>
            How It Works
          </div>
          <ol class="steps">
            <li class="step">
              <div class="step-index">1</div>
              <div class="step-body">
                <div class="step-title">
                  <span class="material-icons-round">share</span>
                  Share a Tweet
                </div>
                <div class="step-text">
                  Share the provided tweet on X to qualify for token claiming.
                </div>
              </div>
            </li>
            <li class="step">
              <div class="step-index">2</div>
              <div class="step-body">
                <div class="step-title">
                  <span class="material-icons-round">wallet</span>
                  Enter Your Wallet
                </div>
                <div class="step-text">
                  Enter your Polygon (MATIC) wallet address to receive tokens.
                </div>
              </div>
            </li>
            <li class="step">
              <div class="step-index">3</div>
              <div class="step-body">
                <div class="step-title">
                  <span class="material-icons-round">token</span>
                  Claim Tokens
                </div>
                <div class="step-text">
                  Complete the process to receive 1B $NFTFAN tokens directly to your wallet.
                </div>
              </div>
            </li>
          </ol>
        </div>
      </div>

      <!-- Leaderboard Tab Content -->
      <div id="tabLeaderboardContent" style="display:none;">
        <div class="card">
          <div class="section-title">
            <span class="material-icons-round">leaderboard</span>
            Top Contributors
          </div>
          <div id="leaderboardList" class="leaderboard-list">
            <div style="text-align:center;padding:10px;color:var(--muted);">Loading leaderboard...</div>
          </div>
          
          <div class="hint" style="text-align:center;margin-top:4px;">
            <div>Your Shares: <span id="userShareCount">0</span></div>
            <div>Your Tokens: <span id="userTokenCount">0</span>T</div>
          </div>
        </div>
      </div>

      <!-- Footer with Logout -->
      <button class="btn secondary" id="logoutBtn">
        <span class="material-icons-round">logout</span>
        Logout
      </button>
    </div>
  </main>

  <!-- Toast / Snackbar -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="icon"><span class="material-icons-round">notifications</span></div>
    <div class="content">
      <div class="title" id="toastTitle">Notification</div>
      <div class="desc" id="toastDesc">Details</div>
    </div>
    <a id="toastAction" class="action" href="#" target="_blank" rel="noopener" style="display:none;">
      <span class="material-icons-round">open_in_new</span>
      <span>Open</span>
    </a>
  </div>

  <!-- Firebase Scripts -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
      authDomain: "nftfanactive.firebaseapp.com",
      databaseURL: "https://nftfanactive-default-rtdb.firebaseio.com",
      projectId: "nftfanactive",
      storageBucket: "nftfanactive.appspot.com",
      messagingSenderId: "311309982791",
      appId: "1:311309982791:web:3e55bba6b78feb57ea6562"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Constants
    const TWEET_TEMPLATE = `NFTFans Token @nftfanstoken: Shoutout to {usernames} ! Earn free $NFTFAN tokens. Claim 1B free $NFTFAN TOKENS without any gas fee. Claim here: https://www.nftfanstoken.com/sne`;
    const TOKENS_PER_SHARE = 10;
    const TWEET_COOLDOWN_MINUTES = 30;
    const CLAIM_COOLDOWN_HOURS = 6;
    const CONTRACT_ADDRESS = '0x2017fcaea540d2925430586dc92818035bfc2f50';
    const TOKEN_IMG = 'https://pbs.twimg.com/media/GxsIpeHW8AAB7Zq?format=jpg&name=900x900';
    const SEND_ENDPOINT = 'https://us-central1-autosend-c64ee.cloudfunctions.net/sendToken';

    // UI Elements
    const loginView = document.getElementById('loginView');
    const mainView = document.getElementById('mainView');
    const usernameInput = document.getElementById('usernameInput');
    const clearUsernameBtn = document.getElementById('clearUsername');
    const loginForm = document.getElementById('loginForm');
    const logoutBtn = document.getElementById('logoutBtn');
    const userStatusText = document.getElementById('userStatusText');
    const serverStatus = document.getElementById('serverStatus');
    const serverStatusText = document.getElementById('serverStatusText');
    const tweetPreview = document.getElementById('tweetPreview');
    const shareBtn = document.getElementById('shareBtn');
    const cooldownMsg = document.getElementById('cooldownMsg');
    const successMsg = document.getElementById('successMsg');
    const walletInput = document.getElementById('wallet');
    const clearWalletBtn = document.getElementById('clearWallet');
    const claimBtn = document.getElementById('claimBtn');
    const claimStatus = document.getElementById('claimStatus');
    const contractAddressEl = document.getElementById('contractAddress');
    const leaderboardList = document.getElementById('leaderboardList');
    const userShareCount = document.getElementById('userShareCount');
    const userTokenCount = document.getElementById('userTokenCount');

    // Tabs
    const tabShare = document.getElementById('tabShare');
    const tabClaim = document.getElementById('tabClaim');
    const tabLeaderboard = document.getElementById('tabLeaderboard');
    const tabShareContent = document.getElementById('tabShareContent');
    const tabClaimContent = document.getElementById('tabClaimContent');
    const tabLeaderboardContent = document.getElementById('tabLeaderboardContent');

    // Progress steps
    const stepLogin = document.getElementById('stepLogin');
    const stepShare = document.getElementById('stepShare');
    const stepClaim = document.getElementById('stepClaim');

    // Toast
    const toast = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastDesc = document.getElementById('toastDesc');
    const toastAction = document.getElementById('toastAction');

    // Celebration
    const celebrateLayer = document.getElementById('celebrateLayer');

    // App state
    let currentUser = null;
    let assignedGroupId = null;
    let assignedUsernames = [];
    let hasShared = false;

    // ===== HELPER FUNCTIONS =====

    // Toast notifications
    function showToast({ type = 'info', title = 'Notification', desc = '', actionText = '', actionUrl = '' } = {}) {
      toast.classList.remove('success', 'error');
      if (type === 'success') toast.classList.add('success');
      if (type === 'error') toast.classList.add('error');
      toastTitle.textContent = title;
      toastDesc.innerHTML = desc;
      if (actionText && actionUrl) {
        toastAction.style.display = 'inline-flex';
        toastAction.innerHTML = '<span class="material-icons-round">open_in_new</span><span>' + actionText + '</span>';
        toastAction.href = actionUrl;
      } else {
        toastAction.style.display = 'none';
        toastAction.href = '#';
      }
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.classList.remove('show'), 5000);
    }

    // Format wallet address
    function short(addr) {
      return addr ? addr.slice(0, 6) + '...' + addr.slice(-4) : '';
    }

    // Format time remaining
    function formatRemaining(ms) {
      const s = Math.ceil(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${sec}s`;
      return `${sec}s`;
    }

    // Get storage keys
    function getLastShareKey() {
      if (!currentUser) return null;
      return `nftfans-share-lastshare-${currentUser.replace('@','')}`;
    }

    function getScoreKey() {
      if (!currentUser) return null;
      return `nftfans-share-score-${currentUser.replace('@','')}`;
    }

    function getLastClaimKey() {
      if (!currentUser) return null;
      return `nftfans-claim-lastclaim-${currentUser.replace('@','')}`;
    }

    // Check tweet cooldown
    function checkTweetCooldown() {
      const lastShare = Number(localStorage.getItem(getLastShareKey())) || 0;
      const now = Date.now();
      if (lastShare && (now - lastShare < TWEET_COOLDOWN_MINUTES * 60 * 1000)) {
        const mins = Math.ceil((TWEET_COOLDOWN_MINUTES * 60 * 1000 - (now - lastShare)) / 60000);
        cooldownMsg.textContent = `You can share again in ${mins} minutes.`;
        cooldownMsg.style.display = '';
        shareBtn.disabled = true;
        return true;
      }
      shareBtn.disabled = false;
      cooldownMsg.style.display = 'none';
      return false;
    }

    // Check claim cooldown
    function checkClaimCooldown() {
      const lastClaim = Number(localStorage.getItem(getLastClaimKey())) || 0;
      const now = Date.now();
      if (lastClaim && (now - lastClaim < CLAIM_COOLDOWN_HOURS * 3600 * 1000)) {
        const remain = CLAIM_COOLDOWN_HOURS * 3600 * 1000 - (now - lastClaim);
        claimStatus.textContent = `You can claim again in ${formatRemaining(remain)}`;
        claimStatus.style.color = 'var(--gold)';
        claimBtn.disabled = true;
        return true;
      }
      claimBtn.disabled = !hasShared;
      if (!hasShared) {
        claimStatus.textContent = "Share a tweet first to activate claiming";
        claimStatus.style.color = 'var(--error)';
      } else {
        claimStatus.textContent = "Ready to claim your tokens!";
        claimStatus.style.color = 'var(--success)';
      }
      return false;
    }

    // Update user stats display
    function updateUserStats() {
      const shares = Number(localStorage.getItem(getScoreKey()) || "0");
      userShareCount.textContent = shares;
      userTokenCount.textContent = (shares * TOKENS_PER_SHARE);
    }

    // Check server status
    async function checkServerStatus() {
      try {
        const res = await fetch(SEND_ENDPOINT);
        const data = await res.json().catch(() => ({}));
        if (data && data.status === 'online') {
          serverStatus.classList.add('online');
          serverStatusText.textContent = 'Server Online';
        } else {
          serverStatus.classList.remove('online');
          serverStatusText.textContent = 'Server Offline';
        }
      } catch {
        serverStatus.classList.remove('online');
        serverStatusText.textContent = 'Server Offline';
      }
    }

    // Copy contract address
    function copyContract(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast({ type: 'success', title: 'Copied', desc: 'Contract address copied to clipboard' });
      }).catch(() => {
        showToast({ type: 'error', title: 'Copy failed', desc: 'Please copy the address manually' });
      });
    }

    // Celebration effect
    function dropCelebration(count = 48) {
      const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      for (let i = 0; i < count; i++) {
        const wrap = document.createElement('div');
        wrap.className = 'confetti';
        const img = document.createElement('img');
        img.className = 'inner';
        img.src = TOKEN_IMG;
        img.alt = 'NFTFAN';

        // Randomize sizes and positions
        const size = Math.floor(18 + Math.random() * 16); // 18-34px
        const left = Math.random() * (vw - size);
        const dx = (Math.random() * 160 - 80).toFixed(1); // -80..80px drift
        const dur = (3 + Math.random() * 3).toFixed(2);   // 3..6s
        const delay = (Math.random() * 0.8).toFixed(2);   // 0..0.8s
        const spinDur = (1.6 + Math.random() * 1.8).toFixed(2); // 1.6..3.4s

        wrap.style.left = `${left}px`;
        wrap.style.setProperty('--dx', `${dx}px`);
        wrap.style.animation = `fall ${dur}s linear ${delay}s forwards`;
        img.style.width = `${size}px`;
        img.style.height = 'auto';
        img.style.animation = `spin3d ${spinDur}s linear infinite`;

        wrap.appendChild(img);
        celebrateLayer.appendChild(wrap);

        // Cleanup after animation
        const ttl = (parseFloat(dur) + parseFloat(delay) + 0.5) * 1000;
        setTimeout(() => {
          wrap.remove();
        }, ttl);
      }
    }

    // ===== APP FUNCTIONALITY =====

    // Initialize the app
    function initApp() {
      // Check for saved user
      const savedUser = localStorage.getItem('nftfans-currentUser');
      if (savedUser) {
        currentUser = savedUser;
        loginUser(currentUser);
      }

      // Setup listeners for tabs
      tabShare.addEventListener('click', () => {
        tabShare.classList.add('active');
        tabClaim.classList.remove('active');
        tabLeaderboard.classList.remove('active');
        tabShareContent.style.display = '';
        tabClaimContent.style.display = 'none';
        tabLeaderboardContent.style.display = 'none';
      });

      tabClaim.addEventListener('click', () => {
        tabShare.classList.remove('active');
        tabClaim.classList.add('active');
        tabLeaderboard.classList.remove('active');
        tabShareContent.style.display = 'none';
        tabClaimContent.style.display = '';
        tabLeaderboardContent.style.display = 'none';
        checkClaimCooldown();
      });

      tabLeaderboard.addEventListener('click', () => {
        tabShare.classList.remove('active');
        tabClaim.classList.remove('active');
        tabLeaderboard.classList.add('active');
        tabShareContent.style.display = 'none';
        tabClaimContent.style.display = 'none';
        tabLeaderboardContent.style.display = '';
        renderLeaderboard();
      });

      // Clear buttons
      clearUsernameBtn.addEventListener('click', () => {
        usernameInput.value = '';
        usernameInput.focus();
      });

      clearWalletBtn.addEventListener('click', () => {
        walletInput.value = '';
        walletInput.focus();
      });

      // Copy contract
      contractAddressEl.addEventListener('click', () => copyContract(CONTRACT_ADDRESS));

      // Hide toast on click
      toast.addEventListener('click', () => toast.classList.remove('show'));
      
      // Login form submission
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const username = usernameInput.value.trim();
        if (!/^@[A-Za-z0-9_]{2,32}$/.test(username)) {
          showToast({ type: 'error', title: 'Invalid Username', desc: 'Please enter a valid X username starting with @' });
          return;
        }
        currentUser = username;
        localStorage.setItem('nftfans-currentUser', currentUser);
        loginUser(currentUser);
      });

      // Share button
      shareBtn.addEventListener('click', handleShare);

      // Claim button
      claimBtn.addEventListener('click', handleClaim);

      // Logout button
      logoutBtn.addEventListener('click', () => {
        currentUser = null;
        localStorage.removeItem('nftfans-currentUser');
        loginView.style.display = '';
        mainView.style.display = 'none';
      });

      // Check server status periodically
      checkServerStatus();
      setInterval(checkServerStatus, 30000);
    }

    // Login user
    function loginUser(username) {
      currentUser = username;
      userStatusText.textContent = currentUser;
      
      // Update UI
      loginView.style.display = 'none';
      mainView.style.display = '';
      
      // Update progress
      stepLogin.classList.add('completed');
      stepShare.classList.add('active');

      // Fetch tweet content
      fetchTweetUsernames();
      
      // Check if user has already shared
      const lastShare = Number(localStorage.getItem(getLastShareKey())) || 0;
      if (lastShare) {
        hasShared = true;
        stepShare.classList.add('completed');
        stepClaim.classList.add('active');
      }
      
      // Update user stats
      updateUserStats();
    }

    // Fetch usernames for tweet
    async function fetchTweetUsernames() {
      tweetPreview.textContent = "Loading...";
      cooldownMsg.style.display = 'none';
      successMsg.style.display = 'none';
      shareBtn.disabled = true;
      
      if (checkTweetCooldown()) return;
      
      try {
        // Find a group with status=pending and not assigned
        const snapshot = await get(ref(db, 'groups'));
        const allGroups = snapshot.val() || {};
        
        let foundGroup = null;
        for (const groupId in allGroups) {
          const group = allGroups[groupId];
          if (group.status === 'pending' && !group.assignedTo) {
            foundGroup = { groupId, group };
            break;
          }
        }
        
        if (!foundGroup) {
          tweetPreview.textContent = "No usernames available right now. Please try again later.";
          shareBtn.disabled = true;
          return;
        }
        
        // Assign group to user
        const { groupId, group } = foundGroup;
        await update(ref(db, 'groups/' + groupId), { assignedTo: currentUser });
        
        assignedGroupId = groupId;
        assignedUsernames = (group.usernames || []).map(u => decodeURIComponent(u));
        
        // Generate tweet text
        const tweet = TWEET_TEMPLATE.replace("{usernames}", assignedUsernames.join(' '));
        tweetPreview.textContent = tweet;
        shareBtn.disabled = false;
      } catch (e) {
        console.error("Error fetching usernames:", e);
        tweetPreview.textContent = "Error loading usernames. Please try again.";
        shareBtn.disabled = true;
      }
    }

    // Handle tweet sharing
    async function handleShare() {
      if (!assignedGroupId || assignedUsernames.length < 3) {
        showToast({ type: 'error', title: 'Error', desc: 'No usernames available. Try refreshing the page.' });
        return;
      }
      
      if (checkTweetCooldown()) return;
      
      cooldownMsg.style.display = 'none';
      successMsg.style.display = 'none';
      
      const tweet = TWEET_TEMPLATE.replace("{usernames}", assignedUsernames.join(' '));
      window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(tweet)}`, "_blank");
      
      try {
        // Mark group as done
        await update(ref(db, 'groups/' + assignedGroupId), { status: "done" });
        
        // Update local storage
        localStorage.setItem(getLastShareKey(), Date.now().toString());
        
        // Update share count
        let shareCount = Number(localStorage.getItem(getScoreKey()) || "0") + 1;
        localStorage.setItem(getScoreKey(), shareCount.toString());
        updateUserStats();
        
        // Update leaderboard
        await set(ref(db, 'tweetLeaderboard/' + encodeURIComponent(currentUser)), {
          username: currentUser,
          shares: shareCount,
          tokens: shareCount * TOKENS_PER_SHARE
        });
        
        // Update UI
        successMsg.textContent = `Tweet shared! You can now claim your 1B tokens.`;
        successMsg.style.display = '';
        shareBtn.disabled = true;
        
        // Set shared flag
        hasShared = true;
        stepShare.classList.add('completed');
        stepClaim.classList.add('active');
        
        // Show notification
        showToast({ 
          type: 'success', 
          title: 'Tweet Shared!', 
          desc: 'You can now claim your 1B tokens. Switch to the Claim tab.'
        });
        
        // Refresh tweet content after delay
        setTimeout(fetchTweetUsernames, 500);
        
      } catch (e) {
        console.error("Error updating share status:", e);
        showToast({ type: 'error', title: 'Error', desc: 'Failed to update share status. Please try again.' });
      }
    }

    // Handle token claiming
    async function handleClaim() {
      const wallet = walletInput.value.trim();
      
      if (!hasShared) {
        showToast({ type: 'error', title: 'Share Required', desc: 'Please share a tweet first before claiming tokens.' });
        return;
      }
      
      if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
        showToast({
          type: 'error',
          title: 'Invalid Address',
          desc: 'Please enter a valid Polygon wallet address starting with 0x'
        });
        return;
      }
      
      if (checkClaimCooldown()) return;
      
      // Update UI
      claimBtn.disabled = true;
      const prevHTML = claimBtn.innerHTML;
      claimBtn.innerHTML = '<span class="spinner"></span><span>Processing...</span>';
      
      try {
        // Get last claim for wallet
        const claimSnapshot = await get(ref(db, `claims/${wallet}`));
        let lastTs = 0;
        let count = 0;
        if (claimSnapshot.exists()) {
          const val = claimSnapshot.val() || {};
          lastTs = val.timestamp || 0;
          count = val.count || 0;
        }
        
        const now = Date.now();
        const elapsed = now - lastTs;
        
        if (elapsed < CLAIM_COOLDOWN_HOURS * 3600 * 1000) {
          const remain = CLAIM_COOLDOWN_HOURS * 3600 * 1000 - elapsed;
          showToast({
            type: 'error',
            title: 'Claim Limit Reached',
            desc: `You can claim again in ${formatRemaining(remain)}.`
          });
          return;
        }
        
        // Show processing notification
        showToast({
          title: 'Sending Tokens',
          desc: `Sending 1B $NFTFAN to ${short(wallet)}...`
        });
        
        // Call API endpoint
        const res = await fetch(SEND_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: wallet })
        });
        
        const json = await res.json().catch(() => ({ success: false }));
        
        if (json.success) {
          const tx = json.txHash || '';
          
          // Save claim record
          await set(ref(db, `claims/${wallet}`), {
            timestamp: now,
            username: currentUser,
            count: count + 1,
            lastTx: tx
          });
          
          // Update local storage
          localStorage.setItem(getLastClaimKey(), now.toString());
          
          // Update progress
          stepClaim.classList.add('completed');
          
          // Show success and celebration
          showToast({
            type: 'success',
            title: 'Tokens Claimed!',
            desc: '1B $NFTFAN tokens are on the way to your wallet.',
            actionText: 'View Transaction',
            actionUrl: tx ? `https://polygonscan.com/tx/${tx}` : '#'
          });
          
          dropCelebration(64);
          claimStatus.textContent = "Tokens sent to your wallet!";
          claimStatus.style.color = 'var(--success)';
          
        } else {
          showToast({
            type: 'error',
            title: 'Transfer Failed',
            desc: json.error || 'Please check your wallet address and try again.'
          });
          claimStatus.textContent = "Transaction failed. Please try again.";
          claimStatus.style.color = 'var(--error)';
        }
      } catch (e) {
        console.error("Error claiming tokens:", e);
        showToast({
          type: 'error',
          title: 'Network Error',
          desc: 'Failed to process your request. Please try again.'
        });
      } finally {
        // Restore button state
        claimBtn.disabled = false;
        claimBtn.innerHTML = prevHTML;
        checkClaimCooldown();
      }
    }

    // Render leaderboard
    async function renderLeaderboard() {
      leaderboardList.innerHTML = '<div style="text-align:center;padding:10px;color:var(--muted);">Loading leaderboard...</div>';
      
      try {
        const snapshot = await get(ref(db, 'tweetLeaderboard'));
        const all = snapshot.val() || {};
        
        let users = Object.values(all);
        users.sort((a, b) => (b.shares || 0) - (a.shares || 0));
        
        if (users.length === 0) {
          leaderboardList.innerHTML = '<div style="text-align:center;padding:10px;color:var(--muted);">No entries yet</div>';
          return;
        }
        
        let html = '';
        users.slice(0, 100).forEach((user, idx) => {
          html += `<div class="lb-item">
            <div class="lb-rank">#${idx + 1}</div>
            <div class="lb-user">${user.username}</div>
            <div class="lb-score">${user.tokens || 0}T</div>
          </div>`;
        });
        
        leaderboardList.innerHTML = html;
      } catch (e) {
        console.error("Error loading leaderboard:", e);
        leaderboardList.innerHTML = '<div style="text-align:center;padding:10px;color:var(--error);">Failed to load leaderboard</div>';
      }
    }

    // Initialize app on load
    initApp();
  </script>
</body>
</html>
