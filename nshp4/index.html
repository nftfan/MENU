<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NFTFANS ERC1155 Shop (Crypto Theme Minimal)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, 'Inter', Arial, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      font-size: 10px;
    }
    body {
      background: #000;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 7px 0 24px 0;
    }
    .header {
      background-color: #111;
      padding: 10px 5px 10px 7px;
      font-weight: bold;
      font-size: 12px;
      border-bottom: 1px solid #222;
      text-align: center;
      letter-spacing: 0.5px;
      color: #93c5fd;
    }
    .top-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      padding: 7px 5px 3px 7px;
      background: #0b1221;
      font-size: 10px;
      border: none;
      color: #93c5fd;
    }
    .nftfan-balance-bar {
      display: flex;
      align-items: center;
      margin-right: auto;
      font-size: 8px;
      color: #89c9ff;
      background: #1a2336;
      border-radius: 6px;
      padding: 2px 7px 2px 2px;
      gap: 2px;
      font-weight: 500;
    }
    .nftfan-token-icon {
      width: 15px;
      height: 15px;
      margin-right: 2px;
    }
    .connect-btn {
      padding: 4px 8px;
      background: #121d33;
      border: 1px solid #3b82f6;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      color: #60a5fa;
      font-size: 9px;
      min-width: 70px;
      box-shadow: 0 1px 2px #0008;
      transition: background .18s, color .18s;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 170px;
    }
    .connect-btn:hover, .connect-btn:focus {
      background: #182745;
      color: #fff;
      outline: none;
    }
    .status-bar {
      padding: 6px 9px;
      background: #fff;
      border-radius: 4px;
      margin: 8px 7px 8px 7px;
      font-size: 9px;
      color: #e53e3e;
      min-height: 19px;
      text-align: left;
      font-weight: 600;
      border: 1px solid #e53e3e;
      letter-spacing: .01em;
      transition: color .18s, background .18s;
      box-shadow: 0 0.5px 2px #0002;
      word-break: break-word;
    }
    .tab-bar {
      display: flex;
      gap: 4px;
      margin: 0 7px 8px 7px;
      background: #121d33;
      border-radius: 7px;
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 6px 0;
      background: #121d33;
      border: none;
      border-radius: 0;
      cursor: pointer;
      font-weight: 600;
      color: #93c5fd;
      font-size: 8px;
      letter-spacing: .01em;
      transition: background .18s, color .18s;
      outline: none;
    }
    .tab-btn.active {
      background: #60a5fa;
      color: #fff;
    }
    .tab-btn:hover:not(.active) {
      background: #182745;
      color: #fff;
    }
    .nft-list {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
    }
    .nft-post {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 11px 0 11px 0;
      background: transparent;
      position: relative;
      font-size: 10px;
      gap: 13px;
      border: none;
    }
    .nft-post:not(:last-child)::after {
      content: "";
      display: block;
      position: absolute;
      left: 56px;
      right: 0;
      bottom: 0;
      height: 1px;
      background: #222;
      opacity: 1;
      z-index: 1;
    }
    .nft-post-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    .serial-number {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 38px;
      min-width: 22px;
      font-size: 8px;
      color: #aaa;
      font-family: inherit;
      font-weight: 500;
      letter-spacing: 0.03em;
      text-align: center;
      margin-right: 0;
    }
    .nft-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background-color: #fff;
      object-fit: cover;
      border: 1.5px solid #222f44;
      flex-shrink: 0;
      display: block;
    }
    .nft-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .nft-title {
      font-weight: bold;
      font-size: 10px;
      color: #cbe2ff;
      line-height: 1.2;
      margin-bottom: 1px;
      white-space: normal;
      word-break: break-word;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .nft-supply {
      color: #aaa;
      font-size: 9px;
      font-weight: 400;
      margin-left: 4px;
    }
    .nft-description {
      font-size: 8.5px;
      color: #ccc;
      margin-top: 1px;
      max-width: 220px;
      white-space: normal;
      word-break: break-word;
    }
    .nft-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 7px;
      margin-left: 11px;
    }
    .price-tab {
      background: #181f3a;
      color: #60a5fa;
      font-size: 9px;
      font-weight: 600;
      border-radius: 13px;
      padding: 4px 10px;
      border: 1px solid #222c48;
      margin: 0;
      min-width: 70px;
      text-align: center;
      box-shadow: 0 1px 2px #0003;
      display: inline-block;
      letter-spacing: 0.15px;
    }
    .buy-btn, .sell-btn {
      font-size: 9px;
      padding: 5px 13px;
      border-radius: 16px;
      border: none;
      background-color: #1e90ff;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
      box-shadow: 0 1px 2px #0008;
      letter-spacing: 0.1px;
    }
    .sell-btn {
      background-color: #ff9500;
    }
    .buy-btn:disabled, .sell-btn:disabled {
      background: #222a46;
      color: #aaa;
      cursor: not-allowed;
    }
    .buy-btn:hover:not(:disabled) {
      background-color: #3aa0ff;
    }
    .sell-btn:hover:not(:disabled) {
      background-color: #ffaa33;
    }
    .sold-out {
      font-size: 9px;
      color: #ff6363;
      font-weight: bold;
      margin-left: 14px;
    }
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #121d33;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      color: #fff;
      text-align: center;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 14px;
      cursor: pointer;
      color: #93c5fd;
    }
    .modal-title {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .modal-input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      background: #1a2336;
      border: 1px solid #3b82f6;
      color: #fff;
      border-radius: 5px;
      font-size: 10px;
    }
    .modal-button {
      padding: 8px 16px;
      background: #1e90ff;
      border: none;
      border-radius: 5px;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      margin: 5px;
    }
    .modal-button:hover {
      background: #3aa0ff;
    }
    .modal-button.cancel {
      background: #ff6363;
    }
    .modal-button.cancel:hover {
      background: #ff7878;
    }
    @media (max-width: 600px) {
      .wrapper { max-width: 100vw; padding: 0; }
      .nft-avatar { width: 29px; height: 29px; }
      .nft-title { font-size: 9px; }
      .buy-btn, .sell-btn { font-size: 8px; padding: 4px 10px; }
      .nft-description { font-size: 7.5px; max-width: 110px; }
      .nft-post { padding: 7px 0; }
      .price-tab { font-size: 8px; padding: 3px 7px; min-width: 50px;}
      .nft-actions { gap: 4px; margin-left: 7px;}
      .nft-post:not(:last-child)::after { left: 44px; }
      .serial-number { height: 29px; min-width: 14px; font-size: 7px;}
      .modal-content { padding: 15px; }
      .modal-title { font-size: 11px; }
      .modal-input { font-size: 9px; }
      .modal-button { font-size: 9px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="header">NFTFANS ERC1155 Shop</div>
    <div class="top-bar">
      <div class="nftfan-balance-bar" id="nftfanBalanceBar" style="display:none;">
        <img class="nftfan-token-icon" src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Token">
        <span id="nftfanBalance">--</span>
        <span style="font-size:7px;font-weight:400;color:#888;margin-left:2px;">NFTFAN</span>
      </div>
      <button class="connect-btn" id="connect-btn" onclick="connectWallet()">ðŸ”— Connect Wallet</button>
    </div>
    <div class="status-bar" id="statusBar">
      Status: Initializing...
    </div>
    <div class="tab-bar">
      <button class="tab-btn active" id="tab-shop" onclick="showTab('shop')">NFTFANS Shop</button>
      <button class="tab-btn" id="tab-mynfts" onclick="showTab('mynfts')">My NFTs</button>
      <button class="tab-btn" id="tab-market" onclick="showTab('market')">Market</button>
    </div>
    <div class="tab-content" id="tab-content-shop">
      <div id="shop-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading NFTs...</div>
      <div id="shop-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="shopGrid" style="display: none;"></ul>
    </div>
    <div class="tab-content" id="tab-content-mynfts" style="display:none;">
      <div id="my-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading Your NFTs...</div>
      <div id="my-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="myGrid" style="display: none;"></ul>
    </div>
    <div class="tab-content" id="tab-content-market" style="display:none;">
      <div id="market-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading Market Listings...</div>
      <div id="market-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="marketGrid" style="display: none;"></ul>
    </div>
    <!-- Modal -->
    <div id="actionModal" class="modal">
      <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">Ã—</span>
        <h2 class="modal-title" id="modalTitle">Action</h2>
        <p id="modalMessage"></p>
        <input type="number" class="modal-input" id="modalAmount" placeholder="Amount" min="1" style="display:none;">
        <input type="number" class="modal-input" id="modalPrice" placeholder="Price in MATIC" min="0" step="0.01" style="display:none;">
        <div>
          <button class="modal-button" id="modalConfirm" onclick="confirmAction()">Confirm</button>
          <button class="modal-button cancel" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/64.0.4/web3.min.js"></script>
  <script>
    // --- CONFIG ---
    const POLYGON_PROPERTIES = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/', 'https://rpc-mainnet.matic.network/'],
      blockExplorerUrls: ['https://polygonscan.com/']
    };
    const NFTFAN_SHOP_ADDRESS = "0x10FdffF7E02CDfB4E5d34FA5Dc93074f1F2619cc";
    const NFTFAN_SHOP_ABI = [
      { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
      { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "creator", "type": "address" }, { "indexed": false, "internalType": "string", "name": "tokenURI", "type": "string" }, { "indexed": false, "internalType": "uint256", "name": "price", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "NFTMinted", "type": "event" },
      { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "buyer", "type": "address" }, { "indexed": false, "internalType": "address", "name": "seller", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "price", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "NFTBought", "type": "event" },
      { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "indexed": false, "internalType": "address", "name": "seller", "type": "address" }, { "indexed": false, "internalType": "uint256", "name": "price", "type": "uint256" }, { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "NFTListed", "type": "event" },
      { "anonymous": false, "inputs": [{ "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "NFTUnlisted", "type": "event" },
      { "inputs": [], "name": "nextTokenId", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "nftInfo", "outputs": [{ "internalType": "string", "name": "tokenURI", "type": "string" }, { "internalType": "uint256", "name": "price", "type": "uint256" }, { "internalType": "bool", "name": "forSale", "type": "bool" }, { "internalType": "address", "name": "originalCreator", "type": "address" }, { "internalType": "uint256", "name": "maxSupply", "type": "uint256" }, { "internalType": "uint256", "name": "currentSupply", "type": "uint256" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "shopInventory", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
      { "inputs": [], "name": "getShopNFTs", "outputs": [{ "internalType": "uint256[]", "name": "ids", "type": "uint256[]" }, { "internalType": "string[]", "name": "uris", "type": "string[]" }, { "internalType": "uint256[]", "name": "prices", "type": "uint256[]" }, { "internalType": "bool[]", "name": "isForSale", "type": "bool[]" }, { "internalType": "uint256[]", "name": "shopAmounts", "type": "uint256[]" }, { "internalType": "uint256[]", "name": "maxSupplies", "type": "uint256[]" }, { "internalType": "uint256[]", "name": "currentSupplies", "type": "uint256[]" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "address", "name": "user", "type": "address" }], "name": "tokensOfOwner", "outputs": [{ "internalType": "uint256[]", "name": "tokenIds", "type": "uint256[]" }, { "internalType": "uint256[]", "name": "amounts", "type": "uint256[]" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "getListings", "outputs": [{ "components": [{ "internalType": "address", "name": "seller", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "price", "type": "uint256" }], "internalType": "struct NFTFansShop.Listing[]", "name": "", "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "buyNFT", "outputs": [], "stateMutability": "payable", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "_price", "type": "uint256" }], "name": "sellNFT", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
      { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "id", "type": "uint256" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
      { "inputs": [{ "internalType": "uint256", "name": "tokenId", "type": "uint256" }], "name": "uri", "outputs": [{ "internalType": "string", "name": "", "type": "string" }], "stateMutability": "view", "type": "function" }
    ];

    // --- APP STATE ---
    let userAccount = null, web3 = null, nftfanShop = null, currentTokenId = null, currentPrice = null, currentAction = null;

    // --- UI UTILS ---
    function updateStatus(message) {
      const statusBar = document.getElementById('statusBar');
      statusBar.textContent = message;
      statusBar.style.background = "#fff";
      statusBar.style.color = "#e53e3e";
      setTimeout(() => {
        statusBar.style.background = "#fff";
        statusBar.style.color = "#e53e3e";
      }, 6000);
    }
    function showError(elementId, message) {
      const errorEl = document.getElementById(elementId);
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      updateStatus(message);
    }
    function hideError(elementId) {
      document.getElementById(elementId).style.display = 'none';
    }
    function formatAddress(address) {
      if (!address) return '';
      return `${address.slice(0, 5)}...${address.slice(-4)}`;
    }

    // --- MODAL HANDLING ---
    function openModal(title, message, showAmount = false, showPrice = false, action = null) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      document.getElementById('modalAmount').style.display = showAmount ? 'block' : 'none';
      document.getElementById('modalPrice').style.display = showPrice ? 'block' : 'none';
      document.getElementById('actionModal').style.display = 'flex';
      currentAction = action;
    }
    function closeModal() {
      document.getElementById('actionModal').style.display = 'none';
      document.getElementById('modalAmount').value = '';
      document.getElementById('modalPrice').value = '';
      currentAction = null;
      currentTokenId = null;
      currentPrice = null;
    }
    async function confirmAction() {
      if (!currentAction) return;
      const amount = parseInt(document.getElementById('modalAmount').value) || 1;
      const price = document.getElementById('modalPrice').value;
      try {
        await currentAction(amount, price ? web3.utils.toWei(price, 'ether') : null);
        closeModal();
      } catch (error) {
        updateStatus(`Error: ${error.message}`);
        closeModal();
      }
    }

    // --- WALLET & CONTRACTS ---
    async function connectWallet() {
      try {
        updateStatus('Connecting wallet...');
        if (!window.ethereum) throw new Error("Please install MetaMask or a compatible wallet!");
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== POLYGON_PROPERTIES.chainId) {
          try {
            await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_PROPERTIES.chainId }] });
          } catch (switchError) {
            if (switchError.code === 4902) {
              await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PROPERTIES] });
            } else { throw switchError; }
          }
        }
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        document.getElementById("connect-btn").textContent = formatAddress(userAccount);
        await setupContracts();
        updateStatus('Connected successfully');
        loadShopNFTs();
        loadUserNFTs();
        loadMarketListings();
      } catch (error) {
        updateStatus('Connection failed: ' + error.message);
      }
    }
    async function setupContracts() {
      try {
        updateStatus('Setting up contracts...');
        const provider = window.ethereum || POLYGON_PROPERTIES.rpcUrls[0];
        web3 = new Web3(provider);
        nftfanShop = new web3.eth.Contract(NFTFAN_SHOP_ABI, NFTFAN_SHOP_ADDRESS);
        updateStatus('Contracts initialized');
      } catch (error) {
        updateStatus('Contract setup failed: ' + error.message);
        throw error;
      }
    }
    // --- NFT METADATA ---
    async function fetchOpenSeaMeta(uri) {
      if (!uri) return null;
      try {
        if (uri.startsWith("ipfs://")) uri = "https://ipfs.io/ipfs/" + uri.slice(7);
        if (uri.startsWith("ar://")) uri = "https://arweave.net/" + uri.slice(5);
        const res = await fetch(uri, { mode: 'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch {
        return null;
      }
    }

    // --- SHOP LOGIC ---
    async function loadShopNFTs() {
      const shopGrid = document.getElementById("shopGrid");
      const loading = document.getElementById("shop-loading");
      shopGrid.innerHTML = "";
      loading.style.display = "block";
      shopGrid.style.display = "none";
      hideError("shop-error");
      try {
        updateStatus('Loading shop NFTs...');
        if (!nftfanShop) await setupContracts();
        const result = await nftfanShop.methods.getShopNFTs().call();
        const { ids, uris, prices, isForSale, shopAmounts, maxSupplies } = result;
        if (!ids.length) {
          loading.textContent = "No NFTs in Shop";
          updateStatus('No NFTs in shop');
          return;
        }
        const metaArr = await Promise.all(uris.map((uri) => fetchOpenSeaMeta(uri)));
        let html = "";
        for (let i = 0; i < ids.length; i++) {
          const id = ids[i], meta = metaArr[i],
                name = meta?.name || `NFTFAN #${id}`,
                img = meta?.image || uris[i] || "https://via.placeholder.com/92x92?text=NFT",
                desc = meta?.description || "",
                price = web3.utils.fromWei(prices[i], "ether"),
                forSale = isForSale[i],
                available = shopAmounts[i],
                maxSupply = maxSupplies ? maxSupplies[i] : '';
          html += `<li class="nft-post">
            <div class="nft-post-left">
              <span class="serial-number">${i+1}</span>
              <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
              <div class="nft-content">
                <div class="nft-title">${name}
                  ${maxSupply ? `<span class="nft-supply">Â· Max: ${maxSupply}</span>` : ''}
                </div>
                <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
              </div>
            </div>
            <div class="nft-actions">
              <div class="price-tab">${price} MATIC</div>
              ${(forSale && available !== "0") ? `<button class="openBuyModal(${id}, '${prices[i]}', '${name}', ${available})">Buy Now</button>` : `<div class="sold-out">Sold Out</div>`}
            </div>
          </li>`;
        }
        shopGrid.innerHTML = html;
        loading.style.display = "none";
        shopGrid.style.display = "block";
        updateStatus('Shop loaded successfully');
      } catch (error) {
        showError("shop-error", "Failed to load NFTs: " + error.message);
        updateStatus('Shop loading failed: ' + error.message);
      }
    }
    async function buyNFT(id, price, available) {
      if (!userAccount) {
        updateStatus('Please connect wallet first');
        return;
      }
      openModal('Buy NFT', `Confirm purchase of NFT #${id} for ${web3.utils.fromWei(price, 'ether')} MATIC each?`, true, false, async (amount) => {
        try {
          updateStatus('Processing purchase...');
          const totalPrice = (BigInt(price) * BigInt(amount)).toString();
          await nftfanShop.methods.buyNFT(id, amount).send({
            from: userAccount,
            value: totalPrice
          });
          updateStatus('Purchase successful!');
          loadShopNFTs();
          loadUserNFTs();
          loadMarketListings();
        } catch (error) {
          throw new Error(`Purchase failed: ${error.message}`);
        }
      });
    }

    // --- MY NFTs LOGIC ---
    async function loadUserNFTs() {
      const userGrid = document.getElementById("userGrid");
      const loading = document.getElementById("my-loading");
      userGrid.innerHTML = "";
      loading.style.display = "block";
      userGrid.style.display = "none";
      hideError("my-error");
      if (!userAccount) {
        loading.textContent = "Connect wallet to view your NFTs.";
        return;
      }
      try {
        updateStatus('Loading your NFTs...');
        if (!nftfanShop) await setupContracts();
        const tokens = await nftfanShop.methods.tokensOfOwner(userAccount).call();
        const { tokenIds, amounts } = tokens;
        if (!tokenIds.length) {
          loading.textContent = "You own no NFTs yet.";
          updateStatus('No NFTs owned');
          return;
        }
        const metaArr = await Promise.all(tokenIds.map(async (id, idx) => {
          try {
            const meta = await nftfanShop.methods.nftInfo(id).call();
            const metaJson = await fetchOpenSeaMeta(meta.tokenURI);
            return { id, amount: amounts[idx], meta, metaJson };
          } catch {
            return { id, amount: amounts[idx], meta: null, metaJson: null };
          }
        }));
        let html = "";
        for (let i = 0; i < metaArr.length; i++) {
          const item = metaArr[i],
                { id, amount, meta, metaJson } = item,
                name = metaJson?.name || `NFTFAN #${id}`,
                img = metaJson?.image || (meta?.tokenURI || "https://via.placeholder.com/92x92?text=NFT"),
                desc = metaJson?.description || "",
                maxSupply = meta?.maxSupply || "";
          html += `<li class="nft-post">
              <div class="nft-post-left">
                <span class="serial-number">${i+1}</span>
                <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
                <div class="nft-content">
                  <div class="nft-title">${name}
                    ${maxSupply ? `<span class="nft-supply">Â· Max: ${maxSupply}</span>` : ''}
                  </div>
                  <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
                  <div class="nft-supply" style="margin-top:3px;color:#60a5fa;">You own: ${amount}</div>
                </div>
              </div>
              <div class="nft-actions">
                <button class="sell-btn" onclick="openSellModal(${id}, '${name}', ${amount})">Sell</button>
              </div>
            </li>`;
        }
        userGrid.innerHTML = html;
        loading.style.display = "none";
        userGrid.style.display = "block";
        updateStatus('Your NFTs loaded');
      } catch (error) {
        showError("my-error", "Failed to load your NFTs: " + error.message);
        updateStatus('Error loading NFTs: ' + error.message);
      }
    }
    function openSellModal(id, name, available) {
      if (!userAccount) {
        updateStatus('Please connect wallet first');
        return;
      }
      openModal('Sell NFT', `Sell your NFT #${name}?`, true, true, async (amount, price) => {
        try {
          updateStatus('Listing NFT for sale...');
          await nftfanShop.methods.sellNFT(id, amount, price).send({ from: userAccount });
          updateStatus('NFT listed successfully!');
          loadUserNFTs();
          loadMarketListings();
        } catch (error) {
          throw new Error(`Listing failed: ${error.message}`);
        }
      });
    }

    // --- MARKET LISTINGS ---
    async function loadMarketListings() {
      const marketGrid = document.getElementById('marketGrid');
      const loading = document.getElementById('market-loading');
      marketGrid.innerHTML = '';
      loading.style.display = 'block';
      marketGrid.style.display = 'none';
      hideError('market-error');
      try {
        updateStatus('Loading market listings...');
        if (!nftfanShop) await setupContracts();
        const tokenIds = await nftfanShop.methods.getShopNFTs().call().then(r => r.ids);
        let listings = [];
        for (const id of tokenIds) {
          const listingData = await nftfanShop.methods.getListings(id).call();
          listingData.forEach(item => {
            if (item.amount > 0) {
              listings.push({ tokenId: id, seller: item.seller, amount: item.amount, price: item.price });
            }
          });
        }
        if (!listings.length) {
          loading.textContent = 'No market listings available';
          updateStatus('No market listings');
          return;
        }
        const metaArr = await Promise.all(listings.map(async (listing) => {
          const meta = await nftfanShop.methods.nftInfo(listing.tokenId).call();
          const metaJson = await fetchOpenSeaMeta(meta.tokenURI);
          return { id: listing.tokenId, meta, metaJson, listing };
        }));
        let html = '';
        for (let i = 0; i < metaArr.length; i++) {
          const { id, meta, metaJson, listing } = metaArr[i];
          const name = metaJson?.name || `NFTFAN #${id}`,
                img = metaJson?.image || meta.tokenURI || "https://via.placeholder.com/92x92?text=NFT",
                desc = metaJson?.description || "",
                maxSupply = meta?.maxSupply || "",
                price = web3.utils.fromWei(listing.price, 'ether");
          html += `<li class="nft-post">
            <div class="nft-post-left">
              <span class="serial-number">${i + 1}</span>
              <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
              <div class="nft-content">
                <div class="nft-title">${name}
                  ${maxSupply ? `<span class="nft-supply">Â· Max: ${maxSupply}</span>` : ''}
                </div>
                <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
                <div class="nft-supply" style="margin-top:3px;color:#60a5;">Listed by: ${formatAddress(listing.seller)}</div>
                  <div class="nft-amount" style="margin-top:3px;color:#60a5fa;">Amount: ${listing.amount}</div>
              </div>
            </div>
            <div class="nft-actions">
              <div class="price-tab">${price} MATIC</div>
              <button class="buy-btn" onclick="openBuyModal(${id}', '${listing.price}', '${name}', ${listing.amount}, '${listing.seller}')">Buy</button>
            </div>
          </li>`;
        }
        marketGrid.innerHTML = html;
        loading.style.display = 'none';
        marketGrid.style.display = 'block';
        updateStatus('Market listings loaded');
      } catch (error) {
        showError('market-error', 'Failed to load market listings: ' + error.message);
        updateStatus('Market loading failed: ' + error.message);
      }
    }

    // --- TABS ---
    function showTab(tab) {
      ['shop', 'mynfts', 'market'].forEach(t => {
        document.getElementById(`tab-content-${t}`).style.display = 'none';
        document.getElementById(`tab-${t}`).classList.remove('active');
      });
      document.getElementById(`tab-content-${tab}`).style.display = 'block';
      document.getElementById(`tab-${tab}`).classList.add('active');
      if (tab === 'shop') loadShopNFTs();
      else if (tab === 'mynfts') loadUserNFTs();
      else if (tab === 'market') loadMarketListings();
    }

    // --- EVENT LISTENERS ---
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        userAccount = accounts[0] || null;
        const connectBtn = document.getElementById("connect-btn");
        connectBtn.textContent = userAccount ? formatAddress(userAccount) : "ðŸ”— Connect Wallet";
        if (userAccount) {
          setupContracts().then(() => {
            loadShopNFTs();
            loadUserNFTs();
            loadMarketListings();
            updateStatus('Account changed');
          });
        } else {
          updateStatus('Wallet disconnected');
        }
      });
      window.ethereum.on('chainChanged', () => {
        updateStatus('Network changed - reconnecting...');
        setupContracts().then(() => {
          loadShopNFTs();
          loadUserNFTs();
          loadMarketListings();
          updateStatus('Network changed');
        });
      });
    }
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        updateStatus('Initializing...');
        await setupContracts();
        await loadShopNFTs();
        updateStatus('Ready');
      } catch (error) {
        updateStatus('Initialization failed: ' + error.message);
        showError('shop-error', 'Failed to initialize the application. Please refresh.');
      }
    });
  </script>
</body>
</html>
