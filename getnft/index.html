<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>$NFTFAN Token Sale Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="icon" href="https://i.imgur.com/ODP45iQ.png" type="image/png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
:root {
  --bg: #fcfcfe;
  --primary: #00bfae;
  --secondary: #a259e6;
  --accent: #ffd900;
  --success: #27ae60;
  --text: #23243b;
  --text-light: #7e819c;
  --bubble-bot: #f3f7fa;
  --bubble-user: #e0f7fa;
  --bubble-success: #e8faf1;
  --bubble-warning: #fffbe9;
  --bot-shadow: 0 4px 18px 0 rgba(0,205,180,.08);
  --radius: 17px;
  --radius-m: 13px;
  --font-title: 'Orbitron', monospace;
  --font-main: 'Inter', sans-serif;
}
html, body {
  background: var(--bg);
  min-height: 100vh;
  font-family: var(--font-main);
  color: var(--text);
  font-size: 16px;
}
#app {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  align-items: center;
  background: var(--bg);
  padding: 0;
}
.chat-card {
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
  background: #fff;
  border-radius: var(--radius);
  box-shadow: 0 4px 36px 0 rgba(36,36,62,.09);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 80vh;
  margin-top: 24px;
  margin-bottom: 24px;
  border: 1.5px solid #f0f0f7;
}
.header {
  display: flex;
  align-items: center;
  gap: 11px;
  background: linear-gradient(90deg, #f3f7fa 60%, #eae6fb 100%);
  padding: 19px 19px 13px 19px;
  border-bottom: 1.5px solid #f0f0f7;
}
.logo {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: linear-gradient(135deg,#00bfae,#a259e6);
  box-shadow: 0 3px 11px #a259e633;
  display: flex; align-items: center; justify-content: center;
}
.logo img {
  width: 26px; height: 26px; border-radius: 50%;
}
.header-text {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.header-title {
  font-family: var(--font-title);
  font-size: 17px;
  color: var(--primary);
  font-weight: 700;
  letter-spacing: 1.1px;
}
.header-desc {
  color: var(--text-light);
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .3px;
}
.chat-window {
  flex: 1;
  background: #fcfcfe;
  padding: 22px 16px 12px 16px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
  scroll-behavior: smooth;
}
::-webkit-scrollbar {width:7px;}
::-webkit-scrollbar-thumb{background:#ececf4;border-radius:8px;}
::-webkit-scrollbar-track{background:transparent;}

.bubble-row {
  display: flex;
  align-items: flex-end;
  margin-bottom: 2px;
}
.bubble-row.bot {justify-content: flex-start;}
.bubble-row.user {justify-content: flex-end;}
.bubble {
  max-width: 85%;
  padding: 14px 15px;
  border-radius: var(--radius-m);
  font-size: 15px;
  box-shadow: var(--bot-shadow);
  margin-bottom: 2px;
  word-break: break-word;
  line-height: 1.4;
  position: relative;
  animation: fadeInUp 0.5s;
}
.bubble.bot {
  background: var(--bubble-bot);
  color: var(--text);
  border-bottom-left-radius: 3px;
}
.bubble.user {
  background: var(--bubble-user);
  color: var(--primary);
  border-bottom-right-radius: 3px;
  font-weight: 600;
}
.bubble.success {
  background: var(--bubble-success);
  color: var(--success);
  border: 1.5px solid var(--success);
}
.bubble.warning {
  background: var(--bubble-warning);
  color: var(--accent);
  border: 1.5px solid var(--accent);
}
.material-icons {
  font-size: 19px;
  vertical-align: middle;
  margin-right: 6px;
  opacity: .74;
}
.bot-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #fff;
  margin-right: 7px;
  box-shadow: 0 1px 7px #a259e619;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e0f7fa;
  margin-left: 7px;
  display: flex; align-items: center; justify-content: center;
}
.input-bar {
  display: flex;
  gap: 8px;
  padding: 15px 17px 15px 17px;
  border-top: 1.5px solid #f0f0f7;
  background: linear-gradient(90deg,#fcfcfe 80%,#f5f4fe 100%);
  align-items: center;
}
.input-bar input, .input-bar button, .input-bar select {
  font-family: var(--font-main);
  font-size: 15px;
  border-radius: 7px;
  border: none;
  outline: none;
}
.input-bar input {
  flex: 1;
  padding: 12px 13px;
  background: #f5f5fa;
  color: var(--text);
  border: 1.2px solid #e1e1ef;
  transition: border .17s;
}
.input-bar input:focus {
  border: 1.2px solid var(--primary);
  background: #f8f9fb;
}
.input-bar button {
  background: linear-gradient(90deg,#00bfae 80%,#a259e6 100%);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  padding: 11px 17px;
  cursor: pointer;
  border: none;
  min-width: 46px;
  box-shadow: 0 1px 6px #00bfae1c;
  transition: box-shadow .18s, transform .18s;
}
.input-bar button:active { transform: scale(0.98);}
.input-bar button:disabled { opacity: .43; cursor: not-allowed;}
@media (max-width:520px) {
  .chat-card {max-width:99vw;}
}
@media (max-width:400px) {
  .header-title {font-size:14px;}
  .header-desc {font-size:10px;}
  .chat-window {padding:10px 2vw 6px 2vw;}
  .input-bar {padding: 10px 5px;}
}
/* Animations */
@keyframes fadeInUp {from{opacity:0;transform:translateY(21px);}to{opacity:1;transform:translateY(0);}}
@keyframes pulse {
  0%{box-shadow:0 0 0 0 #00bfae33;}
  70%{box-shadow:0 0 0 12px #00bfae00;}
  100%{box-shadow:0 0 0 0 #00bfae33;}
}
/* Countdown badge */
.countdown-badge {
  display: inline-flex;
  align-items: center;
  background: #e0f7fa;
  color: var(--primary);
  border-radius: 999px;
  padding: 5px 13px;
  font-size: 15px;
  margin: 4px 0;
  font-weight: 700;
  box-shadow: 0 1px 6px #00bfae14;
  animation: pulse 1.4s infinite;
}
a.social-link {
  color: var(--secondary);
  text-decoration: none;
  font-weight: 700;
  margin-left: 4px;
}
a.social-link:hover {text-decoration: underline;}
  </style>
</head>
<body>
  <div id="app">
    <div class="chat-card">
      <div class="header">
        <div class="logo">
          <img src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Logo"/>
        </div>
        <div class="header-text">
          <div class="header-title">$NFTFAN TOKEN SALE</div>
          <div class="header-desc">Official Token Purchase Chat Portal</div>
        </div>
      </div>
      <div class="chat-window" id="chatWindow">
        <!-- Chat bubbles rendered here -->
      </div>
      <form class="input-bar" id="inputBar" autocomplete="off">
        <input id="chatInput" type="text" placeholder="Type your response..." autocomplete="off"/>
        <button id="sendBtn" type="submit"><span class="material-icons">send</span></button>
      </form>
    </div>
  </div>
  <script>
    // CONFIG
    const CONFIG = {
      tokenAddress: "0x2017Fcaea540d2925430586DC92818035Bfc2F50",
      apiKey: "3AFN3ZU4ANK3XEUJQ6BRJCBCITAFHKFVTV",
      airdropContract: "0xaf2d132C8773bca3821C24EcF64e844E202A12e8"
    };

    // FLOW STEPS
    const STEPS = [
      'welcome',         // 0
      'ask_wallet',      // 1
      'ask_amount',      // 2
      'pay',             // 3
      'processing',      // 4
      'show_balance',    // 5
      'thank_you'        // 6
    ];

    let state = {
      step: 0,
      userWallet: '',
      amount: 0,
      countdown: 10,
      botTyping: false,
      balance: null,
      processingTimer: null,
    };

    // --- Utility functions ---
    function delay(ms) { return new Promise(res=>setTimeout(res,ms)); }
    function scrollDown() {
      const chatWindow = document.getElementById('chatWindow');
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }
    function validateEthAddress(addr) {
      return /^0x[a-fA-F0-9]{40}$/.test(addr);
    }
    function sanitize(str) {
      return (str||'').replace(/[<>&]/g, (c)=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[c]));
    }
    // --- Chat rendering ---
    function botBubble(html, opts={}) {
      const pre = opts.avatar===false ? '' : `
        <div class="bot-avatar"><img src="https://i.imgur.com/ODP45iQ.png" style="width:100%;"></div>`;
      return `<div class="bubble-row bot">
        ${pre}
        <div class="bubble bot${opts.success? ' success':''}${opts.warning?' warning':''}">${html}</div>
      </div>`;
    }
    function userBubble(html) {
      return `<div class="bubble-row user">
        <div class="bubble user">${html}</div>
        <div class="user-avatar"><span class="material-icons" style="color:#00bfae;">account_circle</span></div>
      </div>`;
    }
    function appendChat(html) {
      document.getElementById('chatWindow').insertAdjacentHTML('beforeend', html);
      scrollDown();
    }
    function showBotTyping() {
      state.botTyping = true;
      appendChat(botBubble(`<span class="material-icons">more_horiz</span>`, {avatar:false}));
      scrollDown();
    }
    function removeBotTyping() {
      if(!state.botTyping) return;
      const bubbles = document.querySelectorAll('.bubble-row.bot');
      if (bubbles.length > 0) {
        const last = bubbles[bubbles.length-1];
        if (last.querySelector('.material-icons') && last.textContent.trim() === '') last.remove();
      }
      state.botTyping = false;
    }
    // --- Main chat logic ---
    async function runStep(step, input) {
      // Remove typing indicator if present
      removeBotTyping();
      const chatInput = document.getElementById('chatInput');
      chatInput.value = '';
      chatInput.disabled = true;
      document.getElementById('sendBtn').disabled = true;

      // STEP 0: Welcome
      if(step === 0) {
        showBotTyping(); await delay(700);
        appendChat(botBubble(`<span class="material-icons">waving_hand</span> Welcome to <b>$NFTFAN Token Sale!</b><br>
          <span style="color:var(--text-light);display:block;margin-top:2px;">I'm your assistant for secure, automated NFTFAN token purchases.</span>`));
        scrollDown(); await delay(1200);
        showBotTyping(); await delay(500);
        appendChat(botBubble(`<span class="material-icons">info</span> All purchases are processed <b>automatically</b>.<br>
          <b>You'll receive your tokens after sending $POL (MATIC).</b>`));
        scrollDown(); await delay(1100);
        state.step = 1;
        askWallet();
        return;
      }
      // STEP 1: Ask For Sender Wallet
      if(step === 1) {
        if(!input) { askWallet(); return; }
        const addr = input.trim();
        if(!validateEthAddress(addr)) {
          appendChat(botBubble(`<span class="material-icons">error</span> That doesn't look like a valid Polygon (EVM) wallet.<br>
            <span style="font-size:13px;color:var(--text-light);">It should start with "0x" and be 42 characters.</span>`,{warning:true}));
          state.step = 1;
          chatInput.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          return;
        }
        state.userWallet = addr;
        appendChat(userBubble(sanitize(addr)));
        appendChat(botBubble(`<span class="material-icons">check_circle</span> <b>Wallet accepted!</b><br>
          <span style="font-size:13px;color:var(--text-light);">Now, how much $POL (MATIC) do you want to spend?</span>`));
        state.step = 2;
        setTimeout(askAmount, 650);
        return;
      }
      // STEP 2: Ask Amount
      if(step === 2) {
        if(!input) { askAmount(); return; }
        let amt = parseFloat(input);
        if(isNaN(amt) || amt<0.01 || amt>100) {
          appendChat(botBubble(`<span class="material-icons">warning</span> Please enter an amount between <b>0.01 and 100 $POL</b>.`,{warning:true}));
          chatInput.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          return;
        }
        state.amount = amt;
        appendChat(userBubble(`${amt}`));
        appendChat(botBubble(`<span class="material-icons">payments</span> <b>Perfect!</b><br>
          Please send exactly <b>${amt} $POL</b> from:<br>
          <span style="color:var(--primary);font-size:15px;font-weight:700;">${sanitize(state.userWallet)}</span>
          <br>to our contract below:`));
        setTimeout(()=>{
          appendChat(botBubble(
            `<span class="material-icons">account_balance</span>
            <b>Contract:</b>
            <span style="font-family:monospace;font-size:13px;display:block;margin:7px 0 3px 0;">
              <span id="contractAddrSpan" style="user-select:all;">${CONFIG.airdropContract}</span>
              <button onclick="navigator.clipboard.writeText('${CONFIG.airdropContract}');this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',900);" style="border:none;background:var(--primary);color:#fff;padding:4px 9px;border-radius:7px;font-size:12px;margin-left:7px;cursor:pointer;">Copy</button>
            </span>
            <span style="color:var(--text-light);font-size:13px;">Send <b>exactly</b> this amount. Tokens will be auto-delivered after payment.</span>`
          ));
          state.step = 3;
          askSent();
        }, 850);
        return;
      }
      // STEP 3: Confirm Sent
      if(step === 3) {
        if(!input) { askSent(); return; }
        appendChat(userBubble(sanitize(input)));
        if(!input.match(/(sent|done|paid|complete|yes|ok|confirm|i(')?ve sent)/i)) {
          appendChat(botBubble(`<span class="material-icons">info</span> Please type <b>"Sent"</b> when you've sent <b>${state.amount} $POL</b>.`));
          chatInput.disabled = false;
          document.getElementById('sendBtn').disabled = false;
          return;
        }
        appendChat(botBubble(`<span class="material-icons">hourglass_top</span> <b>Processing your payment...</b>`,{avatar:false}));
        state.step = 4;
        setTimeout(startProcessing, 1000);
        return;
      }
      // STEP 4: Processing
      if(step === 4) {
        // Shouldn't occur, handled automatically
        chatInput.disabled = true;
        document.getElementById('sendBtn').disabled = true;
        return;
      }
      // STEP 5: Show Balance
      if(step === 5) {
        showBotTyping(); await delay(800);
        appendChat(botBubble(`<span class="material-icons" style="color:var(--success);">check_circle</span>
          <b>Purchase Complete!</b><br>
          <span style="font-size:14px;color:var(--text-light);">Your wallet now holds:</span>
          <br>
          <span class="countdown-badge" style="margin:10px 0;">
            <span class="material-icons">token</span>
            <span id="balanceVal">${state.balance ?? 0}</span> $NFTFAN
          </span>
        `,{success:true}));
        scrollDown();
        state.step = 6;
        setTimeout(thankYou, 1100);
        return;
      }
      // STEP 6: Thank You
      if(step === 6) {
        appendChat(botBubble(`
          <span class="material-icons">celebration</span>
          <b>Thank you for buying $NFTFAN tokens!</b>
          <br>
          For more updates, <a class="social-link" href="https://x.com/nftfanstoken" target="_blank"><span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:2px;">open_in_new</span>Follow us on X</a>
          <br>
          <div style="margin-top:11px;">
            <button onclick="window.location.reload()" style="background:var(--primary);color:#fff;font-weight:700;border:none;border-radius:7px;padding:8px 17px;cursor:pointer;font-size:15px;">
              <span class="material-icons" style="vertical-align:middle;">repeat</span>
              Buy More
            </button>
            <button onclick="window.open('https://polygonscan.com/address/${state.userWallet}','_blank')" style="background:var(--secondary);color:#fff;font-weight:700;border:none;border-radius:7px;padding:8px 17px;cursor:pointer;font-size:15px;margin-left:8px;">
              <span class="material-icons" style="vertical-align:middle;">open_in_new</span>
              View on Explorer
            </button>
          </div>
        `));
        document.getElementById('chatInput').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        return;
      }
    }

    // --- Step handlers ---
    function askWallet() {
      showBotTyping();
      setTimeout(()=>{
        removeBotTyping();
        appendChat(botBubble(`<span class="material-icons">account_balance_wallet</span>
          Which <b>Polygon (EVM) wallet</b> will you send $POL from?<br>
          <span style="color:var(--text-light);font-size:13px;">Paste your wallet address (starts with <b>0x</b>).</span>`));
        document.getElementById('chatInput').placeholder = '0x...';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('chatInput').focus();
      }, 600);
    }
    function askAmount() {
      showBotTyping();
      setTimeout(()=>{
        removeBotTyping();
        appendChat(botBubble(`<span class="material-icons">payments</span>
          How much <b>$POL (MATIC)</b> do you want to spend?<br>
          <span style="color:var(--text-light);font-size:13px;">(Min: 0.01, Max: 100)</span>`));
        document.getElementById('chatInput').placeholder = 'Enter amount in $POL';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('chatInput').focus();
      }, 600);
    }
    function askSent() {
      showBotTyping();
      setTimeout(()=>{
        removeBotTyping();
        appendChat(botBubble(`<span class="material-icons">send</span>
          Reply <b>"Sent"</b> after you send <b>${state.amount} $POL</b> from your wallet above.`));
        document.getElementById('chatInput').placeholder = 'Type "Sent" after payment';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('chatInput').focus();
      }, 700);
    }

    async function startProcessing() {
      removeBotTyping();
      let count = 10;
      const bubbleId = 'processingBubble'+Math.floor(Math.random()*9999);
      appendChat(`<div class="bubble-row bot" id="${bubbleId}">
        <div class="bot-avatar"><img src="https://i.imgur.com/ODP45iQ.png" style="width:100%;"></div>
        <div class="bubble bot" id="processingBubbleInner">
          <span class="material-icons">hourglass_empty</span>
          <b>Processing payment...</b>
          <div style="margin-top:9px;"><span class="countdown-badge" id="countdownBadge">10s</span></div>
          <span style="color:var(--text-light);font-size:13px;">Checking blockchain and contract status.</span>
        </div>
      </div>`);
      scrollDown();
      document.getElementById('chatInput').disabled = true;
      document.getElementById('sendBtn').disabled = true;
      let interval = setInterval(()=>{
        count--;
        if(document.getElementById('countdownBadge')) document.getElementById('countdownBadge').textContent = count+'s';
        if(count<=0) {
          clearInterval(interval);
          completeTransaction();
        }
      },1000);
    }

    async function completeTransaction() {
      // Remove processing bubble
      const processingBubble = document.getElementById('processingBubbleInner');
      if(processingBubble) processingBubble.innerHTML = `<span class="material-icons" style="color:var(--success);">check</span> <b>Payment confirmed!</b>`;
      // Fetch balance
      await fetchBalance();
      state.step = 5;
      runStep(5);
    }

    async function fetchBalance() {
      // Use Polygonscan API
      try {
        const url = `https://api.polygonscan.com/api?module=account&action=tokenbalance&contractaddress=${CONFIG.tokenAddress}&address=${state.userWallet}&tag=latest&apikey=${CONFIG.apiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.status === "1") {
          const decimals = 18;
          const balance = Number(data.result) / 10 ** decimals;
          state.balance = formatNumber(Math.floor(balance));
        } else {
          state.balance = "Error";
        }
      } catch (e) {
        state.balance = "Error";
      }
    }

    function thankYou() {
      runStep(6);
    }

    // --- Input handler ---
    document.getElementById('inputBar').addEventListener('submit', function(e){
      e.preventDefault();
      if(state.botTyping) return;
      const val = document.getElementById('chatInput').value;
      if(!val.trim()) return;
      runStep(state.step, val);
    });

    // --- ON LOAD: start chat ---
    window.addEventListener('DOMContentLoaded', ()=>{
      setTimeout(()=>runStep(0), 400);
    });
  </script>
</body>
</html>


