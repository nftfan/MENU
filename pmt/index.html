<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFTFans Unified Platform</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://i.imgur.com/g8B2Old.png">
    <meta property="og:description" content="Revolutionizing digital advertising with NFTs. Earn, share, and grow the network with NFTFan Tokens on Polygon Matic. Join the movement today!">
    <meta property="og:image" content="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/image.png">
    <meta property="og:url" content="https://www.nftfanstoken.com/pmt">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NFTFans Token - Power to the Creators">
    <meta name="twitter:description" content="Decentralized advertising meets NFTs. Claim your NFTFan tokens, invite others, and earn rewards. Now live on Polygon Matic!">
    <meta name="twitter:image" content="https://raw.githubusercontent.com/leuvenfd/coinfun/refs/heads/main/image.png">
    <meta name="twitter:url" content="https://www.nftfanstoken.com/pmt">
    <style>
/* (Styles unchanged from your provided file) */
:root { --primary:#5273e0;--accent:#9d7fe2;--secondary:#3cabb9;--success:#42b883;--warning:#f0b86e;--background:#0d1117;--foreground:#181d26;--card-bg:#1c2333;--border-radius:8px;--shadow:0 2px 8px rgba(20,24,60,.12);--text:#dce1ea;--text-secondary:#8c93a6;--input-bg:#1e2536;--input-border:#2a334a;--inactive:#465166;}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;max-width:100%;overflow-x:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:var(--background);color:var(--text);font-size:9px;letter-spacing:.01em;min-height:100vh;line-height:1.4}
.container{width:330px;margin:0 auto;padding:10px 10px 56px}
.banner-img{width:100%;height:60px;object-fit:cover;border-radius:var(--border-radius);margin-bottom:8px;box-shadow:var(--shadow);border:1px solid var(--input-border)}
h1{text-align:center;color:var(--accent);margin:4px 0;font-size:10px;letter-spacing:.05em;font-weight:600}
h2{text-align:center;font-size:8px;margin:2px 0 8px;color:var(--text-secondary);font-weight:400;line-height:1.3}
.topbar{width:100%;margin:0 0 8px;background:var(--foreground);display:flex;align-items:center;justify-content:space-between;padding:5px 8px;border-radius:var(--border-radius);box-shadow:var(--shadow);min-height:26px}
.topbar-left{display:flex;align-items:center;gap:6px;min-width:0;overflow:hidden}
.topbar-xpic{width:16px;height:16px;border-radius:50%;object-fit:cover;border:1px solid var(--secondary);background:var(--input-bg);flex-shrink:0}
.topbar-xname{font-weight:600;color:var(--warning);font-size:9px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px}
.topbar-score{background:var(--input-bg);color:var(--success);font-weight:600;font-size:8px;border-radius:4px;padding:3px 6px;display:flex;align-items:center;gap:3px;min-width:50px}
.topbar-score .material-icons{font-size:9px!important;color:var(--warning)}
.stats-bar{display:flex;justify-content:space-between;gap:4px;margin:0 0 8px}
.stat-box{flex:1;background:var(--foreground);color:var(--primary);border-radius:6px;padding:4px;text-align:center;font-weight:600;display:flex;flex-direction:column;align-items:center;font-size:9px}
.stat-label{font-size:8px;color:var(--text-secondary);font-weight:500;margin-top:2px;line-height:1}
.tabs{display:flex;justify-content:space-between;margin-bottom:8px;background:var(--foreground);border-radius:var(--border-radius);padding:2px;box-shadow:var(--shadow)}
.tab{flex:1;text-align:center;padding:5px 0 4px;cursor:pointer;font-weight:500;color:var(--text-secondary);font-size:8px;transition:.15s;border-radius:6px;display:flex;flex-direction:column;align-items:center;gap:1px}
.tab.active{color:var(--primary);background:rgba(82,115,224,.08)}
.tab .material-icons{font-size:9px!important}
.section{display:none;margin-top:6px}
.section.active{display:block}
label{font-size:9px;font-weight:500;margin-bottom:3px;display:block;color:var(--text-secondary)}
input[type=text]{width:100%;font-size:9px;padding:6px 8px;margin-bottom:6px;border-radius:5px;border:1px solid var(--input-border);background:var(--input-bg);color:var(--text);transition:.15s}
input:focus{border-color:var(--primary);outline:none}
button{width:100%;font-size:9px;padding:6px 0;background:linear-gradient(90deg,var(--primary),var(--accent));border:none;border-radius:5px;color:#fff;font-weight:600;margin:4px 0 6px;box-shadow:0 1px 3px rgba(74,58,255,.08);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:3px;transition:.15s}
button:active{opacity:.9;transform:translateY(1px)}
.card{background:var(--foreground);border-radius:var(--border-radius);box-shadow:var(--shadow);margin:8px 0;padding:10px 8px;border:1px solid var(--input-border);position:relative}
.error-msg,.success-msg{border-radius:4px;margin-bottom:6px;padding:5px 7px;font-size:8px;display:none}
.error-msg{color:#ff6b81;background:rgba(255,107,129,.08);border-left:2px solid #ff6b81}
.success-msg{color:var(--success);background:rgba(66,184,131,.08);border-left:2px solid var(--success)}
.leaderboard-list,.username-list{background:var(--card-bg);border-radius:6px;padding:6px;margin-top:5px}
.leaderboard-item,.username-item{display:flex;align-items:center;justify-content:space-between;padding:3px 0;border-bottom:1px solid var(--input-border);font-size:9px}
.leaderboard-item:last-child,.username-item:last-child{border-bottom:none}
.leaderboard-rank{font-weight:600;color:var(--accent);margin-right:5px;min-width:16px;text-align:center}
.leaderboard-user{color:var(--primary);display:flex;align-items:center;gap:4px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}
.leaderboard-avatar{width:8px;height:8px;border-radius:50%;object-fit:cover;border:1px solid var(--input-border);background:var(--input-bg)}
.leaderboard-points{color:var(--success);font-weight:600;min-width:40px;text-align:right}
.wallet-table{width:100%;border-collapse:collapse;margin:6px 0;table-layout:fixed}
.wallet-table th,.wallet-table td{font-size:8px;padding:3px 2px;border-bottom:1px solid var(--input-border);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.wallet-table th{font-weight:600;color:var(--text-secondary)}
.wallet-copy-btn,.username-copy-btn{background:none;border:none;color:var(--primary);cursor:pointer;border-radius:3px;padding:2px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;width:18px;height:18px}
.username-copy-btn:active,.wallet-copy-btn:active{background:rgba(82,115,224,.1)}
.copy-all-btn{margin-top:5px;background:var(--success)}
.status-badge{display:inline-block;padding:2px 5px;border-radius:4px;font-size:8px;font-weight:600;margin-bottom:5px}
.pending{background:rgba(240,184,110,.15);color:var(--warning)}
.done{background:rgba(66,184,131,.15);color:var(--success)}
.task-card{background:var(--card-bg);border:1px solid var(--input-border);border-radius:var(--border-radius);box-shadow:var(--shadow);margin:8px 0;padding:8px}
.task-title{font-size:9px;font-weight:600;color:var(--warning);margin-bottom:5px;display:flex;align-items:center;gap:4px}
.tweet-preview{font-family:monospace;font-size:8px;background:var(--input-bg);border-radius:4px;color:var(--text);padding:6px;margin:6px 0 8px;border:1px solid var(--input-border);line-height:1.3;max-height:80px;overflow-y:auto}
.share-btn{background:rgba(29,161,242,.08);color:#1DA1F2;border:1px solid rgba(29,161,242,.3);border-radius:4px;padding:5px 0;font-size:9px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:4px}
.share-btn .material-icons{font-size:9px!important}
.share-btn:disabled{opacity:.5;background:var(--input-bg);color:var(--text-secondary);border-color:var(--input-border);cursor:not-allowed}
.reward-row{display:flex;align-items:center;gap:4px;margin-top:6px;flex-wrap:wrap;font-size:8px;color:var(--success)}
.reward-icon{font-size:9px!important;color:var(--success)}
.reward-label{background:var(--warning);font-size:7px;opacity:.7;padding:1px 3px;border-radius:2px;color:#000}
.logout-btn{background:var(--input-bg);border:none;color:var(--text-secondary);font-weight:500;padding:2px 6px;border-radius:4px;font-size:8px;display:flex;align-items:center;gap:2px;height:18px;width:auto}
.logout-btn:hover{background:rgba(82,115,224,.1);color:var(--accent)}
#waitModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000}
.wait-backdrop{position:absolute;inset:0;background:rgba(13,17,23,.85);backdrop-filter:blur(2px)}
.wait-content{background:var(--foreground);border-radius:var(--border-radius);padding:16px;display:flex;flex-direction:column;align-items:center;min-width:120px;z-index:2}
.loader{width:24px;height:24px;border:2px solid var(--secondary);border-top:2px solid var(--warning);border-radius:50%;animation:spin 1s linear infinite;margin-bottom:8px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.verify-instructions{margin:6px 0;font-size:8px;color:var(--text-secondary);background:var(--input-bg);border-radius:4px;padding:6px;line-height:1.5}
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--foreground);display:flex;justify-content:space-around;padding:6px 0;box-shadow:0 -2px 8px rgba(0,0,0,.15);z-index:100;border-top:1px solid var(--input-border)}
.nav-item{display:flex;flex-direction:column;align-items:center;font-size:8px;color:var(--text-secondary);text-decoration:none;gap:2px;padding:3px;border-radius:4px;flex:1;max-width:60px}
.nav-item.active{color:var(--primary);background:rgba(82,115,224,.08)}
.nav-item .material-icons{font-size:14px!important}
::placeholder{color:var(--text-secondary);opacity:.7;font-size:8px}
.material-icons{font-size:10px!important;line-height:1}
@media (max-width:330px){
 .container{width:100%;padding:8px 8px 56px}
 .stats-bar{flex-wrap:wrap}
 .stat-box{flex:0 0 31%}
 .task-card,.card{padding:8px 6px}
 .tweet-preview{max-height:70px;font-size:7px}
 .banner-img{height:50px}
}
@keyframes blinkWithPause {
  0%,25%,100%{color:red;transform:none}
 5%{color:orange;transform:translateX(-3px)}
10%{color:yellow;transform:translateX(3px)}
15%{color:lime;transform:translateX(-3px)}
20%{color:cyan;transform:translateX(3px)}
23%{color:magenta;transform:translateX(0)}
}
.blink-shake-icon{animation:blinkWithPause 2s infinite}
    </style>
</head>
<body>
<div class="container">
    <div class="topbar" id="topbar" style="display:none;">
        <div class="topbar-left">
            <img id="topbarXPic" class="topbar-xpic" src="" alt="X Icon">
            <span class="topbar-xname" id="topbarDisplayName"></span>
        </div>
        <div class="topbar-score">
            <span class="material-icons">paid</span>
            <span id="topbarScoreValue">0T</span>
        </div>
    </div>

    <img class="banner-img" src="https://pbs.twimg.com/media/GuyjoocWYAAm6BT?format=jpg&name=4096x4096" alt="NFTFans Banner">

    <h1>NFTFANS PROMOTERS</h1>
    <h2><span style="color:#ff4757;font-weight:bold;">New</span>: Get 3 usernames after every 60 min.
        <a href="https://www.nftfanstoken.com/60m/" style="color:#00aaff;font-weight:bold;">Click here</a>
    </h2>

    <div class="stats-bar" id="statsBar">
        <div class="stat-box">
            <span id="statTotalPromoters">-</span>
            <div class="stat-label"><span class="material-icons" style="font-size:10px;">person</span> Promoters</div>
        </div>
        <div class="stat-box">
            <span id="statTotalMentions">-</span>
            <div class="stat-label"><span class="material-icons" style="font-size:10px;">alternate_email</span> Mentions</div>
        </div>
        <div class="stat-box">
            <span id="statTotalTokens">-</span>
            <div class="stat-label"><span class="material-icons" style="font-size:10px;">token</span> Tokens</div>
        </div>
    </div>

    <!-- Login Section -->
    <div class="section active" id="loginSection">
        <div class="card">
            <form id="loginForm">
                <label for="loginUsernameInput">Enter your X username</label>
                <input type="text" id="loginUsernameInput" placeholder="@yourusername" autocomplete="username">
                <button id="loginButton" type="submit"><span class="material-icons">login</span> Login / Register</button>
                <div id="loginError" class="error-msg"></div>
                <div id="loginSuccess" class="success-msg"></div>
            </form>
        </div>
    </div>

    <!-- Main Section -->
    <div class="section" id="mainSection">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <div><span id="userWelcome" style="font-size:11px;font-weight:500;color:var(--text-secondary);"></span></div>
            <button class="logout-btn" type="button" id="logoutBtn">
                <span class="material-icons" style="font-size:14px;">logout</span>
            </button>
        </div>

        <div class="card">
            <div id="promoPoints" style="text-align:right;font-weight:bold;color:var(--primary);margin-bottom:5px;font-size:10px;"></div>
            <div id="tokensEarned" style="text-align:right;font-weight:bold;color:var(--success);margin-bottom:5px;font-size:10px;"></div>

            <form id="walletForm" style="margin-bottom:10px;">
                <label for="walletInput">Submit EVM wallet (0x...)</label>
                <div style="display:flex;align-items:center;gap:4px;">
                    <input type="text" id="walletInput" placeholder="0x..." autocomplete="off" style="flex:1;">
                    <button type="submit" style="width:auto;padding:6px 8px;font-size:10px;margin:0;">
                        <span class="material-icons" style="font-size:11px;">add</span>
                    </button>
                </div>
            </form>
            <table class="wallet-table" id="walletTable">
                <thead><tr><th>Wallet</th><th>Copy</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Internal Tabs -->
        <div class="tabs" id="mainTabs">
            <div class="tab active" id="promoterTab" data-tab="promoter">
                <span class="material-icons blink-shake-icon">alternate_email</span> Promote
            </div>
            <div class="tab" id="tweetsTab" data-tab="tweets">
                <span class="material-icons blink-shake-icon">share</span> Share Tweets
            </div>
            <div class="tab" id="mainLeaderboardTab" data-tab="leaderboard">
                <span class="material-icons blink-shake-icon">leaderboard</span> Leaderboard
            </div>
        </div>

        <div class="section active" id="promoterSection">
            <div class="verify-instructions">
                <span class="material-icons" style="font-size:11px;vertical-align:top;color:var(--primary);margin-right:2px;">info</span>
                <b>Paste these usernames under the pinned tweet of
                    <a href="https://x.com/nftfanstoken" target="_blank">@nftfanstoken</a> on X to verify your points.
                    <br>Note: In 24h you will not get more than <b>9 usernames</b> to paste, so use wisely!</b>
            </div>
            <div id="getGroupSection">
                <button type="button" id="getGroupBtn"><span class="material-icons">group</span>Get 3 Usernames</button>
                <div id="groupStatus"></div>
                <div id="groupList" class="username-list"></div>
                <button class="copy-all-btn" style="display:none;" id="copyAllBtn" type="button">
                    <span class="material-icons">content_copy</span>Copy All Usernames
                </button>
            </div>
        </div>

        <div class="section" id="tweetsSection">
            <div id="tasksArea" style="text-align:center;color:var(--text-secondary);margin:20px 0;">
                Loading tweet tasks...
            </div>
        </div>

        <div class="section" id="mainLeaderboardSection">
            <div style="text-align:center;font-size:12px;color:var(--accent);font-weight:600;margin-bottom:7px;">
                <span class="material-icons" style="vertical-align:middle;">leaderboard</span> Leaderboard
            </div>
            <div id="mainLeaderboardList" class="leaderboard-list"></div>
        </div>
    </div>

    <!-- Separate leaderboard section (bottom nav) -->
    <div class="section" id="leaderboardSection">
        <div style="text-align:center;font-size:12px;color:var(--accent);font-weight:600;margin-bottom:7px;">
            <span class="material-icons" style="vertical-align:middle;">leaderboard</span> Leaderboard
        </div>
        <div id="leaderboardList" class="leaderboard-list"></div>
    </div>
</div>

<div class="bottom-nav">
    <a href="#" class="nav-item active" id="navHome" data-nav="login">
        <span class="material-icons">home</span><span>Home</span>
    </a>
    <a href="#" class="nav-item" id="navPromoter" data-nav="main">
        <span class="material-icons">campaign</span><span>Dashboard</span>
    </a>
    <a href="#" class="nav-item" id="navLeaderboard" data-nav="leaderboard">
        <span class="material-icons">leaderboard</span><span>Ranks</span>
    </a>
</div>

<!-- Wait Modal -->
<div id="waitModal">
    <div class="wait-backdrop"></div>
    <div class="wait-content">
        <div class="loader"></div>
        <div class="wait-text">Please wait...</div>
    </div>
</div>

<!-- Firebase Modular Script -->
<script type="module">
/* ---------------- Firebase (NEW project config) ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAnalytics, isSupported as analyticsSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
import {
  getDatabase, ref, get, set, update, runTransaction,
  query, orderByChild, equalTo
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
  authDomain: "newnft-47bd7.firebaseapp.com",
  databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
  projectId: "newnft-47bd7",
  storageBucket: "newnft-47bd7.firebasestorage.app",
  messagingSenderId: "172043823738",
  appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
  measurementId: "G-8VB3DYRNXR"
};

const app = initializeApp(firebaseConfig);
analyticsSupported().then(s => { if (s) getAnalytics(app); });
const db = getDatabase(app);

/* ---------------- State ---------------- */
let currentUser = null;
let currentWallets = [];
let currentGroupKey = "";
let currentGroupStatus = "";
let lastGroupUsernames = [];

/* ---------------- Tweet Tasks ---------------- */
const tweetTasks = [
  { id:'tweet4', icon:"wallet", title:"1M $NFTFAN Drop!", tweet:"5B free $NFTFAN \nDrop Solana Wallet \n visit HERE to claim:\nhttp://nftfanstoken.com/apps\n\n$ETH $SOL $BASE $POL $MONAD $SUI SUPPORTED ON\nMETAMASK WALLET, TRUST WALLET, BASE WALLET, BITGET WALLET, PHANTOM WALLET, OKX WALLET", reward:"1M $NFTFAN" },
  { id:'tweet3', icon:"gift", title:"Earn 1T Tokens!", tweet:"Earn 1 Trillion $NFTFAN TOKENS ðŸ’°\nðŸ‘‰ Task: Copy & paste usernames from the link below ðŸ”— into this post ðŸ“£\nhttps://nftfanstoken.com/promoz/\n1 username = 1T $NFTFAN", reward:"1T per Share" },
  { id:'tweet1', icon:"send", title:"Share This!", tweet:"NFTFans: Earn rewards for sharing tweets.\nJoin us and get 1 trillion $NFTFAN. \n Visit now: \n https://www.nftfanstoken.com/active", reward:"1T $NFTFAN" },
  { id:'tweet2', icon:"send", title:"Share This!", tweet:"NFTFans: Earn rewards for sharing tweets.\nJoin us and get 1 trillion $NFTFAN. \n Visit now: \n https://www.nftfanstoken.com/active \n #Bitcoin #BTC #Ethereum #ETH #Crypto #Cryptocurrency #Altcoins #DeFi #CryptoNews #Blockchain #CryptoTrading #CryptoCommunity #NFTs #HODL #DYOR", reward:"1T $NFTFAN" }
];

/* ---------------- DOM Helpers ---------------- */
const $ = id => document.getElementById(id);
function show(el){ el.style.display='block'; }
function hide(el){ el.style.display='none'; }

/* ---------------- UI Messages ---------------- */
function showWait(){ $('waitModal').style.display='flex'; }
function hideWait(){ $('waitModal').style.display='none'; }
function showError(msg){ const d=$('loginError'); d.textContent=msg; d.style.display='block'; }
function showSuccess(msg){ const d=$('loginSuccess'); d.textContent=msg; d.style.display='block'; }
function clearMessages(){ hide($('loginError')); hide($('loginSuccess')); }

/* ---------------- Navigation ---------------- */
function switchSection(section){
  document.querySelectorAll('.section').forEach(s=>{s.classList.remove('active');s.style.display='none';});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(section==='login'){
    show($('loginSection')); $('loginSection').classList.add('active');
    $('navHome').classList.add('active');
  } else if(section==='main'){
    if(!currentUser){ switchSection('login'); return; }
    show($('mainSection')); $('mainSection').classList.add('active');
    $('navPromoter').classList.add('active');
  } else if(section==='leaderboard'){
    show($('leaderboardSection')); $('leaderboardSection').classList.add('active');
    $('navLeaderboard').classList.add('active');
    loadLeaderboard(false);
  }
}
function switchMainTab(tab){
  document.querySelectorAll('#mainTabs .tab').forEach(t=>t.classList.remove('active'));
  ['promoterSection','tweetsSection','mainLeaderboardSection'].forEach(id=>{
    $(id).classList.remove('active'); $(id).style.display='none';
  });
  if(tab==='promoter'){ $('promoterTab').classList.add('active'); show($('promoterSection')); $('promoterSection').classList.add('active'); }
  else if(tab==='tweets'){ $('tweetsTab').classList.add('active'); show($('tweetsSection')); $('tweetsSection').classList.add('active'); renderTweetTasks(); }
  else { $('mainLeaderboardTab').classList.add('active'); show($('mainLeaderboardSection')); $('mainLeaderboardSection').classList.add('active'); loadLeaderboard(true); }
}

/* ---------------- Utilities ---------------- */
function getTodayMidnightUTC(){
  const now=new Date(); return Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),now.getUTCDate(),0,0,0,0);
}
function twitterAvatar(username){
  const uname=username.replace(/^@/,'');
  return `https://unavatar.io/twitter/${uname}`;
}

/* ---------------- Auth ---------------- */
async function loginOrRegisterUser(e){
  e.preventDefault();
  clearMessages();
  const username=$('loginUsernameInput').value.trim();
  if(!/^@[A-Za-z0-9_]{2,32}$/.test(username)){ showError("Enter a valid X username (e.g. @username)"); return; }
  showWait();
  const key=encodeURIComponent(username);
  const userRef=ref(db,'promoters/'+key);
  try{
    const snap=await get(userRef);
    if(!snap.exists()){
      await set(userRef,{promoPoints:0,registeredAt:Date.now()});
      showSuccess("Registration successful!");
      currentUser={ username, promoPoints:0, avatarUrl: twitterAvatar(username) };
    } else {
      const data=snap.val();
      showSuccess("Login successful!");
      currentUser={ username, promoPoints:data.promoPoints||0, avatarUrl: twitterAvatar(username) };
    }
    await loadUserData();
    setTimeout(()=>{ switchSection('main'); hideWait(); },600);
  }catch(err){
    console.error(err);
    showError("Error connecting. Try again.");
    hideWait();
  }
}
function logoutUser(){
  currentUser=null; currentWallets=[]; currentGroupKey=""; currentGroupStatus=""; lastGroupUsernames=[];
  hide($('topbar'));
  switchSection('login');
}

/* ---------------- User / Wallets ---------------- */
async function loadUserData(){
  if(!currentUser) return;
  const key=encodeURIComponent(currentUser.username);
  try{
    const snap=await get(ref(db,'promoters/'+key));
    if(snap.exists()){
      currentUser.promoPoints = snap.val().promoPoints || 0;
      show($('topbar'));
      $('topbarXPic').src = currentUser.avatarUrl;
      $('topbarDisplayName').textContent = currentUser.username;
      $('topbarScoreValue').textContent = currentUser.promoPoints+'T';
      $('userWelcome').textContent = `Welcome, ${currentUser.username}`;
      $('promoPoints').textContent = `Promo Points: ${currentUser.promoPoints}`;
      $('tokensEarned').textContent = `$NFTFAN tokens earned: ${currentUser.promoPoints}T`;
      await loadWallets();
    }
  }catch(e){ console.error("loadUserData",e); }
}

async function loadWallets(){
  if(!currentUser) return;
  const key=encodeURIComponent(currentUser.username);
  try{
    const snap=await get(ref(db,'promoters/'+key+'/wallets'));
    const wallets = snap.val() || [];
    currentWallets = Array.isArray(wallets) ? wallets :
                     (wallets && typeof wallets==='object') ? Object.values(wallets) : [];
    renderWalletTable();
  }catch(e){ console.error("loadWallets",e); }
}
function renderWalletTable(){
  const tbody=$('walletTable').querySelector('tbody');
  tbody.innerHTML='';
  if(!currentWallets.length){
    tbody.innerHTML=`<tr><td colspan="2" style="font-size:9px;color:var(--text-secondary);text-align:center;">No wallets added yet</td></tr>`;
    return;
  }
  currentWallets.forEach(w=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="font-size:9px;">${w}</td>
      <td><button class="wallet-copy-btn" data-wallet="${w}"><span class="material-icons" style="font-size:9px;">content_copy</span></button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('.wallet-copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>copyWallet(btn.dataset.wallet));
  });
}
async function addWallet(e){
  e.preventDefault();
  if(!currentUser) return;
  let wallet=$('walletInput').value.trim();
  if(!/^0x[a-fA-F0-9]{40}$/.test(wallet)){ alert("Invalid EVM wallet."); return; }
  if(currentWallets.includes(wallet)){ alert("Already added."); return; }
  currentWallets.push(wallet);
  try{
    await set(ref(db,'promoters/'+encodeURIComponent(currentUser.username)+'/wallets'), currentWallets);
    renderWalletTable();
    $('walletInput').value='';
  }catch(e){ console.error(e); alert("Failed to add wallet."); }
}
function copyWallet(w){ navigator.clipboard.writeText(w); alert('Copied wallet: '+w); }

/* ---------------- Groups ---------------- */
async function getGroup(){
  if(!currentUser) return;
  const key=encodeURIComponent(currentUser.username);
  const today=getTodayMidnightUTC();
  try{
    const histSnap=await get(ref(db,'promoters/'+key+'/airdropHistory'));
    const hist=histSnap.val()||{};
    let last24=0; for(const k in hist){ if(parseInt(k)>=today) last24+=hist[k]; }
    if(last24>=9){
      $('groupList').innerHTML=`<div style='color:var(--warning);text-align:center;font-weight:bold;padding:8px 0;'>Limit reached (9 / 24h). Come back tomorrow.</div>`;
      hide($('copyAllBtn')); $('groupStatus').innerHTML=''; return;
    }
    const userSnap=await get(ref(db,'promoters/'+key));
    const userData=userSnap.val()||{};
    if(userData.assignedGroup){
      const grpSnap=await get(ref(db,'groups/'+userData.assignedGroup));
      const grp=grpSnap.val();
      if(grp && grp.status==='pending'){ return showGroup(userData.assignedGroup, grp); }
    }
    await assignNewGroup(last24);
  }catch(e){
    console.error("getGroup",e);
    alert("Failed to get usernames.");
  }
}
async function assignNewGroup(last24){
  const q=query(ref(db,'groups'),orderByChild('status'),equalTo('pending'));
  const snap=await get(q);
  const groups=snap.val()||{};
  for(const k of Object.keys(groups)){
    if(!groups[k].assignedTo){
      if(last24+3>9){
        $('groupList').innerHTML=`<div style='color:var(--warning);text-align:center;font-weight:bold;padding:8px 0;'>Limit reached (9 / 24h). Come back tomorrow.</div>`;
        hide($('copyAllBtn')); $('groupStatus').innerHTML=''; return;
      }
      await update(ref(db,'groups/'+k),{assignedTo:currentUser.username});
      await update(ref(db,'promoters/'+encodeURIComponent(currentUser.username)),{assignedGroup:k});
      return showGroup(k,{...groups[k],assignedTo:currentUser.username});
    }
  }
  $('groupList').innerHTML=`<div style='text-align:center;color:var(--text-secondary);padding:8px 0;'>No pending groups now. Try later.</div>`;
  hide($('copyAllBtn'));
}
async function showGroup(groupKey, group){
  currentGroupKey=groupKey;
  currentGroupStatus=group.status;
  lastGroupUsernames=group.usernames||[];
  $('groupStatus').innerHTML=`Group status: <span class='status-badge ${group.status==='done'?'done':'pending'}'>${group.status}</span>`;
  const list=$('groupList'); list.innerHTML='';
  for(const u of group.usernames){
    const uname=decodeURIComponent(u);
    const row=document.createElement('div');
    row.className='username-item';
    row.innerHTML=`<div style="display:flex;align-items:center;gap:8px;">
        <img src="${twitterAvatar(uname)}" class="leaderboard-avatar" title="${uname}" style="width:16px;height:16px;">
        <a href="https://x.com/${uname.replace('@','')}" target="_blank" style="color:var(--primary);text-decoration:none;">${uname}</a>
      </div>
      <button class="username-copy-btn" data-u="${uname}"><span class="material-icons">content_copy</span></button>`;
    list.appendChild(row);
  }
  list.querySelectorAll('.username-copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>copyUsername(btn.dataset.u));
  });
  (group.status==='pending')?show($('copyAllBtn')):hide($('copyAllBtn'));
}
function copyUsername(u){ navigator.clipboard.writeText(u); alert('Copied: '+u); }
async function copyAllUsernames(){
  if(!lastGroupUsernames.length) return;
  navigator.clipboard.writeText(lastGroupUsernames.map(u=>decodeURIComponent(u)).join('\n'));
  if(currentGroupKey && currentGroupStatus==='pending'){
    try{
      await update(ref(db,'groups/'+currentGroupKey),{status:'done'});
      const key=encodeURIComponent(currentUser.username);
      const userSnap=await get(ref(db,'promoters/'+key));
      const data=userSnap.val()||{};
      const newPoints=(data.promoPoints||0)+3;
      await update(ref(db,'promoters/'+key),{promoPoints:newPoints,assignedGroup:null});
      currentUser.promoPoints=newPoints;
      $('promoPoints').textContent=`Promo Points: ${newPoints}`;
      $('tokensEarned').textContent=`$NFTFAN tokens earned: ${newPoints}T`;
      $('topbarScoreValue').textContent=`${newPoints}T`;
      await runTransaction(ref(db,'promoters/'+key+'/airdropHistory/'+getTodayMidnightUTC()), val => (val||0)+3);
      $('groupStatus').innerHTML=`Group status: <span class='status-badge done'>done</span>`;
      currentGroupStatus='done';
      hide($('copyAllBtn'));
      updateStats();
      loadLeaderboard(true);
      alert('Copied all usernames! (+3T)');
    }catch(e){
      console.error(e);
      alert('Failed to update group.');
    }
  } else {
    alert('Copied all usernames.');
  }
}

/* ---------------- Tweets ---------------- */
function renderTweetTasks(){
  if(!currentUser) return;
  const tasksArea=$('tasksArea'); tasksArea.innerHTML='';
  const shares=JSON.parse(localStorage.getItem('nftfans-shares-'+currentUser.username.replace('@',''))||'{}');
  if(!tweetTasks.length){
    tasksArea.innerHTML=`<div style="color:var(--warning);text-align:center;margin-top:22px;">No tweet tasks available.</div>`;
    return;
  }
  tweetTasks.forEach(task=>{
    const last=shares[task.id]?.lastShare||0;
    const earned=shares[task.id]?.earned||0;
    const cooldown=3600000;
    const canShare = !(last && Date.now()-last < cooldown);
    const wrap=document.createElement('div');
    wrap.className='task-card';
    wrap.innerHTML=`
      <div class="task-title"><span class="material-icons">${task.icon}</span>${task.title}</div>
      <div class="tweet-preview">${task.tweet.replace(/\n/g,'<br>')}</div>
      <button class="share-btn" data-id="${task.id}" ${canShare?'':'disabled'}>
        <span class="material-icons">share</span>Share on X
      </button>
      <div class="reward-row">
        <span class="material-icons reward-icon">paid</span>
        <span class="reward-amount">${earned}T $NFTFAN</span>
        <span class="reward-label">Earned</span>
        ${!canShare && last ? `<span style="color:var(--warning);margin-left:auto;font-size:9px;">Cooldown: ${Math.ceil((cooldown-(Date.now()-last))/60000)} min</span>`:''}
      </div>`;
    tasksArea.appendChild(wrap);
  });
  tasksArea.querySelectorAll('.share-btn').forEach(btn=>{
    btn.addEventListener('click',()=>shareTweet(btn.dataset.id));
  });
}
async function shareTweet(id){
  if(!currentUser) return;
  const task=tweetTasks.find(t=>t.id===id); if(!task) return;
  const key=currentUser.username.replace('@','');
  const shares=JSON.parse(localStorage.getItem('nftfans-shares-'+key)||'{}');
  const last=shares[id]?.lastShare||0;
  const cooldown=3600000;
  if(last && Date.now()-last < cooldown){
    alert('You can only share this tweet once every 60 minutes.');
    return;
  }
  window.open('https://x.com/intent/tweet?text='+encodeURIComponent(task.tweet),'_blank');
  shares[id]={ lastShare:Date.now(), earned:(shares[id]?.earned||0)+1 };
  localStorage.setItem('nftfans-shares-'+key, JSON.stringify(shares));
  // Increase promo points
  const userKey=encodeURIComponent(currentUser.username);
  try{
    const userRef=ref(db,'promoters/'+userKey);
    const snap=await get(userRef);
    const data=snap.val()||{};
    const newPoints=(data.promoPoints||0)+1;
    await update(userRef,{promoPoints:newPoints});
    currentUser.promoPoints=newPoints;
    $('promoPoints').textContent=`Promo Points: ${newPoints}`;
    $('tokensEarned').textContent=`$NFTFAN tokens earned: ${newPoints}T`;
    $('topbarScoreValue').textContent=`${newPoints}T`;
    renderTweetTasks();
    updateStats();
    alert('Tweet shared! (+1T)');
  }catch(e){
    console.error(e);
    alert('Failed to update score.');
  }
}

/* ---------------- Leaderboard & Stats ---------------- */
async function loadLeaderboard(inMain){
  const list = inMain ? $('mainLeaderboardList') : $('leaderboardList');
  list.innerHTML='<div style="text-align:center;color:var(--text-secondary);padding:10px;">Loading...</div>';
  try{
    const snap=await get(ref(db,'promoters'));
    const promoters=snap.val()||{};
    let arr=[];
    for(const enc in promoters){
      const u=decodeURIComponent(enc);
      const wallets=Array.isArray(promoters[enc].wallets)?promoters[enc].wallets:
                    promoters[enc].wallets?Object.values(promoters[enc].wallets):[];
      arr.push({ username:u, points:promoters[enc].promoPoints||0, wallets });
    }
    arr.sort((a,b)=>b.points-a.points);
    list.innerHTML='';
    if(!arr.length){
      list.innerHTML='<div style="text-align:center;color:var(--text-secondary);padding:10px;">No promoters yet.</div>';
      return;
    }
    arr.forEach((user,idx)=>{
      const item=document.createElement('div');
      item.className='leaderboard-item';
      item.innerHTML=`
        <span class="leaderboard-rank" style="${idx<3?'color:var(--warning);':''}">${idx+1}</span>
        <span class="leaderboard-user">
          <img src="${twitterAvatar(user.username)}" class="leaderboard-avatar" title="${user.username}">
          <a href="https://x.com/${user.username.replace('@','')}" target="_blank" style="color:var(--primary);text-decoration:none;">${user.username}</a>
        </span>
        <span class="leaderboard-points">${user.points}T</span>`;
      list.appendChild(item);
      if(user.wallets.length){
        const wt=document.createElement('table');
        wt.className='wallet-table';
        wt.style.marginLeft='38px';
        const tb=document.createElement('tbody');
        user.wallets.forEach(w=>{
          const tr=document.createElement('tr');
            tr.innerHTML=`<td style="font-size:8px;">${w}</td>
                          <td><button class="wallet-copy-btn" data-wallet="${w}">
                          <span class="material-icons" style="font-size:9px;">content_copy</span></button></td>`;
          tb.appendChild(tr);
        });
        wt.appendChild(tb); list.appendChild(wt);
        tb.querySelectorAll('.wallet-copy-btn').forEach(btn=>{
          btn.addEventListener('click',()=>{navigator.clipboard.writeText(btn.dataset.wallet);alert('Copied wallet: '+btn.dataset.wallet);});
        });
      }
    });
  }catch(e){
    console.error(e);
    list.innerHTML='<div style="text-align:center;color:#ff4757;padding:10px;">Failed to load leaderboard.</div>';
  }
}
async function updateStats(){
  try{
    const promSnap=await get(ref(db,'promoters'));
    const promoters=promSnap.val()||{};
    let totalPromoters=Object.keys(promoters).length;
    let totalTokens=0;
    Object.values(promoters).forEach(p=> totalTokens += (p.promoPoints||0));
    const grpSnap=await get(ref(db,'groups'));
    const groups=grpSnap.val()||{};
    const unameSet=new Set();
    Object.values(groups).forEach(g=>{
      if(Array.isArray(g.usernames)) g.usernames.forEach(u=>unameSet.add(decodeURIComponent(u)));
    });
    $('statTotalPromoters').textContent=totalPromoters.toLocaleString();
    $('statTotalMentions').textContent=unameSet.size.toLocaleString();
    $('statTotalTokens').textContent=totalTokens.toLocaleString()+'T';
  }catch(e){ console.error("updateStats",e); }
}

/* ---------------- Event Listeners ---------------- */
$('loginForm').addEventListener('submit', loginOrRegisterUser);
$('walletForm').addEventListener('submit', addWallet);
$('logoutBtn').addEventListener('click', logoutUser);
$('getGroupBtn').addEventListener('click', getGroup);
$('copyAllBtn').addEventListener('click', copyAllUsernames);
document.querySelectorAll('#mainTabs .tab').forEach(tab=>{
  tab.addEventListener('click', ()=> switchMainTab(tab.dataset.tab));
});
document.querySelectorAll('.bottom-nav .nav-item').forEach(nav=>{
  nav.addEventListener('click', e=>{ e.preventDefault(); switchSection(nav.dataset.nav); });
});

/* ---------------- Init ---------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const stored=sessionStorage.getItem('nftfans-user');
  if(stored){
    try{
      currentUser=JSON.parse(stored);
      loadUserData().then(()=>switchSection('main'));
    }catch(e){
      console.error(e); sessionStorage.removeItem('nftfans-user');
    }
  }
  updateStats();
  setInterval(updateStats,30000);
  loadLeaderboard(false);
});

/* Store session on unload */
window.addEventListener('beforeunload', ()=>{
  if(currentUser) sessionStorage.setItem('nftfans-user', JSON.stringify(currentUser));
});

/* Expose (if needed) */
window.switchSection = switchSection;
window.switchMainTab = switchMainTab;
</script>
</body>
</html>
