<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NFTFans Unified Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://i.imgur.com/g8B2Old.png">
<style>
:root {
    --primary: #5273e0;
    --accent: #9d7fe2;
    --secondary: #3cabb9;
    --success: #42b883;
    --warning: #f0b86e;
    --background: #0d1117;
    --foreground: #181d26;
    --card-bg: #1c2333;
    --border-radius: 8px;
    --shadow: 0 2px 8px rgba(20, 24, 60, 0.12);
    --text: #dce1ea;
    --text-secondary: #8c93a6;
    --input-bg: #1e2536;
    --input-border: #2a334a;
    --inactive: #465166;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html, body {
    width: 100%;
    max-width: 100%;
    overflow-x: hidden;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--background);
    color: var(--text);
    font-size: 9px;
    letter-spacing: 0.01em;
    min-height: 100vh;
    line-height: 1.4;
}

.container {
    max-width: 100%;
    width: 330px;
    margin: 0 auto;
    padding: 10px 10px 56px 10px;
    position: relative;
    z-index: 2;
}

.banner-img {
    width: 100%;
    height: 60px;
    object-fit: cover;
    border-radius: var(--border-radius);
    margin-bottom: 8px;
    box-shadow: var(--shadow);
    border: 1px solid var(--input-border);
}

h1 {
    text-align: center;
    color: var(--accent);
    margin: 4px 0;
    font-size: 10px;
    letter-spacing: 0.05em;
    font-weight: 600;
}

h2 {
    text-align: center;
    font-size: 8px;
    margin: 2px 0 8px 0;
    color: var(--text-secondary);
    font-weight: normal;
    line-height: 1.3;
}

/* Topbar */
.topbar {
    width: 100%;
    margin: 0 auto 8px auto;
    background: var(--foreground);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 8px;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    min-height: 26px;
}

.topbar-left {
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 0;
    overflow: hidden;
}

.topbar-xpic {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--secondary);
    background: var(--input-bg);
    flex-shrink: 0;
}

.topbar-xname {
    font-weight: 600;
    color: var(--warning);
    font-size: 9px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 90px;
}

.topbar-score {
    background: var(--input-bg);
    color: var(--success);
    font-weight: 600;
    font-size: 8px;
    border-radius: 4px;
    padding: 3px 6px;
    display: flex;
    align-items: center;
    gap: 3px;
    min-width: 50px;
}

.topbar-score .material-icons {
    font-size: 9px !important;
    color: var(--warning);
}

/* Stats Bar */
.stats-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin: 0 0 8px 0;
    gap: 4px;
}

.stat-box {
    flex: 1;
    background: var(--foreground);
    color: var(--primary);
    border-radius: 6px;
    padding: 4px;
    text-align: center;
    font-weight: 600;
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 9px;
}

.stat-label {
    font-size: 8px;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 2px;
    letter-spacing: 0.01em;
    line-height: 1;
}

/* Navigation Tabs */
.tabs {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    background: var(--foreground);
    border-radius: var(--border-radius);
    padding: 2px;
    box-shadow: var(--shadow);
}

.tab {
    flex: 1;
    text-align: center;
    padding: 5px 0 4px 0;
    cursor: pointer;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 8px;
    transition: all 0.15s;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1px;
}

.tab.active {
    color: var(--primary);
    background-color: rgba(82, 115, 224, 0.08);
}

.tab .material-icons {
    font-size: 9px !important;
}

/* Sections */
.section {
    display: none;
    margin-top: 6px;
}

.section.active {
    display: block;
}

/* Forms */
label {
    font-size: 9px;
    font-weight: 500;
    margin-bottom: 3px;
    display: block;
    color: var(--text-secondary);
    letter-spacing: 0.01em;
}

input[type="text"], input[type="password"], input[type="number"] {
    width: 100%;
    font-size: 9px;
    padding: 6px 8px;
    margin-bottom: 6px;
    border-radius: 5px;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
    color: var(--text);
    transition: border 0.15s;
    letter-spacing: 0.01em;
}

input:focus {
    border-color: var(--primary);
    outline: none;
}

button {
    width: 100%;
    font-size: 9px;
    padding: 6px 0;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    border: none;
    border-radius: 5px;
    color: #fff;
    font-weight: 600;
    margin: 4px 0 6px 0;
    box-shadow: 0 1px 3px rgba(74, 58, 255, 0.08);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
}

button:active {
    opacity: 0.9;
    transform: translateY(1px);
}

/* Cards */
.card {
    background: var(--foreground);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin: 8px 0;
    padding: 10px 8px;
    border: 1px solid var(--input-border);
    position: relative;
    overflow: hidden;
}

/* Messages */
.error-msg, .success-msg {
    border-radius: 4px;
    margin-bottom: 6px;
    padding: 5px 7px;
    font-size: 8px;
    display: none;
}

.error-msg {
    color: #ff6b81;
    background: rgba(255, 107, 129, 0.08);
    border-left: 2px solid #ff6b81;
}

.success-msg {
    color: var(--success);
    background: rgba(66, 184, 131, 0.08);
    border-left: 2px solid var(--success);
}

/* Leaderboard */
.leaderboard-list {
    background: var(--card-bg);
    border-radius: 6px;
    padding: 6px;
    margin-top: 5px;
    margin-bottom: 2px;
}

.leaderboard-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid var(--input-border);
    font-size: 9px;
}

.leaderboard-item:last-child {
    border-bottom: none;
}

.leaderboard-rank {
    font-weight: 600;
    color: var(--accent);
    margin-right: 5px;
    min-width: 16px;
    text-align: center;
}

.leaderboard-user {
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 4px;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

.leaderboard-avatar {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--input-border);
    background: var(--input-bg);
}

.leaderboard-points {
    color: var(--success);
    font-weight: 600;
    min-width: 40px;
    text-align: right;
}

/* Wallet table */
.wallet-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 6px;
    margin-bottom: 6px;
    table-layout: fixed;
}

.wallet-table th, .wallet-table td {
    font-size: 8px;
    color: var(--text);
    padding: 3px 2px;
    border-bottom: 1px solid var(--input-border);
    text-align: left;
    vertical-align: middle;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.wallet-table th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 8px;
}

.wallet-table td:first-child {
    max-width: 80%;
    overflow: hidden;
    text-overflow: ellipsis;
}

.wallet-table td:last-child {
    width: 20%;
    text-align: right;
}

.wallet-copy-btn {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    border-radius: 3px;
    padding: 2px;
    margin: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 8px;
    width: 18px;
    height: 18px;
}

.wallet-copy-btn:active {
    background: rgba(82, 115, 224, 0.1);
}

/* Username list */
.username-list {
    background: var(--card-bg);
    border-radius: 6px;
    padding: 6px;
    margin-top: 5px;
    margin-bottom: 2px;
}

.username-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid var(--input-border);
    font-size: 9px;
}

.username-item:last-child {
    border-bottom: none;
}

.username-copy-btn {
    background: none;
    border: none;
    color: var(--primary);
    cursor: pointer;
    border-radius: 3px;
    padding: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.13s;
    width: 18px;
    height: 18px;
}

.username-copy-btn:active {
    background: rgba(82, 115, 224, 0.1);
}

.copy-all-btn {
    width: 100%;
    margin-top: 5px;
    background: var(--success);
    color: white;
    font-size: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 3px;
}

/* Status badges */
.status-badge {
    display: inline-block;
    padding: 2px 5px;
    border-radius: 4px;
    font-size: 8px;
    font-weight: 600;
    margin-bottom: 5px;
}

.pending {
    background: rgba(240, 184, 110, 0.15);
    color: var(--warning);
}

.done {
    background: rgba(66, 184, 131, 0.15);
    color: var(--success);
}

/* Task cards */
.task-card {
    background: var(--card-bg);
    border: 1px solid var(--input-border);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    margin: 8px 0;
    padding: 8px;
    position: relative;
    color: var(--text);
    transition: box-shadow 0.2s, border 0.2s;
    overflow: hidden;
}

.task-title {
    font-size: 9px;
    font-weight: 600;
    color: var(--warning);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 4px;
    letter-spacing: 0.02em;
}

.tweet-preview {
    display: block;
    font-family: monospace;
    font-size: 8px;
    background: var(--input-bg);
    border-radius: 4px;
    color: var(--text);
    padding: 6px;
    margin: 6px 0 8px 0;
    border: 1px solid var(--input-border);
    word-break: break-word;
    line-height: 1.3;
    max-height: 80px;
    overflow-y: auto;
}

.share-btn {
    background: rgba(29, 161, 242, 0.08);
    color: #1DA1F2;
    border: 1px solid rgba(29, 161, 242, 0.3);
    border-radius: 4px;
    padding: 5px 0;
    font-size: 9px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    cursor: pointer;
    transition: all 0.15s;
    margin: 0;
}

.share-btn .material-icons {
    font-size: 9px;
    color: #1DA1F2;
}

.share-btn[disabled], .share-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: var(--input-bg);
    color: var(--text-secondary);
    border-color: var(--input-border);
}

.reward-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin: 6px 0 0 0;
    color: var(--success);
    flex-wrap: wrap;
    font-size: 8px;
}

.reward-icon {
    color: var(--success);
    font-size: 9px !important;
    vertical-align: middle;
}

.reward-amount {
    font-size: 8px;
    color: var(--success);
    font-weight: 600;
}

.reward-label {
    color: rgba(0, 0, 0, 0.7);
    background: var(--warning);
    font-size: 7px;
    opacity: 0.7;
    margin-left: 2px;
    padding: 1px 3px;
    border-radius: 2px;
}

/* Logout button */
.logout-btn {
    background: var(--input-bg);
    border: none;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 2px;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 8px;
    display: flex;
    align-items: center;
    gap: 2px;
    justify-content: center;
    box-shadow: none;
    height: 18px;
    width: auto;
    transition: all 0.13s;
}

.logout-btn:hover, .logout-btn:active {
    background: rgba(82, 115, 224, 0.1);
    color: var(--accent);
}

/* Wait modal */
#waitModal {
    position: fixed;
    z-index: 1000;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
}

.wait-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(13, 17, 23, 0.85);
    backdrop-filter: blur(2px);
}

.wait-content {
    position: relative;
    z-index: 2;
    background: var(--foreground);
    border-radius: var(--border-radius);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 120px;
}

.loader {
    width: 24px;
    height: 24px;
    border: 2px solid var(--secondary);
    border-top: 2px solid var(--warning);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 8px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.wait-text {
    font-size: 10px;
    color: var(--text);
    font-weight: 600;
    letter-spacing: 0.05em;
}

/* Instructions */
.verify-instructions {
    margin: 6px 0;
    font-size: 8px;
    color: var(--text-secondary);
    background: var(--input-bg);
    border-radius: 4px;
    padding: 6px;
    line-height: 1.5;
    text-align: left;
}

.verify-instructions a {
    color: var(--primary);
    text-decoration: none;
}

/* Footer navigation */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--foreground);
    display: flex;
    justify-content: space-around;
    padding: 6px 0;
    box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.15);
    z-index: 100;
    border-top: 1px solid var(--input-border);
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 8px;
    color: var(--text-secondary);
    text-decoration: none;
    gap: 2px;
    padding: 3px;
    border-radius: 4px;
    transition: all 0.15s;
    flex: 1;
    max-width: 60px;
}

.nav-item.active {
    color: var(--primary);
    background-color: rgba(82, 115, 224, 0.08);
}

.nav-item .material-icons {
    font-size: 14px !important;
}

/* Placeholder */
::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
    font-size: 8px;
}

.material-icons {
    font-size: 10px !important;
    line-height: 1;
}

/* Fix table display for small screens */
@media (max-width: 330px) {
    .container {
        width: 100%;
        padding: 8px 8px 56px 8px;
    }
    
    .stats-bar {
        flex-wrap: wrap;
    }
    
    .stat-box {
        flex: 0 0 31%;
    }
    
    .wallet-table td:first-child {
        max-width: 70%;
    }
    
    .wallet-table td:last-child {
        width: 30%;
    }
    
    .task-card, .card {
        padding: 8px 6px;
    }
    
    .tweet-preview {
        max-height: 70px;
        font-size: 7px;
    }
    
    .banner-img {
        height: 50px;
    }
}
    @keyframes blinkColors {
    0% { color: red; }
    20% { color: orange; }
    40% { color: yellow; }
    60% { color: lime; }
    80% { color: cyan; }
    100% { color: magenta; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.blink-shake-icon {
    animation:
        blinkColors 1s infinite,
        shake 0.4s ease-in-out infinite alternate;
    animation-delay: 0s, 0s;
    animation-timing-function: linear, ease-in-out;
    animation-iteration-count: infinite, infinite;
}

/* Pause the shake periodically */
@keyframes blinkWithPause {
    0%, 25%, 100% { color: red; transform: none; }
    5% { color: orange; transform: translateX(-3px); }
    10% { color: yellow; transform: translateX(3px); }
    15% { color: lime; transform: translateX(-3px); }
    20% { color: cyan; transform: translateX(3px); }
    23% { color: magenta; transform: translateX(0); }
}

.blink-shake-icon {
    animation: blinkWithPause 2s infinite;
}
</style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
        <!-- Topbar -->
        <div class="topbar" id="topbar" style="display: none;">
            <div class="topbar-left">
                <img id="topbarXPic" class="topbar-xpic" src="" alt="X Icon">
                <span class="topbar-xname" id="topbarDisplayName"></span>
            </div>
            <div class="topbar-score" id="topbarScore">
                <span class="material-icons">paid</span>
                <span id="topbarScoreValue">0T</span>
            </div>
        </div>
        
        <!-- Banner -->
        <img class="banner-img" src="https://pbs.twimg.com/media/GuyjoocWYAAm6BT?format=jpg&name=4096x4096" alt="NFTFans Banner">
        
        <!-- Header -->
        <h1>NFTFANS UNIFIED PLATFORM</h1>
        <h2>
            <span style="color: #ff4757; font-weight: bold;">New</span>: Earn tokens by sharing tweets and promoting usernames
        </h2>
        
        <!-- Stats Bar -->
        <div class="stats-bar" id="statsBar">
            <div class="stat-box">
                <span id="statTotalPromoters">-</span>
                <div class="stat-label"><span class="material-icons" style="font-size:10px;">person</span> Promoters</div>
            </div>
            <div class="stat-box">
                <span id="statTotalMentions">-</span>
                <div class="stat-label"><span class="material-icons" style="font-size:10px;">alternate_email</span> Mentions</div>
            </div>
            <div class="stat-box">
                <span id="statTotalTokens">-</span>
                <div class="stat-label"><span class="material-icons" style="font-size:10px;">token</span> Tokens</div>
            </div>
        </div>
        
        <!-- Main Sections -->
        <div class="section active" id="loginSection">
            <div class="card">
                <form id="loginForm">
                    <label for="loginUsernameInput">Enter your X username</label>
                    <input type="text" id="loginUsernameInput" placeholder="@yourusername" autocomplete="username">
                    <button id="loginButton" type="submit"><span class="material-icons">login</span> Login / Register</button>
                    <div id="loginError" class="error-msg"></div>
                    <div id="loginSuccess" class="success-msg"></div>
                </form>
            </div>
        </div>
        
        <div class="section" id="mainSection">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div>
                    <span style="font-size:11px;font-weight:500;color:var(--text-secondary);" id="userWelcome"></span>
                </div>
                <button class="logout-btn" onclick="logoutUser()" title="Logout">
                    <span class="material-icons" style="font-size:14px;">logout</span>
                </button>
            </div>
            
            <!-- User stats -->
            <div class="card">
                <div class="promo-points" id="promoPoints" style="text-align:right;font-weight:bold;color:var(--primary);margin-bottom:5px;font-size:10px;"></div>
                <div class="tokens-earned" id="tokensEarned" style="text-align:right;font-weight:bold;color:var(--success);margin-bottom:5px;font-size:10px;"></div>
                
                <!-- Wallet management -->
                <form id="walletForm" style="margin-bottom:10px;">
                    <label for="walletInput">Submit EVM wallet (0x...)</label>
                    <div style="display:flex;align-items:center;gap:4px;">
                        <input type="text" id="walletInput" placeholder="0x..." autocomplete="off" style="flex:1;">
                        <button type="submit" style="width:auto;padding:6px 8px;font-size:10px;margin:0;"><span class="material-icons" style="font-size:11px;">add</span></button>
                    </div>
                </form>
                <table class="wallet-table" id="walletTable">
                    <thead><tr><th>Wallet</th><th>Copy</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- Main tabs for promoter/tweets sections -->
<div class="tabs" id="mainTabs">
    <div class="tab active" id="promoterTab" onclick="switchMainTab('promoter')">
        <span class="material-icons blink-shake-icon">alternate_email</span>
        Promote
    </div>
    <div class="tab" id="tweetsTab" onclick="switchMainTab('tweets')">
        <span class="material-icons blink-shake-icon">share</span>
        Share Tweets
    </div>
    <div class="tab" id="mainLeaderboardTab" onclick="switchMainTab('leaderboard')">
        <span class="material-icons blink-shake-icon">leaderboard</span>
        Leaderboard
    </div>
</div>
            
            <!-- Promoter section -->
            <div class="section active" id="promoterSection">
                <div class="verify-instructions">
                    <span class="material-icons" style="font-size:11px;vertical-align:top;color:var(--primary);margin-right:2px;">info</span>
                    <b>Paste these usernames under the pinned tweet of <a href="https://x.com/nftfanstoken" target="_blank">@nftfanstoken</a> on X to verify your points. 
                    <br>Note: In 24h you will not get more than <b>9 usernames</b> to paste, so use wisely!</b>
                </div>
                <div id="getGroupSection">
                    <button onclick="getGroup()"><span class="material-icons">group</span>Get 3 Usernames</button>
                    <div id="groupStatus"></div>
                    <div id="groupList" class="username-list"></div>
                    <button class="copy-all-btn" style="display:none;" id="copyAllBtn" onclick="copyAllUsernames()">
                        <span class="material-icons">content_copy</span>Copy All Usernames
                    </button>
                </div>
            </div>
            
            <!-- Tweets section -->
            <div class="section" id="tweetsSection">
                <div id="tasksArea">
                    <!-- Tweet tasks will be loaded here -->
                    <div style="text-align:center;color:var(--text-secondary);margin:20px 0;">Loading tweet tasks...</div>
                </div>
            </div>
            
            <!-- Main leaderboard section -->
            <div class="section" id="mainLeaderboardSection">
                <div style="text-align:center;font-size:12px;color:var(--accent);font-weight:600;margin-bottom:7px;">
                    <span class="material-icons" style="vertical-align:middle;">leaderboard</span> Leaderboard
                </div>
                <div id="mainLeaderboardList" class="leaderboard-list"></div>
            </div>
        </div>
        
        <div class="section" id="leaderboardSection">
            <div style="text-align:center;font-size:12px;color:var(--accent);font-weight:600;margin-bottom:7px;">
                <span class="material-icons" style="vertical-align:middle;">leaderboard</span> Leaderboard
            </div>
            <div id="leaderboardList" class="leaderboard-list"></div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" id="navHome" onclick="switchSection('login')">
            <span class="material-icons">home</span>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item" id="navPromoter" onclick="switchSection('main')">
            <span class="material-icons">campaign</span>
            <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item" id="navLeaderboard" onclick="switchSection('leaderboard')">
            <span class="material-icons">leaderboard</span>
            <span>Ranks</span>
        </a>
    </div>
    
    <!-- Wait Modal -->
    <div id="waitModal" style="display:none;">
        <div class="wait-backdrop"></div>
        <div class="wait-content">
            <div class="loader"></div>
            <div class="wait-text">Please wait...</div>
        </div>
    </div>

<script>
// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyCYSOx_niWPHLDisCjAQzK8UJSe5TfwtLI",
    authDomain: "nftfanactive.firebaseapp.com",
    databaseURL: "https://nftfanactive-default-rtdb.firebaseio.com",
    projectId: "nftfanactive",
    storageBucket: "nftfanactive.appspot.com",
    messagingSenderId: "311309982791",
    appId: "1:311309982791:web:3e55bba6b78feb57ea6562",
    measurementId: "G-3TRDL9749N"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Global state
let currentUser = null;
let currentWallets = [];
let currentGroupKey = "";
let currentGroupStatus = "";
let lastGroupUsernames = [];
let lastFetchTime = 0;

// Tweet tasks from second app
const tweetTasks = [
    {
        id: 'tweet4',
        icon: "wallet",
        title: "1M $NFTFAN Drop!",
        tweet: "5B free $NFTFAN \nDrop Solana Wallet \n visit HERE to claim:\nhttp://nftfanstoken.com/apps\n\n$ETH $SOL $BASE $POL $MONAD $SUI SUPPORTED ON\nMETAMASK WALLET, TRUST WALLET, BASE WALLET, BITGET WALLET, PHANTOM WALLET, OKX WALLET",
        reward: "1M $NFTFAN"
    },
    {
        id: 'tweet3',
        icon: "gift",
        title: "Earn 1T Tokens!",
        tweet: "Earn 1 Trillion $NFTFAN TOKENS 💰\n👉 Task: Copy & paste usernames from the link below 🔗 into this post 📣\nhttps://nftfanstoken.com/promoz/\n1 username = 1T $NFTFAN",
        reward: "1T per Share"
    },
    {
        id: 'tweet1',
        icon: "send",
        title: "Share This!",
        tweet: "NFTFans: Earn rewards for sharing tweets.\nJoin us and get 1 trillion $NFTFAN. \n Visit now: \n https://www.nftfanstoken.com/active",
        reward: "1T $NFTFAN"
    },
    {
        id: 'tweet2',
        icon: "send",
        title: "Share This!",
        tweet: "NFTFans: Earn rewards for sharing tweets.\nJoin us and get 1 trillion $NFTFAN. \n Visit now: \n https://www.nftfanstoken.com/active \n #Bitcoin #BTC #Ethereum #ETH #Crypto #Cryptocurrency #Altcoins #DeFi #CryptoNews #Blockchain #CryptoTrading #CryptoCommunity #NFTs #HODL #DYOR",
        reward: "1T $NFTFAN"
    }
];

// Helper Functions
function showWaitModal() {
    document.getElementById('waitModal').style.display = 'flex';
}

function hideWaitModal() {
    document.getElementById('waitModal').style.display = 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function showSuccess(message) {
    const successDiv = document.getElementById('loginSuccess');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
}

function hideMessages() {
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginSuccess').style.display = 'none';
}

// Navigation Functions
function switchSection(section) {
    document.querySelectorAll('.section').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });
    
    document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
    });
    
    if (section === 'login') {
        document.getElementById('loginSection').classList.add('active');
        document.getElementById('loginSection').style.display = 'block';
        document.getElementById('navHome').classList.add('active');
    } 
    else if (section === 'main') {
        if (!currentUser) {
            switchSection('login');
            return;
        }
        document.getElementById('mainSection').classList.add('active');
        document.getElementById('mainSection').style.display = 'block';
        document.getElementById('navPromoter').classList.add('active');
    } 
    else if (section === 'leaderboard') {
        document.getElementById('leaderboardSection').classList.add('active');
        document.getElementById('leaderboardSection').style.display = 'block';
        document.getElementById('navLeaderboard').classList.add('active');
        loadLeaderboard();
    }
}

function switchMainTab(tab) {
    document.querySelectorAll('#mainTabs .tab').forEach(el => {
        el.classList.remove('active');
    });
    
    document.querySelectorAll('#mainSection .section').forEach(el => {
        el.classList.remove('active');
        el.style.display = 'none';
    });
    
    if (tab === 'promoter') {
        document.getElementById('promoterTab').classList.add('active');
        document.getElementById('promoterSection').classList.add('active');
        document.getElementById('promoterSection').style.display = 'block';
    } 
    else if (tab === 'tweets') {
        document.getElementById('tweetsTab').classList.add('active');
        document.getElementById('tweetsSection').classList.add('active');
        document.getElementById('tweetsSection').style.display = 'block';
        renderTweetTasks();
    } 
    else if (tab === 'leaderboard') {
        document.getElementById('mainLeaderboardTab').classList.add('active');
        document.getElementById('mainLeaderboardSection').classList.add('active');
        document.getElementById('mainLeaderboardSection').style.display = 'block';
        loadLeaderboard(true);
    }
}

// Helper: get "midnight UTC" timestamp for today
function getTodayMidnightUTC() {
    const now = new Date();
    return Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 0, 0, 0, 0);
}

// Helper: Get Twitter avatar for username
async function getTwitterAvatar(username) {
    let uname = username.replace(/^@/, '');
    let defaultAvatar = 'https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png';
    try {
        return `https://unavatar.io/twitter/${uname}`;
    } catch (e) {
        return defaultAvatar;
    }
}

// User Authentication
async function loginOrRegisterUser() {
    hideMessages();
    const username = document.getElementById('loginUsernameInput').value.trim();
    
    if (!/^@[A-Za-z0-9_]{2,32}$/.test(username)) {
        showError("Enter a valid X username (e.g. @username)");
        return;
    }
    
    showWaitModal();
    
    try {
        const userRef = db.ref('promoters/' + encodeURIComponent(username));
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();
        
        if (!userData) {
            // New user registration
            await userRef.set({
                promoPoints: 0,
                registeredAt: Date.now()
            });
            currentUser = {
                username: username,
                promoPoints: 0,
                avatarUrl: await getTwitterAvatar(username)
            };
            showSuccess("Registration successful!");
        } else {
            // Existing user login
            currentUser = {
                username: username,
                promoPoints: userData.promoPoints || 0,
                avatarUrl: await getTwitterAvatar(username)
            };
            showSuccess("Login successful!");
        }
        
        // Load user data
        loadUserData();
        
        // Switch to main section
        setTimeout(() => {
            switchSection('main');
            hideWaitModal();
        }, 800);
    } catch (error) {
        console.error("Login/Register error:", error);
        showError("Error connecting to server. Please try again.");
        hideWaitModal();
    }
}

function logoutUser() {
    currentUser = null;
    currentWallets = [];
    currentGroupKey = "";
    currentGroupStatus = "";
    lastGroupUsernames = [];
    
    // Hide topbar
    document.getElementById('topbar').style.display = 'none';
    
    // Switch to login section
    switchSection('login');
}

// Load User Data
async function loadUserData() {
    if (!currentUser) return;
    
    try {
        // Get latest user data
        const userRef = db.ref('promoters/' + encodeURIComponent(currentUser.username));
        const snapshot = await userRef.once('value');
        const userData = snapshot.val();
        
        if (userData) {
            currentUser.promoPoints = userData.promoPoints || 0;
            
            // Update topbar
            document.getElementById('topbar').style.display = '';
            document.getElementById('topbarXPic').src = currentUser.avatarUrl;
            document.getElementById('topbarDisplayName').textContent = currentUser.username;
            document.getElementById('topbarScoreValue').textContent = `${currentUser.promoPoints}T`;
            
            // Update welcome message
            document.getElementById('userWelcome').textContent = `Welcome, ${currentUser.username}`;
            
            // Update points display
            document.getElementById('promoPoints').textContent = `Promo Points: ${currentUser.promoPoints}`;
            document.getElementById('tokensEarned').textContent = `$NFTFAN tokens earned: ${currentUser.promoPoints}T`;
            
            // Load wallets
            loadWallets();
        }
    } catch (error) {
        console.error("Error loading user data:", error);
    }
}

// Wallet Functions
async function loadWallets() {
    if (!currentUser) return;
    
    try {
        const walletsRef = db.ref('promoters/' + encodeURIComponent(currentUser.username) + '/wallets');
        const snapshot = await walletsRef.once('value');
        const wallets = snapshot.val() || [];
        
        currentWallets = [];
        if (Array.isArray(wallets)) {
            currentWallets = wallets;
        } else if (typeof wallets === "object" && wallets !== null) {
            currentWallets = Object.values(wallets);
        }
        
        renderWalletTable();
    } catch (error) {
        console.error("Error loading wallets:", error);
    }
}

function renderWalletTable() {
    const tbody = document.getElementById('walletTable').querySelector('tbody');
    tbody.innerHTML = "";
    
    if (!currentWallets.length) {
        tbody.innerHTML = `<tr><td colspan="2" style="font-size:9px;color:var(--text-secondary);text-align:center;">No wallets added yet</td></tr>`;
        return;
    }
    
    currentWallets.forEach(wallet => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td style="font-size:9px;text-align:left;">${wallet}</td>
            <td>
                <button class="wallet-copy-btn" onclick="copyWallet('${wallet}')">
                    <span class="material-icons" style="font-size:9px;">content_copy</span>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function addWallet(wallet) {
    if (!currentUser) return;
    
    wallet = wallet.trim();
    if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
        alert("Invalid EVM wallet. Must start with 0x and be 42 characters.");
        return;
    }
    
    if (currentWallets.includes(wallet)) {
        alert("This wallet is already added.");
        return;
    }
    
    currentWallets.push(wallet);
    db.ref('promoters/' + encodeURIComponent(currentUser.username) + '/wallets').set(currentWallets)
        .then(() => {
            renderWalletTable();
            document.getElementById('walletInput').value = "";
        })
        .catch(error => {
            console.error("Error adding wallet:", error);
            alert("Failed to add wallet. Please try again.");
        });
}

function copyWallet(wallet) {
    navigator.clipboard.writeText(wallet);
    alert('Copied wallet: ' + wallet);
}

// Group Functions
async function getGroup() {
    if (!currentUser) return;
    
    try {
        const todayMidnight = getTodayMidnightUTC();
        const historyRef = db.ref('promoters/' + encodeURIComponent(currentUser.username) + '/airdropHistory');
        const histSnapshot = await historyRef.once('value');
        const hist = histSnapshot.val() || {};
        
        // Calculate usage in the last 24h
        let last24hCount = 0;
        for (const k in hist) {
            if (parseInt(k) >= todayMidnight) last24hCount += hist[k];
        }
        
        if (last24hCount >= 9) {
            document.getElementById('groupList').innerHTML = `
                <div style='color:var(--warning);text-align:center;font-weight:bold;padding:8px 0;'>
                    Limit reached: In 24h, you can't get more than 9 usernames.<br>Please come back tomorrow!
                </div>
            `;
            document.getElementById('copyAllBtn').style.display = 'none';
            document.getElementById('groupStatus').innerHTML = '';
            return;
        }
        
        // Check if user already has an assigned group
        const userRef = db.ref('promoters/' + encodeURIComponent(currentUser.username));
        const userSnapshot = await userRef.once('value');
        const promoter = userSnapshot.val() || {};
        
        if (promoter.assignedGroup) {
            const groupRef = db.ref('groups/' + promoter.assignedGroup);
            const groupSnapshot = await groupRef.once('value');
            const group = groupSnapshot.val();
            
            if (group && group.status === 'pending') {
                showGroup(promoter.assignedGroup, group);
            } else {
                assignNewGroup(last24hCount);
            }
        } else {
            assignNewGroup(last24hCount);
        }
    } catch (error) {
        console.error("Error getting group:", error);
        alert("Failed to get usernames. Please try again.");
    }
}

async function assignNewGroup(last24hCount) {
    try {
        const pendingGroupsRef = db.ref('groups').orderByChild('status').equalTo('pending');
        const snapshot = await pendingGroupsRef.once('value');
        const groups = snapshot.val() || {};
        
        let assigned = false;
        for (const key in groups) {
            if (!groups[key].assignedTo) {
                if (last24hCount + 3 > 9) {
                    document.getElementById('groupList').innerHTML = `
                        <div style='color:var(--warning);text-align:center;font-weight:bold;padding:8px 0;'>
                            Limit reached: In 24h, you can't get more than 9 usernames.<br>Please come back tomorrow!
                        </div>
                    `;
                    document.getElementById('copyAllBtn').style.display = 'none';
                    document.getElementById('groupStatus').innerHTML = '';
                    return;
                }
                
                await db.ref('groups/' + key).update({ assignedTo: currentUser.username });
                await db.ref('promoters/' + encodeURIComponent(currentUser.username)).update({ assignedGroup: key });
                
                showGroup(key, { ...groups[key], assignedTo: currentUser.username });
                assigned = true;
                break;
            }
        }
        
        if (!assigned) {
            document.getElementById('groupList').innerHTML = `
                <div style='text-align:center;color:var(--text-secondary);padding:8px 0;'>
                    No more pending groups available. Please try again later!
                </div>
            `;
            document.getElementById('copyAllBtn').style.display = 'none';
        }
    } catch (error) {
        console.error("Error assigning new group:", error);
        alert("Failed to get usernames. Please try again.");
    }
}

async function showGroup(groupKey, group) {
    currentGroupKey = groupKey;
    currentGroupStatus = group.status;
    lastGroupUsernames = group.usernames || [];
    
    document.getElementById('groupStatus').innerHTML = `
        Group status: <span class='status-badge ${group.status === "done" ? "done" : "pending"}'>
            ${group.status}
        </span>
    `;
    
    const listDiv = document.getElementById('groupList');
    listDiv.innerHTML = '';
    
    for (const encodedUsername of group.usernames) {
        const username = decodeURIComponent(encodedUsername);
        const avatar = await getTwitterAvatar(username);
        
        const div = document.createElement('div');
        div.className = 'username-item';
        div.innerHTML = `
            <div style="display:flex;align-items:center;gap:8px;">
                <img src="${avatar}" class="leaderboard-avatar" title="${username}" style="width:16px;height:16px;">
                <a href="https://x.com/${username.replace('@', '')}" target="_blank" style="color:var(--primary);text-decoration:none;">
                    ${username}
                </a>
            </div>
            <button class="username-copy-btn" onclick="copyUsername('${username}')">
                <span class="material-icons">content_copy</span>
            </button>
        `;
        listDiv.appendChild(div);
    }
    
    document.getElementById('copyAllBtn').style.display = group.status === 'pending' ? '' : 'none';
}

function copyUsername(username) {
    navigator.clipboard.writeText(username);
    alert('Copied to clipboard: ' + username);
}

async function copyAllUsernames() {
    if (!lastGroupUsernames.length) return;
    
    const textToCopy = lastGroupUsernames.map(u => decodeURIComponent(u)).join('\n');
    navigator.clipboard.writeText(textToCopy);
    
    if (currentGroupKey && currentGroupStatus === "pending") {
        try {
            await db.ref('groups/' + currentGroupKey).update({ status: "done" });
            
            const userRef = db.ref('promoters/' + encodeURIComponent(currentUser.username));
            const snapshot = await userRef.once('value');
            const data = snapshot.val() || {};
            
            let newPoints = (data.promoPoints || 0) + 3;
            await userRef.update({
                promoPoints: newPoints,
                assignedGroup: null
            });
            
            currentUser.promoPoints = newPoints;
            
            // Update points displays
            document.getElementById('promoPoints').textContent = `Promo Points: ${newPoints}`;
            document.getElementById('tokensEarned').textContent = `$NFTFAN tokens earned: ${newPoints}T`;
            document.getElementById('topbarScoreValue').textContent = `${newPoints}T`;
            
            // Update history
            const todayTs = getTodayMidnightUTC();
            db.ref('promoters/' + encodeURIComponent(currentUser.username) + '/airdropHistory/' + todayTs).transaction(val => (val || 0) + 3);
            
            document.getElementById('groupStatus').innerHTML = "Group status: <span class='status-badge done'>done</span>";
            currentGroupStatus = "done";
            document.getElementById('copyAllBtn').style.display = 'none';
            
            // Update stats
            updateStats();
            
            // Refresh leaderboard
            loadLeaderboard(true);
            
            alert(`Copied all usernames to clipboard! (+3 Promo Points, +3T $NFTFAN tokens)`);
        } catch (error) {
            console.error("Error updating group status:", error);
            alert("Failed to update group status. Please try again.");
        }
    } else {
        alert('Copied all usernames to clipboard!');
    }
}

// Tweet Functions
function renderTweetTasks() {
    if (!currentUser) return;
    
    const tasksArea = document.getElementById('tasksArea');
    tasksArea.innerHTML = '';
    
    // Get shares from localStorage
    const shares = JSON.parse(localStorage.getItem(`nftfans-shares-${currentUser.username.replace('@', '')}`) || '{}');
    
    if (tweetTasks.length === 0) {
        tasksArea.innerHTML = `<div style="color:var(--warning);text-align:center;margin-top:22px;">No tweet tasks available yet.</div>`;
        return;
    }
    
    tweetTasks.forEach(task => {
        let canShare = true;
        let lastShare = shares[task.id]?.lastShare || 0;
        let earned = shares[task.id]?.earned || 0;
        let cooldown = 60 * 60 * 1000; // 1 hour
        
        if (lastShare && Date.now() - lastShare < cooldown) canShare = false;
        
        const taskDiv = document.createElement('div');
        taskDiv.className = 'task-card';
        taskDiv.id = `task-${task.id}`;
        
        taskDiv.innerHTML = `
            <div class="task-title">
                <span class="material-icons">${task.icon}</span>
                ${task.title}
            </div>
            <div class="tweet-preview">${task.tweet.replace(/\n/g, '<br>')}</div>
            <button class="share-btn" id="shareBtn-${task.id}" ${canShare ? '' : 'disabled'}>
                <span class="material-icons">share</span>
                Share on X
            </button>
            <div class="reward-row">
                <span class="material-icons reward-icon">paid</span>
                <span class="reward-amount">${earned}T $NFTFAN</span>
                <span class="reward-label">Earned</span>
                ${!canShare && lastShare ? 
                    `<span style="color:var(--warning);margin-left:auto;font-size:9px;">
                        Cooldown: ${Math.ceil((cooldown - (Date.now() - lastShare)) / 60000)} min left
                    </span>` : ''}
            </div>
        `;
        
        tasksArea.appendChild(taskDiv);
        
        // Add event listener to share button
        const shareBtn = document.getElementById(`shareBtn-${task.id}`);
        if (shareBtn) {
            shareBtn.addEventListener('click', () => shareTweet(task));
        }
    });
}

async function shareTweet(task) {
    if (!currentUser) return;
    
    // Get current shares
    const shares = JSON.parse(localStorage.getItem(`nftfans-shares-${currentUser.username.replace('@', '')}`) || '{}');
    
    let lastShare = shares[task.id]?.lastShare || 0;
    let cooldown = 60 * 60 * 1000; // 1 hour
    
    if (lastShare && Date.now() - lastShare < cooldown) {
        alert('You can only share this tweet once every 60 minutes.');
        return;
    }
    
    // Open tweet in a new window
    window.open(`https://x.com/intent/tweet?text=${encodeURIComponent(task.tweet)}`, "_blank");
    
    // Update shares
    shares[task.id] = {
        lastShare: Date.now(),
        earned: (shares[task.id]?.earned || 0) + 1 // Add 1T $NFTFAN per share
    };
    localStorage.setItem(`nftfans-shares-${currentUser.username.replace('@', '')}`, JSON.stringify(shares));
    
    // Calculate total earned
    let earnedSum = Object.values(shares).reduce((sum, t) => sum + (t.earned || 0), 0);
    
    try {
        // Update user's score in the database
        const newPoints = currentUser.promoPoints + 1;
        await db.ref('promoters/' + encodeURIComponent(currentUser.username)).update({
            promoPoints: newPoints
        });
        
        currentUser.promoPoints = newPoints;
        
        // Update UI
        document.getElementById('promoPoints').textContent = `Promo Points: ${newPoints}`;
        document.getElementById('tokensEarned').textContent = `$NFTFAN tokens earned: ${newPoints}T`;
        document.getElementById('topbarScoreValue').textContent = `${newPoints}T`;
        
        // Refresh tweet tasks
        renderTweetTasks();
        
        // Update stats
        updateStats();
        
        alert(`Tweet shared successfully! (+1T $NFTFAN tokens)`);
    } catch (error) {
        console.error("Error updating user score:", error);
        alert("Failed to update score. Please try again.");
    }
}

// Leaderboard Functions
async function loadLeaderboard(mainSection = false) {
    const leaderboardList = mainSection ?
        document.getElementById('mainLeaderboardList') :
        document.getElementById('leaderboardList');
    
    leaderboardList.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:10px;">Loading...</div>';
    
    try {
        const promotersRef = db.ref('promoters');
        const snapshot = await promotersRef.once('value');
        const promoters = snapshot.val() || {};
        
        let users = [];
        for (const encodedUsername in promoters) {
            const username = decodeURIComponent(encodedUsername);
            users.push({
                username: username,
                points: promoters[encodedUsername].promoPoints || 0,
                wallets: Array.isArray(promoters[encodedUsername].wallets) ? promoters[encodedUsername].wallets :
                    promoters[encodedUsername].wallets ? Object.values(promoters[encodedUsername].wallets) : []
            });
        }
        
        // Sort by points (descending)
        users.sort((a, b) => b.points - a.points);
        
        leaderboardList.innerHTML = '';
        
        if (users.length === 0) {
            leaderboardList.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:10px;">No promoters yet.</div>';
            return;
        }
        
        for (let idx = 0; idx < Math.min(users.length, 10000); idx++) {
            const user = users[idx];
            const avatarUrl = await getTwitterAvatar(user.username);
            
            const div = document.createElement('div');
            div.className = 'leaderboard-item';
            div.innerHTML = `
                <span class="leaderboard-rank" style="${idx < 3 ? 'color:var(--warning);':''}">${idx + 1}</span>
                <span class="leaderboard-user">
                    <img src="${avatarUrl}" class="leaderboard-avatar" title="${user.username}">
                    <a href="https://x.com/${user.username.replace('@', '')}" target="_blank" style="color:var(--primary);text-decoration:none;">${user.username}</a>
                </span>
                <span class="leaderboard-points">${user.points}T</span>
            `;
            leaderboardList.appendChild(div);
            
            // Show wallets under each user in leaderboard
            if (user.wallets && user.wallets.length) {
                const walletTable = document.createElement('table');
                walletTable.className = 'wallet-table';
                walletTable.style.marginLeft = "38px";
                walletTable.style.marginBottom = "6px";
               
                
                const tbody = document.createElement('tbody');
                user.wallets.forEach(wallet => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `

                    `;
                    tbody.appendChild(tr);
                });
                
                walletTable.appendChild(tbody);
                leaderboardList.appendChild(walletTable);
            }
        }
    } catch (error) {
        console.error("Error loading leaderboard:", error);
        leaderboardList.innerHTML = '<div style="text-align:center;color:#ff4757;padding:10px;">Failed to load leaderboard.</div>';
    }
}

// Stats Functions
async function updateStats() {
    try {
        // Get total promoters and tokens
        const promotersRef = db.ref('promoters');
        const promotersSnapshot = await promotersRef.once('value');
        const promoters = promotersSnapshot.val() || {};
        
        let totalPromoters = Object.keys(promoters).length;
        let totalTokens = 0;
        
        for (const key in promoters) {
            totalTokens += promoters[key].promoPoints || 0;
        }
        
        // Get total mentions
        const groupsRef = db.ref('groups');
        const groupsSnapshot = await groupsRef.once('value');
        const groups = groupsSnapshot.val() || {};
        
        let usernames = new Set();
        for (const key in groups) {
            if (groups[key].usernames && Array.isArray(groups[key].usernames)) {
                groups[key].usernames.forEach(u => usernames.add(decodeURIComponent(u)));
            }
        }
        
        // Update stats display
        document.getElementById('statTotalPromoters').textContent = totalPromoters.toLocaleString();
        document.getElementById('statTotalMentions').textContent = usernames.size.toLocaleString();
        document.getElementById('statTotalTokens').textContent = totalTokens.toLocaleString() + "T";
    } catch (error) {
        console.error("Error updating stats:", error);
    }
}

// Utility function to copy wallet from leaderboard
function copyWalletFromLeaderboard(wallet) {
    navigator.clipboard.writeText(wallet);
    alert('Copied wallet: ' + wallet);
}

// Event Listeners
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loginOrRegisterUser();
});

document.getElementById('walletForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const wallet = document.getElementById('walletInput').value;
    addWallet(wallet);
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is stored in sessionStorage
    const storedUser = sessionStorage.getItem('nftfans-user');
    if (storedUser) {
        try {
            currentUser = JSON.parse(storedUser);
            loadUserData();
            switchSection('main');
        } catch (e) {
            console.error("Error loading stored user:", e);
            sessionStorage.removeItem('nftfans-user');
        }
    }
    
    // Initialize stats
    updateStats();
    setInterval(updateStats, 30000); // Update stats every 30 seconds
    
    // Initialize leaderboard
    loadLeaderboard();
});

// Store user in sessionStorage when logged in
function storeUserSession() {
    if (currentUser) {
        sessionStorage.setItem('nftfans-user', JSON.stringify(currentUser));
    }
}

// Expose functions to window
window.switchSection = switchSection;
window.switchMainTab = switchMainTab;
window.copyUsername = copyUsername;
window.copyAllUsernames = copyAllUsernames;
window.copyWallet = copyWallet;
window.copyWalletFromLeaderboard = copyWalletFromLeaderboard;
window.logoutUser = logoutUser;
window.getGroup = getGroup;
</script>
</body>
</html>
