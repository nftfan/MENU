<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no,maximum-scale=1.0">
    <title>ETH Airdrop Console</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.11.1/web3.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#101622 0%,#2c3242 100%);color:#f2f2ff;margin:0;padding:0;min-height:100vh;}
        .container {max-width:400px;background:#1a1c29;margin:24px auto 0;padding:16px 16px 30px 16px;border-radius:14px;box-shadow:0 0 19px #1a1a1ecc,0 1px 2px #31313350;}
        h2 {color:#59aaff;font-size:1.23em;margin-bottom:12px;text-align:center;font-weight:600;letter-spacing:0.7px;}
        .bar {background:#161a27;border-radius:7px;margin-bottom:13px;padding:10px 13px 7px 13px;box-shadow:0 1px 2.5px #23243b33;}
        .bar-label {font-size:0.98em;color:#b5c0e0;}
        .pending-groups-table {width:100%;background:#23243b;border-collapse:collapse;border-radius:8px;overflow:hidden;font-size:13px;margin-bottom:9px;}
        .pending-groups-table th,.pending-groups-table td {padding:8px 7px;border-bottom:1.2px solid #272a3a;}
        .pending-groups-table th {color:#7ee3ff;font-weight:600;background:#23263b;}
        .status-pending {color:#b7b724;font-weight:700;}
        .status-done {color:#2fe68d;font-weight:700;}
        .btn {background:linear-gradient(135deg,#3692fa 0%,#555ff8 100%);color:#fff;border:none;padding:8px 15px;border-radius:5px;font-size:1em;font-weight:500;cursor:pointer;margin:8px 0 6px;transition:background .15s;}
        .btn:disabled {opacity:0.55;cursor:not-allowed;}
        .wallet-info-block {padding:8px 12px;margin:8px auto 12px;background:#212542;border-radius:8px;font-size:1.03em;display:flex;justify-content:space-between;color:#caedfa;}
        .topbar {display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
        .topbar-wallet {color:#93bddf;font-size:0.93em;font-family:monospace;max-width:130px;overflow:hidden;text-overflow:ellipsis;}
        .connect-btn {background:linear-gradient(135deg,#2940a7 0%,#6262b2 100%);color:#fff;border:none;padding:6px 13px;border-radius:20px;font-size:15px;font-weight:600;cursor:pointer;min-width:90px;}
        .airdrop-status {margin:12px 0 0;padding:7px 13px;background:#181c37;border-radius:5px;color:#a9e8ff;font-size:14px;text-align:center;}
        .score-row {text-align:right;font-size:1.01em;margin-bottom:8px;}
        .progress-section {margin:15px 0;display:none;}
        .progress-bar {width:100%;height:12px;background:#161c2e;border-radius:7px;overflow:hidden;}
        .progress-fill {height:100%;background:linear-gradient(90deg,#27e8c6 0%,#227ee3 100%);width:0%;transition:width .3s;}
        .progress-text {text-align:center;margin-top:5px;color:#7fa9f8;font-weight:600;}
        @media (max-width:600px){.container{padding:7px 2vw 18px 2vw;}}
    </style>
</head>
<body>
<div class="container">
    <div class="topbar">
        <h2>ETH Airdrop Console</h2>
        <div>
            <span class="topbar-wallet" id="walletAddress"></span>
            <button class="connect-btn" id="connectBtn" onclick="connectWallet()">Connect</button>
        </div>
    </div>

    <div class="bar">
        <div class="bar-label">Total Pending Wallets: <span id="pendingWallets">0</span></div>
        <div class="bar-label">Pending Groups: <span id="pendingGroups">0</span></div>
    </div>

    <div class="wallet-info-block">
        <span>Your $NFTFAN balance:</span>
        <span id="nftfanBalance">-</span>
        <span>$NFTFAN</span>
    </div>

    <div class="score-row">
        Your Subdrop Score: <span id="subdropScore">-</span>
    </div>

    <table class="pending-groups-table" id="pendingGroupsTable">
        <thead>
            <tr><th>Group #</th><th>Count</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody id="pendingGroupsBody"></tbody>
    </table>

    <div class="progress-section" id="progressSection">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="progress-text" id="progressText">Preparing...</div>
    </div>

    <div class="airdrop-status" id="airdropStatus">Ready</div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
        authDomain: "newnft-47bd7.firebaseapp.com",
        databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
        projectId: "newnft-47bd7",
        storageBucket: "newnft-47bd7.firebasestorage.app",
        messagingSenderId: "172043823738",
        appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const DISTRIBUTOR_ADDRESS = '0x6Ee372b30C73Dd6087ba58F8C4a5Ca77F49BE0b3';
    const NFTFAN_ADDRESS = '0x2017Fcaea540d2925430586DC92818035Bfc2F50';
    const POLYGON_CHAIN_ID = '0x89';

    const ERC20_ABI = [
        {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"}
    ];

    const DISTRIBUTOR_ABI = [
        {"inputs":[{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"distributeTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
        {"inputs":[{"internalType":"address","name":"wallet","type":"address"}],"name":"getSubdropScore","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
        {"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address[]","name":"recipients","type":"address[]"}],"name":"previewDistribution","outputs":[{"internalType":"uint256","name":"successfulDrops","type":"uint256"},{"internalType":"uint256","name":"tokensNeeded","type":"uint256"}],"stateMutability":"view","type":"function"}
    ];

    let web3, userAccount, distributorContract, nftfanContract;

    async function switchToPolygon() {
        try {
            await window.ethereum.request({method: 'wallet_switchEthereumChain', params: [{chainId: POLYGON_CHAIN_ID}]});
        } catch (e) {
            if (e.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{chainId: POLYGON_CHAIN_ID, chainName: 'Polygon', nativeCurrency: {name:'MATIC',symbol:'MATIC',decimals:18}, rpcUrls: ['https://polygon-rpc.com'], blockExplorerUrls: ['https://polygonscan.com']}]
                });
            } else throw e;
        }
    }

    async function connectWallet() {
        if (!window.ethereum) { setStatus('Please install MetaMask'); return null; }
        try {
            await switchToPolygon();
            const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
            userAccount = accounts[0];
            web3 = new Web3(window.ethereum);
            distributorContract = new web3.eth.Contract(DISTRIBUTOR_ABI, DISTRIBUTOR_ADDRESS);
            nftfanContract = new web3.eth.Contract(ERC20_ABI, NFTFAN_ADDRESS);

            document.getElementById('walletAddress').textContent = userAccount.slice(0,6)+'...'+userAccount.slice(-4);
            document.getElementById('connectBtn').textContent = 'Connected';
            document.getElementById('connectBtn').disabled = true;

            await Promise.all([updateBalancesAndScore(), loadDashboard()]);
            setStatus('Wallet connected');
            return userAccount;
        } catch (e) {
            setStatus('Connection failed or rejected');
            console.error(e);
            return null;
        }
    }

    async function loadDashboard() {
        const snap = await db.ref('wallet_groups').once('value');
        const groups = snap.val() || {};
        const keys = Object.keys(groups).sort((a,b) => (parseInt(a.replace('group_','')) || 0) - (parseInt(b.replace('group_','')) || 0));

        let pendingCount = 0, pendingGroups = [];
        keys.forEach((key, idx) => {
            const g = groups[key];
            if (g && g.status !== 'done') {
                const valid = (g.wallets || []).filter(w => /^0x[a-fA-F0-9]{40}$/i.test(w));
                if (valid.length > 0) {
                    pendingCount += valid.length;
                    pendingGroups.push({key, idx: idx+1, count: valid.length, status: g.status || 'pending'});
                }
            }
        });

        document.getElementById('pendingWallets').textContent = pendingCount;
        document.getElementById('pendingGroups').textContent = pendingGroups.length;

        const tbody = document.getElementById('pendingGroupsBody');
        tbody.innerHTML = pendingGroups.length === 0
            ? `<tr><td colspan="4" style="text-align:center;color:#91bfff;">No pending groups</td></tr>`
            : pendingGroups.map(g => `
                <tr>
                    <td>${g.idx}</td>
                    <td>${g.count}</td>
                    <td class="${g.status==='done'?'status-done':'status-pending'}">${g.status}</td>
                    <td><button class="btn" onclick="airdropGroup('${g.key}')">Airdrop</button></td>
                </tr>`).join('');
    }

    async function updateBalancesAndScore() {
        if (!userAccount) return;
        try {
            const [bal, dec, score] = await Promise.all([
                nftfanContract.methods.balanceOf(userAccount).call(),
                nftfanContract.methods.decimals().call(),
                distributorContract.methods.getSubdropScore(userAccount).call()
            ]);
            const formatted = (BigInt(bal) / (10n ** BigInt(dec || 18))).toString();
            document.getElementById('nftfanBalance').textContent = Number(formatted).toLocaleString();
            document.getElementById('subdropScore').textContent = score;
        } catch (e) {
            document.getElementById('nftfanBalance').textContent = 'Error';
            document.getElementById('subdropScore').textContent = '-';
        }
    }

    function setStatus(msg) {
        document.getElementById('airdropStatus').textContent = msg;
    }

    function updateProgress(pct, text) {
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = text || `Processing... ${pct}%`;
    }

    window.airdropGroup = async function(groupKey) {
        if (!userAccount) { await connectWallet(); if (!userAccount) return; }

        const snap = await db.ref('wallet_groups/' + groupKey).once('value');
        const group = snap.val();
        if (!group || group.status === 'done') { setStatus('Group already done or missing'); return; }

        const wallets = (group.wallets || []).filter(w => /^0x[a-fA-F0-9]{40}$/i.test(w));
        if (wallets.length === 0) { setStatus('No valid wallets'); return; }

        document.getElementById('progressSection').style.display = 'block';
        setStatus('Previewing...');

        try {
            const preview = await distributorContract.methods.previewDistribution(userAccount, wallets).call({from: userAccount});
            const needed = BigInt(preview.tokensNeeded || preview[1]);
            const balance = await nftfanContract.methods.balanceOf(userAccount).call();
            if (BigInt(balance) < needed) { setStatus('Not enough $NFTFAN'); return; }

            const allowance = await nftfanContract.methods.allowance(userAccount, DISTRIBUTOR_ADDRESS).call();
            if (BigInt(allowance) < needed) {
                setStatus('Approving tokens...');
                await nftfanContract.methods.approve(DISTRIBUTOR_ADDRESS, '115792089237316195423570985008687907853269984665640564039457584007913129639935').send({from: userAccount});
            }

            setStatus('Airdropping...');
            updateProgress(30, 'Sending transaction...');

            await distributorContract.methods.distributeTokens(wallets).send({
                from: userAccount,
                gas: 6000000
            });

            await db.ref('wallet_groups/' + groupKey).update({status: 'done'});
            updateProgress(100, 'Done!');
            setStatus('Airdrop successful!');
            await Promise.all([loadDashboard(), updateBalancesAndScore()]);
            setTimeout(() => document.getElementById('progressSection').style.display = 'none', 2000);

        } catch (e) {
            console.error(e);
            setStatus('Failed: ' + (e.message || 'Unknown error'));
            document.getElementById('progressSection').style.display = 'none';
        }
    }

    // Auto-connect + refresh
    window.addEventListener('DOMContentLoaded', async () => {
        if (window.ethereum) {
            const accounts = await window.ethereum.request({method: 'eth_accounts'});
            if (accounts.length > 0) {
                userAccount = accounts[0];
                await connectWallet();
            }
        }
        await loadDashboard();
        setInterval(loadDashboard, 20000);
    });
</script>
</body>
</html>
