<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>BTCUSD Guess App</title>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.20.0/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Mono font for clean cyber look -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Share Tech Mono', 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(120deg, #181d23 0%, #255257 100%);
      color: #f9fafb;
      font-size: 10px;
      min-height: 100svh;
      box-sizing: border-box;
      user-select: none;
      transition: background 0.8s;
    }
    .container {
      max-width: 400px;
      margin: 14px auto 0 auto;
      padding: 12px 8px 20px 8px;
      background: #1a232bfc;
      border-radius: 24px;
      box-shadow: 0 2px 12px #0002;
      position: relative;
      z-index: 2;
      border: 1.5px solid #32434c;
      animation: fadein-container 0.8s cubic-bezier(.59,.01,.31,.98);
    }
    @keyframes fadein-container {
      0% { transform: translateY(26px) scale(.90); opacity: 0 }
      51% { opacity: .81 }
      100% { transform: translateY(0) scale(1.0); opacity: 1 }
    }
    .price {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 3px;
      letter-spacing: 1.2px;
      text-align: center;
      color: #36cbe3;
      background: #1b2932;
      padding: 11px 0 8px 0;
      border-radius: 11px;
      transition: color 0.23s;
      animation: slide-fade-in 0.76s cubic-bezier(.54,0,.14,1.04);
    }
    @keyframes slide-fade-in {
      0% { transform: translateY(-20px) scale(.96); opacity: 0.38 }
      100%{ transform: translateY(0) scale(1.0); opacity: 1 }
    }
    .chart-wrap {
      background:#101418;
      border-radius: 8px;
      margin: 0px 0 14px 0;
      padding: 5px 0 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 77px;
      animation: fadein-container 0.7s 0.12s backwards;
      border: 1px solid #27323F;
    }
    .timer {
      font-family: inherit;
      text-align: center;
      color: #43fa9d;
      margin-bottom: 14px;
      font-weight: 700;
      letter-spacing: 1px;
      font-size: 1.08em;
      padding: 0;
      transition: color 0.29s;
      animation: slide-fade-in 0.84s 0.08s backwards;
    }
    .form {
      display: flex;
      flex-direction: column;
      gap: 7px;
      margin-bottom: 14px;
      background: #202e38;
      padding: 12px 10px 12px 10px;
      border-radius: 13px;
      border: 1.5px solid #27323F;
      animation: fadein-container 0.78s 0.19s backwards;
      box-shadow: none;
    }
    input[type="text"], input[type="number"] {
      font-size: 10px;
      padding: 7px 10px;
      border: 1.3px solid #333b43;
      border-radius: 7px;
      background: #161d22;
      color: #b3ecfd;
      outline: none;
      transition: border 0.17s, background .2s;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      caret-color: #20f5b8;
      letter-spacing: .2px;
      animation: inputfade 0.9s backwards;
      box-shadow: none;
    }
    @keyframes inputfade {
      0% { opacity: 0; transform: scale(.98);}
      100% { opacity: 1; transform: scale(1); }
    }
    input[type="text"]:focus, input[type="number"]:focus {
      border: 1.4px solid #2ed7ce;
      background: #194249;
    }
    button {
      padding: 10px 0 7px 0;
      font-size: 10px;
      background: linear-gradient(90deg, #0be6d3 0%, #227fdc 100%);
      color: #171d28;
      font-weight: 700;
      border: none;
      border-radius: 7px;
      margin-top: 2px;
      cursor: pointer;
      transition: background 0.14s, color 0.19s, transform .17s;
      letter-spacing: 1.1px;
      box-shadow: none;
      font-family: inherit;
      animation: fadein-container 0.82s 0.21s backwards;
    }
    button:active {
      background: linear-gradient(90deg, #227fdc 10%, #0be6d3 90%);
      color: #161a20;
      transform: scale(.96);
    }
    .disabled, button:disabled {
      opacity: 0.37;
      pointer-events: none;
    }
    .entries-table {
      width: 100%;
      border-collapse: collapse;
      background: #172026;
      border-radius: 9px;
      overflow: hidden;
      margin-top: 10px;
      font-size: 10px;
      border: 1.3px solid #2a323a;
      box-shadow: none;
      animation: fadein-container 0.9s 0.26s backwards;
    }
    .entries-table th, .entries-table td {
      padding: 5px 4px;
      text-align: left;
      border-bottom: 0.6px solid #242C33;
      font-size: 10px;
      font-family: inherit;
      background: transparent;
      transition: background .17s;
      box-shadow: none;
    }
    .entries-table th {
      background: #212F36;
      color: #81eaf7;
      font-weight: 700;
      border-bottom: 1.2px solid #27323F;
    }
    .entries-table tr:last-child td {
      border-bottom: none;
    }
    .winner {
      background: #1be4c7 !important;
      color: #171832 !important;
      animation: winpop .9s cubic-bezier(.23,1.32,.3,1.02) backwards;
    }
    @keyframes winpop {
      0%{ filter: blur(7px) opacity(0.1); transform:scale(0.92);}
      54%{ filter: blur(0.5px); opacity:0.91;}
      100%{ filter: none; opacity:1; transform:scale(1);}
    }
    .closed-msg {
      text-align: center;
      color: #2779c4;
      background: #232c3a;
      border-radius: 9px;
      padding: 7px 8px 8px 8px;
      margin-bottom: 12px;
      margin-top: 7px;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 0.5px;
      border: 1.5px solid #223249;
    }
    .info {
      font-size: 9px;
      color: #44f7de;
      margin-top: 3px;
      text-align: center;
      letter-spacing: 0px;
      font-family: inherit;
      padding: 1px 0;
    }
    .pnl {
      font-weight: bold;
      font-family: inherit;
      font-size: 10px;
      padding-left: 5px;
      transition: color 0.23s;
    }
    .pnl-pos { color: #38d48e;}
    .pnl-neg { color: #e1465b;}
    .pnl-zero{ color: #e5dc4c;}
    tr:hover {
      filter: brightness(1.12) saturate(1.18);
      background: #19424933 !important;
      transition: .2s;
    }
    /* Hide scrollbar for graph/side UX purity */
    ::-webkit-scrollbar { width: 0 !important; display: none; }
    .chart-wrap {
      animation: chartfadein 1.25s cubic-bezier(.22,1.31,.41,.98);
    }
    @keyframes chartfadein {
      from { opacity: 0; transform: scale(.92);}
      68%{ opacity:.33;}
      to { opacity:1; transform:scale(1);}
    }
    /* Responsive chart */
    @media (max-width:440px){
      .container {max-width:99vw;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="text-align:center;margin-bottom:8px;">
      <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png?v=026" alt="btc" style="width:35px">
    </div>
    <div id="price" class="price">...</div>
    <div class="chart-wrap">
      <canvas id="btcChart" width="365" height="74" style="pointer-events:none;width:99%;height:74px;"></canvas>
    </div>
    <div id="timer" class="timer">Loading...</div>
    <div id="closedMsg" class="closed-msg" style="display:none;">
      Entries are closed.<br>Wait for results!
    </div>
    <form class="form" id="guessForm" autocomplete="off">
      <input autocomplete="off" autocorrect="off" spellcheck="false" inputmode="text" pattern="^@.+" id="xUsername" type="text" placeholder="Your X username, e.g. @xyzzz" required maxlength="24" style="ime-mode:disabled;">
      <input autocomplete="off" autocorrect="off" spellcheck="false" inputmode="decimal" pattern="^[\d\.]+$" min="0" max="999999" maxlength="7" id="usdGuess" type="number" placeholder="Guess price after 24h (USD)" required>
      <button type="submit" id="guessBtn">Submit Guess</button>
    </form>
    <div class="info">(Entries close after 12h. Winner(s) list will show after 24h)<br>PNL = (BTC Live - Your Guess)</div>
    <div id="winnersSection" style="display:none;margin-top:10px;">
      <h3 style="font-size:10px;margin:0 0 4px 0;font-weight:bold;color:#44f7de;">Winners</h3>
      <table class="entries-table" id="winnersTable"></table>
    </div>
    <div id="tableSection" style="margin-top:10px;">
      <h3 style="font-size:10px;margin:0 0 4px 0;font-weight:bold;color:#44f7de;">Guesses</h3>
      <table class="entries-table" id="entriesTable"></table>
    </div>
  </div>
  <script>
    // --- CONFIGURABLES ---
    const firebaseConfig = {
      apiKey: "AIzaSyA6w6auszWRniQfZCjb4nXE_bq9Mzt9dOs",
      authDomain: "betbtc-6d881.firebaseapp.com",
      databaseURL: "https://betbtc-6d881-default-rtdb.firebaseio.com",
      projectId: "betbtc-6d881",
      storageBucket: "betbtc-6d881.appspot.com",
      messagingSenderId: "962176232122",
      appId: "1:962176232122:web:a277d922543c3378033083",
      measurementId: "G-V4XNB7K1E0"
    };

    // Session-related state
    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const SESSION_PATH = '/btc24h_session';
    const ENTRIES_PATH = '/btc24h_entries';
    let session = {
      start: null, close: null, end: null, closePrice: null, endPrice: null,
    };

    async function getOrCreateSession() {
      return new Promise((resolve) => {
        db.ref(SESSION_PATH).once('value').then(async snap => {
          if (snap.exists()) {
            session = {...session, ...snap.val()};
            resolve(session);
          } else {
            const now = Date.now();
            const start = now - (now % 60000);
            const close = start + 12 * 60 * 60 * 1000;
            const end = start + 24 * 60 * 60 * 1000;
            session = { start, close, end, closePrice: null, endPrice: null };
            await db.ref(SESSION_PATH).set(session);
            resolve(session);
          }
        });
      });
    }

    // --- BTC PRICE & HISTORY/CHART ---
    let lastBTC = null;
    let btcHistory = []; // [ {time, price} ]
    let btcChart = null;
    let chartFirst = true;
    async function fetchBTC() {
      try {
        const r = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const { price } = await r.json();
        lastBTC = +price;
        return lastBTC.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
      } catch {
        return '???.??';
      }
    }
    function addToHistory(price) {
      const now = Date.now();
      btcHistory.push({time: now, price: +price});
      // prune to latest 120 points (approx 10 minutes at 5s/sample)
      if (btcHistory.length > 120) btcHistory = btcHistory.slice(-120);
    }
    async function updateBTC() {
      const priceStr = await fetchBTC();
      document.getElementById('price').textContent = priceStr;
      addToHistory(lastBTC || 0);

      // Animate price color on up/dn
      if(btcHistory.length>2 && lastBTC){
        let p0 = btcHistory[btcHistory.length-2].price;
        let elem = document.getElementById('price');
        elem.style.transition = "color 0.25s";
        if(lastBTC>p0) elem.style.color="#53eb99";
        else if(lastBTC<p0) elem.style.color="#e35e8f";
        else elem.style.color="#36cbe3";
        setTimeout(()=>{elem.style.color="#36cbe3"},350);
      }

      // Animate/refresh chart
      if (btcChart) {
        btcChart.data.labels = btcHistory.map(d => (new Date(d.time)).toLocaleTimeString([], {minute:'2-digit',second:'2-digit'}));
        btcChart.data.datasets[0].data = btcHistory.map(d => d.price);
        btcChart.update('active'); // animate
      }
      renderEntries(); // Re-PNL
    }
    function initChart() {
      const ctx = document.getElementById('btcChart').getContext('2d');
      btcChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'BTCUSD',
            data: [],
            fill: false,
            borderColor: '#31bfdc',
            tension: 0.33,
            pointRadius: 0,
            borderWidth:2.2,
            backgroundColor: '#eee8',
          }]
        },
        options: {
          responsive: false,
          scales: {
            x: {
              display: false
            },
            y: {
              ticks: { display: false },
              grid: { display: false },
              border: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => ctx.parsed.y
              }
            }
          },
          animation: {
            duration: 900,
            easing: 'easeInOutCirc'
          }
        }
      });
    }
    // --- TIMER ---
    function prettyTime(ms, short=true) {
      if (ms<0) return "0s";
      const d = Math.floor(ms/86400000);
      const h = Math.floor(ms/3600000)%24;
      const m = Math.floor(ms/60000)%60;
      const s = Math.floor(ms/1000)%60;
      if (short) {
        if (d>0) return `${d}d ${h}h`;
        if (h>0) return `${h}h ${m}m`;
        if (m>0) return `${m}m ${s}s`;
        return `${s}s`;
      }
      let parts = [];
      if (d) parts.push(d + ' day' + (d === 1 ? '' : 's'));
      if (h) parts.push(h + ' hour' + (h === 1 ? '' : 's'));
      if (m) parts.push(m + ' min' + (m === 1 ? '' : 's'));
      if (s) parts.push(s + ' sec');
      return parts.join(', ');
    }
    function updateTimerUI() {
      const now = Date.now();
      if (session.close && now<session.close) {
        document.getElementById('timer').textContent = 'Enter guess: ' + prettyTime(session.close-now);
      } else if (session.end && now<session.end) {
        document.getElementById('timer').textContent = 'Next Payout: ' + prettyTime(session.end-now);
      } else {
        document.getElementById('timer').textContent = 'New session soon!';
      }
    }
    function updateFormState() {
      const now = Date.now();
      if (session.close && now >= session.close) {
        document.getElementById('closedMsg').style.display = '';
        document.getElementById('guessForm').classList.add('disabled');
        document.getElementById('guessBtn').disabled = true;
        Array.from(document.querySelectorAll('.form input')).forEach(e=>e.disabled=true);
      } else {
        document.getElementById('closedMsg').style.display = 'none';
        document.getElementById('guessForm').classList.remove('disabled');
        document.getElementById('guessBtn').disabled = false;
        Array.from(document.querySelectorAll('.form input')).forEach(e=>e.disabled=false);
      }
    }
    // --- SUBMIT GUESS ---
    document.getElementById('guessForm').addEventListener('submit', async function(e){
      e.preventDefault();
      let username = document.getElementById('xUsername').value.trim();
      let guess = document.getElementById('usdGuess').value.trim();
      if (!/^@[\w\.]{2,22,25}$|@[\w]{2,23}$/.test(username)) {
        alert("Invalid X username. Example: @xyzzz");
        return;
      }
      let guessNum = +guess;
      if (isNaN(guessNum) || guessNum < 1000 || guessNum > 999999) {
        alert("Guess must be a number in USD (1000-999999).");
        return;
      }
      const userKey = username.replace(/[^a-zA-Z0-9_\.]/g,"_");
      const entryPath = ENTRIES_PATH + '/' + session.start + '/' + userKey;
      let existing = (await db.ref(entryPath).once('value')).val();
      if (!existing) {
        await db.ref(entryPath).set({
          x: username,
          guess: guessNum,
          ts: Date.now()
        });
        alert('Guess submitted!');
        document.getElementById('guessForm').reset();
      } else {
        alert("You've already entered!");
      }
      renderEntries();
    });
    // --- RENDER ENTRIES TABLE WITH LIVE PNL ---
    async function renderEntries() {
      const snap = await db.ref(ENTRIES_PATH + '/' + session.start).once('value');
      const entriesObj = snap.val() || {};
      let arr = Object.values(entriesObj);
      arr.sort((a,b)=>a.ts-b.ts);
      const table = document.getElementById('entriesTable');
      let html = `<tr>
        <th>X Username</th>
        <th>Guess ($)</th>
        <th>PNL (Live)</th>
        <th>When</th>
      </tr>`;
      if (arr.length)
        html += arr.map(e => {
          if (!e.x || typeof e.guess !== 'number' && typeof e.guess !== 'string') return '';
          const pnl = (lastBTC != null && !isNaN(e.guess)) ? (+lastBTC - e.guess) : null;
          let pnlDisp = '';
          if (pnl != null) {
              const sign = pnl > 0 ? '+' : (pnl < 0 ? '-' : '±');
              const absPnl = Math.abs(pnl).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
              let colorClass = pnl > 0 ? 'pnl-pos' : (pnl < 0 ? 'pnl-neg':'pnl-zero');
              pnlDisp = `<span class="pnl ${colorClass}" style="animation:fadein-container .9s;">${sign}${absPnl}</span>`;
          }
          return `
            <tr>
              <td style="color:#45caf7;font-family:inherit;">${e.x}</td>
              <td>${String(e.guess)}</td>
              <td>${pnlDisp}</td>
              <td>${new Date(e.ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td>
            </tr>`;
      }).join("");
      else
        html += "<tr><td colspan=4 style='text-align:center'>No guesses yet</td></tr>";
      table.innerHTML = html;
    }
    // --- RECORD CLOSE/END PRICES (admin only, for auto: do below!) ---
    async function checkAndSetPrices() {
      const now = Date.now();
      if (!session.closePrice && session.close && now>session.close && now<(session.end-1000)) {
        const cp = await fetchBTC();
        session.closePrice = +cp.replace(/,/g,"");
        await db.ref(SESSION_PATH + "/closePrice").set(session.closePrice);
      }
      if (!session.endPrice && session.end && now>session.end) {
        const ep = await fetchBTC();
        session.endPrice = +ep.replace(/,/g,"");
        await db.ref(SESSION_PATH + "/endPrice").set(session.endPrice);
      }
    }
    // --- WINNERS TABLE ---
    async function renderWinners() {
      if (!session.endPrice) return;
      const snap = await db.ref(ENTRIES_PATH + '/' + session.start).once('value');
      const entriesObj = snap.val() || {};
      let arr = Object.values(entriesObj);
      if (!arr.length) return;
      arr.forEach(e => e.dist = Math.abs(e.guess - session.endPrice));
      arr.sort((a, b) => a.dist - b.dist);
      const table = document.getElementById('winnersTable');
      let html = `<tr>
        <th>Rank</th>
        <th>X Username</th>
        <th>Guess ($)</th>
        <th>Δ</th>
      </tr>`;
      arr.forEach((e, i) => {
        html += `<tr class="${i==0?'winner':''}">
          <td>${i+1}</td>
          <td style="font-family:inherit;">${e.x}</td>
          <td>${String(e.guess)}</td>
          <td>${Math.abs(e.guess - session.endPrice)}</td>
        </tr>`;
      });
      table.innerHTML = html;
      document.getElementById('winnersSection').style.display = '';
      document.getElementById('tableSection').style.display = 'none';
    }
    // --- MAIN ---
    async function main() {
      await getOrCreateSession();
      initChart();
      // FWD FILL chart a bit for better start look:
      let preload = [];
      for(let i=16; i>=0; --i) preload.push({time: Date.now()-i*5000, price: lastBTC??43500});
      btcHistory = preload;
      for(let i=0;i<preload.length;i++) btcChart.data.labels.push('');
      btcChart.data.datasets[0].data = btcHistory.map(d=>d.price);
      btcChart.update();

      await updateBTC();
      updateTimerUI();
      updateFormState();
      renderEntries();
      setInterval(updateTimerUI, 1000);
      setInterval(updateFormState, 2000);
      setInterval(async ()=> {
        await checkAndSetPrices();
        if (session.end && Date.now() > session.end) {
          await db.ref(SESSION_PATH).once('value').then(snap=>session={...session, ...snap.val()});
          if (session.endPrice) renderWinners();
        }
      }, 15*1000);
      if (session.end && Date.now()>session.end) {
        await db.ref(SESSION_PATH).once('value').then(snap=>session={...session, ...snap.val()});
        if (session.endPrice) renderWinners();
      }
    }
    main();

    setInterval(updateBTC, 5000);

    // Prevent zoom on input focus on mobile
    document.querySelectorAll('input').forEach(function(input){
      input.addEventListener('touchstart', function(){
        document.body.style.fontSize = '10px';
        document.documentElement.style.fontSize='10px';
      });
    });
  </script>
</body>
</html>
