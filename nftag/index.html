<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NFT FANS WORLD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a0b0f" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0b0f;
      --fg:#cfeaff;
      --sub:#8eaccb;
      --accent:#00e5ff;
      --accent2:#ff00d4;
      --border:rgba(160,210,255,0.25);
      --panel:#0f1218;
      --label:#0e1018;
    }
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      font-size: 10px; /* Global base font size reduced */
    }

    /* Top half map */
    #map{
      height:50dvh;
      min-height:260px;
      width:100%;
      background:#06070a;
    }

    /* Bottom panel */
    .panel{
      box-sizing:border-box;
      width:100%;
      padding:10px 12px calc(env(safe-area-inset-bottom) + 10px);
      background:var(--panel);
      border-top:1px solid var(--border);
    }
    .bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:10px;
      background:linear-gradient(135deg, rgba(0,229,255,0.08), rgba(255,0,212,0.08));
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .logo{
      width:18px;height:18px;border-radius:5px;
      background:linear-gradient(135deg, rgba(0,229,255,0.3), rgba(255,0,212,0.3));
      border:1px solid var(--border);
      color:white;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:9px;letter-spacing:-0.2px;
      flex:0 0 auto;
    }
    .title{
      font-weight:900;font-size:10px;
      letter-spacing:0.3px;color:var(--fg);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .hint{
      font-size:9px;
      color:var(--sub);
      white-space:nowrap;
    }

    /* Color picker row */
    .colorRow{
      margin-top:8px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .colorPickerWrap{
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      border-radius:8px;
      padding:4px 6px;
      background:#0c0f16;
      flex:1 1 auto;
    }
    .colorLabel{
      font-size:10px;
      color:#9fb9d4;
    }
    #colorPicker{
      width:32px;
      height:20px;
      padding:0;
      border:1px solid var(--border);
      border-radius:4px;
      background:#0c0f16;
      cursor:pointer;
    }
    .btnMini{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#11131a;
      color:#e8f6ff;
      font-size:10px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }

    /* Controls */
    .controls{
      margin-top:8px;
      display:flex;
      gap:8px;
    }
    .btn{
      flex:1 1 0%;
      display:inline-flex;align-items:center;justify-content:center;gap:4px;
      padding:8px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#11131a;
      color:#e8f6ff;
      font-size:10px;font-weight:800;
      cursor:pointer;user-select:none;-webkit-tap-highlight-color:transparent;
    }
    .btn.primary{
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#001015;
      border:1px solid transparent;
    }
    .btn .material-icons{font-size:16px;line-height:1;}

    /* List Container & Tabs */
    .list-container{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .tabs{
      display:flex;
      background:#0c0f16;
      border-bottom:1px solid var(--border);
    }
    .tab-btn{
      flex:1;
      padding:8px 4px;
      font-size:9px;
      color:var(--sub);
      text-align:center;
      cursor:pointer;
      font-weight:700;
      background:transparent;
      border:none;
      border-bottom:2px solid transparent;
      white-space: nowrap;
    }
    .tab-btn .material-icons {
        font-size: 14px;
        vertical-align: middle;
    }
    .tab-btn.active{
      color:var(--accent);
      border-bottom-color:var(--accent);
      background:rgba(0,229,255,0.05);
    }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    /* Tables */
    table{
      width:100%;
      border-collapse:collapse;
      background:#0c0f16;
    }
    thead th{
      text-align:left;
      font-size:9px;
      color:#9fb9d4;
      padding:6px 8px;
      border-bottom:1px solid var(--border);
      font-weight:700;
    }
    tbody td{
      font-size:10px;
      color:#d6ecff;
      padding:6px 8px;
      border-bottom:1px solid rgba(160,210,255,0.15);
      vertical-align:middle;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .agent-cell{
      display:flex;align-items:center;gap:6px;min-width:0;
    }
    .dot{
      width:5px;height:5px;border-radius:50%;
      flex:0 0 auto;
      border:1px solid transparent;
    }
    .nameText{ white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
    .countryText{ display:flex;align-items:center;gap:4px; color:#b8d1ea; font-size:10px; }
    .grand-total-row td { font-weight: 800; color: var(--accent); border-top: 2px solid var(--border); font-size: 10px; }

    /* FUNDS TAB STYLE */
    .funds-display {
        padding: 20px;
        text-align: center;
        background: linear-gradient(180deg, rgba(0,229,255,0.05), transparent);
    }
    .funds-amount {
        font-size: 24px;
        font-weight: 900;
        color: var(--accent);
        text-shadow: 0 0 10px rgba(0,229,255,0.3);
        margin-bottom: 5px;
    }
    .funds-label {
        font-size: 10px;
        color: var(--sub);
    }

    /* NOTIFICATIONS TAB STYLE */
    .notif-list {
        padding: 0;
        list-style: none;
        max-height: 200px;
        overflow-y: auto;
    }
    .notif-item {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(160,210,255,0.1);
        display: flex;
        gap: 8px;
        align-items: flex-start;
    }
    .notif-icon {
        color: var(--accent2);
        font-size: 14px;
        margin-top: 2px;
    }
    .notif-content {
        flex: 1;
    }
    .notif-header {
        font-size: 9px;
        color: var(--sub);
        display: flex;
        justify-content: space-between;
        margin-bottom: 2px;
    }
    .notif-text {
        font-size: 10px;
        color: #fff;
    }


    /* CHAT SECTION */
    .chat-section {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0c0f16;
      padding: 8px;
    }
    .chat-header {
      font-size: 10px; color: var(--sub); margin-bottom: 6px; font-weight: 700;
    }
    .chat-input-row {
      display: flex; gap: 6px; margin-bottom: 10px;
    }
    .chat-input {
      flex: 1;
      background: #11131a;
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 10px;
      outline: none;
    }
    .chat-input:focus { border-color: var(--accent); }
    .chat-send-btn {
      background: var(--accent);
      color: #000;
      border: none;
      border-radius: 6px;
      width: 32px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }
    
    .msg-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .msg-bubble {
      background: linear-gradient(145deg, rgba(17,19,26,0.9), rgba(12,15,22,0.8));
      border: 1px solid var(--border); /* Default, overridden by JS */
      border-radius: 8px;
      border-top-left-radius: 2px;
      padding: 8px;
      position: relative;
    }
    .msg-meta {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 4px;
      font-size: 9px;
    }
    .msg-agent {
      display: flex; align-items: center; gap: 4px;
      font-weight: 800; color: var(--accent);
    }
    .msg-time {
      color: var(--sub); opacity: 0.7; font-size: 8px;
    }
    .msg-body {
      font-size: 10px; line-height: 1.3; color: #eef7ff;
      word-wrap: break-word;
    }
    .load-more-btn {
      margin-top: 8px;
      width: 100%;
      padding: 8px;
      background: #11131a;
      border: 1px dashed var(--border);
      color: var(--sub);
      font-size: 9px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      text-align: center;
    }
    .load-more-btn:hover { color: var(--fg); border-style: solid; }

    /* Toast */
    .toast{
      margin-top:10px;
      background:var(--label);
      color:#e6f7ff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 8px;
      font-size:10px;
      display:none;
    }
    .toast.show{display:block;}

    /* Leaflet overrides */
    .leaflet-container{background:#06070a;}
    .leaflet-control-attribution, .leaflet-control-zoom{ display:none !important; }
    .agent-label{
      background:var(--label);
      color:#cfeaff;
      border:1px solid var(--border);
      border-radius:6px;
      padding:2px 4px;
      font-size:8px;
      line-height:1.1;
      letter-spacing:0.2px;
      box-shadow:none;
    }
    .labels-hidden .leaflet-tooltip{display:none !important;}
  </style>
</head>
<body>

  <div id="map" role="application" aria-label="World map of NFT FANS agents"></div>

  <section class="panel">
    <div class="bar">
      <div class="brand">
        <div class="logo">NF</div>
        <div class="title">NFT FANS WORLD</div>
      </div>
      <div class="hint">Join the map â€” be an Agent</div>
    </div>

    <div class="colorRow">
      <div class="colorPickerWrap">
        <span class="colorLabel">Dot & Agent area color</span>
        <input type="color" id="colorPicker" value="#23ffd5" aria-label="Choose dot color" />
      </div>
      <button id="btnApplyColor" class="btnMini" title="Apply color to my agent">
        <span class="material-icons" aria-hidden="true" style="font-size:14px;">palette</span>
        Apply
      </button>
    </div>

    <div class="controls" aria-label="Actions">
      <button id="btnJoin" class="btn primary">
        <span class="material-icons" aria-hidden="true">group_add</span>
        Join
      </button>
      <button id="btnLocate" class="btn" title="Go to my location" aria-label="Go to my location">
        <span class="material-icons" aria-hidden="true">my_location</span>
        My Location
      </button>
    </div>

    <!-- TABS -->
    <div class="list-container" aria-label="App Tabs">
      <div class="tabs">
        <button class="tab-btn active" data-tab="latest">Agents</button>
        <button class="tab-btn" data-tab="country">Country</button>
        <button class="tab-btn" data-tab="funds">Funds</button>
        <button class="tab-btn" data-tab="notif"><span class="material-icons">notifications</span></button>
      </div>

      <!-- Tab 1: Agents -->
      <div id="tab-latest" class="tab-content active">
        <table aria-describedby="Latest agents joining and their country">
            <thead>
            <tr>
                <th style="width:58%">Agent</th>
                <th style="width:42%">Country</th>
            </tr>
            </thead>
            <tbody id="latestBody"></tbody>
        </table>
      </div>

      <!-- Tab 2: Country -->
      <div id="tab-country" class="tab-content">
        <table aria-describedby="Agents grouped by country">
            <thead>
            <tr>
                <th style="width:70%">Country</th>
                <th style="width:30%; text-align:right;">Users</th>
            </tr>
            </thead>
            <tbody id="countryBody"></tbody>
            <tfoot id="countryFoot"></tfoot>
        </table>
      </div>

      <!-- Tab 3: Funds -->
      <div id="tab-funds" class="tab-content">
        <div class="funds-display">
            <div class="funds-amount">$15,000</div>
            <div class="funds-label">Available for Agents</div>
        </div>
      </div>

      <!-- Tab 4: Notifications (Agent 1, 2, 3 only) -->
      <div id="tab-notif" class="tab-content">
        <ul id="notifList" class="notif-list">
            <!-- Filtered messages go here -->
        </ul>
      </div>
    </div>

    <!-- MESSAGING SECTION -->
    <div class="chat-section">
        <div class="chat-header">AGENT COMM CENTER</div>
        <div class="chat-input-row">
            <input type="text" id="msgInput" class="chat-input" placeholder="Type a message..." maxlength="140" />
            <button id="btnSendMsg" class="chat-send-btn">
                <span class="material-icons" style="font-size:14px;">send</span>
            </button>
        </div>
        <div id="msgList" class="msg-list">
            <!-- Messages injected here -->
        </div>
        <button id="btnLoadMoreMsg" class="load-more-btn">Load Next (Older)</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </section>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getDatabase, ref, push, set, onChildAdded, onChildChanged, onChildRemoved,
      runTransaction, serverTimestamp, update, child, get,
      query, orderByChild, startAt, endAt, limitToLast
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBuBB-Cha7eLG1O7SxOTfFt8e6hVAWjkxI",
      authDomain: "tokentransfer-4a9b3.firebaseapp.com",
      databaseURL: "https://tokentransfer-4a9b3-default-rtdb.firebaseio.com",
      projectId: "tokentransfer-4a9b3",
      storageBucket: "tokentransfer-4a9b3.firebasestorage.app",
      messagingSenderId: "205455490321",
      appId: "1:205455490321:web:9919f5dde059316c9320b0",
      measurementId: "G-Y6CVEDL9XH"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const agentsRef = ref(db, "agents");
    const msgsRef = ref(db, "messages");
    const counterRef = ref(db, "counters/agents");

    const DEFAULT_COLOR = "#23ffd5";

    // ---------------- HELPER: Shorten Country Names ----------------
    function shortenCountryName(name) {
      if (!name) return "Unknown";
      const n = name.toLowerCase();
      if (n.includes("united states") || n.includes("america") || n === "us") return "USA";
      if (n.includes("united kingdom") || n.includes("britain") || n === "uk") return "UK";
      if (n.includes("united arab emirates")) return "UAE";
      if (n.includes("russian federation")) return "Russia";
      return name; 
    }

    // ---------------- MAP SETUP ----------------
    const worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
    const map = L.map('map', {
      zoomControl: false, attributionControl: false,
      minZoom: 2, maxZoom: 19, maxBounds: worldBounds,
      maxBoundsViscosity: 1.0, worldCopyJump: false
    });
    L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
      maxZoom: 19, noWrap: true, bounds: worldBounds
    }).addTo(map);
    map.setView([20, 0], 2);
    window.addEventListener('resize', () => map.invalidateSize(), { passive: true });

    map.createPane('linesPane');
    map.getPane('linesPane').style.zIndex = 399;
    const linesGroup = L.layerGroup().addTo(map);

    const toastEl = document.getElementById('toast');
    function toast(msg, ms = 2800) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.classList.remove('show'), ms);
    }
    function pad4(n){ return String(n).padStart(4,'0'); }
    function countryCodeToEmoji(countryCode){
      if(!countryCode || countryCode.length !== 2) return "ðŸ³ï¸";
      const cps = [...countryCode.toUpperCase()].map(c => 127397 + c.charCodeAt());
      return String.fromCodePoint(...cps);
    }
    function buildLabel(agent){
      const flag = countryCodeToEmoji(agent.countryCode);
      const shortC = shortenCountryName(agent.countryName);
      return `
        <div class="label">
          <span class="flag">${flag}</span>
          <span class="name">${agent.displayName}</span><br/>
          <span class="country">${shortC}</span>
        </div>
      `;
    }

    // Label visibility
    const LABELS_MIN_ZOOM = 11;
    map.on('zoomend', () => {
      if(map.getZoom() < LABELS_MIN_ZOOM) map.getContainer().classList.add('labels-hidden');
      else map.getContainer().classList.remove('labels-hidden');
    });
    map.getContainer().classList.add('labels-hidden'); // initial

    // Markers
    const DOT_RADIUS = 3;
    const markers = new Map();
    function upsertMarker(key, agent){
      const pos = [agent.lat, agent.lng];
      const html = buildLabel(agent);
      const color = agent.color || DEFAULT_COLOR;

      if(markers.has(key)){
        const rec = markers.get(key);
        rec.dot.setLatLng(pos);
        rec.dot.setStyle({ color, fillColor: color });
        if(rec.dot.getTooltip()) rec.dot.setTooltipContent(html);
        rec.circle.setLatLng(pos);
        rec.circle.setStyle({ color, fillColor: color });
      } else {
        const dot = L.circleMarker(pos, {
          radius: DOT_RADIUS, color, weight:1, opacity:0.9, fillColor:color, fillOpacity:0.95
        }).addTo(map);
        dot.bindTooltip(html, { permanent:true, direction:'top', className:'agent-label', offset:[0,-6] });
        
        const circle = L.circle(pos, {
          radius: 50, color, weight:1, opacity:0.6, fillColor:color, fillOpacity:0.08
        }).addTo(map);
        markers.set(key, { dot, circle });
      }
    }
    function removeMarker(key){
      const rec = markers.get(key);
      if(rec){ map.removeLayer(rec.dot); map.removeLayer(rec.circle); markers.delete(key); }
    }

    // Agents Store & Lines
    const agentsStore = new Map();
    function upsertStore(key, data){
      if(!data || typeof data.lat!=="number" || typeof data.lng!=="number") return;
      // Ensure color is stored
      agentsStore.set(key, { ...data, key, color: data.color || DEFAULT_COLOR });
      recomputeLines();
      renderCountryStats();
    }
    function removeFromStore(key){
      agentsStore.delete(key);
      recomputeLines();
      renderCountryStats();
    }

    function recomputeLines(){
      linesGroup.clearLayers();
      const nodes = Array.from(agentsStore.values());
      const n = nodes.length;
      if(n < 2) return;

      const inMST = Array(n).fill(false);
      const minCost = Array(n).fill(Infinity);
      const parent = Array(n).fill(-1);
      minCost[0] = 0;

      function dist2(i, j){
        const dx = nodes[i].lat - nodes[j].lat;
        const dy = nodes[i].lng - nodes[j].lng;
        return dx*dx + dy*dy;
      }

      for(let k=0; k<n; k++){
        let u=-1, best=Infinity;
        for(let i=0; i<n; i++){
          if(!inMST[i] && minCost[i] < best){ best = minCost[i]; u = i; }
        }
        if(u === -1) break;
        inMST[u] = true;
        for(let v=0; v<n; v++){
          if(!inMST[v]){
            const d2 = dist2(u, v);
            if(d2 < minCost[v]){ minCost[v] = d2; parent[v] = u; }
          }
        }
      }
      for(let v=0; v<n; v++){
        const u = parent[v];
        if(u !== -1){
          const a = nodes[u];
          const b = nodes[v];
          L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {
            color: a.color || DEFAULT_COLOR, weight:2, opacity:0.7, pane:'linesPane'
          }).addTo(linesGroup);
        }
      }
    }

    // Firebase Agents Listeners
    onChildAdded(agentsRef, s => { upsertMarker(s.key, s.val()); upsertStore(s.key, s.val()); upsertLatest(s.key, s.val()); });
    onChildChanged(agentsRef, s => { upsertMarker(s.key, s.val()); upsertStore(s.key, s.val()); upsertLatest(s.key, s.val()); });
    onChildRemoved(agentsRef, s => { removeMarker(s.key); removeFromStore(s.key); removeLatest(s.key); });

    // UI Logic (Join, Locate, Color)
    async function getCurrentPosition(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error("No Geo"));
        navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:15000});
      });
    }
    async function reverseGeocodeCountry(lat, lng){
      const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
      const d = await r.json();
      return { countryName: d.countryName||"Unknown", countryCode: d.countryCode||"" };
    }

    const btnJoin = document.getElementById('btnJoin');
    const btnLocate = document.getElementById('btnLocate');
    const colorPicker = document.getElementById('colorPicker');
    const btnApplyColor = document.getElementById('btnApplyColor');

    const savedColor = localStorage.getItem("nftFansColor");
    if(savedColor) colorPicker.value = savedColor;
    colorPicker.addEventListener('input', ()=>localStorage.setItem("nftFansColor",colorPicker.value));

    btnApplyColor.addEventListener('click', async()=>{
      const key = localStorage.getItem("nftFansAgentKey");
      const color = colorPicker.value || DEFAULT_COLOR;
      localStorage.setItem("nftFansColor", color);
      if(!key){ toast("Color saved locally. Join to publish."); return; }
      await update(child(agentsRef, key), { color, updatedAt: serverTimestamp() });
      toast("Color updated.");
    });

    btnLocate.addEventListener('click', async()=>{
      try{
        toast("Locating...");
        const p = await getCurrentPosition();
        map.flyTo([p.coords.latitude, p.coords.longitude], 14, {duration:0.8});
      }catch(e){ toast("Location permission needed."); }
    });

    // Haversine check for 50m
    function toRad(x){ return x * Math.PI / 180; }
    function haversine(lat1,lon1,lat2,lon2){
      const R=6371000, dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    async function checkNear(lat, lng){
      let found = false;
      for(const a of agentsStore.values()){
        if(haversine(lat,lng,a.lat,a.lng) < 50) return true;
      }
      return false;
    }

    btnJoin.addEventListener('click', async()=>{
      btnJoin.disabled = true;
      try{
        toast("Requesting location...");
        const p = await getCurrentPosition();
        const {latitude:lat, longitude:lng} = p.coords;
        
        const existingKey = localStorage.getItem("nftFansAgentKey");
        if(!existingKey && await checkNear(lat, lng)){
          toast("Too close to another agent (50m)."); return;
        }
        
        let country = {countryName:"Unknown", countryCode:""};
        try{ country = await reverseGeocodeCountry(lat,lng); }catch{}
        
        const color = colorPicker.value || DEFAULT_COLOR;
        
        if(!existingKey){
          const tx = await runTransaction(counterRef, c=>(c||0)+1);
          const seq = tx.snapshot.val();
          const displayName = `NFT FANS AGENT #${pad4(seq)}`;
          const newRef = push(agentsRef);
          await set(newRef, {
            displayName, seq, countryName:country.countryName, countryCode:country.countryCode,
            color, lat, lng, createdAt:serverTimestamp(), updatedAt:serverTimestamp()
          });
          localStorage.setItem("nftFansAgentKey", newRef.key);
          toast("Welcome Agent!");
        } else {
          // Update
          const ref = child(agentsRef, existingKey);
          await update(ref, {
             countryName:country.countryName, countryCode:country.countryCode,
             color, lat, lng, updatedAt:serverTimestamp()
          });
          toast("Location updated.");
        }
        map.flyTo([lat,lng], 15);
      }catch(e){ console.error(e); toast("Join failed."); }
      finally{ btnJoin.disabled = false; }
    });

    // ---------------- TABS ----------------
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        tabBtns.forEach(b=>b.classList.remove('active'));
        tabContents.forEach(c=>c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
      });
    });

    // ---------------- LATEST AGENTS TABLE ----------------
    const latestBody = document.getElementById('latestBody');
    const latestMap = new Map();
    function upsertLatest(key, data){ if(data) latestMap.set(key, data); renderLatest(); }
    function removeLatest(key){ latestMap.delete(key); renderLatest(); }
    function renderLatest(){
      const arr = Array.from(latestMap.values()).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)).slice(0,10);
      latestBody.innerHTML = arr.map(a=>{
        const f = countryCodeToEmoji(a.countryCode);
        const sn = shortenCountryName(a.countryName);
        return `
          <tr>
            <td><div class="agent-cell"><span class="dot" style="background:${a.color||DEFAULT_COLOR}"></span><span>${a.displayName}</span></div></td>
            <td><div class="countryText"><span>${f}</span><span>${sn}</span></div></td>
          </tr>
        `;
      }).join("");
    }

    // ---------------- COUNTRY STATS ----------------
    const countryBody = document.getElementById('countryBody');
    const countryFoot = document.getElementById('countryFoot');
    function renderCountryStats(){
      const stats = {};
      const all = Array.from(agentsStore.values());
      all.forEach(a=>{
        const cc = a.countryCode||"XX";
        if(!stats[cc]) stats[cc] = { count:0, name: shortenCountryName(a.countryName), code:cc };
        stats[cc].count++;
      });
      const sorted = Object.values(stats).sort((a,b)=>b.count-a.count);
      countryBody.innerHTML = sorted.map(s=>`
        <tr>
          <td><div class="countryText" style="font-size:10px;"><span style="font-size:12px; margin-right:6px;">${countryCodeToEmoji(s.code)}</span><span>${s.name}</span></div></td>
          <td style="text-align:right;"><strong>[ ${s.count} ]</strong></td>
        </tr>
      `).join("");
      countryFoot.innerHTML = `<tr class="grand-total-row"><td>GRAND TOTAL</td><td style="text-align:right;">[ ${all.length} ]</td></tr>`;
    }

    // ---------------- MESSAGING SYSTEM ----------------
    const msgInput = document.getElementById('msgInput');
    const btnSendMsg = document.getElementById('btnSendMsg');
    const msgListEl = document.getElementById('msgList');
    const btnLoadMoreMsg = document.getElementById('btnLoadMoreMsg');
    const notifListEl = document.getElementById('notifList');

    // State for messages
    let messageCache = []; // Stores { id, ...data }
    let oldestTimestamp = Date.now() + 10000; // init future
    const MSG_LIMIT = 10;
    
    // Whitelist for notifications
    const SPECIAL_AGENTS = ["NFT FANS AGENT #0001", "NFT FANS AGENT #0002", "NFT FANS AGENT #0003"];

    // Send Message
    btnSendMsg.addEventListener('click', async () => {
      const txt = msgInput.value.trim();
      if(!txt) return;

      const key = localStorage.getItem("nftFansAgentKey");
      if(!key){ toast("Join first to post!"); return; }

      const agent = agentsStore.get(key);
      if(!agent){ toast("Agent not found."); return; }

      // Validate agent displayName is present
      if(!agent.displayName) { toast("Agent invalid."); return; }

      btnSendMsg.disabled = true;
      try {
        await push(msgsRef, {
          text: txt,
          agentName: agent.displayName,
          countryCode: agent.countryCode,
          countryName: agent.countryName,
          agentKey: key,
          timestamp: serverTimestamp()
        });
        msgInput.value = "";
      } catch(e) {
        console.error(e); toast("Failed to send.");
      } finally {
        btnSendMsg.disabled = false;
      }
    });

    function getAgentColor(agentKey) {
        if(agentsStore.has(agentKey)) {
            return agentsStore.get(agentKey).color || DEFAULT_COLOR;
        }
        return DEFAULT_COLOR;
    }

    function isSpecialAgent(name) {
        return SPECIAL_AGENTS.includes(name);
    }

    // Render Messages & Notifications
    function renderMessages(){
      // Sort desc by time
      messageCache.sort((a,b) => b.timestamp - a.timestamp);
      
      // Filter out undefined agents (just in case)
      const validMsgs = messageCache.filter(m => m.agentName && m.agentName !== 'undefined');

      // Separate Special vs Normal
      const normalMsgs = validMsgs.filter(m => !isSpecialAgent(m.agentName));
      const specialMsgs = validMsgs.filter(m => isSpecialAgent(m.agentName));

      // 1. Render Normal Chat
      msgListEl.innerHTML = normalMsgs.map(m => {
        const flag = countryCodeToEmoji(m.countryCode);
        const shortC = shortenCountryName(m.countryName);
        const dateStr = new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        // Get color for border
        const bubbleColor = getAgentColor(m.agentKey);
        
        return `
          <div class="msg-bubble" style="border-color:${bubbleColor}">
            <div class="msg-meta">
              <div class="msg-agent">
                <span>${flag}</span>
                <span>${m.agentName}</span>
                <span style="font-weight:400; color:#8eaccb; font-size:8px;">(${shortC})</span>
              </div>
              <div class="msg-time">${dateStr}</div>
            </div>
            <div class="msg-body">${m.text}</div>
          </div>
        `;
      }).join("");

      // 2. Render Notifications (Special Agents only)
      notifListEl.innerHTML = specialMsgs.map(m => {
        const dateStr = new Date(m.timestamp).toLocaleDateString() + ' ' + new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return `
            <li class="notif-item">
                <span class="material-icons notif-icon">campaign</span>
                <div class="notif-content">
                    <div class="notif-header">
                        <span style="color:var(--accent); font-weight:800;">${m.agentName}</span>
                        <span>${dateStr}</span>
                    </div>
                    <div class="notif-text">${m.text}</div>
                </div>
            </li>
        `;
      }).join("");
    }

    // Initial Load
    const initialQuery = query(msgsRef, orderByChild('timestamp'), limitToLast(MSG_LIMIT));
    onChildAdded(initialQuery, (snapshot) => {
      const val = snapshot.val();
      if(!val.agentName) return; // skip junk
      const m = { id: snapshot.key, ...val };
      if(!messageCache.find(x => x.id === m.id)){
        messageCache.push(m);
        if(val.timestamp < oldestTimestamp) oldestTimestamp = val.timestamp;
        renderMessages();
      }
    });

    // Load More
    btnLoadMoreMsg.addEventListener('click', async () => {
      if(messageCache.length === 0) return;
      
      const lastTime = messageCache[messageCache.length-1].timestamp;
      const oldQuery = query(msgsRef, orderByChild('timestamp'), endAt(lastTime - 1), limitToLast(MSG_LIMIT));
      
      const snap = await get(oldQuery);
      if(!snap.exists()){ toast("No older messages."); return; }

      const newMsgs = [];
      snap.forEach(child => {
        newMsgs.push({ id: child.key, ...child.val() });
      });

      if(newMsgs.length === 0) { toast("No older messages."); return; }

      newMsgs.forEach(m => {
        if(m.agentName && !messageCache.find(x => x.id === m.id)) messageCache.push(m);
      });
      renderMessages();
    });

  </script>
</body>
</html>
