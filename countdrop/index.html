<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFTFAN Airdrop Tool (Simple)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #181825;
      --accent: #00bcd4;
      --bg: #f7faff;
      --card: #fff;
      --border: #e0e7ef;
      --button: #00bcd4;
      --button-hover: #0097a7;
      --radius: 10px;
      --font-size: 15px;
    }
    html, body {
      background: var(--bg);
      color: var(--primary);
      font-family: 'Inter', Arial, sans-serif;
      font-size: var(--font-size);
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      min-height: 100vh;
    }
    .container {
      max-width: 410px;
      margin: 32px auto;
      padding: 24px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 2px 14px #0012;
      border: 1px solid var(--border);
    }
    h1 {
      font-size: 1.2em;
      margin: 0 0 18px 0;
      font-weight: 700;
      text-align: center;
      color: var(--accent);
    }
    textarea {
      width: 100%;
      min-height: 80px;
      font-size: var(--font-size);
      border-radius: 7px;
      border: 1px solid var(--border);
      background: #f4f8fa;
      color: var(--primary);
      padding: 10px;
      margin-bottom: 10px;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }
    .btn {
      background: var(--button);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: var(--font-size);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
      margin-right: 6px;
      margin-bottom: 10px;
    }
    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .btn:hover:not(:disabled) {
      background: var(--button-hover);
    }
    .info {
      font-size: 13px;
      color: #666;
      margin-bottom: 10px;
    }
    .wallet-list {
      background: #f4f8fa;
      border-radius: 6px;
      padding: 8px 6px;
      max-height: 110px;
      overflow-y: auto;
      font-size: 12px;
      border: 1px solid var(--border);
      margin-bottom: 7px;
      color: #333;
      word-break: break-all;
    }
    .status, .error {
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      margin: 10px 0;
      display: none;
    }
    .status { background: #e0f7fa; color: #00838f; }
    .error { background: #ffe0e6; color: #c62828; }
    .contract-info {
      font-size: 11px;
      color: #666;
      text-align: center;
      margin: 18px 0 0 0;
      background: #f4f8fa;
      border-radius: 6px;
      padding: 7px;
      border: 1px solid var(--border);
    }
    .bar-bg {
      width: 100%;
      height: 10px;
      background: #e2eaf6;
      border-radius: 7px;
      margin: 12px 0 10px 0;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: var(--accent);
      width: 0%;
      transition: width 0.5s;
    }
    .score {
      text-align: right;
      font-size: 13px;
      color: #00838f;
      margin-bottom: 8px;
    }
    @media (max-width: 480px) {
      .container { padding: 10px; }
      h1 { font-size: 1em;}
      .btn { padding: 8px 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>NFTFAN Airdrop</h1>
    <div class="info">Paste wallet addresses (comma, space, or newline separated):</div>
    <textarea id="walletInput" placeholder="0x..."></textarea>
    <button class="btn" id="filterBtn">Filter</button>
    <button class="btn" id="connectWalletBtn">Connect Wallet</button>
    <span class="score" id="myScore"></span>

    <div class="wallet-list" id="walletList"></div>
    <div class="info" id="walletCountInfo">0 wallets</div>
    <div class="bar-bg"><div class="bar-fill" id="progressBar"></div></div>
    <button class="btn" id="airdropBtn" disabled>Send Airdrop</button>
    <div class="status" id="statusMsg"></div>
    <div class="error" id="errorMsg"></div>
    <div class="contract-info">
      Token: <span id="tokenCA">0x2017Fcaea540d2925430586DC92818035Bfc2F50</span><br>
      Distributor: <span id="airdropCA">0x664d25959EcCabc3e04A4Dc9D1f5ca5dDE82a5d5</span>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    // CONFIG (update as needed)
    const NFTFAN_TOKEN_CA = "0x2017Fcaea540d2925430586DC92818035Bfc2F50";
    const AIRDROP_CONTRACT_CA = "0x664d25959EcCabc3e04A4Dc9D1f5ca5dDE82a5d5";
    const AIRDROP_ABI = [
      "function distributeTokens(address[] calldata recipients) external",
      "function userScores(address) public view returns (uint256)"
    ];
    const BATCH_SIZE = 50; // send to 50 wallets at a time

    // DOM
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const filterBtn = document.getElementById('filterBtn');
    const airdropBtn = document.getElementById('airdropBtn');
    const walletInput = document.getElementById('walletInput');
    const walletList = document.getElementById('walletList');
    const walletCountInfo = document.getElementById('walletCountInfo');
    const progressBar = document.getElementById('progressBar');
    const myScore = document.getElementById('myScore');
    const statusMsg = document.getElementById('statusMsg');
    const errorMsg = document.getElementById('errorMsg');

    // State
    let provider, signer, userAddress, contract;
    let filteredWallets = [];
    let airdropInProgress = false;

    function isWallet(addr) {
      return /^0x[a-fA-F0-9]{40}$/.test(addr);
    }
    function extractWallets(text) {
      let matches = text.match(/0x[a-fA-F0-9]{40}/g) || [];
      let deduped = Array.from(new Set(matches.map(a => ethers.utils.getAddress(a.toLowerCase()))));
      return deduped;
    }
    function showWallets(wallets) {
      walletList.innerHTML = wallets.slice(0, 120).map(w =>
        `<div>${w}</div>`
      ).join('');
      if (wallets.length > 120) {
        walletList.innerHTML += `<div style="color:#00bcd4;">...and ${wallets.length-120} more</div>`;
      }
      walletCountInfo.textContent = wallets.length + " wallets";
    }
    function showStatus(msg) {
      statusMsg.textContent = msg;
      statusMsg.style.display = 'block';
      errorMsg.style.display = 'none';
    }
    function showError(msg) {
      errorMsg.textContent = msg;
      errorMsg.style.display = 'block';
      statusMsg.style.display = 'none';
    }
    function clearNotif() {
      statusMsg.style.display = 'none';
      errorMsg.style.display = 'none';
    }

    filterBtn.onclick = () => {
      try {
        const wallets = extractWallets(walletInput.value);
        filteredWallets = wallets;
        showWallets(filteredWallets);
        airdropBtn.disabled = filteredWallets.length === 0 || !signer || airdropInProgress;
        showStatus("Filtered " + wallets.length + " valid wallet addresses.");
      } catch (error) {
        showError("Error filtering wallets: " + error.message);
      }
    };

    connectWalletBtn.onclick = async () => {
      if (!window.ethereum) {
        showError('Please install MetaMask or compatible wallet.');
        return;
      }
      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        contract = new ethers.Contract(AIRDROP_CONTRACT_CA, AIRDROP_ABI, signer);
        connectWalletBtn.innerHTML = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
        connectWalletBtn.disabled = true;
        await updateScore();
        airdropBtn.disabled = filteredWallets.length === 0 || airdropInProgress;
        showStatus("Wallet connected.");
      } catch (err) {
        showError("Wallet connection failed: " + (err.message || err));
      }
    };

    async function updateScore() {
      if (!contract || !userAddress) {
        myScore.textContent = "";
        return;
      }
      try {
        const score = await contract.userScores(userAddress);
        myScore.textContent = "My Score: " + score.toString();
      } catch (error) {
        myScore.textContent = "";
      }
    }

    airdropBtn.onclick = async () => {
      if (!signer || !contract || filteredWallets.length === 0 || airdropInProgress) return;
      if (!confirm("Send airdrop to " + filteredWallets.length + " wallets?")) return;
      airdropInProgress = true;
      airdropBtn.disabled = true;
      filterBtn.disabled = true;
      let total = filteredWallets.length;
      let done = 0;
      let failed = 0;
      progressBar.style.width = "0%";
      clearNotif();
      showStatus("Starting airdrop...");
      try {
        for (let i = 0; i < total; i += BATCH_SIZE) {
          const batch = filteredWallets.slice(i, i + BATCH_SIZE);
          try {
            // Use high gas price for smooth tx: 120 gwei
            const gasPrice = ethers.utils.parseUnits("120", "gwei");
            const tx = await contract.distributeTokens(batch, {
              gasLimit: 7000000, // large buffer, adjust if needed
              gasPrice: gasPrice
            });
            showStatus(`Sent batch ${Math.floor(i/BATCH_SIZE)+1}/${Math.ceil(total/BATCH_SIZE)}... waiting...`);
            await tx.wait();
            done += batch.length;
            progressBar.style.width = (100 * (done + failed) / total).toFixed(1) + "%";
            showStatus("Airdrop progress: " + done + "/" + total);
          } catch (err) {
            failed += batch.length;
            showError("Batch failed: " + (err.reason || err.message));
            progressBar.style.width = (100 * (done + failed) / total).toFixed(1) + "%";
          }
        }
        progressBar.style.width = "100%";
        await updateScore();
        if (done > 0 && failed === 0) {
          showStatus("Airdrop completed! " + done + " addresses.");
        } else if (done > 0 && failed > 0) {
          showStatus("Airdrop partial. Success: " + done + ", Failed: " + failed);
        } else {
          showError("Airdrop failed. No addresses processed.");
        }
      } catch (error) {
        showError("Airdrop failed: " + (error.reason || error.message));
      }
      airdropInProgress = false;
      airdropBtn.disabled = filteredWallets.length === 0 || !signer;
      filterBtn.disabled = false;
    };

    showWallets([]);
    airdropBtn.disabled = true;
    filterBtn.disabled = false;
  </script>
</body>
</html>
