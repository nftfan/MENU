<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<title>$NFTFAN Mention Tool</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="dark light">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#06070a">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
  --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
  --accent: #6a8dff;
  --accent-rgb: 106 141 255;
  --text: #f2f6fb;
  --text-dim: #b6c2d6;
  --text-faint: #6f7d92;
  --surface: #11151d;
  --panel: #171d27cc;
  --border: #2d3947;
  --glass-border: #ffffff12;
  --radius-md: 12px;
  --radius-lg: 16px;
  --shadow-1: 0 4px 12px -4px rgba(0,0,0,.5), 0 12px 28px -8px rgba(0,0,0,.6);
  --blur-panel: 22px;
  --gradient-accent: linear-gradient(135deg,#5f83ff,#4d4ffb 40%,#9a40ff 70%,#ff35a6);
  --gradient-bg: radial-gradient(circle at 10% 15%,#1a2230 0%,#0d1219 45%,#07090d 85%);
  --success: #3ddf91;
}

* { box-sizing: border-box; }
html,body { height:100%; margin:0; }
body {
  font-family: var(--font-sans);
  -webkit-font-smoothing: antialiased;
  background: var(--gradient-bg);
  color: var(--text);
  accent-color: var(--accent);
  overflow-x:hidden;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding: 2rem 1rem;
  font-size: 14px;
}

body::before {
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  background:
    radial-gradient(circle at 85% 10%, #5d82ff28 0%, transparent 40%),
    radial-gradient(circle at 10% 90%, #ff3db922 0%, transparent 45%);
  mix-blend-mode:color-dodge;
  z-index:0;
  animation: bg-glow 15s infinite alternate;
}

@keyframes bg-glow {
  from { opacity: 0.5; transform: scale(1); }
  to { opacity: 1; transform: scale(1.1); }
}

.container {
  width:100%;
  max-width:520px;
  position:relative;
  z-index:1;
  text-align:center;
  animation: slide-up-fade 1s var(--ease-out-expo) .2s both;
}

@keyframes slide-up-fade {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.header {
  margin-bottom: 1.5rem;
}

h1 {
  font-size: 2.25rem;
  font-weight: 900;
  background: var(--gradient-accent);
  -webkit-background-clip:text;
  color:transparent;
  filter:drop-shadow(0 6px 12px #00000050);
  margin:0;
}

.panel {
  position:relative;
  background:var(--panel);
  border:1px solid var(--glass-border);
  border-radius:var(--radius-lg);
  padding:1.5rem;
  box-shadow:var(--shadow-1);
  backdrop-filter:saturate(140%) blur(var(--blur-panel));
  -webkit-backdrop-filter:saturate(140%) blur(var(--blur-panel));
  margin:1rem 0;
  text-align: left;
}

.panel::before {
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg,#ffffff10 0%,transparent 25%,transparent 75%,#ffffff08 100%);
  pointer-events:none;
  mix-blend-mode:overlay;
  opacity:.55;
  border-radius:inherit;
}

.message {
  font-size:14px;
  margin:0 0 1.5rem;
  color:var(--text-dim);
  line-height:1.5;
  text-align: center;
}

button {
  font-family:inherit;
  font-weight:600;
  font-size:14px;
  letter-spacing:.5px;
  line-height:1;
  border:none;
  border-radius:var(--radius-md);
  padding: 0 1.5rem;
  height:50px;
  cursor:pointer;
  transition:transform .25s var(--ease-out-expo), box-shadow .25s var(--ease-out-expo), background .25s ease;
  width:100%;
}

button.primary {
  background:linear-gradient(135deg,#3552ff,#5d82ff 55%,#7b2dfd);
  color:#fff;
  box-shadow:0 4px 14px -5px rgba(var(--accent-rgb)/.8), 0 2px 4px -2px rgba(0,0,0,.6);
}

button.primary:hover:not(:disabled) {
  background:linear-gradient(135deg,#4660ff,#6a8bff 55%,#8a40ff);
  transform:translateY(-3px);
  box-shadow:0 8px 26px -6px rgba(var(--accent-rgb)/.85), 0 3px 10px -4px rgba(0,0,0,.8);
}

button.secondary {
  background: rgba(255,255,255,0.08);
  color: var(--text-dim);
  box-shadow: 0 2px 8px -4px rgba(0,0,0,.4);
}

button.secondary:hover:not(:disabled) {
  background: rgba(255,255,255,0.15);
  color: #fff;
  transform: translateY(-2px);
}

button:active:not(:disabled) {
  transform:translateY(0);
  transition-duration:.1s;
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
  filter:saturate(.3);
  transform:none !important;
  box-shadow: none !important;
}

.loading {
  display:inline-block;
  width:18px;
  height:18px;
  border:2px solid rgba(255,255,255,0.3);
  border-radius:50%;
  border-top-color:#fff;
  animation:spin 1s ease-in-out infinite;
  margin-right:8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#tweet-output-panel {
    display: none;
}

#tweet-text {
    width: 100%;
    min-height: 120px;
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 1rem;
    color: var(--text-dim);
    font-size: 14px;
    line-height: 1.6;
    margin-bottom: 1rem;
    font-family: inherit;
    resize: vertical;
}

.button-group {
    display: flex;
    gap: 0.75rem;
    flex-direction: column;
}
@media (min-width: 400px) {
    .button-group { flex-direction: row; }
}

.toast {
  position:fixed;
  z-index:100;
  bottom:1.5rem;
  max-width:min(360px,90vw);
  background:#121c27f2;
  backdrop-filter:blur(22px) saturate(160%);
  -webkit-backdrop-filter:blur(22px) saturate(160%);
  border:1px solid #ffffff20;
  box-shadow:0 12px 40px -12px rgba(0,0,0,.6), 0 0 0 1px #ffffff08;
  padding: 1rem;
  border-radius:var(--radius-lg);
  font-size:13px;
  line-height:1.4;
  opacity:0;
  transform:translateY(14px) scale(.96);
  pointer-events:none;
  transition:opacity .5s var(--ease-out-expo), transform .55s var(--ease-out-expo);
}
.toast.show {
  opacity:1;
  transform:translateY(0) scale(1);
  pointer-events:auto;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Mention Tool</h1>
  </div>
  
  <div class="panel" id="action-panel" style="animation-delay: 0.4s;">
    <p class="message">Click the button to fetch two groups of users from the database and generate a mention tweet.</p>
    <button id="generateBtn" type="button" class="primary">Fetch Groups & Generate Tweet</button>
  </div>

  <!-- Cooldown panel for timer -->
  <div id="cooldown-panel">
    <div class="cooldown-message">Please wait before generating another tweet.</div>
    <div class="cooldown-timer" id="cooldown-timer">20:00</div>
  </div>

  <div class="panel" id="tweet-output-panel" style="animation-delay: 0.5s;">
    <p class="message">Your tweet is ready. Post it on X or copy the text.</p>
    <textarea id="tweet-text" readonly></textarea>
    <div class="button-group">
      <button id="postBtn" type="button" class="primary">Post on X</button>
      <button id="copyBtn" type="button" class="secondary">Copy Text</button>
    </div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6wYBu-KOXkDmB-84_7OPtY71zBX4FzRY",
  authDomain: "newnft-47bd7.firebaseapp.com",
  databaseURL: "https://newnft-47bd7-default-rtdb.firebaseio.com",
  projectId: "newnft-47bd7",
  storageBucket: "newnft-47bd7.firebasestorage.app",
  messagingSenderId: "172043823738",
  appId: "1:172043823738:web:daf1fcfb7862d7d8f029c3",
  measurementId: "G-8VB3DYRNXR"
};

initializeApp(firebaseConfig);
const db = getDatabase();

document.addEventListener('DOMContentLoaded', () => {
    const generateBtn = document.getElementById('generateBtn');
    const copyBtn = document.getElementById('copyBtn');
    const postBtn = document.getElementById('postBtn');
    const toastEl = document.getElementById('toast');
    const outputPanel = document.getElementById('tweet-output-panel');
    const tweetTextArea = document.getElementById('tweet-text');
    const actionPanel = document.getElementById('action-panel');
    const cooldownPanel = document.getElementById('cooldown-panel');
    const cooldownTimer = document.getElementById('cooldown-timer');

    const cooldownMinutes = 20;
    const userHandle = 'usmanunimib'; // Using your provided login

    function showToast(msg, t = 3000) {
        toastEl.textContent = msg;
        toastEl.classList.add('show');
        setTimeout(() => toastEl.classList.remove('show'), t);
    }

    async function getLastClaimTime() {
        const lastClaimRef = ref(db, `users/${userHandle}/last_claimed`);
        const snapshot = await get(lastClaimRef);
        if (!snapshot.exists()) return null;
        return snapshot.val();
    }

    async function setLastClaimTime(ts) {
        await update(ref(db), { [`/users/${userHandle}/last_claimed`]: ts });
    }

    async function fetchAndClaimTwoGroups() {
        const allGroupsRef = ref(db, 'groups');
        const snapshot = await get(allGroupsRef);
        if (!snapshot.exists()) {
            return [];
        }
        const groupsObj = snapshot.val();
        const pendingGroups = [];
        for (const key in groupsObj) {
            if (groupsObj[key].status === 'pending') {
                pendingGroups.push({ key, data: groupsObj[key] });
            }
        }
        pendingGroups.sort((a, b) => {
            const numA = parseInt(a.key.replace('group_', ''));
            const numB = parseInt(b.key.replace('group_', ''));
            return numA - numB;
        });
        if (pendingGroups.length < 2) {
            return [];
        }
        const groupsToClaim = pendingGroups.slice(0, 2);
        const updates = {};
        for (const group of groupsToClaim) {
            updates[`/groups/${group.key}/status`] = 'claimed';
            updates[`/groups/${group.key}/claimed_by`] = userHandle;
            updates[`/groups/${group.key}/claimed_at`] = new Date().toISOString();
        }
        await update(ref(db), updates);
        return groupsToClaim;
    }

    // Countdown timer logic
    function startCooldownTimer(secondsLeft) {
        // Show cooldown panel, hide action panel
        actionPanel.style.display = 'none';
        cooldownPanel.style.display = 'block';

        function pad(n) { return n.toString().padStart(2, '0'); }

        let interval = setInterval(() => {
            const min = Math.floor(secondsLeft / 60);
            const sec = secondsLeft % 60;
            cooldownTimer.textContent = `${pad(min)}:${pad(sec)}`;
            if (secondsLeft <= 0) {
                clearInterval(interval);
                cooldownPanel.style.display = 'none';
                actionPanel.style.display = '';
            }
            secondsLeft--;
        }, 1000);
    }

    // On page load, check for cooldown and start timer if needed
    (async function checkInitialCooldown() {
        const lastClaimed = await getLastClaimTime();
        if (lastClaimed) {
            const now = Date.now();
            const diffMs = now - new Date(lastClaimed).getTime();
            const diffSec = Math.floor(diffMs / 1000);
            const totalCooldownSec = cooldownMinutes * 60;
            if (diffSec < totalCooldownSec) {
                startCooldownTimer(totalCooldownSec - diffSec);
            }
        }
    })();

    generateBtn.addEventListener('click', async () => {
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<span class="loading"></span> Checking Cooldown...';

        try {
            const lastClaimed = await getLastClaimTime();
            const now = Date.now();
            if (lastClaimed) {
                const diffMs = now - new Date(lastClaimed).getTime();
                const diffMin = diffMs / 60000;
                if (diffMin < cooldownMinutes) {
                    const waitSec = Math.ceil((cooldownMinutes * 60) - diffMs / 1000);
                    startCooldownTimer(waitSec);
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Fetch Groups & Generate Tweet';
                    return;
                }
            }

            generateBtn.innerHTML = '<span class="loading"></span> Fetching Groups...';
            const claimedGroups = await fetchAndClaimTwoGroups();

            if (claimedGroups.length < 2) {
                showToast('Not enough available groups found. Please try again later.');
                generateBtn.disabled = false;
                generateBtn.textContent = 'Fetch Groups & Generate Tweet';
                return;
            }
            
            const allUsernames = claimedGroups.reduce((acc, group) => {
                return acc.concat(group.data.usernames);
            }, []);

            const formattedUsernames = allUsernames.map(u => u.startsWith('@') ? u : `@${u}`);
            const mentionList = formattedUsernames.join(' ');
            
            const tweet = `Hello, ${mentionList} I have mentioned you to claim 5B free $NFTFAN token by @nftfanstoken at this link: https://www.nftfanstoken.com/nftzz/ I used this url to invite you: https://www.nftfanstoken.com/mtool`;

            tweetTextArea.value = tweet;
            outputPanel.style.display = 'block';

            // Set cooldown timestamp
            await setLastClaimTime(new Date().toISOString());
            
            showToast('Groups fetched and tweet generated!');
            generateBtn.parentElement.style.display = 'none';
            
            outputPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });

        } catch (error) {
            console.error('Error fetching or processing groups:', error);
            showToast('An error occurred. Please try again.');
            generateBtn.disabled = false;
            generateBtn.textContent = 'Fetch Groups & Generate Tweet';
        }
    });

    postBtn.addEventListener('click', () => {
        const tweet = tweetTextArea.value;
        if (!tweet) return;
        const encodedTweet = encodeURIComponent(tweet);
        const webIntentUrl = `https://twitter.com/intent/tweet?text=${encodedTweet}`;
        window.open(webIntentUrl, '_blank', 'noopener');
    });

    copyBtn.addEventListener('click', () => {
        const tweet = tweetTextArea.value;
        if (!tweet) return;

        navigator.clipboard.writeText(tweet)
            .then(() => {
                showToast('Tweet copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy text: ', err);
                showToast('Could not copy tweet. Please copy it manually.');
                tweetTextArea.select();
                document.execCommand('copy');
            });
    });
});
</script>
</body>
</html>
