<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NFTFans Lottery â€“ Win 100 $POL Mega Prize!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- Google Fonts for professional look -->
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary: #09bfa1;
      --secondary: #ffd700;
      --background: #181c1f;
      --card-bg: #22272b;
      --accent: #323c47;
      --success: #43d675;
      --danger: #ea4444;
      --font: 'Inter', Arial, sans-serif;
      --shadow: 0 2px 12px #0002;
      --border-radius: 14px;
      --transition: 0.2s cubic-bezier(.22,1,.36,1);
      --mobile-font-size: 12px;
      --icon-size: 20px;
    }
    html, body {
      margin: 0; padding: 0;
      background: var(--background);
      font-family: var(--font);
      color: #f0f3f9;
      min-height: 100vh;
      font-size: var(--mobile-font-size);
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 430px;
      margin: 10px auto 10px auto;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 12px 3vw 10px 3vw;
      border: 1px solid #232a33;
    }
    h1 {
      text-align: center;
      font-size: 1.23rem;
      margin: 0 0 6px 0;
      color: var(--secondary);
      letter-spacing: 0.5px;
      font-weight: 700;
      line-height: 1.1;
      text-shadow: 0 2px 10px #fffa;
    }
    .prize {
      font-weight: 600;
      color: var(--primary);
      text-align: center;
      margin-bottom: 8px;
      font-size: 1.04rem;
      letter-spacing: 0.08em;
    }
    .bonus-nftfan {
      display: flex;
      align-items: center;
      gap: 7px;
      background: #222f2e;
      border-radius: 7px;
      padding: 6px 10px;
      margin: 10px 0 12px 0;
      font-size: .98em;
      color: #00ffc3;
      justify-content: center;
      font-weight: 600;
      box-shadow: 0 1px 7px #00ffe722;
    }
    .nftfan-icon {
      width: var(--icon-size);
      height: var(--icon-size);
      border-radius: 50%;
      box-shadow: 0 0 6px #fff6;
      background: #fff;
      object-fit: cover;
    }
    .lottery-img {
      display: block;
      width: 97vw;
      max-width: 340px;
      margin: 10px auto 10px auto;
      border-radius: 10px;
      border: 1.5px solid var(--secondary);
      box-shadow: 0 0 10px #ffd70044;
      transition: transform .20s var(--transition);
    }
    .lottery-img:hover { transform: scale(1.01) rotate(-1deg);}
    .instructions {
      background: #232e2f;
      border-left: 3px solid var(--primary);
      padding: 8px 12px 8px 12px;
      margin-bottom: 13px;
      border-radius: 7px;
      font-size: 1.03em;
      line-height: 1.55;
      box-shadow: 0 1px 7px #0ff1;
      color: #e1e7f3;
    }
    .material-icons {
      font-size: var(--icon-size);
      vertical-align: middle;
      margin-right: 2px;
    }
    .address-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      margin-bottom: 9px;
    }
    .address-box {
      background: var(--accent);
      border: 1.5px dashed var(--primary);
      color: var(--primary);
      border-radius: 5px;
      padding: 7px 10px;
      font-family: 'Fira Mono', monospace;
      font-size: 1em;
      text-align: center;
      margin-bottom: 1px;
      word-break: break-all;
      font-weight: 600;
      user-select: all;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
      box-shadow: 0 0 7px #12d6b314;
    }
    .address-box.copied {
      background: var(--success);
      color: #002a24;
      border-color: #fff;
      animation: pop 0.7s;
    }
    @keyframes pop {
      0% { transform: scale(1);}
      40% { transform: scale(1.08);}
      100% { transform: scale(1);}
    }
    .copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .98em;
      padding: 3px 10px;
      border-radius: 6px;
      background: #232b4b;
      color: var(--primary);
      border: none;
      cursor: pointer;
      transition: background .16s;
      margin-top: 1px;
      font-weight: 500;
    }
    .copy-btn:hover {
      background: #34418a;
      color: #fff;
    }

    .entry-count {
      text-align: center;
      font-size: 1.07em;
      color: var(--primary);
      margin-bottom: 4px;
      font-weight: 600;
    }
    .progress-bar-bg {
      width: 100%;
      background: #26314a;
      border-radius: 4px;
      height: 8px;
      margin: 0 auto 8px auto;
      box-shadow: 0 1px 3px #1118;
      position: relative;
    }
    .progress-bar-fill {
      height: 8px;
      background: linear-gradient(90deg, var(--primary), #fff 70%);
      border-radius: 4px;
      transition: width 0.6s var(--transition);
      min-width: 4px;
      max-width: 100%;
      box-shadow: 0 0 4px #12d6b366;
    }
    .send-pol-section {
      margin: 8px auto 12px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .send-btn {
      background: linear-gradient(90deg, var(--primary) 10%, #8affec 90%);
      border: none;
      color: #003e2e;
      font-weight: bold;
      font-size: 1.07em;
      border-radius: 13px;
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 2px;
      transition: background .15s, transform .15s;
      min-width: 134px;
      min-height: 32px;
      box-shadow: 0 1px 7px #12d6b355;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      position: relative;
      overflow: hidden;
    }
    .send-btn:active { transform: scale(.97);}
    .send-btn.success {
      background: linear-gradient(90deg, #4ade80 10%, #fff 70%);
      color: #0e2;
      animation: send-success 0.65s;
    }
    .send-btn.error {
      background: linear-gradient(90deg, #ea4444 10%, #fff 70%);
      color: #fff;
      animation: send-fail 0.5s;
    }
    @keyframes send-success {
      0% { box-shadow: 0 0 0 #4ade8040;}
      60% { box-shadow: 0 0 14px #4ade8040;}
      100% { box-shadow: 0 0 0 #4ade8040;}
    }
    @keyframes send-fail {
      0% { box-shadow: 0 0 0 #ea444444;}
      50% { box-shadow: 0 0 12px #ea444444;}
      100% { box-shadow: 0 0 0 #ea444444;}
    }
    .send-anim {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%,-50%);
      pointer-events: none;
      z-index: 1;
      display: none;
    }
    .send-btn.sending .send-anim {
      display: block;
      animation: spin 1.1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%,-50%) rotate(0);}
      100% { transform: translate(-50%,-50%) rotate(360deg);}
    }

    .tx-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 11px;
      background: #232a2f;
      border-radius: 7px;
      overflow: hidden;
      box-shadow: 0 1px 7px #0005;
      font-size: 12px;
    }
    .tx-table th, .tx-table td {
      padding: 4.5px 2px;
      text-align: center;
    }
    .tx-table th {
      background: #2d3741;
      color: var(--secondary);
      font-weight: 600;
      font-size: 12px;
      border-bottom: 1px solid #26314a;
    }
    .tx-table tr {
      transition: background 0.1s;
    }
    .tx-table tr.valid-row {
      background: linear-gradient(90deg, #0ae1a0 0, #eaffd6 100%);
      color: #057d45;
      font-weight: bold;
    }
    .tx-table tr.new-entry-anim {
      animation: entry-pop 0.7s;
    }
    @keyframes entry-pop {
      0% { background: #fff9; transform: scale(0.96);}
      60% { background: #08ffb055; transform: scale(1.01);}
      100% { }
    }
    .tx-table tr:not(.valid-row):hover {
      background: #222b2f;
    }
    .tx-table td a {
      color: var(--secondary);
      text-decoration: underline;
      font-size: 12px;
    }
    .tx-table td a:hover { color: #fff;}
    .footer {
      margin-top: 14px;
      text-align: center;
      font-size: 10px;
      color: #697189;
      letter-spacing: .08em;
    }
    .blink {
      animation: blink-anim 0.45s 2;
    }
    @keyframes blink-anim {
      0% { background: #fff9; color: #222;}
      50% { background: #12d6b3; color: #fff;}
      100% { }
    }
    @media (max-width: 460px) {
      .container { padding: 2vw 1vw; max-width: 99vw;}
      .tx-table th, .tx-table td, .tx-table td a { font-size: 10.5px;}
      .lottery-img { max-width: 96vw;}
    }
    @media (max-width: 350px) {
      .entry-count { font-size: 0.95em;}
      .lottery-img { max-width: 99vw;}
    }
  </style>
  <!-- Ethers.js for wallet interaction -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
<div class="container">
  <h1>
    <span class="material-icons" style="color:#ffd700;">confirmation_number</span>
    NFTFans Lottery
  </h1>
  <div class="prize">
    WIN <span style="color:#ffd700;">100 $POL</span> (~$20) â€“ <span style="color:#43d675;">1 Lucky Winner!</span>
  </div>
  <div class="bonus-nftfan">
    <img class="nftfan-icon" src="https://res.cloudinary.com/dvbwmtdwh/image/upload/v1751403742/Untitled_design_69_kxpjn9.png" alt="NFTFAN Token">
    <span>+ <b>1,000T $NFTFAN</b> tokens each entry</span>
  </div>
  <img src="https://pbs.twimg.com/media/GuzMxVMWkAA08_t?format=jpg&name=large" alt="Lottery Ticket" class="lottery-img" loading="lazy">
  <div class="instructions">
    <span class="material-icons" style="font-size:18px;color:#ffd700;vertical-align:-4px;">info</span>
    <b style="color:#ffd700;">How to Enter:</b> <br>
    <ol style="margin:0 0 0 1.1em; padding-left:0.7em;">
      <li>Send <b>1 $POL</b> to the address below.</li>
      <li>Each <b>1 $POL</b> = 1 lottery entry. No max entries.</li>
      <li>At <b>150 entries</b>, 1 random participant wins <b>100 $POL!</b></li>
      <li>Prize sent automatically to winner.</li>
    </ol>
  </div>
  <div class="address-section">
    <div class="address-box" id="address-box" title="Click to copy">
      0xaf2d132C8773bca3821C24EcF64e844E202A12e8
    </div>
    <button class="copy-btn" id="copy-btn">
      <span class="material-icons" style="font-size:17px;">content_copy</span> Copy Address
    </button>
  </div>
  <div class="entry-count" id="entry-count">
    Loading entries...
  </div>
  <div class="progress-bar-bg">
    <div class="progress-bar-fill" id="progress-fill" style="width:0%"></div>
  </div>
  <div class="send-pol-section">
    <button id="send-btn" class="send-btn">
      <span class="material-icons" style="font-size:18px;">send</span>
      <span>Send 1 $POL & Enter</span>
      <svg class="send-anim" width="15" height="15" viewBox="0 0 50 50">
        <circle cx="25" cy="25" r="20" fill="none" stroke="#00ffe7" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4" stroke-dashoffset="0"/>
      </svg>
    </button>
    <div id="send-status" style="font-size:10px; min-height:1em; color:#ffd700; margin-top:2px;"></div>
  </div>
  <h2 style="margin-top:13px; color:#ffd700; text-align:center; font-size:12px;">Valid Entries</h2>
  <table class="tx-table" id="tx-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Time</th>
        <th>From</th>
        <th>Amount</th>
        <th>Txn</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="5">Loadingâ€¦</td></tr>
    </tbody>
  </table>
</div>
<div class="footer">
  Powered by <b>NFTFans</b> <span class="material-icons" style="font-size:13px;vertical-align:middle;">bolt</span> Luck favours the brave!
</div>
<script>
const LOTTERY_ADDRESS = "0xaf2d132C8773bca3821C24EcF64e844E202A12e8";
const API_KEY = "3AFN3ZU4ANK3XEUJQ6BRJCBCITAFHKFVTV";
const POL_DECIMALS = 18;
const ENTRY_AMOUNT = 1;
const MAX_ENTRIES = 150;

function formatAddress(addr) {
  return addr.slice(0, 4) + "â€¦" + addr.slice(-3);
}
function formatDate(ts) {
  const date = new Date(parseInt(ts, 10) * 1000);
  // Show MM/DD HH:MM
  return date.toLocaleString(undefined, {
    month: "2-digit", day: "2-digit",
    hour: '2-digit', minute: '2-digit'
  });
}
function formatPol(val) {
  return (parseFloat(val) / Math.pow(10, POL_DECIMALS)).toFixed(2);
}

let prevTxHashes = [];
let prevEntries = 0;
let lastDataResult = null;
let lastApiCall = 0;

// To optimize for API limits: cache the last result, only refetch if >6s or forced
async function fetchAndRenderTxs(force = false) {
  const now = Date.now();
  if (!force && lastDataResult && now - lastApiCall < 6000) {
    renderTx(lastDataResult);
    return;
  }
  const tbody = document.querySelector("#tx-table tbody");
  const entryCountDiv = document.getElementById("entry-count");
  const progressBar = document.getElementById("progress-fill");
  let url = `https://api.polygonscan.com/api?module=account&action=txlist&address=${LOTTERY_ADDRESS}&sort=desc&apikey=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    lastApiCall = now;
    lastDataResult = data;
    renderTx(data);
  } catch (e) {
    const tbody = document.querySelector("#tx-table tbody");
    tbody.innerHTML = `<tr><td colspan="5" style="color:red;">Error loading.</td></tr>`;
    document.getElementById("entry-count").innerHTML = "Error loading entries.";
  }
}

function renderTx(data) {
  const tbody = document.querySelector("#tx-table tbody");
  const entryCountDiv = document.getElementById("entry-count");
  const progressBar = document.getElementById("progress-fill");
  if (data.status !== "1" || !Array.isArray(data.result)) {
    tbody.innerHTML = `<tr><td colspan="5">No valid entries yet.</td></tr>`;
    entryCountDiv.innerHTML = "No entries.";
    progressBar.style.width = "0%";
    return;
  }
  // Only consider valid incoming tx (to our address AND value == 1 POL AND not failed)
  const txs = data.result.filter(tx =>
    tx.to && tx.to.toLowerCase() === LOTTERY_ADDRESS.toLowerCase() &&
    Math.abs(parseFloat(tx.value) / Math.pow(10, POL_DECIMALS) - ENTRY_AMOUNT) < 0.00009 &&
    tx.isError === "0"
  );
  let entries = txs.length, rows = "";
  let hashes = txs.slice(0, 25).map(tx => tx.hash);
  let newHashes = prevTxHashes.length === 0 ? [] : hashes.filter(h => !prevTxHashes.includes(h));
  txs.slice(0, 25).forEach((tx, idx) => {
    let isNew = newHashes.includes(tx.hash);
    rows += `<tr class="valid-row${isNew ? ' new-entry-anim' : ''}">
      <td>${entries - idx}</td>
      <td>${formatDate(tx.timeStamp)}</td>
      <td title="${tx.from}">${formatAddress(tx.from)}</td>
      <td>${formatPol(tx.value)}</td>
      <td><a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" title="View on Polygonscan">
        <span class="material-icons" style="font-size:15px;vertical-align:middle;">open_in_new</span>
      </a></td>
    </tr>`;
  });
  if (!rows) rows = `<tr><td colspan="5">No valid entries yet.</td></tr>`;
  tbody.innerHTML = rows;
  entryCountDiv.innerHTML = `Valid entries: <b style="color:#ffd700;">${entries}</b> / <b>${MAX_ENTRIES}</b>`;
  let percent = Math.min(Math.round((entries / MAX_ENTRIES) * 100), 100);
  progressBar.style.width = percent + "%";
  // Only animate the new entry if there are new hashes
  if (newHashes.length > 0) {
    entryCountDiv.classList.add('blink');
    setTimeout(()=>entryCountDiv.classList.remove('blink'), 900);
    setTimeout(()=>{
      document.querySelectorAll('.new-entry-anim').forEach(row => row.classList.remove('new-entry-anim'));
    }, 800);
  }
  prevEntries = entries;
  prevTxHashes = hashes;
}

fetchAndRenderTxs(true);
setInterval(fetchAndRenderTxs, 6500);

// Copy Address Logic
const addressBox = document.getElementById('address-box');
const copyBtn = document.getElementById('copy-btn');
copyBtn.addEventListener('click', () => {
  navigator.clipboard.writeText(LOTTERY_ADDRESS);
  addressBox.classList.add('copied');
  copyBtn.innerHTML = `<span class="material-icons" style="font-size:17px;">check</span> Copied!`;
  setTimeout(()=>{
    addressBox.classList.remove('copied');
    copyBtn.innerHTML = `<span class="material-icons" style="font-size:17px;">content_copy</span> Copy Address`;
  }, 900);
});
addressBox.addEventListener('click', () => copyBtn.click());

// Send $POL Button, with wallet integration + animation
const sendBtn = document.getElementById('send-btn');
const sendStatus = document.getElementById('send-status');
let sending = false;
sendBtn.addEventListener('click', async () => {
  if (sending) return;
  sending = true;
  sendBtn.classList.remove('success','error');
  sendBtn.classList.add('sending');
  sendStatus.innerText = "";
  const anim = sendBtn.querySelector('.send-anim');
  if(anim) anim.style.display = "block";
  try {
    if (typeof window.ethereum === 'undefined') {
      throw new Error("No wallet detected. Install MetaMask or another wallet.");
    }
    const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    // Check if user is on Polygon (137), prompt switch if not
    const network = await provider.getNetwork();
    if (network.chainId !== 137) {
      await window.ethereum.request({
        method: 'wallet_switchEthereumChain',
        params: [{ chainId: '0x89' }],
      });
    }
    const tx = {
      to: LOTTERY_ADDRESS,
      value: ethers.utils.parseUnits(ENTRY_AMOUNT.toString(), POL_DECIMALS)
    };
    sendBtn.querySelector('span:last-child').innerText = "Confirmingâ€¦";
    sendStatus.style.color = "#ffd700";
    const txResponse = await signer.sendTransaction(tx);
    sendBtn.querySelector('span:last-child').innerText = "Sendingâ€¦";
    sendStatus.innerText = "Waiting for confirmationâ€¦";
    await txResponse.wait(1);
    sendBtn.classList.remove('sending');
    sendBtn.classList.add('success');
    sendBtn.querySelector('span:last-child').innerText = "Success! You're In ðŸŽ‰";
    sendStatus.innerText = "Entry confirmed!";
    sendStatus.style.color = "var(--success)";
    fetchAndRenderTxs(true);
    setTimeout(()=>{
      sendBtn.classList.remove('success');
      sendBtn.querySelector('span:last-child').innerText = "Send 1 $POL & Enter";
      sendStatus.innerText = "";
    }, 1500);
  } catch(e) {
    sendBtn.classList.remove('sending');
    sendBtn.classList.add('error');
    sendBtn.querySelector('span:last-child').innerText = "Failed! Try Again";
    sendStatus.style.color = "var(--danger)";
    sendStatus.innerText = e.message || "Transaction failed.";
    setTimeout(()=>{
      sendBtn.classList.remove('error');
      sendBtn.querySelector('span:last-child').innerText = "Send 1 $POL & Enter";
      sendStatus.innerText = "";
    }, 2000);
  }
  sending = false;
  if(sendBtn.querySelector('.send-anim')) sendBtn.querySelector('.send-anim').style.display = "none";
});
</script>
</body>
</html>
