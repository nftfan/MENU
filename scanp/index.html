<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Grocery Barcode Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #0ea5e9;
      --accent-2: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --card: #111827;
      --border: #1f2937;
      --ring: rgba(14,165,233,.5);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, #0b1220, #0b122000);
      padding: 16px;
      backdrop-filter: saturate(120%) blur(6px);
      border-bottom: 1px solid var(--border);
    }
    h1 {
      margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: .2px;
      display: flex; align-items: center; gap: 10px;
    }
    .chip {
      font-size: .75rem; color: #0ea5e9; background: rgba(14,165,233,.12); border: 1px solid rgba(14,165,233,.25);
      padding: 2px 8px; border-radius: 999px;
    }
    main { padding: 16px; display: grid; gap: 16px; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button, .btn {
      appearance: none; border: 1px solid var(--border); background: #0b1220; color: var(--text);
      padding: 12px 14px; border-radius: 12px; font-weight: 600; font-size: .95rem; display: inline-flex; gap: 10px; align-items: center;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.02), 0 2px 10px rgba(0,0,0,.3);
      transition: transform .05s ease, border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    button:active { transform: translateY(1px) scale(.995); }
    button.primary { background: linear-gradient(180deg, #0ea5e9, #0284c7); border-color: rgba(255,255,255,.15); color: white; }
    button.success { background: linear-gradient(180deg, #22c55e, #16a34a); border-color: rgba(255,255,255,.15); color: white; }
    button.warn { background: linear-gradient(180deg, #f59e0b, #d97706); border-color: rgba(255,255,255,.15); color: black; }
    button.danger { background: linear-gradient(180deg, #ef4444, #dc2626); border-color: rgba(255,255,255,.15); color: white; }
    button.ghost { background: #0b1220; }
    button:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }

    .icon { width: 20px; height: 20px; display: inline-block; }

    .panel {
      border: 1px solid var(--border);
      background: linear-gradient(180deg, #0f172a, #0b1220);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .panel-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .panel-body { padding: 12px; }

    table { width: 100%; border-collapse: collapse; }
    thead th {
      text-align: left; font-size: .8rem; color: var(--muted);
      border-bottom: 1px solid var(--border); padding: 10px 8px; font-weight: 600;
    }
    tbody td {
      padding: 12px 8px; border-bottom: 1px dashed rgba(255,255,255,.07); vertical-align: middle;
    }
    .empty {
      color: var(--muted); padding: 24px; text-align: center; font-size: .95rem;
    }

    /* Scanner sheet */
    .sheet {
      position: fixed; inset: 0; background: rgba(2,6,23,.72);
      backdrop-filter: saturate(120%) blur(4px);
      display: none; place-items: center; z-index: 50;
    }
    .sheet.open { display: grid; }
    .sheet-card {
      width: min(100vw, 720px); margin: 16px; border-radius: 16px; overflow: hidden;
      background: var(--panel); border: 1px solid var(--border);
      display: grid; grid-template-rows: auto 1fr auto;
    }
    .sheet-toolbar { padding: 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); }
    .sheet-toolbar .spacer { flex: 1; }
    .sheet-video {
      position: relative; aspect-ratio: 3/4; background: #000;
      display: grid; place-items: center;
    }
    video {
      width: 100%; height: 100%; object-fit: cover; background: #000;
    }
    .frame {
      position: absolute; inset: 10% 10%;
      border-radius: 12px;
      box-shadow:
        inset 0 0 0 2px rgba(255,255,255,.9),
        0 0 0 9999px rgba(0,0,0,.35);
      outline: 100vmax solid rgba(0,0,0,.25);
      pointer-events: none;
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: inset 0 0 0 2px rgba(255,255,255,.85), 0 0 0 9999px rgba(0,0,0,.35); }
      50% { box-shadow: inset 0 0 0 3px rgba(14,165,233,.9), 0 0 0 9999px rgba(0,0,0,.35); }
    }
    .hint {
      padding: 10px 12px; color: var(--muted); font-size: .9rem; border-top: 1px solid var(--border);
      display: flex; gap: 8px; align-items: center; justify-content: center;
    }

    .pill {
      display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 999px;
      border: 1px solid var(--border); background: #0b1220; font-size: .8rem; color: var(--muted);
    }
    .tag { font-size: .75rem; color: #cbd5e1; background: rgba(255,255,255,.06); padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }

    .qty {
      display: inline-flex; align-items: center; border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden;
    }
    .qty button { padding: 6px 10px; border-radius: 0; background: #0b1220; }
    .qty input {
      width: 48px; text-align: center; background: #0f172a; border: 0; color: var(--text); padding: 6px 4px; font-weight: 700;
    }

    .flex { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .right { margin-left: auto; }

    .sr-only {
      position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden;
      clip: rect(0,0,0,0); white-space: nowrap; border: 0;
    }
    a.link { color: var(--accent); text-decoration: none; }
    a.link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <header>
    <h1>
      Grocery Barcode Scanner
      <span class="chip">Offline-ready</span>
      <span class="chip">Local only</span>
    </h1>
  </header>

  <main>
    <div class="controls">
      <button class="primary" id="openCameraBtn" type="button" title="Open camera to scan">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7a2 2 0 0 1 2-2h2.2a2 2 0 0 0 1.6-.8l.4-.54A2 2 0 0 1 11.8 3h4.4A2 2 0 0 1 18 4.33L18.2 5H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7Z" fill="currentColor" opacity=".12"/>
          <path d="M4 7a2 2 0 0 1 2-2h2.2a2 2 0 0 0 1.6-.8l.4-.54A2 2 0 0 1 11.8 3h4.4A2 2 0 0 1 18 4.33L18.2 5H20a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7Z" stroke="currentColor" stroke-width="1.5"/>
          <circle cx="12" cy="13" r="4.5" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        Scan
      </button>

      <button class="ghost" id="exportCsvBtn" type="button" title="Export as CSV">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3v12m0 0 4-4m-4 4-4-4M4 17v1a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3v-1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Export CSV
      </button>

      <button class="ghost" id="clearAllBtn" type="button" title="Clear all">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        Clear
      </button>

      <span class="pill right" id="statusPill">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <circle cx="12" cy="12" r="9" stroke="currentColor" opacity=".25"/>
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2" stroke-dasharray="56" stroke-dashoffset="28"/>
        </svg>
        Ready
      </span>
    </div>

    <section class="panel" aria-labelledby="listTitle">
      <div class="panel-header">
        <div class="flex">
          <strong id="listTitle">Scanned items</strong>
          <span class="tag" id="totalCount">0 items</span>
          <span class="tag" id="totalQty">0 qty</span>
        </div>
        <div class="flex">
          <span class="pill" id="capabilityPill">Capability: Detecting…</span>
        </div>
      </div>
      <div class="panel-body">
        <div id="emptyState" class="empty">No items yet. Tap “Scan” to start.</div>
        <div style="overflow:auto">
          <table id="scanTable" aria-describedby="listTitle">
            <thead>
              <tr>
                <th style="width:44px">#</th>
                <th>Barcode</th>
                <th>Format</th>
                <th>Qty</th>
                <th>First seen</th>
                <th>Last seen</th>
                <th style="width:96px">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- Scanner Sheet -->
  <div class="sheet" id="scannerSheet" aria-hidden="true" role="dialog" aria-label="Barcode scanner">
    <div class="sheet-card">
      <div class="sheet-toolbar">
        <button class="ghost" id="closeScannerBtn" type="button" title="Close">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          Close
        </button>
        <div class="spacer"></div>
        <span class="pill" id="scannerModePill">Mode: —</span>
      </div>
      <div class="sheet-video">
        <video id="video" playsinline muted></video>
        <div class="frame" aria-hidden="true"></div>
      </div>
      <div class="hint">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7h3m10 0h3M4 17h3m10 0h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity=".6"/>
          <rect x="7" y="5" width="10" height="14" rx="2" stroke="currentColor" stroke-width="1.5" opacity=".6"/>
        </svg>
        Align the barcode within the frame
      </div>
    </div>
  </div>

  <!-- ZXing fallback (loaded only if needed) -->
  <script id="zxingScript" defer data-loaded="false"></script>

  <script>
    // State
    const state = {
      scans: [],
      lastSeen: new Map(), // code -> timestamp
      stream: null,
      rafId: null,
      using: 'none', // 'BarcodeDetector' | 'ZXing' | 'none'
      zxingReader: null,
      coolDownMs: 1500
    };

    // Elements
    const els = {
      openBtn: document.getElementById('openCameraBtn'),
      closeBtn: document.getElementById('closeScannerBtn'),
      sheet: document.getElementById('scannerSheet'),
      video: document.getElementById('video'),
      tableBody: document.querySelector('#scanTable tbody'),
      empty: document.getElementById('emptyState'),
      totalCount: document.getElementById('totalCount'),
      totalQty: document.getElementById('totalQty'),
      exportBtn: document.getElementById('exportCsvBtn'),
      clearBtn: document.getElementById('clearAllBtn'),
      statusPill: document.getElementById('statusPill'),
      capabilityPill: document.getElementById('capabilityPill'),
      modePill: document.getElementById('scannerModePill'),
      zxingScript: document.getElementById('zxingScript'),
    };

    // Utilities
    const nowIso = () => new Date().toISOString();
    const fmtTime = iso => {
      try {
        const d = new Date(iso);
        return d.toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
      } catch { return iso; }
    };
    const vibrate = pat => 'vibrate' in navigator && navigator.vibrate(pat);
    const beep = () => {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.setValueAtTime(880, ctx.currentTime);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.15);
        o.connect(g).connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + 0.16);
      } catch {}
    };
    const save = () => localStorage.setItem('grocery_scans_v1', JSON.stringify(state.scans));
    const load = () => {
      try {
        const raw = localStorage.getItem('grocery_scans_v1');
        state.scans = raw ? JSON.parse(raw) : [];
      } catch { state.scans = []; }
      render();
    };

    function setStatus(text) {
      els.statusPill.innerHTML = els.statusPill.innerHTML.replace(/>.*$/, '>' + text);
    }

    function setCapabilityPill(text) {
      els.capabilityPill.textContent = 'Capability: ' + text;
    }

    function setModePill(text) {
      els.modePill.textContent = 'Mode: ' + text;
    }

    // Rendering
    function render() {
      const tbody = els.tableBody;
      tbody.innerHTML = '';
      if (!state.scans.length) {
        els.empty.style.display = '';
      } else {
        els.empty.style.display = 'none';
      }
      let i = 0, totalQty = 0;
      for (const item of state.scans) {
        totalQty += item.qty;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${++i}</td>
          <td><code>${escapeHtml(item.code)}</code></td>
          <td><span class="tag">${escapeHtml(item.format || '—')}</span></td>
          <td>
            <div class="qty">
              <button type="button" aria-label="Decrease quantity">−</button>
              <input type="number" min="1" value="${item.qty}" inputmode="numeric" />
              <button type="button" aria-label="Increase quantity">+</button>
            </div>
          </td>
          <td>${fmtTime(item.firstSeen)}</td>
          <td>${fmtTime(item.lastSeen)}</td>
          <td>
            <div class="flex">
              <button type="button" class="success" data-action="scan-again" title="Scan again">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M4 7h3m10 0h3M4 17h3m10 0h3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity=".7"/>
                  <rect x="7" y="5" width="10" height="14" rx="2" stroke="currentColor" stroke-width="1.5" opacity=".7"/>
                </svg>
              </button>
              <button type="button" class="danger" data-action="delete" title="Remove">
                <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M6 7h12M9 7v12m6-12v12M10 4h4l1 2H9l1-2Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>
            </div>
          </td>
        `;
        // Attach handlers
        const [minusBtn, qtyInput, plusBtn] = tr.querySelectorAll('.qty > *');
        minusBtn.addEventListener('click', () => updateQty(item.code, -1));
        plusBtn.addEventListener('click', () => updateQty(item.code, +1));
        qtyInput.addEventListener('change', () => setQty(item.code, Number(qtyInput.value || 1)));
        tr.querySelector('[data-action="delete"]').addEventListener('click', () => removeItem(item.code));
        tr.querySelector('[data-action="scan-again"]').addEventListener('click', () => openScanner());
        tbody.appendChild(tr);
      }
      els.totalCount.textContent = `${state.scans.length} item${state.scans.length !== 1 ? 's' : ''}`;
      els.totalQty.textContent   = `${totalQty} qty`;
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // Data ops
    function addOrBump(code, format) {
      const t = nowIso();
      const existing = state.scans.find(x => x.code === code);
      if (existing) {
        existing.qty += 1;
        existing.lastSeen = t;
      } else {
        state.scans.unshift({ code, format: format || '', qty: 1, firstSeen: t, lastSeen: t });
      }
      save();
      render();
    }
    function updateQty(code, delta) {
      const item = state.scans.find(x => x.code === code);
      if (!item) return;
      item.qty = Math.max(1, item.qty + delta);
      item.lastSeen = nowIso();
      save(); render();
    }
    function setQty(code, value) {
      const item = state.scans.find(x => x.code === code);
      if (!item) return;
      item.qty = Math.max(1, Number.isFinite(value) ? value : 1);
      item.lastSeen = nowIso();
      save(); render();
    }
    function removeItem(code) {
      state.scans = state.scans.filter(x => x.code !== code);
      save(); render();
    }
    function clearAll() {
      if (!confirm('Remove all scanned items?')) return;
      state.scans = [];
      save(); render();
    }

    // Scanner
    let detector = null;
    async function openScanner() {
      els.sheet.classList.add('open');
      els.sheet.setAttribute('aria-hidden', 'false');
      setStatus('Opening camera…');

      try {
        // Prefer rear camera
        state.stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        els.video.srcObject = state.stream;
        await els.video.play();

        // Choose detection method
        if ('BarcodeDetector' in window) {
          const supported = await window.BarcodeDetector.getSupportedFormats().catch(() => []);
          const needed = ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'];
          const formats = supported.length ? supported.filter(f => needed.includes(f)).concat(['qr_code']) : needed;
          detector = new window.BarcodeDetector({ formats });
          state.using = 'BarcodeDetector';
          setModePill('Native');
          loopDetect();
        } else {
          // ZXing fallback
          await loadZXing();
          state.zxingReader = new window.ZXing.BrowserMultiFormatReader();
          state.using = 'ZXing';
          setModePill('ZXing');
          await startZXing();
        }

        setStatus('Scanning…');
      } catch (err) {
        console.error(err);
        alert('Could not open the camera. Please ensure this page is served over HTTPS and camera permissions are allowed.');
        setStatus('Camera error');
        closeScanner();
      }
    }

    function closeScanner() {
      cancelAnimationFrame(state.rafId);
      if (state.zxingReader) {
        try { state.zxingReader.reset(); } catch {}
        state.zxingReader = null;
      }
      if (state.stream) {
        state.stream.getTracks().forEach(t => t.stop());
        state.stream = null;
      }
      els.video.srcObject = null;
      els.sheet.classList.remove('open');
      els.sheet.setAttribute('aria-hidden', 'true');
      state.using = 'none';
      setModePill('—');
      setStatus('Ready');
    }

    function loopDetect() {
      const tick = async () => {
        if (!detector || !els.video || els.video.readyState < 2) {
          state.rafId = requestAnimationFrame(tick);
          return;
        }
        try {
          const barcodes = await detector.detect(els.video);
          if (barcodes && barcodes.length) {
            for (const b of barcodes) {
              handleDetection(String(b.rawValue || b.rawValue === 0 ? b.rawValue : b?.rawValue), b.format || '');
            }
          }
        } catch (e) {
          // Ignore frame decode errors to keep the loop smooth
        }
        state.rafId = requestAnimationFrame(tick);
      };
      state.rafId = requestAnimationFrame(tick);
    }

    async function loadZXing() {
      if (els.zxingScript.dataset.loaded === 'true') return;
      return new Promise((resolve, reject) => {
        els.zxingScript.src = 'https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js';
        els.zxingScript.onload = () => { els.zxingScript.dataset.loaded = 'true'; resolve(); };
        els.zxingScript.onerror = reject;
      });
    }

    async function startZXing() {
      if (!state.zxingReader) return;
      // If a stream exists, ZXing can bind to video element and reuse the device
      state.zxingReader.decodeFromVideoElement(els.video, (res, err) => {
        if (res && res.text) {
          const fmt = res.getBarcodeFormat ? String(res.getBarcodeFormat()) : 'UNKNOWN';
          handleDetection(String(res.text), fmt);
        }
        // errors are frequent per frame; ignore
      });
    }

    function handleDetection(code, format) {
      if (!code) return;
      const now = Date.now();
      const last = state.lastSeen.get(code) || 0;
      if (now - last < state.coolDownMs) return; // de-dup bursts
      state.lastSeen.set(code, now);

      vibrate([20, 30, 20]);
      beep();
      addOrBump(code, format);

      // Optional: Briefly flash status
      setStatus('Captured ' + code);
      clearTimeout(handleDetection._t);
      handleDetection._t = setTimeout(() => setStatus('Scanning…'), 1000);
    }

    // CSV export
    function exportCsv() {
      if (!state.scans.length) return alert('Nothing to export yet.');
      const header = ['barcode','format','qty','first_seen','last_seen'];
      const rows = state.scans.map(x => [x.code, x.format || '', x.qty, x.firstSeen, x.lastSeen]);
      const csv = [header, ...rows].map(r => r.map(cell => {
        const s = String(cell ?? '');
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `grocery-scans-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }

    // Capability hint
    function detectCapability() {
      const hasMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      const hasBD = 'BarcodeDetector' in window;
      if (!hasMedia) {
        setCapabilityPill('Camera not available');
      } else if (hasBD) {
        setCapabilityPill('Native detector');
      } else {
        setCapabilityPill('ZXing fallback');
      }
    }

    // Handlers
    els.openBtn.addEventListener('click', openScanner);
    els.closeBtn.addEventListener('click', closeScanner);
    els.exportBtn.addEventListener('click', exportCsv);
    els.clearBtn.addEventListener('click', clearAll);
    els.sheet.addEventListener('click', (e) => {
      if (e.target === els.sheet) closeScanner(); // click outside to close
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && els.sheet.classList.contains('open')) closeScanner();
    });

    // Init
    detectCapability();
    load();

    // iOS autoplay quirks helper (ensure play on visibility)
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && els.video.srcObject && els.video.paused) {
        els.video.play().catch(()=>{});
      }
    });
  </script>
</body>
</html>
