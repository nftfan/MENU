
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NFTFANS ERC1155 Shop (Crypto Theme Minimal)</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
html, body {
  margin: 0;
  padding: 0;
  font-family: system-ui, 'Inter', Arial, sans-serif;
  background: #000;
  color: #fff;
  min-height: 100vh;
  font-size: 10px;
}
body {
  background: #000;
}
.banner-top {
  width: 100vw;
  max-width: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #111;
  border-bottom: 1px solid #222;
  padding: 0;
  margin: 0;
}
.banner-top img {
  width: 100%;
  max-width: 480px;
  object-fit: cover;
  display: block;
  margin: 0 auto;
  border-radius: 0 0 12px 12px;
  background: #000;
  box-shadow: 0 2px 8px #0008;
}
.wrapper {
  max-width: 480px;
  margin: 0 auto;
  padding: 7px 0 24px 0;
  position: relative;
}
.header {
  background-color: #111;
  padding: 10px 5px 10px 7px;
  font-weight: bold;
  font-size: 13px;
  border-bottom: 1px solid #222;
  text-align: center;
  letter-spacing: 0.5px;
  color: #93c5fd;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
.header .material-icons {
  font-size: 18px;
  color: #60a5fa;
  vertical-align: middle;
}
.top-bar {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 8px;
  padding: 7px 5px 3px 7px;
  background: #0b1221;
  font-size: 10px;
  border: none;
  color: #93c5fd;
}
.nftfan-balance-bar {
  display: flex;
  align-items: center;
  margin-right: auto;
  font-size: 8px;
  color: #89c9ff;
  background: #1a2336;
  border-radius: 6px;
  padding: 2px 7px 2px 2px;
  gap: 2px;
  font-weight: 500;
}
.nftfan-token-icon {
  width: 15px;
  height: 15px;
  margin-right: 2px;
}
.connect-btn {
  padding: 4px 8px;
  background: #121d33;
  border: 1px solid #3b82f6;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  color: #60a5fa;
  font-size: 9px;
  min-width: 70px;
  box-shadow: 0 1px 2px #0008;
  transition: background .18s, color .18s;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  max-width: 170px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.connect-btn .material-icons {
  font-size: 13px;
  margin-bottom: 1px;
}
.connect-btn:hover, .connect-btn:focus {
  background: #182745;
  color: #fff;
  outline: none;
}
/* Notification bar */
.status-bar {
  padding: 7px 11px;
  background: #171e2e;
  border-radius: 6px;
  margin: 8px 7px 10px 7px;
  font-size: 10px;
  min-height: 21px;
  text-align: left;
  font-weight: 600;
  border: 1px solid #313a4a;
  letter-spacing: .01em;
  box-shadow: 0 1px 6px #0002;
  word-break: break-word;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background .18s, color .18s, border .18s;
}
.status-bar .material-icons {
  font-size: 16px;
  vertical-align: middle;
  padding-right: 2px;
  /* color set by status type */
  transition: color .18s;
}
.status-info { background: #171e2e; color: #60a5fa; border-color: #60a5fa; }
.status-success { background: #192f21; color: #22c55e; border-color: #22c55e; }
.status-error { background: #2e1a1a; color: #e53e3e; border-color: #e53e3e; }
.status-warn { background: #2e241a; color: #ffbe3d; border-color: #ffbe3d; }
.status-bar.status-success .material-icons { color: #22c55e;}
.status-bar.status-error .material-icons { color: #e53e3e;}
.status-bar.status-warn .material-icons { color: #ffbe3d;}
.status-bar.status-info .material-icons { color: #60a5fa;}

.tab-bar {
  display: flex;
  gap: 4px;
  margin: 0 7px 8px 7px;
  background: #121d33;
  border-radius: 7px;
  overflow: hidden;
}
.tab-btn {
  flex: 1;
  padding: 6px 0;
  background: #121d33;
  border: none;
  border-radius: 0;
  cursor: pointer;
  font-weight: 600;
  color: #93c5fd;
  font-size: 8px;
  letter-spacing: .01em;
  transition: background .18s, color .18s;
  outline: none;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 5px;
}
.tab-btn .material-icons {
  font-size: 13px;
  margin-bottom: 1px;
}
.tab-btn.active {
  background: #60a5fa;
  color: #fff;
}
.tab-btn:hover:not(.active) {
  background: #182745;
  color: #fff;
}

.nft-list {
  list-style: none;
  padding: 0;
  margin: 10px 0 0 0;
}
.nft-post {
  display: flex;
  align-items: stretch;
  justify-content: space-between;
  padding: 11px 0 11px 0;
  background: transparent;
  position: relative;
  font-size: 10px;
  gap: 13px;
  border: none;
}
.nft-post:not(:last-child)::after {
  content: "";
  display: block;
  position: absolute;
  left: 56px;
  right: 0;
  bottom: 0;
  height: 1px;
  background: #222;
  opacity: 1;
  z-index: 1;
}
.nft-post-left {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
}
.serial-number {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 38px;
  min-width: 22px;
  font-size: 8px;
  color: #aaa;
  font-family: inherit;
  font-weight: 500;
  letter-spacing: 0.03em;
  text-align: center;
  margin-right: 0;
}
.nft-avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background-color: #fff;
  object-fit: cover;
  border: 1.5px solid #222f44;
  flex-shrink: 0;
  display: block;
}
.nft-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}
.nft-title {
  font-weight: bold;
  font-size: 10px;
  color: #cbe2ff;
  line-height: 1.2;
  margin-bottom: 1px;
  white-space: normal;
  word-break: break-word;
  display: flex;
  align-items: center;
  gap: 7px;
}
.nft-supply {
  color: #aaa;
  font-size: 9px;
  font-weight: 400;
  margin-left: 4px;
}
.nft-description {
  font-size: 8.5px;
  color: #ccc;
  margin-top: 1px;
  max-width: 220px;
  white-space: normal;
  word-break: break-word;
}
.nft-actions {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 7px;
  margin-left: 11px;
  min-width: 90px;
  justify-content: center;
}
.price-tab {
  background: #181f3a;
  color: #60a5fa;
  font-size: 9px;
  font-weight: 600;
  border-radius: 13px;
  padding: 4px 10px;
  border: 1px solid #222c48;
  margin: 0;
  min-width: 70px;
  text-align: center;
  box-shadow: 0 1px 2px #0003;
  display: flex;
  align-items: center;
  gap: 3px;
  letter-spacing: 0.15px;
}
.price-tab .material-icons {
  font-size: 13px;
  color: #60a5fa;
  margin-right: 2px;
}
.buy-btn, .sell-btn {
  font-size: 9px;
  padding: 5px 13px;
  border-radius: 16px;
  border: none;
  background-color: #1e90ff;
  color: white;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
  box-shadow: 0 1px 2px #0008;
  letter-spacing: 0.1px;
  display: flex;
  align-items: center;
  gap: 4px;
}
.buy-btn .material-icons, .sell-btn .material-icons {
  font-size: 13px;
  margin-bottom: 1px;
}
.buy-btn:disabled, .sell-btn:disabled {
  background: #222a46;
  color: #aaa;
  cursor: not-allowed;
}
.buy-btn:hover:not(:disabled), .sell-btn:hover:not(:disabled) {
  background-color: #3aa0ff;
}
.sold-out {
  font-size: 9px;
  color: #ff6363;
  font-weight: bold;
  margin-left: 0;
  display: flex;
  align-items: center;
  gap: 3px;
}
.sold-out .material-icons {
  font-size: 13px;
  color: #e53e3e;
}
@media (max-width: 600px) {
  .wrapper { max-width: 100vw; padding: 0; }
  .nft-avatar { width: 29px; height: 29px; }
  .serial-number { height: 29px; min-width: 14px; font-size: 7px;}
  .nft-title { font-size: 9px; }
  .buy-btn, .sell-btn { font-size: 8px; padding: 4px 10px; }
  .nft-description { font-size: 7.5px; max-width: 110px; }
  .nft-post { padding: 7px 0; }
  .price-tab { font-size: 8px; padding: 3px 7px; min-width: 50px;}
  .nft-actions { gap: 4px; margin-left: 7px;}
  .nft-post:not(:last-child)::after { left: 44px; }
  .banner-top img { max-width: 100vw; }
}
/* Modal for selling */
#sellModal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(9,15,32,0.92);
  justify-content: center;
  align-items: center;
}
#sellModalContent {
  background: #161e2d;
  padding: 16px 12px 13px 12px;
  border-radius: 10px;
  box-shadow: 0 2px 16px #0008;
  min-width: 210px;
  max-width: 96vw;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  font-size: 9px;
  color: #fff;
  border: 1px solid #60a5fa;
  gap: 7px;
  position: relative;
}
#sellModalContent h3 {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 10px;
  margin: 0 0 7px 0;
}
#sellModalContent input {
  margin: 2px 0 5px 0;
  padding: 5px 7px;
  border: 1px solid #60a5fa;
  border-radius: 4px;
  width: 97%;
  font-size: 9px;
  background: #10131f;
  color: #fff;
  outline: none;
  transition: border .15s;
}
#sellModalContent input:focus {
  border: 1.5px solid #3b82f6;
  background: #13193c;
}
#sellModalContent button {
  padding: 4px 13px;
  border-radius: 4px;
  border: none;
  background: #60a5fa;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  font-size: 9px;
  margin-top: 3px;
  transition: background .18s;
  display: flex;
  align-items: center;
  gap: 4px;
}
#sellModalContent button .material-icons {
  font-size: 13px;
  margin-bottom: 1px;
}
#sellModalContent button:hover { background: #3b82f6; }
#sellModalContent .cancel-btn {
  background: #222a38;
  color: #fff;
  margin-left: 7px;
  border: 1px solid #d1d5db;
}
#sellModalError {
  color: #ff6363;
  margin-top: 7px;
  font-size: 8px;
  display: flex;
  align-items: center;
  gap: 4px;
}
#sellModalClose {
  position: absolute;
  top: 8px;
  right: 10px;
  background: none;
  border: none;
  color: #93c5fd;
  font-size: 17px;
  cursor: pointer;
  z-index: 2;
  display: flex;
  align-items: center;
}
#sellModalClose:hover { color: #e53e3e; }

.nft-status-label {
  display: inline-block;
  font-size: 8px;
  font-weight: 700;
  padding: 2px 7px;
  margin-left: 7px;
  margin-top: 2px;
  color: #fff;
}
.nft-status-listed { color: #ffffee; }
.nft-status-notlisted { color: #ff6600;}

/* ===================== */
/* NEW FEATURES ADDED!   */
/* ===================== */

/* User Listings Modal */
#userListingsModal {
  display: none;
  position: fixed;
  z-index: 1002;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(9,15,32,0.92);
  justify-content: center;
  align-items: center;
}
#userListingsModalContent {
  background: #161e2d;
  padding: 18px 15px 15px 15px;
  border-radius: 12px;
  min-width: 240px;
  max-width: 97vw;
  box-shadow: 0 2px 13px #000a;
  color: #fff;
  border: 1px solid #60a5fa;
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
}
#userListingsModalContent h3 {
  margin: 0 0 8px 0;
  font-size: 11px;
  color: #7dd3fc;
  display: flex;
  align-items: center;
  gap: 7px;
}
.user-listings-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 9px;
  color: #fff;
  margin-bottom: 7px;
}
.user-listings-table th,
.user-listings-table td {
  border: 1px solid #22334a;
  padding: 6px 7px;
  text-align: left;
}
.user-listings-table th {
  background: #1a2236;
  color: #7dd3fc;
}
.user-listings-table tr:nth-child(even) {
  background: #141b2d;
}
.user-listings-table tr:nth-child(odd) {
  background: #19213a;
}
.cancel-listing-btn {
  padding: 3px 11px;
  border-radius: 8px;
  border: none;
  background: #e53e3e;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  font-size: 8px;
  margin-left: 4px;
  transition: background .16s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.cancel-listing-btn .material-icons {
  font-size: 12px;
  margin-bottom: 1px;
}
.cancel-listing-btn:hover {
  background: #c53030;
}
#userListingsModalClose {
  position: absolute;
  top: 12px;
  right: 13px;
  background: none;
  border: none;
  color: #93c5fd;
  font-size: 17px;
  cursor: pointer;
  z-index: 2;
  display: flex;
  align-items: center;
}
#userListingsModalClose:hover { color: #e53e3e; }

/* END NEW FEATURES */

/* Prevent mobile browser zoom on input focus by setting font-size >= 16px */
input,
textarea,
select {
  font-size: 16px !important;
}
  </style>
</head>
<body>
  <div class="banner-top">
    <img src="https://pbs.twimg.com/media/Gs758wIWEAEsq45?format=jpg&name=large" alt="Banner">
  </div>
  <div class="wrapper">
    <div class="header">
      <span class="material-icons">currency_bitcoin</span>
      COIN FANS
    </div>
    <div class="top-bar">
      <div class="nftfan-balance-bar" id="nftfanBalanceBar" style="display:none;">
        <img class="nftfan-token-icon" src="https://i.imgur.com/ODP45iQ.png" alt="NFTFAN Token">
        <span id="nftfanBalance">--</span>
        <span style="font-size:7px;font-weight:400;color:#888;margin-left:2px;">NFTFAN</span>
      </div>
      <button class="connect-btn" id="connect-btn" onclick="connectWallet()">
        <span class="material-icons">link</span>
        Connect Wallet
      </button>
      <!-- New: Button to open user listings modal -->
      <button class="connect-btn" id="my-listings-btn" style="margin-left:10px;display:none;" onclick="openUserListingsModal()">
        <span class="material-icons">fact_check</span>
        My Listings
      </button>
    </div>
    <div class="status-bar status-info" id="statusBar">
      <span class="material-icons" id="statusBarIcon">info</span>
      Status: Initializing...
    </div>
    <div class="tab-bar">
      <button class="tab-btn" id="tab-listings" onclick="showTab('listings')">
        <span class="material-icons">list_alt</span>User Listings
      </button>
      <button class="tab-btn active" id="tab-shop" onclick="showTab('shop')">
        <span class="material-icons">storefront</span>Coin Shop
      </button>
      <button class="tab-btn" id="tab-mynfts" onclick="showTab('mynfts')">
        <span class="material-icons">account_balance_wallet</span>My Coins
      </button>
    </div>
    <!-- Shop Tab -->
    <div class="tab-content" id="tab-content-shop">
      <div id="shop-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading NFTs...</div>
      <div id="shop-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="shopGrid" style="display: none;"></ul>
    </div>
    <!-- My NFTs Tab -->
    <div class="tab-content" id="tab-content-mynfts" style="display:none;">
      <div id="my-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading Your NFTs...</div>
      <div id="my-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="myGrid" style="display: none;"></ul>
    </div>
    <!-- User Listings Tab -->
    <div class="tab-content" id="tab-content-listings" style="display:none;">
      <div id="listings-loading" class="loading" style="color:#60a5fa;text-align:center;padding:18px 0;font-size:10px;">Loading User Listings...</div>
      <div id="listings-error" class="error" style="display: none;background:#fee2e2;color:#e53e3e;padding:7px;border-radius:4px;margin-bottom:7px;font-size:9px;text-align:left;border:1px solid #fecaca;"></div>
      <ul class="nft-list" id="listingsGrid" style="display: none;"></ul>
    </div>
  </div>

  <!-- Sell Modal -->
  <div id="sellModal">
    <div id="sellModalContent">
      <button id="sellModalClose" onclick="closeSellModal()" title="Close"><span class="material-icons">close</span></button>
      <h3>
        <span class="material-icons">sell</span>
        Sell Your NFT
      </h3>
      <div>
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">confirmation_number</span>
        Token ID: <span id="sellTokenId"></span>
      </div>
      <div>
        <span class="material-icons" style="font-size:12px;vertical-align:middle;">inventory_2</span>
        You own: <span id="sellMaxAmount"></span>
      </div>
      <input type="number" id="sellAmountInput" min="1" placeholder="Amount to sell">
      <input type="number" id="sellPriceInput" step="0.000000000000000001" placeholder="Price per NFT (MATIC)">
      <div style="display:flex;gap:7px;width:100%;justify-content:flex-start;">
        <button onclick="confirmSellNFT()">
          <span class="material-icons">check_circle</span>Sell
        </button>
        <button onclick="closeSellModal()" class="cancel-btn">
          <span class="material-icons">cancel</span>Cancel
        </button>
      </div>
      <div id="sellModalError"></div>
    </div>
  </div>

  <!-- User Listings Modal (NEW FEATURE)-->
  <div id="userListingsModal">
    <div id="userListingsModalContent">
      <button id="userListingsModalClose" onclick="closeUserListingsModal()" title="Close"><span class="material-icons">close</span></button>
      <h3>
        <span class="material-icons">fact_check</span>
        My Active Listings
      </h3>
      <table class="user-listings-table" id="userListingsTable">
        <thead>
          <tr>
            <th>Token ID</th>
            <th>Amount</th>
            <th>Price (MATIC)</th>
            <th>Cancel</th>
          </tr>
        </thead>
        <tbody>
          <!-- JS fills in user's listings here -->
        </tbody>
      </table>
      <div id="userListingsEmpty" style="display:none;color:#aaa;font-size:9px;text-align:center;padding:6px;">
        You have no active listings.
      </div>
    </div>
  </div>
</body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
  <script>
    // --- CONFIG ---
    const POLYGON_PARAMS = {
      chainId: '0x89',
      chainName: 'Polygon Mainnet',
      nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
      rpcUrls: ['https://polygon-rpc.com/', 'https://rpc.polygon.technology/', 'https://rpc-mainnet.matic.network/'],
      blockExplorerUrls: ['https://polygonscan.com/'],
    };
    const NFTFAN_SHOP_CA = "0x98F56A5549A44ee2DB61F44E0E901D92F0C86a3e";
   const NFTFAN_SHOP_ABI = [
  // NFTMeta struct
  { "inputs": [], "stateMutability": "nonpayable", "type": "constructor" },
  { "anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"address","name":"creator","type":"address"},{"indexed":false,"internalType":"string","name":"tokenURI","type":"string"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NFTMinted","type":"event" },
  { "anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NFTBought","type":"event" },
  { "anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"NFTListed","type":"event" },
  { "anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"NFTUnlisted","type":"event" },
  { "anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"listingIndex","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ListingCancelled","type":"event" },
  // view functions
  { "inputs": [], "name": "nextTokenId", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" } ], "name": "nftInfo", "outputs": [
    { "internalType": "string", "name": "tokenURI", "type": "string" },
    { "internalType": "uint256", "name": "price", "type": "uint256" },
    { "internalType": "bool", "name": "forSale", "type": "bool" },
    { "internalType": "address", "name": "originalCreator", "type": "address" },
    { "internalType": "uint256", "name": "maxSupply", "type": "uint256" },
    { "internalType": "uint256", "name": "currentSupply", "type": "uint256" }
  ], "stateMutability": "view", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" } ], "name": "shopInventory", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
  { "inputs": [], "name": "getShopNFTs", "outputs": [
    { "internalType": "uint256[]", "name": "ids", "type": "uint256[]" },
    { "internalType": "string[]", "name": "uris", "type": "string[]" },
    { "internalType": "uint256[]", "name": "prices", "type": "uint256[]" },
    { "internalType": "bool[]", "name": "isForSale", "type": "bool[]" },
    { "internalType": "uint256[]", "name": "shopAmounts", "type": "uint256[]" },
    { "internalType": "uint256[]", "name": "maxSupplies", "type": "uint256[]" },
    { "internalType": "uint256[]", "name": "currentSupplies", "type": "uint256[]" }
  ], "stateMutability": "view", "type": "function" },
  { "inputs": [ { "internalType": "address", "name": "user", "type": "address" } ], "name": "tokensOfOwner", "outputs": [
    { "internalType": "uint256[]", "name": "tokenIds", "type": "uint256[]" },
    { "internalType": "uint256[]", "name": "amounts", "type": "uint256[]" }
  ], "stateMutability": "view", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" } ], "name": "getListings", "outputs": [
    { "components": [
      { "internalType": "address", "name": "seller", "type": "address" },
      { "internalType": "uint256", "name": "amount", "type": "uint256" },
      { "internalType": "uint256", "name": "price", "type": "uint256" }
    ], "internalType": "struct NFTFansShop.Listing[]", "name": "", "type": "tuple[]" }
  ], "stateMutability": "view", "type": "function" },
  // user actions
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "internalType": "uint256", "name": "amount", "type": "uint256" } ], "name": "buyNFT", "outputs": [], "stateMutability": "payable", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "_price", "type": "uint256" } ], "name": "sellNFT", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" }, { "internalType": "uint256", "name": "listingIndex", "type": "uint256" } ], "name": "cancelListing", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
  // ERC1155
  { "inputs": [ { "internalType": "address", "name": "account", "type": "address" }, { "internalType": "uint256", "name": "id", "type": "uint256" } ], "name": "balanceOf", "outputs": [ { "internalType": "uint256", "name": "", "type": "uint256" } ], "stateMutability": "view", "type": "function" },
  { "inputs": [ { "internalType": "uint256", "name": "tokenId", "type": "uint256" } ], "name": "uri", "outputs": [ { "internalType": "string", "name": "", "type": "string" } ], "stateMutability": "view", "type": "function" }
];
    let userAccount = null, web3, nftfanShop = null, lastError = null, statusTimeout = null;
let sellModalTokenId = null, sellModalMaxAmount = null;
let statusBarClass = "status-info";
let statusBarIcon = "info";

function setStatusBar(type, message) {
  // type: info, success, error, warn
  const statusBar = document.getElementById('statusBar');
  const iconSpan = document.getElementById('statusBarIcon');
  statusBar.className = `status-bar status-${type}`;
  if (iconSpan) {
    if (type === "success") iconSpan.textContent = "check_circle";
    else if (type === "error") iconSpan.textContent = "error";
    else if (type === "warn") iconSpan.textContent = "warning";
    else iconSpan.textContent = "info";
  }
  statusBar.style.display = "flex";
  statusBar.textContent = ""; // clear for correct flex alignment
  statusBar.appendChild(iconSpan);
  statusBar.appendChild(document.createTextNode(message));
}

function updateStatus(message, type = "info") {
  clearTimeout(statusTimeout);
  setStatusBar(type, message);
  // auto-hide for info/success
  if (type === "success" || type === "info") {
    statusTimeout = setTimeout(() => {
      document.getElementById('statusBar').style.display = "none";
    }, 5000);
  }
}

function logError(error, context = '') {
  lastError = `${context}: ${error.message || error}`;
}

function showError(elementId, message) {
  const errorEl = document.getElementById(elementId);
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  updateStatus(message, "error");
}

function hideError(elementId) {
  document.getElementById(elementId).style.display = 'none';
}

async function connectWallet() {
  try {
    updateStatus('Connecting wallet...');
    if (!window.ethereum) throw new Error("Please install MetaMask or a compatible wallet!");
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== POLYGON_PARAMS.chainId) {
      updateStatus('Switching to Polygon network...');
      try {
        await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_PARAMS.chainId }] });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [POLYGON_PARAMS] });
        } else { throw switchError; }
      }
    }
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAccount = accounts[0];
    document.getElementById("connect-btn").textContent = formatAddress(userAccount);
    await setupContracts();
    updateStatus('Connected successfully');
    loadShopNFTs();
    loadUserNFTs();
    loadUserListings();
  } catch (error) {
    logError(error, 'Wallet Connection');
    updateStatus('Connection failed: ' + error.message, "error");
  }
}

async function setupContracts() {
  try {
    updateStatus('Setting up contracts...');
    const rpcUrls = POLYGON_PARAMS.rpcUrls;
    let provider = null;
    if (window.ethereum) {
      provider = window.ethereum;
    } else {
      for (const rpcUrl of rpcUrls) {
        try {
          const testWeb3 = new Web3(rpcUrl);
          await testWeb3.eth.getBlockNumber();
          provider = rpcUrl;
          break;
        } catch {}
      }
    }
    if (!provider) throw new Error('No working RPC provider found');
    web3 = new Web3(provider);
    nftfanShop = new web3.eth.Contract(NFTFAN_SHOP_ABI, NFTFAN_SHOP_CA);
    updateStatus('Contracts initialized');
  } catch (error) {
    logError(error, 'Contract Setup');
    throw error;
  }
}

async function fetchOpenSeaMeta(uri) {
  if (!uri) return null;
  try {
    if (uri.startsWith("ipfs://")) uri = "https://ipfs.io/ipfs/" + uri.slice(7);
    if (uri.startsWith("ar://")) uri = "https://arweave.net/" + uri.slice(5);
    const res = await fetch(uri, { mode: 'cors' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (e) {
    updateStatus('Metadata fetch failed: ' + (uri || 'unknown'), "error");
    return null;
  }
}

let permanentlySoldOutIds = JSON.parse(localStorage.getItem('nftfans_permanently_sold_out_ids') || '[]');

function markPermanentlySoldOut(tokenId) {
  if (!permanentlySoldOutIds.includes(tokenId)) {
    permanentlySoldOutIds.push(tokenId);
    localStorage.setItem('nftfans_permanently_sold_out_ids', JSON.stringify(permanentlySoldOutIds));
  }
}
    async function loadShopNFTs() {
  const shopGrid = document.getElementById("shopGrid");
  const loading = document.getElementById("shop-loading");
  shopGrid.innerHTML = "";
  loading.style.display = "block";
  shopGrid.style.display = "none";
  hideError("shop-error");
  try {
    updateStatus('Loading shop NFTs...');
    if (!nftfanShop) await setupContracts();
    const result = await nftfanShop.methods.getShopNFTs().call();
    const { ids, uris, prices, isForSale, shopAmounts, maxSupplies } = result;
    if (!ids.length) { loading.textContent = "No NFTs in Shop"; updateStatus('No NFTs in shop'); return; }
    updateStatus(`Loading metadata for ${ids.length} NFTs...`);

    // Also, for each NFT, check if it's listed or not (forSale)
    const metaArr = await Promise.all(uris.map((uri, i) => fetchOpenSeaMeta(uri)));
    let html = "";
    let visibleCount = 0;
    for (let i = 0; i < ids.length; i++) {
      const id = ids[i], meta = metaArr[i],
            name = meta?.name || `NFTFAN #${id}`,
            img = meta?.image || uris[i] || "https://via.placeholder.com/92x92?text=NFT",
            desc = meta?.description || "",
            price = web3.utils.fromWei(prices[i], "ether"),
            forSale = isForSale[i], available = Number(shopAmounts[i]),
            maxSupply = maxSupplies ? maxSupplies[i] : '';

      // Status badge
      let statusBadge = '';
      if (forSale && available > 0) {
        statusBadge = `<span class="nft-status-label nft-status-listed">Listed</span>`;
      } else {
        statusBadge = `<span class="nft-status-label nft-status-notlisted">Not listed</span>`;
      }

      html += `<li class="nft-post">
        <div class="nft-post-left">
          <span class="serial-number">${++visibleCount}</span>
          <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
          <div class="nft-content">
            <div class="nft-title">${name}
              ${maxSupply ? `<span class="nft-supply">· Max: ${maxSupply}</span>` : ''}
            </div>
            <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
            ${statusBadge}
          </div>
        </div>
        <div class="nft-actions">
          <div class="price-tab">${price} POL</div>
          ${(forSale && available > 0) ? `<button class="buy-btn" onclick="buyNFT(${id}, '${prices[i]}', ${available})" ${!userAccount ? 'disabled' : ''}>Buy</button>` : `<div class="sold-out">Sold Out</div>`}
        </div>
      </li>`;
    }
    shopGrid.innerHTML = html;
    loading.style.display = "none";
    shopGrid.style.display = visibleCount > 0 ? "block" : "none";
    if (visibleCount === 0) {
      loading.textContent = "No NFTs available in shop.";
      loading.style.display = "block";
    }
    updateStatus(`Shop loaded`);
  } catch (error) {
    logError(error, 'Shop Loading');
    showError("shop-error", "Failed to load NFTs: " + error.message);
  }
}

async function loadUserNFTs() {
  const myGrid = document.getElementById("myGrid");
  const loading = document.getElementById("my-loading");
  myGrid.innerHTML = "";
  loading.style.display = "block";
  myGrid.style.display = "none";
  hideError("my-error");
  if (!userAccount) { loading.textContent = "Connect wallet to view your NFTs."; return; }
  try {
    updateStatus('Loading your NFTs...');
    if (!nftfanShop) await setupContracts();
    const tokens = await nftfanShop.methods.tokensOfOwner(userAccount).call();
    const { tokenIds, amounts } = tokens;
    if (!tokenIds.length) { loading.textContent = "You own no NFTs yet."; updateStatus('No NFTs owned'); return; }
    let metaArr = await Promise.all(tokenIds.map(async (id, idx) => {
      try {
        let meta = await nftfanShop.methods.nftInfo(id).call();
        let metaJson = await fetchOpenSeaMeta(meta.tokenURI);
        return {id, amount: amounts[idx], meta, metaJson};
      } catch { return {id, amount: amounts[idx], meta: null, metaJson: null}; }
    }));
    let html = "";
    for (let i = 0; i < metaArr.length; i++) {
      const item = metaArr[i],
            {id, amount, meta, metaJson} = item,
            name = metaJson?.name || `NFTFAN #${id}`,
            img = metaJson?.image || (meta?.tokenURI || "https://via.placeholder.com/92x92?text=NFT"),
            desc = metaJson?.description || "",
            maxSupply = meta?.maxSupply || "";
      html += `<li class="nft-post">
          <div class="nft-post-left">
            <span class="serial-number">${i+1}</span>
            <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
            <div class="nft-content">
              <div class="nft-title">${name}
                ${maxSupply ? `<span class="nft-supply">· Max: ${maxSupply}</span>` : ''}
              </div>
              <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
              <div class="nft-supply" style="margin-top:3px;color:#60a5fa;">You own: ${amount}</div>
              <button class="sell-btn" style="margin-top:5px;width:90px;" onclick="openSellModal(${id}, ${amount})">Sell</button>
            </div>
          </div>
        </li>`;
    }
    myGrid.innerHTML = html;
    loading.style.display = "none";
    myGrid.style.display = "block";
    updateStatus(`Your NFTs loaded`);
  } catch (error) {
    logError(error, 'User NFTs Loading');
    showError("my-error", "Failed to load your NFTs: " + error.message);
  }
}

    // ----------- USER LISTINGS LOGIC -------------
async function loadUserListings() {
  const listingsGrid = document.getElementById("listingsGrid");
  const loading = document.getElementById("listings-loading");
  listingsGrid.innerHTML = "";
  loading.style.display = "block";
  listingsGrid.style.display = "none";
  hideError("listings-error");
  try {
    updateStatus('Loading user listings...');
    if (!nftfanShop) await setupContracts();
    // get all NFTs in shop
    const result = await nftfanShop.methods.getShopNFTs().call();
    const { ids, uris } = result;
    if (!ids.length) { loading.textContent = "No NFTs in Shop"; updateStatus('No NFTs in shop'); return; }
    // For each token, get all listings
    let allListings = [];
    for (let i = 0; i < ids.length; i++) {
      try {
        const id = ids[i];
        const uri = uris[i];
        // Get all listings for this tokenId
        const listings = await nftfanShop.methods.getListings(id).call();
        // Get shop's original creator (owner)
        const meta = await nftfanShop.methods.nftInfo(id).call();
        const originalCreator = meta.originalCreator;
        // Only keep listings NOT by original creator and with amount > 0
        const filtered = listings
          .map((l, idx) => ({ ...l, id, uri, meta, listingIndex: idx }))
          .filter(l => l.seller.toLowerCase() !== originalCreator.toLowerCase() && Number(l.amount) > 0);
        allListings = allListings.concat(filtered);
      } catch {}
    }
    if (!allListings.length) {
      loading.textContent = "No other user listings yet.";
      updateStatus('No user listings');
      return;
    }
    updateStatus(`Loading metadata for ${allListings.length} listings...`);
    // Fetch metadata for all
    let html = "";
    for (let i = 0; i < allListings.length; i++) {
      const l = allListings[i];
      let metaJson = await fetchOpenSeaMeta(l.meta.tokenURI);
      let name = metaJson?.name || `NFTFAN #${l.id}`;
      let img = metaJson?.image || l.meta.tokenURI || "https://via.placeholder.com/92x92?text=NFT";
      let desc = metaJson?.description || "";
      let price = web3.utils.fromWei(l.price, "ether");
      html += `<li class="nft-post">
        <div class="nft-post-left">
          <span class="serial-number">${i+1}</span>
          <img class="nft-avatar" src="${img}" alt="NFT ${name}" onerror="this.src='https://via.placeholder.com/92x92?text=NFT'">
          <div class="nft-content">
            <div class="nft-title">${name}
              ${l.meta.maxSupply ? `<span class="nft-supply">· Max: ${l.meta.maxSupply}</span>` : ''}
            </div>
            <div class="nft-description">${desc ? desc.substring(0, 60) + (desc.length > 60 ? '...' : '') : ''}</div>
            <div class="nft-supply" style="margin-top:3px;color:#60a5fa;">Seller: ${formatAddress(l.seller)}</div>
          </div>
        </div>
        <div class="nft-actions">
          <div class="price-tab">${price} MATIC</div>
          <button class="buy-btn" onclick="buyUserListing('${l.id}', '${l.seller}', '${l.price}', '${l.amount}')" ${!userAccount ? 'disabled' : ''}>Buy</button>
        </div>
      </li>`;
    }
    listingsGrid.innerHTML = html;
    loading.style.display = "none";
    listingsGrid.style.display = "block";
    updateStatus(`User listings loaded`);
  } catch (error) {
    logError(error, 'User Listings Loading');
    showError("listings-error", "Failed to load user listings: " + error.message);
  }
}

window.buyUserListing = async function(tokenId, seller, priceWei, availableAmount) {
  if (!userAccount) return updateStatus("Connect your wallet first!", "error");
  let amount = 1;
  if (availableAmount > 1) {
    let input = prompt(`How many would you like to buy from user? (max ${availableAmount})`, "1");
    if (!input) return;
    amount = parseInt(input);
    if (isNaN(amount) || amount < 1 || amount > availableAmount) return updateStatus("Invalid amount", "error");
  }
  try {
    updateStatus('Processing purchase...');
    // The contract's buyNFT handles any available listing, including user ones;
    // if contract expects to buy from a specific seller, you need to add a buyFromSeller method.
    await nftfanShop.methods.buyNFT(tokenId, amount).send({
      from: userAccount,
      value: (BigInt(priceWei) * BigInt(amount)).toString()
    });
    updateStatus('NFT bought successfully!', "success");
    loadShopNFTs(); loadUserNFTs(); loadUserListings();
  } catch (error) {
    logError(error, 'NFT User Listing Purchase');
    updateStatus('Purchase failed: ' + error.message, "error");
  }
};

function showTab(tab) {
  document.getElementById('tab-content-shop').style.display = 'none';
  document.getElementById('tab-content-mynfts').style.display = 'none';
  document.getElementById('tab-content-listings').style.display = 'none';
  document.getElementById(`tab-content-${tab}`).style.display = 'block';
  document.getElementById('tab-shop').classList.remove('active');
  document.getElementById('tab-mynfts').classList.remove('active');
  document.getElementById('tab-listings').classList.remove('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
  if (tab === 'shop') loadShopNFTs();
  else if (tab === 'mynfts') loadUserNFTs();
  else if (tab === 'listings') loadUserListings();
}

window.buyNFT = async function(tokenId, priceWei, availableAmount) {
  if (!userAccount) return updateStatus("Connect your wallet first!", "error");
  let amount = 1;
  if (availableAmount > 1) {
    let input = prompt(`How many would you like to buy? (max ${availableAmount})`, "1");
    if (!input) return;
    amount = parseInt(input);
    if (isNaN(amount) || amount < 1 || amount > availableAmount) return updateStatus("Invalid amount", "error");
  }
  try {
    updateStatus('Processing purchase...');
    await nftfanShop.methods.buyNFT(tokenId, amount).send({
      from: userAccount,
      value: (BigInt(priceWei) * BigInt(amount)).toString()
    });
    updateStatus('NFT bought successfully!', "success");
    // After purchase, reload and check for sold out
    await loadShopNFTs();
    loadUserNFTs();
    loadUserListings();
  } catch (error) {
    logError(error, 'NFT Purchase');
    updateStatus('Purchase failed: ' + error.message, "error");
  }
};


// SELL MODAL LOGIC
window.openSellModal = function(tokenId, maxAmount) {
  sellModalTokenId = tokenId;
  sellModalMaxAmount = maxAmount;
  document.getElementById("sellModal").style.display = "flex";
  document.getElementById("sellTokenId").textContent = tokenId;
  document.getElementById("sellMaxAmount").textContent = maxAmount;
  document.getElementById("sellAmountInput").value = "";
  document.getElementById("sellAmountInput").max = maxAmount;
  document.getElementById("sellPriceInput").value = "";
  document.getElementById("sellModalError").textContent = "";
};
window.closeSellModal = function() {
  document.getElementById("sellModal").style.display = "none";
  sellModalTokenId = null; sellModalMaxAmount = null;
};
window.confirmSellNFT = async function() {
  const amount = parseInt(document.getElementById("sellAmountInput").value);
  const price = document.getElementById("sellPriceInput").value;
  document.getElementById("sellModalError").textContent = "";
  if (!userAccount) return document.getElementById("sellModalError").textContent = "Connect your wallet first!";
  if (!amount || isNaN(amount) || amount < 1 || amount > sellModalMaxAmount)
    return document.getElementById("sellModalError").textContent = "Invalid amount!";
  if (!price || isNaN(price) || Number(price) <= 0)
    return document.getElementById("sellModalError").textContent = "Invalid price!";
  let priceWei = "0";
  try { priceWei = web3.utils.toWei(price, "ether"); }
  catch { return document.getElementById("sellModalError").textContent = "Invalid price."; }
  try {
    updateStatus('Processing sale...');
    await nftfanShop.methods.sellNFT(sellModalTokenId, amount, priceWei).send({ from: userAccount });
    updateStatus('NFT listed for sale!', "success");
    closeSellModal();
    loadShopNFTs(); loadUserNFTs(); loadUserListings();
  } catch (error) {
    logError(error, 'NFT Sale');
    updateStatus('Sale listing failed: ' + error.message, "error");
    document.getElementById("sellModalError").textContent = "Sale failed: " + error.message;
  }
};
// Modal close on outside click
window.onclick = function(event) {
  const modal = document.getElementById("sellModal");
  if (event.target === modal) closeSellModal();
};

// EVENTS
if (window.ethereum) {
  window.ethereum.on('accountsChanged', function (accounts) {
    userAccount = accounts[0] || null;
    const connectBtn = document.getElementById("connect-btn");
    connectBtn.textContent = userAccount ? formatAddress(userAccount) : "🔗 Connect Wallet";
    if (userAccount) {
      setupContracts().then(() => { loadShopNFTs(); loadUserNFTs(); loadUserListings(); updateStatus('Account changed', "info"); });
    } else { updateStatus('Wallet disconnected', "warn"); }
  });
  window.ethereum.on('chainChanged', function (chainId) {
    updateStatus('Network changed - reconnecting...', "warn");
    setupContracts().then(() => { loadShopNFTs(); loadUserNFTs(); loadUserListings(); updateStatus('Network changed', "info"); });
  });
}
window.addEventListener("DOMContentLoaded", async () => {
  try {
    updateStatus('Initializing...', "info");
    await setupContracts();
    await loadShopNFTs();
    await loadUserListings();
    updateStatus('Ready', "success");
  } catch (error) {
    logError(error, 'Initialization');
    updateStatus('Initialization failed: ' + error.message, "error");
    showError('shop-error', 'Failed to initialize the application. Please refresh.');
  }
});
function formatAddress(address) {
  if (!address) return '';
  return `${address.slice(0, 5)}...${address.slice(-4)}`;
}
  </script>
</body>
</html>

