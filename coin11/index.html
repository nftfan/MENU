<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinFans NFT Marketplace</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .connect-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .connect-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .nft-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            border-color: #667eea;
        }

        .nft-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }

        .nft-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nft-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .nft-info-item {
            display: flex;
            flex-direction: column;
        }

        .nft-info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 3px;
        }

        .nft-info-value {
            color: #333;
            font-weight: 500;
        }

        .listing-info {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .listing-price {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .buy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .buy-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .buy-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .mint-form {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .mint-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .mint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .mint-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .contract-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .contract-address {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nft-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü™ô CoinFans NFT</h1>
            <p>Discover and trade unique CoinFans NFTs</p>
            <button id="connectBtn" class="connect-btn">Connect Wallet</button>
        </div>

        <div id="status" class="status" style="display: none;"></div>

        <div class="contract-info">
            <h3>Contract Information</h3>
            <div class="contract-address">0xd4d6D7e27a2B5d7AC114AcE38d82b05b38E9F2D1</div>
            <p>Total Supply: <span id="totalSupply">Loading...</span></p>
            <p>Current Token ID: <span id="currentTokenId">Loading...</span></p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('marketplace')">üõí Marketplace</button>
            <button class="tab" onclick="switchTab('collection')">üñºÔ∏è Collection</button>
            <button class="tab" onclick="switchTab('mint')">‚ö° Mint (Owner Only)</button>
        </div>

        <div id="marketplace" class="tab-content active">
            <h2>üî• Active Listings</h2>
            <div id="listingsGrid" class="nft-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading active listings...</p>
                </div>
            </div>
        </div>

        <div id="collection" class="tab-content">
            <h2>üé® All NFTs</h2>
            <div id="collectionGrid" class="nft-grid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading collection...</p>
                </div>
            </div>
        </div>

        <div id="mint" class="tab-content">
            <div class="mint-form">
                <h2>‚ö° Mint New NFT</h2>
                <div class="form-group">
                    <label for="tokenURI">Token URI (Metadata URL):</label>
                    <input type="url" id="tokenURI" placeholder="https://example.com/metadata.json" required>
                </div>
                <div class="form-group">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" min="1" placeholder="1" required>
                </div>
                <button id="mintBtn" class="mint-btn">Mint NFT</button>
            </div>
        </div>
    </div>

    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xd4d6D7e27a2B5d7AC114AcE38d82b05b38E9F2D1';
        const CONTRACT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function totalSupply() view returns (uint256)",
            "function getCurrentTokenId() view returns (uint256)",
            "function uri(uint256 tokenId) view returns (string)",
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function exists(uint256 tokenId) view returns (bool)",
            "function getTokenSupply(uint256 tokenId) view returns (uint256)",
            "function getTokenCreator(uint256 tokenId) view returns (address)",
            "function getListing(uint256 tokenId) view returns (address seller, uint256 price, uint256 amount, uint256 expiryTime, bool active, bool expired)",
            "function getActiveListings(uint256 startId, uint256 endId) view returns (uint256[] tokenIds, address[] sellers, uint256[] prices, uint256[] amounts, uint256[] expiryTimes)",
            "function mint(string tokenURI, uint256 amount) returns (uint256)",
            "function buyNFT(uint256 tokenId, uint256 amount) payable",
            "function owner() view returns (address)",
            "event TokenMinted(uint256 indexed tokenId, address indexed creator, uint256 amount, string uri)",
            "event NFTSold(uint256 indexed tokenId, address indexed seller, address indexed buyer, uint256 price, uint256 amount)"
        ];

        // Global variables
        let provider;
        let signer;
        let contract;
        let userAddress;

        // Initialize the app
        window.addEventListener('load', async () => {
            await loadContractInfo();
            await loadCollection();
            await loadActiveListings();
        });

        // Connect wallet
        document.getElementById('connectBtn').addEventListener('click', connectWallet);

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    showStatus('Connecting to wallet...', 'info');
                    
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                    document.getElementById('connectBtn').textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                    document.getElementById('connectBtn').disabled = true;
                    
                    showStatus(`Connected to ${userAddress}`, 'success');
                    
                    // Check if user is owner
                    const owner = await contract.owner();
                    if (userAddress.toLowerCase() === owner.toLowerCase()) {
                        showStatus('You are the contract owner!', 'success');
                    }
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    showStatus('Failed to connect wallet', 'error');
                }
            } else {
                showStatus('Please install MetaMask', 'error');
            }
        }

        // Load contract information
        async function loadContractInfo() {
            try {
                if (!provider) {
                    provider = new ethers.JsonRpcProvider('https://rpc.ankr.com/eth');
                }
                
                if (!contract) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                }

                const totalSupply = await contract.totalSupply();
                const currentTokenId = await contract.getCurrentTokenId();

                document.getElementById('totalSupply').textContent = totalSupply.toString();
                document.getElementById('currentTokenId').textContent = currentTokenId.toString();
            } catch (error) {
                console.error('Error loading contract info:', error);
                document.getElementById('totalSupply').textContent = 'Error';
                document.getElementById('currentTokenId').textContent = 'Error';
            }
        }

        // Load collection
        async function loadCollection() {
            try {
                if (!contract) {
                    provider = new ethers.JsonRpcProvider('https://rpc.ankr.com/eth');
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                }

                const currentTokenId = await contract.getCurrentTokenId();
                const collectionGrid = document.getElementById('collectionGrid');
                collectionGrid.innerHTML = '';

                if (currentTokenId <= 1) {
                    collectionGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">No NFTs minted yet</p>';
                    return;
                }

                for (let i = 1; i < currentTokenId; i++) {
                    try {
                        const exists = await contract.exists(i);
                        if (!exists) continue;

                        const tokenURI = await contract.uri(i);
                        const tokenSupply = await contract.getTokenSupply(i);
                        const creator = await contract.getTokenCreator(i);

                        const nftCard = createNFTCard({
                            tokenId: i,
                            tokenURI,
                            supply: tokenSupply.toString(),
                            creator
                        });

                        collectionGrid.appendChild(nftCard);
                    } catch (error) {
                        console.error(`Error loading token ${i}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error loading collection:', error);
                document.getElementById('collectionGrid').innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: red;">Error loading collection</p>';
            }
        }

        // Load active listings
        async function loadActiveListings() {
            try {
                if (!contract) {
                    provider = new ethers.JsonRpcProvider('https://rpc.ankr.com/eth');
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                }

                const currentTokenId = await contract.getCurrentTokenId();
                const listingsGrid = document.getElementById('listingsGrid');
                listingsGrid.innerHTML = '';

                if (currentTokenId <= 1) {
                    listingsGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">No listings available</p>';
                    return;
                }

                let hasListings = false;

                for (let i = 1; i < currentTokenId; i++) {
                    try {
                        const listing = await contract.getListing(i);
                        if (!listing.active) continue;

                        hasListings = true;
                        const tokenURI = await contract.uri(i);
                        const tokenSupply = await contract.getTokenSupply(i);

                        const nftCard = createNFTCard({
                            tokenId: i,
                            tokenURI,
                            supply: tokenSupply.toString(),
                            listing: {
                                seller: listing.seller,
                                price: listing.price,
                                amount: listing.amount,
                                expiryTime: listing.expiryTime
                            }
                        });

                        listingsGrid.appendChild(nftCard);
                    } catch (error) {
                        console.error(`Error loading listing ${i}:`, error);
                    }
                }

                if (!hasListings) {
                    listingsGrid.innerHTML = '<p style="text-align: center; grid-column: 1/-1;">No active listings</p>';
                }
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('listingsGrid').innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: red;">Error loading listings</p>';
            }
        }

        // Create NFT card
        function createNFTCard(nftData) {
            const card = document.createElement('div');
            card.className = 'nft-card';

            let imageUrl = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="200" height="200" fill="%23f8f9fa"/><text x="100" y="100" text-anchor="middle" fill="%23666" font-size="16">NFT #' + nftData.tokenId + '</text></svg>';
            
            // Try to fetch metadata for image
            if (nftData.tokenURI) {
                fetchMetadata(nftData.tokenURI).then(metadata => {
                    if (metadata && metadata.image) {
                        const img = card.querySelector('.nft-image');
                        img.src = metadata.image;
                        img.onerror = () => {
                            img.src = imageUrl;
                        };
                    }
                });
            }

            card.innerHTML = `
                <img class="nft-image" src="${imageUrl}" alt="NFT #${nftData.tokenId}">
                <div class="nft-title">CoinFans #${nftData.tokenId}</div>
                <div class="nft-info">
                    <div class="nft-info-item">
                        <div class="nft-info-label">Supply</div>
                        <div class="nft-info-value">${nftData.supply}</div>
                    </div>
                    <div class="nft-info-item">
                        <div class="nft-info-label">Token ID</div>
                        <div class="nft-info-value">#${nftData.tokenId}</div>
                    </div>
                </div>
                ${nftData.listing ? `
                    <div class="listing-info">
                        <div class="listing-price">${ethers.formatEther(nftData.listing.price)} ETH</div>
                        <div>Amount: ${nftData.listing.amount}</div>
                        <div>Seller: ${nftData.listing.seller.substring(0, 6)}...${nftData.listing.seller.substring(38)}</div>
                        <button class="buy-btn" onclick="buyNFT(${nftData.tokenId}, ${nftData.listing.amount}, '${nftData.listing.price}')">
                            Buy for ${ethers.formatEther(nftData.listing.price)} ETH
                        </button>
                    </div>
                ` : ''}
            `;

            return card;
        }

        // Fetch metadata
        async function fetchMetadata(uri) {
            try {
                const response = await fetch(uri);
                return await response.json();
            } catch (error) {
                console.error('Error fetching metadata:', error);
                return null;
            }
        }

        // Buy NFT
        async function buyNFT(tokenId, amount, price) {
            if (!signer) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                showStatus('Purchasing NFT...', 'info');
                const tx = await contract.buyNFT(tokenId, amount, { value: price });
                showStatus('Transaction sent. Waiting for confirmation...', 'info');
                await tx.wait();
                showStatus('NFT purchased successfully!', 'success');
                
                // Refresh listings
                await loadActiveListings();
            } catch (error) {
                console.error('Error buying NFT:', error);
                showStatus('Failed to purchase NFT: ' + error.message, 'error');
            }
        }

        // Mint NFT
        document.getElementById('mintBtn').addEventListener('click', async () => {
            if (!signer) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const tokenURI = document.getElementById('tokenURI').value;
            const amount = document.getElementById('amount').value;

            if (!tokenURI || !amount) {
                showStatus('Please fill in all fields', 'error');
                return;
            }

            try {
                showStatus('Minting NFT...', 'info');
                const tx = await contract.mint(tokenURI, amount);
                showStatus('Transaction sent. Waiting for confirmation...', 'info');
                const receipt = await tx.wait();
                
                // Find the TokenMinted event
                const mintEvent = receipt.logs.find(log => {
                    try {
                        const parsed = contract.interface.parseLog(log);
                        return parsed.name === 'TokenMinted';
                    } catch {
                        return false;
                    }
                });

                if (mintEvent) {
                    const parsed = contract.interface.parseLog(mintEvent);
                    showStatus(`NFT minted successfully! Token ID: ${parsed.args.tokenId}`, 'success');
                } else {
                    showStatus('NFT minted successfully!', 'success');
                }
                
                // Clear form
                document.getElementById('tokenURI').value = '';
                document.getElementById('amount').value = '';
                
                // Refresh collection and contract info
                await loadContractInfo();
                await loadCollection();
            } catch (error) {
                console.error('Error minting NFT:', error);
                showStatus('Failed to mint NFT: ' + error.message, 'error');
            }
        });

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // User disconnected
                    document.getElementById('connectBtn').textContent = 'Connect Wallet';
                    document.getElementById('connectBtn').disabled = false;
                    provider = null;
                    signer = null;
                    contract = null;
                    userAddress = null;
                } else {
                    // User switched accounts
                    location.reload();
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>
